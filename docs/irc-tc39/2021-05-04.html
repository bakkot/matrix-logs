<!doctype html>
<head>
  <title>#tc39 on 2021-05-04</title>
  <link rel="stylesheet" href="../style.css">
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">#tc39<br>2021-05-04<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-05-03" class="nav-link"><span>prev</span></a>
<a href="2021-05-05" class="nav-link"><span style="float:right">next</span></a>
</div>
    
<div class="room-list-wrapper">Active:<br>
<ul class="room-list">
<li><a href="../TC39_Delegates/">TC39 Delegates</a></li>
<li><a href="../TC39_Editors/">TC39 Editors</a></li>
<li><a href="../TC39_General/">TC39 General</a></li>
<li><a href="../WHATWG/">WHATWG</a></li>
</ul>
</div>
<br>
<div class="room-list-wrapper">Historical:<br>
<ul class="room-list">
<li><a href="../irc-tc39/" class="current-room">#tc39</a></li>
<li><a href="../irc-tc39-delegates/">#tc39-delegates</a></li>
<li><a href="../irc-tc39-editor-group/">#tc39-editor-group</a></li>
<li><a href="../irc-whatwg/">#whatwg</a></li>
</ul>
</div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>
<input type="text" id="query" size=25 placeholder="Search #tc39">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon May 03 2021 17:10:19 GMT-0700 (Pacific Daylight Time)">00:10</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yes, that&#039;s how they all work, and yes, it&#039;s extremely gross</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon May 03 2021 17:11:15 GMT-0700 (Pacific Daylight Time)">00:11</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">the worst one is, `l\u{65}t\nx` is a reference to `let` followed by a reference to `x`, rather than a declaration of `x` the way that `let\nx` would be</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon May 03 2021 17:12:14 GMT-0700 (Pacific Daylight Time)">00:12</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">(though technically that one isn&#039;t a consequence of lookahead restrictions, I guess)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon May 03 2021 17:16:49 GMT-0700 (Pacific Daylight Time)">00:16</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=shu@irc>shu</span>&gt;</td><td class="msg-cell">my goodness</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon May 03 2021 18:23:08 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Bakkot: when you say &quot;(which is, here, the context created to evaluate the &quot;resolve&quot; handler for the promise)&quot;, is that an &#039;Await fulfilled function&#039; ?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon May 03 2021 18:33:24 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">that&#039;s not what I intended to refer to, though I might be mistaken about which is actually the top of the stack at that point</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon May 03 2021 18:33:41 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">I didn&#039;t trace the Await machinery all that carefully</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon May 03 2021 18:45:58 GMT-0700 (Pacific Daylight Time)">01:45</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">ah, yeah, it&#039;s the one context created to run the Await fulfilled function (</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon May 03 2021 18:46:14 GMT-0700 (Pacific Daylight Time)">01:46</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">(which lives in &quot;onFulfilled in the Await steps)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon May 03 2021 20:36:00 GMT-0700 (Pacific Daylight Time)">03:36</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">sorry, you *did* mention  &#039;Await fulfilled function&#039; at the time.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon May 03 2021 20:39:11 GMT-0700 (Pacific Daylight Time)">03:39</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so when the timeout completes, does the host invoke a &#039;PromiseReaction&#039; job?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon May 03 2021 20:40:26 GMT-0700 (Pacific Daylight Time)">03:40</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">i.e., starting at step 1.a in NewPromiseReactionJob</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon May 03 2021 20:43:57 GMT-0700 (Pacific Daylight Time)">03:43</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">well, not immediately, but ultimately yes</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon May 03 2021 20:44:23 GMT-0700 (Pacific Daylight Time)">03:44</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">when the timeout completes, control goes Promise Resolve Functions -&gt; FulfillPromise -&gt; TriggerPromiseReactions -&gt; HostEnqueuePromiseJob, and then at some future time, as a consequence of HostEnqueuePromiseJob, the host runs the steps in 1.a of NewPromiseReactionJob</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon May 03 2021 20:46:50 GMT-0700 (Pacific Daylight Time)">03:46</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so much machinery</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon May 03 2021 20:46:55 GMT-0700 (Pacific Daylight Time)">03:46</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yyyyyyup</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon May 03 2021 20:48:15 GMT-0700 (Pacific Daylight Time)">03:48</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">also, before then, I&#039;m not clear on when/where the ConciseBody is evaluated</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon May 03 2021 20:49:08 GMT-0700 (Pacific Daylight Time)">03:49</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">the concisebody is evaluated in step 9 of the Promise constructor</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon May 03 2021 20:49:20 GMT-0700 (Pacific Daylight Time)">03:49</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">(i.e. as part of the `new Promise` call)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon May 03 2021 20:51:36 GMT-0700 (Pacific Daylight Time)">03:51</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so that would be in an execution context stacked onto the genContext</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon May 03 2021 20:52:06 GMT-0700 (Pacific Daylight Time)">03:52</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yes, though one which is pushed and popped without doing any unusual juggling</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon May 03 2021 20:52:18 GMT-0700 (Pacific Daylight Time)">03:52</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">strictly speaking it&#039;s actually twice-nested, because there&#039;s an execution context pushed for the call to Promise as well</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon May 03 2021 20:52:25 GMT-0700 (Pacific Daylight Time)">03:52</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">which then pushes the context for the arrow</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon May 03 2021 20:52:40 GMT-0700 (Pacific Daylight Time)">03:52</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">ah yup</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon May 03 2021 21:04:41 GMT-0700 (Pacific Daylight Time)">04:04</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so when the Await Fulfilled Function starts, the running execution context is probably nothing much?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon May 03 2021 21:08:38 GMT-0700 (Pacific Daylight Time)">04:08</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">no wait, you say it&#039;s &quot;the context created to evaluate the &quot;resolve&quot; handler for the promise&quot;</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon May 03 2021 21:09:13 GMT-0700 (Pacific Daylight Time)">04:09</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">i.e., created by the host?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon May 03 2021 21:09:51 GMT-0700 (Pacific Daylight Time)">04:09</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">&quot;the context created to evaluate the &quot;resolve&quot; handler for the promise&quot; isn&#039;t really precise</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon May 03 2021 21:10:55 GMT-0700 (Pacific Daylight Time)">04:10</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">I just meant that the host will create an execution context to run the PromiseReactionJob</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon May 03 2021 21:11:07 GMT-0700 (Pacific Daylight Time)">04:11</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">yeah, okay</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue May 04 2021 06:49:56 GMT-0700 (Pacific Daylight Time)">13:49</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Bakkot: re <a href="https://freenode.logbot.info/tc39/20210503">https://freenode.logbot.info/tc39/20210503</a></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue May 04 2021 06:52:00 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">19:38: &quot;so AsyncGeneratorResumeNext [at 15] suspends the caller context - which, as  before, is the context created to evaluate the &quot;resolve&quot; handler for the  promise - and then [17] pushes and [18] resumes the generator context&quot;</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue May 04 2021 06:55:04 GMT-0700 (Pacific Daylight Time)">13:55</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">but look more closely at 18: it says &quot;Resume the suspended evaluation of genContext&quot;. But genContext&#039;s evaluation was never suspended!</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue May 04 2021 06:57:04 GMT-0700 (Pacific Daylight Time)">13:57</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">AsyncGeneratorYield step 8 removed it from the stack, but didn&#039;t suspend it, and didn&#039;t resume the new running execution context</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue May 04 2021 07:01:59 GMT-0700 (Pacific Daylight Time)">14:01</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so during the execution of AsyncGeneratorResolve, [the &quot;resolve&quot; handler] is the running execution context, but it hasn&#039;t been resumed.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue May 04 2021 07:06:59 GMT-0700 (Pacific Daylight Time)">14:06</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Well, strictly speaking, I shouldn&#039;t say &quot;resumed&quot;, because in the current spec, the generative side doesn&#039;t &quot;resume&quot; the setup side. But it &quot;returns to&quot;. So AsyncGeneratorYield at the conclusion of step 9 will &quot;return to&quot; the op that most recently resumed the eval of genContext (which actually isnt an operation, but the alg for an Await fulfilled function?), but that hasn&#039;t happened yet.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue May 04 2021 07:15:22 GMT-0700 (Pacific Daylight Time)">14:15</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Hm.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue May 04 2021 07:22:56 GMT-0700 (Pacific Daylight Time)">14:22</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">re my issue #2400, I&#039;m now thinking that the intended mental model was that the stack-manipulation step *is* an implied Resume (or however you want to refer to the generative-&gt;setup transfer of control).</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue May 04 2021 07:24:18 GMT-0700 (Pacific Daylight Time)">14:24</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">(which of course is inconsistent with the rest of the spec, where you still need an explicit Resume after a stack-push)</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue May 04 2021 07:26:55 GMT-0700 (Pacific Daylight Time)">14:26</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">no, that&#039;s still not it, because a Resume transfers control to a suspended algorithm, and the step after the Resume step isn&#039;t executed until/if control ever returns.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue May 04 2021 07:28:29 GMT-0700 (Pacific Daylight Time)">14:28</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">But when AsyncGeneratorYield step 7 does the stack-pop, it doesn&#039;t transfer control to some suspended op, we&#039;re supposed to proceed to step 8 + 9, right?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue May 04 2021 07:32:52 GMT-0700 (Pacific Daylight Time)">14:32</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so between the stack-pop and the eventual return, we&#039;re still in AsyncGenYield, so control hasn&#039;t transferred anywhere, and yet we&#039;re supposed to assume that genContext has been suspended (and the setup context has been [resumed])?</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue May 04 2021 09:00:27 GMT-0700 (Pacific Daylight Time)">16:00</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">If AsyncGeneratorYield&#039;s stack-pop *did* involve a transfer of control, it would go back to the Await fulfilled function, which would accomplish close to nothing, and the genContext would never be resumed?, so that can&#039;t be it.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue May 04 2021 09:12:19 GMT-0700 (Pacific Daylight Time)">16:12</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">jmdyck: my reading of the current specification is that a stack-pop is implicitly a suspend, but neither this implicit suspend nor an explicit suspend entails a transfer of control. otoh, a stack-push is _not_ implicitly a resume, and an explicit resume _is_ a transfer of control.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue May 04 2021 09:14:33 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">so after AsyncGeneratorYield step 7, _genContext_ is suspended, and the topmost execution context is the one below it (the one created by the host for the timeout promise&#039;s handler, in this example), but control remains in AsyncGeneratorYield</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue May 04 2021 10:16:03 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Bakkot: So a stack-pop is an implicit suspend, but a stack-push isn&#039;t an implicit resume; a suspend isn&#039;t a transfer of control, but a resume is. Well, that might work, but I wouldn&#039;t call it intuitively obvious.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue May 04 2021 10:16:23 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">agreed</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue May 04 2021 10:16:39 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">that&#039;s just what I derive by working backwards from what the spec seems to be actually doing</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue May 04 2021 10:16:56 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">yup.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue May 04 2021 10:17:15 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">I still like my &quot;we should conflate stack manipulation and transfer of control&quot; framing</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue May 04 2021 10:17:33 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">though the above conversation made me realize we&#039;d need to refactor the async generator plumbing to make it work</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue May 04 2021 10:17:36 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so how would that handle AsyncGenYield?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue May 04 2021 10:17:45 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue May 04 2021 10:23:29 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">which, I&#039;m not sure how feasible that is; I&#039;d need to actually try the rewrite to see.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue May 04 2021 10:25:09 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">what if the Await fulfilled function (etc), rather than pushing asyncContext onto the stack and resuming it, instead created an intermediary context and resumed that. The intermediary context would initially just push the asynccontext and resume it, BUT it would be there waiting for an explicit resume, at which point it could do the AsyncGeneratorResolve.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue May 04 2021 10:26:58 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">except presumably sometimes it shouldn&#039;t do AsyncGeneratorResolve</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue May 04 2021 10:29:42 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">or maybe i take that back.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue May 04 2021 10:30:18 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">Await fulfilled functions are also used for regular async functions, not just async generators</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue May 04 2021 10:31:16 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">well, there&#039;s lots of pseudocode that switches on GeneratorKind</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue May 04 2021 10:31:39 GMT-0700 (Pacific Daylight Time)">17:31</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">true, we could switch on whether it&#039;s an async generator or async function</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue May 04 2021 10:34:26 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">i suppose you wouldn&#039;t need the extra context, you could do it in the same context as the Await fulfilled function?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue May 04 2021 10:35:20 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">that might be slightly less spaghetti</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue May 04 2021 10:36:28 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">the thing I was thinking of was more along the lines of, AsyncGeneratorResumeNext is recursive so that it can drain the queue. but we could break the recursion (by having AsyncGeneratorResolve and AsyncGeneratorReject not call it), and instead an explicit loop to drain the queue</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue May 04 2021 10:37:10 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">you&#039;d need two explicit loops, I guess, one in AsyncGeneratorEnqueue and one... somewhere else, to handle the case that something is enqueued while it is `await`ing</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue May 04 2021 10:38:50 GMT-0700 (Pacific Daylight Time)">17:38</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">that sounds like more than a refactoring</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue May 04 2021 10:39:08 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">as in you think it would have observable implications?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue May 04 2021 10:39:19 GMT-0700 (Pacific Daylight Time)">17:39</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">wouldn&#039;t do it if so, but I was hoping it would not be observable</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue May 04 2021 10:42:13 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">no, i just meant it sounded like it would be difficult (for me) to verify it as preserving correctness/behavior</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue May 04 2021 10:42:19 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">oh, sure</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue May 04 2021 10:43:10 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">I guess maybe a simpler option would be to have AsyncGeneratorYield not do the suspend</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue May 04 2021 10:43:35 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">wha?</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue May 04 2021 10:44:15 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">but you figure stack-pop is an implicit suspend, how do you not do it?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue May 04 2021 10:44:30 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">that logic could be moved into AsyncGeneratorResumeNext, and made conditional on the queue being empty</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue May 04 2021 10:45:38 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">so in AsyncGeneratorResumeNext, if the state is executing, it would check the queue and if it was empty then do the set-code-execution-state-and-suspend that AsyncGeneratorYield currently does, and if it is not then just execute the logic directly, instead of storing it in the code execution state</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue May 04 2021 10:46:10 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">so that we avoid the current situation where there is a suspension and then immediate resumption a few steps later</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue May 04 2021 10:46:35 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">i&#039;m not really following.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue May 04 2021 10:46:48 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">mm, yeah, hard to describe</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue May 04 2021 10:46:55 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">So AGYield wouldn&#039;t have the stack-pop?</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue May 04 2021 10:46:55 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">I might make a strawman PR if I have time</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue May 04 2021 10:46:58 GMT-0700 (Pacific Daylight Time)">17:46</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue May 04 2021 10:47:03 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">that would be moved into the AsyncGeneratorResumeNext call</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue May 04 2021 10:47:19 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">(or the step 8 set code eval state)</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue May 04 2021 10:47:30 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue May 04 2021 10:47:43 GMT-0700 (Pacific Daylight Time)">17:47</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">it would just go straight to invoking AGResolve</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue May 04 2021 10:48:31 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">So does AGResolve</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue May 04 2021 10:48:54 GMT-0700 (Pacific Daylight Time)">17:48</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">&#039;s step 8 not care what the running ex context is?</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Tue May 04 2021 10:50:30 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Also there are other invocations of AGResolve: are they going to be okay with this change?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Tue May 04 2021 10:51:27 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">(and other invocations of AGResumeNext)</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Tue May 04 2021 10:53:50 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">AGResumeNext currently has an assertion that the state is not ~executing~, so if the new logic were guarded on the state being ~executing~, it shouldn&#039;t affect the other callers</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Tue May 04 2021 10:54:33 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">I think AGResolve does not care what the running execution context is, though I&#039;m not 100% certain</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Tue May 04 2021 10:54:53 GMT-0700 (Pacific Daylight Time)">17:54</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">anyway I haven&#039;t thought through this very far, just talking through possibilities</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Tue May 04 2021 10:55:15 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">sure</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Tue May 04 2021 10:55:20 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">and I haven&#039;t thought about the `.return` calls at all</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Tue May 04 2021 10:59:08 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">fundamentally the bit that I don&#039;t like is that AsyncGeneratorYield pops the execution context but does not immediately return control there</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Tue May 04 2021 10:59:34 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">that&#039;s been bugging me for days</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Tue May 04 2021 11:00:30 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">that&#039;s why 2400 is only an issue and not a PR</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Tue May 04 2021 11:00:43 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">because my brilliant idea didn&#039;t work for AGYield</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Tue May 04 2021 11:01:23 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">because of the AGResolve call between the stack-pop and the control transfer.</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Tue May 04 2021 11:05:32 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Bakkot: so AGYield&#039;s step 6 &quot;Set generator.[[AsyncGeneratorState]] to suspendedYield.&quot; would instead set it to executing?</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Tue May 04 2021 11:06:59 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">hm, currently it gets set to executing late in AGResumeNext</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Tue May 04 2021 11:13:56 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell"> it&#039;s already executing in AGYield</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Tue May 04 2021 11:17:19 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">how?</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Tue May 04 2021 11:19:20 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">Currently the only way you can be executing the body of the async generator, and so perform AGYield, is via step 18 of AGResumeNext, which is immediately preceded by setting the state to ~executing~</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Tue May 04 2021 11:21:32 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">oh right, there&#039;s an AGREsumeNext way back near the start if this example</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Tue May 04 2021 11:35:15 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">ok, so take steps 6,7,8 from AGYield, push them down into AGResolve (at which point we have to wrap them in &quot;If state is ~executing~&quot; so that other invocations aren&#039;t disturbed), past AGResolve&#039;s `Call` at step 8, and down into AGResumeNext,</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Tue May 04 2021 12:02:28 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">In AGResumeNext, if the queue is not empty, I&#039;m not sure what you mean by &quot;then just execute the logic directly, instead of storing it in the code execution state&quot;</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Tue May 04 2021 12:20:38 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">...</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Tue May 04 2021 12:22:04 GMT-0700 (Pacific Daylight Time)">19:22</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">I&#039;ve been looking at other calls to AGResolve. The one in AGStart is another case where we do a stack-pop without an immediate control-transfer.</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Tue May 04 2021 12:30:31 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">It looks like currently, AGResolve is only invoked when the async context is suspended (not the running context). So that would make me worried about invoking it when the async context *is* the running context.</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Tue May 04 2021 12:34:53 GMT-0700 (Pacific Daylight Time)">19:34</a></td><td class="nick-cell">&lt;<span class="nick nick-3" title=ryzokuken@irc>ryzokuken</span>&gt;</td><td class="msg-cell">is there a way to &quot;break loop&quot; in the spec? Can someone point me to some part of the spec that does that?</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Tue May 04 2021 12:35:17 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell">&lt;<span class="nick nick-3" title=ryzokuken@irc>ryzokuken</span>&gt;</td><td class="msg-cell">I am writing a loop that I need to conditionally break out of...</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Tue May 04 2021 12:35:23 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell">&lt;<span class="nick nick-6" title=ljharb@irc>ljharb</span>&gt;</td><td class="msg-cell">ryzokuken: what&#039;s the use case?</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Tue May 04 2021 12:35:29 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell">&lt;<span class="nick nick-6" title=ljharb@irc>ljharb</span>&gt;</td><td class="msg-cell">ryzokuken: i&#039;d think an AO with an early return would be clearer</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Tue May 04 2021 12:35:42 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell">&lt;<span class="nick nick-3" title=ryzokuken@irc>ryzokuken</span>&gt;</td><td class="msg-cell">ljharb: gotcha</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Tue May 04 2021 12:37:14 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell">&lt;<span class="nick nick-3" title=ryzokuken@irc>ryzokuken</span>&gt;</td><td class="msg-cell">ah okay that makes a whole lot of sense in hindsight, thanks ljharb</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Tue May 04 2021 14:17:44 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">jmdyck: yeah, you&#039;re right: my most recent idea would end up changing the realm for the iterator result object created in AGResolve</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Tue May 04 2021 14:17:50 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">so it wouldn&#039;t be strictly editorial</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Tue May 04 2021 14:17:58 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">however, I am certain it would be web-compat</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Tue May 04 2021 14:18:04 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">cf results in <a href="https://gist.github.com/bakkot/587234af192dcb86f6a76b024a416c1c">https://gist.github.com/bakkot/587234af192dcb86f6a76b024a416c1c</a></td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Tue May 04 2021 14:18:48 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">also, note that the realm for the iterator result object for _regular_ generators is always that of the generator, because the result object is created before the stack-pop</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Tue May 04 2021 14:19:31 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">in that gist I believe FF&#039;s results are the ones which are correct per spec, but I wouldn&#039;t put money on it</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Tue May 04 2021 14:22:48 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell"><a href="https://github.com/tc39/ecma262/compare/master...jmdyck:AsyncGeneratorYield">https://github.com/tc39/ecma262/compare/master...jmdyck:AsyncGeneratorYield</a> is what I had in mind</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Tue May 04 2021 14:24:46 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">this doesn&#039;t work when there&#039;s no await</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Tue May 04 2021 14:25:33 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">no AwaitExpression in the AsyncGeneratorBody?</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Tue May 04 2021 14:25:40 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Tue May 04 2021 14:25:42 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">at least, I think not</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Tue May 04 2021 14:26:12 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">in that case it needs to do the AsyncGeneratorResolve steps, still</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Tue May 04 2021 14:27:25 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">it doesn&#039;t need to do the AsyncGeneratorResumeNext ones, because the steps in that case will just be to return immediately (generally speaking, since the queue would be empty)</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Tue May 04 2021 14:27:37 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so if there isn&#039;t an await, then AGYield is returning to ... AGResumeNext?</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Tue May 04 2021 14:27:47 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">but it needs to resolve the promise created by the first call to `.next`</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Tue May 04 2021 14:27:50 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Tue May 04 2021 14:35:12 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">in your gist, why realm.eval(&#039;foo&#039;) rather than just declaring foo?</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Tue May 04 2021 14:35:52 GMT-0700 (Pacific Daylight Time)">21:35</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">s/declaring/executing/</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Tue May 04 2021 14:36:15 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">as in, why the `eval`? the point is to get a generator whose realm is different from the realm of the outer context</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Tue May 04 2021 14:36:26 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">ah</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Tue May 04 2021 14:39:28 GMT-0700 (Pacific Daylight Time)">21:39</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">I don&#039;t really follow what it&#039;s doing, but you&#039;re saying that implementations are fairly different in the behavior they exhibit, so web devs can&#039;t be relying on a particular behavior, so tc39 is free to pick one?</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Tue May 04 2021 14:41:30 GMT-0700 (Pacific Daylight Time)">21:41</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">(not &quot;pick one of the exhibited behaviors&quot; necessarily, but &quot;pick a specific behavior&quot;)</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Tue May 04 2021 14:43:52 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yup</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Tue May 04 2021 14:44:15 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">in terms of which realm the objects created by these AOs come from</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Tue May 04 2021 14:44:43 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">we&#039;d need consensus, still</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Tue May 04 2021 15:13:30 GMT-0700 (Pacific Daylight Time)">22:13</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">so then what about the calls to AGResolve when the async context isn&#039;t the running context? Won&#039;t they create objects in a different realm from those created when the async context *is* the running context?</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Tue May 04 2021 15:24:43 GMT-0700 (Pacific Daylight Time)">22:24</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yes, unless we patched that</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Tue May 04 2021 15:26:22 GMT-0700 (Pacific Daylight Time)">22:26</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">something like that already happens, though: the iterator result created during normal operation of a non-async generator comes from the generator realm, but if you call `Generator.prototype.return` on the generator after it is already completed you get an object created in the realm of your `Generator.prototype.return`</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Tue May 04 2021 15:26:45 GMT-0700 (Pacific Daylight Time)">22:26</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">(which is not necessarily the same realm as the generator, since you can `.call` it across realms)</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Tue May 04 2021 15:27:17 GMT-0700 (Pacific Daylight Time)">22:27</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">not just `.return` but also `.next` after the generator has completed, I should say</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Tue May 04 2021 15:28:21 GMT-0700 (Pacific Daylight Time)">22:28</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">that is: the iterator result object created in step 2 of GeneratorResume is created in the realm of the caller (e.g. Generator.prototype.return), whereas the iterator result object created in step 3 of Yield is created in the realm of the generator itself</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Tue May 04 2021 15:28:35 GMT-0700 (Pacific Daylight Time)">22:28</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">all this is just to say that we&#039;re already inconsistent here</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Tue May 04 2021 15:38:03 GMT-0700 (Pacific Daylight Time)">22:38</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">sorry, two lines up, for Generator.prototype.return read <a href="http://Generator.prototype.next">Generator.prototype.next</a></td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Tue May 04 2021 16:31:42 GMT-0700 (Pacific Daylight Time)">23:31</a></td><td class="nick-cell">&lt;<span class="nick nick-13" title=jmdyck@irc>jmdyck</span>&gt;</td><td class="msg-cell">Bakkot: and your gist shows that implementations differ even on the non-async generators?</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Tue May 04 2021 16:39:18 GMT-0700 (Pacific Daylight Time)">23:39</a></td><td class="nick-cell">&lt;<span class="nick nick-8" title=Bakkot@irc>Bakkot</span>&gt;</td><td class="msg-cell">yup</td></tr>

</tbody></table></div></div></div></body>
