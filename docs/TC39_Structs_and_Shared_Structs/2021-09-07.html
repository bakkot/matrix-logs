<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2021-09-07</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2021-09-07<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-09-06" class="nav-link"><span>prev</span></a>
<a href="2021-09-09" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>
<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Sep 07 2021 08:26:19 GMT-0700 (Pacific Daylight Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">this room also never had an orange TC39 logo for me</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Sep 07 2021 08:26:25 GMT-0700 (Pacific Daylight Time)">15:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">dunno how this stuff works</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Sep 07 2021 08:31:51 GMT-0700 (Pacific Daylight Time)">15:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@atakikawa:igalia.com">asumu</span>&gt;</div></td><td class="msg-cell">At 9AM PDT I'll be talking a bit about the connection between Wasm GC &amp; this proposal (among other things) at the Wasm GC subgroup: <a href="https://github.com/WebAssembly/gc/issues/237">https://github.com/WebAssembly/gc/issues/237</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Sep 07 2021 10:00:53 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">sorry i missed this, i don't have the GC subgroup meetings on my calendar, though always happy to attend fewer meetings</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Sep 07 2021 10:00:56 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">how did it go, asumu?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Sep 07 2021 10:09:59 GMT-0700 (Pacific Daylight Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@atakikawa:igalia.com">asumu</span>&gt;</div></td><td class="msg-cell">I think it went well! There was a lot of agreement overall. One of the bigger points of discussion was what can be done about type-checking in the JS-&gt;Wasm direction. There was some discussion on how that might be possible by extending Wasm's API, perhaps even without adding more types to the JS structs proposal (which of course we had agreed wasn't part of the initial proposal).</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Sep 07 2021 10:10:05 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@atakikawa:igalia.com">asumu</span>&gt;</div></td><td class="msg-cell">Slides here: <a href="https://docs.google.com/presentation/d/1XwCwOQvTTuV5mU74d2wLnEqsdpi20ReCxtFRZLcW0EA/edit?usp=sharing">https://docs.google.com/presentation/d/1XwCwOQvTTuV5mU74d2wLnEqsdpi20ReCxtFRZLcW0EA/edit?usp=sharing</a></td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Sep 07 2021 12:36:57 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">cool, thanks for the slides</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Sep 07 2021 12:37:22 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">makes me think i should attend the GC subgroup meetings, if only mostly as an observer</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Sep 07 2021 12:38:41 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">One thing that Shu and I were discussing was the possibility of using decorators to handle marshaling behavior for things like FFIs. I'm still interested in RTT support and how to align that with TypeScript</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Sep 07 2021 12:47:18 GMT-0700 (Pacific Daylight Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>In the proposal draft I was working on, I used <code>: type</code> (similar to TypeScript) for a restricted subset of types, with the possibility of using something like TS generics for specific subtyping (i.e., <code>kind: i32&lt;Kind&gt;</code>, where the <code>&lt;Kind&gt;</code> would be erased by TS on emit). Another approach was a prefix <code>(type)</code> similar to what I was thinking for operator overloading:</p>
<pre><code>struct Point {
  (i32) x;
  (i32) y;
  static (Point + i32) (a, b) { return new Point(a.x + b, a.y + b); }
  ...
}
</code></pre>
<p>But this could also theoretically be handled by decorators under the current proposal:</p>
<pre><code>struct class Point {
  @WebAssembly.Type("i32") x;
  @WebAssembly.Type("i32") y;
}
// or
const { i32 } = WebAssembly.Types;
struct class Point {
  @i32 x;
  @i32 y;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Sep 07 2021 13:57:29 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">using decorators makes sense if types (really, "size + representation" instead of "type" writ large) were always applied via API like a WebAssembly API</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Sep 07 2021 13:58:10 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but i think a desire exists to declare size+representation for JS structs for use within JS as well, and how would that work?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Sep 07 2021 13:58:53 GMT-0700 (Pacific Daylight Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">and to be clear, i think a world where the size+repr are only the purview of WebAssembly is actually fine</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Sep 07 2021 13:59:16 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but that might ruffle some feathers for platforms that don't want to include wasm but do want sized fields</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Sep 07 2021 16:00:18 GMT-0700 (Pacific Daylight Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>The <code>@type</code> decorator approach wouldn't be the first time we've seen a similar proposal. I think littledan considered something for user-defined numeric literal suffixes as well (i.e., <code>123@px</code>).</p>
<p>Also, it wouldn't necessarily need to be tied to <code>WebAssembly</code> if we went with that approach. There are a few use cases it doesn't solve though (like fixed size arrays, etc.) that I was considering here: <a href="https://github.com/rbuckton/proposal-struct#field-types">https://github.com/rbuckton/proposal-struct#field-types</a></p>
</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Sep 07 2021 16:17:51 GMT-0700 (Pacific Daylight Time)">23:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Specific cases being something like:</p>
<ol>
<li><code>i32[8]</code> for a fixed-size array of 8 32-bit signed integers (derived from standard C/C++ array field declarators and C# array field declarators)</li>
<li><code>i32[length]</code> for a dependent-sized array whose size is derived from another field on the object (roughly based on <a href="https://docs.microsoft.com/en-us/windows/win32/midl/midl-arrays">https://docs.microsoft.com/en-us/windows/win32/midl/midl-arrays</a>, though possibly not feasible if <code>length</code> is mutable).</li>
<li><code>i32[]</code> for a flexible-sized array (based on C99 flexible array members <a href="https://en.wikipedia.org/wiki/Flexible_array_member">https://en.wikipedia.org/wiki/Flexible_array_member</a>)</li>
</ol>
</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Sep 07 2021 16:20:07 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">you think those can be done with decorators instead of building them in?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Sep 07 2021 16:20:10 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">(2) may be unlikely. In most cases where I've seen a similar construct it has been purely informative and primarily intended for describing marshaling.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Sep 07 2021 16:20:10 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">or should be done with decorators?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Sep 07 2021 16:20:39 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I think either are feasible, though building in syntax might be preferred.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Sep 07 2021 16:20:43 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">(3) is enshrining a common pattern in the kind of programming i do, i'd be happy with that</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Sep 07 2021 16:28:29 GMT-0700 (Pacific Daylight Time)">23:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Decorators do provide some flexibility, and we could leverage <em>MetaProperty</em>, i.e.:</p>
<pre><code>struct class Foo {
  @struct.type(struct.i32)
  x;
  @struct.type(struct.i32, { size: 8 })
  y;
  @struct.type(struct.i32, { size: "flexible" })
  z;
}
</code></pre>
<p>You would run into the same issue decorators has with circular references though:</p>
<pre><code>struct class A {
  @struct.type(struct.i32)
  size;
  @struct.type(B, { size: "flexible" })
  bArray;
}
struct class B {
  @struct.type(struct.i32)
  size;
  @struct.type(A, { size: "flexible" })
  aArray;
}
</code></pre>
<p>That was one of the other motivators for <code>ref</code>:</p>
<pre><code>struct class A {
  @struct.type(struct.i32)
  size;
  @struct.type(ref B, { size: "flexible" }) // reference `B`
  bArray;
}
struct class B {
  @struct.type(struct.i32)
  size;
  @struct.type(A, { size: "flexible" })
  aArray;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Sep 07 2021 16:29:50 GMT-0700 (Pacific Daylight Time)">23:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Downsides of <em>MetaProperty</em> are the repetition and the fact you can't destructure.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Sep 07 2021 16:29:54 GMT-0700 (Pacific Daylight Time)">23:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">sorry, would like to engage more fully here but am busy today. are you mainly interested in discussing the syntax space for a unified future-proof mechanism for both types and arrays?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Sep 07 2021 16:30:11 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">(more top of mind for me is whether we should pull arrays into scope)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Sep 07 2021 16:30:33 GMT-0700 (Pacific Daylight Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'm interested in that among other things, yes.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Sep 07 2021 16:31:41 GMT-0700 (Pacific Daylight Time)">23:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Arrays are definitely useful, otherwise your only option for shared lists will be linked lists</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Sep 07 2021 16:34:19 GMT-0700 (Pacific Daylight Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Of course, <code>struct</code> isn't a reserved word, so it wouldn't be a <em>MetaProperty</em> anyways...</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Sep 07 2021 16:37:23 GMT-0700 (Pacific Daylight Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><em>If</em> types are defined via decorators we'd need some place to put them. That same place would be as good as any other for defining possible marshalling behavior for other things as well (like pseudo-blittable representations, struct layout and packing behavior, marshalling strings and arrays, FFI interop mechanisms, etc.)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Sep 07 2021 16:39:10 GMT-0700 (Pacific Daylight Time)">23:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Maybe a global <code>Interop</code> object (since anything non-Proxy related can't go on <code>Reflect</code>). Then you could write:</p>
<pre><code>const { type, i32 } = Interop;
struct class Foo {
  @type(i32) x;
  @type(i32) y;
}
</code></pre>
<p>But there's plenty to bikeshed there.</p>
</td></tr>

</tbody></table></div></div></div>
</body></html>