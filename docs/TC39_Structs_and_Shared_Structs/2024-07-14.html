<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2024-07-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2024-07-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-13" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sat Jul 13 2024 17:07:48 GMT-0700 (Pacific Daylight Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><p>Here’s an idea for the semantic details for unsafe, Reflect, Atomics, and MOP for shared structs:</p>
<ul>
<li>There is an abstract op, GetUnsafe(obj, propKey), which checks whether the obj is a shared struct, if so tries to get the propKey, if it is missing or if it isn’t a shared struct, fall back to Get. Analogously for SetUnsafe.</li>
<li>Reflect.getUnsafe/setUnsafe expose these ops</li>
<li>inside of an unsafe {} block, all direct property access is interpreted as GetUnsafe/SetUnsafe</li>
<li>Get and Set on shared structs are missing their own data properties. Those props don’t show up for any other MOP things either. But the thread-local prototype is present (it isn’t unsafe; a method might call an unsafe thing as an implementation detail though)</li>
<li>Atomics are always unsafe (that’s literally the point) so they are just overloaded for shared struct properties regardless of where they come from.</li>
<li>if we were doing SAB today, we might also consider this same unsafe restriction, but what’s done is done. This only applies for shared structs.</li>
</ul></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sat Jul 13 2024 18:10:37 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The property keys need to show up in MOP operations. <code>in</code> and <code>hasOwnProperty</code> and <code>Reflect.has</code> are safe because structs have a fixed layout.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sat Jul 13 2024 18:12:07 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Though [[Get]] and [[Set]] would throw</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sat Jul 13 2024 18:14:34 GMT-0700 (Pacific Daylight Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">What do you mean by "Atomics are always unsafe?" my perspective is that Atomics should not need an <code>unsafe</code> block at all</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sat Jul 13 2024 18:22:24 GMT-0700 (Pacific Daylight Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What do you mean by "Atomics are always unsafe?" my perspective is that Atomics should not need an <code>unsafe</code> block at all</blockquote></mx-reply>I think we are saying the same thing</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sat Jul 13 2024 18:22:29 GMT-0700 (Pacific Daylight Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">OK</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sat Jul 13 2024 18:23:06 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The property keys need to show up in MOP operations. <code>in</code> and <code>hasOwnProperty</code> and <code>Reflect.has</code> are safe because structs have a fixed layout.</blockquote></mx-reply>Sure, that makes sense. The important thing is that normal MOP operations can’t get at the contents, it’s just this other operation that can</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sat Jul 13 2024 18:23:22 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The rest of what you describe sounds like another namespace (like private names) which we absolutely do not want</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sat Jul 13 2024 18:23:45 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The rest of what you describe sounds like another namespace (like private names) which we absolutely do not want</blockquote></mx-reply>Not sure what you mean. It is still strings (or maybe symbols)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sat Jul 13 2024 18:24:18 GMT-0700 (Pacific Daylight Time)">01:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I am not especially attached to the idea I wrote above, it is just the simplest thing I can imagine. How do you think unsafe blocks should work with respect to the MOP?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sat Jul 13 2024 18:24:49 GMT-0700 (Pacific Daylight Time)">01:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It sounded like you were saying that shared struct properties are transparent to MOP operations, which would not be correct</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sat Jul 13 2024 18:25:11 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It sounded like you were saying that shared struct properties are transparent to MOP operations, which would not be correct</blockquote></mx-reply>Not transparent, just missing</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sat Jul 13 2024 18:25:39 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Maybe that is what you meant</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sat Jul 13 2024 18:25:45 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes, thats what I meant</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sat Jul 13 2024 18:25:48 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">they cannot be missing</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sat Jul 13 2024 18:26:18 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You cannot have a [[Get]] outside of <code>unsafe</code> return a prototype property if there was a struct field of the same name.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sat Jul 13 2024 18:26:28 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Can you explain how you think it should work?</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sat Jul 13 2024 18:26:39 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">They have to treat them like normal properties, except that [[Get]] and [[Set]] throws.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Sat Jul 13 2024 18:26:48 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">How?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Sat Jul 13 2024 18:27:03 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You override [[Get]] and [[Set]] for shared struct objects. </td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Sat Jul 13 2024 18:27:11 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Those are abstract.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Sat Jul 13 2024 18:28:03 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Will GetOwnPropertyDescriptor throw?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Sat Jul 13 2024 18:28:19 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Lets say you have [[Get]], [[Set]], [[UnsafeGet]], and [[UnsafeSet]]. On all objects, [[UnsafeGet]]/[[UnsafeSet]] just forwards on to the ordinary get/set behavior.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Sat Jul 13 2024 18:28:28 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">What happens in the unsafe blocks?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Sat Jul 13 2024 18:28:30 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But shared structs have a [[Get]] and [[Set]] that throw.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Sat Jul 13 2024 18:28:49 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">In an unsafe block, get operations use [[UnsafeGet]]/[[UnsafeSet]] instead of [[Get]]/[[Set]]</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sat Jul 13 2024 18:29:50 GMT-0700 (Pacific Daylight Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Even without <code>unsafe</code> we need to do something similar to handle shared memory access for shared struct fields in [[Get]] and [[Set]], so we already expect to pay this cost.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sat Jul 13 2024 18:31:01 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">GetOwnPropertyDescriptor would probably throw outside of <code>unsafe</code>, or possibly would return a new descriptor that is <code>{ enumerable: ?, writable: ?, configurable: false, shared: true }</code> with no <code>value</code> property.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Sat Jul 13 2024 18:31:41 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">OK, so how does Object.getOwnPropertyDescriptor know if it’s in an unsafe block?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Sat Jul 13 2024 18:31:47 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But <code>in</code> and <code>Reflect.has</code> et al should work outside of unsafe because for a given reference to a shared struct, it will still have a fixed shape.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Sat Jul 13 2024 18:32:21 GMT-0700 (Pacific Daylight Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I was trying to avoid functions changing behavior based on their caller</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Sat Jul 13 2024 18:33:38 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> You cannot have a [[Get]] outside of <code>unsafe</code> return a prototype property if there was a struct field of the same name.</blockquote></mx-reply>I think this problem can be fixed in my suggestion without making any new MOP ops or anything</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Sat Jul 13 2024 18:33:44 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We could have gOPD return a new kind of descriptor both in and out of <code>unsafe</code>, and an <code>Reflect.unsafeGetOwnPropertyDescriptor</code> that has the same magic that <code>Reflect.unsafeGet</code>/<code>Reflect.unsafeSet</code> would have (if any).</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Sat Jul 13 2024 18:34:49 GMT-0700 (Pacific Daylight Time)">01:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Maybe gOPD would throw if you don’t call the unsafe one?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Sat Jul 13 2024 18:35:01 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You need MOP operations to be reliable. What happens if I do <code>Object.create(sharedStruct)</code>? Now I have a normal JS object with a shared struct prototype. If I call [[Get]] on the result it should still throw if it tries to read a prototype field outside of <code>unsafe</code>.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Sat Jul 13 2024 18:35:11 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Do we have unsafeDefineProperty?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Sat Jul 13 2024 18:35:22 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">getOPD shouldn't throw. Nothing causes it to throw today, to my knowledge.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Sat Jul 13 2024 18:35:34 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">No. You can't call defineProperty on a shared struct, it would fail.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Sat Jul 13 2024 18:35:39 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Shared struct instances are sealed.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Sat Jul 13 2024 18:35:46 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">No new properties, no deleting properties.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Sat Jul 13 2024 18:35:57 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Even if the property descriptor matches what’s already there?</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Sat Jul 13 2024 18:36:06 GMT-0700 (Pacific Daylight Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> getOPD shouldn't throw. Nothing causes it to throw today, to my knowledge.</blockquote></mx-reply>Proxy can</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Sat Jul 13 2024 18:36:08 GMT-0700 (Pacific Daylight Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Normal defineProperty would just fail because of the existing integrity checks</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Sat Jul 13 2024 18:36:43 GMT-0700 (Pacific Daylight Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Normal defineProperty would just fail because of the existing integrity checks</blockquote></mx-reply>I don’t think that’s the case if you define it as what it’s already defined to be, but with a different value</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Sat Jul 13 2024 18:36:44 GMT-0700 (Pacific Daylight Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">AFAIK, no developers code defensively against gOPD failing. </td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Sat Jul 13 2024 18:36:54 GMT-0700 (Pacific Daylight Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That's fair</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Sat Jul 13 2024 18:37:38 GMT-0700 (Pacific Daylight Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Maybe we do need <code>unsafeDefineProperty</code>. I do want to be able to change <code>writable</code></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Sat Jul 13 2024 18:37:50 GMT-0700 (Pacific Daylight Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But you can't create new properties with it.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Sat Jul 13 2024 18:39:06 GMT-0700 (Pacific Daylight Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Maybe instead of <code>Reflect.unsafeX</code> we have <code>Reflect.unsafe.X</code> which just mirrors <code>Reflect</code></td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Sat Jul 13 2024 18:39:10 GMT-0700 (Pacific Daylight Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I would start simple and omit unsafeGOPD and unsafeDP, letting these always throw on shared struct data props. That might be the only observable difference between the ways we are thinking about this.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Sat Jul 13 2024 18:39:19 GMT-0700 (Pacific Daylight Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">(except for <code>deleteProperty</code> since that will never work?)</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Sat Jul 13 2024 18:39:58 GMT-0700 (Pacific Daylight Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Maybe instead of <code>Reflect.unsafeX</code> we have <code>Reflect.unsafe.X</code> which just mirrors <code>Reflect</code></blockquote></mx-reply>I am a fan of namespace objects, but I don’t know how much of this we need to fill in</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Sat Jul 13 2024 18:40:18 GMT-0700 (Pacific Daylight Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I really would like to make fields non-writable, though I've been thinking we some kind of "init-only" modifier for fields that can only be initialized in the constructor.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Sat Jul 13 2024 18:41:18 GMT-0700 (Pacific Daylight Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I really would like to make fields non-writable, though I've been thinking we some kind of "init-only" modifier for fields that can only be initialized in the constructor.</blockquote></mx-reply>Yeah I don’t think nonwritable is a good solution for this. We would need initializer lists. Anyway I imagined shared struct fields would be nonconfigurable</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Sat Jul 13 2024 18:41:31 GMT-0700 (Pacific Daylight Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But we probably should have some kind of <code>getOwnPropertyDescriptor</code> support at some point.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Sat Jul 13 2024 18:41:38 GMT-0700 (Pacific Daylight Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes, they are non-configurable</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Sat Jul 13 2024 18:42:20 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">So… no particular use for defineProperty then</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Sat Jul 13 2024 18:42:52 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But we probably should have some kind of <code>getOwnPropertyDescriptor</code> support at some point.</blockquote></mx-reply>Some kind of introspection would be good, but maybe this should be focused on the class level</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Sat Jul 13 2024 18:43:00 GMT-0700 (Pacific Daylight Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Even if we don't have gOPD, I want to make sure we can still do <code>{ ...sharedStruct }</code> inside of an <code>unsafe</code> block as it could be an efficient way to copy the properties off of the struct while in a lock.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Sat Jul 13 2024 18:44:09 GMT-0700 (Pacific Daylight Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Even if we don't have gOPD, I want to make sure we can still do <code>{ ...sharedStruct }</code> inside of an <code>unsafe</code> block as it could be an efficient way to copy the properties off of the struct while in a lock.</blockquote></mx-reply>Huh, how do you attach the right cross realm prototype identifier?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Sat Jul 13 2024 18:44:30 GMT-0700 (Pacific Daylight Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">you don't? You're not creating a shared struct instance, just a normal object.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Sat Jul 13 2024 18:44:46 GMT-0700 (Pacific Daylight Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Shared struct instances can only be created via a constructor.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Sat Jul 13 2024 18:45:03 GMT-0700 (Pacific Daylight Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Oic. Yes that should be handled like . Access</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Sat Jul 13 2024 18:45:11 GMT-0700 (Pacific Daylight Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code>{ ...sharedStruct }</code> is "give me a normal object that is a copy of the struct fields"</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Sat Jul 13 2024 18:47:47 GMT-0700 (Pacific Daylight Time)">01:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I skipped a lot of the discussion, but do shared properties have to appear as data properties, or could they appear as own accessors?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Sat Jul 13 2024 18:48:58 GMT-0700 (Pacific Daylight Time)">01:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I guess accessors would be a significant overhead and that engines wouldn't always be able to optimize the same as data props?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Sat Jul 13 2024 18:55:13 GMT-0700 (Pacific Daylight Time)">01:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">The problem we are trying to solve is how to explain unsafe blocks. I don’t see how accessors help.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Sat Jul 13 2024 18:58:28 GMT-0700 (Pacific Daylight Time)">01:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Well accessors means there are no issues with any of the MOP and no special property descriptors</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Sat Jul 13 2024 18:58:30 GMT-0700 (Pacific Daylight Time)">01:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">get <em>already</em> has a lexical rule for <code>"use strict"</code>. We could just encode [[Unsafe]] on a Reference Record just as we do [[Strict]], and just have the relevant operations check [[Unsafe]] when resolving the reference.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Sat Jul 13 2024 19:00:29 GMT-0700 (Pacific Daylight Time)">02:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">i.e., <code>GetValue</code> checks for [[Strict]] for variable references. We could modify Step 3.d to check for [[Unsafe]] and call baseObj.[[UnsafeGet]] in that case.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Sat Jul 13 2024 19:01:07 GMT-0700 (Pacific Daylight Time)">02:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Of course we're just pushing the problem down into a problem of function invocation working differently depending on the context where the call occurs, sometimes nested in the case of Reflect.get calling an "accessors"</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Sat Jul 13 2024 19:01:35 GMT-0700 (Pacific Daylight Time)">02:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Adding an [[UnsafeGet]] slot on objects seems to mesh better with the current spec than an UnsafeGet AO  </td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Sat Jul 13 2024 19:02:34 GMT-0700 (Pacific Daylight Time)">02:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">It really feels that function coloring actually explains all this much better</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Sat Jul 13 2024 19:02:45 GMT-0700 (Pacific Daylight Time)">02:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If we don't have function coloring, we could just allow you to call the <code>Reflect.unsafeX</code> outside of an <code>unsafe</code> block. Its in the name, so it's already labeled unsafe.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Sat Jul 13 2024 19:03:23 GMT-0700 (Pacific Daylight Time)">02:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Well accessors means there are no issues with any of the MOP and no special property descriptors</blockquote></mx-reply>How are accessors supposed to know whether they are in an unsafe block?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Sat Jul 13 2024 19:05:13 GMT-0700 (Pacific Daylight Time)">02:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How are accessors supposed to know whether they are in an unsafe block?</blockquote></mx-reply>Yes that's the problem. Accessor simply reduce to a single kind of problem: function calls, instead of also dealing with the other meta ops. But it remains a problem that it's hard to explain the behavior without function coloring</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Sat Jul 13 2024 19:06:12 GMT-0700 (Pacific Daylight Time)">02:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Could you describe how you picture function coloring to work?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Sat Jul 13 2024 19:06:38 GMT-0700 (Pacific Daylight Time)">02:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>e.g., something like this but with proper support for <code>receiver</code></p>
<pre><code class="language-js">Reflect.unsafeGet = (obj, key) =&gt; {
  if ({}.hasOwnProperty.call(obj, key)) {
    unsafe {
      return obj[key];
    }
  }
  return Reflect.get(obj, key);
}
</code></pre>
</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Sat Jul 13 2024 19:07:57 GMT-0700 (Pacific Daylight Time)">02:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How are accessors supposed to know whether they are in an unsafe block?</blockquote></mx-reply>Accessors like <code>get foo() { }</code>? They don't? They're just a function. If you expose a getter/setter on your struct you need to do your due diligence to make it safe to outside callers.</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Sat Jul 13 2024 19:09:25 GMT-0700 (Pacific Daylight Time)">02:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">shared struct S {
  #mut = new Atomics.Mutex();
  #x;
  get x() {
    unsafe {
      using lck = new Atomics.UniqueLock(this.#mut);
      return this.#x;
    }
  }
}
</code></pre>
<p>It's nasty, but I suppose that's the point?</p>
</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Sat Jul 13 2024 19:11:37 GMT-0700 (Pacific Daylight Time)">02:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Although, without function coloring I don't see how <code>accessor x;</code> could ever work. At least, not without doing <code>unsafe accessor x;</code> or <code>accessor x unsafe;</code> or something</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Sat Jul 13 2024 19:13:16 GMT-0700 (Pacific Daylight Time)">02:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">The way I picture function coloring is that every callable now has 2 ops: `[[Call]]` and `[[CallUnsafe]]`. If you are in an unsafe block, it's CallUnsafe that gets executed. For normal functions, CallUnsafe is the same as Call (maybe it's missing and it falls back to Call when missing?). For shared functions, Call throws (can only be called from unsafe blocks). Reflect and other intrinsics can have different Call and CallUnsafe behaviors, that effectively "forward" the unsafe state of the call site.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Sat Jul 13 2024 19:13:43 GMT-0700 (Pacific Daylight Time)">02:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">this example makes me wonder something... should a shared struct even be exposed? in rust for example you'd write your code like <code>struct Public(Mutex&lt;Shared&gt;)</code>, rather than <code>struct Shared { mutex: Mutex&lt;()&gt;, ...Shared }</code></td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Sat Jul 13 2024 19:14:01 GMT-0700 (Pacific Daylight Time)">02:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'll have to follow up on any other discussion on Monday.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Sat Jul 13 2024 19:15:22 GMT-0700 (Pacific Daylight Time)">02:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That example I gave is a bad one </td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Sat Jul 13 2024 19:15:35 GMT-0700 (Pacific Daylight Time)">02:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The way I picture function coloring is that every callable now has 2 ops: `[[Call]]` and `[[CallUnsafe]]`. If you are in an unsafe block, it's CallUnsafe that gets executed. For normal functions, CallUnsafe is the same as Call (maybe it's missing and it falls back to Call when missing?). For shared functions, Call throws (can only be called from unsafe blocks). Reflect and other intrinsics can have different Call and CallUnsafe behaviors, that effectively "forward" the unsafe state of the call site.</blockquote></mx-reply>this sounds coherent to me, but it's not what I would call "function coloring", which would apply recursively somehow, like async/await</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Sat Jul 13 2024 19:15:57 GMT-0700 (Pacific Daylight Time)">02:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But yes, we think a shared struct should be exposed. Mutex and shared struct are not strongly tied to each other.</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Sat Jul 13 2024 19:17:12 GMT-0700 (Pacific Daylight Time)">02:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Function coloring does not imply recursive application. Async/await poisoning occurs because you are taking an inherently sequential, synchronous operation and want to turn it into a sequential asynchronous operation.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Sat Jul 13 2024 19:17:49 GMT-0700 (Pacific Daylight Time)">02:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> this sounds coherent to me, but it's not what I would call "function coloring", which would apply recursively somehow, like async/await</blockquote></mx-reply>Right, technically you can have an <code>CallUnsafe</code> implementation that is not itself an unsafe scope</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Sat Jul 13 2024 19:17:58 GMT-0700 (Pacific Daylight Time)">02:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Async/await has function coloring (of a sort), but function coloring is not async/await.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Sat Jul 13 2024 19:18:12 GMT-0700 (Pacific Daylight Time)">02:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">no i don't mean you should have to use mutex specifically, that's just the example here.</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Sat Jul 13 2024 19:18:29 GMT-0700 (Pacific Daylight Time)">02:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(I'm not criticizing the approach, it's just drastically different from what I expected when people started using the term "function coloring")</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Sat Jul 13 2024 19:19:53 GMT-0700 (Pacific Daylight Time)">02:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> no i don't mean you should have to use mutex specifically, that's just the example here.</blockquote></mx-reply>you can organize your code however you want. My use cases have entire object graphs of shared objects with any coordination being through  lock-free concurrent collections.</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Sat Jul 13 2024 19:20:47 GMT-0700 (Pacific Daylight Time)">02:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (I'm not criticizing the approach, it's just drastically different from what I expected when people started using the term "function coloring")</blockquote></mx-reply>It's possible I also misunderstood what people had in mind, but that is what I understood could work</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Sat Jul 13 2024 19:22:38 GMT-0700 (Pacific Daylight Time)">02:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I was never concerned about function coloring, just that we didn't repeat async/await poisoning by essentially requiring your entire application to be inside of an <code>unsafe {}</code> block to use the feature.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Sat Jul 13 2024 19:22:45 GMT-0700 (Pacific Daylight Time)">02:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I think it would even be possible to make proxies work that way. As well as let user land do the same as intrinsics by having functions that have dual safe and unsafe behaviors</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Sat Jul 13 2024 19:23:12 GMT-0700 (Pacific Daylight Time)">02:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">keeping <code>unsafe</code> localized to just the code that is actually unsafe is important.</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Sat Jul 13 2024 19:24:18 GMT-0700 (Pacific Daylight Time)">02:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Having functions that are aware of the context with which they are invoked is nothing new. <code>unsafe</code> is more like <code>this</code> than <code>async</code>/<code>await</code>, to be honest. <code>async</code> functions don't care how you call them and its up to the callers to determine if they want to use <code>await</code> or <code>.then</code>.</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Sat Jul 13 2024 19:24:37 GMT-0700 (Pacific Daylight Time)">02:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I was never concerned about function coloring, just that we didn't repeat async/await poisoning by essentially requiring your entire application to be inside of an <code>unsafe {}</code> block to use the feature.</blockquote></mx-reply>Yeah I think that's accomplished by letting you start an unsafe block without modifying the signature of the surrounding function</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Sat Jul 13 2024 19:24:44 GMT-0700 (Pacific Daylight Time)">02:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Having an operation that throws outside of <code>unsafe</code> is more like having a function that throws if you give it the wrong <code>this</code>.</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Sat Jul 13 2024 19:26:22 GMT-0700 (Pacific Daylight Time)">02:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">From a spec perspective, we just have to carry along this extra bit of information that indicates whether you were inside or outside of an <code>unsafe</code> block before you get/set.</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Sat Jul 13 2024 19:27:21 GMT-0700 (Pacific Daylight Time)">02:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Aside from whatever we decide for <code>Reflect</code>, we could just ship with <code>unsafe {}</code> and add "function coloring" later if needs be.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Sat Jul 13 2024 19:29:43 GMT-0700 (Pacific Daylight Time)">02:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">For something like <code>unsafe function f() {}</code> I was less concerned with "function coloring" and more about improving the DX by moving the <code>unsafe</code> out of the block to cover the contents of the whole function (including parameter lists). I think the fact I proposed it as a prefix keyword led to the "function coloring" implication of unsafe functions in Rust, that the function itself is somehow unsafe. But it could just as easily have been <code>function f() unsafe { }</code> (and is an alternative I mentioned in the related issue on the repo).</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Sat Jul 13 2024 19:30:50 GMT-0700 (Pacific Daylight Time)">02:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'm just not a fan of the C++ namespace nesting style. It looks terrible and there's no reason we should repeat that approach.</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Sat Jul 13 2024 19:31:03 GMT-0700 (Pacific Daylight Time)">02:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">what if you want a function that should be unsafe to call, <code>unsafe</code> on the declaration referring to the body seems inverted to the expectation of someone using that function.</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Sat Jul 13 2024 19:32:35 GMT-0700 (Pacific Daylight Time)">02:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> what if you want a function that should be unsafe to call, <code>unsafe</code> on the declaration referring to the body seems inverted to the expectation of someone using that function.</blockquote></mx-reply>Then we reserve the prefix position for that, where <code>unsafe &lt;x&gt; ...</code> means "x is unsafe and does unsafe things" while <code>&lt;x&gt; unsafe ...</code> means "x is safe, but does unsafe things".</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Sat Jul 13 2024 19:35:14 GMT-0700 (Pacific Daylight Time)">02:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">i.e., <code>function f() unsafe {}</code> is just shorthand for <code>function f() { unsafe { } }</code>. You use that for functions in your API that are at the safe/unsafe boundary. <code>unsafe function f() {}</code>, if we added it, would only be intended to be used for functions inside of your library/app that don't perform any locking as they expect to be called from code that has already done any necessary coordination.</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Sat Jul 13 2024 19:36:23 GMT-0700 (Pacific Daylight Time)">02:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">that sounds reasonable</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Sat Jul 13 2024 19:36:32 GMT-0700 (Pacific Daylight Time)">02:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">i like composing with block syntax everywhere</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Sat Jul 13 2024 19:37:41 GMT-0700 (Pacific Daylight Time)">02:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code>unsafe</code> should be as narrow as is reasonable, while being as broad as is useful. I like the idea of being able to write <code>shared struct S unsafe {}</code> and have the whole body be unsafe, but also having <code>shared struct S { foo() unsafe { } }</code> when I want to limit exposure at the edges of a public API.</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Sat Jul 13 2024 19:40:02 GMT-0700 (Pacific Daylight Time)">02:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">for example, I might have a <code>shared struct ConcurrentDeque&lt;T&gt; { ... }</code> whose public methods are safe to use and whose contents are private and encapsulated. But I might also want to have a <code>shared struct RingBuffer&lt;T&gt; unsafe { ... }</code> because the whole body will contain unsafe code and the struct won't be exposed outside of my API.</td></tr>

</tbody></table></div></div></div>
</body></html>