<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2024-10-11</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2024-10-11<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-10-10" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Oct 10 2024 17:13:22 GMT-0700 (Pacific Daylight Time)">00:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>WASM integration: I doubt an FFI style approach and wasm having to go through JS would be acceptable for every shared field access?</p>
</blockquote>
<p>privacy is a source-language level concept, not a target language level concept. how JS structs are reflected in wasm is just an independent discussion IMO.</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Oct 10 2024 17:14:03 GMT-0700 (Pacific Daylight Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>shared struct extend: the semantics of privates in JS is lexical. I think we may need a notion of protected here. Or at least a way to extract and represent the power to access private fields (which could be used to solve the wasm issue as well)</p>
</blockquote>
<p>yes, the existing semantics of #-names binds us in a way. i don't have a good answer</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Oct 10 2024 17:14:21 GMT-0700 (Pacific Daylight Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">like wasmgc structs don't have names, just offsets, right?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Oct 10 2024 17:14:27 GMT-0700 (Pacific Daylight Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">privacy is just not a question there</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Oct 10 2024 17:30:22 GMT-0700 (Pacific Daylight Time)">00:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> for unsafe {}, mark is also happy with "all shared struct fields always private", then we don't need unsafe {}, because the idea is the public API must be written by the developer, which should be threadsafe<br><br>the implementation constraint for me with that world is that we must be able to compile #-names in shared structs just as normal property slots. because of the "#-names have different identities depending on the evaluation of the class declaration" thing, they are wildly inefficient in engines. this problem might not exist at all if we have the restriction that struct decls are top-level only and thus can't be reevaluated anyways<br><br>so that sounds like a promising thing for us to explore</blockquote></mx-reply>If struct fields are always private, how would you even use them with Atomics? I'm not sure I'm in favor of that direction, for more reasons than that.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Oct 10 2024 17:58:35 GMT-0700 (Pacific Daylight Time)">00:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If struct fields are always private, how would you even use them with Atomics? I'm not sure I'm in favor of that direction, for more reasons than that.</blockquote></mx-reply>you expose methods that does the atomics thing</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Oct 10 2024 17:58:59 GMT-0700 (Pacific Daylight Time)">00:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">the "always private" direction has a strong dependency on per-realm prototypes with methods</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Oct 10 2024 17:59:17 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">oh you mean, like, you can't reify #-names so how do you even call Atomics.load</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Oct 10 2024 17:59:19 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i misunderstood</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Oct 10 2024 17:59:46 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yeah idk</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Oct 10 2024 17:59:51 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">we're gonna need to come up with something there</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Oct 10 2024 18:00:26 GMT-0700 (Pacific Daylight Time)">01:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i am of course more than happy with a direction with neither unsafe{} <em>nor</em> always private, but i think agoric still can't live with that</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Oct 10 2024 18:03:48 GMT-0700 (Pacific Daylight Time)">01:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">the atomics thing is one to be solved regardless of always-private, i suppose, because <span class="nick-15">rbuckton</span> you wanted to be able to use private state eventually anyway</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Oct 10 2024 18:04:18 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> you expose methods that does the atomics thing</blockquote></mx-reply>This doesn't make sense. Atomics requires a field name, but you cannot reference a private field</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Oct 10 2024 18:04:30 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i know, i misunderstood the question</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Oct 10 2024 18:06:28 GMT-0700 (Pacific Daylight Time)">01:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I agree, and I already have a solution for this, but I also am not partial to private fields only as a direction. I could have multiple structs representing a complex data structure that are fully guarded, but I would always have to access their fields indirectly through accessors? IMO, that is not a great solution.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Oct 10 2024 18:07:17 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i think if you have a bunch of friend classes, i agree friend classes ought to be able to see each other somehow, but i don't know how complex we wanna make it</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Oct 10 2024 18:07:38 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but we still need to thread the needle between a guardrail that Agoric requires for this to progress</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Oct 10 2024 18:08:00 GMT-0700 (Pacific Daylight Time)">01:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that's the most viable option i see, if choosing between this and no guardrails at all</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Oct 10 2024 18:08:03 GMT-0700 (Pacific Daylight Time)">01:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">are there other ideas?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Oct 10 2024 18:08:43 GMT-0700 (Pacific Daylight Time)">01:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">(assuming unsafe{} is dead in the water, given how much opposition we heard during plenary)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Oct 10 2024 18:10:03 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We're making this so much more complicated than it needs to be</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Oct 10 2024 18:10:24 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i agree personally</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Oct 10 2024 18:10:42 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">What opposition, aside from Waldemar's?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Oct 10 2024 18:10:53 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">oh, your preference is to <em>have</em> unsafe{}?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Oct 10 2024 18:11:02 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'd much rather have no guardrails than only private fields.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Oct 10 2024 18:11:20 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'd rather have <code>unsafe</code> than only private fields.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Oct 10 2024 18:11:34 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">not just Waldemar, you also said TS gave negative feedback (i saw ryanc hating on it for the same reasons), i saw matrix conversations that were very much against the idea</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Oct 10 2024 18:12:03 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">okay, it'd be good to get a ranking and take stock of the options at the next meeting. i've invited Waldemar but i don't know if he'll attend</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Oct 10 2024 18:12:38 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><p>the known options so far are:</p>
<ol>
<li>no guardrails at all</li>
<li>volatile {} (people definitely hated unsafe)</li>
<li>private only</li>
</ol>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Oct 10 2024 18:12:44 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">One suggestion that seemed interesting was using a different punctuator for field access. Something like <code>obj-&gt;x</code>, but maybe without the pointer dereferencing baggage.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Oct 10 2024 18:13:20 GMT-0700 (Pacific Daylight Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Like, we have <code>.id</code> and <code>.#id</code> we could just have something else</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Oct 10 2024 18:13:23 GMT-0700 (Pacific Daylight Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that seems also like a lot of complexity to me</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Oct 10 2024 18:13:28 GMT-0700 (Pacific Daylight Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but sure, we can also talk about it</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Oct 10 2024 18:13:55 GMT-0700 (Pacific Daylight Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">my preference is 1 &gt; 3 &gt; 2, ron's is 1 &gt; 2 &gt; 3, agoric's AFAIU is 2 = 3 (?) &gt; 1</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Oct 10 2024 18:14:29 GMT-0700 (Pacific Daylight Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I think private only is a non-starter because it requires so much additional complexity. </td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Oct 10 2024 18:15:00 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">As far as atomic access to privates, there's always <a href="https://github.com/rbuckton/proposal-refs">https://github.com/rbuckton/proposal-refs</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Oct 10 2024 18:15:11 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">one advantage of new syntax is that it opens up the possibility of not allowing access to these fields through reflection, the same way private fields cannot be accessed through reflection</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Oct 10 2024 18:15:38 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I haven't proposed it, but I've been thinking about it for years.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Oct 10 2024 18:15:48 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">it also means that private shared fields don't need to have exactly the same semantics as private fields</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Oct 10 2024 18:16:08 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> it also means that private shared fields don't need to have exactly the same semantics as private fields</blockquote></mx-reply>the Atomics methods problem is a hard requirement though</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Oct 10 2024 18:16:26 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">to not be able to do seq-cst, or acq/rel (as waldemar is proposing now) on those fields would be fatal</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Oct 10 2024 18:16:28 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This is supposed to be a perf-critical feature. Routing everything through accessors is antithetical to that</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Oct 10 2024 18:16:43 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">well, it's only via public use is the point</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Oct 10 2024 18:16:57 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i'm actually not super concerned for routing through accessors because that only happens externally to the class's methods</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Oct 10 2024 18:16:59 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">yeah Atomics becomes difficult to explain with new syntax if there is no reflection</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Oct 10 2024 18:17:04 GMT-0700 (Pacific Daylight Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">which would only be a perf problem in your cluster-of-friends case</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Oct 10 2024 18:17:40 GMT-0700 (Pacific Daylight Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">accessors on fixed shape objects, especially if they're possibly autogenerated, don't have to have any overhead, right ?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Oct 10 2024 18:17:42 GMT-0700 (Pacific Daylight Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">the refs proposal would introduce a mechanism for reified References.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Oct 10 2024 18:17:50 GMT-0700 (Pacific Daylight Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> accessors on fixed shape objects, especially if they're possibly autogenerated, don't have to have any overhead, right ?</blockquote></mx-reply>oh they have super overhead as a function call</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Oct 10 2024 18:17:55 GMT-0700 (Pacific Daylight Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So you could do <code>Atomics.load(ref struct.#x)</code></td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Oct 10 2024 18:17:57 GMT-0700 (Pacific Daylight Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that is a huge overhead compared to a load on a struct</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Oct 10 2024 18:18:11 GMT-0700 (Pacific Daylight Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but i can live with it if it's for public users only</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Oct 10 2024 18:18:17 GMT-0700 (Pacific Daylight Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">because that shouldn't happen frequently for public users</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Oct 10 2024 18:19:32 GMT-0700 (Pacific Daylight Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> the refs proposal would introduce a mechanism for reified References.</blockquote></mx-reply>that's a big dependency to take :(</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Oct 10 2024 18:19:41 GMT-0700 (Pacific Daylight Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> which would only be a perf problem in your cluster-of-friends case</blockquote></mx-reply>Which is something I'm already doing in the TS experiment to build the lock free data structures I need to actually get work done.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Oct 10 2024 18:19:56 GMT-0700 (Pacific Daylight Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">interesting, what is your cluster of friend classes in that case?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Oct 10 2024 18:20:03 GMT-0700 (Pacific Daylight Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I agree, but it has other uses. It's had use cases since Decorators was proposed.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Oct 10 2024 18:20:04 GMT-0700 (Pacific Daylight Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">just pick a concrete one, just curious</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Oct 10 2024 18:20:11 GMT-0700 (Pacific Daylight Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Writing a Deque</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Oct 10 2024 18:20:27 GMT-0700 (Pacific Daylight Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">and the subclasses that comprise it that need to see each others' state?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Oct 10 2024 18:20:27 GMT-0700 (Pacific Daylight Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">there are about 4-5 data structures that are all interrelated. </td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Oct 10 2024 18:20:47 GMT-0700 (Pacific Daylight Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The <code>Deque</code> needs to be able to access the ring buffer's state.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Oct 10 2024 18:21:00 GMT-0700 (Pacific Daylight Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This is all lock free, so only the Deque public methods need to be guarded.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Oct 10 2024 18:21:29 GMT-0700 (Pacific Daylight Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">okay so you have like a RingBuffer and you want Deque to just get ._buffer, not RingBuffer.p.getBufferElementAt(n) or whatever</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Oct 10 2024 18:21:33 GMT-0700 (Pacific Daylight Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">And you need to use objects for ringbuffer entries for appropriate CAS operations.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Oct 10 2024 18:21:42 GMT-0700 (Pacific Daylight Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">roughly.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Oct 10 2024 18:21:47 GMT-0700 (Pacific Daylight Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">right, or .compareExchangeElementAt</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Oct 10 2024 18:22:20 GMT-0700 (Pacific Daylight Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/microsoft/TypeScript/blob/shared-struct-test/src/compiler/sharing/collections/deque.ts">https://github.com/microsoft/TypeScript/blob/shared-struct-test/src/compiler/sharing/collections/deque.ts</a></td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Oct 10 2024 18:22:22 GMT-0700 (Pacific Daylight Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">right, if we take alway-private to mean literal #-names with their semantics today, this works very poorly</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Oct 10 2024 18:23:26 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">(though that's using <code>class</code> and TS legacy decorators to give me something to attach types to, the constructors actually return structs)</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Oct 10 2024 18:23:58 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">man why is this so hard</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Oct 10 2024 18:24:16 GMT-0700 (Pacific Daylight Time)">01:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i am <em>really</em> skeptical about adding a new kind of property after private names</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Oct 10 2024 18:24:32 GMT-0700 (Pacific Daylight Time)">01:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">also for a new pointer-field-access syntax, but i'd need to see the specifics i guess</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Oct 10 2024 18:25:04 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Everyone I've spoken to on my team seems to be in agreement that this additional guardrail is wholly unnecessary.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Oct 10 2024 18:26:02 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">JS has getters and setters, so an object's properties can change underneath you unexpectedly already, and reads and writes don't tear.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Oct 10 2024 18:26:41 GMT-0700 (Pacific Daylight Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">this was waldemar's core point iirc</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Oct 10 2024 18:27:53 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i confess i am also confused <em>why</em> data races are categorically different from "wacky getters". mark's explanation to me in the hallway was, getters are the public API of the class designer, so it is intentional by the designer. whereas fields are just fields, so i guess to expose racy access on them by default without additional signal of intent is the contagion he wants to prevent</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Oct 10 2024 18:28:19 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i didn't have time to really dig in, but a struct designer still has to type <code>fieldName;</code></td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Oct 10 2024 18:30:14 GMT-0700 (Pacific Daylight Time)">01:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code>shared struct</code> is in the public API of the struct author as well. I don't see how this is different.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Oct 10 2024 18:30:38 GMT-0700 (Pacific Daylight Time)">01:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">it would be good to dig into more there, for sure</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Oct 10 2024 18:30:39 GMT-0700 (Pacific Daylight Time)">01:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">What's <em>not</em> in the public API of the class designer are Proxies, and Proxies can change values on you even for <em>fields</em></td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Oct 10 2024 18:31:17 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">because mark's actual goal as articulated is "how do we better ensure a world where by default devs interact with shared structs only via their public interface, which should be threadsafe"</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Oct 10 2024 18:33:12 GMT-0700 (Pacific Daylight Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If you don't have COOP/COEP enabled, then it is threadsafe because you can't actually share it?</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Oct 10 2024 18:55:51 GMT-0700 (Pacific Daylight Time)">01:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Stage 2 is a little early, but I'm experimenting with a TypeScript downleveling for shared structs that uses the dev trial constructor:

</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Oct 10 2024 18:57:27 GMT-0700 (Pacific Daylight Time)">01:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">No <code>shared struct</code>-specific type checking though, it piggybacks on <code>class</code> type checking.</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Oct 10 2024 18:57:50 GMT-0700 (Pacific Daylight Time)">01:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">i.e., it doesn't disallow non-static methods/accessors at present.</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Oct 10 2024 18:58:51 GMT-0700 (Pacific Daylight Time)">01:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">and the [[Prototype]] chain of the struct constructor doesn't match spec since the actual struct type gets stuffed in there.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Oct 10 2024 19:05:42 GMT-0700 (Pacific Daylight Time)">02:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">it also doesn't allow subclassing</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Thu Oct 10 2024 19:07:35 GMT-0700 (Pacific Daylight Time)">02:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If you don't have COOP/COEP enabled, then it is threadsafe because you can't actually share it?</blockquote></mx-reply>My understanding is that it's mostly in a world where we accept shared memory concurrency, and where it's available. What can we do to steer authors towards designing their shared data so that race conditions are contained and not exposed to users.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Thu Oct 10 2024 19:10:49 GMT-0700 (Pacific Daylight Time)">02:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">For example most host APIs are internally multi-threaded with shared memory, but thankfully they do not expose that to the JS program. Host object rarely expose objects with data properties that change without local action</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Thu Oct 10 2024 21:37:57 GMT-0700 (Pacific Daylight Time)">04:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">Mathieu Hofman</span>: i want to get to a shared understanding in this group (and in committee) the way in which shared memory data race in shared struct public fields is a categorically different kind of unsafe than getters and proxies doing arbitrary things</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Oct 10 2024 21:39:23 GMT-0700 (Pacific Daylight Time)">04:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><p>namely, the assertion from mark seems to have been "those getters are the intended public API provided by the author", while the contention is "from the consumer's point of view, unclear why public fields don't constitute the same intent"</p>
<p>is the main issue perhaps that there <em>can't</em> be private fields currently? so the conscientious shared struct author has no way to express the intent?</p>
</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Oct 10 2024 21:39:57 GMT-0700 (Pacific Daylight Time)">04:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">like, <em>if</em> we had both public and private fields in shared structs (assuming we can somehow make Atomics work, no idea how), what is the issue?</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Thu Oct 10 2024 23:41:23 GMT-0700 (Pacific Daylight Time)">06:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I see discussion about how to use private fields and atomics â€” both Justin and littledan had proposals to reify private names as first-class values, you should probably also get in touch with them</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Oct 11 2024 12:45:28 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>True, which is why I've held off on proposing it until there were more motivating use cases. I initially wrote up the proposal to address a concern around decorators surfaced by the Angular team:</p>
<pre><code class="language-js">class A { @dec(B) b; }
class B { @dec(A) a; }
</code></pre>
<p>This throws because <code>B</code> is not yet defined (even w/o TDZ it would have been <code>undefined</code>). You can address this with arrow functions, but its easy to accidentally pass an actual function and forget the arrow as you cannot readily distinguish between function types.</p>
<p>With references, this might be:</p>
<pre><code class="language-js">class A { @dec(&amp;B) b; }
class B { @dec(&amp;A) a; }
</code></pre>
<p>A second motivator is to support both conditional and unconditional output values w/o the overhead of destructuring:</p>
<pre><code class="language-js">Map.prototype.tryGet = function (key, &amp;value) {
  // naive implementation
  if (this.has(key)) {
    value = this.get(key);
    return true;
  }
  return false;
}

let value;
if (map.tryGet(key, &amp;value) &amp;&amp; value &gt; 0) { ... }
</code></pre>
<p>And refs could be used to pass a reference to a variable, field, or array element:</p>
<pre><code class="language-js">// private field and array element refs for atomics
Atomics.load(&amp;this.#x);
Atomics.store(&amp;ar[0], value);

// private field refs for friend classes
class Source {
  signal;
  #waiters;
  constructor() {
    this.signal = new Signal(&amp;this.#waiters);
  }
}
class Signal {
  #waiters;
  constructor(&amp;waiters) { // deref/bind 
    this.#waiters = &amp;waiters; // ref, reified
  }
  subscribe(cb) {
    let &amp;waiters = this.#waiters; // deref
    waiters ??= new Set(); // assigns to source.#waiters
    waiters.add(cb);
  }
}
</code></pre>
<p>A reified reference is roughly akin to a closure:</p>
<pre><code class="language-js">let a = 1;
let b = &amp;a;
b.value; // 1
b.value++;
a; // 2

// rough desugaring
let a = 1;
let b = { get value() { return a; }, set value(v) { a = v; } };
b.value; // 1
b.value++;
a; // 2
</code></pre>
<p>Except that for fields its actually more like a Reference record in that it holds the object and property key, which is how something like <code>Atomics</code> could reach in and touch the actual field value. This is the only behavior that refs provide that isn't already possible in the language as a closure. My hope is, though, that engines could potentially optimize ref/deref pairs and avoid reification when it isn't necessary:</p>
<pre><code class="language-js">let a = 1;
let &amp;b = &amp;a; // ref/deref. 'b' and 'a' point to same binding

function &amp;f(&amp;x) { return &amp;x; } // statically indicates ref return
let x = 1;
let &amp;y = &amp;f(&amp;x); // ref/deref/ref/deref/ref/deref. 'y' and 'x' point to the same binding
</code></pre>
</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Oct 11 2024 12:51:43 GMT-0700 (Pacific Daylight Time)">19:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This also came up in the Extractors proposal when comparing how we would need to use array destructuring, while C#'s <code>Deconstruct</code> uses <code>out</code> (same as <code>ref</code>, but statically enforced to ensure you assign to it before returning)</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Oct 11 2024 12:54:50 GMT-0700 (Pacific Daylight Time)">19:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I've gone back and forth on whether to use <code>ref</code> or <code>&amp;</code>. I've felt <code>&amp;</code> seems too pointer-y, but <code>ref</code> is ambiguous with call when the operand is parenthesized, e.g. <code>ref (x).y</code>.</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Fri Oct 11 2024 13:01:56 GMT-0700 (Pacific Daylight Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You could potentially split up something like refs into two parts: <code>&amp;</code> for ref/deref but no reification (i.e., either statically an error if not derefing if that's feasible, or produces an opaque object), with reification coming later (if at all).</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Fri Oct 11 2024 13:08:50 GMT-0700 (Pacific Daylight Time)">20:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Prior to C# 8, you could only take a ref of an argument and pass it to a ref parameter, which is a further potential restriction.</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Fri Oct 11 2024 13:11:51 GMT-0700 (Pacific Daylight Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That would still cover the main motivations I'd have for the refs proposal, though without some of the conveniences it offers. A decorator could take a ref as a parameter and internally close over it. The only problem being that the parameter could not be optional (or could be but it would be an error to access it, as if it had TDZ, which I know that's not a good direction)</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Fri Oct 11 2024 13:14:52 GMT-0700 (Pacific Daylight Time)">20:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">There was also some interest in using refs with the signals proposal. I spoke with Domenic Gannaway a few months back about that, as it could potentially allow for reactive variables similar to Svelte.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Fri Oct 11 2024 13:23:00 GMT-0700 (Pacific Daylight Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>For example:</p>
<pre><code class="language-js">const nameState = new Signal.State("Bob");
const helloComputed = new Signal.Computed(() =&gt; `Hello ${name}`);

let &amp;name = &amp;nameState.getMutableRef();
const &amp;hello = &amp;helloComputed.getImmutableRef();

name; // "Bob";
hello; // "Hello Bob";

name = "Alice";
hello; // "Hello Alice";
</code></pre>
</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Fri Oct 11 2024 13:25:04 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">That seems exactly like the code that made the committee reject `import defer` without a namespace import ðŸ˜…</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Fri Oct 11 2024 13:25:26 GMT-0700 (Pacific Daylight Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">i.e. that it was introducing side-effects in binding access</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Fri Oct 11 2024 13:26:22 GMT-0700 (Pacific Daylight Time)">20:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yeah, I am aware it's a hard sell. This is fairly explicit at the declaration site, on a per-binding case.</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Fri Oct 11 2024 13:27:06 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I guess it's no worse than the alternative (using an object and property access)</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Fri Oct 11 2024 13:27:16 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Given that it's statically analyzable </td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Fri Oct 11 2024 13:27:41 GMT-0700 (Pacific Daylight Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">With the exception of how Atomics would work, this is fully transpilable. </td></tr>

</tbody></table></div></div></div>
</body></html>