<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2024-07-02</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2024-07-02<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-20" class="nav-link"><span>prev</span></a>
<a href="2024-07-03" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jul 02 2024 09:24:11 GMT-0700 (Pacific Daylight Time)">16:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">FYI, I have someone coming by today to repair some siding that came loose during a thunderstorm and it looks like they were delayed and will be here around 1pm EST (the start of the meeting today), so I may be delayed by a few minutes or interrupted.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jul 02 2024 10:55:35 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><span class="nick-4">iain</span>: Regarding your comment that the intuition is that "<code>async</code> affects the type", I disagree. Both <code>async</code> (and <code>*</code>) imply a <em>syntactic transformation in the function body</em>. Non <code>async</code> code can still return a <code>Promise</code>, and non <code>*</code> code can still return a generator.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jul 02 2024 10:58:15 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(I think you tagged the wrong Iain)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jul 02 2024 10:59:44 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't think that tracks. If I add <code>async</code> or <code>*</code> to a function definition, it returns a different sort of thing, in a way that my caller needs to know about. If I add <code>unsafe</code>, it doesn't change anything from the caller's perspective.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jul 02 2024 11:02:43 GMT-0700 (Pacific Daylight Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Functions don't have typed signatures in raw JS, but if you return a promise or a generator from a function then that is reflected in the implicit return type. The same is not true for <code>unsafe</code>.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jul 02 2024 11:03:20 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I did, oops.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jul 02 2024 11:03:38 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The distinction is whether the property is important to the caller, and since we're explicitly avoiding function colouring, I claim that <code>unsafe</code> is only relevant to the code inside the function.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jul 02 2024 11:05:18 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">My anecdotal evidence that this is potentially confusing is that I was personally confused by this while reading the explainer.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jul 02 2024 11:05:47 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We tried to make this distinction in TypeScript fairly clear. While you can write <code>async function f(): Promise&lt;void&gt; { ... }</code> in your code, the output declaration is <code>declare function f(): Promise&lt;void&gt; { ... }</code>, as <code>async</code> only performs a syntactic transformation. It does certainly <em>inform</em> the return type, but it is not part of the function signature from a type checking perspective.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jul 02 2024 11:05:49 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Although it is certainly plausible that I am too easily confused!)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jul 02 2024 11:07:29 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Decorators will further complicate that mental model, though, as a decorator could affect the return type of a function as well. At one point (after we had already shipped <code>async</code>/<code>await</code>), there were comments that we could have just used generators and <code>@async function* f() { ... }</code>.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jul 02 2024 11:08:37 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes, <code>async</code> and <code>*</code> do imply a specific return type, but that is purely a result of the syntactic transformation. In the same way, <code>accessor</code> is also a syntactic transformation.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jul 02 2024 11:09:41 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It could even be argued that <code>static</code> is a syntactic transformation insomuch as it applies to where a method or field is placed on a class. All of these potentially affect the type, but the type produced is purely a result of the transformation itself.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jul 02 2024 11:13:30 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'd also like to point out that <code>unsafe</code>, as I've proposed, is generally consistent with Rust as prior art. Rust allows <code>unsafe {}</code>, but also <code>unsafe fn</code>, <code>unsafe trait</code>, and <code>unsafe impl</code>:</p>
<blockquote>
<p>By default, <code>unsafe fn</code> also acts like an <code>unsafe {}</code> block around the code inside the function. This means it is not just a signal to the caller, but also promises that the preconditions for the operations inside the function are upheld. Mixing these two meanings can be confusing, so the <code>unsafe_op_in_unsafe_fn</code> lint can be enabled to warn against that and require explicit unsafe blocks even inside <code>unsafe fn</code>.</p>
</blockquote>
<p>In Rust, disallowing <code>unsafe fn</code> in favor of a nested unsafe block is specified as a lint rule.</p>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jul 02 2024 11:14:05 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><a href="https://doc.rust-lang.org/std/keyword.unsafe.html">https://doc.rust-lang.org/std/keyword.unsafe.html</a></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jul 02 2024 11:15:05 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Or am I misinterpreting? Does Rust require an <code>unsafe</code> block around an unsafe function call?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jul 02 2024 11:15:15 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">In general, I would say that a function signature (broadly waving at all the parts of a function declaration outside the body) provides information that is important to the caller. This is especially true in statically typed languages, but even in JS I think it holds. By putting <code>unsafe</code> in such a prominent location, we imply that it is similarly important to the caller, which is not the case here.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jul 02 2024 11:15:30 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You are misinterpreting: Rust requires an unsafe block around calls to unsafe functions.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jul 02 2024 11:15:44 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Ah, thanks. My mistake.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jul 02 2024 11:15:53 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That's a big part of why I misread your explainer.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jul 02 2024 11:17:45 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The purpose of the Rust lint is to encourage code to be precise about which parts of a function body are unsafe, even if the entire function must be called in an unsafe context.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jul 02 2024 11:17:47 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">An alternative to <code>unsafe function f() {}</code> that I'd also put on the explainer might be <code>function f() unsafe { }</code>. My concern is that this isn't obvious that it also affects the parameter list. Then again <code>function f() { "use strict"; }</code> affects the parameter list as well.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jul 02 2024 11:19:17 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The equivalent in JS of the Rust lint would be to have function colouring (where <code>unsafe function foo()</code> can only be called from inside an unsafe block) and also require explicit unsafe blocks inside the body of the function, which is the opposite of what you are proposing.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jul 02 2024 11:19:23 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So, <code>class C unsafe { }</code> to make a class body unsafe, or <code>shared struct S unsafe { }</code> to make a shared struct body unsafe. We probably wouldn't do <code>unsafe const</code>/<code>unsafe let</code> in that case because it would be mixing up suffix vs. prefix, so we <em>would</em> need to depend on an unsafe IIFE or <code>unsafe do</code></td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jul 02 2024 11:21:37 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">function coloring is a major DX pain. I see it as a necessity for <code>async</code> and <code>*</code> given that the syntactic transformations affect the return type, but it's not a practice I'm fond of continuing with new syntax if it isn't warranted.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jul 02 2024 11:22:22 GMT-0700 (Pacific Daylight Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So, <code>class C unsafe { }</code> to make a class body unsafe, or <code>shared struct S unsafe { }</code> to make a shared struct body unsafe. We probably wouldn't do <code>unsafe const</code>/<code>unsafe let</code> in that case because it would be mixing up suffix vs. prefix, so we <em>would</em> need to depend on an unsafe IIFE or <code>unsafe do</code></blockquote></mx-reply>I suppose it would be <code>do unsafe {}</code>, to maintain the suffix position</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jul 02 2024 11:26:24 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Function colouring in this case allows for the more nuanced expression of safety invariants. So for example you could have <code>function foo() { unsafe {...} }</code> and <code>unsafe function foo_AlreadyHoldingLock() {...}</code>, in which case <code>unsafe function</code> does not do a syntactic transformation, but it does impose restrictions on the callers to maintain invariants.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jul 02 2024 11:27:14 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I'm not convinced we want that, and I think adding it might impose a small performance overhead on unrelated code, but it's a point in design space.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jul 02 2024 11:27:28 GMT-0700 (Pacific Daylight Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>There is one thing about function coloring an <code>unsafe</code> function has over <code>async</code>/<code>await</code> that makes it somewhat more palatable, which is that you can introduce an <code>unsafe {}</code> block in safe code to perform the operation. That almost makes me want to have both <code>unsafe function</code> ("it is unsafe to call me and my contents are unsafe") and <code>function () unsafe { }</code> ("my contents are unsafe, but it is safe to call me as I have done my due diligence to ensure I am safe at the boundaries"), mostly because I really am not a fan of the namespace nesting style often seen in C++, i.e.</p>
<pre><code class="language-js">function f() { unsafe { 
  ...
} }
</code></pre>
</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jul 02 2024 11:28:43 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, given my previous experience in Rust, that's what I thought you were proposing initially. The problem is that then every call that is not in an unsafe context is responsible for checking that the callee is not an unsafe function, which potentially slows down polymorphic code.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jul 02 2024 11:28:58 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Where <code>... unsafe { }</code> is just syntactic sugar for <code>... { unsafe { } }</code></td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jul 02 2024 11:29:32 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(Although there's a chance that we could fold it into checks that we already have to do to ensure that you don't call a derived constructor without <code>new</code>)</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jul 02 2024 11:31:05 GMT-0700 (Pacific Daylight Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Could that slow down be handled via a function stub, such that "safe" code has no overhead (if it calls the stub, the stub throws), while "unsafe" code has overhead as it must check for the stub to step over it, or to pass the stub a flag indicating safety?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jul 02 2024 11:33:44 GMT-0700 (Pacific Daylight Time)">18:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We already expect "unsafe" code will have some additional complexity even without the notion of an <code>unsafe {}</code> block, purely because reads and writes potentially require agent coordination</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jul 02 2024 11:35:57 GMT-0700 (Pacific Daylight Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">At a hardware level there isn't really any way to pass a flag that doesn't require the safe caller to do at least a little bit of work to not pass it</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jul 02 2024 11:37:53 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">(That's maybe not true if you imagine that we have some sort of global "are we in an unsafe block" flag that gets cleared when unsafe code calls into safe code and reset when we return, but keeping that flag set correctly seems potentially complicated.)</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Jul 02 2024 11:38:32 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So "safe code just calls the function" as normal (which throws for the stub), and "unsafe code first checks if the function is an unsafe function stub and then calls the underlying function" isn't an option?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Jul 02 2024 11:38:33 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">The overall performance cost here is pretty small</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Jul 02 2024 11:39:09 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'll admit, I'm primarily coming at this from the spec perspective, and not the perspective of an implementer or optimizin gcompiler.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Jul 02 2024 11:40:00 GMT-0700 (Pacific Daylight Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Yeah, I guess I can see some ways of making that work. </td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Jul 02 2024 11:41:03 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Although they end up adding a fair bit of complexity to some already very complicated code</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Jul 02 2024 11:41:05 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But I wouldn't expect a global flag is necessary given that <code>unsafe {}</code> is purely syntactic and could be used to drive transformations or optimizations based on its presence in the parse tree.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Jul 02 2024 11:44:44 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Taking a step back: this can all be implemented, and with sufficient elbow grease the overhead could be minimized. The question is whether coloured functions provide enough value to justify engines spending their limited elbows on this instead of the million other things we could be implementing / optimizing.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Jul 02 2024 11:51:38 GMT-0700 (Pacific Daylight Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i don't think function coloring is problematic from engines' perspectives, but it is pretty bad for usability, especially since we already have async/non-async</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Jul 02 2024 11:55:40 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Actually, now that I'm thinking through the implementation, even normal <code>unsafe</code> blocks are at least a little annoying to implement, because it means that every GetProperty needs to know its location in the source. Or else you use a global flag, and clear it around calls?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Jul 02 2024 11:56:52 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i was actually imagining something even dumber, like outputting different bytecode</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Jul 02 2024 11:57:21 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">since it's lexical</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Jul 02 2024 11:57:39 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Oh, yeah, maybe that works too</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Jul 02 2024 11:57:59 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">could still be slightly annoying maybe to maintain two types of property access, with their ICs and such</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Jul 02 2024 11:58:11 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">My biggest concern was <code>unsafe</code> having <code>async</code>/<code>await</code>-like poisoning effects. Introducing <code>async</code> to a sync function normally poisons it's callers if they must maintain sequential execution. Given that you can nest an <code>unsafe{}</code> block in safe code, the concern is lessened somewhat. In the call I said that an <code>unsafe function</code> doesn't perform any implicit synchronization or coordination, so its up to the author to implement any necessary coordination, including none at all. The "none at all" coordination was meant as a way for you to decompose an <code>unsafe</code> function into multiple <code>unsafe</code> functions without having to guard against "safe" code invoking them unintentionally by leveraging scoping. Function coloring at this level isn't quite as bad as I'd feared, and has the benefit of pushing the user to implement safety in a function not marked <code>unsafe</code>.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Jul 02 2024 11:58:32 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> could still be slightly annoying maybe to maintain two types of property access, with their ICs and such</blockquote></mx-reply>V8 bytecodes at least can have immediate arguments. it could be a Get with an "in-unsafe-block" bit</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Jul 02 2024 11:59:06 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">like, the same way "should throw" flags are threaded through for strict code</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Jul 02 2024 12:00:04 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">SM has SetProp/StrictSetProp and so on</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Jul 02 2024 12:00:21 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">Although most of the code is shared</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Jul 02 2024 12:00:26 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yeah, same</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Jul 02 2024 12:00:28 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It ends up being similar in practice</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Jul 02 2024 12:00:31 GMT-0700 (Pacific Daylight Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">same to "most of the code is shared"</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Jul 02 2024 12:01:38 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>In other words, this</p>
<pre><code class="language-js">unsafe function readMessage(lck, workArea) { ... }
unsafe function writeMessage(workArea, message) { ... }
unsafe function processMessage(message) { ... }

function processWorkArea(mut, workArea) unsafe {
  using lck = new UniqueLock(mut);
  let message;
  while (message = readMessage(lck, workArea)) {
    const result = processMessage(message);
    writeMessage(workArea, result);
  }
}
</code></pre>
<p>Doesn't seem quite so bad to me (though I still prefer <code>function() unsafe { }</code> to <code>function() { unsafe { } }</code>)</p>
</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Jul 02 2024 12:04:41 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It has the upside of preventing users from inadvertently invoking unsafe code from safe code and allows you to declare your function as not only containing unsafe code, but also indicating that it doesn't internally perform any coordination.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Jul 02 2024 12:08:57 GMT-0700 (Pacific Daylight Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">In C#, <code>unsafe</code> can apply to a function/method, but does not affect callers: <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/unsafe">https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/unsafe</a></td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Jul 02 2024 12:09:41 GMT-0700 (Pacific Daylight Time)">19:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Though <code>unsafe</code> in C# is primarily around direct access to pointers (which Rust also shares).</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Jul 02 2024 12:10:01 GMT-0700 (Pacific Daylight Time)">19:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">For me the uncertainty about the value of function colouring implies strongly that we should leave out <code>unsafe function</code> syntax for now. In the future we will have much more user experience to help determine what that syntax should mean.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Jul 02 2024 12:14:02 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'd really like to be able to write conventional JS with shared structs when I know I already have exclusive access to an object. If we only have <code>unsafe {}</code>, I can't write this</p>
<pre><code class="language-js">unsafe function doWork(task, timeout = task.timeout ?? 1000) { ... }
</code></pre>
<p>and instead must write this</p>
<pre><code class="language-js">function doWork(task, timeout) {
  unsafe {
    timeout ??= task.timeout ?? 1000;
    ...
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Jul 02 2024 12:16:11 GMT-0700 (Pacific Daylight Time)">19:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">However, I do see the potential value of safe code erroring if you invoke <code>doWork</code>, since <code>doWork</code> here <em>doesn't</em> implement a coordination mechanism as it's intended to be used from another function that does. Instead, I must indicate it by convention, i.e. <code>function doWorkUnsafe()</code> to draw attention to its use.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Jul 02 2024 12:21:14 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Let me be clear on my position though. If we must have <code>unsafe</code>, but can only have <code>unsafe {}</code> for now, I'm fine with that. I do think the lack of an <code>unsafe</code> marker for functions and class/struct bodies is a major DX wart that will very likely need to be addressed at some point, function coloring or not. I just don't want to go down a road of allowing <code>import</code>/<code>export</code> inside of an <code>unsafe</code> block as it would likely be a long term aesthetic wart on the language <em>after</em> we introduce an <code>unsafe</code> marker in other contexts.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Jul 02 2024 12:23:54 GMT-0700 (Pacific Daylight Time)">19:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We <em>could</em> consider an alternative to make <code>import</code>/<code>export</code> work, by declaring the entire module as <code>unsafe</code> via something like <code>unsafe module;</code> (or some other incantation) at the top level.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Jul 02 2024 12:25:10 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Or use module blocks, e.g.:</p>
<pre><code class="language-js">unsafe module M {
  export shared struct AtomicValue { ... }
}
export * from M;
</code></pre>
</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Jul 02 2024 12:26:49 GMT-0700 (Pacific Daylight Time)">19:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">(though that still uses <code>unsafe</code> as a prefix)</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Jul 02 2024 12:32:55 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'd also be fine with postfix-<code>unsafe</code> markers for declarations (<code>function f() unsafe { }</code>) and potentially allowing <code>unsafe</code> in both positions (<code>unsafe function f() {}</code> and <code>function f() unsafe {}</code>, though <code>unsafe function f() unsafe {}</code> is redundant). I'd also be fine with <code>unsafe</code> markers for parameters much like I suggested for variable and field initializers in a world where we either can't have postifx-<code>unsafe</code> or if postfix-<code>unsafe</code> can't include parameters, e.g.:</p>
<pre><code class="language-js">function doWork(task, unsafe timeout = task.timeout ?? 1000) {
  unsafe { ... }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Jul 02 2024 12:35:39 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>IMO, only having <code>unsafe {}</code> is not ideal, though <code>do unsafe {}</code> would make that <em>somewhat</em> more bearable, e.g.:</p>
<pre><code class="language-js">function doWork(task, timeout = do unsafe { task.timeout } ?? 1000) {
  unsafe { }
}
</code></pre>
<p>But for that we would need <code>do {}</code> to advance.</p>
</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Jul 02 2024 12:36:47 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Or we would have to advance <code>unsafe {}</code> as an expression as well, which would be confusing if we do end up advancing <code>do</code>.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Jul 02 2024 15:08:02 GMT-0700 (Pacific Daylight Time)">22:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">It would be great if someone brought do expressions back to committee. My understanding is that bakkot is leaving that for others to champion. (Maybe there is some remaining controversy but I don’t know what it is)</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Jul 02 2024 15:29:04 GMT-0700 (Pacific Daylight Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It looks like we decided in <a href="https://github.com/tc39/notes/blob/main/meetings/2021-03/mar-9.md">March 2021</a> that we were going to do some sort of user study. Did anything ever come of that?</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Jul 02 2024 16:24:54 GMT-0700 (Pacific Daylight Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> An alternative to <code>unsafe function f() {}</code> that I'd also put on the explainer might be <code>function f() unsafe { }</code>. My concern is that this isn't obvious that it also affects the parameter list. Then again <code>function f() { "use strict"; }</code> affects the parameter list as well.</blockquote></mx-reply>I am honestly suspicious of any code that attempts to do anything with a shared struct passed in arguments without first satisfying whatever synchronization mechanism is appropriate to access that shared struct. As such I suspect that only allowing unsafe blocks is actually a benefit as it would force authors to consider whether they've first satisfied the synchronization responsibility they're supposed to take on, and which seem hard to satisfy within the parameters list alone.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Jul 02 2024 16:35:18 GMT-0700 (Pacific Daylight Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I'd really like to be able to write conventional JS with shared structs when I know I already have exclusive access to an object. If we only have <code>unsafe {}</code>, I can't write this</p>
<pre><code class="language-js">unsafe function doWork(task, timeout = task.timeout ?? 1000) { ... }
</code></pre>
<p>and instead must write this</p>
<pre><code class="language-js">function doWork(task, timeout) {
  unsafe {
    timeout ??= task.timeout ?? 1000;
    ...
  }
}
</code></pre>
</blockquote></mx-reply>Can't you define your <code>doWork</code> function inside an unsafe block instead?</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Jul 02 2024 16:35:28 GMT-0700 (Pacific Daylight Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>In an earlier example I showed how you might decompose a series of <code>unsafe</code> operations into multiple functions, where only the entrypoint function would perform any coordination, i.e.:</p>
<pre><code class="language-js">unsafe function readMessage(...) { ... }
unsafe function writeMessage(...) { ... }
unsafe function processMessage(...) { ... }
function processWorkArea(workArea) {
  unsafe {
    // performs locking
    // calls readMessage/writeMessage/processMessage
  }
}
</code></pre>
<p>If we have <code>unsafe function</code>, we can enforce that safe code cannot invoke an <code>unsafe</code> function directly, or inadvertently.<br>If we do not have <code>unsafe function</code> and only have <code>unsafe {}</code>, then we cannot perform such enforcement and there is no clear delineation between a safe entrypoint and unsafe code:</p>
<pre><code class="language-js">function readMessage(...) { unsafe { ... } }
function writeMessage(...) { unsafe { ... } }
function processMessage(...) { unsafe { ... } }
function processWorkArea(workArea) {
  unsafe {
    // performs locking
    // calls readMessage/writeMessage/processMessage
  }
}
</code></pre>
<p>Here, <code>readMessage</code> will not perform any independent coordination or locking as it expects to be called by <code>processWorkArea</code>, which is the function that would actually perform locking. A user could inadvertently invoke <code>readMessage</code> from "safe" code, resulting in a data race. The only way to enforce this is by convention, thus you would instead want to write this as:</p>
<pre><code class="language-js">function readMessageUnsafe(...) { unsafe { ... } }
function writeMessageUnsafe(...) { unsafe { ... } }
function processMessageUnsafe(...) { unsafe { ... } }
function processWorkArea(workArea) {
  unsafe {
    // performs locking
    // calls readMessageUnsafe/writeMessageUnsafe/processMessageUnsafe
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Jul 02 2024 16:37:36 GMT-0700 (Pacific Daylight Time)">23:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Can't you define your <code>doWork</code> function inside an unsafe block instead?</blockquote></mx-reply><p>It's not quite so easy if I want to make <code>doWork</code> available to code outside of the block:</p>
<pre><code class="language-js">let doWork;
unsafe {
  doWork = function() { ... };
}
</code></pre>
<p>This would be a regular frustration developers would encounter, both here and with <code>import</code>/<code>export</code>, or shared struct bodies, etc.</p>
</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Jul 02 2024 16:38:33 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Blocks are best for localizing the transition from safe to unsafe. They're terrible for encapsulating declarations since you generally want at least one declaration to escape the block to be actually usable.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Jul 02 2024 16:38:47 GMT-0700 (Pacific Daylight Time)">23:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I do find interesting the proposition that the user could define unsafe functions that like shared struct fields do need to be called from an unsafe context. As mentioned that seems to point we could for now reserve that space in the syntax for later </td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Jul 02 2024 16:39:48 GMT-0700 (Pacific Daylight Time)">23:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>Note that we could also simply allow</p>
<pre><code>unsafe {
  let doWork = ...; 
}
</code></pre>
</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue Jul 02 2024 16:40:45 GMT-0700 (Pacific Daylight Time)">23:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">An unsafe block doesn't have to be a separate lexical scope of its own</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue Jul 02 2024 16:41:04 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i would strongly prefer that something that looks like <code>{ }</code> be its own lexical scope</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue Jul 02 2024 16:41:26 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">lexical scoping should never escape a <code>{}</code>, that would be a terrible precedent.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue Jul 02 2024 16:41:29 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that is a pretty deep affordance</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue Jul 02 2024 16:41:30 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue Jul 02 2024 16:41:46 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We don't even let class decorators access lexically scoped private names since they're outside of the class body</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Tue Jul 02 2024 16:41:59 GMT-0700 (Pacific Daylight Time)">23:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell"><p>I point to the parallel of namespace blocks in C++, where indenting them like:</p>
<pre><code>unsafe {

let doWork = ...

}
</code></pre>
<p>makes it less confusing.</p>
</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Tue Jul 02 2024 16:42:11 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I do find interesting the proposition that the user could define unsafe functions that like shared struct fields do need to be called from an unsafe context. As mentioned that seems to point we could for know reserve that space in the syntax for later </blockquote></mx-reply>runtime enforcement of colored functions like that is probably a no-go</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Tue Jul 02 2024 16:42:24 GMT-0700 (Pacific Daylight Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I point to the parallel of namespace blocks in C++, where indenting them like:</p>
<pre><code>unsafe {

let doWork = ...

}
</code></pre>
<p>makes it less confusing.</p>
</blockquote></mx-reply>nty :)</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Tue Jul 02 2024 16:43:17 GMT-0700 (Pacific Daylight Time)">23:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I maintain that C++ <code>namespace</code>-like indentation is a terrible aesthetic that we should not go out of our way to replicate.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Tue Jul 02 2024 16:43:54 GMT-0700 (Pacific Daylight Time)">23:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">there is the worse-is-worse alternative of <code>"use unsafe"</code> which doesn't imply anything about scoping</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Tue Jul 02 2024 16:44:07 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">however, i find directives bad precisely because of that</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Tue Jul 02 2024 16:44:27 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">All this now makes me realize something. What is the compatibility story of shared structs (and I suppose unsafe functions in the future) with Proxy. I don't think that we should prevent constructing a proxy with such a target, but I also assume a proxy trap implementation wouldn't be exempted from unsafe checks when accessing the target, even if the trap was triggered from an unsafe block. Is the only option that proxy traps be updated to become unsafe themselves? Is there a way to dynamically test whether an object has an unsafe color?</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Tue Jul 02 2024 16:44:45 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">there is no function coloring</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Tue Jul 02 2024 16:44:50 GMT-0700 (Pacific Daylight Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">proxies just work?</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Tue Jul 02 2024 16:45:06 GMT-0700 (Pacific Daylight Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">No, they wouldn't.</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Tue Jul 02 2024 16:45:20 GMT-0700 (Pacific Daylight Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">why wouldn't proxies just work?</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Tue Jul 02 2024 16:45:38 GMT-0700 (Pacific Daylight Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">You need to have an unsafe block inside the proxy trap, don't you?</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Tue Jul 02 2024 16:45:48 GMT-0700 (Pacific Daylight Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">They would work as long as you don't have a proxy trap for <code>get</code> or <code>set</code></td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Tue Jul 02 2024 16:46:21 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But I don't imagine that <code>unsafe</code> magically carries through to proxies via the <code>get</code> and <code>set</code> traps.</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Tue Jul 02 2024 16:46:34 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">sorry, that's what i mean. proxies "just compose", unless there's interposed user code like a trap</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Tue Jul 02 2024 16:46:41 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Also would the Reflect intrinsics be "forwarding" the unsafe environment? Aka throw if not called from an unsafe block when bottoming out in accessing an unsafe receiver?</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Tue Jul 02 2024 16:46:43 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">in which case, exactly as ron says, they'd need their own <code>unsafe { }</code> marker</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Tue Jul 02 2024 16:46:58 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">it works exactly like strict mode throwing</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Tue Jul 02 2024 16:47:42 GMT-0700 (Pacific Daylight Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If you have a shared struct <code>s</code> and you need an <code>unsafe</code> block to read <code>s.x</code>, then <code>new Proxy(s, { get(target, key, receiver) { return Reflect.get(target, key, receiver); } }).x</code> would throw because neither the <code>get</code> trap nor <code>Reflect.get</code> can read/write the struct's fields.</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Tue Jul 02 2024 16:49:24 GMT-0700 (Pacific Daylight Time)">23:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">e.g., we might need a <code>Reflect.unsafeGet</code> and a <code>{ unsafeGet }</code> trap, or we'd need to be able to pass <code>unsafe</code> as a flag to the trap/Reflect.get</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Tue Jul 02 2024 16:50:31 GMT-0700 (Pacific Daylight Time)">23:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Would you want <code>Reflect.get(s, "x")</code> to work outside of an <code>unsafe</code> context?</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Tue Jul 02 2024 16:51:16 GMT-0700 (Pacific Daylight Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> runtime enforcement of colored functions like that is probably a no-go</blockquote></mx-reply>How is calling different from field access? Doesn't the receiver need to perform some check in both cases?</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Tue Jul 02 2024 16:51:17 GMT-0700 (Pacific Daylight Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i feel like it really shouldn't?</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Tue Jul 02 2024 16:51:21 GMT-0700 (Pacific Daylight Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code>"use strict"</code> applies mostly to <code>set</code>, and informs how to react to the boolean return value of <code>Reflect.set()</code> or the <code>set</code> trap. It doesn't impact the <code>get</code> trap at all.</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Tue Jul 02 2024 16:52:14 GMT-0700 (Pacific Daylight Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How is calling different from field access? Doesn't the receiver need to perform some check in both cases?</blockquote></mx-reply>it's different in that Ron's sketch is completely lexical, so all property access lexically contained with <code>unsafe { }</code> can generate a different bytecode at parse time. there is no propagation from from frame to frame</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Tue Jul 02 2024 16:52:31 GMT-0700 (Pacific Daylight Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">We won't need an <code>unsafe</code> block to use <code>Atomics.load(s, "x")</code>, since that already has implications around memory order. I'm not sure where I stand on whether <code>Reflect.get</code> observes <code>unsafe</code></td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Tue Jul 02 2024 16:53:38 GMT-0700 (Pacific Daylight Time)">23:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">My design sketch is more loosely based on C#'s interpretation of <code>unsafe</code> than Rust's in that C# doesn't require <code>unsafe</code> functions be invoked from within an <code>unsafe</code> block, while Rust does.</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Tue Jul 02 2024 16:54:09 GMT-0700 (Pacific Daylight Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We won't need an <code>unsafe</code> block to use <code>Atomics.load(s, "x")</code>, since that already has implications around memory order. I'm not sure where I stand on whether <code>Reflect.get</code> observes <code>unsafe</code></blockquote></mx-reply>i'm not sure mark would agree to that, actually. while it's true <code>Atomics.load</code> can't exhibit a <em>data</em> race, it can still exhibit races. so if mark's desired guarantee is "no non-deterministic races arising from shared memory at all", then it should also require <code>unsafe</code>. otherwise it can be outside of <code>unsafe</code></td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Tue Jul 02 2024 16:54:12 GMT-0700 (Pacific Daylight Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">While I'm agnostic about the value of function colouring, I don't see why you can't generate different bytecode for calls in the same way you do for property access.</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Tue Jul 02 2024 16:55:19 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">It is definitely unfortunate that it would require calls to perform an extra check in safe contexts (aka normal code that isn't touching any of this stuff), but it seems technically feasible to enforce.</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Tue Jul 02 2024 16:55:46 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> While I'm agnostic about the value of function colouring, I don't see why you can't generate different bytecode for calls in the same way you do for property access.</blockquote></mx-reply>i guess i don't know how the unsafe propagation works. if i have <code>unsafe { safeFunction(); } function safeFunction() { unsafeFunction(); } unsafe unsafeFunction() { ... }</code>, does that work or does that throw?</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Tue Jul 02 2024 16:55:51 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> it's different in that Ron's sketch is completely lexical, so all property access lexically contained with <code>unsafe { }</code> can generate a different bytecode at parse time. there is no propagation from from frame to frame</blockquote></mx-reply>Can't you generate a different byte code for unsafeCall? An unsafe function would throw on regular call. A safe function would accept both call and unsafeCall</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Tue Jul 02 2024 16:56:27 GMT-0700 (Pacific Daylight Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">That throws for the same reason as anything else</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Tue Jul 02 2024 16:56:40 GMT-0700 (Pacific Daylight Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">okay, then yes, we can also generate a different bytecode</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Tue Jul 02 2024 16:56:47 GMT-0700 (Pacific Daylight Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">and then it comes down to do we really want another function color</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Tue Jul 02 2024 16:57:11 GMT-0700 (Pacific Daylight Time)">23:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> i'm not sure mark would agree to that, actually. while it's true <code>Atomics.load</code> can't exhibit a <em>data</em> race, it can still exhibit races. so if mark's desired guarantee is "no non-deterministic races arising from shared memory at all", then it should also require <code>unsafe</code>. otherwise it can be outside of <code>unsafe</code></blockquote></mx-reply>I don't see a way to have <code>Atomics.load</code> be aware of <code>unsafe</code> unless we start treating it like we do direct vs. indirect eval? Otherwise we essentially <em>would</em> have function coloring, but only for <code>Atomics</code> methods and only when they receive a <code>shared struct</code> argument.</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Tue Jul 02 2024 16:58:29 GMT-0700 (Pacific Daylight Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">good point. for Atomics.load to require <code>unsafe</code> would require an <code>UnsafeCall</code> internal bytecode as we've been discussing</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Tue Jul 02 2024 16:58:47 GMT-0700 (Pacific Daylight Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So would it be better to special case function coloring purely for the <code>Atomics</code> methods, or just make it a more general mechanism?</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Tue Jul 02 2024 16:58:57 GMT-0700 (Pacific Daylight Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but that'll be an implementation detail, and is orthogonal to whether we expose that coloring to user code</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Tue Jul 02 2024 16:59:17 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@iain:mozilla.org">iain</span>&gt;</div></td><td class="msg-cell">I don't see any backwards-compatible way to make Atomics methods usefully unsafe</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Tue Jul 02 2024 16:59:36 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">well, Atomics currently don't work on field names, only TAs and indices</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Tue Jul 02 2024 16:59:42 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that will remain usable everywhere</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Tue Jul 02 2024 16:59:49 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">and there will be magic to make the new forms throw outside of <code>unsafe</code></td></tr>

</tbody></table></div></div></div>
</body></html>