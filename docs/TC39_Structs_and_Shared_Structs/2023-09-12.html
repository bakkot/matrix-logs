<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2023-09-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2023-09-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-09-11" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Sep 12 2023 09:13:28 GMT-0700 (Pacific Daylight Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I've used <a href="https://nodejs.org/download/v8-canary/">https://nodejs.org/download/v8-canary/</a> successfully before</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Sep 12 2023 09:14:35 GMT-0700 (Pacific Daylight Time)">16:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Built from <a href="https://github.com/nodejs/node-v8">https://github.com/nodejs/node-v8</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Sep 12 2023 13:29:19 GMT-0700 (Pacific Daylight Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Built from <a href="https://github.com/nodejs/node-v8">https://github.com/nodejs/node-v8</a></blockquote></mx-reply>Thanks! This works perfectly</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Sep 12 2023 13:32:42 GMT-0700 (Pacific Daylight Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code>instanceof</code> for Mutex/Condition/SharedArray is great. I see that it works for instances of instances of <code>SharedStructType</code> as well, though there's still no fast way to see if a value is <em>any</em> shared struct (i.e., without access to its specific constructor)</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Sep 12 2023 13:33:47 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">rbuckton</span>: there is, i also added <code>SharedStructType.isSharedStruct</code> iirc</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Sep 12 2023 13:35:52 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Ah, great</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Sep 12 2023 13:41:14 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Hmm. I was hoping I could use <code>SharedStructType</code> to emulate <code>SharedArray</code> when I also need extra fields, but its significantly slower so that's a no-go.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Sep 12 2023 13:44:18 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yes -- that's a possible optimization that's not implemented due to complexity/effort</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Sep 12 2023 13:44:37 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">if you use indexed fields in SharedStructTypes, those are <em>always</em> backed by "dictionary elements", i.e. a hash table</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Sep 12 2023 13:44:41 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">SharedArrays are contiguous arrays</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Sep 12 2023 13:45:09 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">we can optimize SharedStructTypes to use fast elements when those indexes are all packed, or something</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Sep 12 2023 13:45:22 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i could put it on the queue if it's a blocker</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Sep 12 2023 13:47:08 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hmm. I was hoping I could use <code>SharedStructType</code> to emulate <code>SharedArray</code> when I also need extra fields, but its significantly slower so that's a no-go.</blockquote></mx-reply>Could the N extra fields be hidden at the start of the sharedarray? Their names map to fixed indexes 0,1,2 etc, and all array looping logic knows to start index at N? Or too big a refactor?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Sep 12 2023 13:48:54 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Thats just as much of a refactor as what I was doing, which was stashing a SharedArray in an <code>items</code> field in another struct. The biggest issue with that approach is that every function that expected a <code>NodeArray</code> with indexable elements has to check if it's instead a <code>SharedNodeArray</code> to use its <code>items</code> field.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Sep 12 2023 13:49:22 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">rbuckton</span>: what's the full list of field names you'd like to be fast?</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Sep 12 2023 13:49:29 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">might not be too bad, i'll see if i have time next week</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Sep 12 2023 13:55:33 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'm not sure how to answer that. What's "slow" is that I'm trying to emulate a <code>SharedArray</code> with fields named <code>"length"</code>, <code>"0"</code>, <code>"1"</code>, etc. as well as attach a few extra fields that we normally stash on a <code>NodeArray</code>, which looks something like this:</p>
<pre><code class="language-ts">interface NodeArray&lt;T extends Node&gt; extends Array&lt;T&gt; {
  pos: number;
  end: number;
  hasTrailingComma: boolean;
  transformFlags: TransformFlags; // number
}
</code></pre>
<p>If you're asking about other fields, the most frequently hit fields on our AST are <code>pos</code>, <code>end</code>, <code>kind</code>, <code>id</code>, <code>transformFlags</code>, and <code>parent</code>:</p>
<pre><code class="language-ts">interface Node {
  pos: number;
  end: number;
  kind: SyntaxKind; // number
  transformFlags: TransformFlags; // number
  id: number | undefined;
  parent: Node | undefined;
}
</code></pre>
</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Sep 12 2023 13:59:06 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">ah i see</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Sep 12 2023 13:59:29 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">is the length of these nodes known AOT per Node?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Sep 12 2023 13:59:42 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">(and are contiguous?)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Sep 12 2023 14:07:39 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Can you clarify what you mean by contiguous?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Sep 12 2023 14:09:41 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I've essentially mirrored our AST structure into shared struct definitions, so I could tell you exactly how many fields are attached to a given node, though I'd need a bit if you want something like the average field count.</td></tr>

</tbody></table></div></div></div>
</body></html>