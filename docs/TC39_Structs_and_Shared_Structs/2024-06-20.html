<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2024-06-20</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2024-06-20<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-17" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Jun 20 2024 09:02:01 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Is there an agenda for the shared structs meeting? (after the plenary presentation, I'm considering attending)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 20 2024 09:02:55 GMT-0700 (Pacific Daylight Time)">16:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">It seems like there are some common problems to solve between shared structs and modules, with regard to what it means to "be the same code"</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 20 2024 09:28:48 GMT-0700 (Pacific Daylight Time)">16:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think we're hoping that Mark will show up and we can continue the discussion from plenary</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 20 2024 09:34:27 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">IMO the most awkward thing about the "same code" question is that WASM linking -- and especially WASM gc reference types -- already has a coherent answer to what it means for types to be compatible/identical/etc </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 20 2024 09:34:56 GMT-0700 (Pacific Daylight Time)">16:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">(a story based on exporting types and type witnesses)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 20 2024 09:35:42 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">do you have a reference for the type witness thing? I thought it was all structural</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 20 2024 09:35:47 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">and it's not been clear to me which parts of that story are possible or desirable to also do in JS, but it would sure make things simpler to use some of the same principles</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 20 2024 09:36:31 GMT-0700 (Pacific Daylight Time)">16:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">uhhh I don't know which parts of WASM are real and which are still imaginary, I read proposals and don't use it in practice yet</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 20 2024 09:37:44 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">but the exceptions/call tags pieces are definitely using witnesses and opaque coercions, and at least in some stage the GC proposal had some of that (for subtyping)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 20 2024 09:41:58 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">hmm yeah I don't see how/why we'd use those. I like the idea of identifying by parse node, and maybe adding onto that, reference (via module sources)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 20 2024 10:11:08 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">if you have witnesses you can have different declarations share the same identifier (different methods in different workers for the same struct), and subtyping/sealed witnesses provides a foundation for private fields</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 20 2024 10:11:43 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@shaylew:matrix.org">shaylew</span>&gt;</div></td><td class="msg-cell">(it's very alien to the JS world though, if it's the only place witnesses show up)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 20 2024 11:08:56 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">towards the end of the discussion, it felt like we were moving towards some concept of witnesses, but obviously a runtime not type-time witness</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 20 2024 12:07:09 GMT-0700 (Pacific Daylight Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>One way to tackle the "same code" issue might be code signing. If you're not using a custom loader you can just rely on source location (i.e., module cache key + source text position). If you want to use a custom loader, or even if you want to expose private state to WASM, you could give your shared struct a fixed identity (i.e., a UUID, URN, etc.) and sign the module. A custom loader could be given a suitable signing mechanism to sign its version of the module, or your WASM assembly could be signed in the same way. During correlation, we would compare both the fixed identity and whether both sources were signed with the same signing key. We could also have a syntactic mechanism to establish "trust" with other digital signatures.</p>
<pre><code class="language-js">export shared struct Point {
  with identity "uuid:191edd8d-ad62-4c5e-acec-4f2c0525e753";
  #x;
  #y;
  ...
}

// SIG // Begin signature block
// SIG // &lt;base64 encoded signature&gt;
// SIG // End signature block
</code></pre>
<p>(NOTE: the <code>// SIG</code> comment, above, is how the Windows Scripting Host (WSH) recognizes a digitally signed script signed using <code>signtool.exe</code>)</p>
<p>Loaders would need a way to enforce signatures at runtime, which is a bit trickier. One way this could be accomplished would be to have a syntactic mechanism to declare a dynamically generated signing key whose trust is associated with the trust of the containing module. If a loader can be locked down to prevent dynamic patching of its various resolve/fetch/link/evaluate algorithms, its methods were not generic (i.e., <code>this</code> was brand checked), and if those algorithms are trusted, then it could use the dynamic signing key to sign code as part of linking. Untrusted code wouldn't be able to create its own loader as it also wouldn't be trusted. A trusted loader could opt to not sign untrusted code, establishing a trust boundary.</p>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 20 2024 12:14:04 GMT-0700 (Pacific Daylight Time)">19:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">To be fair, I've been daydreaming about establishing trust boundaries at the module level in JS for awhile, with other ramifications besides this one. For example, establishing a membrane across a trust boundary and using decorators to enforce various trust relationships, such as ensuring the <code>this</code> of a function call is trusted by the function/method being called, or preventing untrusted code from calling a trusted method or function, or vice versa.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 20 2024 12:35:51 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Then again, .NET has been moving away from code access security and partially trusted code for awhile, and .NET Core doesn't support it at all. Current security recommendations are to never call partially trusted or untrusted code and to instead utilize virtualization or sandboxing. In that model, if you want code to run in isolation from the rest of your code, you actually run it in isolation. In that model, we'd probably establish a unique key for the current Realm and just indicate whether to copy that key (opt-in) to Realms it creates via workers/ShadowRealm/etc. If you want to run untrusted code, you create a new Worker/ShadowRealm and don't copy the Realm key. When we correlate <code>shared structs</code> based on <code>with identity ...</code>, we just combine the Realm's key with the struct's identity. Untrusted code can't match, but trusted code can.<br>If you want WASM to have access to private state, you pass a flag when you instantiate the assembly indicating whether to share the realm's key with the WASM module.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 20 2024 12:37:27 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That is fairly simple, and is closed by default. If you want your worker to correlate via <code>with identity</code>, you do something like <code>new Worker(code, { structCorrelation: "allow" })</code>.</td></tr>

</tbody></table></div></div></div>
</body></html>