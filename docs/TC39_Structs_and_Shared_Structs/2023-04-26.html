<!DOCTYPE html><html><head>
  <title>TC39 Structs and Shared Structs on 2023-04-26</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Structs and Shared Structs";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Structs and Shared Structs<br>2023-04-26<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-04-25" class="nav-link"><span>prev</span></a>
<a href="2023-04-27" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Structs and Shared Structs">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Apr 26 2023 05:00:10 GMT-0700 (Pacific Daylight Time)">12:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p><span class="nick-15">rbuckton</span>: i applaud the scope of "shared modules" but i feel that is tantamount to designing a new language, which is not incremental and significantly increases risk of adoption or shipping anything.</p>
<p>put another way, IMO the only realistic way to move the needle for multithreading for JS is to have an opt-in carve out for shared memory. shared structs <em>is</em> that opt-in. to have "shared modules" seems to require the capability to write code that is actual parallel and threadsafe <em>in general</em>, including a threadsafe stdlib. were i to do a greenfield project i'd design a stdlib with that in mind but i feel like that would be too much to bite off at the moment?</p>
</blockquote></mx-reply><p>I'm coming at this from two different directions, with two different outcomes:</p>
<ol>
<li>Design something transformative for the language, adding cohesive and comprehensive new capabilities.</li>
<li>Design something tacked on to the language, adding a minimal set of capabilities necessary to solve a specific problem.</li>
</ol>
<p>Option 1 is complex, takes longer, and requires a fair amount of "big design upfront", all to support capabilities we may or may not need. However, the end goal is to have something cohesive that is future-leaning with few "warts". That's what "shared modules" is, or is intended to be.</p>
<p>Option 2 is far simpler (though not trivial), shorter term, and focused. While this approach allows for incremental change, we may in the future find that related capabilities are harder to implement in the future because of design decisions we make now, potentially leaving more "warts" in the design over time.</p>
<p>I'm not opposed to either direction, but its worth considering the former even if only to inform the latter.</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Apr 26 2023 05:01:29 GMT-0700 (Pacific Daylight Time)">12:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> more i think about it, i think the non-threadsafe stdlib thing is the actual showstopper for me</blockquote></mx-reply>The "shared modules" approach would have required a threadsafe stdlib subset (i.e., make operations threadsafe if possible, and throw when not).</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Apr 26 2023 05:02:42 GMT-0700 (Pacific Daylight Time)">12:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I find the "only share data, but register per-thread behavior" approach acceptable, so long as we have a reasonable way to register per-thread behavior.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Apr 26 2023 05:04:58 GMT-0700 (Pacific Daylight Time)">12:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That's the approach I took with <a href="https://esfx.js.org/esfx/api/struct-type.html?tabs=ts">https://esfx.js.org/esfx/api/struct-type.html?tabs=ts</a>, though it's not so much "registration" and is more of a "wrap an ArrayBuffer with a DataView"-like approach.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Apr 26 2023 07:30:50 GMT-0700 (Pacific Daylight Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i'm saying something stronger for (1). my intuition is that "transformative" for JS actually means "not adoptable and unrealistic"</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Apr 26 2023 10:42:59 GMT-0700 (Pacific Daylight Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Yeah, I think it's good to <em>consider</em> 1, but after years of considering it, I haven't seen a realistic path for it. Do you? This informs my agreement with Shu's choice of 2.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Apr 26 2023 10:43:20 GMT-0700 (Pacific Daylight Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Are there other things about it we should consider? Other potential takeaways to inform things further?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Apr 26 2023 13:29:34 GMT-0700 (Pacific Daylight Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I remain convinced that sharing initialization code between realms, and in this case between agents, is also a general problem that is relevant for this proposal and for others (extensible cloning for example, or recursive initialization of ShadowRealms). I believe this problem can be solved without being transformative to the language, just with targeted API additions and relying on other proposals in progress like module expressions. So going towards (2) does not mean the solution has to be specific to this proposal.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Apr 26 2023 13:30:15 GMT-0700 (Pacific Daylight Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">We're all agreed on sharing code, the question is whether to has to be the same copy of the code or not</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Apr 26 2023 13:30:51 GMT-0700 (Pacific Daylight Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">my idea with module expressions has always been, it's the same code but different copies of it; different instances of the same module</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Apr 26 2023 13:32:42 GMT-0700 (Pacific Daylight Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Right I agree. I think multiple copies is sufficient, we just need to solve the registration ergonomics, which has different approaches possible, and where <span class="nick-15">rbuckton</span> and I disagree on.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Apr 26 2023 13:33:40 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah I agree registration ergonomics is fraught. Could you elaborate on the disagreement?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Apr 26 2023 13:33:46 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><span class="nick-5">bterlson</span>: I think I saw you typing?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Apr 26 2023 13:34:29 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Basically Ron suggested an implicit shared cross agent registry, which is a non starter in my book.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Apr 26 2023 13:34:30 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@bterlson:matrix.org">bterlson</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">littledan</span>: I was just catching up and typed a bit :-D Just got back from paternity and have been out for many an eon, have no idea whats going on</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Apr 26 2023 13:34:54 GMT-0700 (Pacific Daylight Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@bterlson:matrix.org">bterlson</span>&gt;</div></td><td class="msg-cell">(and I want this feature in my project I'm working on)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Apr 26 2023 13:35:19 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Basically Ron suggested an implicit shared cross agent registry, which is a non starter in my book.</blockquote></mx-reply>Huh, I don't see why we'd bother with a new registry when we already have the module map</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Apr 26 2023 13:35:27 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (and I want this feature in my project I'm working on)</blockquote></mx-reply>Oh! Could you say more?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Apr 26 2023 13:36:37 GMT-0700 (Pacific Daylight Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-5" title="@bterlson:matrix.org">bterlson</span>&gt;</div></td><td class="msg-cell">wasm stuff, can't say more yet :P</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Apr 26 2023 13:37:14 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">are we going to start living the multithreaded wasm gc dream?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Apr 26 2023 13:37:26 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">The module map is agent specific, different agents may have a different module map. The main question is independent initialization and what happens when you receive a shared struct from another agent, whether there is a relation to the "same" shared struct that may have been declared in the local agent</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Apr 26 2023 13:38:08 GMT-0700 (Pacific Daylight Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">basically identity discontinuity</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Apr 26 2023 13:39:03 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">wait, I thought a limited form of "identity discontinuity" was a given: We're taking that we have different <em>copies</em> of the functions and prototype (which ideally do the same thing)</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Apr 26 2023 13:39:39 GMT-0700 (Pacific Daylight Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">do you mean, the risk that it won't just be identity discontinuity, but a greater level where the actual behavior won't match up?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Apr 26 2023 13:40:19 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">for example, I imagined that each thread has its own global object which is mutable and all, and so different prototypes on different threads will access different things and experience different behavior</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Apr 26 2023 13:40:49 GMT-0700 (Pacific Daylight Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but that this is smoothed over because <code>[[GetPrototype]]()</code> finds the "current" prototype given your agent</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Apr 26 2023 13:41:21 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">if you receive Vector from agent 1, and yourself define and instantiate Vector, should these 2 objects share the same implementation locally?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Apr 26 2023 13:41:52 GMT-0700 (Pacific Daylight Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">they <em>should</em>, but defining "same implementation" is a bit complicated</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Apr 26 2023 13:42:05 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">and I guess it's a question of whether "should" or "must" is what we're going for</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Apr 26 2023 13:42:12 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">should you see the same prototype object ?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Apr 26 2023 13:42:37 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">oh sorry I misread the question... yes they should have the identical prototype identity IMO</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Apr 26 2023 13:42:44 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">or is it acceptable for these 2 objects to have equivalent prototype objects that are not the same</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Apr 26 2023 13:42:58 GMT-0700 (Pacific Daylight Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">what difficulties would we have in getting there?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Apr 26 2023 13:44:38 GMT-0700 (Pacific Daylight Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">How do you make that happen when both agents have independently defined their own <code>Vector</code> shared struct. I suppose how did they define the behavior of those shared structs is the question</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Apr 26 2023 13:45:02 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">what is the identity used to say they're the "same"</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Apr 26 2023 13:45:32 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think this identity could be keyed by a module specifier. This could be either a string specifier or module block</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Apr 26 2023 13:45:44 GMT-0700 (Pacific Daylight Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">that is, if you want to make a shared struct with a non-null prototype, it has to be exported from a module</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Apr 26 2023 13:46:02 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the pair of the (absolute) module specifier + export name is the key</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Apr 26 2023 13:46:16 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">if it's a string, you're dealing with module maps that may not resolve the same way between agents</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Apr 26 2023 13:46:34 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">module blocks do not currently preserve their identity through structured cloning</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Apr 26 2023 13:46:42 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">both good points</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Apr 26 2023 13:46:55 GMT-0700 (Pacific Daylight Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> module blocks do not currently preserve their identity through structured cloning</blockquote></mx-reply>we would have to switch this attribute of module blocks if we wanted to enable this usage</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Apr 26 2023 13:47:06 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if it's a string, you're dealing with module maps that may not resolve the same way between agents</blockquote></mx-reply>I'm willing to take this risk, but it's a value judgement</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Apr 26 2023 13:47:38 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">I'm curious where we imagine the module loading would be awaited</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Apr 26 2023 13:47:39 GMT-0700 (Pacific Daylight Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">re: the string risk, this is <em>not</em> a risk for meeting this property of the shared struct prototypes not matching. It just means different methods would be available on the different sides of the boundary</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Apr 26 2023 13:48:01 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">this is also an important problem. My suggestion would be, <code>[[GetPrototype]]()</code> throws if the module isn't already loaded.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Apr 26 2023 13:48:05 GMT-0700 (Pacific Daylight Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">module blocks is however my suggestion, and it doesn't solve the independent initialization use case. By definition one agent has to init first, and share the module block definition through postMessage, then agent 2 has to define the shared struct</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Apr 26 2023 13:49:20 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> module blocks is however my suggestion, and it doesn't solve the independent initialization use case. By definition one agent has to init first, and share the module block definition through postMessage, then agent 2 has to define the shared struct</blockquote></mx-reply>well, what if agent 1 doesn't bother sending over the module block, and just starts by sending the shared struct?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Apr 26 2023 13:49:29 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I believe however that having the same prototype object is not strictly necessary for most use cases</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Apr 26 2023 13:49:51 GMT-0700 (Pacific Daylight Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I worry that <em>forcing</em> module blocks rather than also allowing string specifiers will make initialization of programs too awkward and therefore impractical</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Apr 26 2023 13:51:22 GMT-0700 (Pacific Daylight Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">it's possible that the answer is indeed to do both</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Apr 26 2023 13:52:05 GMT-0700 (Pacific Daylight Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The module map is agent specific, different agents may have a different module map. The main question is independent initialization and what happens when you receive a shared struct from another agent, whether there is a relation to the "same" shared struct that may have been declared in the local agent</blockquote></mx-reply>I'm not so concerned about identity discontinuity. If each agent/realm is required to load its own copy of the behavior for a struct, the code defining that behavior could be different per agent/realm because of bundling/minification/tree shaking.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Apr 26 2023 13:53:14 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">How is it a problem that it's different?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Apr 26 2023 13:53:33 GMT-0700 (Pacific Daylight Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm not so concerned about identity discontinuity. If each agent/realm is required to load its own copy of the behavior for a struct, the code defining that behavior could be different per agent/realm because of bundling/minification/tree shaking.</blockquote></mx-reply>I may have misinterpreted "identity discontinuity". I'm thinking about behavior, not identity.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Apr 26 2023 13:54:31 GMT-0700 (Pacific Daylight Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Good, we are all trying to accomplish the same thing then</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Apr 26 2023 13:55:25 GMT-0700 (Pacific Daylight Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">by identity discontinuity I meant that the prototype object for a vector received from another agent may not be the same as the prototype object for a vector object defined and instantiated in the local agent.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Apr 26 2023 13:56:44 GMT-0700 (Pacific Daylight Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">What matters to me is that there is a way to define <code>Vector</code> in two threads (A and B) such that a <code>Vector</code> created in A is also a <code>Vector</code> in B, and vise versa. Also, that a <code>Vector</code> created in A, sent to B, and then sent back to A is still a <code>Vector</code> in A.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Apr 26 2023 13:57:42 GMT-0700 (Pacific Daylight Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">A and B may have subtly different implementations of <code>Vector</code> (due to tree shaking, etc.), so there needs to be some way for A and B to coordinate what a <code>Vector</code> is.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Apr 26 2023 13:59:19 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The tree shaking concern isn't conjecture either. If "the way" to do multithreading in JS is going to require duplicating runtime code in each thread, developers are going to want to find ways to minimize the memory footprint of short-lived threads by tree shaking away unused functionality.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Apr 26 2023 13:59:23 GMT-0700 (Pacific Daylight Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Right, but the main question is whether this should be possible without an explicit "synchronization" message between A and B</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Apr 26 2023 14:00:31 GMT-0700 (Pacific Daylight Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> A and B may have subtly different implementations of <code>Vector</code> (due to tree shaking, etc.), so there needs to be some way for A and B to coordinate what a <code>Vector</code> is.</blockquote></mx-reply>so, I guess the question is, whether we especially want to permit this difference</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Apr 26 2023 14:00:32 GMT-0700 (Pacific Daylight Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Right, but the main question is whether this should be possible without an explicit "synchronization" message between A and B</blockquote></mx-reply>Or a way to register the prototype via a Worker</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Apr 26 2023 14:01:07 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> so, I guess the question is, whether we especially want to permit this difference</blockquote></mx-reply>I think it's important to permit it. If we can't share code, we need to be able to reduce overhead in other ways.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Apr 26 2023 14:01:45 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The tree shaking concern isn't conjecture either. If "the way" to do multithreading in JS is going to require duplicating runtime code in each thread, developers are going to want to find ways to minimize the memory footprint of short-lived threads by tree shaking away unused functionality.</blockquote></mx-reply>I can see how this is nice to have; what I have trouble understanding is whether it's an absolute blocker. There are reasons, on the other hand, to prefer that this correspondence in the code loaded is mandatory</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Apr 26 2023 14:01:51 GMT-0700 (Pacific Daylight Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Aka if and how can A and B define their <code>Vector</code> independently and for the vector instance send by A to B to have the same prototype as the one created independently by B</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Apr 26 2023 14:03:14 GMT-0700 (Pacific Daylight Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Actually: I think it should work just fine to use a small module which just contains the field definitions, and then have other chunks of code (different in different workers/agents) which go back and install methods on the class.</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Apr 26 2023 14:03:22 GMT-0700 (Pacific Daylight Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">My understanding is that module identifiers are somewhat problematic with bundlers</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Apr 26 2023 14:03:47 GMT-0700 (Pacific Daylight Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">and I don't see a way to accomplish this with module blocks</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Apr 26 2023 14:04:06 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Bundlers, minifiers, and treeshakers exist for a reason. Performance is important, so whatever solution we come up with must be able to handle web reality.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Apr 26 2023 14:04:12 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Actually: I think it should work just fine to use a small module which just contains the field definitions, and then have other chunks of code (different in different workers/agents) which go back and install methods on the class.</blockquote></mx-reply>these later "installation" chunks of code could use various different techniques to minimize the memory footprint, as rbuckton mentioned</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Apr 26 2023 14:04:37 GMT-0700 (Pacific Daylight Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the must-be-the-same parts are really limited to, what field names are there (which is mandatory to correspond anyway)</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Apr 26 2023 14:05:39 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">How do you "attach" the behavior to a struct definition? What is the shared identity of the struct definition</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Apr 26 2023 14:05:52 GMT-0700 (Pacific Daylight Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How do you "attach" the behavior to a struct definition? What is the shared identity of the struct definition</blockquote></mx-reply>by mutating the prototype</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Apr 26 2023 14:06:01 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">this is just about making sure that we can call methods on these instances</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Apr 26 2023 14:06:12 GMT-0700 (Pacific Daylight Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">you'd just be mutating the prototype on your own agent-local copy of course</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Apr 26 2023 14:07:15 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Bundlers, minifiers, and treeshakers exist for a reason. Performance is important, so whatever solution we come up with must be able to handle web reality.</blockquote></mx-reply>I think we don't quite know yet how much of this will need to differ per agent in a single cooperating application. But generally I see your point. But I think the technique I explained above should be enough.</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Apr 26 2023 14:07:29 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">My suggestion is to use a registry, possibly scoped to the Worker. Rather than message synchronization, the code loaded in the worker thread must register an association between a string key and a prototype. The thread that creates the Worker must also register the same key with a prototype, otherwise the behavior isn't available.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Apr 26 2023 14:07:55 GMT-0700 (Pacific Daylight Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Ron, you know that TC39 doesn't like this kind of registry. Let's try to think of something else.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Apr 26 2023 14:08:14 GMT-0700 (Pacific Daylight Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I don't yet understand the problem with my suggestion to use module specifiers, given that the weighty part of the class (the method definitions) can be factored out</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Apr 26 2023 14:09:16 GMT-0700 (Pacific Daylight Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">as I've mentioned before a mutable registry with forgeable string keys scoped to an agent or realm is a non starter for me </td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Apr 26 2023 14:10:03 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I see how the registry solves the problem, but I don't understand why the other solution doesn't work as well.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Apr 26 2023 14:10:26 GMT-0700 (Pacific Daylight Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Something like:</p>
<pre><code class="language-js">// main.js
import { Worker } from "worker_threads";
import { Vector } from "./vector.js";

const worker = new Worker("./worker.js", { structTypes: { "some-string-for-vector": Vector.prototype } });
worker.postMessage(new Vector());

// worker.js
import { parentPort } from "worker_threads";
import { Vector } from "./vector.js";

parentPort.addStructType("some-string-for-vector", Vector.prototype);
parentPort.onmessage = msg =&gt; {
  msg // a Vector
};
</code></pre>
</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Apr 26 2023 14:11:25 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">A per channel registry however like above is fine</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Apr 26 2023 14:11:43 GMT-0700 (Pacific Daylight Time)">21:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">What I'm suggesting is a per-channel registry.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Apr 26 2023 14:12:50 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">huh, I don't understand how this would be implemented. It has to be that we <em>don't</em> have wrapper objects per instance. So the channel can't be transforming what goes across it.</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Apr 26 2023 14:12:58 GMT-0700 (Pacific Daylight Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>An alternative, which makes things even less mutable might be:</p>
<pre><code class="language-js">import { parentPort, MessagePortWrapper } from "worker_threads";
const parent = new MessagePortWrapper(parentPort, { structTypes: { ... } });
parent.onmessage = msg =&gt; { ... };
</code></pre>
</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Apr 26 2023 14:13:55 GMT-0700 (Pacific Daylight Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I don't see how a registry not scoped to the agent could satisfy the no-linear-work-across-postmessage property</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Apr 26 2023 14:14:39 GMT-0700 (Pacific Daylight Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Ah, I think I see what you mean. You want the remote agent to define these types once for the agent.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Apr 26 2023 14:16:47 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">well, I don't necessarily want that particular thing. For this no-linear-work requirement, an agent-scoped registry would work if defined inside that agent (it just wouldn't meet Matthieu's goals)</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Apr 26 2023 14:16:55 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But the same problem exists in the main thread as well. We wouldn't be able to handle per-channel prototype associations either.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Apr 26 2023 14:16:57 GMT-0700 (Pacific Daylight Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">also using the module map would work</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Apr 26 2023 14:17:07 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> also using the module map would work</blockquote></mx-reply>Except for bundling?</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Wed Apr 26 2023 14:17:16 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">brb, meeting.</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Wed Apr 26 2023 14:17:30 GMT-0700 (Pacific Daylight Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But the same problem exists in the main thread as well. We wouldn't be able to handle per-channel prototype associations either.</blockquote></mx-reply>That's right. The prototype has to be per-agent (resolved in GetPrototype), not per-channel</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Wed Apr 26 2023 14:18:23 GMT-0700 (Pacific Daylight Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Except for bundling?</blockquote></mx-reply>Yes, that's right, doing something based on the module map would require usage of <em>native</em> ESM. That's an argument against this approach. It's also a reason why module expressions might be relevant (if we fixed the cloning behavior)</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Wed Apr 26 2023 14:19:05 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I guess I just sort of believe that we're getting to a point where it can be OK to bet on native ESM</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Wed Apr 26 2023 14:19:30 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Module expressions require an explicit introduction however before defining the struct</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Wed Apr 26 2023 14:20:06 GMT-0700 (Pacific Daylight Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Module expressions require an explicit introduction however before defining the struct</blockquote></mx-reply>yes, definitely introduces its own awkwardness</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Wed Apr 26 2023 14:21:56 GMT-0700 (Pacific Daylight Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">Mathieu Hofman</span>: to clarify, an <em>additional</em> mutable registry is a non-starter for you, is that right?</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Wed Apr 26 2023 14:22:14 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">like, one rather crude thing is to use an existing mutable registry, like, the global scope</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Wed Apr 26 2023 14:22:27 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">not the global scope!!!</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Wed Apr 26 2023 14:22:59 GMT-0700 (Pacific Daylight Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">bro why</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Wed Apr 26 2023 14:23:01 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">it's already there</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Wed Apr 26 2023 14:23:14 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">love to use things that are already there!</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Wed Apr 26 2023 14:23:25 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">depends on what is used as keys. if using forgeable string keys, it is. if using unforgeable objects, then it's equivalent to a WeakMap, which is fine</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Wed Apr 26 2023 14:23:40 GMT-0700 (Pacific Daylight Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">it's icky</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Wed Apr 26 2023 14:24:13 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i'm gonna make a shirt that says "globals lover"</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Wed Apr 26 2023 14:24:20 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">the o in "global" will be a heart</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Wed Apr 26 2023 14:24:39 GMT-0700 (Pacific Daylight Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">oh the global scope is not shared across agents, the problem is that the registry would have to be shared between realms/agents for it to be useful, no ?</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Wed Apr 26 2023 14:25:08 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i don't think it's a hard requirement for me the registry itself be shared</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Wed Apr 26 2023 14:25:31 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">it's already part of the model that the app is responsible for ensuring the same code is loaded across agents, and hopefully we'll make that not too hard</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Wed Apr 26 2023 14:25:47 GMT-0700 (Pacific Daylight Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Just to clarify, per-channel prototypes are a non-starter, which means a per-channel registry is probably a non-starter.</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Wed Apr 26 2023 14:26:01 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">ensuring the same key is used for the copies of the code would be part of that responsibility</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Wed Apr 26 2023 14:26:18 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">shu: By that, do you mean, of course there needs to be a happy path where you load the same-acting prototype in each agent, but it's OK if you're able to load non-matching things?</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Wed Apr 26 2023 14:26:31 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Wed Apr 26 2023 14:26:32 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(if so I agree; I don't see it being necessary that we force it to be the same code)</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Wed Apr 26 2023 14:26:52 GMT-0700 (Pacific Daylight Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Which means the struct value-&gt;prototype relationship must be per-thread.</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Wed Apr 26 2023 14:27:30 GMT-0700 (Pacific Daylight Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Which means the struct value-&gt;prototype relationship must be per-thread.</blockquote></mx-reply>yes this is a given at the outset of the conversation; I thought we've been talking in those terms this whole time</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Wed Apr 26 2023 14:28:02 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">In this "use the global scope" idea, what happens if the registration changes, aka the global property gets redefined. Do existing objects have their proto automagically change to the new object ?</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Wed Apr 26 2023 14:28:06 GMT-0700 (Pacific Daylight Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> yes this is a given at the outset of the conversation; I thought we've been talking in those terms this whole time</blockquote></mx-reply>I'm just clarifying things, for myself if for no one else</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Wed Apr 26 2023 14:29:07 GMT-0700 (Pacific Daylight Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> In this "use the global scope" idea, what happens if the registration changes, aka the global property gets redefined. Do existing objects have their proto automagically change to the new object ?</blockquote></mx-reply>It would be like, each time you do a property access resulting in [[GetPrototypeOf]] (so it's not an own property), the global would be looked up to see how it resolves</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Wed Apr 26 2023 14:29:35 GMT-0700 (Pacific Daylight Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">My concern with a forgeable key global registry was about libraries fighting to define the same thing</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Wed Apr 26 2023 14:29:51 GMT-0700 (Pacific Daylight Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">why is that different than loading competing polyfills?</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Wed Apr 26 2023 14:30:10 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">or rather, is it different? maybe it is</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Wed Apr 26 2023 14:30:13 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I mean, I think TC39 added modules to solve this problem</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Wed Apr 26 2023 14:30:17 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So, value-&gt;prototype is per-thread, and <em>n</em> threads need to coordinate this value-&gt;prototype relationship to properly communicate, which means there must be some type of unique identity associated with the value-&gt;prototype relationship that can be reproduced in each thread.</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Wed Apr 26 2023 14:30:23 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">because competing over globals <em>was</em> a real problem in JS</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Wed Apr 26 2023 14:30:39 GMT-0700 (Pacific Daylight Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Shared struct object wouldn't allowed to be frozen, would they ?</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Wed Apr 26 2023 14:31:16 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">no, they can't be frozen without violating the "immutable shapes" requirement</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Wed Apr 26 2023 14:31:21 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">else all property accesses would need to synchronize</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Wed Apr 26 2023 14:31:37 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">sure but there can be born-frozen shared structs (hypothetically--not arguing it should be prioritized)</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Wed Apr 26 2023 14:31:39 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">they should be able to be made frozen-from-construction, however</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Wed Apr 26 2023 14:31:40 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Wed Apr 26 2023 14:31:54 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(I don't see a reason to add this, but I also don't see what it would break)</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Wed Apr 26 2023 14:31:54 GMT-0700 (Pacific Daylight Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">oops, editor call and other mtgs, bbl</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Wed Apr 26 2023 14:32:06 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">the prototype of a frozen object cannot change</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Wed Apr 26 2023 14:32:23 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">so it can't be looked up dynamically for these frozen structs</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Wed Apr 26 2023 14:32:26 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">well, it would never change within an agent</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Wed Apr 26 2023 14:32:28 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">oh, right</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Wed Apr 26 2023 14:32:42 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah, that's something we could accomplish with modules but not globals</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Wed Apr 26 2023 14:32:54 GMT-0700 (Pacific Daylight Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">it'd have to be a const module export!</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Wed Apr 26 2023 14:36:06 GMT-0700 (Pacific Daylight Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I also have got to get back to work. <span class="nick-10">littledan</span> hopefully that highlights where the remaining problems are with different copies of behavior code</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Wed Apr 26 2023 14:42:04 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I have to work too! I think this helped advance all of our understanding and we're at a good place to stop</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Wed Apr 26 2023 14:42:41 GMT-0700 (Pacific Daylight Time)">21:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I'm more OK with different copies/behaviors of code than I am with using the global object, which leads to classic namespace management problems</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Wed Apr 26 2023 14:43:52 GMT-0700 (Pacific Daylight Time)">21:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I wonder if we could accomplish a per-thread registry with workers via a preload mechanism? Would that be an acceptable compromise for that approach?</p>
<p>Consider:</p>
<ul>
<li>The main thread must load/evaluate all struct types it intends to use to communicate with workers.</li>
<li>Struct types with behavior must have an associated unique identity (possibly user defined).</li>
<li>When the main thread constructs a Worker, it must specify a <code>preload</code> module in addition to the regular worker script.</li>
<li>The <code>preload</code> module is loaded in the Worker first, and should load/evaluate all struct types so that their type-&gt;prototype mapping is loaded. This is to be considered a privileged operation, so developers should take care with how third-party code is loaded at this time.</li>
<li>After the <code>preload</code> module has been evaluated, the Worker's struct type registry is locked down and the regular worker script/module is evaluated. It reuses the same module cache as the <code>preload</code> script, so module identities and reference identities are consistent between <code>preload</code> and normal execution.</li>
</ul>
</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Wed Apr 26 2023 14:44:43 GMT-0700 (Pacific Daylight Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This approach is similar to Electron's preload mechanism</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Wed Apr 26 2023 14:46:35 GMT-0700 (Pacific Daylight Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><a href="https://www.electronjs.org/docs/latest/tutorial/tutorial-preload">https://www.electronjs.org/docs/latest/tutorial/tutorial-preload</a>, for reference.</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Wed Apr 26 2023 14:50:45 GMT-0700 (Pacific Daylight Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>In that approach, you might write something like:</p>
<pre><code class="language-js">// point.js
@Reflect.StructIdentity("796eb01e-70d2-42c6-a30f-8bdce572db3d")
export shared struct Point {
  x;
  y;
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
  toString() {
    return `${this.x},${this.y}`;
  }
}

// main.js
import { Point } from "./point.js";
import { Worker } from "worker_threads";

const worker = new Worker("worker.js", { type: "module", preload: "preload.js" });
worker.postMessage(new Point(0, 0));

// preload.js
import "./point.js";

// worker.js
import { parentPort } from "worker_threads";
parentPort.onmessage = msg =&gt; {
  console.log(msg.toString()); // prints: 0,0
}
</code></pre>
</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Wed Apr 26 2023 14:51:35 GMT-0700 (Pacific Daylight Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think this requires a kind of centralized coordination that I'd prefer to not require</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Wed Apr 26 2023 14:53:14 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It's pretty much a given that we must perform some kind of coordination. I'm borrowing from electron's model because its fairly widely adopted.</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Wed Apr 26 2023 14:53:56 GMT-0700 (Pacific Daylight Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">sure there's coordination across threads to load the corresponding code, but coordinating all the "preload" code to be packaged up together seems like a different kind of thing</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Wed Apr 26 2023 14:54:27 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">also Electron is using this for privileged APIs, but I'd prefer that this is conceptually unprivileged</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Wed Apr 26 2023 14:54:27 GMT-0700 (Pacific Daylight Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">A different approach might be something fully statically analyzable during module import evaluation, so long as it still allows bundling/minification/tree shaking.</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Wed Apr 26 2023 14:55:35 GMT-0700 (Pacific Daylight Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Skimming back really quick, but the ability to define modules that are evaluated when constructing a new realm is exactly what I'd want.</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Wed Apr 26 2023 14:56:32 GMT-0700 (Pacific Daylight Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Skimming back really quick, but the ability to define modules that are evaluated when constructing a new realm is exactly what I'd want.</blockquote></mx-reply>Are you talking about the <code>preload</code> mechanism?</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Wed Apr 26 2023 14:57:36 GMT-0700 (Pacific Daylight Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">well more general, but yeah, modules that are executed right after the realm is instantiated by the engine, but before other code runs</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Wed Apr 26 2023 14:58:12 GMT-0700 (Pacific Daylight Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">can be used to seamlessly apply transformations to the realm</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Wed Apr 26 2023 14:59:35 GMT-0700 (Pacific Daylight Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">any realm created from your realm applies the list of registered modules</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Wed Apr 26 2023 15:02:48 GMT-0700 (Pacific Daylight Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">But do you want that mechanism plus not being able to define new shared structs later?</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Wed Apr 26 2023 15:17:35 GMT-0700 (Pacific Daylight Time)">22:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I don't see why we need to disallow the definition of new shared structs, but I haven't fully thought it through in this context</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Wed Apr 26 2023 15:32:17 GMT-0700 (Pacific Daylight Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I would allow them to be defined, but they wouldn't be registered so a prototype walk from a foreign struct value would fail.</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Wed Apr 26 2023 15:35:02 GMT-0700 (Pacific Daylight Time)">22:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I'd still like a mechanism to manually synchronize so that you can use the prototype of a foreign struct that isn't pre-registered. It just means you can share the prototype with the "equivalent" struct declared locally</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Wed Apr 26 2023 15:35:51 GMT-0700 (Pacific Daylight Time)">22:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>How would you do this in a way that doesn't involve:</p>
<ul>
<li>A mutable shared registry, or</li>
<li>A wrapper object per instance</li>
</ul>
</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Wed Apr 26 2023 15:36:03 GMT-0700 (Pacific Daylight Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">and as <span class="nick-10">littledan</span> said, maybe it's just by creating an empty prototype object the first time that can be attached props</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Wed Apr 26 2023 15:36:50 GMT-0700 (Pacific Daylight Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">so the seeing a struct the first time would create a registration, but it's not mutable</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Wed Apr 26 2023 15:40:53 GMT-0700 (Pacific Daylight Time)">22:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">or as I had in my earlier suggestion in january, a way to share over post message an unforgeable representative of the struct kind, allowing to define the local prototype object for structs of that kind</td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Wed Apr 26 2023 15:41:08 GMT-0700 (Pacific Daylight Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">oh creating an empty proto is an interesting alternative i hadn't thought about before</td></tr>
  <tr class="msg" id="L167"><td class="ts-cell"><a class="ts" href="#L167" alt="Wed Apr 26 2023 15:41:20 GMT-0700 (Pacific Daylight Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So, if its registered you get the registered prototype, if its unregistered you get an empty prototype? How would you warn a user that they tried to walk the prototype of a foreign struct value that has no associated behavior?</td></tr>
  <tr class="msg" id="L168"><td class="ts-cell"><a class="ts" href="#L168" alt="Wed Apr 26 2023 15:41:35 GMT-0700 (Pacific Daylight Time)">22:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">the warning is that the app doesn't work, i feel like?</td></tr>
  <tr class="msg" id="L169"><td class="ts-cell"><a class="ts" href="#L169" alt="Wed Apr 26 2023 15:42:06 GMT-0700 (Pacific Daylight Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">yes that's for allowing inband synchronization.</td></tr>
  <tr class="msg" id="L170"><td class="ts-cell"><a class="ts" href="#L170" alt="Wed Apr 26 2023 15:42:33 GMT-0700 (Pacific Daylight Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">You send a post message saying, here is an object of kind "foo", please init its proto as needed</td></tr>
  <tr class="msg" id="L171"><td class="ts-cell"><a class="ts" href="#L171" alt="Wed Apr 26 2023 15:42:51 GMT-0700 (Pacific Daylight Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">and you attach a dummy instance of the struct</td></tr>
  <tr class="msg" id="L172"><td class="ts-cell"><a class="ts" href="#L172" alt="Wed Apr 26 2023 15:42:52 GMT-0700 (Pacific Daylight Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I was hoping for a better developer experience, and by "better developer experience" I mean "throw an error with a message I can search for on stackoverflow"</td></tr>
  <tr class="msg" id="L173"><td class="ts-cell"><a class="ts" href="#L173" alt="Wed Apr 26 2023 15:44:03 GMT-0700 (Pacific Daylight Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">well my suggestion for having a kind representative and having to register using that would allow to throw an explicit message if you walk the proto of a struct that wasn't registered</td></tr>
  <tr class="msg" id="L174"><td class="ts-cell"><a class="ts" href="#L174" alt="Wed Apr 26 2023 15:44:35 GMT-0700 (Pacific Daylight Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">it is however a little more API complexity</td></tr>
  <tr class="msg" id="L175"><td class="ts-cell"><a class="ts" href="#L175" alt="Wed Apr 26 2023 15:44:45 GMT-0700 (Pacific Daylight Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Like, an exotic object that throws on property access. That's still achievable with the "empty prototype" idea, except you have to do: value -&gt; empty prototype -&gt; throw-on-access-object</td></tr>
  <tr class="msg" id="L176"><td class="ts-cell"><a class="ts" href="#L176" alt="Wed Apr 26 2023 15:45:38 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Where the "throw-on-access-object" is analogous to a revoked proxy.</td></tr>
  <tr class="msg" id="L177"><td class="ts-cell"><a class="ts" href="#L177" alt="Wed Apr 26 2023 15:45:46 GMT-0700 (Pacific Daylight Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">please no more exotic object</td></tr>
  <tr class="msg" id="L178"><td class="ts-cell"><a class="ts" href="#L178" alt="Wed Apr 26 2023 15:46:19 GMT-0700 (Pacific Daylight Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I'd prefer normal objects for the prototype</td></tr>
  <tr class="msg" id="L179"><td class="ts-cell"><a class="ts" href="#L179" alt="Wed Apr 26 2023 15:46:33 GMT-0700 (Pacific Daylight Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">the instances are already exotic enough ;)</td></tr>
  <tr class="msg" id="L180"><td class="ts-cell"><a class="ts" href="#L180" alt="Wed Apr 26 2023 15:46:49 GMT-0700 (Pacific Daylight Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It doesn't have to be exotic</td></tr>
  <tr class="msg" id="L181"><td class="ts-cell"><a class="ts" href="#L181" alt="Wed Apr 26 2023 15:47:42 GMT-0700 (Pacific Daylight Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">IIRC, a revoked Proxy isn't exotic, so it could be spec'd similarly.</td></tr>
  <tr class="msg" id="L182"><td class="ts-cell"><a class="ts" href="#L182" alt="Wed Apr 26 2023 15:50:55 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Alternatively, the "empty prototype" could itself be an ordinary object with hooks similar to a proxy that throws on attempts to read/write to non-existent properties, but still allow you to use <code>Object.defineProperty</code>.</td></tr>
  <tr class="msg" id="L183"><td class="ts-cell"><a class="ts" href="#L183" alt="Wed Apr 26 2023 15:55:49 GMT-0700 (Pacific Daylight Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>What would the API look like? Something like this?</p>
<pre><code class="language-js">// worker.js
import { parentPort } from "worker_threads";
import { Point } from "./point.js";

parentPort.onunhandledstruct = (id, prototype) =&gt; {
  switch (id) {
    case "796eb01e-70d2-42c6-a30f-8bdce572db3d":
      Object.defineProperties(prototype, Object.getOwnPropertyDescriptors(Point.prototype));
      break;
  }
};
</code></pre>
<p>That kind of registration could have issues if shared structs are allowed to have private fields/methods (and I'd like us to consider them in the future).</p>
</td></tr>
  <tr class="msg" id="L184"><td class="ts-cell"><a class="ts" href="#L184" alt="Wed Apr 26 2023 15:56:10 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">a proxy object is the definition of exotic</td></tr>
  <tr class="msg" id="L185"><td class="ts-cell"><a class="ts" href="#L185" alt="Wed Apr 26 2023 15:56:32 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">a proxy object is how user land can make exotic objects</td></tr>
  <tr class="msg" id="L186"><td class="ts-cell"><a class="ts" href="#L186" alt="Wed Apr 26 2023 15:56:37 GMT-0700 (Pacific Daylight Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> a proxy object is the definition of exotic</blockquote></mx-reply>ProxyCreate calls MakeBasicObject, which creates an ordinary object.</td></tr>
  <tr class="msg" id="L187"><td class="ts-cell"><a class="ts" href="#L187" alt="Wed Apr 26 2023 15:57:36 GMT-0700 (Pacific Daylight Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I think having a way to signal to a developer <em>why</em> a value isn't behaving appropriately is important, especially considering the complex mechanisms in play necessary to make this work.</td></tr>
  <tr class="msg" id="L188"><td class="ts-cell"><a class="ts" href="#L188" alt="Wed Apr 26 2023 15:58:35 GMT-0700 (Pacific Daylight Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If our answer is "you just get a plain old ReferenceError because its a plain old object", we're not doing the development community any favors.</td></tr>
  <tr class="msg" id="L189"><td class="ts-cell"><a class="ts" href="#L189" alt="Wed Apr 26 2023 15:58:44 GMT-0700 (Pacific Daylight Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I'd agree. But I'd really prefer avoiding more exotic like behavior</td></tr>
  <tr class="msg" id="L190"><td class="ts-cell"><a class="ts" href="#L190" alt="Wed Apr 26 2023 15:59:16 GMT-0700 (Pacific Daylight Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The whole idea of shared structs is exotic-like behavior.</td></tr>
  <tr class="msg" id="L191"><td class="ts-cell"><a class="ts" href="#L191" alt="Wed Apr 26 2023 16:01:30 GMT-0700 (Pacific Daylight Time)">23:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">on the instances. Is the argument that we already have exotic behavior there so, exotic behavior on the prototype is ok?</td></tr>
  <tr class="msg" id="L192"><td class="ts-cell"><a class="ts" href="#L192" alt="Wed Apr 26 2023 16:03:08 GMT-0700 (Pacific Daylight Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Also, is there any reason we can't do an API like this instead:</p>
<pre><code class="language-js">// called _before_ the runtime assigns a prototype to an unregistered foreign struct for the first time.
parentPort.onunhandledstruct = (id) =&gt; {
  switch (id) {
    case "796eb01e-70d2-42c6-a30f-8bdce572db3d":
      return Point.prototype;
  }
};
</code></pre>
</td></tr>
  <tr class="msg" id="L193"><td class="ts-cell"><a class="ts" href="#L193" alt="Wed Apr 26 2023 16:03:51 GMT-0700 (Pacific Daylight Time)">23:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Though both of the API sketches above don't seem like they'd work per-realm in the same thread (if that was a requirement?)</td></tr>
  <tr class="msg" id="L194"><td class="ts-cell"><a class="ts" href="#L194" alt="Wed Apr 26 2023 16:05:33 GMT-0700 (Pacific Daylight Time)">23:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> on the instances. Is the argument that we already have exotic behavior there so, exotic behavior on the prototype is ok?</blockquote></mx-reply>All I care about regarding this point is that we want a good developer experience, or at least the best we can offer.</td></tr>
  <tr class="msg" id="L195"><td class="ts-cell"><a class="ts" href="#L195" alt="Wed Apr 26 2023 16:07:45 GMT-0700 (Pacific Daylight Time)">23:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Though, if we have an API design like one that has <code>return Point.prototype</code> above, we could potentially have unregistered and unhandled foreign struct values just have a <code>null</code> prototype, and tailor the <code>ReferenceError</code> message based on the fact the value itself is a struct value.</td></tr>
  <tr class="msg" id="L196"><td class="ts-cell"><a class="ts" href="#L196" alt="Wed Apr 26 2023 16:08:42 GMT-0700 (Pacific Daylight Time)">23:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That's still tantamount to a mutable registry though, even if it is first-in-wins.</td></tr>
  <tr class="msg" id="L197"><td class="ts-cell"><a class="ts" href="#L197" alt="Wed Apr 26 2023 16:10:58 GMT-0700 (Pacific Daylight Time)">23:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'm not really sure how any dynamic "cure an unhandled foreign struct value's prototype" mechanism isn't just another way to say "mutable shared registry"</td></tr>
  <tr class="msg" id="L198"><td class="ts-cell"><a class="ts" href="#L198" alt="Wed Apr 26 2023 16:18:37 GMT-0700 (Pacific Daylight Time)">23:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">It really feels like this pre-registration stuff really is realm "arguments". With preload or other generic realm init, you can only express the identity of a struct kind as a string in code, where if you had a way to pass arguments to that init logic, you could pass handles to the struct definitions.</td></tr>
  <tr class="msg" id="L199"><td class="ts-cell"><a class="ts" href="#L199" alt="Wed Apr 26 2023 16:19:22 GMT-0700 (Pacific Daylight Time)">23:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">at the end of the day, the "parentPort" is an implicit argument of the new Worker</td></tr>
  <tr class="msg" id="L200"><td class="ts-cell"><a class="ts" href="#L200" alt="Wed Apr 26 2023 16:20:14 GMT-0700 (Pacific Daylight Time)">23:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">maybe we should have a global called "initArgs"</td></tr>
  <tr class="msg" id="L201"><td class="ts-cell"><a class="ts" href="#L201" alt="Wed Apr 26 2023 16:22:54 GMT-0700 (Pacific Daylight Time)">23:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Well, <code>parentPort</code> in this case is already a thing in NodeJS. So is something like <code>initArgs</code> (i.e., <code>workerData</code>)</p>
<p><a href="https://nodejs.org/dist/latest-v20.x/docs/api/worker_threads.html#workerparentport">https://nodejs.org/dist/latest-v20.x/docs/api/worker_threads.html#workerparentport</a></p>
<p><a href="https://nodejs.org/dist/latest-v20.x/docs/api/worker_threads.html#workerworkerdata">https://nodejs.org/dist/latest-v20.x/docs/api/worker_threads.html#workerworkerdata</a></p></td></tr>
  <tr class="msg" id="L202"><td class="ts-cell"><a class="ts" href="#L202" alt="Wed Apr 26 2023 16:23:30 GMT-0700 (Pacific Daylight Time)">23:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">TIL about <code>workerData</code>. I guess yes</td></tr>
  <tr class="msg" id="L203"><td class="ts-cell"><a class="ts" href="#L203" alt="Wed Apr 26 2023 16:27:07 GMT-0700 (Pacific Daylight Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It really feels like this pre-registration stuff really is realm "arguments". With preload or other generic realm init, you can only express the identity of a struct kind as a string in code, where if you had a way to pass arguments to that init logic, you could pass handles to the struct definitions.</blockquote></mx-reply>What do you mean by handles?</td></tr>
  <tr class="msg" id="L204"><td class="ts-cell"><a class="ts" href="#L204" alt="Wed Apr 26 2023 16:29:32 GMT-0700 (Pacific Daylight Time)">23:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <pre><code class="language-js">// vector2d.js
// Each shared struct type, whether data only or "prepared" has its own unique type
export const vector2Dtype = SharedStructType.prepare(["x", "y"]);

const _Vector2D = SharedStructType.getConstructor(vector2Dtype);

// custom construction behavior
export function Vector2D(x = 0, y = 0) {
  const _this = Reflect.construct(_Vector2D, [], new.target);
  _this.x = x;
  _this.y = y;
  return _this;
}

// prototype methods
Vector2D.prototype.distanceTo = function (v) {
  const dx = this.x - v.x;
  const dy = this.y - v.y;
  return Math.sqrt(dx * dx + dy * dy);
};

SharedStructType.registerPrototype(vector2Dtype, Vector2D.prototype);

// main.js
import { Vector2D, vector2DType } from "./vector2d.js";
const v1 = new Vector2D(1, 2);
const worker = new Worker("worker.js");
worker.postMessage([vector2DType, v1]);

// worker.js
// worker imports Vector2D, which causes registration as a side-effect.
import { Vector2D, vector2DType } from "./vector2d.js";

const v2 = new Vector2D(3, 4);

parentPort.on("message", ([mainVector2DType, v1]) =&gt; {
  SharedStructType.registerPrototype(mainVector2DType, Vector2D.prototype);
  assert(mainVector2DType !== vector2DType);
  assert(
    SharedStructType.getConstructor(mainVector2DType) !==
      SharedStructType.getConstructor(vector2Dtype)
  );
  assert(v1 instanceof Vector2D); // by virtue of sharing a prototype
  v1.x; // 1
  v1.distanceTo(v2); // ok
  v1.toString(); // ok
});

</code></pre>
<p>SharedStructType.getConstructor() is needed to allow the program to avoid duplicating type definitions in each agent/realm. I think the burden of such deduplication should be on the program, not on the engine.</p>
<p>If the engine had to deduplicate itself, you'd either need a user provided type identifier at "prepare" time, and a global lock around such type definitions, or you'd need to somehow be able to collapse separate definitions into a single one. In either case you'd have to figure out what to do if the shape definition does not match, and in the case of definition collapse, how do you communicate the error to the program?</p>
<p>By having the type definition generate the unique type identifier, you avoid all those complications in the engine, at the cost of putting more type hydration burden on the program.</p>
</blockquote></mx-reply><span class="nick-15">rbuckton</span>: this</td></tr>
  <tr class="msg" id="L205"><td class="ts-cell"><a class="ts" href="#L205" alt="Wed Apr 26 2023 16:35:19 GMT-0700 (Pacific Daylight Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That doesn't clarify things for me. Are you saying the "handle" is the thing produced by <code>.prepare</code>? I don't think that works without a user-defined type identifier (which you call out yourself), so the handle is meaningless on its own.</td></tr>
  <tr class="msg" id="L206"><td class="ts-cell"><a class="ts" href="#L206" alt="Wed Apr 26 2023 16:36:09 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Yes the handle is what I called the type in that example.</td></tr>
  <tr class="msg" id="L207"><td class="ts-cell"><a class="ts" href="#L207" alt="Wed Apr 26 2023 16:36:41 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I need to break for the day and make dinner. I'll come back to this tomorrow</td></tr>
  <tr class="msg" id="L208"><td class="ts-cell"><a class="ts" href="#L208" alt="Wed Apr 26 2023 16:46:49 GMT-0700 (Pacific Daylight Time)">23:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><p>And the prepare minting the handle is sufficient if you have <code>workerData</code> and <code>preload</code>:</p>
<ul>
<li>Main thread initially defines the struct using <code>prepare</code>, and defines it's local behavior (registers its local prototype)</li>
<li>When creating a worker, the main thread puts the struct handle in workerData, like <code>{ handles: { foo: fooHandle } }</code></li>
<li>The preload code in the worker looks up the <code>handles</code> in the <code>workerData</code> and defines the its local behavior. It's app specific init behavior dealing with an app specific <code>workerData</code> structure.</li>
<li>Until registered a struct's prototype is null, and can throw with an explicit message if accessed.</li>
<li>You can always postMessage a struct handle at any point, and a realm can update the prototype for that struct kind using its handle</li>
<li>For frozen by construction structs, you can only register the prototype if no structs of that kind has been seen by the local realm</li>
</ul>
</td></tr>
  <tr class="msg" id="L209"><td class="ts-cell"><a class="ts" href="#L209" alt="Wed Apr 26 2023 16:50:20 GMT-0700 (Pacific Daylight Time)">23:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You're still using a string key (here <code>"foo"</code>) to communicate. Otherwise the worker doesn't know one handle from another, so the handle itself isn't meaningful</td></tr>
  <tr class="msg" id="L210"><td class="ts-cell"><a class="ts" href="#L210" alt="Wed Apr 26 2023 16:51:26 GMT-0700 (Pacific Daylight Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">At least, not if the key is encoded into the struct value itself (like with my decorator-based example above).</td></tr>
  <tr class="msg" id="L211"><td class="ts-cell"><a class="ts" href="#L211" alt="Wed Apr 26 2023 16:53:02 GMT-0700 (Pacific Daylight Time)">23:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That design also seems to imply you can do <code>{ handles: { foo: fooHandle, bar: fooHandle } }</code>, but the same struct type can't really be used twice.</td></tr>
  <tr class="msg" id="L212"><td class="ts-cell"><a class="ts" href="#L212" alt="Wed Apr 26 2023 16:55:49 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It also requires coordinating a struct type with an identity where you create the worker, which could happen in more than one place in your code, which increases the likelihood of a mistranscription. If the identity is defined on the struct type at the struct declaration site, then it only needs to be written once per thread, and maybe even once for the whole program if importing the same file in multiple threads</td></tr>
  <tr class="msg" id="L213"><td class="ts-cell"><a class="ts" href="#L213" alt="Wed Apr 26 2023 16:55:55 GMT-0700 (Pacific Daylight Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">yes but the string key is only in app logic, it's not part of the shared struct API</td></tr>
  <tr class="msg" id="L214"><td class="ts-cell"><a class="ts" href="#L214" alt="Wed Apr 26 2023 16:56:30 GMT-0700 (Pacific Daylight Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That just increases the potential for mistakes</td></tr>
  <tr class="msg" id="L215"><td class="ts-cell"><a class="ts" href="#L215" alt="Wed Apr 26 2023 16:56:37 GMT-0700 (Pacific Daylight Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">my concern is with enshrining a forgeable key in a built-in registry</td></tr>
  <tr class="msg" id="L216"><td class="ts-cell"><a class="ts" href="#L216" alt="Wed Apr 26 2023 16:57:58 GMT-0700 (Pacific Daylight Time)">23:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I don't see how it creates more potential for mistakes. it just moves the knowledge of string identifiers to the application layer</td></tr>
  <tr class="msg" id="L217"><td class="ts-cell"><a class="ts" href="#L217" alt="Wed Apr 26 2023 16:58:35 GMT-0700 (Pacific Daylight Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">and it makes it possible to define new behavior after init the same way behavior during init is defined</td></tr>
  <tr class="msg" id="L218"><td class="ts-cell"><a class="ts" href="#L218" alt="Wed Apr 26 2023 16:59:29 GMT-0700 (Pacific Daylight Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don't see how it creates more potential for mistakes. it just moves the knowledge of string identifiers to the application layer</blockquote></mx-reply>This makes it hard for multiple packages to share a common shared struct definition without that common definition also enshrininf the key as an exported <code>const</code> or some such.</td></tr>

</tbody></table></div></div></div>
</body></html>