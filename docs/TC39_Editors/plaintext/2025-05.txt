2025-05-05
[09:27:28.0475] <shu>
Michael Ficarra: bakkot i've invited NicoloÌ€ to some future editor call to brainstorm ideas to make the module machinery editorially easier to understand

[09:28:00.0269] <bakkot>
great

[09:28:34.0510] <Michael Ficarra>
awesome

[14:05:29.0312] <Michael Ficarra>
new editorial convention just dropped:
> do not use determiners or pronouns to refer to values from other steps (e.g. "that number"); instead uses aliases or repetition

[14:19:38.0811] <shu>
who said that

[14:20:02.0518] <shu>
what's wrong with "that number"

[14:32:29.0397] <Michael Ficarra>
you should assign it to an alias and refer to the alias instead of hand-waving at things from earlier steps

[14:33:15.0015] <Michael Ficarra>
the context of this was a PR that referred to a Unicode data file in one step and then hand-waved a reference to "that line" from the file in the next step

[14:33:55.0440] <Michael Ficarra>
also added:
> assertion steps should not be necessary to understand an algorithm; a reader should interpret it the same if they are removed

[14:34:10.0847] <Michael Ficarra>
inspired by the same line, since the "prior step" there was actually an assertion step

[14:34:16.0638] <shu>
sometimes it is clear from context, sometimes it is not

[14:34:56.0765] <Michael Ficarra>
I can drop the convention for now or leave it in until we can discuss at editor call

[14:35:05.0432] <Michael Ficarra>
I added it because I thought it would be uncontroversial

[14:38:38.0739] <Michael Ficarra>
I would also like to add another one:
> do not include unnecessary demonstrative determiners (`the String _v_` when `v` is already a String) or use demonstrative determiners as a hand-wavey way to perform a conversion

[14:40:21.0542] <Michael Ficarra>
@shuyuguo:matrix.org here was the specific line btw: https://github.com/tc39/ecma262/pull/3587/files/37ad780a824f42495276961ee32bcc2ce6c3241b#diff-181371b08d71216599b0acccbaabd03c306da6de142ea6275c2135810999805aR38582

[15:55:28.0424] <bakkot>
I don't have a problem with "that number"; it's fine when it's clear and when not clear the problem is that it is not clear

[15:56:38.0104] <bakkot>
I also don't have a problem with `the String _v_` unless it's obvious from context that `_v_` is a string

[15:57:25.0558] <bakkot>
I agree with the assert one

[16:02:15.0240] <Michael Ficarra>
this one I think we should talk about more in editor call

[16:04:09.0041] <Michael Ficarra>
is a return value of an AO whose return type is declared obvious? is a value retrieved from a call of an AO whose return type is declared obvious?

[16:05:35.0076] <bakkot>
I mean, sometimes?

[16:05:55.0221] <bakkot>
we cannot codify "be clear" as a specific set of rules around which words to use when

[16:06:51.0789] <bakkot>
we are not going to come up with a set of rules that can tell you exactly how to write each step and we shouldn't try

[16:06:56.0958] <bakkot>
it's prose

[16:11:44.0476] <jmdyck>
If someone is inclined to use `the String _v_`, they should consider `Assert: _v_ is a String` instead.

[16:13:37.0912] <jmdyck>
(i.e., if the point is to reassure the reader about what `_v_` is)


2025-05-07
[09:04:59.0827] <Michael Ficarra>
https://github.com/tc39/ecma262/issues/3588 is more evidence that the note at the bottom of that section is not sufficient

[09:05:15.0160] <Michael Ficarra>
we really need like an alternative styling or a note right next to any production that is modified in Annex B

[15:43:45.0861] <Michael Ficarra>
how about
> don't use demonstrative determiners as type assertions (`the String _v_` when `v` is already a `String`) when an assertion step can be used instead

[16:02:21.0382] <bakkot>
sgtm


2025-05-08
[17:23:18.0230] <Michael Ficarra>
neither the IEEE style guide nor the Microsoft Manual of Style say anything about pronouns/repetition so I guess I won't pursue that convention anymore

[17:23:29.0651] <Michael Ficarra>
I still don't think we'll ever actually permit a step like that though

[18:11:19.0748] <shu>
sorry, like "that"?

[18:43:14.0374] <Michael Ficarra>
yeah, a step that uses "that" to refer to something from a previous step instead of an alias

[18:46:07.0712] <Michael Ficarra>
also, I think you guys are taking the conventions a little too seriously

[18:46:20.0078] <Michael Ficarra>
they're just conventions, they don't bind us, just guide us

[18:47:05.0139] <Michael Ficarra>
if something is going to be a helpful guide 99% of the time, it's still a useful convention to document, and we should happily violate it whenever we feel justified

[18:49:17.0135] <Michael Ficarra>
also remember that we're going to pretty much follow these instinctively, the more important audience for the conventions is proposal authors


2025-05-11
[21:21:03.0471] <Michael Ficarra>
GeneratorStart (https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-generatorstart) invokes `generatorBody` which may be an Abstract Closure that uses the `?` macro, but it doesn't wrap it in `Completion()`

[21:21:05.0497] <Michael Ficarra>
it should, right?

[21:21:08.0547] <Michael Ficarra>
@bakkot:matrix.org

[22:15:42.0269] <bakkot>
yeah, I guess

[22:16:02.0843] <bakkot>
strictly speaking the rule about wrapping things in completions only applies to AOs, I think, but it makes sense to do it for ACs as well

[05:22:49.0496] <Michael Ficarra>
should we treat all AC call sites as if the AC returns a completion record?

[05:23:06.0429] <Michael Ficarra>
I'm thinking specifically about using prefix `!`

[05:24:50.0655] <Michael Ficarra>
I think we either need to do that or annotate their return type (and include that when describing an AC-typed parameter)

[07:23:06.0947] <bakkot>
there are not that many ACs

[07:23:23.0740] <bakkot>
especially if you ignore those passed to CreateBuiltInFunction

[07:23:46.0794] <bakkot>
I definitely do not want to treat them all as returning completions; I don't see any reason to do that


2025-05-14
[08:09:56.0531] <bakkot>
https://github.com/tc39/proposal-idl/issues/7

[09:27:07.0572] <Michael Ficarra>
wow that seems *really* messy

[09:27:20.0455] <Michael Ficarra>
exceptions on top of exceptions

[09:27:40.0867] <Michael Ficarra>
when so many things have a special 1-off attribute, is it really helpful?

[09:55:18.0771] <bakkot>
I'm thinking there might be a middle ground, because most of the 1-off things are things we don't really want to do in the future

[09:55:34.0395] <bakkot>
so possibly we could just enumerate those ones and then do the rest with IDL

[10:37:34.0319] <shu>
that doc has 78 pages

[10:37:37.0925] <shu>
i'm not reading that

[10:40:53.0392] <shu>
i'd like someone to exec summary that for me

[10:41:23.0528] <bakkot>
the issue has descriptions of the parts which are most important

[10:51:22.0423] <shu>
that helps, thanks

[10:51:27.0786] <shu>
i'm a little skeptical of the "shared infra" parts

[10:51:38.0809] <shu>
you'd need to write a different bindgen for JS builtins

[15:37:01.0382] <bakkot>
looks like hte IPR check is broken again

[15:38:22.0686] <bakkot>
ah, I think because ron used his work email previously and that is no longer associated with his account

[15:38:29.0847] <bakkot>
we really gotta update the check to only apply to _new_ commits

[16:02:05.0760] <ljharb>
yes, that's right. i pinged ron to re-add it to his github account.

[16:05:38.0124] <ljharb>
i added a commit that marks his spec commits as exceptions, so nothing's blocked

[16:06:07.0718] <Michael Ficarra>
he probably can't re-add it if he doesn't have access to that email account anymore

[16:06:38.0178] <ljharb>
i think you still can add it, you just can't verify it

[16:06:57.0093] <ljharb>
(but this is yet another reminder of why work emails should never be used as the primary address for open source work)

[16:07:55.0452] <Michael Ficarra>
lmao

[16:42:47.0229] <Michael Ficarra>
hmm in some of the ACs that get passed to GeneratorStart, we return `ReturnCompletion(*undefined*)`, but we can also return `NormalCompletion(~unused~)` for the same behaviour

[16:43:07.0689] <Michael Ficarra>
is there a reason we would use a `ReturnCompletion` when the value is `*undefined*`?

[16:43:22.0857] <Michael Ficarra>
it seems like we should only use it when the value *isn't* `*undefined*`


2025-05-15
[17:14:47.0887] <bakkot>
didn't we talk about this at some length?

[17:16:04.0738] <bakkot>
returning NormalCompletion is basically saying this is the "fall off the end of the function body without hitting a return" case

[17:16:17.0647] <bakkot>
returning ReturnCompletion is basically ending with an explicit `return`

[17:16:24.0915] <bakkot>
the latter is clearer

[17:17:37.0613] <bakkot>
the only reason we even support the NormalCompletion case in the machinery is to deal with implicit returns in syntactic generators, so it's weird to rely on it for non-syntactic generators which do not have implicit returns

[17:18:27.0752] <jmdyck>
3457 changed one `ReturnCompletion(*undefined*)` to `NormalCompletion(~unused~)`

[17:19:19.0297] <bakkot>
that's not inside of an AC though

[17:21:07.0798] <bakkot>
I guess it is fair to say that we could have built-in generators match non-generators by never returning a return completion

[17:21:42.0696] <bakkot>
but the machinery which consumes those completions is pretty different so I'm not sure that symmetry makes sense

[17:24:47.0166] <bakkot>
in particular, the machinery which consumes completions for built-in functions (https://tc39.es/ecma262/multipage/ordinary-and-exotic-objects-behaviours.html#sec-built-in-function-objects-call-thisargument-argumentslist) is not the same as the machinery which consumes completions for ES functions (https://tc39.es/ecma262/multipage/ordinary-and-exotic-objects-behaviours.html#sec-ecmascript-function-objects-call-thisargument-argumentslist), whereas for generators it's the same machinery in either case (https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-generatorstart)

[17:40:17.0109] <Michael Ficarra>
alright, well leave your opinion on the PR then

[17:40:34.0964] <Michael Ficarra>
I've opened a few PRs related to completion records and ACs as discussed at editor call: https://github.com/tc39/ecma262/pulls?q=sort%3Aupdated-desc+is%3Apr+is%3Aopen+author%3Amichaelficarra

[17:54:34.0291] <bakkot>
hm so I think some of the generator stuff might be broken actually

[17:55:34.0470] <bakkot>
ah, wait, nevermind it's fine, just kind of weird

[17:56:03.0638] <bakkot>
GeneratorStart does Evaluation of a FunctionBody parse node, which I was thinking should be https://tc39.es/ecma262/multipage/ecmascript-language-functions-and-classes.html#sec-runtime-semantics-evaluatefunctionbody but it's actually not

[17:57:25.0695] <bakkot>
it just falls through to Evaluation of the FunctionStatementList

[17:57:33.0770] <bakkot>
which is also how EvaluateFunctionBody works: https://tc39.es/ecma262/multipage/ecmascript-language-functions-and-classes.html#sec-runtime-semantics-evaluatefunctionbody

[18:10:36.0261] <bakkot>
ok, so, we have four kinds of function: ordinary/async/generator/async+generator

[18:10:49.0147] <bakkot>
for each of these, we have to handle throw completions, return completions, and normal completions

[18:20:28.0122] <bakkot>
right now, evaluating any of them produces either a throw completion or a return completion.

for ordinary functions this is handled by translating normal completions to `ReturnCompletion(*undefined*)` in EvaluateFunctionBody: https://tc39.es/ecma262/multipage/ecmascript-language-functions-and-classes.html#sec-runtime-semantics-evaluatefunctionbody

the others explicitly return a return completion holding the promise (for async functions) or generator object (otherwise).

Then [[Call]] handles the two cases (throw completion and return completion) explicitly https://tc39.es/ecma262/multipage/ordinary-and-exotic-objects-behaviours.html#sec-ecmascript-function-objects-call-thisargument-argumentslist.

I am tempted to say that instead EvaluateFunctionBody should translate return completions into normal completions, so that evaluating the other bodies can return a normal completion. this is what the async generator machinery does, in AsyncGeneratorStart step 4.i https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-asyncgeneratorstart

[18:21:04.0242] <Michael Ficarra>
@bakkot:matrix.org here's your answer to the desired semantics for compound assignment https://github.com/tc39/test262/pull/4459/files#diff-02f5df894e79077a1cab224a19f7489864719a2fcf3e821674c4eaa06a099159

[18:21:25.0663] <bakkot>
nice

