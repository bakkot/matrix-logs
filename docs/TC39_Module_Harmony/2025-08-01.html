<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <title>TC39 Module Harmony on 2025-08-01</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Module Harmony";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Module Harmony<br>2025-08-01<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2025-07-31" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Module Harmony">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Aug 01 2025 11:18:10 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell"><p>At plenary <span class="nick-2">bakkot</span> expressed dispreference for ModuleSource carrying a non-transferrable importHook. We pretty fully explored and I’ve shelved a design wit ha separate Module constructor, which I’m open to reexamining, but have come to appreciate primacy of ModuleSource as the target of dynamic import, avoiding a need for an <code>import module</code> and <code>import.module</code> to designate a module instance without forcing evaluation, and other questions like whether module expressions produce Module or ModuleSource instances.</p>
<p>It occurs to me that we’ve already stepped away from having a per-module-instance module-map, just a module-map on <code>new Global</code>. I think that means that the only reason to prefer <code>importHook</code> on <code>Module</code> or <code>ModuleSource</code> is that resolution of import specifiers to full specifiers in the scope of the global module map. So, I am open to revisiting the idea of constructing a <code>ModuleSource</code> with some kind of transferable data bag that could express the base specifier.</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Aug 01 2025 11:21:05 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">I don’t think I’ve fully realized how far we’ve strayed from Caridy’s model, with per-module-instance module-map just with the concessions for ESM source phase imports. Agoric’s and the Endo project’s objectives are not hindered by this at all, but I need to adjust my mental model for the ramifications of transferrable <code>ModuleSource</code> identity for purposes of global module map keys.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Aug 01 2025 11:21:44 GMT-0700 (Pacific Daylight Time)">18:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I didn't really get into this, but another way to address this is to make the import hook or other remapping mechanism something which is provided at import time, rather than being ambient data carried by the ModuleSource itself</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Aug 01 2025 11:32:54 GMT-0700 (Pacific Daylight Time)">18:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><p>though also, don't these have to be per-module-graph anyway? because of:</p>
<ul>
<li>using the mapping { 'C' -&gt; 'X' }, module 'A' imports 'B', which imports 'C'. 'B' now exists in the module graph and references objects from 'X'.</li>
<li>later, using the mapping { 'C' -&gt; 'Y' }, someone else in the same module graph imports 'B'. presumably this gets the existing 'B' instance (that's what "in the same module graph" means). but then they get a confusing result, because 'B' has already been instantiated with a reference to 'X', whereas they're presumably expecting it to reference 'Y'.</li>
</ul>
<p>import maps are global for this reason. they can be updated but updates which would conflict with things observed by previous modules are forbidden.</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Aug 01 2025 11:38:09 GMT-0700 (Pacific Daylight Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Threading the referrer through dynamic <code>import</code> is interesting and I’ll have to think through that more, in particular for the case of importing a ModuleSource instance. I will have to think through the ramifications of that and whether it covers all the cases. The <code>importHook</code> would be obligated to always return something obtained from <code>import</code> or <code>import.source</code>, and that might be funny for <code>import.source(new ModuleSource(), { type, referrer/url/whatever })</code>.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Aug 01 2025 11:39:10 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">But yes, my intuition is that this might cover all the motivating cases.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Aug 01 2025 11:41:14 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">And the confusion you mention above, I believe, is adequately addressed by <span class="nick-2">guybedford</span>’s work in the ESM source phase proposal, where importing a ModuleSource uses a different keyspace than importing by specifier. At the first approximation, these are keyed by the identity of the instance, but that identity is transferrable through postMessage and structuredClone, so at a second approximation, they’re keyed by a transmissible unique identifier among agents of an agent cluster.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Aug 01 2025 11:41:46 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">An <code>importHook</code> is thereby in a position to say “for this module specifier, this is the corresponding module source identity” as a sort of alias.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Aug 01 2025 11:44:16 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell"><p>Consider:</p>
<pre><code>importHook(importSpecifier, { type, fullSpecifier }) {
  return import.source(new ModuleSource(''), {
    type,
    fullSpecifier: resolve(importSpecifier, fullSpecifier),
   });
 }
</code></pre>
</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Aug 01 2025 12:29:07 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Hm, I'm still not understanding. Does the import hook govern only the imports from the module itself, or also its transitive imports? I was assuming the latter but if it's the former then I understand how it could work.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Aug 01 2025 12:37:58 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">I believe the former. For the thought experiment, I’m assuming that there is a per-Global importHook that gets called to populate the module map for every <code>import</code> for a fully-qualified specifier <strong>string</strong> (importing by ModuleSource instances bypass the importHook and get injected by virtue of their own identity.)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Aug 01 2025 13:29:32 GMT-0700 (Pacific Daylight Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Gotcha, ok. The utility of an import hook which doesn't handle transitive imports is not obvious to me - indeed it seems somewhat suspicious, since then an otherwise transparent refactoring where you move things out of the entrypoint into another file which gets imported from the entrypoint is suddenly a breaking change.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Aug 01 2025 13:32:16 GMT-0700 (Pacific Daylight Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">I don’t follow. The importHook gets consulted for transitive imports of any module imported by its specifier string. It’s only not consulted when given a ModuleSource.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Aug 01 2025 13:33:40 GMT-0700 (Pacific Daylight Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">So, it’s this particular virtue that makes it possible to employ your recommendation of binding the referrer specifier to a ModuleSource when invoking dynamic import.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Aug 01 2025 13:35:13 GMT-0700 (Pacific Daylight Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">With the <code>importHook</code> I proposed above, that gets configured by <code>new Global({ importHook })</code> such that <code>newGlobal.import(specifier)</code> would bounce once for each of the transitive dependencies of <code>specifier</code>.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Aug 01 2025 13:37:34 GMT-0700 (Pacific Daylight Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Each individual response from the <code>importHook</code> is necessarily the result of dynamic <code>import</code>  or <code>import.source</code>. Returning a namespace adopts that instance into the new global’s module map, and so exits the new global’s module graph to the host’s module graph. Returning a module source binds the specifier to a new module instance in the new global’s module map, and induces the <code>importHook</code> for all its shallow imports.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Aug 01 2025 14:19:48 GMT-0700 (Pacific Daylight Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><p>OK, I think I was missing the bit about returning namespaces vs returning imports. Though it seems fraught to return a namespace without first having analyzed its transitive dependencies.</p>
<p>A concrete problem: suppose I have a module graph where I wish to mock <code>node:fs</code>. I'm going to mock it two different ways on different occasions. Anything in the graph which transitively imports <code>node:fs</code> must therefore not be shared when doing the first import vs the second import. But anything which does not transitively import <code>node:fs</code> should be re-used, so as to avoid identity discontinuities and so on.</p>
<p>Is it possible to accomplish this without manually constructing my own complete view of the module graph in userland?</p>
</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Aug 01 2025 15:43:34 GMT-0700 (Pacific Daylight Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">You have definitely identified a shortcoming, though I don’t think it’s reducible. There is a potential to configure an <code>importHook</code> such that it admits a module instance from the host but does not graft the host module’s transitive dependencies, such that the host and guest have discontinuous identities. But, it’s also entirely possible to configure an <code>importHook</code> without that defect, and though it’s a footgun on one hand, it’s a feature on the other. In some cases, we will want to avoid sharing mutable instances between the host and guest.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Aug 01 2025 15:48:55 GMT-0700 (Pacific Daylight Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I think this comes up as a consequence of trying to have the full dynamism of <code>importHook</code>, instead of matching the existing web platform mechanism of an import map. With an import map, the host can compute a mapping from module -&gt; { set of resolved imports }, such that if you import a module on two occasions (potentially with different import maps) the host can determine whether that (module, resolved imports for that module) pair has already been imported and provide it.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Aug 01 2025 15:49:40 GMT-0700 (Pacific Daylight Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">That, I think is a shortcoming of importmaps that we will want to avoid.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Aug 01 2025 15:50:42 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">I grok that it’s a footgun on the one hand. But, being able to deliberately isolate instances is an intentional consequence of this design that we would have to shore up for importmap, and then also deal with our desire to, for example, load from a zip file, a database, or just not places keyed by URL.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Aug 01 2025 15:50:45 GMT-0700 (Pacific Daylight Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Hm. In what way is that a shortcoming? Generally speaking, users expect that importing the same module twice should result in only a single evaluation.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Aug 01 2025 15:51:01 GMT-0700 (Pacific Daylight Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">If you want to hook some dependencies so they differ, that's fine, but it's extremely weird for that to affect unrelated things.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Aug 01 2025 15:51:49 GMT-0700 (Pacific Daylight Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">To be clear, I'm imagining an extension of import maps which allow not just specifier -&gt; URL but also specifier -&gt; ModuleSource (or some other representation)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Aug 01 2025 15:52:06 GMT-0700 (Pacific Daylight Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">so you'd still be able to load from places not keyed by URL just fine</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Aug 01 2025 15:52:18 GMT-0700 (Pacific Daylight Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">We very intentionally wish to be able to intercept all imports so that we can prevent a guest from reaching for capabilities of the host.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Aug 01 2025 15:53:02 GMT-0700 (Pacific Daylight Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I see, that's fair.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Aug 01 2025 15:53:18 GMT-0700 (Pacific Daylight Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">That’s fair too. I’ll try to internalize this idea.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Aug 01 2025 15:54:12 GMT-0700 (Pacific Daylight Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Probably people who have worked on node's import hooks will have more thoughts on this question.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Aug 01 2025 15:54:21 GMT-0700 (Pacific Daylight Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">If we could rely on transitive dependencies to be pure and have no mutable state, I think it would make sense to adopt the transitive dependencies, even if we prevented edges from linking across the host guest gap.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Aug 01 2025 15:55:56 GMT-0700 (Pacific Daylight Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Yes, I think it’s on me to convene a parade of conversations and frequent updates. Your engagement with the topic is much appreciated.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Aug 01 2025 15:57:05 GMT-0700 (Pacific Daylight Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">I think that the key here is that you’re not merely suggesting we lift the serialized form of importmap, but adopt its schema for a living object representation.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Aug 01 2025 15:57:54 GMT-0700 (Pacific Daylight Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Importmaps do a bunch of muxing that is effectively shorthand for what can be expressed in an importHook otherwise.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Aug 01 2025 15:58:24 GMT-0700 (Pacific Daylight Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">And perhaps it might limit a degree of freedom intentionally somehow. I don’t know.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Aug 01 2025 15:59:21 GMT-0700 (Pacific Daylight Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">But I can say that importmap was a muse for me in implementing a compartment mapper, which is a generalization on the idea, but for multiple globals and isolated but cross-linked namespaces.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Aug 01 2025 16:15:00 GMT-0700 (Pacific Daylight Time)">23:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Ok actually this is false when there isn't a single global import map, because dynamic imports mean that mapping cannot be computed up front - you don't know what a module might choose to import later.</td></tr>

</tbody></table></div></div></div>
</body></html>