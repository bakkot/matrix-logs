<!DOCTYPE html><html><head>
  <title>TC39 Module Harmony on 2023-01-10</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Module Harmony";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Module Harmony<br>2023-01-10<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-09" class="nav-link"><span>prev</span></a>
<a href="2023-01-11" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Module Harmony">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jan 09 2023 17:10:49 GMT-0800 (Pacific Standard Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Could anyone summarize the conclusions of this conversation?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jan 09 2023 19:47:09 GMT-0800 (Pacific Standard Time)">03:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Kevin might be convinced that a path from module text to evaluated behavior is permissible if 1. no new loopholes to CSP are introduced (and we agree that this is not a concern) 2. the capability is not too easy to find or use, for example made possibly only through a Compartment importHook that returns <code>{ source }</code> (but presumably not a Module importHook, and with no ModuleSource constructor. We agree that this does not limit expressible behavior.) and 2. motivation more compelling than just Agoric‚Äôs use case can be found. The use cases presented as yet are not sufficiently compelling.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jan 09 2023 19:49:19 GMT-0800 (Pacific Standard Time)">03:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">To that end, I might reach out to the community at large to build a coalition. It seems we need some combination of quantity and quality of use cases that we have not yet presented. I believe these exist and we need testimonials.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jan 09 2023 19:54:37 GMT-0800 (Pacific Standard Time)">03:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">my primary use case is being able to test module-level syntax features, like TLA, without necessarily needing a filesystem to be present. That's already what I use Function for (and potentially AsyncFunction, GeneratorFunction, and AsyncGeneratorFunction as well).</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jan 09 2023 20:01:27 GMT-0800 (Pacific Standard Time)">04:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">ljharb, could you elaborate on what the testing is for? I take it that this is for a polyfill, rather than test262-related (where we could add extra host callbacks)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jan 09 2023 20:02:36 GMT-0800 (Pacific Standard Time)">04:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I take it that the use case has to be something that <span class="nick-2">bakkot</span> can be convinced is important enough (since he questioned that above); maybe context from ljharb could meet that requirement</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jan 09 2023 20:06:50 GMT-0800 (Pacific Standard Time)">04:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">yes, polyfills or environment testing packages - like ‚Äúhas object spread‚Äù or ‚Äúhas top-level await‚Äù</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jan 09 2023 20:07:19 GMT-0800 (Pacific Standard Time)">04:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">or ‚Äúhas Unicode named exports‚Äù, or any new syntax we add to the top level of Modules in the future</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jan 09 2023 20:07:56 GMT-0800 (Pacific Standard Time)">04:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">until we ship a syntax detection mechanism (which we may never do), eval is the only viable alternative.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jan 09 2023 20:12:00 GMT-0800 (Pacific Standard Time)">04:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Could you say more about why ModuleSource helps you do something that you can't do with plain eval?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jan 09 2023 20:17:37 GMT-0800 (Pacific Standard Time)">04:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I‚Äôm also motivated by ljharb‚Äôs use case, but in the interest of demonstrating that I‚Äôve listened to bakkot carefully, I imagine that module blocks + eval are sufficient to that end and would not require ModuleSource(text)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jan 09 2023 20:18:07 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">nope, because i can‚Äôt test for the syntax in an engine that lacks module blocks</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jan 09 2023 20:18:15 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">i need a purely API-based solution</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jan 09 2023 20:18:36 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">module blocks would presumably need to contain valid-in-the-current-engine syntax anyway</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jan 09 2023 20:18:37 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">oh i see what you mean, inside Function, put a module block</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jan 09 2023 20:18:47 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">oh wait yeah</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jan 09 2023 20:19:11 GMT-0800 (Pacific Standard Time)">04:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">yeah that seems adequate for this use case if I understand the use case correctly</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jan 09 2023 20:20:06 GMT-0800 (Pacific Standard Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That‚Äôs not to say I wouldn‚Äôt favor ModuleSource(x) over eval('module {' + x + '})') for that purpose, but we would only need one or the other strictly speaking.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jan 09 2023 20:20:19 GMT-0800 (Pacific Standard Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">Function, to be clear, never eval :-)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jan 09 2023 20:20:28 GMT-0800 (Pacific Standard Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">but yeah, same.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jan 09 2023 20:20:31 GMT-0800 (Pacific Standard Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Yeah, fair.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jan 09 2023 20:20:45 GMT-0800 (Pacific Standard Time)">04:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Never direct-eval, anyway.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jan 09 2023 20:22:18 GMT-0800 (Pacific Standard Time)">04:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">i just avoid it like a bad word, direct or not</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jan 09 2023 20:22:47 GMT-0800 (Pacific Standard Time)">04:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">ljharb</span>: kind of a tangent, but why do you need to feature-test syntax anyway? is it just to decide which polyfill to load or is there some other case it comes up?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jan 09 2023 20:23:03 GMT-0800 (Pacific Standard Time)">04:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">("deciding which polyfill to load" is an important use case, I'm just wondering if there's others I'm missing)</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jan 09 2023 20:23:21 GMT-0800 (Pacific Standard Time)">04:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">i use it constantly in test suites</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jan 09 2023 20:23:42 GMT-0800 (Pacific Standard Time)">04:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">(also even if Function + a module block works for me, i still have the consistency argument that every other way of passing around code-to-be-executed has a constructor)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jan 09 2023 20:23:48 GMT-0800 (Pacific Standard Time)">04:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">We do eval-based syntax testing to discover intrinsics we need to freeze, tame, and trim.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jan 09 2023 20:23:57 GMT-0800 (Pacific Standard Time)">04:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">(In <code>ses</code> shim.)</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jan 09 2023 20:24:39 GMT-0800 (Pacific Standard Time)">04:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I‚Äôm sympathetic to the consistency argument, but it doesn‚Äôt pass the bakkot test.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jan 09 2023 20:25:42 GMT-0800 (Pacific Standard Time)">04:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I feel very strongly that the best proposals triangulate a void implied by two other features, the way Array.from and async imply the existence of Array.fromAsync.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jan 09 2023 20:26:06 GMT-0800 (Pacific Standard Time)">04:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Or the way Array and iterators imply iterator helpers.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jan 09 2023 20:30:20 GMT-0800 (Pacific Standard Time)">04:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">if the only goal was to fill the void left by <code>eval</code> only handling the Script parse goal, the way to fill it would be <code>eval(source, { type: 'module' })</code> or something, which... I mean, I find that instinctively distasteful, but the reason I don't like it is because it's enhancing <code>eval</code>, which is also my objection to all of the other options</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Jan 09 2023 20:30:36 GMT-0800 (Pacific Standard Time)">04:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">it at least has the advantage that it would not be <em>new</em> thing that we would need to tell people not to use</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Jan 09 2023 20:32:30 GMT-0800 (Pacific Standard Time)">04:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">honestly I kind of appreciate the honesty of it - the fundamental question before the committee, do we want to make <code>eval</code>-for-modules? if we would not add <code>eval(source, { type: 'module' })</code> then we probably should not add a constructible <code>ModuleSource</code> either</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Jan 09 2023 21:33:00 GMT-0800 (Pacific Standard Time)">05:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><p>Looks like the solution is to add a new directive for <code>script-src</code> CSP to limit import from dynamically constructed <code>ModuleSource</code> from string.</p>
<p>e.g. <code>script-src: unsafe-module-source</code></p>
</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Jan 09 2023 21:39:16 GMT-0800 (Pacific Standard Time)">05:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell">ü§î Is <code>ModuleSource</code> unforgeable? via <code>(module {}).constructor</code></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Jan 09 2023 21:42:04 GMT-0800 (Pacific Standard Time)">05:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">What do you mean by unforgeable?</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Jan 09 2023 21:44:30 GMT-0800 (Pacific Standard Time)">05:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Looks like the solution is to add a new directive for <code>script-src</code> CSP to limit import from dynamically constructed <code>ModuleSource</code> from string.</p>
<p>e.g. <code>script-src: unsafe-module-source</code></p>
</blockquote></mx-reply>As long as <code>unsafe-module-source</code> is a more specific variant of <code>unsafe-eval</code> (<code>unsafe-eval</code> disables both like it does for <code>wasm-unsafe-eval</code>)</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Jan 09 2023 21:46:12 GMT-0800 (Pacific Standard Time)">05:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Great, this is clear. We can focus on building 1. the strongest reason and 2. the work-arounds other proposals (specifically module binding static analysis) can be recovered in the absence of ModuleSource(text).</blockquote></mx-reply>or make <code>ModuleSource.fromString</code> a thing and make it potional?</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Jan 09 2023 21:53:55 GMT-0800 (Pacific Standard Time)">05:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> And the motivation for parsing bindings is bundle, web archive, or import map generation, in which case, a path to eval is not needed.</blockquote></mx-reply><p>further split <code>ModuleSource</code> into <code>ParsedModule</code> and <code>ImportableModule</code>?</p>
<p><code>ParsedModule</code> can be used for analyze purpose, but cannot be imported.<br><code>ImportableModule</code> constructor accepts <code>ParsedModule</code> or an object that implements Virtual Module Source interface. If there is CSP, it will throw when <code>ParsedModule</code> is constructed from a string (or any other TrustedType limitations).</p>
</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Jan 09 2023 22:05:06 GMT-0800 (Pacific Standard Time)">06:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <a href="https://github.com/guybedford/es-module-lexer">https://github.com/guybedford/es-module-lexer</a></blockquote></mx-reply><p>Every time I want to use es-module-lexer for some fast analyzing it always fails because</p>
<ul>
<li>I want to analyze TypeScript + JSX</li>
<li>I want to analyze import bindings</li>
</ul>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Jan 09 2023 22:09:56 GMT-0800 (Pacific Standard Time)">06:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I assume this is sufficient to accept exactly and only grammatically valid sources. That requires block matching, but not AST generation. The other motivation for a full parse is that <code>eval('module {' + text + '}')</code> is an inevitable work-around for the lack of <code>ModuleSource</code>, which is much worse if text is not constrained to be a valid module source.</blockquote></mx-reply>which definitely seems worse <code>text = '}; run any code; {'</code></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Jan 10 2023 06:24:11 GMT-0800 (Pacific Standard Time)">14:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> ü§î Is <code>ModuleSource</code> unforgeable? via <code>(module {}).constructor</code></blockquote></mx-reply>In the current module blocks proposal, this is <code>Module</code></td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Jan 10 2023 06:25:05 GMT-0800 (Pacific Standard Time)">14:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> nope, because i can‚Äôt test for the syntax in an engine that lacks module blocks</blockquote></mx-reply>I guess this is mostly an issue if there exists any engine that ships constructable Module before module blocks.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Jan 10 2023 06:27:21 GMT-0800 (Pacific Standard Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Every time I want to use es-module-lexer for some fast analyzing it always fails because</p>
<ul>
<li>I want to analyze TypeScript + JSX</li>
<li>I want to analyze import bindings</li>
</ul>
</blockquote></mx-reply>What do you end up doing instead?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Jan 10 2023 09:28:26 GMT-0800 (Pacific Standard Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I guess this is mostly an issue if there exists any engine that ships constructable Module before module blocks.</blockquote></mx-reply>no, it's also an issue for being able to ship syntax-testing code to an engine that doesn't have either one</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Jan 10 2023 09:30:33 GMT-0800 (Pacific Standard Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What do you end up doing instead?</blockquote></mx-reply>Use a full-powered parser (I am familiar with the TypeScript compiler API) which is costly.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Jan 10 2023 10:08:55 GMT-0800 (Pacific Standard Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> which definitely seems worse <code>text = '}; run any code; {'</code></blockquote></mx-reply>It is, but @bakkot makes the case that a lexer with limited parse capabilities, such that it can do the static analysis and balance braces, brackets, and parentheses, is on the order of 1KB, so it‚Äôs at least possible to avoid the code injection hazard. Node.js has such a lexer by <span class="nick-11">guybedford (Guy Bedford)</span> and the performance was okay, though only in WASM.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Jan 10 2023 10:09:54 GMT-0800 (Pacific Standard Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I do think that 1.) performance of native will be unbeatable and 2.) code injection foot-gun do count in favor of ModuleSource, but my understanding is that this is not enough to sway @bakkot.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Jan 10 2023 10:11:00 GMT-0800 (Pacific Standard Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> or make <code>ModuleSource.fromString</code> a thing and make it potional?</blockquote></mx-reply>I agree that this is a viable mitigation. It at least decouples <code>Module</code> from constructible <code>ModuleSource</code>.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Jan 10 2023 10:16:30 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> honestly I kind of appreciate the honesty of it - the fundamental question before the committee, do we want to make <code>eval</code>-for-modules? if we would not add <code>eval(source, { type: 'module' })</code> then we probably should not add a constructible <code>ModuleSource</code> either</blockquote></mx-reply>I hear you that we should slice off a portion of Module Harmony that is explicitly eval-but-modules, but I would not propose <code>eval(source, { type: 'module' })</code> as the vessel for it under any circumstances. Modules are more analogous to the <code>Function</code> constructor form of <code>eval</code> since they are reusable and defer execution, but differ because they can import and export. An <code>eval</code> form would have to answer a lot of questions about top-level await. The form would clearly be unable to export, and a completion value would stand in the way of an exports namespace. I think that the question of whether to support eval-but-modules is a better framing, but <code>ModuleSource</code> is consistent with the prevailing eval aesthetic.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Jan 10 2023 10:17:54 GMT-0800 (Pacific Standard Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That said, I don‚Äôt know whether JSDOM for example would be able to emulate <code>&lt;script type="module"&gt;</code> faithfully using <code>ModuleSource</code>. I don‚Äôt recall whether scripts can export.</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Jan 10 2023 10:20:02 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Inviting <span class="nick-4">domenic (Domenic Denicola)</span> because I had reason to wonder whether JSDOM would be a motivating use case for <code>ModuleSource</code>, such that <code>&lt;script type="module"&gt;</code> could maybe be emulated faithfully on a language feature.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Jan 10 2023 10:20:37 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And also because <span class="nick-4">domenic (Domenic Denicola)</span> should be here anyway. üòä</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Jan 10 2023 11:07:09 GMT-0800 (Pacific Standard Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">i think script type modules <em>can</em> export, but i'm not sure if anything can access them?</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Jan 10 2023 11:07:55 GMT-0800 (Pacific Standard Time)">19:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Yeah, <code>ModuleSource</code> would be sufficient assuming the exports just get black-holed.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Jan 10 2023 11:08:31 GMT-0800 (Pacific Standard Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">there's only one Module parse goal so i'm not sure how you'd have a Module without allowing exports</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Jan 10 2023 11:08:33 GMT-0800 (Pacific Standard Time)">19:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And I don‚Äôt think we should make an eval form that reveals the completion value of a module. I can‚Äôt imagine that being useful.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Jan 10 2023 11:11:47 GMT-0800 (Pacific Standard Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">i mean it could easily be the module namespace object for it, but i agree it's not super useful and best avoided</td></tr>

</tbody></table></div></div></div>
</body></html>