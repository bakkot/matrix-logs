<!DOCTYPE html><html><head>
  <title>TC39 Module Harmony on 2024-04-11</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Module Harmony";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Module Harmony<br>2024-04-11<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-04-08" class="nav-link"><span>prev</span></a>
<a href="2024-04-14" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Module Harmony">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Apr 11 2024 08:03:36 GMT-0700 (Pacific Daylight Time)">15:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> this is a good discussion topic, I'd suggest we bring it up in our next meeting if you'd like to join</blockquote></mx-reply>Nobody's here, after opening the agenda doc I guess I was supposed to have added something to the schedule?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Apr 11 2024 08:06:06 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">That or TC39 is still happening and "next meeting" didn't mean next week üòÑ</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Apr 11 2024 08:09:24 GMT-0700 (Pacific Daylight Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Whips sorry üòÖ</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Apr 11 2024 08:09:48 GMT-0700 (Pacific Daylight Time)">15:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Yes, TC39 is still happening </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Apr 11 2024 08:10:07 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">I rushed out of bed for nothing! üòÑ (oops)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Apr 11 2024 08:10:18 GMT-0700 (Pacific Daylight Time)">15:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">(TC39 meetings tend to all be cancelled during TC39 plenary week)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Apr 11 2024 08:29:15 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">sorry, we'll try to update the calendar for accuracy in the future</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Apr 11 2024 08:29:26 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">No worries.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Apr 11 2024 08:36:08 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Also btw, if you have something to talk about please make sure it's on the agenda! We usually consider meeting to be automatically cancelled if 12 hours before the agenda is empty, so that you don't have to wake up early just to discover that the meeting is cancelled</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Apr 11 2024 08:36:44 GMT-0700 (Pacific Daylight Time)">15:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Oh the agenda says "30 minutes"</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Apr 11 2024 08:37:02 GMT-0700 (Pacific Daylight Time)">15:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I always assumed it was something like "the evening before for the west coast" üòÖ</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Apr 11 2024 09:15:05 GMT-0700 (Pacific Daylight Time)">16:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Yeah. So on one hand, I'd be happy with <code>import.meta.require</code> being re-proposed, especially now that Node has <code>import.meta.dirname</code> and such, but there's the more general solution too!</blockquote></mx-reply>It seems to me what you need that is missing from the spec is the ability to do lazy resolution/more lenient resolution, so that you don't get an error by importing from an id that doesn't resolve</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Apr 11 2024 09:16:17 GMT-0700 (Pacific Daylight Time)">16:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">(Or maybe there can be an error, but one you can catch, though that's not necessarily good for perf)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Apr 11 2024 09:17:23 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">It'd be at the top level, so there's nothing to catch. Technically speaking an import that is allowed to be there but not resolve and not error if not touched is fine, but my impression was that the deferred import proposal still errored on a failed import</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Apr 11 2024 09:17:29 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It seems to me what you need that is missing from the spec is the ability to do lazy resolution/more lenient resolution, so that you don't get an error by importing from an id that doesn't resolve</blockquote></mx-reply>This is a good thread to pull on. browsers are also wondering whether we could let some other types of early errors to come later.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Apr 11 2024 09:17:31 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">so, we'd end up breaking in browsers if we had <code>node:fs</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Apr 11 2024 09:17:57 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Yes, the import defer proposal is deferring evaluation, not resolution</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Apr 11 2024 09:18:31 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">WebAssembly started with eager validation, but later permitted lazy</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Apr 11 2024 09:18:53 GMT-0700 (Pacific Daylight Time)">16:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">But, at some level I think that the abiliy to conditionally require synchronously is a useful construct for some libraries who can't go async, and a sync import now seems like a possible thing without being in CJS</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Apr 11 2024 09:19:39 GMT-0700 (Pacific Daylight Time)">16:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">But it does sound like a generally useful thing to have, for example for modules that want to work on both the browser and server side runtimes, otherwise, everyone just puts everything on the global</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Apr 11 2024 09:21:31 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But it does sound like a generally useful thing to have, for example for modules that want to work on both the browser and server side runtimes, otherwise, everyone just puts everything on the global</blockquote></mx-reply>it's true, this is a sort of missing capability from CJS</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Apr 11 2024 09:21:35 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">CJS require() couples resolution + evaluation in one go. ESM import decouples them. In the use case we are talking about, the conditional part is resolution, which currently in ESM is only possible in dynamic import()</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Apr 11 2024 09:23:50 GMT-0700 (Pacific Daylight Time)">16:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">I guess I don't see those as separate for this use case, since I want the whole thing to be conditional; we precheck and only do this on a "node like" system</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Apr 11 2024 09:25:14 GMT-0700 (Pacific Daylight Time)">16:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">My understanding of the history of ESM is fairly limited, but I think the decoupling in ESM is part of the design (personally, I love it, because that unlocks things like module snapshot and tree shaking, and the coupling in CJS makes me sad). My guess is, making the resolution lazy/conditional/more leinient via syntax is still possible while preserving the decoupling in ESM (I could be too naive, too)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Apr 11 2024 09:27:38 GMT-0700 (Pacific Daylight Time)">16:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jakobjingleheimer:matrix.org">jakobjingleheimer</span>&gt;</div></td><td class="msg-cell">That's my understanding too üôÇ</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Apr 11 2024 09:38:06 GMT-0700 (Pacific Daylight Time)">16:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Or maybe, it doesn't need new syntax, just special, standardized import attributes across the platforms that allow weak imports, like what's described in <a href="https://lea.verou.me/blog/2020/11/the-case-for-weak-dependencies-in-js/">https://lea.verou.me/blog/2020/11/the-case-for-weak-dependencies-in-js/</a>, but also for <code>import</code></td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Apr 11 2024 09:39:19 GMT-0700 (Pacific Daylight Time)">16:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">(With the potential downside of, what happens if you need to support older versions of browsers/runtimes? üòµ‚Äçüí´)</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Apr 11 2024 09:41:38 GMT-0700 (Pacific Daylight Time)">16:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell"><span class="nick-13">jakebailey</span>: Sorry for the meeting confusion. I missed that the meeting was cancelled this week myself, and thought we were on a bi-weekly schedule for some reason!</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Apr 11 2024 09:42:39 GMT-0700 (Pacific Daylight Time)">16:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">import fs from "node:fs" with { weak: true };

// 1. In Node.js or other runtimes with Node.js compat layer, fs is fs,
// also applies to named exports for APIs that are supported.
// 2. In runtimes that don't support it/browsers, fs is undefined..or a symbol? Or something else?
</code></pre>
</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Apr 11 2024 09:46:42 GMT-0700 (Pacific Daylight Time)">16:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">The complexity here was more or less why I was re-proposing <code>import.meta.require</code> / <code>import.meta.importSync</code> or something, a la <code>import.meta.dirname</code> and so on which are Node specific constructs</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Apr 11 2024 09:48:06 GMT-0700 (Pacific Daylight Time)">16:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">With require(ESM), it really felt like we could finally make TypeScript be ESM without breaking the ecosystem, but then I realized that I couldn't without some way to conditionally handle node, so it became self defeating... Without resorting to import conditions anyway, which is where things get super frustrating internally for us</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Apr 11 2024 09:52:14 GMT-0700 (Pacific Daylight Time)">16:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">conditional static imports is definitely something we need. there used to be a proposal but it doesn't seem to even be in the proposals table</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Apr 11 2024 09:53:52 GMT-0700 (Pacific Daylight Time)">16:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jakobjingleheimer:matrix.org">jakobjingleheimer</span>&gt;</div></td><td class="msg-cell">Why?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Apr 11 2024 09:54:59 GMT-0700 (Pacific Daylight Time)">16:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">i'm not sure, i'll have to track that down</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Apr 11 2024 09:55:24 GMT-0700 (Pacific Daylight Time)">16:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jakobjingleheimer:matrix.org">jakobjingleheimer</span>&gt;</div></td><td class="msg-cell">To be clear, i meant why do we need them?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Apr 11 2024 09:56:04 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">There are some more pragmatic pros to <code>import.meta.require</code>, like being (significantly?) faster than <code>import cjs</code> or <code>import builtin</code> on Node.js, or easier to feature detect. Cons are...one more thing on the <code>import.meta</code>? I think some consider that evil?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Apr 11 2024 09:56:12 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> CJS require() couples resolution + evaluation in one go. ESM import decouples them. In the use case we are talking about, the conditional part is resolution, which currently in ESM is only possible in dynamic import()</blockquote></mx-reply>I think it‚Äôs useful to distinguish Node.js loader from abstract CJS loaders (which is a tent with Node.js, bundlers, and others). That makes it clear that the choice to couple resolution and evaluation is a Node.js-specific constraint. CJS and ESM were both designed to cover the web‚Äôs need to resolve specifiers for transitive dependencies before evaluation. CJS doesn‚Äôt even mandate that evaluation ever occur on the stack of require. I could buy the case for an <code><a href="http://import.now">import.now</a></code> in the language (and <code>importNowHook</code> on virtual <code>Module</code> instances)</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Apr 11 2024 09:56:54 GMT-0700 (Pacific Daylight Time)">16:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">ah! well, for one, platform-specific deps - like <code>node:fs</code> for example. you might want to sync-import a polyfill, but only when a feature test fails.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Apr 11 2024 09:57:35 GMT-0700 (Pacific Daylight Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">The Node.js case is interesting historically. Ryan Dahl was reluctant to embrace CommonJS. When I talked to Bryan Cantril about it in 2010, his take was that it didn‚Äôt matter, even though it ran against the ‚Äúeverything async‚Äù grain of the platform, because linking a dynamic library is never going to be async.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Apr 11 2024 09:58:40 GMT-0700 (Pacific Daylight Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">or at least, you need it to be sync the vast majority of the time</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Apr 11 2024 09:59:01 GMT-0700 (Pacific Daylight Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">In the CommonJS mailing list days, there was a great deal of talk about a <code>require.async</code> that would return a promise like dynamic import, but there wasn‚Äôt agreement on the design of promises yet.</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Apr 11 2024 10:00:57 GMT-0700 (Pacific Daylight Time)">17:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">One of the other pressures to make Node.js resolution synchronous was that the CJS loader doesn‚Äôt opportunistically discover the <code>package.json</code> tree, as the ESM does. Embracing the package tree is <em>interesting</em> because resolution can be synchronous if you know every reachable path, and is analogous to having an import-map on the web.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Apr 11 2024 10:02:05 GMT-0700 (Pacific Daylight Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">History aside, I think we should have <code><a href="http://import.now">import.now</a></code>, deferred exports, and with both of these, deferring resolution to conditional use is possible.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Apr 11 2024 10:03:05 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">node's ESM doesn't allow knowing every reachable path tho, because of conditional exports, and because of subpath patterns (unless you include the filesystem and treat it as immutable, in which case CJS provides the exact same property)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Apr 11 2024 10:03:57 GMT-0700 (Pacific Daylight Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">What does <code>opportunistically discover the package.json tree</code>  mean?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Apr 11 2024 10:12:38 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">I think I mis-inferred that changing <code>import.meta.resolve</code> from async to sync on both the web and in node meant that it no longer required sync I/O to answer for all paths.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Apr 11 2024 10:14:17 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">On the web, the import-map makes it possible to answer for all specifiers without I/O. On Node.js, static resolution makes it sync I/O-free most of the time, but yeah, if Node.js <em>doesn‚Äôt</em> locate every package reachable from a module before evaluating a module, it would have to fall through to sync I/O sometimes.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Apr 11 2024 10:14:46 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">And of course the extension search path isn‚Äôt captured in <code>package.json</code> anyway, so yeee.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Apr 11 2024 10:16:48 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@gibson042:matrix.org">Richard Gibson</span>&gt;</div></td><td class="msg-cell"><p>related: <a href="https://github.com/tc39/proposal-import-attributes/issues/153#issuecomment-1981354653">https://github.com/tc39/proposal-import-attributes/issues/153#issuecomment-1981354653</a></p>
<pre><code>// Import config with type "wasm" if possible, otherwise with type "json".
import '//test.local/config' with { type: "wasm" },
       '//test.local/config' with { type: "json" }

// Import an empty module if `0m` is valid syntax, otherwise import a BigDecimal polyfill.
import '/empty.mjs' with { condition: { "validSyntax": "0m" } },
       '/polyfills/BigDecimal.mjs'

// Import CSS if possible, otherwise JS.
import styles from './styles.css' with { type: "css" },
                   './styles.mjs'
</code></pre>
</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Apr 11 2024 10:17:14 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">(follow-up on main thread)</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Apr 11 2024 10:20:23 GMT-0700 (Pacific Daylight Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Not quite sure if I am following but synchronicity of resolution in Node.js is more of an implementation detail that can be changed</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Apr 11 2024 10:21:28 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">For CJS and <code>require(esm)</code> it does synchronous I/O all the way, querying the nearest the package.json until it reaches the root directory</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Apr 11 2024 10:21:50 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">(That's actually faster than the async I/O a full <code>import esm</code> is doing)</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Apr 11 2024 10:22:34 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Yeah, understood on the performance front. That was the grounds for implementing CJS with sync I/O on Node.js.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Apr 11 2024 10:22:45 GMT-0700 (Pacific Daylight Time)">17:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">And the resolution result is also cached, so <code>import.meta.resolve</code> can just throw cache entries in there, or get cached entries</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Apr 11 2024 10:23:03 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">And I was mistaken that Node.js can avoid I/O for sync ESM. I hadn‚Äôt throught through all the cases.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Apr 11 2024 10:23:49 GMT-0700 (Pacific Daylight Time)">17:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">If it's cached, then no I/O. If it isn't, at least some I/O is always needed to discover package.json, especially when people use <code>.js</code> then Node.js need to check <code>type</code> field</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Apr 11 2024 10:24:02 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Right, I‚Äôd hoped (but was mistaken) that the <code>import.meta.resolve</code> memo could be proven to be complete before a module evaluates.</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Apr 11 2024 10:24:06 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">Largely though, isn't this unrelated? Like, node ESM stuff is now off-thread, and "looks" synchronous, but internally can be sync or async however it feels</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Apr 11 2024 10:24:20 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Node.js ESM is not off thread</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Apr 11 2024 10:24:55 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Blocking on off-thread work is synchronous from the JS point-of-view.</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Apr 11 2024 10:24:55 GMT-0700 (Pacific Daylight Time)">17:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@jakebailey:matrix.org">jakebailey</span>&gt;</div></td><td class="msg-cell">Hm, I guess I am misunderstanding about the work that went into making import.meta.resolve synchronous</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Apr 11 2024 10:25:17 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">What makes it synchronous is that it starves progress on the event loop until complete.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Apr 11 2024 10:25:23 GMT-0700 (Pacific Daylight Time)">17:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Only custom loaders are, and we are proposing to add something that allows you to do it in-thread, because the off-thread thing is basically in-thread hooks + worker + block on Atomics.wait</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Apr 11 2024 10:26:40 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Still it's only off thread when you customize the loader. It's in thread if you are not doing that</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Apr 11 2024 10:26:45 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Deadlock enters the chat :|</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Apr 11 2024 10:27:06 GMT-0700 (Pacific Daylight Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Yes, the off thread hooks are suffering from deadlocks, another reason to provide in thread hooks</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Apr 11 2024 10:28:16 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">But then, the default ESM loader without customization is still in the same thread.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Apr 11 2024 10:28:26 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">And no workers etc.</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Apr 11 2024 10:29:33 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">And default ESM loader + future in-thread hooks are also in the same thread. No locks, no worker, not even event loop ticks, everything is synchronous, until you deliberately throw something async in the graph (TLA, network imports, etc.)</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Apr 11 2024 10:32:03 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@jakobjingleheimer:matrix.org">jakobjingleheimer</span>&gt;</div></td><td class="msg-cell">Deadlock is happening in only 1 scenario that we know of, right <span class="nick-15">joyee</span> ?</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Apr 11 2024 10:32:32 GMT-0700 (Pacific Daylight Time)">17:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Currently, yes, but I suspect not being able to control the worker can lead to more</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Apr 11 2024 10:33:34 GMT-0700 (Pacific Daylight Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">And in-thread hooks can allow users to control the worker and work around it</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Apr 11 2024 10:36:23 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-11" title="@kriskowal:aelf.land">kriskowal</span>&gt;</div></td><td class="msg-cell">Would Node.js be in a good position to exploit a <code>ModuleSource</code> constructor that has an internal slot with an immutable representation of a compiled module that can be safely shared, without locking, between threads?</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Apr 11 2024 10:36:31 GMT-0700 (Pacific Daylight Time)">17:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>Hm, I guess I am misunderstanding about the work that went into making import.meta.resolve synchronous</p>
</blockquote>
<p>The ESM loader is currently doing unconditional async resolution for <code>import esm</code> but that is an implementation detail. It can be conditionally async (only when someone does network imports). That'll make <code>import.meta.resolve()</code> a lot more performant too</p>
</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Apr 11 2024 10:37:56 GMT-0700 (Pacific Daylight Time)">17:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">(Which I suspect is part of why <code>require(esm)</code> is 1.2x faster than <code>import esm</code>, even, because <code>require(esm)</code> is doing a fully synchronous resolution)</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Apr 11 2024 10:45:58 GMT-0700 (Pacific Daylight Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">For Node.js at least, which mostly deal with fs I/O, not network, synchronous I/O never shows up in the performance profile of loading any non-trivial app, encoding the UTF8 file content into a V8 string can be like 10x more expensive than I/O</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Apr 11 2024 10:51:30 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>Would Node.js be in a good position to exploit a ModuleSource constructor that has an internal slot with an immutable representation of a compiled module that can be safely shared, without locking, between threads?</p>
</blockquote>
<p>From what I can tell, that looks like an abstraction of source code (+ origin and all?) of source text module. I think that can be useful, but whether it needs to be sharable across threads would only matter to those who customize the ESM loader AND use off-thread hooks. For in-thread cases (default, or using in-thread hooks), it's something Node.js can already internally create (I think that's basically our <code>ModuleWrap</code>, or what's underneath <code>vm.SourceTextModule</code>)</p>
</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Apr 11 2024 11:01:58 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">since we're discussing Node.js here, it's worth mentioning we do want to avoid precluding network imports as being first-class in future though</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Apr 11 2024 11:03:50 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">That can just be conditionally async. You pay for the cost when you actually have network import in the graph. But no need to make everyone slow when there's nothing async in the graph</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Apr 11 2024 11:09:52 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Actually with a cache layer, everything can be synchronous again with the cache even if you have network imports‚Ä¶and you don‚Äôt need to pay for the async overhead if the conditional asynchronicity is enforced</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Apr 11 2024 12:37:01 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jkrems:matrix.org">Jan Olaf Martin</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> For Node.js at least, which mostly deal with fs I/O, not network, synchronous I/O never shows up in the performance profile of loading any non-trivial app, encoding the UTF8 file content into a V8 string can be like 10x more expensive than I/O</blockquote></mx-reply>That may depend on the app. Sync I/O (or maybe rather the amount of stats) is causing seconds of slow down for some of our apps during startup. If I/O wouldn‚Äôt be a bottleneck, I assume bundling wouldn‚Äôt be such a big win in some setups.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Apr 11 2024 12:37:53 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jkrems:matrix.org">Jan Olaf Martin</span>&gt;</div></td><td class="msg-cell">Cold startup times was a major reason why I pushed against the super I/O heavy CommonJS resolution style for ESM in node</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Thu Apr 11 2024 12:39:10 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> That may depend on the app. Sync I/O (or maybe rather the amount of stats) is causing seconds of slow down for some of our apps during startup. If I/O wouldn‚Äôt be a bottleneck, I assume bundling wouldn‚Äôt be such a big win in some setups.</blockquote></mx-reply>I suspect you are talking about fs.read*, not actual syscall</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Thu Apr 11 2024 12:40:19 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Bundling is a win not because it avoids I/O, but because it avoids resolution (computation heavy)</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Thu Apr 11 2024 12:42:20 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">And in Node.js most of the startup time is spent on compilation and‚Ä¶‚Ä¶string encoding (which might mislead people into thinking I/O is slow - it‚Äôs actually the Node.js module loader using the fs API that also does the string encoding üòÖ)</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Thu Apr 11 2024 12:42:26 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jkrems:matrix.org">Jan Olaf Martin</span>&gt;</div></td><td class="msg-cell">From our profiling, it was specifically the stat syscalls. I‚Äôll happily yield that it might be edge cases because we run a lot of things on file systems that are backed by network access and can have cold caches. Adding x2/x3 the amount of disk cache entries that need to be warmed up isn‚Äôt free</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Thu Apr 11 2024 12:44:19 GMT-0700 (Pacific Daylight Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Doing it asynchronously can‚Äôt save you that, either, if the application still needs to wait for those calls to complete to do anything interesting</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Thu Apr 11 2024 12:45:16 GMT-0700 (Pacific Daylight Time)">19:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jkrems:matrix.org">Jan Olaf Martin</span>&gt;</div></td><td class="msg-cell">Doing it async means that the disk cache can be warmed in parallel which makes a huge difference in those scenarios. But I was mostly talking about the I/O cost in general, not specifically about sync vs async I/O.</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Thu Apr 11 2024 12:47:51 GMT-0700 (Pacific Daylight Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">The syscall can still be done in parallel, just in native threads</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Thu Apr 11 2024 12:48:31 GMT-0700 (Pacific Daylight Time)">19:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">But also I am sensing you are talking about CJS loading performance, not ESM in Node.js, because that‚Äôs already parallel</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Thu Apr 11 2024 12:49:20 GMT-0700 (Pacific Daylight Time)">19:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jkrems:matrix.org">Jan Olaf Martin</span>&gt;</div></td><td class="msg-cell">Yes, I‚Äôm talking about what I saw as a ‚Äúlesson learned from CJS‚Äô resolution system‚Äù when we made the ESM decisions</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Thu Apr 11 2024 12:53:22 GMT-0700 (Pacific Daylight Time)">19:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">This is stat call which historically suffer from improper cache misses, so it could still be computation problems</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Thu Apr 11 2024 12:57:27 GMT-0700 (Pacific Daylight Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@qzhang:igalia.com">joyee</span>&gt;</div></td><td class="msg-cell">Unless the graph structure you have invalidates cache in the module loader a lot, which sounds like the case if you are backing them with network access already. Most Node.js applications don‚Äôt do that, though.</td></tr>

</tbody></table></div></div></div>
</body></html>