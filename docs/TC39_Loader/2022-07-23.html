<!DOCTYPE html><html><head>
  <title>TC39 Loader on 2022-07-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Loader";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Loader<br>2022-07-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-07-22" class="nav-link"><span>prev</span></a>
<a href="2022-07-24" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Loader">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Jul 22 2022 17:49:18 GMT-0700 (Pacific Daylight Time)">00:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-9">nicolo-ribaudo</span>: Caridy is working on First-class Modules spec text. It might be good for you to connect.</blockquote></mx-reply><p>Awesome! This week I started refactoring the <code>HostResolveImportedModule</code> and <code>HostImportModuleDynamically</code> host hooks, because I didn't want to go through host-defined behavior when importing module blocks/fragments (until they import external modules).</p>
<p>I now have a single <code>HostLoadImportedModule</code> hook, used both for static and dynamic imports, that "returns" an unlinked Module Record. ECMA-262 takes care of iterating through its dependencies, and it recursively calls <code>HostLoadImportedModule</code> to visit the whole graph (cc <span class="nick-2">guybedford</span>: this matches your intuition in <a href="https://github.com/tc39/proposal-js-module-blocks/pull/65#discussion_r912412376">https://github.com/tc39/proposal-js-module-blocks/pull/65#discussion_r912412376</a> !).</p>
<p>This is my proposed refactor: <a href="https://nicolo-ribaudo.github.io/modules-import-hooks-refactor/">https://nicolo-ribaudo.github.io/modules-import-hooks-refactor/</a><br>If you are curious, this is how the module blocks spec looks like on top of that refactor: <a href="https://nicolo-ribaudo.github.io/modules-import-hooks-refactor/proposals/module-blocks">https://nicolo-ribaudo.github.io/modules-import-hooks-refactor/proposals/module-blocks</a> - the updates to <code>import()</code> are relevant for "layer 0", because they show how to import a "module object".</p>
<p>I believe that the new logic closely resembles the loading logic introduced by "layer 0": we could probably just add a step tocheck to 2.d.ii of InnerModuleLoading that calls a <code>module.[[ImportHook]]</code> function, rather than always delegating to <code>HostLoadImportedModule</code>.</p>
<p>It would probably also help with module reflection: assuming that <code>WebAssembly.Module</code> will be a module source, the proposal could use <code>HostLoadImportedModule(...).[[ModuleSource]]</code> instead of introducing a new <code>HostResolveModuleReflection</code> AO. This would also guarantee that <code>import module x from "x.wasm"</code> and <code>import * as ns from "x.wasm"</code> import the same module, even if they do two different things with it (probably we could guarantee <code>ns === await import(x)</code>).</p>
<p>I would love to hear your thoughts on this ðŸ™‚</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Jul 22 2022 17:53:05 GMT-0700 (Pacific Daylight Time)">00:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Your description matches my intuition.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Jul 22 2022 17:54:20 GMT-0700 (Pacific Daylight Time)">00:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Though, it would be nice if we could always route through module.[[ImportHook]], even when that is just a thunk for HostLoadImportedModule.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Jul 22 2022 17:55:07 GMT-0700 (Pacific Daylight Time)">00:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I reviewed this refactor earlier today and it looks great to me.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Jul 22 2022 17:55:22 GMT-0700 (Pacific Daylight Time)">00:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And I think this generally closes the gap with Caridyâ€™s upcoming changes, which had no reasonable default importHook.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Jul 22 2022 17:58:57 GMT-0700 (Pacific Daylight Time)">00:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">This refactor is great because it makes it clear exactly where importHook is called; it is not too often as currently</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Jul 22 2022 18:00:04 GMT-0700 (Pacific Daylight Time)">01:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">IMO it would make sense to land separately in HTML and JS already, since it is a significant cleanup, or at least put out for review as a separated item</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Jul 22 2022 18:05:29 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Would it be reasonable for HostLoadImportedModule to be the default [[ImportHook]] of a Realm, such that <code>Module</code> instances and module blocks can pick it up from their execution context?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Jul 22 2022 18:05:51 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That should be behaviorally equivalent, I think.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Jul 22 2022 18:06:57 GMT-0700 (Pacific Daylight Time)">01:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Or rather, in the case of the <code>Module</code> constructor, picked up from the ModuleConstructor.[[Context]].[[Realm]].[[ImportHook]]</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Jul 22 2022 18:07:47 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Though, it would be nice if we could always route through module.[[ImportHook]], even when that is just a thunk for HostLoadImportedModule.</blockquote></mx-reply>I thought about that, but it has a problem: I expect that we will always call <code>Promise.resolve</code> on <code>[[ImportHook]]()</code>'s result, because its an user-exposed API. This forces a microtask for every imported module, while the old <code>HostResolveImportedModule</code> allowed everything to be synchronous (the new <code>.LoadRequiredModule</code> always returns a promise, but hosts can implement a sync <code>HostLoadImportedModule</code> and then <code>.LoadRequiredModule</code> always returns an <em>already resolved</em> promise)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Jul 22 2022 18:08:12 GMT-0700 (Pacific Daylight Time)">01:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I see.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Jul 22 2022 18:09:05 GMT-0700 (Pacific Daylight Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I think the ends Iâ€™m looking for could be accomplished another way, thenâ€¦</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Jul 22 2022 18:09:52 GMT-0700 (Pacific Daylight Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I know that Bun (a new experimental JS runtime) allows <code>require()</code> of ESM, and throws if it uses TLA. So there is at least one project that depends on modules loadnig being mostly synchroous (without TLA, <code>.Evaluate()</code> returns an already resolved promise)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Jul 22 2022 18:09:57 GMT-0700 (Pacific Daylight Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That is, for there to be a slot that the HostLoadImportedModule fits into, which a VirtualHostLoadImportedModule would fit in.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Jul 22 2022 18:10:32 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> That is, for there to be a slot that the HostLoadImportedModule fits into, which a VirtualHostLoadImportedModule would fit in.</blockquote></mx-reply>That would work, instead of the user function we would store an abstract closure that wraps the user function</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Jul 22 2022 18:10:38 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Yeah, Iâ€™m familiar with Bun. It makes some similar architectural choices to Endo.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Jul 22 2022 18:11:34 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Or rather is born from similar requirements: All things must bundle.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Jul 22 2022 18:15:54 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Kris Kowal</span> Do you know what's the best way to share my refactor with Caridy? I see that he's not in this room.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Jul 22 2022 20:36:10 GMT-0700 (Pacific Daylight Time)">03:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@jackworks:matrix.org">Jack Works</span>&gt;</div></td><td class="msg-cell"><p>Did a quick scan over the refactor spec:</p>
<ol>
<li><code>ContinueDynamicImport</code> should not try to <code>Link()</code> / <code>Evaluate()</code> multiple times.</li>
<li>Should <code>[[LoadedModules]]</code> be added in Abstract Module Record instead of Cyclic Module Record? A non-cyclic-able module type can also have dependencies.</li>
<li><code>InnerModuleLoading</code> is it a normative change? Say, today loading a module can be unordered (as I can recall)</li>
</ol>
<p>Module block spec:</p>
<ol>
<li>Why disallow import a module block from another realm? (13.3.10.1, step 6.a)</li>
<li>Looks like you're not using the building layers from the compartments? (<code>Module</code> and <code>ModuleSource</code> class)</li>
<li>IIRC we may want to hide the source of a module. Source may not always be available on some platform, like embedding JS engine. (21.6.2.1, step 2.a)</li>
</ol>
</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Jul 22 2022 22:02:20 GMT-0700 (Pacific Daylight Time)">05:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">To review these PRs, understand the ModuleBlock class to stand for Module/ModuleInstance</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Jul 22 2022 22:03:58 GMT-0700 (Pacific Daylight Time)">05:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Since we are talking about instances, they exist just within one module graph and therefore one realm. You can make a different module instance (eg with structured clone) to get something similar but within another module graph</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Jul 22 2022 22:06:10 GMT-0700 (Pacific Daylight Time)">05:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Yes, this change is normative, since it makes all environments follow some of the logic that is currently in HTML. I think this logic is pretty reasonable and makes sense to apply universally but we should be careful to examine the various environments that we have to make sure that is appropriate.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Jul 22 2022 22:07:20 GMT-0700 (Pacific Daylight Time)">05:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">How does ContinueDynamicImport Link/Evaluate the same thing multiple times? I agree that it shouldnâ€™t do that</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Jul 22 2022 22:08:25 GMT-0700 (Pacific Daylight Time)">05:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I agree that the source might not always be visible to JS code. How does that relate to these patches?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Jul 22 2022 22:10:10 GMT-0700 (Pacific Daylight Time)">05:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">About AbstractModuleRecord vs CyclicModuleRecord: currently, the notion of an import/dependency is all in CyclicModuleRecord. We could generalize this but I think it would help to have a driving use case where we donâ€™t want to use CyclicModuleRecord, which I canâ€™t think of. This refactoring seems orthogonal to the current PR.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Sat Jul 23 2022 00:15:00 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span>: great to see! Will review further over the weekend. Did you mean to also include the updates to HostResolveImportedModule calls in InnerModuleLinking and InnerModuleEvaluation? I didn't see those included.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Sat Jul 23 2022 03:45:07 GMT-0700 (Pacific Daylight Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><p>Thanks or the review!</p>
<ol>
<li>Both <code>Link()</code> and <code>Evaluate()</code> are idempotent operations: calling them multiple times has no effect. They are the "public interface" of module records, and we shold use them rather than checking the <code>[[Status]]</code> (which is an "implementation detail" of Cyclic Module Records). It already happens that they are called multiple times:
<ul>
<li>ECMA-262 always calls them for non-cyclic module records, even if they have already been linked/evaluated</li>
<li>HTML always calls them even for all module records imported either with a <code>&lt;script&gt;</code> tag or with dynamic import, even if they have already been linked/evaluated</li>
</ul>
</li>
<li>ECMA-262 never fiddles with the internals of non-cyclic module records, for example the <code>.Link()</code> and <code>.Evaluate()</code> implementations are only given for cyclic module records. From its point of view, that they are terminal nodes of the dependencies graph and they have to handle their own dependencies opaquely. However, it makes sense to move <code>LoadRequestedModules</code> to Abstract Module Record, where we have <code>Link</code> and <code>Evaluate</code>.</li>
<li>Hosts can still load dependencies in the order they want: they can continue pre-fetching them as they currently do, and make <code>HostLoadImportedModule</code> behave just like <code>HostLoadResolvedModule</code>/<code>HostImportModuleDynamically</code> depending on where it's called from. I don't think this refatoring is necessarily normative.</li>
</ol>
<p>Regarding module blocks: yes, the spec still needs to be updated after the harmony discussions in the last week, I only rewrote the current state of the proposal.</p>
</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Sat Jul 23 2022 03:45:26 GMT-0700 (Pacific Daylight Time)">10:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-9">nicolo-ribaudo</span>: great to see! Will review further over the weekend. Did you mean to also include the updates to HostResolveImportedModule calls in InnerModuleLinking and InnerModuleEvaluation? I didn't see those included.</blockquote></mx-reply>There is an editorial note that says "update all the examples of HostResolveImportedModules"</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Sat Jul 23 2022 16:36:54 GMT-0700 (Pacific Daylight Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">Okay, I just would have thought that the InnerModuleLinking logic repeats a lot of the payload logic you have.</td></tr>

</tbody></table></div></div></div>
</body></html>