<!DOCTYPE html><html><head>
  <title>TC39 Loader on 2023-01-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Loader";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Loader<br>2023-01-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-03" class="nav-link"><span>prev</span></a>
<a href="2023-01-10" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Loader">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jan 09 2023 03:43:09 GMT-0800 (Pacific Standard Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">My major open question in response to <span class="nick-2">bakkot</span>'s points at plenary is how this qualifies as a new path to eval - we discussed this at the last loader meeting and came to the conclusion that a <code>ModuleSource</code> constructor was in fact <strong>not</strong> a new path to eval, because the "evalness" of the ModuleSource is done through the existing dynamic import. The constructor itself <strong>does not eval</strong> - eval only happens at import - which is already possible right now.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jan 09 2023 03:44:25 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">I would still like to invite <span class="nick-2">bakkot</span> to a loader meeting so we can discuss this in detail - I am likely missing something, or I am not understanding your concern correctly.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jan 09 2023 07:30:48 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think this is discussed more concretely as we discuss mitigations. Clearly the whole thing (ModuleSource + import()) put together was a path to eval. I guess the question was whether bakkot would accept a mitigation which was, "ModuleSource produces marked things which cannot be passed to import() but otherwise work" (but I'm not so convinced the feature is very useful, and we were discussing this above)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jan 09 2023 08:04:32 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-3">Luca Casonato</span>: as <span class="nick-10">littledan</span> says, ModuleSource + dynamic import is eval, to my view. yes, in some (but not all) hosts it possible to use <code>data</code> URIs with dynamic import already, but a.) that is not widely supported especially given CSP and so is not a reliable way to <code>eval</code> and b.) <code>data</code> URIs are very obviously a kludge, whereas a ModuleSource constructor would be a first-class part of the language, and we should be concerned about making paths to <code>eval</code> more usable, not just whether they exist at all.</p>
<p>also it is not at all clear to me what the use case for ModuleSource is other than <code>eval</code>; the cases discussed about were all either <code>eval</code>-like or a desire from a single library to have a built-in way of parsing out bindings. I think an affirmative case needs to be made for this feature (as with any feature), and to convince me personally that case needs to be something other than "we would like it to be easier to do <code>eval</code>" (or there needs to be an extremely strong reason to make it easier to do <code>eval</code>).</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jan 09 2023 09:39:01 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">&lt;weak-argument&gt;well, it's eval for a module, which is otherwise more or less a missing capability&lt;/weak-argument&gt;</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jan 09 2023 09:39:57 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I would ideally like to find a motivation for this path to eval that does not require others to buy into the SES group‚Äôs long-term motivation to make a safe path to eval, that does not rest on CSP, since I know that is contentious. But, that is personally my motivation. Making an easy path to lift text makes it easier to build a sandbox, and making that part of the language makes it easier to write portable sandboxes. One of the drawbacks of the compartment shim is that we have to censor the words <code>eval</code> and <code>import</code> from source text in order to enforce confinement. There are false positives that a native implementation wouldn‚Äôt suffer from.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jan 09 2023 09:40:42 GMT-0800 (Pacific Standard Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Making it eaiser to make sandboxes has the emergent effect of making sandboxes safer.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jan 09 2023 09:41:11 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And given that the design is compatible with CSP, I feel like this is a win-win.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jan 09 2023 09:41:17 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Kris, I'm glad you're describing your actual use case, as this makes it a lot easier to follow</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jan 09 2023 09:41:21 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">It's quite hard for me to follow a use case argument which centers on the censorship mechanism, since I really don't understand what sorts of restrictions you have in how you evolve that.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jan 09 2023 09:41:45 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">maybe you could give some more details there?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jan 09 2023 09:43:00 GMT-0800 (Pacific Standard Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Yeah, in the SES shim, confinement is enforced at runtime and it‚Äôs a production performance and developer-experience requirement that we not entrain rigorous static analysis or on-the-fly transformations.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jan 09 2023 09:44:28 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The heart of the confinement mechanism points four of JavaScript‚Äôs sharpest edges at each other: We use use direct eval in sloppy mode inside a with block that puts an opaque proxy on the stack.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jan 09 2023 09:44:48 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That‚Äôs‚Ä¶a summary.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jan 09 2023 09:45:11 GMT-0800 (Pacific Standard Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In any case, there are a number of obvious ways to escape lexical containment.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jan 09 2023 09:46:15 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Collectively ‚Äúundeniable intrinsics‚Äù. So, for example, (async()=&gt;{}) gives you access to the async function prototype. That‚Äôs pretty straightforward to confine with the hardening of shared intrinsics.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jan 09 2023 09:47:04 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In the most basic case, {} and [] give you access to shared intrinsics in ways that can‚Äôt be denied with the lexical environment.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jan 09 2023 09:47:59 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Likewise, <code>import</code> escapes confinement. So, we use a careful regex to identify any pattern that <em>might</em> be an invocation of import and refuse to evaluate such programs.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jan 09 2023 09:48:33 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The Evaluators proposal would allow us to hook the behavior of <code>import</code> for confined programs.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jan 09 2023 09:49:44 GMT-0800 (Pacific Standard Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">We also ban direct <code>eval</code> similarly, but not so much because of confinement concerns, but because it is impossible to faithfully emulate the intended behavior in the shim.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jan 09 2023 09:52:00 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In order to support modules, we have no choice but to convert modules into programs at compile time, which is a source-to-source transformation that reduces debuggability. We also eschew source maps because they can be used to confuse auditors.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jan 09 2023 09:53:26 GMT-0800 (Pacific Standard Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">So we have a module-to-program transform, which necessarily generates both the module functor source code and the bindings in a JSON envelope, and a runtime that handles these ‚Äúmodule sources‚Äù reconstructs the linkage from the declared bindings and a sort of calling convention.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jan 09 2023 09:55:19 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The net result is a Zip file that contains JSON enveloped sources which is not as debuggable or reviewable as we‚Äôd like. This is the artifact that must be trusted when you grant capabilities to the guest program, so this is the artifact that gets fingerprinted for integrity checks. It‚Äôs also, notably, not hosted on the web, and modules not hosted on the web are not currently possible to evaluate across all JavaScript hosts.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jan 09 2023 09:56:01 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">There are hacks, but they are hacks, and hacks and confinement are somewhat inimical.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jan 09 2023 09:58:22 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And again, our position is not that we hope to capture all JavaScript in hardened JavaScript. Our position is that it should be possible to get to hardened JavaScript from ordinary mutable implicitly permissive one-big-sandbox JavaScript. We in fact <em>require</em> that as a starting point since anything else would preclude evolution of the host environment over time.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jan 09 2023 10:29:48 GMT-0800 (Pacific Standard Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-2">bakkot</span>: so your concern is not that it is a <strong>new</strong> path to eval, but rather that it may make an existing path to eval more ergonomic?</p>
<p>As for the usecases that can justify an unconstructable <code>ModuleSource</code>:</p>
<ul>
<li>multiple instantiation modules (including module expressions &amp; declarations)</li>
<li>low level <code>script-src: no-eval</code> module passing between workers</li>
<li>manual instantiation and module instrospection (we've seen this in WASM using <code>WebAssembly.Module</code>, for which <code>ModuleSource</code> would be the JS equivalent)</li>
</ul>
</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jan 09 2023 10:34:43 GMT-0800 (Pacific Standard Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">Luca Casonato</span>: it is a new path to eval in many contexts (e.g. anywhere with CSP, and therefore in any library), and also it makes an existing path to eval more ergonomic; both are concerns are important to me</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jan 09 2023 10:35:27 GMT-0800 (Pacific Standard Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I do not think that <span class="nick-2">bakkot</span> objects to the concept of an object that represents a module source, which has intersection semantics relevant to other proposals and does not imply a path to eval. Correct me if I‚Äôm wrong.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jan 09 2023 10:36:09 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">right - none of my <code>eval</code> concerns apply to <code>ModuleSource</code> which does not take a string argument; I am fine with a static import syntax which gives you an object you can clone between workers and so on</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jan 09 2023 10:36:18 GMT-0800 (Pacific Standard Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Oh, <span class="nick-2">bakkot</span> our intention is <em>not</em> to be a new path to eval with CSP. <code>no-unsafe-eval</code> would render a <code>ModuleSource</code> instance lifted from text inert.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jan 09 2023 10:37:39 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> right - none of my <code>eval</code> concerns apply to <code>ModuleSource</code> which does not take a string argument; I am fine with a static import syntax which gives you an object you can clone between workers and so on</blockquote></mx-reply>This is to say we don‚Äôt need to convince <span class="nick-2">bakkot</span> of importing module sources or module blocks with sources, again correct me if I‚Äôm wrong.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jan 09 2023 10:38:30 GMT-0800 (Pacific Standard Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">there are at least some CSPs which allow <code>no-unsafe-eval</code> but do not allow <code>data</code> URIs (primarily because there are libraries with this requirement), so constructible ModuleSource + dynamic import would still constitute a new way to <code>eval</code> in such contexts</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Mon Jan 09 2023 10:38:52 GMT-0800 (Pacific Standard Time)">18:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">By inert I mean that <code>import(new Module(new ModuleSource('')))</code> would unconditionally return a rejected promise under a <code>no-unsafe-eval</code> CSP, and would poison any module that takes it as a transitive dependency as well.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Mon Jan 09 2023 10:39:26 GMT-0800 (Pacific Standard Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Otherwise I would agree that would constitute a new path to eval in situations that should have none.</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Mon Jan 09 2023 10:40:51 GMT-0800 (Pacific Standard Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> there are at least some CSPs which allow <code>no-unsafe-eval</code> but do not allow <code>data</code> URIs (primarily because there are libraries with this requirement), so constructible ModuleSource + dynamic import would still constitute a new way to <code>eval</code> in such contexts</blockquote></mx-reply>Is there a way to better communicate an intention that constructible module sources must not create a new path to eval under any existing CSP that should disallow it?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Mon Jan 09 2023 10:41:57 GMT-0800 (Pacific Standard Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">well, if your CSP allows <code>no-unsafe-eval</code>, then it <em>should</em> allow <code>eval</code>, but I still don't think it is a good idea for the language to provide a new way to <code>eval</code> in that context</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Mon Jan 09 2023 10:42:21 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">and <code>import</code> is <em>not</em> a way to <code>eval</code> in that context, which is good</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Mon Jan 09 2023 10:45:00 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I mean a CSP that disallows use of <code>eval</code>, to be clear.</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Mon Jan 09 2023 10:45:48 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I agree that if we do end up with a constructible <code>ModuleSource</code> it must not be importable in a <code>no-unsafe-eval</code> context; I don't think there was any confusion about that</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Mon Jan 09 2023 10:45:54 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">There‚Äôs a strong possibility I don‚Äôt know CSP well enough to have this conversation. I‚Äôm hoping for instruction.</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Mon Jan 09 2023 10:46:32 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">the relevant fact is that <code>no-unsafe-eval</code> does <em>not</em> restricted use of <code>data:</code> URIs; those are controlled by the use of a <code>data:</code> scheme expression in the CSP</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Mon Jan 09 2023 10:46:59 GMT-0800 (Pacific Standard Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">so it is possible to have CSP in which <code>eval</code> is allowed and <code>data:</code> URIs are not, in which context <code>ModuleSource</code> + dynamic import is unambiguously a new path to eval</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Mon Jan 09 2023 10:47:39 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Is there a way we can frame it such that it would not be?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Mon Jan 09 2023 10:47:53 GMT-0800 (Pacific Standard Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">not that I can think of?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Mon Jan 09 2023 10:48:07 GMT-0800 (Pacific Standard Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">though all this discussion about CSP is all a little bit outside my main objection. I agree that it is <em>technically</em> true that in at least some contexts <code>import</code> can be used for <code>eval</code> because of the existence of <code>data</code> URIs, though it is also even more technically true that this does not not apply in all contexts in which <code>ModuleSource</code> would work (if I understand correctly). however, I don't think this technical point is all that important; even granting it, it seems to me that <code>import</code> + constructible <code>ModuleSource</code> would a new first-class path to <code>eval</code> in a way that <code>import('data:')</code> is not , the latter being kludgey and not universally acceptable or available.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Mon Jan 09 2023 10:49:28 GMT-0800 (Pacific Standard Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That is, how does one describe all CSPs in which <code>import(new Module(new ModuleSource(text)))</code> must fail?</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Mon Jan 09 2023 10:50:18 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Yeah, I‚Äôm not interested in any contexts where <code>import('data:')</code> is a workaround for eval CSP restrictions except insofar as that the proposal should not introduce loopholes in CSP.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Mon Jan 09 2023 10:50:25 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">and while I am not dead-set against having a new <em>or new-ish</em> first-class path to <code>eval</code> I would want it to have a strong justification, which I have not heard yet. whether this is <em>actually</em> new or merely new-ish is not all that important to me - either way I still would want there to be a strong justification.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Mon Jan 09 2023 10:50:40 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I am interested in environment in which there are no such workarounds, ones where import(doesNotEvenTakeURL).</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Mon Jan 09 2023 10:50:58 GMT-0800 (Pacific Standard Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> That is, how does one describe all CSPs in which <code>import(new Module(new ModuleSource(text)))</code> must fail?</blockquote></mx-reply>those which forbid <code>unsafe-eval</code>, I think is an accurate description</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Mon Jan 09 2023 10:51:37 GMT-0800 (Pacific Standard Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">So it is possible that the CSP tangent was entirely us talking past each other. Thanks.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Mon Jan 09 2023 10:52:35 GMT-0800 (Pacific Standard Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">If I read correctly, we‚Äôre generally in agreement that ModuleSource(text) would not introduce a CSP loophole.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Mon Jan 09 2023 10:52:42 GMT-0800 (Pacific Standard Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Mon Jan 09 2023 10:53:37 GMT-0800 (Pacific Standard Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> and while I am not dead-set against having a new <em>or new-ish</em> first-class path to <code>eval</code> I would want it to have a strong justification, which I have not heard yet. whether this is <em>actually</em> new or merely new-ish is not all that important to me - either way I still would want there to be a strong justification.</blockquote></mx-reply>This is my prior understanding and I suggest we focus on articulating a strong justification.</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Mon Jan 09 2023 10:54:27 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">@bakkot You would not happen to have seen the bits about confining JavaScript guests without CSP above before they scrolled away?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Mon Jan 09 2023 10:54:31 GMT-0800 (Pacific Standard Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">(the bit about CSP was just to say that <code>import</code> + <code>data:</code> URIs does not already constitute a path to <code>eval</code> in all contexts - there are CSPs which allow <code>eval</code> but do not allow importing <code>data:</code> URIs, so adding constructible <code>ModuleSource</code> would be in fact granting a path to <code>eval</code> via <code>import</code> which did not previously exist in that context. but as I say this is all kind of a technical point rather than my main objection.)</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Mon Jan 09 2023 10:57:52 GMT-0800 (Pacific Standard Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> @bakkot You would not happen to have seen the bits about confining JavaScript guests without CSP above before they scrolled away?</blockquote></mx-reply>I did read it but am lacking context to understand why your design requires the ability to <code>eval</code> modules from within a module, as opposed to having a compartment or something which would allow you to hook <code>import</code> within that context and provide a module that way</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Mon Jan 09 2023 10:58:54 GMT-0800 (Pacific Standard Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">We certainly need both. The key is that the platform is backed by zipped applications (no URLs and no fetch capability)</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Mon Jan 09 2023 10:59:51 GMT-0800 (Pacific Standard Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Why does the <code>import</code> hook on a compartment (or whatever compartments are called now) not suffice here?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Mon Jan 09 2023 11:00:16 GMT-0800 (Pacific Standard Time)">19:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The import hook returns Module instances with ModuleSources, from text dug out of Zip files.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Mon Jan 09 2023 11:01:12 GMT-0800 (Pacific Standard Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">That's one possible design; certainly there are other designs for <code>import</code> which don't require a constructible <code>ModuleSource</code>, no?</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Mon Jan 09 2023 11:01:56 GMT-0800 (Pacific Standard Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">you could have a <code>defineImport(specifier: string, source: string)</code> capability available to the thing which created the compartment, or something, no?</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Mon Jan 09 2023 11:02:42 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">that would still be eval-like, but I am a lot less concerned about <code>eval</code> which is specifically defined in terms of compartments and which is defined from the outer compartment for use by the inner compartment, as opposed to one which is ambiently available</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Mon Jan 09 2023 11:02:48 GMT-0800 (Pacific Standard Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">(forgive me if I'm using the wrong terminology here)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Mon Jan 09 2023 11:17:43 GMT-0800 (Pacific Standard Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That‚Äôs an interesting clarification.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Mon Jan 09 2023 11:29:57 GMT-0800 (Pacific Standard Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> there are at least some CSPs which allow <code>no-unsafe-eval</code> but do not allow <code>data</code> URIs (primarily because there are libraries with this requirement), so constructible ModuleSource + dynamic import would still constitute a new way to <code>eval</code> in such contexts</blockquote></mx-reply>What CSP actually prevents <code>import("data:...")</code>? A no eval <code>script-src</code> doesn't in Chrome üëÄ (example: <a href="https://dash.deno.com/playground/csptest">https://dash.deno.com/playground/csptest</a>)</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Mon Jan 09 2023 11:33:34 GMT-0800 (Pacific Standard Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">also if i specify <code>default-src 'none'</code> - and same also in FF</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Mon Jan 09 2023 11:34:14 GMT-0800 (Pacific Standard Time)">19:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> that would still be eval-like, but I am a lot less concerned about <code>eval</code> which is specifically defined in terms of compartments and which is defined from the outer compartment for use by the inner compartment, as opposed to one which is ambiently available</blockquote></mx-reply>Yeah, re terminology, by ambiently available, do you mean available by reference? An ocap interpretation of the term ambient would mean that it is registered to the parent host and available to all peers by a forgeable name.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Mon Jan 09 2023 11:48:24 GMT-0800 (Pacific Standard Time)">19:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What CSP actually prevents <code>import("data:...")</code>? A no eval <code>script-src</code> doesn't in Chrome üëÄ (example: <a href="https://dash.deno.com/playground/csptest">https://dash.deno.com/playground/csptest</a>)</blockquote></mx-reply>Oh apparently nonce'd script tags have an implicit `script-src 'strict-dynamic'' behavior for imports - TIL!</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Mon Jan 09 2023 11:48:27 GMT-0800 (Pacific Standard Time)">19:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> What CSP actually prevents <code>import("data:...")</code>? A no eval <code>script-src</code> doesn't in Chrome üëÄ (example: <a href="https://dash.deno.com/playground/csptest">https://dash.deno.com/playground/csptest</a>)</blockquote></mx-reply>nonces are automatically inherited by imports, I think? try <code>unsafe-inline</code> instead of nonces in the CSP</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Mon Jan 09 2023 11:50:03 GMT-0800 (Pacific Standard Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">yup, ok with that I can make a CSP that can do eval, but no <code>import("data:...")</code>: <code>script-src 'unsafe-inline' 'unsafe-eval'</code></td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Mon Jan 09 2023 11:50:41 GMT-0800 (Pacific Standard Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">So your concern is that module source would allow <code>import()</code> to eval with just <code>unsafe-eval</code> specified, whereas right now you need <code>script-src data:</code> or <code>script-src blob:</code>?</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Mon Jan 09 2023 11:50:59 GMT-0800 (Pacific Standard Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Yeah, re terminology, by ambiently available, do you mean available by reference? An ocap interpretation of the term ambient would mean that it is registered to the parent host and available to all peers by a forgeable name.</blockquote></mx-reply>I mean like any library can use this capability to <code>eval</code> in the current context, rather than only being able to do <code>eval</code> inside of a specially-constructed box</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Mon Jan 09 2023 11:52:00 GMT-0800 (Pacific Standard Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So your concern is that module source would allow <code>import()</code> to eval with just <code>unsafe-eval</code> specified, whereas right now you need <code>script-src data:</code> or <code>script-src blob:</code>?</blockquote></mx-reply>well, again, that is a technical point. yes, I am concerned a little bit about that, but the larger concern is that I do not regard <code>data:</code> URIs as being a first-class path to <code>eval</code> built in to the language, for this and other reasons, while <code>ModuleSource</code> would be.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Mon Jan 09 2023 11:52:50 GMT-0800 (Pacific Standard Time)">19:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">i see - thank you for the clarification.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Mon Jan 09 2023 11:56:25 GMT-0800 (Pacific Standard Time)">19:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">For all intents and purposes contexts with dynamic import and data URLs would have a constructable (all be it async) <code>ModuleSource</code> in the form of <code>(await import("data:application/javascript,abc", { reflect: "module" }).source</code> anyway, so for me the lack of an explicit <code>ModuleSource</code> constructor is not the end of the world</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Mon Jan 09 2023 11:57:10 GMT-0800 (Pacific Standard Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">And in these contexts this factory would be subject to CSP - so no new path to eval here (the exact same CSP a direct <code>import("data:...")</code> is subject to today)</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Mon Jan 09 2023 11:57:33 GMT-0800 (Pacific Standard Time)">19:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">So, Module in this proposal is providing exactly as limiting a scope as Compartments, even if Compartments are framed as a registry of source strings. If you‚Äôll forgive a reductio absurdam, <code>const c = new Compartment({ importHook(specifier) { return import(specifier, {reflect: true}) } ); c.registerSource('name', text); c.import('name')</code> is equivalent. The key here is that <code>Module</code> is a box.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Mon Jan 09 2023 11:58:46 GMT-0800 (Pacific Standard Time)">19:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">My hope is that <code>Module</code> is in fact as much a box as the box you like in <code>Compartments</code>! :-)</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Mon Jan 09 2023 12:00:05 GMT-0800 (Pacific Standard Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And <code>Evaluators</code> give us another box, where we can capture the dynamic <code>import</code> behavior for non-modules. Out of these primitives, <code>Compartment</code> can be implemented in user code.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Mon Jan 09 2023 12:00:38 GMT-0800 (Pacific Standard Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And hardened JavaScript can be faithfully implemented in user code, as it cannot with a shim.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Mon Jan 09 2023 12:00:39 GMT-0800 (Pacific Standard Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So, Module in this proposal is providing exactly as limiting a scope as Compartments, even if Compartments are framed as a registry of source strings. If you‚Äôll forgive a reductio absurdam, <code>const c = new Compartment({ importHook(specifier) { return import(specifier, {reflect: true}) } ); c.registerSource('name', text); c.import('name')</code> is equivalent. The key here is that <code>Module</code> is a box.</blockquote></mx-reply>again, I'm concerned not just with <em>whether</em> the thing is possible, but <em>how accessible</em> it is. I agree that some designs for compartments can be bludgeoned into being a current-context <code>eval</code> but that doesn't mean all possible designs are equivalent.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Mon Jan 09 2023 12:02:07 GMT-0800 (Pacific Standard Time)">20:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><code>eval</code> already exists, but we've largely been able to convince people not to use it. I don't want to make a new <code>eval</code> and leave it lying around in another easily accessible form.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Mon Jan 09 2023 12:02:21 GMT-0800 (Pacific Standard Time)">20:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Well, if you‚Äôre satisfied by some API impedance, that‚Äôs overall good news since we care more about what‚Äôs possible than how coherent it is.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Mon Jan 09 2023 12:03:08 GMT-0800 (Pacific Standard Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And Compartments are not all that cumbersome.</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Mon Jan 09 2023 12:03:18 GMT-0800 (Pacific Standard Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I am certainly <em>more</em> comfortable with less accessible new ways to <code>eval</code> but not automatically entirely comfortable with them</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Mon Jan 09 2023 12:04:54 GMT-0800 (Pacific Standard Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Would this be a sufficiently inaccessible affordance: <code>new Compartment({ importHook(specifier) { return { source }; } }).import('specifier')</code>?</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Mon Jan 09 2023 12:04:56 GMT-0800 (Pacific Standard Time)">20:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">though in addition I think if Compartments the use case then a design which exposes the capability only to compartments is more palatable for that reason</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Mon Jan 09 2023 12:05:25 GMT-0800 (Pacific Standard Time)">20:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">That would make me feel a lot better than <code>import(new Module(new ModuleSource(source)))</code>, certainly</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Mon Jan 09 2023 12:09:55 GMT-0800 (Pacific Standard Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Though I would still be hesitant to add that if the only use case is your source-from-zip-files thing</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Mon Jan 09 2023 12:10:11 GMT-0800 (Pacific Standard Time)">20:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><p>So we would recover the ergonomics in user code like:</p>
<pre><code>const loadModuleSource = async source =&gt; new Compartment({ importHook: () =&gt; ({ source }) }).import('.', { reflect: true });
</code></pre>
</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Mon Jan 09 2023 12:11:10 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Why do you want to recover the ergonomics?</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Mon Jan 09 2023 12:11:18 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">zip-files in this case represent a class including databases, local storage, &amp;c, if that makes any difference in substance.</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Mon Jan 09 2023 12:11:28 GMT-0800 (Pacific Standard Time)">20:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Not really.</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Mon Jan 09 2023 12:12:17 GMT-0800 (Pacific Standard Time)">20:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And in all these cases, the point is that it‚Äôs possible to draw a circle around a working set as a reviewable, confineable artifact, which would not otherwise be possible to isolate in this way.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Mon Jan 09 2023 12:12:46 GMT-0800 (Pacific Standard Time)">20:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">that is, those things are not a use case on their own - if you want to <code>eval</code> code from local storage, my question will be why do you want that</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Mon Jan 09 2023 12:13:19 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I think I understand your particular use case, which makes cloning an opaque object to a Worker not viable, but am not convinced by that use case alone</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Mon Jan 09 2023 12:13:25 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In our case, the artifacts are smart contracts, responsible for handling money on behalf of multiple parties.</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Mon Jan 09 2023 12:14:34 GMT-0800 (Pacific Standard Time)">20:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Right, which is to say, an extremely unusual case, unlikely to generalize to something needed by other applications</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Mon Jan 09 2023 12:15:01 GMT-0800 (Pacific Standard Time)">20:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Doug Crockford used to refer to the generalization of the case as mash-ups.</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Mon Jan 09 2023 12:16:34 GMT-0800 (Pacific Standard Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Doug Crockford talked about wanting to be able to shell out to a separate process and communicate code to that process in a transparent representation?</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Mon Jan 09 2023 12:18:26 GMT-0800 (Pacific Standard Time)">20:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Hardly so specifically, but Doug built AdSafe at Yahoo, which does isolate and evaluate arbitrary guest programs.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Mon Jan 09 2023 12:20:48 GMT-0800 (Pacific Standard Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Program isolation is mostly orthogonal from <code>eval</code> - generally one can serve the guest programs from a server, as programs, and not need to <code>eval</code> them (assuming the language has isolation abilities at all, which would need to be built out anyway, as we are doing with realms and so on)</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Mon Jan 09 2023 12:21:26 GMT-0800 (Pacific Standard Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Your particular use case prevents this but, again, your particular use case seems to me to be extremely unusual</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Mon Jan 09 2023 12:22:53 GMT-0800 (Pacific Standard Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">So I would still want to hear other use cases before adding this feature, as I would for any feature, although they can be somewhat less compelling than I would want for a new <em>easily-accessible</em> path to <code>eval</code></td></tr>

</tbody></table></div></div></div>
</body></html>