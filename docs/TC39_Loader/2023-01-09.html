<!DOCTYPE html><html><head>
  <title>TC39 Loader on 2023-01-09</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Loader";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Loader<br>2023-01-09<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-03" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Loader">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jan 09 2023 03:43:09 GMT-0800 (Pacific Standard Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">My major open question in response to <span class="nick-2">bakkot</span>'s points at plenary is how this qualifies as a new path to eval - we discussed this at the last loader meeting and came to the conclusion that a <code>ModuleSource</code> constructor was in fact <strong>not</strong> a new path to eval, because the "evalness" of the ModuleSource is done through the existing dynamic import. The constructor itself <strong>does not eval</strong> - eval only happens at import - which is already possible right now.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jan 09 2023 03:44:25 GMT-0800 (Pacific Standard Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">I would still like to invite <span class="nick-2">bakkot</span> to a loader meeting so we can discuss this in detail - I am likely missing something, or I am not understanding your concern correctly.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jan 09 2023 07:30:48 GMT-0800 (Pacific Standard Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think this is discussed more concretely as we discuss mitigations. Clearly the whole thing (ModuleSource + import()) put together was a path to eval. I guess the question was whether bakkot would accept a mitigation which was, "ModuleSource produces marked things which cannot be passed to import() but otherwise work" (but I'm not so convinced the feature is very useful, and we were discussing this above)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jan 09 2023 08:04:32 GMT-0800 (Pacific Standard Time)">16:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-3">Luca Casonato</span>: as <span class="nick-10">littledan</span> says, ModuleSource + dynamic import is eval, to my view. yes, in some (but not all) hosts it possible to use <code>data</code> URIs with dynamic import already, but a.) that is not widely supported especially given CSP and so is not a reliable way to <code>eval</code> and b.) <code>data</code> URIs are very obviously a kludge, whereas a ModuleSource constructor would be a first-class part of the language, and we should be concerned about making paths to <code>eval</code> more usable, not just whether they exist at all.</p>
<p>also it is not at all clear to me what the use case for ModuleSource is other than <code>eval</code>; the cases discussed about were all either <code>eval</code>-like or a desire from a single library to have a built-in way of parsing out bindings. I think an affirmative case needs to be made for this feature (as with any feature), and to convince me personally that case needs to be something other than "we would like it to be easier to do <code>eval</code>" (or there needs to be an extremely strong reason to make it easier to do <code>eval</code>).</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jan 09 2023 09:39:01 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">&lt;weak-argument&gt;well, it's eval for a module, which is otherwise more or less a missing capability&lt;/weak-argument&gt;</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jan 09 2023 09:39:57 GMT-0800 (Pacific Standard Time)">17:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I would ideally like to find a motivation for this path to eval that does not require others to buy into the SES group’s long-term motivation to make a safe path to eval, that does not rest on CSP, since I know that is contentious. But, that is personally my motivation. Making an easy path to lift text makes it easier to build a sandbox, and making that part of the language makes it easier to write portable sandboxes. One of the drawbacks of the compartment shim is that we have to censor the words <code>eval</code> and <code>import</code> from source text in order to enforce confinement. There are false positives that a native implementation wouldn’t suffer from.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jan 09 2023 09:40:42 GMT-0800 (Pacific Standard Time)">17:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Making it eaiser to make sandboxes has the emergent effect of making sandboxes safer.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jan 09 2023 09:41:11 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And given that the design is compatible with CSP, I feel like this is a win-win.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jan 09 2023 09:41:17 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Kris, I'm glad you're describing your actual use case, as this makes it a lot easier to follow</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jan 09 2023 09:41:21 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">It's quite hard for me to follow a use case argument which centers on the censorship mechanism, since I really don't understand what sorts of restrictions you have in how you evolve that.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jan 09 2023 09:41:45 GMT-0800 (Pacific Standard Time)">17:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">maybe you could give some more details there?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jan 09 2023 09:43:00 GMT-0800 (Pacific Standard Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Yeah, in the SES shim, confinement is enforced at runtime and it’s a production performance and developer-experience requirement that we not entrain rigorous static analysis or on-the-fly transformations.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jan 09 2023 09:44:28 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The heart of the confinement mechanism points four of JavaScript’s sharpest edges at each other: We use use direct eval in sloppy mode inside a with block that puts an opaque proxy on the stack.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jan 09 2023 09:44:48 GMT-0800 (Pacific Standard Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That’s…a summary.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jan 09 2023 09:45:11 GMT-0800 (Pacific Standard Time)">17:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In any case, there are a number of obvious ways to escape lexical containment.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jan 09 2023 09:46:15 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Collectively “undeniable intrinsics”. So, for example, (async()=&gt;{}) gives you access to the async function prototype. That’s pretty straightforward to confine with the hardening of shared intrinsics.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jan 09 2023 09:47:04 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In the most basic case, {} and [] give you access to shared intrinsics in ways that can’t be denied with the lexical environment.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jan 09 2023 09:47:59 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Likewise, <code>import</code> escapes confinement. So, we use a careful regex to identify any pattern that <em>might</em> be an invocation of import and refuse to evaluate such programs.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jan 09 2023 09:48:33 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The Evaluators proposal would allow us to hook the behavior of <code>import</code> for confined programs.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jan 09 2023 09:49:44 GMT-0800 (Pacific Standard Time)">17:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">We also ban direct <code>eval</code> similarly, but not so much because of confinement concerns, but because it is impossible to faithfully emulate the intended behavior in the shim.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jan 09 2023 09:52:00 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In order to support modules, we have no choice but to convert modules into programs at compile time, which is a source-to-source transformation that reduces debuggability. We also eschew source maps because they can be used to confuse auditors.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jan 09 2023 09:53:26 GMT-0800 (Pacific Standard Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">So we have a module-to-program transform, which necessarily generates both the module functor source code and the bindings in a JSON envelope, and a runtime that handles these “module sources” reconstructs the linkage from the declared bindings and a sort of calling convention.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jan 09 2023 09:55:19 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The net result is a Zip file that contains JSON enveloped sources which is not as debuggable or reviewable as we’d like. This is the artifact that must be trusted when you grant capabilities to the guest program, so this is the artifact that gets fingerprinted for integrity checks. It’s also, notably, not hosted on the web, and modules not hosted on the web are not currently possible to evaluate across all JavaScript hosts.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jan 09 2023 09:56:01 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">There are hacks, but they are hacks, and hacks and confinement are somewhat inimical.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jan 09 2023 09:58:22 GMT-0800 (Pacific Standard Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And again, our position is not that we hope to capture all JavaScript in hardened JavaScript. Our position is that it should be possible to get to hardened JavaScript from ordinary mutable implicitly permissive one-big-sandbox JavaScript. We in fact <em>require</em> that as a starting point since anything else would preclude evolution of the host environment over time.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jan 09 2023 10:29:48 GMT-0800 (Pacific Standard Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-2">bakkot</span>: so your concern is not that it is a <strong>new</strong> path to eval, but rather that it may make an existing path to eval more ergonomic?</p>
<p>As for the usecases that can justify an unconstructable <code>ModuleSource</code>:</p>
<ul>
<li>multiple instantiation modules (including module expressions &amp; declarations)</li>
<li>low level <code>script-src: no-eval</code> module passing between workers</li>
<li>manual instantiation and module instrospection (we've seen this in WASM using <code>WebAssembly.Module</code>, for which <code>ModuleSource</code> would be the JS equivalent)</li>
</ul>
</td></tr>

</tbody></table></div></div></div>
</body></html>