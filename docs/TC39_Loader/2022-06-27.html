<!DOCTYPE html><html><head>
  <title>TC39 Loader on 2022-06-27</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Loader";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Loader<br>2022-06-27<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-06-22" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Loader">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jun 27 2022 07:40:18 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Caridy and I had a conversation about paring down the compartments/loader proposal to avoid having to specify any maps at all, to avoid mentioning referrer specifiers at all, to further slim its profile against the wind.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jun 27 2022 07:40:55 GMT-0700 (Pacific Daylight Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The thought experiment is to return to the proposal Guy and Luca made at plenary and ask more questions.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jun 27 2022 07:41:20 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Suppose new ModuleSource(source) and new ModuleInstance(source, importHook, importMeta?)</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jun 27 2022 07:41:42 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Such that source.bindings reflects imports/exports and instance.source refers to the original source.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jun 27 2022 07:44:18 GMT-0700 (Pacific Daylight Time)">14:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Suppose also that import reflection gives us the means to obtain either of these through syntax. Recursively, that would mean that ModuleInstances and ModuleSources could be drawn out of ModuleInstance hooks.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jun 27 2022 07:45:08 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Also, supposing that importHook’s signature is importHook(importSpecifier, moduleInstance), such that there is no referrer, but the importHook can associate instances with referrers and do whatever it must internally.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jun 27 2022 07:45:29 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Caridy also proposes that we use dynamic import in the same way as blocks.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jun 27 2022 07:45:44 GMT-0700 (Pacific Daylight Time)">14:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Which is to say, in this thought experiment, ModuleInstance corresponds to module {}</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jun 27 2022 07:46:56 GMT-0700 (Pacific Daylight Time)">14:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">With that in mind, it’s sufficient to have a module instance to get the underlying unhooked Module Source, like (module {}).source, but Caridy suggests that would potentially mean the creation of throw-away module instances as in new ModuleInstance((module {}.source), importHook, importMeta)</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jun 27 2022 07:47:13 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">So we go on to suggest (static module {}) instanceof ModuleSource, bypassing that step</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jun 27 2022 07:47:47 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That suggests that there be import syntax that gives us both of those options.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jun 27 2022 07:48:55 GMT-0700 (Pacific Daylight Time)">14:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">One thing I had not considered until this moment is that importHook would not be sufficient in order to support the ModuleSource import case.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jun 27 2022 07:50:36 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">But importHook is sufficient for deferred execution. For the deferred execution case, you’re importing a fully linked ModuleInstance that inherits the surrounding ModuleInstance’s importHook. You would then have the option of using it as a handle in a more elaborate import graph or just import(moduleInstance) at whatever time you deem appropriate to experience jank.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jun 27 2022 07:51:22 GMT-0700 (Pacific Daylight Time)">14:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">In any case, I sketched this, borrowing as much as possible from the Compartments proposal <a href="https://gist.github.com/kriskowal/288d38e62e55e09685bf62c3a3c25565">https://gist.github.com/kriskowal/288d38e62e55e09685bf62c3a3c25565</a></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jun 27 2022 07:52:23 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">And note that it varies from Guy and Luca’s proposal in only one meaningful way: there’s no link method. Linking is a side-effect of kicking off the module system with a dynamic import of some leaf instance, which draws in its transitive dependencies.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jun 27 2022 07:52:51 GMT-0700 (Pacific Daylight Time)">14:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">So the difference is that the importHook gets used for both static and dynamic import.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jun 27 2022 07:53:24 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I need to think more about the ramifications, but you’re all welcome to join me in the thought experiment.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jun 27 2022 08:15:32 GMT-0700 (Pacific Daylight Time)">15:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">One question <span class="nick-6">ljharb</span> asked on Github was whether it is ever desirable for dynamic import to provide different values for the same specifier (un-idem-potent?), or results inconsistent with <code>import * as name</code>. It would be surprising, which is undesirable. I’m not sure whether it’s always undesirable. In the context of this thought experiment, it would be possible to enforce idempotence on dynamic import and consistency with static import by having a locale memo as part of the ModuleInstance state. That comes at a cost we might prefer not to bear, especially if it is adequate to suggest that the responsibility to maintain this invariant be deferred to user code.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jun 27 2022 08:17:08 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Maintaining import consistency at any granularity broader than module instance might be futile though. Since compartments as specified do and must allow inter-compartment linkage, it is possible in the degenerate case for user code to arrange a single compartment for every module instance and do whatever they want.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jun 27 2022 08:17:21 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">to be clear, my default assumption is that it should be an unbreakable axiom modulo thenable modules, that static and dynamic imports are the same. I asked when it’d be desirable to figure out if that axiom should hold</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jun 27 2022 08:18:27 GMT-0700 (Pacific Daylight Time)">15:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Do you mean in the scope of an instance, cohort of instances, or realm?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jun 27 2022 08:19:51 GMT-0700 (Pacific Daylight Time)">15:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> to be clear, my default assumption is that it should be an unbreakable axiom modulo thenable modules, that static and dynamic imports are the same. I asked when it’d be desirable to figure out if that axiom should hold</blockquote></mx-reply>That’s also my default assumption. I can think of no use for inconsistency in the scope of an instance.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jun 27 2022 08:23:32 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">This thought experiment would allow for inconsistency, and although inconsistency is not a desired effect, it does allow us to decouple the module loader from the realm’s module map, since it becomes the responsibility of the module instance hooks to maintain consistency.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jun 27 2022 08:24:50 GMT-0700 (Pacific Daylight Time)">15:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">The compartments proposal as written today would require module maps to be factored out of Realm so each Compartment can have its own maps. We’re anticipating that will meet resistance, but I don’t know for sure.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jun 27 2022 08:28:08 GMT-0700 (Pacific Daylight Time)">15:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">nicolo-ribaudo</span> can correct me if I’m wrong, but I believe that module blocks and fragments as <span class="nick-10">littledan</span> has described them to me, would enforce consistency in the same realm by incorporating every module instance into the realm’s module map, using either a gensym or the module instance’s identity as an (ephemeral?) key. That would not allow for inconsistency. But, round-tripping a module instance through an intermediate realm would.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jun 27 2022 08:29:26 GMT-0700 (Pacific Daylight Time)">15:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">But I think the inconsistency would be limited to fragments themselves. Stringly-named dependencies would remain consistent.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jun 27 2022 08:30:03 GMT-0700 (Pacific Daylight Time)">15:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I for one see no reason to expect consistency of fragment identity under any circumstances, but that is a separate matter.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jun 27 2022 08:34:24 GMT-0700 (Pacific Daylight Time)">15:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Compartments as proposed do attempt to maintain consistency by having per-compartment maps and consistent-linkage to other compartments. I should try harder to come up with a consistency attack. I’m not sure a meaningful one exists.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jun 27 2022 08:35:29 GMT-0700 (Pacific Daylight Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do you mean in the scope of an instance, cohort of instances, or realm?</blockquote></mx-reply>i mean in a realm, but I’m not paged in on all the new terminology here</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jun 27 2022 09:10:00 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I need some time to digest all of this, but I like this direction.<br>For module blocks, having "module instances" and "module sources" easily explains why/how passing a module to a different realm (and back) looses the <code>import()</code> caching: you now have a new module, just with the same source (like having two identical files on the file system but in two different locations)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jun 27 2022 09:17:41 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><p>The "import axioms" I think we shuold guarantee are (modulo <code>export function then</code>):</p>
<ul>
<li><code>await import("x")</code> and <code>import * as _ from "x"</code> in the same module must always evaluate to the same object</li>
<li><code>await import(fragment)</code> and <code>import * as _ from fragment</code> in the same realm (compartment?) must always evaluate to the same object</li>
</ul>
<p>And, with your proposed ModuleInstance/ModuleSource,</p>
<ul>
<li><code>await import(fragment)</code> and <code>await import(new ModuleInstance(fragment.source))</code> must re-evaluate the module two times</li>
</ul>
<p>The only thing I'm not sure about is if in module blocks the evaluation context should depend on where <code>import()</code> is called or where the module is defined. Given <code>realm</code> the <code>globalThis</code> of an <code>iframe</code>, I don't know if <code>await import(fragment)</code> and <code>await realm.Function("s", "import(s)")(fragment)</code> should return the same object (because they are importing the same ModuleInstance) or if they should evaluate the module twice (because they are in two different realms).<br>For string-based imports they would evaluate the module twice, but with this ModuleSource/ModuleInstance thing maye they should return the same object.</p>
</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Mon Jun 27 2022 09:35:44 GMT-0700 (Pacific Daylight Time)">16:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Round-tripping to a worker would be similar to doing <code>new ModuleInstance(fragment.source)</code>, and that can explain why you get two different modules.</td></tr>

</tbody></table></div></div></div>
</body></html>