<!doctype html>
<head>
  <title>#whatwg on 2019-05-23</title>
  <link rel="stylesheet" href="../style.css">
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">#whatwg<br>2019-05-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2019-05-22" class="nav-link"><span>prev</span></a>
<a href="2019-05-24" class="nav-link"><span style="float:right">next</span></a>
</div>
    
<div class="room-list-wrapper">Active:<br>
<ul class="room-list">
<li><a href="../TC39_Delegates/">TC39 Delegates</a></li>
<li><a href="../TC39_Editors/">TC39 Editors</a></li>
<li><a href="../TC39_General/">TC39 General</a></li>
<li><a href="../WHATWG/">WHATWG</a></li>
</ul>
</div>
<br>
<div class="room-list-wrapper">Historical:<br>
<ul class="room-list">
<li><a href="../irc-tc39/">#tc39</a></li>
<li><a href="../irc-tc39-delegates/">#tc39-delegates</a></li>
<li><a href="../irc-tc39-editor-group/">#tc39-editor-group</a></li>
<li><a href="../irc-whatwg/" class="current-room">#whatwg</a></li>
</ul>
</div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs"><div class="log">
<table><tbody id="log-tbody">
  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed May 22 2019 17:46:35 GMT-0700 (Pacific Daylight Time)">00:46</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">encoding peoples, what is a nice web encoding I can specify that has the characteristic that some invalid UTF-8 will be valid in that encoding?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed May 22 2019 17:47:32 GMT-0700 (Pacific Daylight Time)">00:47</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">ideally one that&#039;s sort of ASCII-ish, because I need to be able to write a JS script that contains a multi-line comment that contains invalid UTF-8 bytes in it, and I&#039;d rather not learn too much intricacy to do it</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed May 22 2019 17:51:42 GMT-0700 (Pacific Daylight Time)">00:51</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">I guess I don&#039;t *really* need that, I can just pick something that doesn&#039;t equal ASCII in the 00-7F range, can&#039;t I</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed May 22 2019 17:56:03 GMT-0700 (Pacific Daylight Time)">00:56</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">jwalden: I mean, most of the single byte encodings are valid for any byte sequence</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed May 22 2019 17:56:08 GMT-0700 (Pacific Daylight Time)">00:56</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">jwalden: e.g. Windows-1252</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed May 22 2019 17:56:19 GMT-0700 (Pacific Daylight Time)">00:56</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">(i.e., what ISO-8859-1/Latin1 is aliased to)</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed May 22 2019 17:56:55 GMT-0700 (Pacific Daylight Time)">00:56</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">gsnedders: so I think Gecko is not correctly implementing the requirement that worker scripts be only UTF-8 based on code inspection, but for the life of me I can&#039;t get it to fail</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed May 22 2019 17:57:42 GMT-0700 (Pacific Daylight Time)">00:57</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">specifically, I think we do the UTF-8 requirement as a &quot;hint charset&quot; that is applied only after BOM sniffing and content charset inspection (fairly sure from the HTTP header)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed May 22 2019 17:57:50 GMT-0700 (Pacific Daylight Time)">00:57</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">ISO-2022-JP, UTF-16BE, and UTF-16LE are the non-ASCII encodings supported, FWIW</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed May 22 2019 17:58:20 GMT-0700 (Pacific Daylight Time)">00:58</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">so if I make the worker script contain *mostly* UTF-8 but put a UTF-8 encoding error in a comment, the script&#039;s text should be interpreted differently</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed May 22 2019 17:58:25 GMT-0700 (Pacific Daylight Time)">00:58</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">jwalden: well that sounds fun</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed May 22 2019 17:59:22 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">I swear I&#039;m not even trying to fix this, I&#039;m trying to do something else, but odds are if I push this to bz he&#039;s going to say &quot;why are we doing all this extra nonsense when workers are always UTF-8&quot; and hypothetical-bz seems right except practical testing says there isn&#039;t a problem and boo</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed May 22 2019 17:59:39 GMT-0700 (Pacific Daylight Time)">00:59</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">(the original &quot;this&quot; being a largely unrelated fix that happens to touch DOM worker code)</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed May 22 2019 18:00:11 GMT-0700 (Pacific Daylight Time)">01:00</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">jwalden: <a href="https://github.com/web-platform-tests/wpt/tree/master/workers/semantics/encodings">https://github.com/web-platform-tests/wpt/tree/master/workers/semantics/encodings</a> maybe?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed May 22 2019 18:01:03 GMT-0700 (Pacific Daylight Time)">01:01</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">004.worker.js seems to be this</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed May 22 2019 18:01:21 GMT-0700 (Pacific Daylight Time)">01:01</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">we have that test in our tree...</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed May 22 2019 18:01:22 GMT-0700 (Pacific Daylight Time)">01:01</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell"><a href="https://wpt.fyi/results/workers/semantics/encodings/004.worker.html">https://wpt.fyi/results/workers/semantics/encodings/004.worker.html</a> has it passing everywhere? (rejecting invalid UTF-8)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed May 22 2019 18:01:49 GMT-0700 (Pacific Daylight Time)">01:01</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">oh, wait, you think it&#039;s something more subtlely wrong</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed May 22 2019 18:02:56 GMT-0700 (Pacific Daylight Time)">01:02</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">oh god, these are zcorpan&#039;s self-hosting Worker tests</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed May 22 2019 18:03:04 GMT-0700 (Pacific Daylight Time)">01:03</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">gsnedders: if 004.worker.js.headers existed containing &quot;Content-Type: text/html; charset=windows-1252&quot; as its content my code-reading says we should fail it</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed May 22 2019 18:03:14 GMT-0700 (Pacific Daylight Time)">01:03</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">jwalden: see 001.html/002.html, which do have this</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed May 22 2019 18:03:16 GMT-0700 (Pacific Daylight Time)">01:03</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">assuming .headers support works the intuitive way</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed May 22 2019 18:04:30 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">hrm</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed May 22 2019 18:04:35 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">I don&#039;t get it</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed May 22 2019 18:04:44 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">our code looks nuts, but it passes that test</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed May 22 2019 18:05:30 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">oh, that&#039;s why</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed May 22 2019 18:05:40 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">is the expectation wrong?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed May 22 2019 18:05:46 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">Firefox is the only one to pass this</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed May 22 2019 18:05:49 GMT-0700 (Pacific Daylight Time)">01:05</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">we pointlessly pass in a field that looks like it means something, but earlier in this function we nulled it out</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed May 22 2019 18:06:11 GMT-0700 (Pacific Daylight Time)">01:06</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">so our code looks stupid but is not, at least in that manner</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed May 22 2019 18:06:22 GMT-0700 (Pacific Daylight Time)">01:06</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">no, the test is right provided the spec says what you said</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed May 22 2019 18:07:39 GMT-0700 (Pacific Daylight Time)">01:07</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">sorry -- not saying the test is wrong, I&#039;m saying our code does a thing that *looked* like it would lead us astray, but if you look more carefully it is passing in an always-null value and so we end up using the hint charset always</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed May 22 2019 18:08:57 GMT-0700 (Pacific Daylight Time)">01:08</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">I hadn&#039;t read your last comment before my last comment, and I was being paranoid given everywhere but Firefox fails it</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed May 22 2019 18:10:03 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">specifically if you look here <a href="https://searchfox.org/mozilla-central/source/dom/workers/ScriptLoader.cpp#1134">https://searchfox.org/mozilla-central/source/dom/workers/ScriptLoader.cpp#1134</a> we pass in |aLoadInfo.mChannel| which in <a href="https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#3108">https://searchfox.org/mozilla-central/source/dom/script/ScriptLoader.cpp#3108</a> is the second thing tested for picking an encoding...but if you scroll upward to <a href="https://searchfox.org/mozilla-central/source/dom/workers/ScriptLoader.cpp#1050">https://searchfox.org/mozilla-central/source/dom/workers/ScriptLoader.cpp#1050</a> you...</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed May 22 2019 18:10:04 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">...can see |aLoadInfo.mChannel| is definitely null, so either we pick up UTF-8 from the ForBOM test, or we would use the &quot;UTF-8&quot; hint which would get us UTF-8 too</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed May 22 2019 18:10:47 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">there&#039;s a reason for this complexity because in the *general* case this function handles so-called classic scripts, but in the worker caller it&#039;s pointless</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed May 22 2019 18:11:13 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">but there certainly is no reason the worker code should be passing in a field that is always null, rather than passing nullptr directly</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed May 22 2019 18:11:43 GMT-0700 (Pacific Daylight Time)">01:11</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">&quot;this has been another scintillating episode of Gecko Guts with jwalden&quot;</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed May 22 2019 18:12:29 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell">&lt;<span class="nick nick-2" title=gsnedders@irc>gsnedders</span>&gt;</td><td class="msg-cell">who doesn&#039;t love browser code?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed May 22 2019 18:12:52 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><span class="nick nick-2" title=gsnedders@irc>gsnedders</span></td><td class="msg-cell">tries to remember what they were looking at before getting nerd sniped into this much more interesting drama</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed May 22 2019 18:14:46 GMT-0700 (Pacific Daylight Time)">01:14</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">I got into all this by wanting to have a ScriptLoader::ConvertToUTF8, and there&#039;s enough noisy in the ConvertToUTF16 algorithm I could either template that up so both algorithms could be defined by one template function (...and some helpers), or I could define them separately with some algorithmic duplication possibly undesirably</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed May 22 2019 18:15:01 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">for workers, simplifying the algorithm would probably be the right thing to do</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed May 22 2019 18:15:26 GMT-0700 (Pacific Daylight Time)">01:15</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell">except this ConvertToUTF8 may end up used outside workers, so I guess I don&#039;t know whether duplication or not is proper yet</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed May 22 2019 18:23:10 GMT-0700 (Pacific Daylight Time)">01:23</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=jwalden@irc>jwalden</span>&gt;</td><td class="msg-cell"><a href="https://paste.rs/poQ.sh">https://paste.rs/poQ.sh</a> for anyone who wants to see what my testcase looks like (loaded in a server where ^headers^ is like the .headers thing in the wpt tests, looks like) -- should see replacement-characters, Firefox displays them, other browsers display &amp;yuml;</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu May 23 2019 03:07:11 GMT-0700 (Pacific Daylight Time)">10:07</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=annevk@irc>annevk</span>&gt;</td><td class="msg-cell">hah, workers/semantics/encodings/001.html is fun</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu May 23 2019 03:07:32 GMT-0700 (Pacific Daylight Time)">10:07</a></td><td class="nick-cell">&lt;<span class="nick nick-12" title=annevk@irc>annevk</span>&gt;</td><td class="msg-cell">A similar one with &lt;script&gt; and Worker loading the same thing might lead to surprises too</td></tr>
</tbody></table>
</div></div></div></body>
