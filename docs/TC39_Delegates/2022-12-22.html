<!DOCTYPE html><html><head>
  <title>TC39 Delegates on 2022-12-22</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Delegates";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Delegates<br>2022-12-22<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-12-21" class="nav-link"><span>prev</span></a>
<a href="2022-12-27" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Delegates">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Dec 22 2022 13:21:20 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">so i realized while implementing is/toWellFormed that, while web engines today with 1-byte and 2-byte strings can make <code>isWellFormed</code> constant time trivially for 1-byte strings, optimizing for 2-byte strings is actually fairly involved</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Dec 22 2022 13:21:54 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">does anyone have any intuitions on the performance expectations and usage patterns?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Dec 22 2022 13:22:06 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">for 2-byte strings, that is</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Dec 22 2022 13:30:30 GMT-0800 (Pacific Standard Time)">21:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">@shu I'm not sure there are any major expectations for an initial implementation, but there certainly were hopes that this is something that could have optimization potential in time so that it could be used as a guard / check without too much perf overhead. How involved is it looking?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Dec 22 2022 13:33:46 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">couldn't it be optimized opportunistically? Â­maybe caching the result, and setting it at first if a string was created from UTF-8, for example</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Dec 22 2022 13:34:54 GMT-0800 (Pacific Standard Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I'd sort of expect that its usage would ramp up over time (if it becomes widely used at all), so the optimizations that shu and Andreu are thinking of could wait</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Dec 22 2022 13:35:31 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">The absolute bare minimum might be a boolean flag, acting as a cache of the result, that is invalidated on mutations</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Dec 22 2022 13:35:52 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">so that at least there's some internal concept of the check that in theory could be an optimization target in future</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Dec 22 2022 13:35:56 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">It's hard to predict whether caching/precomputing vs optimizing the actual calculation would be more important</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Dec 22 2022 13:38:24 GMT-0800 (Pacific Standard Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(I imagine Shu is thinking about the latter if it's seen as involved? One could imagine fancy SIMD stuff to search for the forbidden surrogates...)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Dec 22 2022 13:44:16 GMT-0800 (Pacific Standard Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i'm thinking of the former, the latter i agree can definitely wait</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Dec 22 2022 13:44:34 GMT-0800 (Pacific Standard Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i'm mainly thinking about removing the cliff between 1-byte and 2-byte strings for <code>isWellFormed</code></td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Dec 22 2022 13:44:50 GMT-0800 (Pacific Standard Time)">21:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">caching a bit requires space to cache the bit, and that is what's involved</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Dec 22 2022 13:46:08 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">no bits to spare...!? or lots of wiring?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Dec 22 2022 13:46:22 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">we're in a perpetual state of no bits to spare :)</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Dec 22 2022 13:46:34 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but in this case, mainly lots of wiring, yeah</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Dec 22 2022 13:47:20 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">web engines today have a 1-bit encoding state: 1-byte or 2-byte</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Dec 22 2022 13:47:50 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">you now need 2-bits with 4 states: 1-byte, 2-byte-of-unknown-well-formedness, 2-byte-well-formed, 2-byte-ill-formed</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Dec 22 2022 13:48:16 GMT-0800 (Pacific Standard Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">you have something of a combinatorial explosion by propagating that through to every string type (rope/cons, slice/view, etc)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Dec 22 2022 13:48:45 GMT-0800 (Pacific Standard Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">you can compute it in sub-linear time for all the non-direct (i.e. don't own their own char buffer) string types, except for slices, which i don't know how to do</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Dec 22 2022 13:49:19 GMT-0800 (Pacific Standard Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i think you always have to re-iterate sliced strings in some cases</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Dec 22 2022 13:49:31 GMT-0800 (Pacific Standard Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">is it not possible to add something as a placeholder that is basically just "well-formed | unknown" where the default is "unknown", and then it can be ignored by the other types for now?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Dec 22 2022 13:50:26 GMT-0800 (Pacific Standard Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">for slices, I think the thinking was that careful checking of the slice ends could be done for surrogate splits, if you know the string being sliced is valid</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Dec 22 2022 13:50:26 GMT-0800 (Pacific Standard Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that is pretty much the same amount of wiring, no?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Dec 22 2022 13:50:40 GMT-0800 (Pacific Standard Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">right, if the underlying of a slice is well-formed, you just need to check the beginning and the end</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Dec 22 2022 13:50:52 GMT-0800 (Pacific Standard Time)">21:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">if the underlying is not well-formed you have to re-iterate afaict</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Dec 22 2022 13:51:25 GMT-0800 (Pacific Standard Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">well everything could ignore the well-formed bit and just recompute by default without that being wiring?</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Dec 22 2022 13:51:32 GMT-0800 (Pacific Standard Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">or does even just adding the bit add overhead there?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Dec 22 2022 13:51:55 GMT-0800 (Pacific Standard Time)">21:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">well, if everything just ignores it why add a bit? reserve it now you mean?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Dec 22 2022 13:52:57 GMT-0800 (Pacific Standard Time)">21:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">for V8 there's also the grossness of external strings, where the embedder can choose to take ownership of the character buffer</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Dec 22 2022 13:53:15 GMT-0800 (Pacific Standard Time)">21:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">1-byte or 2-byte encodings are exposed for external string data, and well-formedness would need to be as well i guess?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Dec 22 2022 13:54:09 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell"><code>const s = "well-formed ðŸ˜Š"; s.isWellFormed()</code> could in theory still benefit as some kind of baseline if the initial static string could pass the bit</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Dec 22 2022 13:54:31 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">how is the initial static string well-formedness computed?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Dec 22 2022 13:54:37 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">yeah this affects webidl as well</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Dec 22 2022 13:54:56 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">although again, you're way ahead - the initial expectation was just to keep it simple very much so</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Dec 22 2022 13:55:15 GMT-0800 (Pacific Standard Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yeah this can probably all wait pending real world usage data</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Dec 22 2022 13:55:16 GMT-0800 (Pacific Standard Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">when the original encoding pass is taking place?</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Dec 22 2022 13:55:42 GMT-0800 (Pacific Standard Time)">21:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">ah, yeah, there are places where we would iterate strings anyway and we might be able to piggyback the well-formedness checks</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Dec 22 2022 13:56:06 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">determining 1-byte is one of them, computing hash codes is another</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Dec 22 2022 13:56:38 GMT-0800 (Pacific Standard Time)">21:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">yeah, in theory external strings might want to set this stuff themselves if they can be trusted to provide that information</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Dec 22 2022 13:57:00 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i think this is all to say the "implementations can make this sub-linear and fast today without much work" only holds for 1-byte strings, which means we'll ship with a performance cliff</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Dec 22 2022 13:57:22 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">which is fine (but isn't ideal) and wasn't something i realized</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Dec 22 2022 13:57:41 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">sub-linear? aren't 1-byte strings always well-formed?</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Dec 22 2022 13:57:52 GMT-0800 (Pacific Standard Time)">21:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yes, that's what i mean, it's constant time for 1-byte strings</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Dec 22 2022 13:58:05 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">but there were vague discussions of its being able to be sublinear for 2-byte as well</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Dec 22 2022 13:58:16 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">and i kinda thought oh okay that sounds plausible without thinking about it much</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Dec 22 2022 14:00:58 GMT-0800 (Pacific Standard Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">I guess the only concern is if this gets put as something that is considered a "cliff" and no one tackles it...?</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Dec 22 2022 14:01:17 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yeah, and that's a pretty generic concern</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Dec 22 2022 14:01:20 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">having some idea of what the cliff is and how to approach it in future would certainly help... so it's interesting to hear what you think here</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Dec 22 2022 14:02:04 GMT-0800 (Pacific Standard Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">(i'm more remarking on the interestingness of the problem space here, do not take what i've said as implementation concerns for shipping)</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Dec 22 2022 14:03:43 GMT-0800 (Pacific Standard Time)">22:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">well, the cliff for the naive implementation (constant time for 1-byte, flattening + linear time always for 2-byte) is fairly stark, so for large strings apps can definitely notice</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Dec 22 2022 14:04:14 GMT-0800 (Pacific Standard Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">as for how to approach, the ideas we've talked about here all sound reasonable to try out</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Dec 22 2022 14:04:38 GMT-0800 (Pacific Standard Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">that is, caching bit and piggybacking on other operations that already need to iterate the code units anyway</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Dec 22 2022 14:05:37 GMT-0800 (Pacific Standard Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">glad to hear constant time doesn't sound untenable, which wasn't clear when these were purely hypothetical discussions</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Dec 22 2022 14:06:01 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">amortized constant time?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Dec 22 2022 14:06:04 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">definitely makes sense to think about the integration points of this</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Dec 22 2022 14:06:24 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">well i guess even for 1-byte it's amortized constant time</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Dec 22 2022 14:06:36 GMT-0800 (Pacific Standard Time)">22:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">Rust &lt;&gt; JS string sharing are cases where these expectations are important</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Dec 22 2022 14:08:32 GMT-0800 (Pacific Standard Time)">22:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">remind me again, rust strings are... wtf8?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Dec 22 2022 14:09:09 GMT-0800 (Pacific Standard Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">oh no, this is the point - they are strictly valid UTF8</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Dec 22 2022 14:09:16 GMT-0800 (Pacific Standard Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">the more relevant thing is wasm strings, which will be list-of-usv, I believe</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Dec 22 2022 14:09:41 GMT-0800 (Pacific Standard Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">list-of-usv implies no unpaired surrogates</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Dec 22 2022 14:09:58 GMT-0800 (Pacific Standard Time)">22:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">you might be thinking of <code>OsString</code> (for filesystem paths, etc.) which in Windows is WTF-8</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Dec 22 2022 14:10:53 GMT-0800 (Pacific Standard Time)">22:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yes let's see how far stringref gets</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Dec 22 2022 14:11:43 GMT-0800 (Pacific Standard Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">also note Wasm components will also want this kind of guarantee for strings</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Dec 22 2022 14:11:55 GMT-0800 (Pacific Standard Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">wasm components is the thing I meant yeah</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Dec 22 2022 14:13:01 GMT-0800 (Pacific Standard Time)">22:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">but in short, we don't need to worry too much about it initially, but it would be nice if there's a clear implementation path to speak to here</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Dec 22 2022 14:13:51 GMT-0800 (Pacific Standard Time)">22:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i believe there is for v8</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Dec 22 2022 14:14:11 GMT-0800 (Pacific Standard Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">given that it's non-trivial if you care about the performance in the limit, should confirm with others</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Dec 22 2022 14:14:56 GMT-0800 (Pacific Standard Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">I mean there's no reason to be doing non-trivial work before christmas...</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Dec 22 2022 14:15:05 GMT-0800 (Pacific Standard Time)">22:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@guybedford:matrix.org">guybedford</span>&gt;</div></td><td class="msg-cell">but glad to hear that</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Dec 22 2022 14:15:20 GMT-0800 (Pacific Standard Time)">22:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think Wasm strings integration into various toolchains are likely to be a lot more important for performance than this function</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Dec 22 2022 14:16:29 GMT-0800 (Pacific Standard Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">true enough, i'm not sure how important the JS integration performance is for any performance-critical wasm workloads right now</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Dec 22 2022 14:16:40 GMT-0800 (Pacific Standard Time)">22:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">in the future i expect this to be important</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Dec 22 2022 14:28:42 GMT-0800 (Pacific Standard Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">seems plausible that you might end up wanting to keep track of the "are there surrogates" bit for wasm integration anyway</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Dec 22 2022 15:51:40 GMT-0800 (Pacific Standard Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think deeper JS/Wasm integration and Wasm component model are sort of a similar order of magnitude away from being performance-critical issues (that is to say, probably not today)</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Dec 22 2022 15:52:05 GMT-0800 (Pacific Standard Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but that doesn't mean we shouldn't design towards it</td></tr>

</tbody></table></div></div></div>
</body></html>