<!DOCTYPE html><html><head>
  <title>TC39 General on 2022-12-06</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 General";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 General<br>2022-12-06<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-12-05" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 General">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 05 2022 20:56:08 GMT-0800 (Pacific Standard Time)">04:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell"><span class="nick-3">James M Snell</span>: BTW I think it would be really cool if there were some sort of language feature (?) where we could give a BufferSource to platform APIs and say "please transfer this to yourself, I won't use it" and then they wouldn't need to do copies. It's hard to imagine how it would work though... there's nothing straightforward, like there is in languages with move semantics that parameters can declare themselves as having.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 05 2022 20:56:49 GMT-0800 (Pacific Standard Time)">04:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">I guess if we were starting from scratch maybe we'd design every BufferSource-taking API as transferring, and ask you to make a copy if you plan to use it later?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 05 2022 20:58:20 GMT-0800 (Pacific Standard Time)">04:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">But something like <code>new Response(body.take())</code> or <code>new Response(take body)</code> or something would be neat, where it's a call-site opt-in. I guess maybe <code>new Response(body.transfer())</code> (with <a href="https://github.com/tc39/proposal-arraybuffer-transfer">https://github.com/tc39/proposal-arraybuffer-transfer</a>) is possible for a highly-integrated platform + JS engine to recognize and optimize, but that's a hard lift.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Dec 05 2022 21:10:01 GMT-0800 (Pacific Standard Time)">05:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yeah definitely difficult. For apis like the Request and Response constructors we could probably get away with a new option that communicates the intent, e.g. `new Response(buf, { transfer: true })`... but that's difficult to do consistently for all apis. </td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Dec 05 2022 21:12:56 GMT-0800 (Pacific Standard Time)">05:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I certainly wouldn't mind a language level take/move type construct tho</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Dec 05 2022 21:15:10 GMT-0800 (Pacific Standard Time)">05:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">Yeah and it feels unfortunate to have to program it in one-off for each API. Then you have to litigate whether that API's really in the fast-path or not, and that'll have different answers for web vs. server... this feels like an area where the language can come in and just say "now there's a global fast thing available" because it doesn't have to judge.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Dec 05 2022 21:16:58 GMT-0800 (Pacific Standard Time)">05:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I wonder how hard the <code>new Response(body.transfer())</code> pattern actually is to optimize</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Dec 05 2022 21:17:00 GMT-0800 (Pacific Standard Time)">05:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">I guess the most feasible path would be trying to hack on an engine to see how optimizable <code>new Response(body.transfer())</code> can be, and then whether that hack can be generalized, or if generalizing it would benefit from some annotation (ideally in IDL to do code-gen for all BufferSource cases)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Dec 05 2022 21:17:41 GMT-0800 (Pacific Standard Time)">05:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">I think the difficulty is not as much technical as "codebase-organizational" in that the teams that implement <code>new Response()</code> are pretty far from the teams that implement the JS engine, and want to operate without too much interaction and intertwingling of code.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Dec 05 2022 21:18:39 GMT-0800 (Pacific Standard Time)">05:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I'm imagining an internal bit on array buffers which is like "this is not aliased anywhere", which could be checked by platform APIs</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Dec 05 2022 21:19:15 GMT-0800 (Pacific Standard Time)">05:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">So the JS engine people could be responsible for figuring out how to set that bit, and the platform people would just need to check it</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Dec 05 2022 21:19:24 GMT-0800 (Pacific Standard Time)">05:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Don't actually know if that's at all feasible though.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Dec 05 2022 21:19:36 GMT-0800 (Pacific Standard Time)">05:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">Yeah if you could pull that off it seems pretty reasonable.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Dec 06 2022 00:45:21 GMT-0800 (Pacific Standard Time)">08:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But something like <code>new Response(body.take())</code> or <code>new Response(take body)</code> or something would be neat, where it's a call-site opt-in. I guess maybe <code>new Response(body.transfer())</code> (with <a href="https://github.com/tc39/proposal-arraybuffer-transfer">https://github.com/tc39/proposal-arraybuffer-transfer</a>) is possible for a highly-integrated platform + JS engine to recognize and optimize, but that's a hard lift.</blockquote></mx-reply>Yeah - we’ve been thinking about this a lot for Deno. The least invasive solution we’ve been able to come up with so far is copy-on-write clones, but unfortunately V8 looks unlikely to implement these due to security concerns</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Dec 06 2022 00:47:05 GMT-0800 (Pacific Standard Time)">08:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I wonder how hard the <code>new Response(body.transfer())</code> pattern actually is to optimize</blockquote></mx-reply>I can’t speak for all runtimes, but for Deno this would maybe be a 100 LOC change after we’ve specified the behavior</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Dec 06 2022 00:47:23 GMT-0800 (Pacific Standard Time)">08:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">It doesn’t seem very difficult</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Dec 06 2022 00:49:22 GMT-0800 (Pacific Standard Time)">08:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">Oh actually I think I misunderstood - the idea for the optimization is to prevent the clone in <code>new Response</code> because they passed in buffer is “fresh” and not anymore accessible by any other JS? This would be much more difficult, maybe impossible at our current integration level with V8</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Dec 06 2022 00:52:24 GMT-0800 (Pacific Standard Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">Would it be that difficult? You could use the <code>BackingStore</code> as the "owned buffer".</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Dec 06 2022 00:53:34 GMT-0800 (Pacific Standard Time)">08:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">The issue that we've been thinking about a lot for Deno is that there are a number of async APIs that take buffers, and those can lead to data races</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Dec 06 2022 07:40:45 GMT-0800 (Pacific Standard Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">yes, that would be difficult for an API to tell its argument is in fact not aliased without some pretty deep VM support exposed at the API boundary, if there's no language equivalent to, like, rvalue references</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Dec 06 2022 07:41:28 GMT-0800 (Pacific Standard Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">dynamic rvalue references also does not seem like a thing that anyone would want to implement</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Dec 06 2022 07:41:51 GMT-0800 (Pacific Standard Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">well, i guess it doesn't have to be dynamic</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Dec 06 2022 07:42:01 GMT-0800 (Pacific Standard Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">can we just transition to refcounting? that makes alias detection easier.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Dec 06 2022 07:42:37 GMT-0800 (Pacific Standard Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@shuyuguo:matrix.org">shu</span>&gt;</div></td><td class="msg-cell">i hear refcounting is also faster</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Dec 06 2022 07:42:51 GMT-0800 (Pacific Standard Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">totally</td></tr>

</tbody></table></div></div></div>
</body></html>