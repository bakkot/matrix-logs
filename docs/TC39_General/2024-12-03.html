<!DOCTYPE html><html><head>
  <title>TC39 General on 2024-12-03</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 General";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 General<br>2024-12-03<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-12-01" class="nav-link"><span>prev</span></a>
<a href="2024-12-04" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 General">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 02 2024 21:01:57 GMT-0800 (Pacific Standard Time)">05:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><p>Hi all, new guy here!</p>
<p>I'm entertaining the idea of opening a proposal but wanted to get a sense on how the community feels about the concept before I commit a weekend to writing it out - haha.</p>
<p>Generally, it's the concept of the incorporation of Rust-inspired static macros. Macos are functions that take tokens and return static ECMAScript, similar to a template literal + eval however with LSP support and without the need for eval.</p>
<p>All macros would be defined by users, none defined in the language.</p>
<pre><code class="language-javascript">// Parse tokens and generate React.createElement() calls
const Foo = () =&gt; jsx!(&lt;div&gt;Hello World&lt;/div&gt;)

// Create a getter/setter for a property
class Bar {
  #[observe]
  baz = undefined
}
</code></pre>
<p>The syntax itself can be changed, I am just defaulting to Rust syntax for familiarity, but something like <code>jsx!()</code> could be <code>~jsx()</code> or anything (to avoid conflicts), I'm not opinionated here</p>
<p>While I know ECMAScript is not a compiled language, there are interesting use cases like;</p>
<ul>
<li>Enabling support for jsx/other templating languages without an external preprocessor/eval</li>
<li>Macro annotations that facilitate more ergonomic mutation observability leading to more ergonomic syntax for frameworks like Vue/Angular</li>
<li>A reduced need for custom compilers (ngc, .vue, .svelte)</li>
<li>More ergonomic usage for tools like protobuf</li>
<li>etc</li>
</ul>
<p>This would also lead to support in preprocessors like TypeScript which <em>could</em> statically compile macros - offering an interesting/novel hybrid macro system.</p>
<p>Any thoughts on the concept?</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 02 2024 21:12:12 GMT-0800 (Pacific Standard Time)">05:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">For the "create a getter/setter" example, that looks like it can be accomplished via a decorator <a href="https://github.com/tc39/proposal-decorators">https://github.com/tc39/proposal-decorators</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 02 2024 21:16:57 GMT-0800 (Pacific Standard Time)">05:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">Hi and welcome btw üëãüèª&nbsp;</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Dec 02 2024 21:22:43 GMT-0800 (Pacific Standard Time)">05:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><p>Yes, I do agree that this idea shares utility with decorators however, due to the static nature of macros (accept tokens, return ecmascript), it expands the concept in various ways, like;</p>
<ul>
<li>Opening a path for preprocessors (like TypeScript, swc, probably v8) to do AoT compilation leading to applications being faster at runtime</li>
<li>Incorporating the annotatability of variable assignments as well as class properties</li>
<li>Runtime (and potentially AoT) transformation of tokens which allows parsing (and LSP support) for jsx, templating languages and even data formats like yaml, xml, protobuf, etc</li>
<li>Many more use cases</li>
</ul>
<pre><code class="language-javascript">const vueComponent = {
  template: vue!(&lt;div&gt;Hello {{data.world}}&lt;/div&gt;),
  data: () =&gt; ({ world: 'World' })
}

const contents = yaml!(foo: 'bar')
// Expands to
// const contents = { foo: 'bar' }
</code></pre>
<p>LSPs would see the expanded form of macros and the macro implementation would define where errors occur in a transformation.</p>
<p>In the Rust world, this has been used to great effect to create GUI frameworks with vastly different approaches without preprocessors, some resembling React, others Vue:</p>
<ul>
<li>Web wasm frameworks <a href="https://yew.rs/">[1]</a> <a href="https://leptos.dev/">[2]</a></li>
<li>Native desktop frameworks <a href="https://github.com/Relm4/Relm4?tab=readme-ov-file#a-simple-counter-app">[1]</a> <a href="https://iced.rs/">[2]</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Dec 02 2024 21:58:51 GMT-0800 (Pacific Standard Time)">05:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">I am curious how things like auto-complete and refactoring work within Rust macros. These both sound easier for tooling to implement when the language extension is concrete, instead of being defined as a macro.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Dec 02 2024 22:21:11 GMT-0800 (Pacific Standard Time)">06:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><p>For autocomplete, the LSP expands the macro and uses the output</p>
<pre><code class="language-javascript">const foo = add!(1, 1)
</code></pre>
<p>Would expand into</p>
<pre><code class="language-javascript">const foo = 2
</code></pre>
<p>So consumers see it as a <code>number</code> rather than a macro. It simply replaces itself with the transformed result.</p>
<p>As for refactoring; when someone implements a macro, they parse "tokens" which they move around into the equivalent valid language syntax.</p>
<p>The editor can unwind that to determine what to update - though there are some macros that are too complex and refactoring tools bail out.</p>
<p>Implementers can also throw during parsing, which bubbles up to the editor, showing errors in the correct place in the macro</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Dec 02 2024 22:31:50 GMT-0800 (Pacific Standard Time)">06:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">For auto-complete, when the macro is expanded, how is the IDE cursor position preserved?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Dec 02 2024 22:32:36 GMT-0800 (Pacific Standard Time)">06:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">the position could expand to a much larger block of code&nbsp;</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Dec 02 2024 22:34:29 GMT-0800 (Pacific Standard Time)">06:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">the expanded code would also lack type annotations, meaning TypeScript would only be able to infer what might be a correct auto complete&nbsp;</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Dec 02 2024 22:38:06 GMT-0800 (Pacific Standard Time)">06:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>These both sound easier for tooling to implement when the language extension is concrete</p>
</blockquote>
<p>Macros are more of a preprocessing step rather than dynamic functionality (like decorators) - but there's a chicken and egg problem.</p>
<p>The best supported illustration of macros in tooling is the built-in transformation of jsx in TypeScript. There are many GitHub issues requesting to expand this to offer custom programmatic macros however it's has been deemed out of scope.</p>
<p>Attempts by other toolmakers to implement the functionality that macros offer have resulted in fragmented, brittle implementations (.vue files and .svelte files - custom tooling, editor plugins and poor support for test runners, linters, formatters, etc).</p>
<p>Decorators also feel like an attempt at addressing the same problem albeit at runtime.</p>
<p>After spending some time in the Rust world, I personally feel that there is evidence that the ES world shows a need for this type of functionality</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Dec 02 2024 22:40:37 GMT-0800 (Pacific Standard Time)">06:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>the expanded code would also lack type annotations, meaning TypeScript would only be able to infer what might be a correct auto complete</p>
</blockquote>
<p>It's likely that TypeScript would compile macros into TypeScript at compile time (and in the editor, like they do with jsx), where the emitted runtime code would be the static JavaScript equivalent</p>
<p>That said, if they simply strip the types and leave macros to be evaluated at runtime, then perhaps type information would be an issue</p>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Dec 02 2024 22:42:18 GMT-0800 (Pacific Standard Time)">06:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">I'm also wondering for tools like swc, it wouldn't be able to execute the macros natively in Rust. It would need to delegate to JS adding overhead that negates the tools desire for speed</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Dec 02 2024 22:43:03 GMT-0800 (Pacific Standard Time)">06:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">Unlike with Rust macros where the compiler naturally understands how to execute Rust</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Dec 02 2024 22:45:38 GMT-0800 (Pacific Standard Time)">06:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>I'm also wondering for tools like swc, it wouldn't be able to execute the macros natively in Rust. It would need to delegate to JS adding overhead that negates the tools desire for speed</p>
</blockquote>
<p>Calling into Nodejs is not as fast as running Rust native code directly and there is overhead in crossing from Rust to Nodejs, but it wouldn't be a substantial performance hit (can do hundreds of millions of nodejs calls per second).</p>
<p>There are also options like embedding Deno, <a href="https://bellard.org/quickjs/">QuickJS</a> or <a href="https://github.com/awslabs/llrt">llrt</a> for macros that don't use niche nodejs functionality</p>
<p>If callable macros are defined using a templating syntax (like in Rust) then an interpreter could be written (or borrowed directly from an existing JS engine) and run entirely in Rust <a href="https://doc.rust-lang.org/book/ch19-06-macros.html#declarative-macros-with-macro_rules-for-general-metaprogramming">example</a></p>
</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Dec 02 2024 22:51:50 GMT-0800 (Pacific Standard Time)">06:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell">Also, I really appreciate you entertaining this idea and asking such great questions üôÇ</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Dec 02 2024 22:53:07 GMT-0800 (Pacific Standard Time)">06:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>For auto-complete, when the macro is expanded, how is the IDE cursor position preserved?</p>
</blockquote>
<p>If I get to the point where a proposal is actually on the cards, I will certainly dig deeper into how Rust does this to provide a clearer answer</p>
</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Dec 02 2024 23:32:06 GMT-0800 (Pacific Standard Time)">07:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">rust macros have some really unfortunate limitations tho - in particular, it seems they can't handle anywhere close to the level of expressiveness and dynamism i'd expect coming from JS</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Dec 03 2024 08:58:28 GMT-0800 (Pacific Standard Time)">16:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">there are two kinds of rust macros; for the cases where the normal macros aren't expressive enough, you can write a procedural macro to literally bypass the parser and operate on a stream of tokens from the lexer</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Dec 03 2024 08:59:08 GMT-0800 (Pacific Standard Time)">16:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@pchimento:igalia.com">ptomato</span>&gt;</div></td><td class="msg-cell">(and the JS equivalent of <em>that</em> starts to sound like <a href="https://github.com/tc39/proposal-binary-ast">https://github.com/tc39/proposal-binary-ast</a>)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Dec 03 2024 09:02:29 GMT-0800 (Pacific Standard Time)">17:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">and even with that i still haven't been able to get what i want to do, done :-/ i'm sure it's a mix of lacking capability in both self and language</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Dec 03 2024 09:03:22 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">what haven't you been able to do with proc macros?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Dec 03 2024 09:05:46 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">David Alsh</span>: macros in the language mean moving complexity and build time from the developer's computer to the user's computer, which I think is very negative</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Dec 03 2024 09:05:59 GMT-0800 (Pacific Standard Time)">17:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">as a developer it's obviously appealing, but in terms of its effects on the world I think it would be very bad</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Dec 03 2024 09:06:10 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">Proc macros can generate arbitrary Rust code by executing arbitrary Rust code taking arbitrary lexer tokens as inputs. They are turing complete - there is nothing they can not do</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Dec 03 2024 09:07:58 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">they can't properly attribute error locations :P</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Dec 03 2024 09:08:08 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">They can in nightly :D</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Dec 03 2024 09:08:20 GMT-0800 (Pacific Standard Time)">17:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@michaelficarra:matrix.org">Michael Ficarra</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote>Proc macros can generate arbitrary Rust code by executing arbitrary Rust code taking arbitrary lexer tokens as inputs. They are turing complete - there is nothing they can not do</blockquote></mx-reply>there's a ton of things that Turing machines cannot do</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Dec 03 2024 09:09:12 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">Sure. Then more accurately: they have all the same capabilities as any other Rust program (because they are a special kind of Rust program)</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Dec 03 2024 09:09:56 GMT-0800 (Pacific Standard Time)">17:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">then that probably means that rust's type system can't do what i want :-p</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Dec 03 2024 09:48:27 GMT-0800 (Pacific Standard Time)">17:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@sirisian:matrix.org">sirisian</span>&gt;</div></td><td class="msg-cell">I started looking at code generation (like C#) before to see how it could function in JS and it has similar issues as it moves what might be build-time to the user's computer which as mentioned is contentious.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Dec 03 2024 13:01:03 GMT-0800 (Pacific Standard Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Hey all, just doing some sketching out on a proposal for a <code>Promise.lazy(fn)</code> API (<a href="https://github.com/jasnell/proposal-promise-lazy">https://github.com/jasnell/proposal-promise-lazy</a>) ... the idea is to simplify a pattern that is currently possible to do with custom thenables with a fair amount of boilerplate. This is very early and not yet ready for in committee discussion but I'd like to invite folks to take a look at provide early feedback. I'll likely raise it for in-committee discussion for the next scheduled plenary</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Dec 03 2024 13:16:03 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Hey all, just doing some sketching out on a proposal for a <code>Promise.lazy(fn)</code> API (<a href="https://github.com/jasnell/proposal-promise-lazy">https://github.com/jasnell/proposal-promise-lazy</a>) ... the idea is to simplify a pattern that is currently possible to do with custom thenables with a fair amount of boilerplate. This is very early and not yet ready for in committee discussion but I'd like to invite folks to take a look at provide early feedback. I'll likely raise it for in-committee discussion for the next scheduled plenary</blockquote></mx-reply>neat</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Dec 03 2024 13:18:38 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">one thing to consider: <code>Promise.resolve</code> (which is also used in the <code>await</code> syntax) has a special case for "real" promises (which works by checking the <code>.constructor</code> property), and you'd need to consider whether this would count</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Dec 03 2024 13:18:51 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I am pretty sure this is a not going to be acceptable to some delegates, including us. Promises are one-way, and I don't want them to grow a back channel</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Dec 03 2024 13:19:23 GMT-0800 (Pacific Standard Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I am pretty sure this is a not going to be acceptable to some delegates, including us. Promises are one-way, and I don't want them to grow a back channel</blockquote></mx-reply>it's not adding them to actual promises</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Dec 03 2024 13:19:29 GMT-0800 (Pacific Standard Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">it's making a new kind of thenable, which you could already do in userland</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Dec 03 2024 13:19:54 GMT-0800 (Pacific Standard Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">We actually go through a great extent to protect against promises with a custom then or then getter in our environment.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Dec 03 2024 13:20:52 GMT-0800 (Pacific Standard Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Right, nothing prevents anyone from making a new thenable, but that's not a promise</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Dec 03 2024 13:21:16 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">well, ok, call it LazyPromise and make it a subclass instead of <code>Promise.lazy</code> then</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Dec 03 2024 13:21:22 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">that seems like a stage 2 concern</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Dec 03 2024 13:21:38 GMT-0800 (Pacific Standard Time)">21:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><code>Promise.resolve()</code> which is extensively used to check if something is a promise would trigger the laziness</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Dec 03 2024 13:22:37 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">¬Ø\_(„ÉÑ)_/¬Ø seems fine</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Dec 03 2024 13:22:54 GMT-0800 (Pacific Standard Time)">21:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I very much contest "extensively" though</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Dec 03 2024 13:23:02 GMT-0800 (Pacific Standard Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I would buy "extensively in our extremely unusual codebase"</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Dec 03 2024 13:23:27 GMT-0800 (Pacific Standard Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Right I might have a miopic vision here.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Dec 03 2024 13:23:46 GMT-0800 (Pacific Standard Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell"><code>await</code> does feel like the wrong place to start work</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Dec 03 2024 13:24:05 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">fwiw that's how it works in Rust and it's fine</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Dec 03 2024 13:24:59 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Well, to be clear, per the proposal, the work is not started on the <code>await</code> (or the .then call). The actual work is deferred as a microtask.</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Dec 03 2024 13:25:26 GMT-0800 (Pacific Standard Time)">21:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">oh I jumped to the wrong assumption</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Dec 03 2024 13:26:02 GMT-0800 (Pacific Standard Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><span class="nick-2">Mathieu Hofman</span>: ... I get the objection... if these were brand-checkable would that make a difference to you? e.g. something like <code>const p = Promise.lazy(...); if (Promise.isLazy(p) { ... }</code></td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Dec 03 2024 13:26:10 GMT-0800 (Pacific Standard Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">FYI that <code>class LazyPromise</code> example doesn't work correctly when <code>then</code> is called multiple times (which re-inforces that it's hard to actually get this right)</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Dec 03 2024 13:26:51 GMT-0800 (Pacific Standard Time)">21:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> FYI that <code>class LazyPromise</code> example doesn't work correctly when <code>then</code> is called multiple times (which re-inforces that it's hard to actually get this right)</blockquote></mx-reply>yep, it was a quick example. didn't go through all the necessary boilerplate to make to complete</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Dec 03 2024 13:27:15 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">deferred to a microtask after the await or then call, right ?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Dec 03 2024 13:27:58 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> deferred to a microtask after the await or then call, right ?</blockquote></mx-reply>Yes. When the reaction is added, the callback is deferred to the microtask at that point</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Dec 03 2024 13:29:54 GMT-0800 (Pacific Standard Time)">21:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">do you have some example use cases for this?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Dec 03 2024 13:31:53 GMT-0800 (Pacific Standard Time)">21:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> do you have some example use cases for this?</blockquote></mx-reply>I need to work up a few more of the examples but the use case that prompted this for me was a work queue built around custom thenables that ended up having a fair amount of boilerplate to get right (for instance, <span class="nick-2">Mathieu Hofman</span>'s comment about about the LazyPromise example needing a lot more to be safe)</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Dec 03 2024 13:32:22 GMT-0800 (Pacific Standard Time)">21:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> do you have some example use cases for this?</blockquote></mx-reply>(there is one example at the bottom of the readme, in case you didn't see that it down there)</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Dec 03 2024 13:33:19 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">i feel like this example is a meta example</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Dec 03 2024 13:33:38 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">now i'm curious what you would put into this queue in practice</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Dec 03 2024 13:33:39 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">would a generator help there?</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Dec 03 2024 13:33:51 GMT-0800 (Pacific Standard Time)">21:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">yeah that example is lacking. One of my key tasks before bringing this officially to the committee is to expand the use cases and examples</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Dec 03 2024 13:34:06 GMT-0800 (Pacific Standard Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@michaelficarra:matrix.org">Michael Ficarra</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote>I need to work up a few more of the examples but the use case that prompted this for me was a work queue built around custom thenables that ended up having a fair amount of boilerplate to get right (for instance, <span class="nick-2">Mathieu Hofman</span>'s comment about about the LazyPromise example needing a lot more to be safe)</blockquote></mx-reply>how about we just provide a built-in work queue instead?</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Dec 03 2024 13:34:34 GMT-0800 (Pacific Standard Time)">21:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@michaelficarra:matrix.org">Michael Ficarra</span>&gt;</div></td><td class="msg-cell">(I am already considering doing this btw)</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Dec 03 2024 13:35:01 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> would a generator help there?</blockquote></mx-reply>This was about 8 months or so ago that I first started thinking about this and at the time we did end up moving the code to a generator to improve things but even then it was still a fair amount of boilerplate. It definitely helped that case tho</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Dec 03 2024 13:35:23 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">i look forward to seeing some. i don't think i have ever (in js or rust) needed to take advantage of executor lazyness in a way that semantically matters.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Dec 03 2024 13:35:40 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> i look forward to seeing some. i don't think i have ever (in js or rust) needed to take advantage of executor lazyness in a way that semantically matters.</blockquote></mx-reply>Fair</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Dec 03 2024 13:35:40 GMT-0800 (Pacific Standard Time)">21:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">only for performance optimization</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Dec 03 2024 13:36:22 GMT-0800 (Pacific Standard Time)">21:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I'll have that (better documenting the use cases) at the top of the todo list then before moving this forward</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Dec 03 2024 13:37:57 GMT-0800 (Pacific Standard Time)">21:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">they feel similar to a memo'ed lazy 0-arg async function. Where the trigger is an explicit call.
The lazy promise looks useful when the code needs to be generic. Would be good to see an example where the code wouldn't have worked with a regular lazy function</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Dec 03 2024 13:38:49 GMT-0800 (Pacific Standard Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">this sort of reminds me about the disagreement over iterator reuse, though maybe i'm over-generalizing. </td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Dec 03 2024 13:40:58 GMT-0800 (Pacific Standard Time)">21:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">as long as we don't add a <code>.then</code> to async functions so that we have both Then-ables and Then-ors</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Dec 03 2024 13:46:17 GMT-0800 (Pacific Standard Time)">21:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> as long as we don't add a <code>.then</code> to async functions so that we have both Then-ables and Then-ors</blockquote></mx-reply>oh no no no... definitely not</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Dec 03 2024 13:47:06 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">thenerators</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Dec 03 2024 13:47:10 GMT-0800 (Pacific Standard Time)">21:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">the motivation for this is not to add anything that cannot currently already be done with custom thenables, it's just to make it easier to implement that pattern more correctly and with less boilerplate</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Dec 03 2024 13:48:32 GMT-0800 (Pacific Standard Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell">i think you can trick v8 into emitting negative line numbers</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Dec 03 2024 13:48:36 GMT-0800 (Pacific Standard Time)">21:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">I'm trying to work out if it composes with <a href="https://github.com/tc39/proposal-concurrency-control">https://github.com/tc39/proposal-concurrency-control</a>, but it's been a long day</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Dec 03 2024 13:49:19 GMT-0800 (Pacific Standard Time)">21:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">ljharb</span>: <a href="https://gc.gy/5787c068-7972-4c5b-bc38-dc39b7704308.png">https://gc.gy/5787c068-7972-4c5b-bc38-dc39b7704308.png</a></td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Dec 03 2024 14:01:46 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-14" title="@michaelficarra:matrix.org">Michael Ficarra</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote>I'm trying to work out if it composes with <a href="https://github.com/tc39/proposal-concurrency-control">https://github.com/tc39/proposal-concurrency-control</a>, but it's been a long day</blockquote></mx-reply>I have a secret prototype task queue that I will share some day</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Dec 03 2024 14:02:42 GMT-0800 (Pacific Standard Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><p>I think so? Something like</p>
<pre><code>let governor = new CountingGovernor(5);

let tasks = data.map(
  x =&gt; Promise.resolve(x)
    .lazyThen(async () =&gt; { using _ = await governor.acquire(); return await doWork(x); }
);
</code></pre>
<p>this gives you: task are not started until first polled, and no matter how many are being polled no more than 5 can be doing work at a time</p>
</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Dec 03 2024 14:02:59 GMT-0800 (Pacific Standard Time)">22:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">but a real task queue would still be better I expect</td></tr>

</tbody></table></div></div></div>
</body></html>