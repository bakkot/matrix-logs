<!DOCTYPE html><html><head>
  <title>TC39 General on 2024-12-03</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 General";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 General<br>2024-12-03<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-12-01" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 General">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Dec 02 2024 21:01:57 GMT-0800 (Pacific Standard Time)">05:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><p>Hi all, new guy here!</p>
<p>I'm entertaining the idea of opening a proposal but wanted to get a sense on how the community feels about the concept before I commit a weekend to writing it out - haha.</p>
<p>Generally, it's the concept of the incorporation of Rust-inspired static macros. Macos are functions that take tokens and return static ECMAScript, similar to a template literal + eval however with LSP support and without the need for eval.</p>
<p>All macros would be defined by users, none defined in the language.</p>
<pre><code class="language-javascript">// Parse tokens and generate React.createElement() calls
const Foo = () =&gt; jsx!(&lt;div&gt;Hello World&lt;/div&gt;)

// Create a getter/setter for a property
class Bar {
  #[observe]
  baz = undefined
}
</code></pre>
<p>The syntax itself can be changed, I am just defaulting to Rust syntax for familiarity, but something like <code>jsx!()</code> could be <code>~jsx()</code> or anything (to avoid conflicts), I'm not opinionated here</p>
<p>While I know ECMAScript is not a compiled language, there are interesting use cases like;</p>
<ul>
<li>Enabling support for jsx/other templating languages without an external preprocessor/eval</li>
<li>Macro annotations that facilitate more ergonomic mutation observability leading to more ergonomic syntax for frameworks like Vue/Angular</li>
<li>A reduced need for custom compilers (ngc, .vue, .svelte)</li>
<li>More ergonomic usage for tools like protobuf</li>
<li>etc</li>
</ul>
<p>This would also lead to support in preprocessors like TypeScript which <em>could</em> statically compile macros - offering an interesting/novel hybrid macro system.</p>
<p>Any thoughts on the concept?</p>
</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Dec 02 2024 21:12:12 GMT-0800 (Pacific Standard Time)">05:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">For the "create a getter/setter" example, that looks like it can be accomplished via a decorator <a href="https://github.com/tc39/proposal-decorators">https://github.com/tc39/proposal-decorators</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Dec 02 2024 21:16:57 GMT-0800 (Pacific Standard Time)">05:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">Hi and welcome btw üëãüèª&nbsp;</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Dec 02 2024 21:22:43 GMT-0800 (Pacific Standard Time)">05:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><p>Yes, I do agree that this idea shares utility with decorators however, due to the static nature of macros (accept tokens, return ecmascript), it expands the concept in various ways, like;</p>
<ul>
<li>Opening a path for preprocessors (like TypeScript, swc, probably v8) to do AoT compilation leading to applications being faster at runtime</li>
<li>Incorporating the annotatability of variable assignments as well as class properties</li>
<li>Runtime (and potentially AoT) transformation of tokens which allows parsing (and LSP support) for jsx, templating languages and even data formats like yaml, xml, protobuf, etc</li>
<li>Many more use cases</li>
</ul>
<pre><code class="language-javascript">const vueComponent = {
  template: vue!(&lt;div&gt;Hello {{data.world}}&lt;/div&gt;),
  data: () =&gt; ({ world: 'World' })
}

const contents = yaml!(foo: 'bar')
// Expands to
// const contents = { foo: 'bar' }
</code></pre>
<p>LSPs would see the expanded form of macros and the macro implementation would define where errors occur in a transformation.</p>
<p>In the Rust world, this has been used to great effect to create GUI frameworks with vastly different approaches without preprocessors, some resembling React, others Vue:</p>
<ul>
<li>Web wasm frameworks <a href="https://yew.rs/">[1]</a> <a href="https://leptos.dev/">[2]</a></li>
<li>Native desktop frameworks <a href="https://github.com/Relm4/Relm4?tab=readme-ov-file#a-simple-counter-app">[1]</a> <a href="https://iced.rs/">[2]</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Dec 02 2024 21:58:51 GMT-0800 (Pacific Standard Time)">05:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">I am curious how things like auto-complete and refactoring work within Rust macros. These both sound easier for tooling to implement when the language extension is concrete, instead of being defined as a macro.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Dec 02 2024 22:21:11 GMT-0800 (Pacific Standard Time)">06:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><p>For autocomplete, the LSP expands the macro and uses the output</p>
<pre><code class="language-javascript">const foo = add!(1, 1)
</code></pre>
<p>Would expand into</p>
<pre><code class="language-javascript">const foo = 2
</code></pre>
<p>So consumers see it as a <code>number</code> rather than a macro. It simply replaces itself with the transformed result.</p>
<p>As for refactoring; when someone implements a macro, they parse "tokens" which they move around into the equivalent valid language syntax.</p>
<p>The editor can unwind that to determine what to update - though there are some macros that are too complex and refactoring tools bail out.</p>
<p>Implementers can also throw during parsing, which bubbles up to the editor, showing errors in the correct place in the macro</p>
</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Dec 02 2024 22:31:50 GMT-0800 (Pacific Standard Time)">06:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">For auto-complete, when the macro is expanded, how is the IDE cursor position preserved?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Dec 02 2024 22:32:36 GMT-0800 (Pacific Standard Time)">06:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">the position could expand to a much larger block of code&nbsp;</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Dec 02 2024 22:34:29 GMT-0800 (Pacific Standard Time)">06:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">the expanded code would also lack type annotations, meaning TypeScript would only be able to infer what might be a correct auto complete&nbsp;</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Dec 02 2024 22:38:06 GMT-0800 (Pacific Standard Time)">06:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>These both sound easier for tooling to implement when the language extension is concrete</p>
</blockquote>
<p>Macros are more of a preprocessing step rather than dynamic functionality (like decorators) - but there's a chicken and egg problem.</p>
<p>The best supported illustration of macros in tooling is the built-in transformation of jsx in TypeScript. There are many GitHub issues requesting to expand this to offer custom programmatic macros however it's has been deemed out of scope.</p>
<p>Attempts by other toolmakers to implement the functionality that macros offer have resulted in fragmented, brittle implementations (.vue files and .svelte files - custom tooling, editor plugins and poor support for test runners, linters, formatters, etc).</p>
<p>Decorators also feel like an attempt at addressing the same problem albeit at runtime.</p>
<p>After spending some time in the Rust world, I personally feel that there is evidence that ES world shows a need for this type of functionality</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Dec 02 2024 22:40:37 GMT-0800 (Pacific Standard Time)">06:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@alshdavid:matrix.org">David Alsh</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>the expanded code would also lack type annotations, meaning TypeScript would only be able to infer what might be a correct auto complete</p>
</blockquote>
<p>It's likely that TypeScript would compile macros into TypeScript at compile time (and in the editor, like they do with jsx), where the emitted runtime code would be the static JavaScript equivalent</p>
<p>That said, if they simply strip the types and leave macros to be evaluated at runtime, then perhaps type information would be an issue</p>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Dec 02 2024 22:42:18 GMT-0800 (Pacific Standard Time)">06:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">I'm also wondering for tools like swc, it wouldn't be able to execute the macros natively in Rust. It would need to delegate to JS adding overhead that negates the tools desire for speed</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Dec 02 2024 22:43:03 GMT-0800 (Pacific Standard Time)">06:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@aclaymore:matrix.org">Ashley Claymore</span>&gt;</div></td><td class="msg-cell">Unlike with Rust macros where the compiler naturally understands how to execute Rust</td></tr>

</tbody></table></div></div></div>
</body></html>