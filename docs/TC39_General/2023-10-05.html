<!DOCTYPE html><html><head>
  <title>TC39 General on 2023-10-05</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 General";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 General<br>2023-10-05<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-10-04" class="nav-link"><span>prev</span></a>
<a href="2023-10-09" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 General">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Oct 04 2023 17:43:40 GMT-0700 (Pacific Daylight Time)">00:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Hello all. I've got a proposal that I'd like to surface for consideration. I put this together after speaking a bit with Matteo Collina and @ljharb... The fundamental idea is to introduce a mechanism for zero-copy concatenation of <code>ArrayBuffer</code> in a way that allows the result to still be an <code>ArrayBuffer</code> that can be wrapped with a <code>TypedArray</code>. The explainer is here: <a href="https://github.com/jasnell/proposal-zero-copy-arraybuffer-list/blob/main/README.md">https://github.com/jasnell/proposal-zero-copy-arraybuffer-list/blob/main/README.md</a></p>
<p>For a quick example:</p>
<p>const ab1 = new ArrayBuffer(10);<br>const ab2 = new ArrayBuffer(20);<br>const combined = ArrayBuffer.of(ab1, ab2);<br>const u8 = new Uint8Array(combined);</p>
<p>Here, <code>combined</code> is effectively a list of the component <code>ArrayBuffer</code> instances that is itself an <code>ArrayBuffer</code>.</p>
<p>The idea here is adapted from the very popular npm module <code>bl</code> which implements a similar idea around Node.js <code>Buffer</code> interface but in a way that still has a number of warts.</p>
<p>There is a more detailed example in the explainer. @littledan and <span class="nick-6">ljharb</span> have already graciously provided some extremely helpful feedback.</p>
</blockquote></mx-reply>Oh I've been wanting this for years. I think I wrote an issue somewhere!</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Oct 04 2023 17:50:46 GMT-0700 (Pacific Daylight Time)">00:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I also still really want CoW ArrayBuffer slices. I still do not understand how it would introduce much more complexity than the existing detached checks already required.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Oct 04 2023 18:03:04 GMT-0700 (Pacific Daylight Time)">01:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><p>Basically I want to be able to do</p>
<pre><code class="language-js">const chunks = [];
chunks.push(chunk1.slice(10));
chunks.push(chunk2);
chunks.push(chunk3.slice(0, 5));
return ArrayBuffer.of(...chunks);
</code></pre>
<p>Obviously each chunk is received in separate events / iterator yields</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Oct 04 2023 18:04:02 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">That said I do expect the new combined buffer to itself be a CoW</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Oct 04 2023 18:04:14 GMT-0700 (Pacific Daylight Time)">01:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">And not a passthrough to the underlying buffer</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Oct 04 2023 18:06:07 GMT-0700 (Pacific Daylight Time)">01:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">The proposal currently does not include CoW but I can't see a reason why it couldn't be. Will give that some thought</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Oct 04 2023 18:09:04 GMT-0700 (Pacific Daylight Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Btw, in that case it really become a <code>concat</code> and the fact that the buffer is in fact a list of smaller buffers is just an unobservable implementation detail</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Oct 04 2023 18:10:31 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">as long as we're able to preserve the zero-copy concat and zero-copy subarray, then I'm fine with that</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Oct 04 2023 18:10:46 GMT-0700 (Pacific Daylight Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Basically I'm really concerned about having multiple ArrayBuffer instances backed by the same underlying data. That's more in the realm of SharedArrayBuffer semantics</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Oct 04 2023 18:12:54 GMT-0700 (Pacific Daylight Time)">01:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">True, but to be fair host implementations already give us that ability</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Oct 04 2023 18:13:12 GMT-0700 (Pacific Daylight Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">(obviously that doesn't mean we should make it easier :-) ...)</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Oct 04 2023 18:16:45 GMT-0700 (Pacific Daylight Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I don't believe any host APIs currently expose that ability, right? I know that JS APIs don't</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Oct 04 2023 18:18:20 GMT-0700 (Pacific Daylight Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Anyway, my motivation for CoW is that I believe it would increase the performance of a ton of existing applications without requiring any code changes on their end</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Oct 04 2023 18:19:02 GMT-0700 (Pacific Daylight Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I think <span class="nick-3">Luca Casonato</span> shares that belief</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Oct 04 2023 18:19:44 GMT-0700 (Pacific Daylight Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">With v8, it's fairly trivial to extract a <code>std::shared_ptr&lt;v8::BackingStore&gt;</code> and have it shared by multiple <code>v8::ArrayBuffer</code> instances</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Oct 04 2023 18:19:56 GMT-0700 (Pacific Daylight Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Not ideal, but trivial :-)</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Oct 04 2023 18:25:25 GMT-0700 (Pacific Daylight Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think <span class="nick-3">Luca Casonato</span> shares that belief</blockquote></mx-reply>Yes, a general purpose CoW optimization for AB.slice would enable many host APIs to become significantly faster</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Oct 04 2023 18:27:14 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">I don’t think we necessarily need a new API here (I view concat as a related, but separate API - it can make sense with or without the CoW optimization)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Oct 04 2023 18:27:52 GMT-0700 (Pacific Daylight Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">The nice thing about CoW is that it’s completely unobservable</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Oct 04 2023 18:28:23 GMT-0700 (Pacific Daylight Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yeah, I'd view the proposal for <code>ArrayBuffer.of(...)</code> and CoW as orthogonal. Both nice to have but distinct</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Oct 04 2023 18:29:33 GMT-0700 (Pacific Daylight Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">If we could get CoW slice, however, there would be no need at all for the <code>ArrayBuffer.prototype.subarray(...)</code> that I suggest in the proposal</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Oct 04 2023 18:31:21 GMT-0700 (Pacific Daylight Time)">01:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Also if we had CoW, an argument could be absolutely made also that <code>ArrayBuffer.of(...)</code> should automatically slice(0, len) to ensure that the new <code>ArrayBuffer</code> is composed entirely of CoW slices</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Oct 04 2023 18:41:09 GMT-0700 (Pacific Daylight Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">I share <span class="nick-2">Mathieu Hofman</span>’s view that we probably should not support having two AB objects backed by the same (or a sub array of the same) backing store</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Oct 04 2023 18:42:09 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">if it’s unobservable it doesn’t need to be in the spec tho, and arguably couldn’t be</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Oct 04 2023 18:42:15 GMT-0700 (Pacific Daylight Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">impls can just do it</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Oct 04 2023 19:02:10 GMT-0700 (Pacific Daylight Time)">02:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">I agree</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Oct 04 2023 20:15:16 GMT-0700 (Pacific Daylight Time)">03:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Yes that's the difficulty I've been having with this. CoW is technically an unobservable optimizing engines could make today.  But we'll only get it if there is sufficient feedback from the community it's needed. Proposals like this IMO show the need.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Oct 04 2023 20:17:39 GMT-0700 (Pacific Daylight Time)">03:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">In that world , a concat feature is orthogonal. But it mostly makes sense if implemented as a list of CoW buffers because otherwise it's equivalent to the program creating a new contiguous buffer and copying into it.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Oct 05 2023 02:49:11 GMT-0700 (Pacific Daylight Time)">09:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">sooo it sounds like this proposal might have a beneficial side effect of nudging engines towards Just Doing CoW, and nothing further need be done?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Oct 05 2023 04:18:36 GMT-0700 (Pacific Daylight Time)">11:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@rkirsling:matrix.org">rkirsling</span>&gt;</div></td><td class="msg-cell">need a shu deck titled Have a CoW Man</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Oct 05 2023 05:54:53 GMT-0700 (Pacific Daylight Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Well, having the CoW bit would be great but I don't want to lose track of the zero-copy concat use case, which is what motivated the proposal</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Oct 05 2023 06:46:08 GMT-0700 (Pacific Daylight Time)">13:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I understand the performance motivation, but is there any reason zero copy should be something observable directly by the program?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Oct 05 2023 06:49:15 GMT-0700 (Pacific Daylight Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">it'd be observable if you mutated one and wanted to see the result in the other, which seems like kind of the main purpose of wanting zero-copy? (other than perf)</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Oct 05 2023 06:50:33 GMT-0700 (Pacific Daylight Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Well, the vast majority of my zero-copy use cases are for read. Specifically, around things like optimizing Stream API implementations due to the fact that WHATWG streams have no concept of writev the way Node.js streams do</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Oct 05 2023 06:52:14 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">For instance, I just had a case where a streams impl was resulting in many small writes that needed to be aggregated into larger buffers before being passed down a transform pipeline... unfortunately it's currently not possible to do without copying or modifying the various stream impls down the pipeline which is... difficult</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Oct 05 2023 06:54:05 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">in the implementation here I would likely be calling <code>transfer()</code> anyway so I don't really care so much about mutations being visible as allowing zero-copy concat for reading</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Oct 05 2023 06:59:28 GMT-0700 (Pacific Daylight Time)">13:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Yeah that's basically my question, is there any use cases requiring observing the mutation through an aggregation or subarray. I can't think of any, and if those are in fact needed, I'd prefer we add that set of features to SAB which has the shared backing store semantics.</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Oct 05 2023 07:03:26 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> For instance, I just had a case where a streams impl was resulting in many small writes that needed to be aggregated into larger buffers before being passed down a transform pipeline... unfortunately it's currently not possible to do without copying or modifying the various stream impls down the pipeline which is... difficult</blockquote></mx-reply>Btw, it was the exact same experience of stitching together smaller chunks that led me to wanting CoW and an internally optimized concat.</td></tr>

</tbody></table></div></div></div>
</body></html>