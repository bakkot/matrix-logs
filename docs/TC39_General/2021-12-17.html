<!DOCTYPE html><html><head>
  <title>TC39 General on 2021-12-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 General";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 General<br>2021-12-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-12-16" class="nav-link"><span>prev</span></a>
<a href="2021-12-18" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>
<select id="sort-order">
  <option value="oldest">Oldest first</option>
  <option value="newest">Newest first</option>
</select>
<input type="text" id="query" size="25" placeholder="Search TC39 General">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Dec 16 2021 16:14:24 GMT-0800 (Pacific Standard Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">We have a 262 issue for that</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Dec 16 2021 16:14:50 GMT-0800 (Pacific Standard Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/tc39/ecma262/issues/1849">https://github.com/tc39/ecma262/issues/1849</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Dec 16 2021 16:17:02 GMT-0800 (Pacific Standard Time)">00:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Looks like you and I arrived at the same conclusion</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Dec 16 2021 16:18:32 GMT-0800 (Pacific Standard Time)">00:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Lol, yah down to the step number</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Dec 16 2021 16:22:51 GMT-0800 (Pacific Standard Time)">00:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Actually rejecting the capability wouldn't close the sync iterator, would it? That's the problem today, the rejection flows into the promise capability, and into the consumer of the async iterator, which then quarantines the async iterator</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Dec 16 2021 16:59:05 GMT-0800 (Pacific Standard Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It should, given a <code>throw</code> will close via the <code>IfAbruptRejectPromise</code>, which just calls <code>capability.[[Reject]]</code></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Dec 16 2021 17:02:22 GMT-0800 (Pacific Standard Time)">01:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I don't see it</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Dec 16 2021 17:07:45 GMT-0800 (Pacific Standard Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I don't see anything that will close the <code>syncIterator</code> if the <code>promiseCapability</code> is rejected. For that matter, the <code>syncIterator</code> is not given to <code>AsyncFromSyncIteratorContinuation</code>, so it wouldn't have a way to do it.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Dec 16 2021 17:09:05 GMT-0800 (Pacific Standard Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">it'd have to be plumbed through as an optional 3rd argument in the case of <code>next</code>, as <code>return</code> and <code>throw</code> already close the <code>syncIterator</code> by definition</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Dec 16 2021 17:16:54 GMT-0800 (Pacific Standard Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Let me try digging in again</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Dec 16 2021 17:21:21 GMT-0800 (Pacific Standard Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://tc39.es/ecma262/#sec-%asyncfromsynciteratorprototype%.next">https://tc39.es/ecma262/#sec-%asyncfromsynciteratorprototype%.next</a></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Dec 16 2021 17:21:35 GMT-0800 (Pacific Standard Time)">01:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Step 6.a gets the <code><a href="http://sync.next">sync.next</a>()</code> value</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Dec 16 2021 17:22:37 GMT-0800 (Pacific Standard Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">it gets the result, aka <code>{value: Promise, done: boolean}</code></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Dec 16 2021 17:22:42 GMT-0800 (Pacific Standard Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Which gets us an <code>{ value, done }</code> value</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Dec 16 2021 17:22:43 GMT-0800 (Pacific Standard Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yah</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Dec 16 2021 17:23:02 GMT-0800 (Pacific Standard Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Now, <code>done</code> doesn't really matter</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Dec 16 2021 17:23:22 GMT-0800 (Pacific Standard Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">But we get the <code>value</code></td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Dec 16 2021 17:23:33 GMT-0800 (Pacific Standard Time)">01:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">In <a href="https://tc39.es/ecma262/#sec-asyncfromsynciteratorcontinuation">https://tc39.es/ecma262/#sec-asyncfromsynciteratorcontinuation</a></td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Dec 16 2021 17:24:12 GMT-0800 (Pacific Standard Time)">01:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The promise itself is received as a normal completion, but it's either rejected or will reject</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Dec 16 2021 17:24:33 GMT-0800 (Pacific Standard Time)">01:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">and from what I understand <code>AsyncFromSyncIteratorContinuation</code> grabs <code>done</code> and <code>value</code> from the result, awaits the <code>value</code> and resolves a promise with <code>{done, value: awaitedValue}</code></td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Dec 16 2021 17:25:10 GMT-0800 (Pacific Standard Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If we pass <code>capibility.[[Reject]]</code> to <code>PerformPromiseThen</code>, then it'll eventually call that reject</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Dec 16 2021 17:25:24 GMT-0800 (Pacific Standard Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">if the await throws, it rejects the promise, but the <code>syncIterator</code> is not touched anymore</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Dec 16 2021 17:25:37 GMT-0800 (Pacific Standard Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">There's a close step</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Dec 16 2021 17:26:05 GMT-0800 (Pacific Standard Time)">01:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">right but rejecting the promise does nothing besides giving a rejected promise to the async iterator consumer</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Dec 16 2021 17:27:21 GMT-0800 (Pacific Standard Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">one fix to this would be to add a handler to <code>valueWrapper</code> which closes the iterator, though that seems kinda silly</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Dec 16 2021 17:27:36 GMT-0800 (Pacific Standard Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">aye that's what I'm arguing we need to do</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Dec 16 2021 17:27:40 GMT-0800 (Pacific Standard Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">another fix is to have for-await-of explicitly coordinate with the wrapper, which seems kinda painful</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Dec 16 2021 17:27:54 GMT-0800 (Pacific Standard Time)">01:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">why is it silly ?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Dec 16 2021 17:28:12 GMT-0800 (Pacific Standard Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">what we have right now is basically the wrapper not cleaning up after itself</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Dec 16 2021 17:28:28 GMT-0800 (Pacific Standard Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">because we'd be unwrapping the promise twice</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Dec 16 2021 17:28:35 GMT-0800 (Pacific Standard Time)">01:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">it missed a <code>try-catch</code> when <code>await</code>ing the value</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Dec 16 2021 17:29:17 GMT-0800 (Pacific Standard Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">how so, the 3rd argument in step 10 does nothing right now, instead it needs to cleanup and passthrough the error</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Dec 16 2021 17:29:28 GMT-0800 (Pacific Standard Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">yeah, that's fair</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Dec 16 2021 17:29:45 GMT-0800 (Pacific Standard Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">not really unwrapping it twice so much as handling both branches</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Dec 16 2021 17:29:59 GMT-0800 (Pacific Standard Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">sgtm, needs-consensus PRs welcome</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Dec 16 2021 17:32:42 GMT-0800 (Pacific Standard Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It's up the chain a bit</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Dec 16 2021 17:32:51 GMT-0800 (Pacific Standard Time)">01:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://tc39.es/ecma262/#sec-runtime-semantics-forin-div-ofbodyevaluation-lhs-stmt-iterator-lhskind-labelset">https://tc39.es/ecma262/#sec-runtime-semantics-forin-div-ofbodyevaluation-lhs-stmt-iterator-lhskind-labelset</a></td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Thu Dec 16 2021 17:33:05 GMT-0800 (Pacific Standard Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">This is the thing that runs <code>for await (â€¦)</code></td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Thu Dec 16 2021 17:34:02 GMT-0800 (Pacific Standard Time)">01:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">For us, <code>iteratorRecord</code> is the wrapped asyncSync iterable, <code>iterationKind</code> is <code>iterate</code>, and <code>iteratorKind</code> is <code>async</code></td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Thu Dec 16 2021 17:35:24 GMT-0800 (Pacific Standard Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Step 6.b says "If iteratorKind is async, set nextResult to ? Await(nextResult)."</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Thu Dec 16 2021 17:35:32 GMT-0800 (Pacific Standard Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">ForIn/OfBodyEvaluation isn't really in a position to handle the issue, because it can't tell the difference between an async iterator which threw and a sync iterator which returned a rejected promise</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Thu Dec 16 2021 17:35:37 GMT-0800 (Pacific Standard Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><p>Step 6.</p>
<blockquote>
<p>b. If iteratorKind is async, set nextResult to ? Await(nextResult).<br>c. If Type(nextResult) is not Object, throw a TypeError exception.</p>
</blockquote>
<p>There is no cleanup of the iterator</p>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Thu Dec 16 2021 17:35:38 GMT-0800 (Pacific Standard Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">it's the wrapper which has to deal with it</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Thu Dec 16 2021 17:36:15 GMT-0800 (Pacific Standard Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">We can't make those different cases</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Thu Dec 16 2021 17:36:36 GMT-0800 (Pacific Standard Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Which?</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Thu Dec 16 2021 17:36:43 GMT-0800 (Pacific Standard Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I agree we can't make <code>ForIn/OfBodyEvaluation</code> differentiate</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Thu Dec 16 2021 17:36:45 GMT-0800 (Pacific Standard Time)">01:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/tc39/ecma262/issues/1849#issuecomment-584961565">https://github.com/tc39/ecma262/issues/1849#issuecomment-584961565</a></td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Thu Dec 16 2021 17:37:09 GMT-0800 (Pacific Standard Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">They should both be calling the cleanup function</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Thu Dec 16 2021 17:37:20 GMT-0800 (Pacific Standard Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">no, neither of them should be</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Thu Dec 16 2021 17:37:39 GMT-0800 (Pacific Standard Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell"><em>the wrapper</em> should do be calling cleanup when its underlying iterator returns a promise which rejects</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Thu Dec 16 2021 17:37:46 GMT-0800 (Pacific Standard Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">iterator throw / reject on <code>next</code> exits the iteration abruptly</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Thu Dec 16 2021 17:37:48 GMT-0800 (Pacific Standard Time)">01:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">because at that point it's going to stop iterating the underlying iterator</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Thu Dec 16 2021 17:38:15 GMT-0800 (Pacific Standard Time)">01:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">and when you stop iterating over a well-behaved iterator, you close it</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Thu Dec 16 2021 17:38:16 GMT-0800 (Pacific Standard Time)">01:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">cf <a href="https://github.com/tc39/rationale/issues/2">https://github.com/tc39/rationale/issues/2</a></td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Thu Dec 16 2021 17:38:57 GMT-0800 (Pacific Standard Time)">01:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">from ForIn/OfBodyEvaluation's point of view, the thing being iterated is not well-behaved, because its next method returned a promise which rejects</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Thu Dec 16 2021 17:39:04 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">so ForIn/OfBodyEvaluation should not be doing any cleanup</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Thu Dec 16 2021 17:39:25 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I disagree</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Thu Dec 16 2021 17:39:33 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Which with part?</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Thu Dec 16 2021 17:39:48 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Non-well behaved iterators should cleanup</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Thu Dec 16 2021 17:39:54 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Well, they don't, anywhere</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Thu Dec 16 2021 17:39:58 GMT-0800 (Pacific Standard Time)">01:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If my iterator throws, it needs to clean up</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Thu Dec 16 2021 17:40:06 GMT-0800 (Pacific Standard Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">if your iterator throws, it can do the cleanup itself</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Thu Dec 16 2021 17:40:52 GMT-0800 (Pacific Standard Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">we only ever call IteratorClose when we stop iterating for reasons which the iterator could not have known</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Thu Dec 16 2021 17:40:59 GMT-0800 (Pacific Standard Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">e.g. breaking out of a loop, etc</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Thu Dec 16 2021 17:41:39 GMT-0800 (Pacific Standard Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">yeah even I was surprised at first, I agree the behavior on broken iterators make sense, and it'd be impossible to change it. Here however it's the wrapper that's not well behaved by not cleaning up when the consumer would think the wrapper itself is misbehaved for throwing</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Thu Dec 16 2021 17:41:39 GMT-0800 (Pacific Standard Time)">01:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">if the iterator itself is saying that it is done, then it's the iterator's responsibility to do the cleanup</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Thu Dec 16 2021 17:42:26 GMT-0800 (Pacific Standard Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Ok, I think we're talking about two separate things now</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Thu Dec 16 2021 17:42:52 GMT-0800 (Pacific Standard Time)">01:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The async wrapper is stopping iteration</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Thu Dec 16 2021 17:43:04 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The underlying sync iterator didn't do anything wrong</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Thu Dec 16 2021 17:43:15 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It can either be left open, or we can clean it up.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Thu Dec 16 2021 17:43:47 GMT-0800 (Pacific Standard Time)">01:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">Right, my position is that the <em>wrapper</em> should clean up the sync iterator at that point</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Thu Dec 16 2021 17:44:16 GMT-0800 (Pacific Standard Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">the async wrapper is returning a rejection, which is construed by the consumer as misbehaving. It should know it won't be called again, so it should close its sync source</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Thu Dec 16 2021 17:44:22 GMT-0800 (Pacific Standard Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Ok</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Thu Dec 16 2021 17:44:28 GMT-0800 (Pacific Standard Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">i.e. we should add a handler to the third argument in step 10 of AsyncFromSyncIteratorContinuation which closes the sync iterator</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Thu Dec 16 2021 17:44:48 GMT-0800 (Pacific Standard Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Lol, I think that's what I suggested</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Thu Dec 16 2021 17:44:53 GMT-0800 (Pacific Standard Time)">01:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">hah, well</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Thu Dec 16 2021 17:45:03 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">I am glad we are agreement then, even if violent</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Thu Dec 16 2021 17:45:37 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">what you suggested is forwarding the rejection, which already happens. The wrapper needs to explicitly close the sync iterator it holds</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Thu Dec 16 2021 17:45:44 GMT-0800 (Pacific Standard Time)">01:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">oh, yeah</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Thu Dec 16 2021 17:46:19 GMT-0800 (Pacific Standard Time)">01:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">admittedly the flow inversion in iterators is a bit mindbending</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Thu Dec 16 2021 19:12:19 GMT-0800 (Pacific Standard Time)">03:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Alright, since this is my first spec PR, can someone take a preliminary look and tell me if that makes sense before I mark it as ready? <span class="nick-2">bakkot</span> maybe?<br><a href="https://github.com/tc39/ecma262/pull/2600">https://github.com/tc39/ecma262/pull/2600</a></td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Thu Dec 16 2021 19:40:19 GMT-0800 (Pacific Standard Time)">03:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">lgtm</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Thu Dec 16 2021 19:44:53 GMT-0800 (Pacific Standard Time)">03:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@bakkot:matrix.org">bakkot</span>&gt;</div></td><td class="msg-cell">note that you (or someone) will need to present at plenary and get consensus for it to land</td></tr>

</tbody></table></div></div></div>
</body></html>