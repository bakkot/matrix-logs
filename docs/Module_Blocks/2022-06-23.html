<!DOCTYPE html><html><head>
  <title>Module Blocks on 2022-06-23</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "Module Blocks";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">Module Blocks<br>2022-06-23<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-06-22" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search Module Blocks">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jun 22 2022 23:12:39 GMT-0700 (Pacific Daylight Time)">06:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">Just to register my personal preference regarding module blocks and idempotence: import(module {}) should be analogous to eval. The module should always be evaluated and should not be memoized, even by a gensym. That would provide a consistent experience even in the case where the module gets transported or returned. Also means that the loader doesn’t retain the resulting graph of module instances, so some things could be collected earlier. That doesn’t preclude user code memoizing the result, even using the identity of the block as a memo key. In short, I strongly prefer to avoid inconsistent behavior between local and remote versions of import(block).</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Jun 23 2022 00:25:56 GMT-0700 (Pacific Daylight Time)">07:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Kris Kowal</span>On the other hand `import("data:text/javascript, ...")` is memoized, and it's the closest thing we have to module blocks </td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Jun 23 2022 00:27:18 GMT-0700 (Pacific Daylight Time)">07:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Even if being a primitive does not suffer from the structured clone problem </td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Jun 23 2022 02:11:09 GMT-0700 (Pacific Daylight Time)">09:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> No, but one thought experiment I had was what happens if I send a block to a worker, and the worker sends it straight back. Is it desirable that we restore identity?</blockquote></mx-reply>My intuition is, it'd be cool if it did, but also I don't see why anyone should depend on that</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Jun 23 2022 02:12:35 GMT-0700 (Pacific Daylight Time)">09:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Just to register my personal preference regarding module blocks and idempotence: import(module {}) should be analogous to eval. The module should always be evaluated and should not be memoized, even by a gensym. That would provide a consistent experience even in the case where the module gets transported or returned. Also means that the loader doesn’t retain the resulting graph of module instances, so some things could be collected earlier. That doesn’t preclude user code memoizing the result, even using the identity of the block as a memo key. In short, I strongly prefer to avoid inconsistent behavior between local and remote versions of import(block).</blockquote></mx-reply>This is a little hard for me to square with, if you use module fragments and have a little module subgraph with a diamond import pattern, you clearly don't expect cloning in that case, or do you?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Jun 23 2022 07:47:26 GMT-0700 (Pacific Daylight Time)">14:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I would expect one fresh instance of each module in the subgraph. The subgraph does not need to be memoized by the loader in order to achieve idempotence within the subgraph.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Jun 23 2022 07:49:37 GMT-0700 (Pacific Daylight Time)">14:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That is to say, I think we agree that importing a module fragment should not produce more than one instance of each of the transitively imported module fragments.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Jun 23 2022 07:50:21 GMT-0700 (Pacific Daylight Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">But I do think it’s acceptable for each dynamic import of a module fragment to instantiate exactly one fresh copy of the module fragment subgraph.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Jun 23 2022 08:05:39 GMT-0700 (Pacific Daylight Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">One of the things that I learned from our last conversation, that I quite like, is that every module fragment has an equivalent source text, effectively a single static module record that can be cached on the identity of the fragment. That also implies that it is content addressable and can be cached as a document or in transit. So there’s a lot to recommend that as a feature of transportability.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Jun 23 2022 08:06:57 GMT-0700 (Pacific Daylight Time)">15:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">But caching the content doesn’t necessarily require memoization of the instances. Instantiating a module fragment essentially means instantiating a list of blocks. All of this is of course provisional, assuming that the idea of lexically named module blocks is popular here.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Jun 23 2022 08:13:55 GMT-0700 (Pacific Daylight Time)">15:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">But, I’ll concede this idea holds no water at all if there’s a hope that it’ll eventually be possible for a module fragment to be imported or exported between modules. If there’s a hope that would be eventually possible, I think that’s a very different design world.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Jun 23 2022 08:15:37 GMT-0700 (Pacific Daylight Time)">15:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">(In that world, I would hold the opposite opinion: that fragments should be memoized, but by virtue of being contained within another module that is memoized by full/referrer specifier, and that fragments would not be transportable without the entirety of the surrounding document.)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Jun 23 2022 08:41:53 GMT-0700 (Pacific Daylight Time)">15:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think this would make module fragments unusable for the bundling case</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Jun 23 2022 08:42:34 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">for example, <code>module x { console.log("happened"); } module y { import x; } module z { import x; } module w { import y; import x; } import x;</code></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Jun 23 2022 08:42:40 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">this should really print "happened" just once</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Jun 23 2022 08:42:49 GMT-0700 (Pacific Daylight Time)">15:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">otherwise we're doing something new and different from how modules work normally</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Thu Jun 23 2022 08:50:29 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">as Guy pointed out, the internal representation need not mention gensyms, just a bunch of recursive data structures, which can be transported as such (some serializations may need to create a gensym/counter but this is just a local thing; it doesn't leak out)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Thu Jun 23 2022 08:50:51 GMT-0700 (Pacific Daylight Time)">15:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">HTML structured clone, for one, doesn't need gensyms and is fine with just having a recursive structure</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Thu Jun 23 2022 08:51:04 GMT-0700 (Pacific Daylight Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(of course implementations don't actually work like that, just the spec formalism)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Thu Jun 23 2022 10:10:51 GMT-0700 (Pacific Daylight Time)">17:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> this should really print "happened" just once</blockquote></mx-reply>I agree and think that can be coherent with dynamic import printing "happened" once more each time.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Thu Jun 23 2022 10:11:24 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Hmm, I also think the dynamic import behavior should match</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Thu Jun 23 2022 10:11:49 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I can sympathize with that.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Thu Jun 23 2022 10:11:52 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">This is also something which would inhibit bundlers from using module fragments as an output format</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Thu Jun 23 2022 10:12:08 GMT-0700 (Pacific Daylight Time)">17:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I do not think that follows.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Thu Jun 23 2022 10:13:37 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I’ll mull on the tension between these motivations some more.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Thu Jun 23 2022 10:14:05 GMT-0700 (Pacific Daylight Time)">17:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><p>The problem with bundlers that Dan is trying to show is that if you have this code:</p>
<pre><code class="language-js">// main.js
await import("./dep.js");
await import("./dep.js");

// dep.js (different file)
console.log("Hi!");
</code></pre>
<p>you cannot (if <code>import()</code> re-evaluates module blocks) rewrite it to a single file like</p>
<pre><code class="language-js">// bundle.js

import main;

module main {
  await import(dep);
  await import(dep);
}

module dep {
  console.log("Hi!");
}
</code></pre>
</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Thu Jun 23 2022 10:15:35 GMT-0700 (Pacific Daylight Time)">17:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I see. So behind door A, we get an inconsistency in behavior between static and dynamic import, behind door B, we get an inconsistency between local and remote dynamic import.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Thu Jun 23 2022 10:16:26 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">By "remote" do you mean "I pass a dynamic import to a worker, and that worker would re-evaluate it"?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jun 23 2022 10:16:44 GMT-0700 (Pacific Daylight Time)">17:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Or "I pass it to a worker, then the worker passes it back to me, and I will re-evaluate it"?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Thu Jun 23 2022 10:17:13 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">worker = compartment, or realm, or something else</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Thu Jun 23 2022 10:19:36 GMT-0700 (Pacific Daylight Time)">17:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I wonder if we could attach an "unique numeric id" to every module block, similar to the shared registered symbols registry, so that when I receive it back <code>import()</code> can give me back the same module namespace. The "id to namespace" cache would be per-realm, but the id needs to be globally unique</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Thu Jun 23 2022 10:21:47 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">This would mean that module namespaces coming from module blocks cannot be garbage collected until the realm is collected, but that's already true for namespaces coming from "file modules"</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Thu Jun 23 2022 10:29:01 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I presume that if module fragments are idempotent within the lifecycle of a loader (where currently, loader === realm), then they are necessarily retained by the loader.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Thu Jun 23 2022 10:30:21 GMT-0700 (Pacific Daylight Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">Oh true you are right. I was thinkng about module blocks ("expressions") that coud otherwise be collected when they become unreachable</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Thu Jun 23 2022 10:35:28 GMT-0700 (Pacific Daylight Time)">17:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@ljharb:matrix.org">ljharb</span>&gt;</div></td><td class="msg-cell">"static and dynamic" seems like a much more important consistency to maintain imo</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Thu Jun 23 2022 10:52:33 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">I’m leaning to agree, if there’s no way to have both.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Thu Jun 23 2022 10:53:50 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I wonder if we could attach an "unique numeric id" to every module block, similar to the shared registered symbols registry, so that when I receive it back <code>import()</code> can give me back the same module namespace. The "id to namespace" cache would be per-realm, but the id needs to be globally unique</blockquote></mx-reply>I believe integrating a fragment id into the module memo key is necessary if module blocks and fragments are memoized.</td></tr>

</tbody></table></div></div></div>
</body></html>