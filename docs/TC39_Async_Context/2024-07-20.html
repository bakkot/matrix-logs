<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-07-20</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-07-20<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-19" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Jul 19 2024 17:19:16 GMT-0700 (Pacific Daylight Time)">00:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">(aside: I assume we did whatever we needed to to get on the agenda for next month?)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Jul 19 2024 17:28:32 GMT-0700 (Pacific Daylight Time)">00:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">What about null vs "empty"?  I think the important example to consider here is the dispatchSnapshot for an event dispatched directly from the event loop, rather than programmatically.  I'll say upfront that I think having it be null for this case is desirable, since there's no good way to determine that some non-null value is "empty".  But I can also see a consistency argument for it being <code>HostGetTopLevelAsyncContextMapping(null)</code> - this is the initial value for agentRecord.[[AsyncContextMapping]], and is therefore presumably its value at the exact time that the event is created/dispatched.  So any other value (including <code>null</code>) is presumably more complicated to spec (and also more challenging to polyfill).</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Jul 19 2024 18:57:50 GMT-0700 (Pacific Daylight Time)">01:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">Polyfills are a reason why I think, regardless of what we end up doing by default, there needs to be a way to have <code>dispatchSnapshot</code> be null</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Jul 19 2024 18:58:56 GMT-0700 (Pacific Daylight Time)">01:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">the event constructor's second argument is an options bag, that could be an additional option there</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Jul 19 2024 19:02:55 GMT-0700 (Pacific Daylight Time)">02:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">about challenging to spec, since we're considering a small initial rollout, events would have a null snapshot by default, with an option in the spec to use the current context instead</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Jul 19 2024 19:03:47 GMT-0700 (Pacific Daylight Time)">02:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">so distinguishing null vs the empty context would not be complicated, because only event dispatches that could have a causal context would be updated to use that option</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Jul 19 2024 19:33:24 GMT-0700 (Pacific Daylight Time)">02:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">What I was suggesting before was that we might not need to do a small initial rollout if we just scope it narrowly - instead, <em>every</em> event gets a <code>dispatchSnapshot</code>, and we handle other use cases with different properties.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Jul 19 2024 19:38:36 GMT-0700 (Pacific Daylight Time)">02:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">wouldn't there still have to be a small initial rollout for those other properties?</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Jul 19 2024 19:39:25 GMT-0700 (Pacific Daylight Time)">02:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">maybe?  but they would also be narrowly-scoped so it should also be possible to roll them out 100%</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Jul 19 2024 19:39:59 GMT-0700 (Pacific Daylight Time)">02:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">though they would only ever include a small subset of events</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Jul 19 2024 19:40:09 GMT-0700 (Pacific Daylight Time)">02:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">i.e. <code>throwSnapshot</code> only makes sense on error/rejection events</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Jul 19 2024 19:41:36 GMT-0700 (Pacific Daylight Time)">02:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">if we think of the future when we've achieved 100% rollout, I don't think the distinction between the different scopes will make sense</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Jul 19 2024 19:43:53 GMT-0700 (Pacific Daylight Time)">02:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">Ultimately the difference is in conceptualizing what <code>fooSnapshot</code> means.  What I'm suggesting is that for any given <code>foo</code> you can look up <em>exactly</em> what it means, whereas the alternative is that you need to puzzle through "okay, this is a 'bar' event, so <em>its</em> <code>fooSnapshot</code> comes from when such-and-such happened"</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Jul 19 2024 19:45:41 GMT-0700 (Pacific Daylight Time)">02:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">it's an argument for homogeneity and comprehensibility.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Jul 19 2024 19:47:01 GMT-0700 (Pacific Daylight Time)">02:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">for homogeneity, wouldn't that also have to apply to events which are dispatched synchronously from some API? <code><a href="http://el.click">el.click</a></code> for example</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Jul 19 2024 19:47:17 GMT-0700 (Pacific Daylight Time)">02:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">i guess homogeneity is a matter of perspective, because the property names themselves would be heterogeneous, but the meaning of any given property is homogeneous</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Jul 19 2024 19:47:46 GMT-0700 (Pacific Daylight Time)">02:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">but yes, I would include those as well - <a href="http://el.click">el.click</a> would set the dispatchSnapshot to the snapshot in which click was called.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Jul 19 2024 19:48:02 GMT-0700 (Pacific Daylight Time)">02:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">why dispatchSnapshot? why not clickSnapshot?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Jul 19 2024 19:48:41 GMT-0700 (Pacific Daylight Time)">02:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">every event gets a dispatch snapshot and it's always defined the same way - since click dispatches synchronously, it doesn't need a separate snapshot</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Jul 19 2024 19:49:19 GMT-0700 (Pacific Daylight Time)">02:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">but wouldn't you also have to look up what exactly that means for each event if you're trying to use it?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Jul 19 2024 19:51:29 GMT-0700 (Pacific Daylight Time)">02:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">No, you just need to know whether the event is dispatched while executing ecmascript code or else by the event loop.  If the former, it's always going to be whatever snapshot was active when the event started dispatching, and if the latter then it's always null (or possibly but hopefully not HostGetTopLevelAsyncContextMapping)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Jul 19 2024 19:52:44 GMT-0700 (Pacific Daylight Time)">02:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">The bit about null is slightly problematic because as it's currently spec'd, the <code>[[AsyncContextMapping]]</code> <em>isn't</em> set to null during the event loop, so it would require a bit of special casing, which I'd rather avoid</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Jul 19 2024 19:53:13 GMT-0700 (Pacific Daylight Time)">02:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">if you're a developer trying to use the snapshot of an event for something, you would usually be writing code that works for multiple different event dispatches, and you'd also need to know what web API call dispatches the current event</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Jul 19 2024 19:53:21 GMT-0700 (Pacific Daylight Time)">02:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I don't see how that's different for async dispatches</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Jul 19 2024 19:53:23 GMT-0700 (Pacific Daylight Time)">02:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">If the mapping lived on the execution context, it might be easier to make it null during the event loop</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Jul 19 2024 19:56:13 GMT-0700 (Pacific Daylight Time)">02:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I assume you already know what event you're responding to, and you certainly know you're in an event handler at all, since you need to read something off of an event object in the first place.  But that's what I was getting at before - are you more likely to just want <em>whatever</em> non-null snapshot you can get, or are you more likely to want fine-grained control to get the snapshot from a particular time?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Jul 19 2024 19:56:33 GMT-0700 (Pacific Daylight Time)">02:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">And as I said above, I don't know the answer to that.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Jul 19 2024 19:57:10 GMT-0700 (Pacific Daylight Time)">02:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">but userland code could easily maintain a mapping from event types to property names, if it wanted to</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Jul 19 2024 19:58:09 GMT-0700 (Pacific Daylight Time)">02:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">whereas putting that special casing directly in the engine (and polyfills) is unconditionally expensive and cuts off expressibility and understandability</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Jul 19 2024 20:00:23 GMT-0700 (Pacific Daylight Time)">03:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">Yes, you know you're in an event handler, and you know what event you're responding to. But if you're saying that for async dispatches developers might need to know which web API call's context is the dispatch snapshot, I don't see why that is not also the case for sync dispatches. The fact that the event is dispatched synchronously doesn't change anything other than possibly the current state of non-local variables the event listener might have access to.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Jul 19 2024 20:01:06 GMT-0700 (Pacific Daylight Time)">03:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">You're registering the event in a different place from where it is dispatched in both cases</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Jul 19 2024 20:02:14 GMT-0700 (Pacific Daylight Time)">03:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I think the difference is that async dispatches are inherently heterogeneous, whereas sync dispatches have a lot more in common between them.  Also, async dispatches are <em>much</em> more likely to prefer the default registration context anyway.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Jul 19 2024 20:04:56 GMT-0700 (Pacific Daylight Time)">03:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">One theory I have is that one-time callbacks are more likely to want registration-snapshot, while multiply-called callbacks are more likely to want a causal snapshot.  I also believe async dispatches tend to correlate more with one-time listeners.</td></tr>

</tbody></table></div></div></div>
</body></html>