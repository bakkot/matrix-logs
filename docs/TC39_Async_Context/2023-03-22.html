<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2023-03-22</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2023-03-22<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-17" class="nav-link"><span>prev</span></a>
<a href="2023-03-23" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Mar 21 2023 17:30:53 GMT-0700 (Pacific Daylight Time)">00:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I had some quick chats today at TC39 with dminor and bakkot, everyone seemed cautiously positive though a little uncertain about use cases. I am optimistic about the presentation but we might consider adding bonus slides that go in more depth there (eg just taking what was in legendecas’s webperf wg slides)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Mar 21 2023 17:31:50 GMT-0700 (Pacific Daylight Time)">00:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I didn’t get the feeling that the complexity around what things are wrapped was considered a very bad issue for either (just something to work out) but maybe I misunderstood them</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Mar 21 2023 17:32:02 GMT-0700 (Pacific Daylight Time)">00:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Good luck this week on proposing for Stage 2!</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Mar 22 2023 08:16:26 GMT-0700 (Pacific Daylight Time)">15:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>So, here's a question. fetch has the <code>Response</code> object. This can be created using a <code>ReadableStream</code> object, which uses a number of internal promises to manage state. In workerd, we have a method that handles received requests and can return a <code>Response</code> object specifying the response to an http request. So, imagine a case like:</p>
<pre><code>const als = new AsyncLocalStorage(); // or AsyncContext
export default {
  async fetch(req) {
    const readable = als.run('abc', () =&gt; new ReadableStream({
      pull(c) {
        c.error(new Error(`boom ${als.getStore()}`));
      }
    }));
    return als.run(123, () =&gt; new Response(readable));
  }
}
</code></pre>
<p>The actual pipe from the readable happens by the code that calls the <code>fetch</code> function handler here, which is running in the root async context where <code>als</code> store will be <code>undefined</code>.</p>
<p>What value would you expect <code>als.getStore()</code> to return when the error is constructed?</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Mar 22 2023 08:17:37 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Keep in mind that the pull function can be called at different times depending on the value of the <code>highWaterMark</code> configured for the readablestream</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Mar 22 2023 08:23:18 GMT-0700 (Pacific Daylight Time)">15:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">specifically, pull might be called when the ReadableStream is created, and any time after while it is being read</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Mar 22 2023 08:52:15 GMT-0700 (Pacific Daylight Time)">15:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I don't have a good answer. Just from the use case I recognize that it must be one of the two (and not <code>undefined</code> just because the <code>Response</code> object is leaked out of the fetch), but I don't have a good idea of which one of these contexts is the "registration" context</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Mar 22 2023 08:53:59 GMT-0700 (Pacific Daylight Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">In my experience, the contexts are the same. I create the readable and the response in the same overall context, so the distinction doesn't matter</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Mar 22 2023 08:56:02 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">That's fair. What I suspect is that for web apis, once AsyncContext is integrated, we'll need a way of identifying in webidl which types are expected to capture and propagate the async context</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Mar 22 2023 08:56:38 GMT-0700 (Pacific Daylight Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">It's going to be needed regardless of where AsyncContext ultimately gets defined (tc39 or whatwg, etc)</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Mar 22 2023 10:51:00 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">Here’s my take: if/once <code>AsyncContext</code> becomes an official part of the language, utilities like <code>ReadableStream</code> could (backwards compatibly!) begin to support a contract whereby the context in effect at <code>ReadableStream</code> construction time is automatically restored each time <code>pull</code> and other callbacks are called</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Mar 22 2023 10:51:20 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">In the meantime (potentially for a long time), you might need to take matters into your own hands using <code>AsyncContext.wrap</code>:</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Mar 22 2023 10:51:26 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-export">  async fetch(req) {
    const readable = als.run('abc', () =&gt; new ReadableStream({
      pull: AsyncContext.wrap((c) =&gt; {
        c.error(new Error(`boom ${als.getStore()}`));
      }),
    }));
    return als.run(123, () =&gt; new Response(readable));
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Mar 22 2023 10:51:51 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">With this code, the <code>als</code> with <code>abc</code> is bound to the <code>pull</code> callback function so <code>als.getStore()</code> can return <code>abc</code> instead of undefined for the Error</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Mar 22 2023 10:52:21 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">Of course, this <code>AsyncContext.wrap</code> binding means any other <code>AsyncContext</code> values coming from the caller of the <code>pull</code> callback (some code in the <code>ReadableStream</code> implementation) will now be ignored, but that’s probably safe as long as you don’t expect <code>ReadableStream</code> to be manipulating <code>AsyncContext</code></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Mar 22 2023 10:52:43 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">Is that helpful?</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Mar 22 2023 10:55:27 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Unfortunately it doesn't exactly help. If I call c.error() within the pull, and there's a queued read, that queued read is likely not necessarily going to be rejected immediately when the <code>c.error</code> is called. It might end up getting processed from a different async scope, which means if it results in an unhandledrejection event, it will propagate the wrong context</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Mar 22 2023 10:56:22 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">going to have to play with this case a bit more to really tease out all the various cases</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Mar 22 2023 10:57:10 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">There are a variety of situations that make this complicated.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Mar 22 2023 10:57:49 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">whatever code is scheduling/queueing those read jobs needs to be using something like <code>AsyncContext.wrap</code> to preserve the context from one job to the next, I think?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Mar 22 2023 10:58:04 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">are you trying to get this to work without modifying library code that does this kind of scheduling? (seems hard)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Mar 22 2023 10:58:06 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">for instance, I may have multiple reads queued, all called from separate async contexts, but a mismatched number of pulls, where one pull triggered by one context fulfills multiple reads</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Mar 22 2023 10:58:22 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">yeah, we're not in control of the ReadableStream implementations</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Mar 22 2023 10:58:47 GMT-0700 (Pacific Daylight Time)">17:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">ok I think I see the rub you were pointing out</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Mar 22 2023 11:00:06 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">a single invocation of <code>pull</code> can handle/inherit multiple different contextual branches</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Mar 22 2023 11:02:26 GMT-0700 (Pacific Daylight Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">do you think the solution is somehow to merge the branches into one context, or to keep the different branches distinct so <code>pull</code> can create the errors with their correct (not merged) contexts?</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Mar 22 2023 11:03:17 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> That's fair. What I suspect is that for web apis, once AsyncContext is integrated, we'll need a way of identifying in webidl which types are expected to capture and propagate the async context</blockquote></mx-reply>This differs from how Yoav ended up implementing a similar feature in Blink. It turned out that the WebIDL layer approach was too slow.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Mar 22 2023 11:03:32 GMT-0700 (Pacific Daylight Time)">18:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">instead, it's more like, you propagate the context when queueing a task</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Mar 22 2023 11:09:05 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">so in this case it's a bit complicated. "when queing a task" ... for a readable stream, a pending read can be viewed as a queued task</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Mar 22 2023 11:09:21 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">when a read is received, the stream may or may not call pull to ensure that the read can be fulfilled</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Mar 22 2023 11:09:43 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">and a single pull can cause multiple pending reads to be fulfilled</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Mar 22 2023 11:10:04 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">so, within that pull, should it use the context of the read that immediately triggered it?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Mar 22 2023 11:10:19 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">or should it use the context that was current when the stream was created?</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Mar 22 2023 11:11:23 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">and if that pull causes an error, causing all subsequent reads to reject with unhandled rejections, should the unhandled rejection events be called from the async context for the individual read or the context that was active when the pull errored</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Mar 22 2023 11:13:15 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">is there some mechanism currently for the <code>pull</code> callback to tell why an error occurred, in a way that points back to one particular read?</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Mar 22 2023 11:13:28 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">no</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Mar 22 2023 11:14:07 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">whether it throws or calls <code>controller.error(...)</code> the effect is the same, the stream is put into an errored state such that all pending and future reads are rejected with that reason</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Mar 22 2023 11:14:47 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">all pending reads would be rejected within the same async context and not the frame that was current when the read was scheduled</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Mar 22 2023 11:15:17 GMT-0700 (Pacific Daylight Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">so the unhandledrejection handler would see that context and the context that scheduled the read in the first place would be lost</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Mar 22 2023 11:17:17 GMT-0700 (Pacific Daylight Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>Here's another example:</p>
<pre><code>const als = new AsyncLocalStorage();

const readable = als.run(123, () =&gt; new ReadableStream({
  pull(c) {
    c.error(`boom ${als.getStore()}`);
  }
}, { highWaterMark: 0 }));
const response = als.run('abc', () =&gt; new Response(readable));
const reader = als.run('xyz', () =&gt; response.body);
const read1 = als.run(321, () =&gt; reader.read());
const read2 = als.run(567, () =&gt; reader.read());
await Promise.all([
  als.run('???', async () =&gt; await read1),
  als.run('!!!', async () =&gt; await read2)
]);
</code></pre>
</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Mar 22 2023 11:18:25 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">sorry that's a bit off... one sec</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Mar 22 2023 11:18:26 GMT-0700 (Pacific Daylight Time)">18:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I'm not sure this works as you'd hope: <code>const reader = <a href="http://als.run">als.run</a>('xyz', () =&gt; response.body)</code>, since <code><a href="http://reader.read">reader.read</a></code> won't automatically restore the <code>xyz</code> context value when called</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Mar 22 2023 11:19:23 GMT-0700 (Pacific Daylight Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">that's thrown in just to make it more complex. I know it wouldn't do anything :-)</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Mar 22 2023 11:23:50 GMT-0700 (Pacific Daylight Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">would it be acceptable for the unhandledrejection error to report a set of contexts rather than just one? or is that a nonstarter?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Mar 22 2023 11:24:32 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">it's called once per each unhandled promise rejection, there's only one context associated with each</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Mar 22 2023 11:24:35 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I have been thinking we need to extend AsyncContext itself to handle a set of context</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Mar 22 2023 11:24:39 GMT-0700 (Pacific Daylight Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">reporting a set would not make sense there</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Mar 22 2023 11:25:05 GMT-0700 (Pacific Daylight Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">how does <code>pull</code> know which <code>read</code> was to blame, and so which context to report?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Mar 22 2023 11:26:00 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">so that the context user can gather the values associated with both the registration and the trigger paths</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Mar 22 2023 11:26:23 GMT-0700 (Pacific Daylight Time)">18:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">it doesn't. Currently pull would be called within the async context of whatever read triggered it. It could also be called following the completion of the start algorithm microtask (the async context where the stream is constructed).</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Mar 22 2023 11:28:13 GMT-0700 (Pacific Daylight Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>we can break this down to a few specific questions:</p>
<ol>
<li>Because the various "algorithms" associated with a stream are considered part of its internal implementation (e.g. start, pull, close), should those always be executed in the async context frame in which the stream itself was created or should they propagate the context that triggered the algorithm to be called</li>
</ol>
</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Mar 22 2023 11:29:37 GMT-0700 (Pacific Daylight Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><ol start="2">
<li>If a read promise rejects and is unhandled, should the unhandledrejection event be called in the async context in which the read promise was rejected (which is likely different than the context that scheduled the read), or the async context that was current when the read was scheduled</li>
</ol>
</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Mar 22 2023 11:34:11 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">Mark Miller brought up a point a while back (when <code>AsyncContext</code> was last proposed), about what to do with an <code>AsyncContext.wrap</code>-bound function that gets called in a context where some <code>AsyncContext</code> instance that was previously bound with one value (for some <code>AsyncContext</code>) happens to have a different value in the new calling context</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Mar 22 2023 11:34:33 GMT-0700 (Pacific Daylight Time)">18:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>Keeping in mind also that people can do silly things like..</p>
<pre><code>let controller;
const readable = als.run(123, () =&gt; new ReadableStream({
  start(c) { controller = c; }
}));
const read = als.run('abc', () =&gt; readable.getReader().read());
als.run(321, () =&gt; controller.error('boom'));
</code></pre>
</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Mar 22 2023 11:36:15 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">Are you expecting the context to be propagated somehow by the assignment <code>controller = c</code>? Whatever context is in effect in <code>start</code> is pretty clearly lost by this code, right?</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Mar 22 2023 11:36:34 GMT-0700 (Pacific Daylight Time)">18:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I don't expect <code>controller.error</code> to have access to anything beyond the <code>321</code> context, there</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Mar 22 2023 11:37:13 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">nope, it's definitely lost. so if we always called the algorithm in the context captured when the readablestream was created, this would escape that context and would cause the reads to be rejected in the context where the value is 321</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Mar 22 2023 11:37:46 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">but what should be the context for the unhandledrejection associated with the read</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Mar 22 2023 11:37:51 GMT-0700 (Pacific Daylight Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">'abc' or '321'?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Mar 22 2023 11:39:39 GMT-0700 (Pacific Daylight Time)">18:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I can imagine a <code>Promise</code> implementation that has a chance of preserving <code>abc</code> (in this code) in the final context associated with the rejected <code>read</code> promise</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Mar 22 2023 11:41:49 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">but that's assuming/imagining <code>Promise</code> objects capture context at creation time (when <code>readable.getReader().read()</code> is called), which is yet to be decided or implemented</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Mar 22 2023 11:42:49 GMT-0700 (Pacific Daylight Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Why would a promise ever need to capture the creation time? I only see the resolution and registration times as being useful</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Mar 22 2023 11:43:06 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">for unhandledrejection error attribution/context, mostly, I think?</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Mar 22 2023 11:43:23 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">we've previously decided that, for promises, the context would be captured at the moment the continuation was attached. So either when then is called or we await</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Mar 22 2023 11:43:36 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">that's the rejection time that's useful, not the promise creation time</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Mar 22 2023 11:43:59 GMT-0700 (Pacific Daylight Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">and that in the deferred promise case, we'd propagate the context that is current when either resolve() or reject() is called</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Mar 22 2023 11:44:14 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I'm fine with that</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Mar 22 2023 11:44:25 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">but in the ReadableStream case, it's <em>most</em> useful to treat <code>read()</code> itself as a scheduled task</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Mar 22 2023 11:44:26 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">so it's the context when <code>reject()</code> is called that matters (determines the context reported by the unhandledrejection error)?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Mar 22 2023 11:44:51 GMT-0700 (Pacific Daylight Time)">18:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">since the read promise itself might be rejected from a completely unrelated context</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Mar 22 2023 11:46:27 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">wouldn't the onus be on the <code>read()</code> implementation to reject the promise from the context in which <code>read()</code> was called if the rejection is related to the read implementation.</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Mar 22 2023 11:47:05 GMT-0700 (Pacific Daylight Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">yeah, it's not specific to the promise itself</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Mar 22 2023 11:47:31 GMT-0700 (Pacific Daylight Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">should the read operation itself capture the current context and make sure that whenever that queued promise is resolved or rejected the captured context is entered</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Mar 22 2023 11:48:40 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">or should it always be resolved in the context the stream was created... or should it always be resolved in the context that happens to be current whenever start/pull or whatever mechanism internal to the stream causes the promise to be rejected/resolved</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Mar 22 2023 11:48:48 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Here is a question: if the user aborts, which causes the read to be rejected, what context matters? the context in which read was started, or the one in which the operation was aborted. I believe the latter is the meaningful one</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Mar 22 2023 11:49:55 GMT-0700 (Pacific Daylight Time)">18:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I agree. but in the unhandledrejection handler for an individual read, does the same answer apply?</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Mar 22 2023 11:51:53 GMT-0700 (Pacific Daylight Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I can see arguments for both. For instance, if it's the runtime that ends up aborting the stream, my unhandledrejection handler might want to log request specific details of the read that was canceled, but I've lost that context because the abort came from the runtime in the root async context where no data was captured</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Mar 22 2023 11:52:51 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I can see how losing track of the call site could be problematic in some use cases, but that's basically amounting to say that we have 3 contexts that can be meaningful: the operation start, the operation resolution, the registration for the result of the operation.</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Mar 22 2023 11:52:53 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">whereas within the cancel algorithm inside the stream itself, I may not care so much about which context was actually propagated</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Mar 22 2023 11:53:45 GMT-0700 (Pacific Daylight Time)">18:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">fwiw, I'm perfectly fine with us maintaining that it's the context that called the abort which is important</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Mar 22 2023 11:54:06 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">if someone <em>really</em> wants to preserve the context for the rejection then they need to explicitly handle the rejection</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Mar 22 2023 11:54:52 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I have use cases where I'd like to be able to recover the context of the promise resolution</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Mar 22 2023 11:55:16 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I can very well imagine some other people may have use cases where they need to recover the context of the promise creation</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Mar 22 2023 11:55:28 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">for my original case, however, the <code>Response</code> object is created in association with a context but used outside of that context and the user has no means of attaching rejection handlers to the internal promises so I think having the <code>Response</code> capture the context and propagate it makes the most sense</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Mar 22 2023 11:55:39 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">(to be clear, that on top of having the context of the promise handler registration)</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Mar 22 2023 11:57:14 GMT-0700 (Pacific Daylight Time)">18:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">I can see this being expensive to implement however</td></tr>

</tbody></table></div></div></div>
</body></html>