<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2022-11-18</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2022-11-18<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-17" class="nav-link"><span>prev</span></a>
<a href="2022-11-19" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Nov 17 2022 18:14:25 GMT-0800 (Pacific Standard Time)">02:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yes, <span class="nick-15">rbuckton</span> was excited about the proposal in June 2020: <a href="https://github.com/tc39/notes/blob/3937a973f1903550e33ccebd9bf18f90dd7d5b7c/meetings/2020-06/june-3.md#async-context">https://github.com/tc39/notes/blob/3937a973f1903550e33ccebd9bf18f90dd7d5b7c/meetings/2020-06/june-3.md#async-context</a></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Nov 17 2022 21:04:12 GMT-0800 (Pacific Standard Time)">05:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">littledan</span>: I don't have a full grasp of React's concurrent priorities. How are you imagining this will help?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Nov 17 2022 21:47:53 GMT-0800 (Pacific Standard Time)">05:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Slides are updated besides that.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Nov 18 2022 04:48:19 GMT-0800 (Pacific Standard Time)">12:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">How does this compare to <code>AsyncLocalStorage</code> in NodeJS? I've used that to good effect so far: <a href="https://nodejs.org/dist/latest-v19.x/docs/api/async_context.html#class-asynclocalstorage">https://nodejs.org/dist/latest-v19.x/docs/api/async_context.html#class-asynclocalstorage</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Nov 18 2022 05:28:05 GMT-0800 (Pacific Standard Time)">13:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-10">littledan</span>: I don't have a full grasp of React's concurrent priorities. How are you imagining this will help?</blockquote></mx-reply>I don’t have a full grasp of it either, but Yoav mentioned it in his talk too. Maybe ask Seb?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Nov 18 2022 05:29:26 GMT-0800 (Pacific Standard Time)">13:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How does this compare to <code>AsyncLocalStorage</code> in NodeJS? I've used that to good effect so far: <a href="https://nodejs.org/dist/latest-v19.x/docs/api/async_context.html#class-asynclocalstorage">https://nodejs.org/dist/latest-v19.x/docs/api/async_context.html#class-asynclocalstorage</a></blockquote></mx-reply>It is hoped to be roughly equivalent in expressiveness for normal usage, just omitting some weird misfeatures and simplifying the API surface.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Nov 18 2022 06:00:34 GMT-0800 (Pacific Standard Time)">14:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Misfeatures?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Nov 18 2022 06:06:42 GMT-0800 (Pacific Standard Time)">14:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'm curious what you're categorizing as misfeatures? <code>exit</code> is a convenience method that is shorthand for <code>run(undefined, ...)</code>,  <code>enterWith</code> is a convenient way to set the context value without introducing a closure (and thus avoiding TCP issues), and <code>disable</code> is a convenience wrapper for <code>enterWith(undefined)</code>.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Nov 18 2022 06:23:02 GMT-0800 (Pacific Standard Time)">14:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">The current proposal is seeking for a minimum API that can provide the necessary infrastructure in the language for async context propagation. Compared to the Node.js AsyncLocalStorage, they are motivated by the same requirement so they should be very similar.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Nov 18 2022 06:26:33 GMT-0800 (Pacific Standard Time)">14:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>For comparison, .NET has two ways of doing something similar:</p>
<p><code>AsyncLocal&lt;T&gt;</code> (<a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.asynclocal-1?view=net-7.0">https://learn.microsoft.com/en-us/dotnet/api/system.threading.asynclocal-1?view=net-7.0</a>) has a <code>.Value</code> property (analogous to Node's <code>AsyncLocalStorage.getStore()</code> and <code>.enterWith(store)</code></p>
<p><code>ExecutionContext</code> (<a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.executioncontext.run?view=netframework-4.8">https://learn.microsoft.com/en-us/dotnet/api/system.threading.executioncontext.run?view=netframework-4.8</a>) has <code>.Run()</code> (analogous to Node's <code><a href="http://AsyncLocalStorage.run">AsyncLocalStorage.run</a>()</code>) and can be used with <code>LogicalCallContext</code> (<a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.remoting.messaging.logicalcallcontext.getdata?view=netframework-4.8">https://learn.microsoft.com/en-us/dotnet/api/system.runtime.remoting.messaging.logicalcallcontext.getdata?view=netframework-4.8</a>) to get and set values associated with the logical call flow. It also has a <code>Dispose</code>, which is analogous to Node's <code>.disable()</code>.</p>
<p>In addition, <code>ExecutionContext</code> allows you to capture the current context, copy it into a new context, and suppress and restore the context across async invocations (using <code>AsyncFlowControl</code>).</p>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Nov 18 2022 06:27:35 GMT-0800 (Pacific Standard Time)">14:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">And <code>AsyncLocal&lt;T&gt;</code> is really just a convenient wrapper over <code>ExecutionContext</code></td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Nov 18 2022 06:28:21 GMT-0800 (Pacific Standard Time)">14:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If anything, I find Node's <code>AsyncLocalStorage</code> to be somewhat limited.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Nov 18 2022 06:30:29 GMT-0800 (Pacific Standard Time)">14:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'm also curious what the motivation is for <code>.wrap</code>? It seems like another convenience method, so I'm interested to know why that is prioritized over others.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Nov 18 2022 06:31:52 GMT-0800 (Pacific Standard Time)">14:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I can see not having <code>.exit()</code> and <code>.disable()</code>, but <code>.enterWith()</code> isn't a convenience method, it's a core capability.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Nov 18 2022 06:33:39 GMT-0800 (Pacific Standard Time)">14:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm also curious what the motivation is for <code>.wrap</code>? It seems like another convenience method, so I'm interested to know why that is prioritized over others.</blockquote></mx-reply>It snapshots the current context into the wrapped function, and restores it when the wrapped function is been invoked. It is part of the basic block to be able to defining userland queues with async context.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Nov 18 2022 06:34:33 GMT-0800 (Pacific Standard Time)">14:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Actually, I'll retract that last statement somewhat. My concern is about async context mutability without violating TCP, but that can be achieved via indirection, i.e. <code><a href="http://context.run">context.run</a>({ value: 1 }, () =&gt; { context.get().value++ })</code></td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Nov 18 2022 06:36:35 GMT-0800 (Pacific Standard Time)">14:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I don't disagree with its utility, but It's still a convenience method. You could achieve the same in userland with only <code>.run()</code> and <code>.get()</code>:</p>
<pre><code class="language-js">function wrap(ctx, cb) {
  const store = ctx.get();
  return () =&gt; ctx.run(store, cb);
}
</code></pre>
</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Nov 18 2022 06:38:06 GMT-0800 (Pacific Standard Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I don't disagree with its utility, but It's still a convenience method. You could achieve the same in userland with only <code>.run()</code> and <code>.get()</code>:</p>
<pre><code class="language-js">function wrap(ctx, cb) {
  const store = ctx.get();
  return () =&gt; ctx.run(store, cb);
}
</code></pre>
</blockquote></mx-reply>I don't think the <code>.wrap</code> in the proposal behaves the same in this example.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Nov 18 2022 06:38:33 GMT-0800 (Pacific Standard Time)">14:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Or, as a one-liner: <code>((store) =&gt; <a href="http://ctx.run">ctx.run</a>(store, cb))(ctx.get())</code></td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Nov 18 2022 06:39:41 GMT-0800 (Pacific Standard Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Ah, I see. <code>.wrap</code> captures <em>all</em> async contexts.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Nov 18 2022 06:39:48 GMT-0800 (Pacific Standard Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">The static wrap in the proposal snapshots the current global async context storage, in which all async context values are saved.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Nov 18 2022 06:39:59 GMT-0800 (Pacific Standard Time)">14:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So its more like .NET's <code>ExecutionContext.Capture()</code></td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Nov 18 2022 06:40:18 GMT-0800 (Pacific Standard Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Yes, with your pointers I think so.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Nov 18 2022 06:40:48 GMT-0800 (Pacific Standard Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Namings in the proposal are not the final decisions at this point.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Nov 18 2022 06:40:59 GMT-0800 (Pacific Standard Time)">14:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">In that case I'm finding the granularity of <code>.run()</code> at odds with the coarseness of <code>.wrap()</code>.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Nov 18 2022 06:42:44 GMT-0800 (Pacific Standard Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">In .NET, you have an <code>ExecutionContext</code> and a <code>LogicalCallContext</code>. When you call <code><a href="http://ExecutionContext.Run">ExecutionContext.Run</a></code>, you pass in what amounts to <em>the entire global async context storage</em>. You then manipulate that storage with <code>LogicalCallContext.GetData(key)</code> and <code>LogicalCallContext.SetData(key, value)</code>.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Nov 18 2022 06:50:33 GMT-0800 (Pacific Standard Time)">14:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>If you have multiple <code>AsyncContext</code> objects, you might end up with:</p>
<pre><code class="language-js">const ctx1 = new AsyncContext();
const ctx2 = new AsyncContext();

function foo() {
  ctx1.run({ id: 1 }, bar);
}

function bar() {
  ctx1.run({ id: 2 }, baz);
}

function baz() {
  ctx1.get(); // { id: 1 }
  ctx2.get(); // { id: 2 } 
}
</code></pre>
<p>While in .NET you might do:</p>
<pre><code class="language-cs">var local1 = new AsyncLocal&lt;number&gt;();
var local2 = new AsyncLocal&lt;number&gt;();

void Foo() {
  var context = ExecutionContext.CreateCopy();
  ExecutionContext.Run(context, () =&gt; {
    local1.Value = 1;
    Bar();
  });
}

void Bar() {
  local2.Value = 2;
  Baz();
}

void Baz() { ... }
</code></pre>
</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Nov 18 2022 06:51:58 GMT-0800 (Pacific Standard Time)">14:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I'm not opposed to the design of <code>AsyncContext</code> being a per-context <code>.run()</code>, I just find <code>.wrap</code> to be strange.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Nov 18 2022 06:53:28 GMT-0800 (Pacific Standard Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>From what I surmise, the purpose of <code>.wrap</code> is to address two specific needs:</p>
<ol>
<li>To capture the current logical call context (i.e., all global async context values)</li>
<li>To, at some point in the future, use that captured context to execute a callback.</li>
</ol>
</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Nov 18 2022 06:57:20 GMT-0800 (Pacific Standard Time)">14:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p><code>.wrap()</code> does that by combining those two operations into a single operation. This is fine if you want to wrap a single callback, but is less convenient if you want to capture all contexts and pass it to different callbacks:</p>
<pre><code class="language-js">const callWithContext = AsyncContext.wrap((cb, ...args) =&gt; cb(...args));
callWithContext(f);
callWithContext(g);
</code></pre>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Nov 18 2022 07:05:30 GMT-0800 (Pacific Standard Time)">15:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>vs. something like:</p>
<pre><code class="language-js">const context = AsyncContext.capture();

// with a `.run` method on the captured context...
context.run(f);
context.run(g);

// or with a static method
AsyncContext.runWithContext(context, f);
AsyncContext.runWithContext(context, g);
</code></pre>
<p>And if <code>AsyncContext</code> ever does become mutable (i.e., via <code>.enterWith</code>), you might want to be able to clone the global context so that async context mutations are local to the logical call:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
ctx.run(1, main);

function main() {
  const captured = AsyncContext.capture();
  const copied = AsyncContext.copyContext();

  AsyncContext.runWithContext(captured, foo);
  AsyncContext.runWithContext(copied, bar);

  console.log(ctx.get()); // 2 (bar's mutation acted on a copy)
}

function foo() {
  console.log(ctx.get()); // 1
  ctx.set(2);
}

function bar() {
  console.log(ctx.get()); // 1 (due to copy)
  ctx.set(3);
}
</code></pre>
</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Nov 18 2022 07:14:57 GMT-0800 (Pacific Standard Time)">15:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Also, without <code>.enterWith</code>, you could not easily emulate something like <code>AsyncLocal</code> in user code:</p>
<pre><code class="language-js">// with AsyncLocalStorage
class AsyncLocal {
  #context = new AsyncLocalStorage();
  get value() { return this.#context.getStore(); }
  set value(v) { this.#context.enterWith(v); }
}

const loc = new AsyncLocal();
loc.value = 1;
loc.value; // 1

// with AsyncContext
class AsyncLocal {
  #context = new AsyncContext();
  get value() { return this.#context.value; }
  set value(v) { this.#context.value = v; }
  enable(cb) {
    return this.#context.run({ value: undefined }, cb);
  }
}

const loc = new AsyncLocal();
loc.value = 1; // ReferenceError

// need to establish context first
loc.enable(() =&gt; {
  loc.value = 1;
  loc.value; // 1
});
</code></pre>
</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Nov 18 2022 07:35:01 GMT-0800 (Pacific Standard Time)">15:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">The user stories of these ideas are important to shape the API in the proposal. I believe it is worthwhile to visit those requirements in stage 1.</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Nov 18 2022 07:40:23 GMT-0800 (Pacific Standard Time)">15:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Actually, I'll retract that last statement somewhat. My concern is about async context mutability without violating TCP, but that can be achieved via indirection, i.e. <code><a href="http://context.run">context.run</a>({ value: 1 }, () =&gt; { context.get().value++ })</code></blockquote></mx-reply>I might get it wrong. Would you mind expanding on the TCP issue?</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Nov 18 2022 07:51:19 GMT-0800 (Pacific Standard Time)">15:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Tennent's Correspondence Principle (aka. "Tennent's Principle of Correspondence"): <a href="http://techscursion.com/2012/02/tennent-correspondence-principle.html">http://techscursion.com/2012/02/tennent-correspondence-principle.html</a></p>
<p>In plenary its often used to describe anything that changes the context of an expression such that the expression can no longer be evaluated in the same way, which is a bit of an more expanded definition than the actual principle.  The issue I'm concerned with is as follows:</p>
<p>Lets say you start with an async generator:</p>
<pre><code class="language-js">class C {
async function* foo() {
  await a();
  yield b();
  await c();
}
</code></pre>
<p>Now I need to</p>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Nov 18 2022 07:53:12 GMT-0800 (Pacific Standard Time)">15:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Now I need to introduce an async context for b() and c():</p>
<pre><code class="language-js">const ctx = new AsyncContext();
class C {
  async * foo() {
    await a();
    ctx.run(value, () =&gt; {
      yield b(); // syntax error, arrow function is not a generator
      await this.c(); // syntax error, arrow function is not async
    });
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Nov 18 2022 07:54:02 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I can make that an async arrow:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
class C {
  async * foo() {
    await a();
    await ctx.run(value, async () =&gt; {
      yield b(); // syntax error, arrow function is not a generator
      await this.c(); // ok
    });
  }
}
</code></pre>
<p>But that won't work with <code>yield</code>.</p>
</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Nov 18 2022 07:54:52 GMT-0800 (Pacific Standard Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I can make it an async generator:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
class C {
  async * foo() {
    await a();
    ctx.run(value, async function *() {
      yield b(); // ok
      await this.c(); // reference error, this is undefined
    });
  }
}
</code></pre>
<p>But that won't work with the <code>this</code> binding.</p>
</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Nov 18 2022 07:55:13 GMT-0800 (Pacific Standard Time)">15:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">any solution requires significant refactoring.</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Nov 18 2022 07:56:15 GMT-0800 (Pacific Standard Time)">15:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>vs. an <code>enterWith</code>:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
class C {
  async * foo() {
    await a();
    ctx.enterWith(value);
    try {
      yield b();
      await this.c();
    }
    finally {
      ctx.disable();
    }
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Nov 18 2022 07:57:50 GMT-0800 (Pacific Standard Time)">15:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>And that could be potentially even more convenient with <code>using</code> declarations:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
class C {
  async * foo() {
    await a();
    using _ = ctx.enterWith(value); // assumes disposable return value...
    yield b();
    await this.c();
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Nov 18 2022 08:05:07 GMT-0800 (Pacific Standard Time)">16:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">TCP violations aren't necessarily bad, but are indicative of inconsistencies in the language. For example, using <code><a href="http://ctx.run">ctx.run</a></code> would be fine if there was an async generator equivalent for arrow functions so that we could more easily preserve <code>await</code>, <code>this</code>, and <code>yield</code></td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Nov 18 2022 08:09:38 GMT-0800 (Pacific Standard Time)">16:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Thanks for sharing! This is a very interesting point on <code>.setValue</code> versus a structured <code>.run</code> method as the basic block.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Nov 18 2022 09:20:38 GMT-0800 (Pacific Standard Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I can see not having <code>.exit()</code> and <code>.disable()</code>, but <code>.enterWith()</code> isn't a convenience method, it's a core capability.</blockquote></mx-reply>Still reading, all the messages, but this is the first I disagree with. The way I'm explaining the proposal during the meeting will be to equate it with putting data onto the call stack, and <code>.enterWith()</code> doesn't create a new callstack entry.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Nov 18 2022 09:21:08 GMT-0800 (Pacific Standard Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The behavior here of leaking data beyond the current callstack, and mutating the containing callstack's data for other execution that follows the current, is only a source of bugs.</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Nov 18 2022 09:30:36 GMT-0800 (Pacific Standard Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>vs. something like:</p>
<pre><code class="language-js">const context = AsyncContext.capture();

// with a `.run` method on the captured context...
context.run(f);
context.run(g);

// or with a static method
AsyncContext.runWithContext(context, f);
AsyncContext.runWithContext(context, g);
</code></pre>
<p>And if <code>AsyncContext</code> ever does become mutable (i.e., via <code>.enterWith</code>), you might want to be able to clone the global context so that async context mutations are local to the logical call:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
ctx.run(1, main);

function main() {
  const captured = AsyncContext.capture();
  const copied = AsyncContext.copyContext();

  AsyncContext.runWithContext(captured, foo);
  AsyncContext.runWithContext(copied, bar);

  console.log(ctx.get()); // 2 (bar's mutation acted on a copy)
}

function foo() {
  console.log(ctx.get()); // 1
  ctx.set(2);
}

function bar() {
  console.log(ctx.get()); // 1 (due to copy)
  ctx.set(3);
}
</code></pre>
</blockquote></mx-reply>Dan suggested we not reify the snapshot into a class structure. Your suggestion matches pretty closely with what I have in <a href="https://gist.github.com/jridgewell/3970a3078ebfb90e90cd9d0a36ab9c08#file-async-context-ts-L7-L20">my gist</a></td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Nov 18 2022 09:56:06 GMT-0800 (Pacific Standard Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I still am having trouble understanding the motivation for this reified design</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Nov 18 2022 10:11:43 GMT-0800 (Pacific Standard Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I still am having trouble understanding the motivation for this reified design</blockquote></mx-reply><p>A <code>.wrap()</code> method makes it easy to wrap a <em>single</em> callback in a captured execution context, but harder to reuse that context for multiple callbacks without incurring the overhead of an additional function wrapper for each callback.</p>
<p>A <code>.capture()</code> method, and an associated <code>.run(globalContext, cb)</code> method make it easy to reuse a context with multiple functions without incurring the overhead of a function wrapper.</p>
<p>Either can be composed with the other, however:</p>
<pre><code class="language-js">// emulate `capture` if you only have `wrap()`:

function capture() {
    return AsyncContext.wrap((cb, ...args) =&gt; cb(...args));
}

// wrap a single callback
const wrapped = AsyncContext.wrap(cb);
setImmediate(() =&gt; {
    wrapped();
});

// capture context and use with multiple functions
const context = capture();
setImmediate(() =&gt; {
    context(foo);
    context(bar);
});

// emulate `wrap` if you only have `capture()`:

// assumes `AsyncContext.capture()` produces `(cb, ...args) =&gt; any`
function wrap(cb) {
    const context = AsyncContext.capture();
    return (...args) =&gt; context(cb, ...args);
}

// wrap a single callback
const wrapped = wrap(cb);
setImmediate(() =&gt; {
    wrapped();
});

// capture context and use with multiple functions
const context = AsyncContext.capture();
setImmediate(() =&gt; {
    context(foo);
    context(bar);
});
</code></pre>
</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Nov 18 2022 10:14:06 GMT-0800 (Pacific Standard Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'd argue its a bit more obvious to a developer that they can do the following to wrap:</p>
<pre><code class="language-js">const context = AsyncContext.capture();
return () =&gt; context(f);
</code></pre>
<p>vs. the more opaque syntax needed to emulate <code>context()</code>:</p>
<pre><code class="language-js">const context = AsyncContext.wrap((cb, ...args) =&gt; cb(...args));
context(f);
</code></pre>
</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Nov 18 2022 10:14:32 GMT-0800 (Pacific Standard Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But I would argue to have both rather than just one or the other.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Nov 18 2022 10:16:52 GMT-0800 (Pacific Standard Time)">18:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I agree, I think that makes is simpler for restoring before multiple callbacks</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Nov 18 2022 10:17:28 GMT-0800 (Pacific Standard Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I also wonder if the MVP should include a mechanism for async context control flow so its easier to escape a global context.</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Nov 18 2022 10:17:57 GMT-0800 (Pacific Standard Time)">18:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">My examples above use <code>setImmediate</code>, but what if <code>setImmediate</code> <em>also</em> passes along the current execution context?</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Nov 18 2022 10:19:26 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">.NET has <code>ExecutionContext.SuppressFlow()</code> and <code>ExecutionContext.RestoreFlow()</code> for this purpose, and the result of <code>SuppressFlow()</code> is disposable (if disposed, it will call <code>RestoreFlow()</code> for you).</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Nov 18 2022 10:19:59 GMT-0800 (Pacific Standard Time)">18:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">(It's intended to keep the execution context, but <code>setImmediate</code> and friends don't live in 262)</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Nov 18 2022 10:20:31 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">then we <em>definitely</em> need a way to escape an execution context.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Nov 18 2022 10:20:59 GMT-0800 (Pacific Standard Time)">18:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It's already possible with <code>.wrap()</code> in the top level scope</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Nov 18 2022 10:22:03 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">const suppressed = AsyncContext.wrap((cb, …args) =&gt; cb(…args));

context.run(1, () =&gt; {
  suppressed(() =&gt; {
    context.get() === undefined;
  });
});
</code></pre>
</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Nov 18 2022 10:23:23 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes, but that wouldn't work well if async contexts were mutable like Node's <code>AsyncLocalStorage.enterWith</code>, since that can set up a context at the top level before your module body runs.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Nov 18 2022 10:23:52 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">then again, <code>capture</code> and <code>copy</code> would have the same problem I suppose.</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Nov 18 2022 10:24:00 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">As I said above, I think mutable context is a bug (and very likely to hit challenges with the SES folks)</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Nov 18 2022 10:24:21 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">But a <code>suppressFlow()</code> would avoid that as well.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Nov 18 2022 10:24:22 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I really don't wanna support it.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Nov 18 2022 10:24:42 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Definite +1 on not supporting mutable context. Not a fan of enterWith</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Nov 18 2022 10:25:11 GMT-0800 (Pacific Standard Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Something like <code>SuppressFlow()</code> would also work well with <code>using</code> declarations, i.e.:</p>
<pre><code class="language-js">const ctx = new AsyncContext();
ctx.run(1, foo);

async function foo() {
  console.log(ctx.get()); // 1
  {
    using flow = AsyncContext.suppressFlow();
    console.log(ctx.get()); // undefined
  }
  console.log(ctx.get()); // 1
}
</code></pre>
</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Nov 18 2022 10:27:47 GMT-0800 (Pacific Standard Time)">18:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'd really like to be able to have a simple <code>AsyncLocal</code> primitive, or even an <code>@AsyncLocal</code> decorator (not unlike a potential <code>@ThreadLocal</code> decorator that could someday exist for shared structs):</p>
<pre><code class="language-js">class HttpServer {
  @AsyncLocal
  accessor currentRequest;
  ...
}
</code></pre>
<p>But that wouldn't work without the ability attach an async context to the <em>current</em> execution context without needing to go through a <code>.run</code> call.</p>
</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Nov 18 2022 10:29:54 GMT-0800 (Pacific Standard Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Definite +1 on not supporting mutable context. Not a fan of enterWith</blockquote></mx-reply>Yet <code><a href="http://context.run">context.run</a>({ value: 1 }, () =&gt; context.get().value++)</code> is still mutable. Not having <code>enterWith</code> just makes other related primitives harder to implement.</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Nov 18 2022 10:35:03 GMT-0800 (Pacific Standard Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yeah, and we have plenty of use cases where folks add to or change values in the context... mutable context is likely the wrong phrase. I'm not a big fan of the enterWith(...) model at all, and I shouldn't be able to completely replace the context value.</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Nov 18 2022 10:37:29 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">unfortunately I'm on my way out the door for an appointment. Will be back and will try to weigh in more</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Nov 18 2022 10:37:31 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Its not the wrong phrase. I was just illustrating that an <em>immutable context</em> can still hold <em>mutable values</em>. And in most other languages I'm familiar with, the context is also mutable.</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Nov 18 2022 10:37:45 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">tl;dr is just I really dislike enterWith</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Nov 18 2022 10:37:55 GMT-0800 (Pacific Standard Time)">18:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">will be back later</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Nov 18 2022 10:40:06 GMT-0800 (Pacific Standard Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">(I'm looking for Marks' comments on mutability during our call)</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Nov 18 2022 10:40:45 GMT-0800 (Pacific Standard Time)">18:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The model that I'm building the slides is simple to explain only because we don't need deep integration with the runtime</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Nov 18 2022 10:42:57 GMT-0800 (Pacific Standard Time)">18:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><p>If we were to support mutable contexts, it would either</p>
<ul>
<li>allow one function to replace the context for sibling calls (which I think is what Mark is objecting to)</li>
<li>push a context onto the stack (but then it's not obvious where we would pop with deep integration with the host's actual call stack)</li>
</ul>
</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Nov 18 2022 10:43:47 GMT-0800 (Pacific Standard Time)">18:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It's <em>possible</em> we could work this with Disposable proposal, but I don't want to the two proposals together</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Nov 18 2022 10:45:14 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The current <code>.run()</code>'s try-finally push-call-pop can be understood extremely easily and it's directly teachable with what's possible in userland today with sync execution</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Nov 18 2022 10:45:20 GMT-0800 (Pacific Standard Time)">18:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I <em>really</em> like that it's simple</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Nov 18 2022 11:41:26 GMT-0800 (Pacific Standard Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><blockquote>
<ul>
<li>allow one function to replace the context for sibling calls (which I think is what Mark is objecting to)</li>
</ul>
</blockquote>
<p>In a mutable context world, you would use <code>.copyContext()</code> to clone the global context to avoid mutations in siblings.</p>
</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Nov 18 2022 11:41:31 GMT-0800 (Pacific Standard Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Here's the part where Mark starts talking about mutability: <a href="https://youtu.be/Y6hQLM08Ig8?t=4513">https://youtu.be/Y6hQLM08Ig8?t=4513</a></td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Nov 18 2022 11:44:01 GMT-0800 (Pacific Standard Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">And a bit more at <a href="https://youtu.be/Y6hQLM08Ig8?t=5106">https://youtu.be/Y6hQLM08Ig8?t=5106</a></td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Nov 18 2022 13:38:42 GMT-0800 (Pacific Standard Time)">21:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But I would argue to have both rather than just one or the other.</blockquote></mx-reply>Yeah, my interpretation has been that each can express the other; that's why my intuition was that we should go with the smaller API surface</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Nov 18 2022 13:39:25 GMT-0800 (Pacific Standard Time)">21:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(smaller API surface was a guiding principle of <span class="nick-7">Chengzhong Wu</span> 's recent edits and I like it, even if I have other preferences for the exact form)</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Nov 18 2022 13:54:40 GMT-0800 (Pacific Standard Time)">21:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I don't mind a small API surface, my concerns stem from ensuring the appropriate building blocks are surfaced. Most of what I've mentioned is inconsequential, you can implement some of the missing functionality in terms of other functionality. The <code>@AsyncLocal</code> or <code>new AsyncLocal()</code> approach can't be solved with the current API, which makes it infeasible to do in userland. Suspending and resuming global async context flow is only barely feasible given that it requires you do <code>const emptyContext = AsyncContext.wrap((cb, ...args) =&gt; cb(...args))</code> at the top level before any context is created, which certainly isn't a great developer experience.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Nov 18 2022 13:58:29 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Could this be solve by using a mutable object in the context, and allowing a default value when constructing?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Nov 18 2022 13:58:39 GMT-0800 (Pacific Standard Time)">21:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I don't understand the decorator usecase yet.</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Nov 18 2022 13:59:12 GMT-0800 (Pacific Standard Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">But a default value would allow the your <code>AsyncLocal</code> example to work at the top-level</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Nov 18 2022 13:59:20 GMT-0800 (Pacific Standard Time)">21:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">(React also allows a default value for its contexts)</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Nov 18 2022 14:00:36 GMT-0800 (Pacific Standard Time)">22:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Except there's no way to switch contexts with just <code>@AsyncLocal</code>, it depends on the ability to copy a context or suppress async flow to actually get a different value each time.</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Nov 18 2022 14:01:15 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Can you explain more? What would code using this look like?</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Nov 18 2022 14:01:43 GMT-0800 (Pacific Standard Time)">22:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I don't understand what a context would do unless there is execution that happens further down the callstack</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Fri Nov 18 2022 14:04:47 GMT-0800 (Pacific Standard Time)">22:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">One moment, I'm refreshing my knowledge of how <code>AsyncLocal</code> works in .NET to make sure I'm not misspeaking</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Fri Nov 18 2022 14:05:59 GMT-0800 (Pacific Standard Time)">22:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah I agree you shouldn't have to run top-level code (this always creates problems with composition/packaging), but I'd like to understand the use case for escaping all the contexts</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Fri Nov 18 2022 14:07:07 GMT-0800 (Pacific Standard Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">we should expect the platform itself to make some context variables too, so I'm not even sure what it means to escape all of them</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Fri Nov 18 2022 14:07:31 GMT-0800 (Pacific Standard Time)">22:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It looks like how .NET's <code>AsyncLocal</code> works, is that each "mutation" of the local results in the local values in the execution context being copied, such that when an <code>await</code> occurs, the current snapshot of the locals in the execution context is copied to the context bound to that <code>await</code>.</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Fri Nov 18 2022 14:11:26 GMT-0800 (Pacific Standard Time)">22:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>So based on that, here's a rough example:</p>
<pre><code class="language-js">const local = new AsyncLocal();
local.value = 1;
await foo(); 

// mutation of local doesn't change the snapshot seen by the `await` in foo
local.value = 2; 

await bar();

function foo() {
  console.log(local.value); // 1

  // takes snapshot of current async execution context
  // restores snapshot when `await` resumes
  await Promise.resolve(); 

  console.log(local.value); // 1
}

function bar() {
  console.log(local.value); // 2

  // takes snapshot of current async execution context
  // restores snapshot when `await` resumes
  await Promise.resolve(); 

  console.log(local.value); // 2
}
</code></pre>
</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Fri Nov 18 2022 14:13:36 GMT-0800 (Pacific Standard Time)">22:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah, I can see how this snapshotting approach is convenient; I guess I prefer the <code>run</code>-based API which makes it a bit more explicit when the copying occurs</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Fri Nov 18 2022 14:14:22 GMT-0800 (Pacific Standard Time)">22:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I sort of assumed that, with what's in the main branch of AsyncContext, the get/set functions didn't have any copying semantics, that you're responsible for saving and restoring things when appropriate</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Fri Nov 18 2022 14:15:33 GMT-0800 (Pacific Standard Time)">22:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">maybe I understood wrong?</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Fri Nov 18 2022 14:17:06 GMT-0800 (Pacific Standard Time)">22:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">anyway if you only have <code>run</code> and not a setter, then it is sort of clearer why <code>run</code> doesn't hold in the reaction (because you've already exited it by then)</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Fri Nov 18 2022 14:17:38 GMT-0800 (Pacific Standard Time)">22:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I think earlier I said .NET has two approaches: <code>AsyncLocal</code> which stores a local associated with async control flow, and <code>ExecutionContext</code>, which has a logical call context that can have data stored within it.</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Fri Nov 18 2022 14:18:14 GMT-0800 (Pacific Standard Time)">22:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code><a href="http://ExecutionContext.Run">ExecutionContext.Run</a>()</code> is kind of like <code><a href="http://AsyncContext.prototype.run">AsyncContext.prototype.run</a>()</code>, except it covers the entire execution context, not just a single value.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Fri Nov 18 2022 14:19:08 GMT-0800 (Pacific Standard Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><code>AsyncLocal</code> state is <em>stored</em> in an <code>ExecutionContext</code>, but that context is captured and restored whenever you create a <code>Task</code> or a task continuation is invoked.</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Fri Nov 18 2022 14:19:40 GMT-0800 (Pacific Standard Time)">22:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So <code>AsyncLocal</code> (which snapshots) is built on an <code>ExecutionContext</code> (which is mutable).</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Fri Nov 18 2022 14:21:33 GMT-0800 (Pacific Standard Time)">22:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I see</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Fri Nov 18 2022 14:22:07 GMT-0800 (Pacific Standard Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Do you have an example of something you can do in this system which wouldn't work with the kinds of approaches we've been discussing?</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Fri Nov 18 2022 14:22:17 GMT-0800 (Pacific Standard Time)">22:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(apologies if that's above)</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Fri Nov 18 2022 14:23:30 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>So in .NET, you can do:</p>
<pre><code class="language-cs">LogicalCallContext.SetData("foo", 1);
var context = ExecutionContext.Capture();

ExecutionContext.Run(context, () =&gt; {
  Console.WriteLine(LogicalCallContext.GetData("foo")); // 1
  LogicalCallContext.SetData("foo", 2);
});

Console.WriteLine(LogicalCallContext.GetData("foo")); // 2
</code></pre>
<p>Since the context is mutable.</p>
</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Fri Nov 18 2022 14:26:57 GMT-0800 (Pacific Standard Time)">22:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do you have an example of something you can do in this system which wouldn't work with the kinds of approaches we've been discussing?</blockquote></mx-reply><p>Since AsyncLocal does snapshotting, its very useful for fork/join operations like this:</p>
<pre><code class="language-js">const local = new AsyncLocal();
local.value = 1;
await Promise.all(operations.map(async (op) =&gt; {
  await op.execute(); // where op.execute reads or writes local.value
}));
</code></pre>
<p>Where each <code>op.execute()</code> gets a copy of the state, such that any state mutations don't affect other parallel tasks.</p>
</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Fri Nov 18 2022 14:28:32 GMT-0800 (Pacific Standard Time)">22:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">In reality, this probably can't be implemented in userland regardless. The kind of snapshotting that is necessary would require the same hooks that <code>AsyncContext</code> needs to restore the context after <code>await</code>.</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Fri Nov 18 2022 14:29:41 GMT-0800 (Pacific Standard Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">the upside of <code>AsyncLocal</code> is that you don't really need to worry about closures and TCP</td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Fri Nov 18 2022 14:29:45 GMT-0800 (Pacific Standard Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I guess all of the alternatives here have the property (which I agree is essential) that you can write to the variable without affecting parallel tasks. The <code>run</code> method certainly does, at least.</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Fri Nov 18 2022 14:30:50 GMT-0800 (Pacific Standard Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> the upside of <code>AsyncLocal</code> is that you don't really need to worry about closures and TCP</blockquote></mx-reply>I see, I guess this is the part I need to understand better (probably you already explained this and I need to reread the logs)</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Fri Nov 18 2022 14:31:28 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I guess all of the alternatives here have the property (which I agree is essential) that you can write to the variable without affecting parallel tasks. The <code>run</code> method certainly does, at least.</blockquote></mx-reply>I guess the get/set functions in the main branch would not handle this properly</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Fri Nov 18 2022 14:31:40 GMT-0800 (Pacific Standard Time)">22:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">No, I've been a bit randomized today so I feel I've been jumping around between topics too frequently and may not be making a coherent argument.</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Fri Nov 18 2022 14:37:08 GMT-0800 (Pacific Standard Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'll simplify my thoughts:</p>
<ul>
<li><code>new AsyncContext()</code> is great.</li>
<li><code><a href="http://AsyncContext.prototype.run">AsyncContext.prototype.run</a>()</code> is great.</li>
<li><code>AsyncContext.prototype.get()</code> is great.</li>
<li>The capability introduced by <code>AsyncContext.wrap()</code> is necessary, but has some ergonomics issues I have concerns about.</li>
<li>The minimal API for <code>AsyncContext</code> means some other useful primitives like an <code>AsyncLocal</code> can't be modeled in userland. However, its likely it would need to be introduced as a built-in anyways if we wanted anything like snapshotting capabilities such that the value is associated with control flow.</li>
<li>A way to suppress and restore the global context is necessary, and I'm not convinced the approach of a "call to <code>AsyncContext.wrap()</code> at the top level" is sufficiently ergonomic.</li>
</ul>
</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Fri Nov 18 2022 14:40:51 GMT-0800 (Pacific Standard Time)">22:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If the value associated with an <code>AsyncContext</code> is immutable, then a <code>.copyContext()</code> isn't necessary because <em>every</em> <code>await</code> (or other async mechanism) would already snapshot the current global execution context.</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Fri Nov 18 2022 14:44:56 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I guess I could see how freely getting/setting and expecting the snapshotting to be automatic can't be built in terms of <code>run</code>, and what I don't understand yet is why we'd want that.</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Fri Nov 18 2022 14:45:09 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I also don't understand in what sorts of cases you'd want to restore the global context</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Fri Nov 18 2022 14:45:27 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think we can support both, but I would want to see use cases that can't be solved by the immutable context</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Fri Nov 18 2022 14:45:30 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I guess I assumed that it'd be an anti-goal to have any sort of notion of the global context</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Fri Nov 18 2022 14:45:41 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(since it's sort of anti-compositional)</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Fri Nov 18 2022 14:48:20 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don’t have a full grasp of it either, but Yoav mentioned it in his talk too. Maybe ask Seb?</blockquote></mx-reply>Seb pushed me back to talking about <code>cache</code>, but dropping <code>use</code> discussion (it's not necessary, client will support async/await without it)</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Fri Nov 18 2022 14:48:37 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Not that I don't need to discuss <code>use</code>, I can dive deeper into the real use for this for client side</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Fri Nov 18 2022 14:48:43 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Seb pushed me back to talking about <code>cache</code>, but dropping <code>use</code> discussion (it's not necessary, client will support async/await without it)</blockquote></mx-reply>Did he not like the idea of discussing priorities?</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Fri Nov 18 2022 14:49:12 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I mean, more importantly: would this feature be useful for priorities?</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Fri Nov 18 2022 14:49:20 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yah, he said that priorities really needs brower APIs that this won't solve (the priority scheduler work would be the API)</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Fri Nov 18 2022 14:49:47 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Possibly, in that they could store the priority on an <code>AsyncContext</code></td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Fri Nov 18 2022 14:49:52 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">ah, but as discussed in Yoav's talk, browsers are unable to make this capability due to <em>the need for the same platform feature</em></td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Fri Nov 18 2022 14:50:12 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">But it needs platform support to not be able to create a high priority task from a low priority one, and that's not solved by us</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Fri Nov 18 2022 14:50:24 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I guess I could see how freely getting/setting and expecting the snapshotting to be automatic can't be built in terms of <code>run</code>, and what I don't understand yet is why we'd want that.</blockquote></mx-reply>I think that's actually how the proposal probably works right now.</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Fri Nov 18 2022 14:51:00 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think that's actually how the proposal probably works right now.</blockquote></mx-reply>by "right now" you mean the flat get/set variable API in the main branch?</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Fri Nov 18 2022 14:51:04 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">No</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Fri Nov 18 2022 14:51:35 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Sorry, no. Snapshotting is likely how we would achieve the semantics that Justin Ridgewell seems to prefer.</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Fri Nov 18 2022 14:51:44 GMT-0800 (Pacific Standard Time)">22:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> But it needs platform support to not be able to create a high priority task from a low priority one, and that's not solved by us</blockquote></mx-reply>hmm, I would like to dig into this more (but maybe another day/with Seb and/or Yoav)</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Fri Nov 18 2022 14:54:01 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Sorry, no. Snapshotting is likely how we would achieve the semantics that Justin Ridgewell seems to prefer.</blockquote></mx-reply>What do you mean by this?</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Fri Nov 18 2022 14:54:02 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Imagine the current execution context as an ImmutableMap. Adding or replacing entries in the map copies the map.<br>So:</p>
<pre><code class="language-js">const ctx1 = new AsyncContext();
const ctx2 = new AsyncContext();
const ctx3 = new AsyncContext();

// execution context: {}
ctx1.run("a", () =&gt; {
  // execution context: { [ctx1]: "a" }
  ctx2.run("b", () =&gt; {
    // execution context: { [ctx1]: "a", [ctx2]: "b" }
  });
  ctx3.run("c", () =&gt; {
    // execution context: { [ctx1]: "a", [ctx3]: "c" }
  });
});
</code></pre>
</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Fri Nov 18 2022 14:54:51 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Yes, well, if that is snapshotting, then I agree it's how we'd achieve the semantics</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Fri Nov 18 2022 14:54:57 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You don't mutate the execution context, you copy it when you call <code><a href="http://contxt.run">contxt.run</a></code>, adding or replacing the value for <code>context</code> in the copy of the execution context seen by the callback.</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Fri Nov 18 2022 14:55:05 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">let __storage__ = new Map();
class AsyncContext {
  // Pushes a new state, and pops it when done
  run(val, cb) {
    let prev = __storage__;
    try {
      this.set(val);
      return cb();
    } finally {
      __storage__ = prev;
    }
  }

  // Mutates the current state
  set(val) {
    const next = new Map(__storage__);
    next.set(this, val);
    __storage__ = next;
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Fri Nov 18 2022 14:55:11 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I like to think of it as, a singly-linked list, which you don't need to copy, just push associations onto</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Fri Nov 18 2022 14:55:31 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">this differentiates <code>run</code> from an AsyncLocal that you can literally mutate (which woudln't have that property)</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Fri Nov 18 2022 14:55:52 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">Justin Ridgewell</span>: Yes, while you can't mutate the execution context itself (since its immutable), you can mutate the values stored in it.</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Fri Nov 18 2022 14:56:24 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I like to think of it as, a singly-linked list, which you don't need to copy, just push associations onto</blockquote></mx-reply>and this singly linked list is immutable; the only thing that changes is the pointer to its root</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Fri Nov 18 2022 14:56:55 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">so if that's our data model, the usage of AsyncContext is somehow "structured" (debatable how useful that is, I'm just describing how I'm conceptualizing this)</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Fri Nov 18 2022 14:57:03 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> and this singly linked list is immutable; the only thing that changes is the pointer to its root</blockquote></mx-reply>Yes, and that's how an <code>ImmutableDictionary</code> would be implemented. Not precisely a "copy" but essentially a snapshot since it can't be changed.</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Fri Nov 18 2022 14:57:59 GMT-0800 (Pacific Standard Time)">22:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">right so since the snapshot operation is the identity function, we don't have to worry about "when" the snapshot occurs, just when/how the mutation occurs (with <code>run</code>)</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Fri Nov 18 2022 14:58:09 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The difference between <code>AsyncContext</code> and something like <code>AsyncLocal</code>, is that <code>AsyncContext</code> is <em>explicit</em> (you must call <code>.run()</code>, while <code>AsyncLocal</code> is implicit.</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Fri Nov 18 2022 14:58:33 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Makes sense</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Fri Nov 18 2022 14:58:53 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I can see how the two things have this difference; I haven't yet understood the downside of explicitness</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Fri Nov 18 2022 15:00:25 GMT-0800 (Pacific Standard Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Explicitness is fine for imperative code, not so much for declarative code (such as using with decorators). Also the TCP issue (managing <code>yield</code>, <code>await</code>, and <code>this</code> when you shift to a callback).</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Fri Nov 18 2022 15:22:40 GMT-0800 (Pacific Standard Time)">23:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Imagine there was an internal <code>ExecutionContext</code> object that had an immutable dictionary of <code>AsyncContext-&gt;value</code> entries. What an <code>AsyncLocal</code> would need is a second immutable dictionary on that object:</p>
<pre><code class="language-ts">// internal implementation details...
class ExecutionContext {
  #asyncContextValues;
  #asyncLocalValues;
  constructor(asyncContextValues, asyncLocalValues) {
    this.#asyncContextValues = asyncContextValues;
    this.#asyncLocalValues = asyncLocalValues;
  }

  static get current() {
    return %GetCurrentExecutionContext();
  }

  static set current(value) {
    %SetCurrentExecutionContext(value);
  }

  static create() {
    return new ExecutionContext(new ImmutableMap(), new ImmutableMap());
  }

  copy() {
    return new ExecutionContext(this.#asyncContextValues, this.#asyncLocalValues);
  }

  getContext(key) {
    return this.#asyncContextValues.get(key);
  }

  getLocal(key) {
    return this.#asyncLocalValues.get(key);
  }

  setLocal(key, value) {
    this.#asyncLocalValues = this.#asyncLocalValues.set(key, value);
  }

  runWithContext(asyncContext, value, callback, args) {
    const context = new ExecutionContext(this.#asyncContextValues.set(asyncContext, value), this.#asyncLocalValues);
    return %RunWithContext(context, callback, args);
  }
}

// global scope would have a root context
ExecutionContext.current = ExecutionContext.create();

// public
class AsyncContext {
  run(value, callback, ...args) {
    return ExecutionContext.current.runWithContext(this, value, callback, args);
  }

  get() {
    return ExecutionContext.current.getContext(this);
  }

  static wrap(cb) {
    const captured = ExecutionContext.current;
    return (...args) =&gt; {
      const current = ExecutionContext.current;
      try {
        ExecutionContext.captured = captured;
        return cb(...args);
      }
      finally {
        ExecutionContext.current = current;
      }
    }
  }
}

// public
class AsyncLocal {
  get value() { return ExecutionContext.current.getLocal(this); }
  set value(v) { ExecutionContext.current.setLocal(this, v); }
}

// and `await f()` is translated to something like:

const result = Promise.resolve(f());
result.[[ExecutionContext]] = ExecutionContext.current.copy(); // used for continuations
await result;

</code></pre>
<p>An <code>await</code> would just preserve the pointer to the <code>AsyncContext</code> entries, but get an independent reference to the <code>AsyncLocal</code> entries. Mutating the <code>asyncLocalValues</code> reference wouldn't affect snapshots taken during <code>await</code>.</p>
</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Fri Nov 18 2022 15:23:26 GMT-0800 (Pacific Standard Time)">23:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Explicitness is fine for imperative code, not so much for declarative code (such as using with decorators). Also the TCP issue (managing <code>yield</code>, <code>await</code>, and <code>this</code> when you shift to a callback).</blockquote></mx-reply>Ah, I see (abstractly, still trying to conceptualize how this relates to likely concrete code)</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Fri Nov 18 2022 15:24:06 GMT-0800 (Pacific Standard Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Most of the real world examples I can think of are related to things like HttpContext in <a href="http://ASP.NET">ASP.NET</a>, which I'm a few years out from using regularly.</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Fri Nov 18 2022 15:24:24 GMT-0800 (Pacific Standard Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">my intuition is that it's generally a "big deal" when you use <code>run</code>. There are many wrapped callbacks/promise reactions for every big <code>run</code> setting up a context</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Fri Nov 18 2022 15:24:26 GMT-0800 (Pacific Standard Time)">23:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I've used this feature in .NET a fair bit though.</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Fri Nov 18 2022 15:25:57 GMT-0800 (Pacific Standard Time)">23:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So really, neither <code>AsyncContext</code> nor <code>AsyncLocal</code> are the actual building block, but rather <code>ExecutionContext</code> is. However, I think <code>ExecutionContext</code> provides too much access to internals.</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Fri Nov 18 2022 15:27:19 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> my intuition is that it's generally a "big deal" when you use <code>run</code>. There are many wrapped callbacks/promise reactions for every big <code>run</code> setting up a context</blockquote></mx-reply>Yes, and that's generally true for an <code>ExecutionContext</code> which is a bit more coarse grained. You will see <code><a href="http://asyncContext.run">asyncContext.run</a></code> more often since its so granular (i.e., a single value). <code>AsyncLocal</code> is designed to be more lightweight.</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Fri Nov 18 2022 15:27:45 GMT-0800 (Pacific Standard Time)">23:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">so, we're talking about <a href="https://learn.microsoft.com/en-us/dotnet/api/system.web.httpcontext?view=netframework-4.8">https://learn.microsoft.com/en-us/dotnet/api/system.web.httpcontext?view=netframework-4.8</a> ?</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Fri Nov 18 2022 15:28:02 GMT-0800 (Pacific Standard Time)">23:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">When I'm talking about HttpContext, yes.</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Fri Nov 18 2022 15:28:04 GMT-0800 (Pacific Standard Time)">23:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">that looks like an example of something coarse-grained, which library user code doesn't manually set</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Fri Nov 18 2022 15:28:15 GMT-0800 (Pacific Standard Time)">23:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">HttpContext.Items uses LogicalCallContext.GetValue under the hood.</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Fri Nov 18 2022 15:28:57 GMT-0800 (Pacific Standard Time)">23:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">And multiple HttpRequests are handled by calls to <a href="http://ExecutionContext.Run">ExecutionContext.Run</a>, which provides isolated execution contexts containing sensitive things like the current security principal, in addition to HttpRequests and responses.</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Fri Nov 18 2022 15:30:54 GMT-0800 (Pacific Standard Time)">23:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">this is also how a lightweight version of MEF (Managed Extensibility Framework) interacted with HttpContext to provide dependency injection for web applications. When a new HttpRequest is created, a new DI composition scope would be created and associated with the request context, allowing you to pull in request-specific services.</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Fri Nov 18 2022 15:31:52 GMT-0800 (Pacific Standard Time)">23:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Again, I'm a few years out from using that actively so some things may have changed.</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Fri Nov 18 2022 15:32:40 GMT-0800 (Pacific Standard Time)">23:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">well, it's interesting to hear about this; it's not so relevant if this is current</td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Fri Nov 18 2022 15:33:07 GMT-0800 (Pacific Standard Time)">23:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The underlying logic is still actively in use, even if some parts have changed.</td></tr>
  <tr class="msg" id="L167"><td class="ts-cell"><a class="ts" href="#L167" alt="Fri Nov 18 2022 15:33:08 GMT-0800 (Pacific Standard Time)">23:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Does the security aspect mean that it should be top-level, or just that the framework needs to be careful about what information it nests where?</td></tr>
  <tr class="msg" id="L168"><td class="ts-cell"><a class="ts" href="#L168" alt="Fri Nov 18 2022 15:33:39 GMT-0800 (Pacific Standard Time)">23:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Are there any use cases here for mutating the value of an AsyncLocal, or is this all through Run?</td></tr>
  <tr class="msg" id="L169"><td class="ts-cell"><a class="ts" href="#L169" alt="Fri Nov 18 2022 15:34:29 GMT-0800 (Pacific Standard Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It needs to be careful about information nesting. The LogicalCallContext exists to do this work for you, though awaitable things in .NET let you configure how to capture and restore execution contexts via <code>.ConfigureAwait()</code>.</td></tr>
  <tr class="msg" id="L170"><td class="ts-cell"><a class="ts" href="#L170" alt="Fri Nov 18 2022 15:34:45 GMT-0800 (Pacific Standard Time)">23:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.configureawait?view=netframework-4.8#system-threading-tasks-task-configureawait(system-boolean)">https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.configureawait?view=netframework-4.8#system-threading-tasks-task-configureawait(system-boolean)</a></td></tr>
  <tr class="msg" id="L171"><td class="ts-cell"><a class="ts" href="#L171" alt="Fri Nov 18 2022 15:35:04 GMT-0800 (Pacific Standard Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Do you think we need .ConfigureAwait?</td></tr>
  <tr class="msg" id="L172"><td class="ts-cell"><a class="ts" href="#L172" alt="Fri Nov 18 2022 15:35:09 GMT-0800 (Pacific Standard Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Hopefully not.</td></tr>
  <tr class="msg" id="L173"><td class="ts-cell"><a class="ts" href="#L173" alt="Fri Nov 18 2022 15:35:52 GMT-0800 (Pacific Standard Time)">23:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Mostly .ConfigureAwait is used to determine whether to resume on the context captured at <code>await</code> or to continue with the context that's part of the continuation.</td></tr>
  <tr class="msg" id="L174"><td class="ts-cell"><a class="ts" href="#L174" alt="Fri Nov 18 2022 15:36:10 GMT-0800 (Pacific Standard Time)">23:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">One moment and I'll put together an example.</td></tr>
  <tr class="msg" id="L175"><td class="ts-cell"><a class="ts" href="#L175" alt="Fri Nov 18 2022 15:45:54 GMT-0800 (Pacific Standard Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Actually, it shouldn't matter. <code>.ContinueAwait(false)</code> is used to resume on the same <em>SynchronizationContext</em>, which affects which thread pool is used. A UI thread in a Windows app uses a Windows message queue based thread pool, while background threads might handle the work that is being awaited. Since you have to be on the UI thread to do UI updates, you need to go back to the original synchronization context to be on the correct thread pool/thread.</td></tr>
  <tr class="msg" id="L176"><td class="ts-cell"><a class="ts" href="#L176" alt="Fri Nov 18 2022 15:51:32 GMT-0800 (Pacific Standard Time)">23:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">However, context switching is still useful. Without async context flow suppression, you can still do <code><a href="http://asyncContext.run">asyncContext.run</a>(undefined, cb)</code>, but that's on an individual <code>AsyncContext</code> bases. Something like .NET's <code>ExecutionContext.SuppressFlow()</code> would suppress copying the current context for <em>every</em> <code>AsyncContext</code>. Again, that's achieveable with <code>wrap</code> but not very ergonomic.</td></tr>
  <tr class="msg" id="L177"><td class="ts-cell"><a class="ts" href="#L177" alt="Fri Nov 18 2022 15:52:10 GMT-0800 (Pacific Standard Time)">23:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">sorry what is the purpose of context flow suppression?</td></tr>
  <tr class="msg" id="L178"><td class="ts-cell"><a class="ts" href="#L178" alt="Fri Nov 18 2022 15:54:18 GMT-0800 (Pacific Standard Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">My earlier example was an HTTP Server. you may have context information for the server itself (such as the server's security principal) that you don't want to propagate to each request handler. In that case you would suppress execution context flow so that the current context isn't copied when you spin up a request handler (which will need to set its own context).</td></tr>
  <tr class="msg" id="L179"><td class="ts-cell"><a class="ts" href="#L179" alt="Fri Nov 18 2022 15:54:47 GMT-0800 (Pacific Standard Time)">23:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I’m also not understanding that usecase</td></tr>
  <tr class="msg" id="L180"><td class="ts-cell"><a class="ts" href="#L180" alt="Fri Nov 18 2022 15:55:08 GMT-0800 (Pacific Standard Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Its also useful if you are using an async context that is reachable both from your code and potentially untrusted/sandboxed code. You may want to suppress async flow when invoking the untrusted code so as not to leak information.</td></tr>
  <tr class="msg" id="L181"><td class="ts-cell"><a class="ts" href="#L181" alt="Fri Nov 18 2022 15:55:12 GMT-0800 (Pacific Standard Time)">23:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Is this because execution context allows you to change all contexts?</td></tr>
  <tr class="msg" id="L182"><td class="ts-cell"><a class="ts" href="#L182" alt="Fri Nov 18 2022 15:56:02 GMT-0800 (Pacific Standard Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The untrusted code use case is very important when building an plugin/extensibility ecosystem, such as the one used in VS Code.</td></tr>
  <tr class="msg" id="L183"><td class="ts-cell"><a class="ts" href="#L183" alt="Fri Nov 18 2022 15:56:57 GMT-0800 (Pacific Standard Time)">23:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Its because there's no easy way to reset all the context information for the purpose of an invocation into untrusted code, aside from a top-level <code>AsyncContext.wrap((cb, ...args) =&gt; cb(...args))</code>.</td></tr>
  <tr class="msg" id="L184"><td class="ts-cell"><a class="ts" href="#L184" alt="Fri Nov 18 2022 15:57:38 GMT-0800 (Pacific Standard Time)">23:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> My earlier example was an HTTP Server. you may have context information for the server itself (such as the server's security principal) that you don't want to propagate to each request handler. In that case you would suppress execution context flow so that the current context isn't copied when you spin up a request handler (which will need to set its own context).</blockquote></mx-reply>OK, so in this case, the sensitive information is in an outer context, and then inner nested contexts need to not be able to see it?</td></tr>
  <tr class="msg" id="L185"><td class="ts-cell"><a class="ts" href="#L185" alt="Fri Nov 18 2022 15:58:09 GMT-0800 (Pacific Standard Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Plus I may just want a way to kick off an async operation in a base state without whatever extra context baggage the current function is holding on to.</td></tr>
  <tr class="msg" id="L186"><td class="ts-cell"><a class="ts" href="#L186" alt="Fri Nov 18 2022 15:58:16 GMT-0800 (Pacific Standard Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes.</td></tr>
  <tr class="msg" id="L187"><td class="ts-cell"><a class="ts" href="#L187" alt="Fri Nov 18 2022 15:58:23 GMT-0800 (Pacific Standard Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Its because there's no easy way to reset all the context information for the purpose of an invocation into untrusted code, aside from a top-level <code>AsyncContext.wrap((cb, ...args) =&gt; cb(...args))</code>.</blockquote></mx-reply>I guess, for both of these examples, a "true" top-level usage is not needed--we just need to capture this before the sensitive information is added by the server/vscode, right?</td></tr>
  <tr class="msg" id="L188"><td class="ts-cell"><a class="ts" href="#L188" alt="Fri Nov 18 2022 15:58:40 GMT-0800 (Pacific Standard Time)">23:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Again, you can do that on a case by case basis with <code><a href="http://asyncContext.run">asyncContext.run</a>(undefined, cb)</code>, but not for <em>all</em> async contexts</td></tr>
  <tr class="msg" id="L189"><td class="ts-cell"><a class="ts" href="#L189" alt="Fri Nov 18 2022 15:59:46 GMT-0800 (Pacific Standard Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes, but making this specifically a case-by-case basis is very fiddly. that can be fine for an and user application, but it makes it hard for intermediate libraries to work around.</td></tr>
  <tr class="msg" id="L190"><td class="ts-cell"><a class="ts" href="#L190" alt="Fri Nov 18 2022 15:59:47 GMT-0800 (Pacific Standard Time)">23:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">So, this is important if you have a profusion of sensitive things, where the inner modules can find the AsyncContext objects, but otoh it would be impractical to construct a list of all of them to censor them?</td></tr>

</tbody></table></div></div></div>
</body></html>