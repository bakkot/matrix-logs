<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2023-08-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2023-08-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-08-23" class="nav-link"><span>prev</span></a>
<a href="2023-08-28" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Aug 24 2023 06:35:11 GMT-0700 (Pacific Daylight Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Andreu, Ms2ger and I learned today in a call with Yoav that they wanted to move task attribution from the context to the isolate. So this shouldn't form a barrier to implementing task attribution on top of AsyncContext.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Aug 24 2023 06:36:21 GMT-0700 (Pacific Daylight Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Overall I think the call was excellent--we were able to talk through a number of core issues, not necessarily coming to any conclusion, but definitely a deeper shared understanding.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Aug 24 2023 06:36:32 GMT-0700 (Pacific Daylight Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Thanks for arranging this, Andreu!</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Aug 24 2023 06:36:36 GMT-0700 (Pacific Daylight Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">sure!</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Aug 24 2023 06:36:59 GMT-0700 (Pacific Daylight Time)">13:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(did my comments in the call seem reasonable to you? Is there anything you'd disagree with?)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Aug 24 2023 06:37:04 GMT-0700 (Pacific Daylight Time)">13:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell"><a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/messaging/message_port.cc;l=322;drc=d76bbe1456ab0713d884cc51742ba565fb808cf8;bpv=1;bpt=1">https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/messaging/message_port.cc;l=322;drc=d76bbe1456ab0713d884cc51742ba565fb808cf8;bpv=1;bpt=1</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Aug 24 2023 06:38:09 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Yoav Weiss</span>: Is "isolated world" there referring to extensions?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Aug 24 2023 06:38:16 GMT-0700 (Pacific Daylight Time)">13:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">yeah</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Aug 24 2023 06:39:24 GMT-0700 (Pacific Daylight Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">Everything sounded reasonable, yeah.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Aug 24 2023 08:54:08 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">let reject;
new Promise((_, rejectFn) =&gt; {
  reject = rejectFn;
});

window.onunhandledrejection = (evt) =&gt; {
    // Creates a new unhandled promise based on `promise`,
    // which will cause this listener to be called (again and again).
    evt.promise.then();
};

reject();
</code></pre>
</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Aug 24 2023 08:54:25 GMT-0700 (Pacific Daylight Time)">15:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">do you expect the <code>unhandledrejection</code> listener to be always called with the same snapshot?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Aug 24 2023 08:59:35 GMT-0700 (Pacific Daylight Time)">15:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">(assuming no other promises)</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Aug 24 2023 09:10:21 GMT-0700 (Pacific Daylight Time)">16:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I think if we want this, and we also want <code>promise.then()</code> with no arguments to not catch the current snapshot, we would need to add a new slot to promises</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Aug 24 2023 09:13:20 GMT-0700 (Pacific Daylight Time)">16:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell">Out of curiosity, what is the behavior when doing <code>new Promise(resolve =&gt; resolve(evt.promise))</code>? Is it any different than <code>evt.promise.then()</code> ?</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Aug 24 2023 09:17:54 GMT-0700 (Pacific Daylight Time)">16:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">it would behave the same, I think</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Thu Aug 24 2023 09:21:54 GMT-0700 (Pacific Daylight Time)">16:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@mhofman:matrix.org">Mathieu Hofman</span>&gt;</div></td><td class="msg-cell"><p>Asking because the former is roughly what internally happens with an async function's return value. In those case, do we want the event handler to run in the context of the initial rejection, or in the context of the call to the async function ?</p>
<pre><code class="language-js">const ctx = new AsyncContext()

window.onunhandledrejection = (evt) =&gt; {
    ctx.get(); // ??
};

const wrap = async (p) =&gt; p;

let reject;
ctx.run(1, () =&gt; wrap(new Promise((_, rejectFn) =&gt; {
  reject = rejectFn;
}));

ctx.run(2, reject);
</code></pre>
</td></tr>

</tbody></table></div></div></div>
</body></html>