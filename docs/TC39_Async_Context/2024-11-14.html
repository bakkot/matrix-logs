<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-11-14</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-11-14<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-13" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Nov 13 2024 16:48:09 GMT-0800 (Pacific Standard Time)">00:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If it's limited to scoped <code>using</code> and not general mutability, I think you can polyfill on top of <code>AsyncContext</code> and only instrument <code>await</code> and <code>yield</code> statements.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Nov 13 2024 16:49:33 GMT-0800 (Pacific Standard Time)">00:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I know we talked about this before and I said otherwise, but I can't remember why I said it wasn't possible before.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Nov 13 2024 20:18:11 GMT-0800 (Pacific Standard Time)">04:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><p>But I think that's the problem - it can't be limited to scoped <code>using</code> because of composability: you need to be able to write</p>
<pre><code class="language-javascript">function enterSpan(id) {
  const span = new Span({id, parent: currentSpan.get()});
  span[Symbol.dispose] = currentSpan.enter(span)[Symbol.dispose];
  log('new span', currentSpan.get());
  return span;
}
</code></pre>
<p>That function gives no syntactic indication that it needs any extra transpilation... in fact, thinking about it further, it violates the principle that functions you call shouldn't be able to change your context.</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Nov 13 2024 20:23:43 GMT-0800 (Pacific Standard Time)">04:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">That example wouldn't be possible, but using <code>using span = enterSpan(…)</code> could be</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Nov 13 2024 20:24:04 GMT-0800 (Pacific Standard Time)">04:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">how would you define <code>enterSpan</code> in that case?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Nov 13 2024 20:35:00 GMT-0800 (Pacific Standard Time)">04:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The same?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Nov 13 2024 20:35:56 GMT-0800 (Pacific Standard Time)">04:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The difference is you expected <code>enterSpan</code> to cause the mutation, and I'm expecting the <code>using span …</code> to do it</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Nov 14 2024 09:06:08 GMT-0800 (Pacific Standard Time)">17:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">This is the <code>disposable[Symbol.enter]()</code> idea, but AIUI, it's a non-starter if it only works syntactically - i.e. you still need to be able to call it reflectively for composability.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Nov 14 2024 09:07:12 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">Case in point: <code>Span.prototype[Symbol.enter]</code> would need to call <code>AsyncContext.Mutation.prototype[Symbol.enter]</code> transitively.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Thu Nov 14 2024 09:07:20 GMT-0800 (Pacific Standard Time)">17:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">and it couldn't use <code>using</code> syntax for that.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Thu Nov 14 2024 09:27:56 GMT-0800 (Pacific Standard Time)">17:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><p>For <code>using</code> with <code>Symbol.enter</code>/<code>Symbol.dispose</code>, I don't think we need to enforce it syntactically. Does this provide enough guarantees, or are there still ways to mess up the context and not get an explicit error about it?</p>
<pre><code class="language-js">function enterWith(variable, value) {
  let oldContext, updatedContext

  return {
    [Symbol.enter]() {
      if (oldContext) throw new Error("Cannot enter twice");
      oldContext = AsyncContextSnapshot();
      updatedContext = { ...oldContext, [variable]: value };

      AsyncContextSwap(updatedContext);
    },
    [Symbol.dispose]() {
      if (!oldContext) throw new Error("Cannot dispose before entering");

      const current = AsyncContextSnapshot();
      if (current !== updatedContext) {
        throw new Error("Cannot dispose, as it's not the current context");
      }

      AsyncContextSwap(oldContext);
    }
  }
}

AsyncContext.Variable.prototype.run = function (value, callback) {
  const oldContext = AsyncContextSnapshot();

  AsyncContextSwap({ ...oldContext, [this]: value });
  try {
    return callback();
  } finally {
    const current = AsyncContextSnapshot();
    AsyncContextSwap(oldContext);

    if (current !== oldContext) {
      throw new Error(".run ended before that its context was restored");
    }
  }
}

{
  // context: root

  x1[Symbol.enter]();
  // context: x1

  x2[Symbol.enter]();
  // context: x2

  x1[Symbol.dispose](); // error: "Cannot dispose, as it's not the current context"
}


{
  // context: root

  x1[Symbol.enter]();
  // context: x1

  myVar.run("foo", () =&gt; {
    // context: foo

    x1[Symbol.dispose](); // error: "Cannot dispose, as it's not the current context"
  })
}

{
  // context: root

  myVar.run("foo", () =&gt; {
    // context: foo

    x1[Symbol.enter]();
    // context: x1
  }); // closes the foo context, then error: ".run ended before that its context was restored"
}
</code></pre>
</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Thu Nov 14 2024 09:33:10 GMT-0800 (Pacific Standard Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><p>And you can still leak <em>a little bit</em>, but:</p>
<ul>
<li><code>.run</code> is a hard boundary you cannot leak accross</li>
<li>if you leak, basically as soon as some other context ends you'll get an error</li>
</ul>
</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Thu Nov 14 2024 09:33:39 GMT-0800 (Pacific Standard Time)">17:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">And the error could point to the stack trace of where you did <code>enter</code> without then disposing it</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Thu Nov 14 2024 09:34:17 GMT-0800 (Pacific Standard Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I think you need to store two locals - one for <code>oldContext</code> and one for <code>updatedContext</code> and then line 15 wants to compare <code>current !== updatedContext</code></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Thu Nov 14 2024 09:34:40 GMT-0800 (Pacific Standard Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">True, right</td></tr>

</tbody></table></div></div></div>
</body></html>