<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2023-01-25</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2023-01-25<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-24" class="nav-link"><span>prev</span></a>
<a href="2023-01-26" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jan 24 2023 16:54:46 GMT-0800 (Pacific Standard Time)">00:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">Justin Ridgewell</span>: Do you have a link to the reference site? I couldn't find it</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jan 24 2023 16:55:02 GMT-0800 (Pacific Standard Time)">00:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I definitely expected that Yoav's work would use this</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jan 24 2023 16:55:23 GMT-0800 (Pacific Standard Time)">00:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Reference site?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jan 24 2023 16:57:31 GMT-0800 (Pacific Standard Time)">00:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">err, callsite</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jan 24 2023 16:58:05 GMT-0800 (Pacific Standard Time)">00:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">just trying to find Yoav's patches or design docs or anything like that</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jan 24 2023 16:59:16 GMT-0800 (Pacific Standard Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/task_attribution_tracker_impl.cc">third_party/blink/renderer/modules/scheduler/task_attribution_tracker_impl.cc</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jan 24 2023 16:59:48 GMT-0800 (Pacific Standard Time)">00:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">ah I see thanks!!</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jan 24 2023 17:00:05 GMT-0800 (Pacific Standard Time)">01:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">They're using continuation API, and there's no special handling for <code>enqueueMicrotask</code> that I can find</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jan 24 2023 17:00:12 GMT-0800 (Pacific Standard Time)">01:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">So they're falling into the same thenable bug</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jan 24 2023 17:01:02 GMT-0800 (Pacific Standard Time)">01:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">how is setTimeout handled here?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jan 24 2023 17:01:03 GMT-0800 (Pacific Standard Time)">01:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">does it work?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jan 24 2023 17:01:36 GMT-0800 (Pacific Standard Time)">01:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Shu is skeptical of putting too much work into thenables. I don't understand the issue in enough detail to know how it would be solved, or whether it should be solved.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jan 24 2023 17:11:02 GMT-0800 (Pacific Standard Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Looks like <code>setTimeout</code> is handled on the Blink side</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jan 24 2023 17:11:16 GMT-0800 (Pacific Standard Time)">01:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">TaskAttribution users: <a href="https://source.chromium.org/search?q=%22GetTaskAttributionTracker()%22&amp;ss=chromium%2Fchromium%2Fsrc">https://source.chromium.org/search?q=%22GetTaskAttributionTracker()%22&amp;ss=chromium%2Fchromium%2Fsrc</a></td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jan 24 2023 17:13:40 GMT-0800 (Pacific Standard Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">OK, good, this is all useful context</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jan 24 2023 17:13:50 GMT-0800 (Pacific Standard Time)">01:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">thank you</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jan 24 2023 17:14:02 GMT-0800 (Pacific Standard Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Shu will look into this and be in some level of contact with Yoav</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jan 24 2023 17:14:30 GMT-0800 (Pacific Standard Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><span class="nick-7">Chengzhong Wu</span>: How is it going with proposing a meeting between us and Yoav?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Jan 24 2023 17:18:50 GMT-0800 (Pacific Standard Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>OK, coming in at a bit under 100 hours from when I promised this, here's the edits I'd make to the slides:</p>
<ul>
<li>Don't you want to use the run() function in your wrap() implementation? (Aside: rename run())</li>
<li>I think mixing in the part about monkey-patching console.log is a distraction which would be better removed.</li>
<li>I would replace the React Cache example with OpenTelemetry (legendecas can do this as he knows that area much better than me). Really, the OpenTelemetry case of holding a span ID instead of an initial timestamp has exactly the same needs--we should say this explicitly.</li>
<li>Slide 18 is really key (maybe reference the main thread scheduling proposal? maybe not?) but the code doesn't then correspond to anything about prioritization, so it's a little confusing</li>
<li>In general, let's say "async context" intead of "async stack" to reinforce the intuition around the terms. Also "stack" implies linear memory usage for the number of async items, which is definitely not the case here, but definitely is the case with general async stack traces (which is a specific non-goal here, and which we should probably avoid comparing this with in slide 19, as it will probably make browsers uncomfortable)</li>
<li>All the stuff about "the dynamic scoping elephant" should be probably rephrased as "Bonus slides (if time allows): ocap analysis" and then just defer to Mark to say he thought about it and decided it's OK. I expect the committee to continue disagreeing internally on whether this deserves to be called "dynamic scoping", and really, that's all irrelevant</li>
</ul>
</blockquote></mx-reply>(and, please let me know if you won't do these edits and I should make them)</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Jan 24 2023 17:19:01 GMT-0800 (Pacific Standard Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I still need to take a look at them</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Jan 24 2023 17:19:30 GMT-0800 (Pacific Standard Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><p>I think this is how setTimeout works:</p>
<ul>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/dom_scheduler.cc">https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/dom_scheduler.cc</a></li>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/dom_task.h">https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/dom_task.h</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Jan 24 2023 17:33:25 GMT-0800 (Pacific Standard Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Cool, though I am having trouble tracing it</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Jan 24 2023 17:33:25 GMT-0800 (Pacific Standard Time)">01:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Would be awesome if it is possible to hack up a PR to Chrome to make a pair of functions to get and set this context variable somehow</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Jan 24 2023 17:34:49 GMT-0800 (Pacific Standard Time)">01:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Different than the <code>Get</code>/<code>SetContinuationPreservedEmbedderData</code>?</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Jan 24 2023 17:35:00 GMT-0800 (Pacific Standard Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Or do you mean specific to timers?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Jan 24 2023 18:17:49 GMT-0800 (Pacific Standard Time)">02:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I mean that plus this plumbing through all the web APIs (not specific to timers)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Jan 24 2023 18:17:54 GMT-0800 (Pacific Standard Time)">02:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">So like the node extension you made but it restores across web APIs including timers in exactly the way yoav’s work does</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Jan 24 2023 18:44:40 GMT-0800 (Pacific Standard Time)">02:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Currently we (workerd) has to capture the context manually for timers and queueMicrotask web apis. These are still fundamentally based on the v8 API tho. Basically when a timer is set we call GetContinuationPreservedEmbedderData to get the current storage context and enter that manually when the callback function is called. Pretty simple</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Jan 24 2023 18:45:20 GMT-0800 (Pacific Standard Time)">02:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">queueMicrotask will be handled for us once v8 fixes the current limitations</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Jan 24 2023 18:45:45 GMT-0800 (Pacific Standard Time)">02:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Do you maintain patches onto V8 for workerd?</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Jan 24 2023 18:45:46 GMT-0800 (Pacific Standard Time)">02:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Oh, we also capture manually for wrapped functions and AsyncResource</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Jan 24 2023 18:45:51 GMT-0800 (Pacific Standard Time)">02:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> queueMicrotask will be handled for us once v8 fixes the current limitations</blockquote></mx-reply>Which limitation?</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Jan 24 2023 18:46:08 GMT-0800 (Pacific Standard Time)">02:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">We do but none for this yet</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Jan 24 2023 18:46:48 GMT-0800 (Pacific Standard Time)">02:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">The limitation that v8 is not attaching the context to EnqueueMicrotask </td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Jan 24 2023 18:51:27 GMT-0800 (Pacific Standard Time)">02:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">We certainly could float a patch that covers the queueMicrotask issue but we'd rather that just be addressed upstream. For now we're fine with it not working for thenables but would like that not to be permanent </td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Jan 24 2023 18:55:07 GMT-0800 (Pacific Standard Time)">02:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The thenable bug is solved by copying <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-247;drc=bf9ffddf05af0586dc82cd2a320508cd5dcfbc3c">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-247;drc=bf9ffddf05af0586dc82cd2a320508cd5dcfbc3c</a> into <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=191-221;drc=bf9ffddf05af0586dc82cd2a320508cd5dcfbc3c">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=191-221;drc=bf9ffddf05af0586dc82cd2a320508cd5dcfbc3c</a></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Jan 24 2023 18:57:10 GMT-0800 (Pacific Standard Time)">02:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The generic microtask bug is in that same function, but it's more complicated</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Jan 24 2023 18:59:37 GMT-0800 (Pacific Standard Time)">02:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Oh nice. Since we have a workaround for queueMicrotask we might be able to just float the change for thenables then wait for the rest </td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Jan 24 2023 19:00:15 GMT-0800 (Pacific Standard Time)">03:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I'm assuming you're not using any Blink code for your timers?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Jan 24 2023 19:00:34 GMT-0800 (Pacific Standard Time)">03:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Correct</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Jan 24 2023 19:03:02 GMT-0800 (Pacific Standard Time)">03:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Perfect</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Jan 24 2023 19:14:21 GMT-0800 (Pacific Standard Time)">03:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><p>Sorry, we'll also need these to store the data in the first place</p>
<ul>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=283-285;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=283-285;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552</a> into <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=310-316;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=310-316;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552</a></li>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=44-47;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=44-47;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28</a> into <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=64-69;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=64-69;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28</a></li>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=57;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=57;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28</a> into <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=64-69;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/promise.tq;l=64-69;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Jan 24 2023 19:15:26 GMT-0800 (Pacific Standard Time)">03:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">So it's the same amount of work to fix generic microtask (I thought those last 3 already existed in thenable tasks, but they didn't)</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Jan 24 2023 19:17:01 GMT-0800 (Pacific Standard Time)">03:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Those same 4 changes are all that's necessary to add continuation data to <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/microtask.tq;l=9-12;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28">CallbackTask</a> and <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/microtask.tq;l=14-17;drc=f30f4815254b8eed9b23026ea0d984d18bb89c28">CallableTask</a> (I don't really know the difference between them…)</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Jan 24 2023 19:18:21 GMT-0800 (Pacific Standard Time)">03:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">As far as I can tell, though, nothing in V8 uses the generic microtask queue except promises, it's only if you call into it via the public API</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Jan 24 2023 19:32:19 GMT-0800 (Pacific Standard Time)">03:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">The web specs do enqueue microtasks for various things, and in Blink they do seem to use <code>EnqueueMicrotask</code></td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Jan 24 2023 19:33:14 GMT-0800 (Pacific Standard Time)">03:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I'm not yet confident that if those microtasks run any user code, or queue tasks that do, that they would want wrap-like behavior</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Jan 24 2023 19:33:29 GMT-0800 (Pacific Standard Time)">03:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I'll look through them though</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jan 25 2023 07:32:30 GMT-0800 (Pacific Standard Time)">15:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-7">Chengzhong Wu</span>: How is it going with proposing a meeting between us and Yoav?</blockquote></mx-reply>Sadly, yoav hasn't responded to my email with the meeting doodle.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jan 25 2023 07:33:49 GMT-0800 (Pacific Standard Time)">15:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Sadly, yoav hasn't responded to my email with the meeting doodle.</blockquote></mx-reply>ah OK I'll ping him today</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jan 25 2023 07:44:26 GMT-0800 (Pacific Standard Time)">15:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">thanks!</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jan 25 2023 09:01:31 GMT-0800 (Pacific Standard Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">@benjamn just did the patches for thenables into his deno impl: <a href="https://github.com/benjamn/deno-v8/commit/d72a3dd59139242385203b3aa0167451220d0bdf">https://github.com/benjamn/deno-v8/commit/d72a3dd59139242385203b3aa0167451220d0bdf</a></td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jan 25 2023 09:42:46 GMT-0800 (Pacific Standard Time)">17:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">👋</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jan 25 2023 09:43:21 GMT-0800 (Pacific Standard Time)">17:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">nice to see some new/familiar faces</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jan 25 2023 09:46:54 GMT-0800 (Pacific Standard Time)">17:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I recently scraped together this Docker image with a custom build of Deno that supports the <code>AsyncContext</code> proposal in native async/await code: <a href="https://github.com/benjamn/deno/pull/2">https://github.com/benjamn/deno/pull/2</a></td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jan 25 2023 09:47:57 GMT-0800 (Pacific Standard Time)">17:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell"><pre><code>docker run -it --rm benjamn/deno:async-thenables repl
</code></pre>
<p>should give you a Deno REPL where you can play with <code>AsyncContext</code>, provided you have Docker installed</p>
</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jan 25 2023 09:52:28 GMT-0800 (Pacific Standard Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I don't plan to support this Deno fork in the long run, but I thought it might be useful to share, so others can check their intuitions, suggest test cases, identify context loss pitfalls, etc</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jan 25 2023 10:02:54 GMT-0800 (Pacific Standard Time)">18:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">(that Docker image is "only" 162MB, thanks mostly to Deno being a single standalone 90MB binary)</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jan 25 2023 10:15:27 GMT-0800 (Pacific Standard Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Was the SES meeting cancelled today?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jan 25 2023 10:15:36 GMT-0800 (Pacific Standard Time)">18:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Nothing on the agenda</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jan 25 2023 11:17:37 GMT-0800 (Pacific Standard Time)">19:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">Justin Ridgewell</span>: ... what's your sense on how stable the current definition of the <code>AsyncContext</code> interface is? Like if we were to do something silly and implement a polyfill in workerd now would we likely be shooting ourselves in the foot</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Jan 25 2023 11:18:24 GMT-0800 (Pacific Standard Time)">19:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I don't think the names are stable</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Jan 25 2023 11:19:10 GMT-0800 (Pacific Standard Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If you're not against it, I would just implement <code>AsyncLocalStorage</code> and provide maybe a JS wrapper around it to conform to the current <code>AsyncContext</code> API</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Jan 25 2023 11:19:50 GMT-0800 (Pacific Standard Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Like a <code>import AsyncContext from "workerd:async-context/v0"</code> would give you the current interface</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Jan 25 2023 11:20:02 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yeah we're just trying to decide whether we really want to encourage too much dependency on ALS while AsyncContext is coming. </td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Jan 25 2023 11:20:33 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I know it's really difficult to estimate standards logistics machinery, but what's your expectation on when AsyncContext could find its way to stage 3?</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Jan 25 2023 11:20:38 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">(if any)</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Jan 25 2023 11:20:51 GMT-0800 (Pacific Standard Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">You could choose not to expose the ALS API at all, but implement a public AC interface on top of your private ALS interface</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Jan 25 2023 11:21:30 GMT-0800 (Pacific Standard Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">we've got customers currently asking specifically for node.js compat with ALS so we're pretty much committed to supporting both apis</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Jan 25 2023 11:21:44 GMT-0800 (Pacific Standard Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think the most likely thing to change is <code>wrap</code> into an object like <code>AsyncResource</code></td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Jan 25 2023 11:21:53 GMT-0800 (Pacific Standard Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><code>get</code>/<code>run</code> seem stable</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Jan 25 2023 11:37:11 GMT-0800 (Pacific Standard Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-1">Justin Ridgewell</span>: ... what's your sense on how stable the current definition of the <code>AsyncContext</code> interface is? Like if we were to do something silly and implement a polyfill in workerd now would we likely be shooting ourselves in the foot</blockquote></mx-reply>Please don't do that!</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Jan 25 2023 11:37:28 GMT-0800 (Pacific Standard Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I'd instead encourage us all to define a subset of AsyncLocalStorage that should be supported across environments</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Jan 25 2023 11:37:54 GMT-0800 (Pacific Standard Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Once AsyncContext is stable, we can polyfill exactly that subset on top of AsyncContext</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Jan 25 2023 11:37:55 GMT-0800 (Pacific Standard Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">heh, I'm not wanting to. We had a question come up about whether we could and I wanted it to not just be me saying "No!"</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Jan 25 2023 11:38:18 GMT-0800 (Pacific Standard Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">great, well, you can cite me as well if it's useful (I can give a more quotable explanation if needed)</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Jan 25 2023 11:38:32 GMT-0800 (Pacific Standard Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">let's actually write down what this subset is though</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Jan 25 2023 11:42:15 GMT-0800 (Pacific Standard Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>let's actually write down what this subset is though</p>
</blockquote>
<p>we can do that on tonight's wintercg call probably</p>
</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Jan 25 2023 11:46:29 GMT-0800 (Pacific Standard Time)">19:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">apologies for the vague question (I'm new)… is there a good term for an API like <code>AsyncContext</code>… loosely immutable (<code>get</code> only), but overridable/censorable (with <code>run</code>) if you're calling new code?</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Jan 25 2023 11:47:29 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">something like a "call stack-hugging environment variable"</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Jan 25 2023 11:47:37 GMT-0800 (Pacific Standard Time)">19:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Mark Miller (TC39 delegate) has been calling this a Fluid Variable</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Jan 25 2023 11:49:30 GMT-0800 (Pacific Standard Time)">19:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">are we collecting use cases somewhere? maybe the proposal repo?</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Jan 25 2023 11:50:30 GMT-0800 (Pacific Standard Time)">19:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/legendecas/proposal-async-context/issues/5">https://github.com/legendecas/proposal-async-context/issues/5</a></td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Jan 25 2023 11:54:03 GMT-0800 (Pacific Standard Time)">19:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I tried looking for references for this, and it's all esoteric computer science papers and MIT's Scheme</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Jan 25 2023 11:59:47 GMT-0800 (Pacific Standard Time)">19:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I vaguely remember there used to be a <code>set</code> method along with <code>get</code>, but that's been removed… is <code>set</code> gone for good? (My bias: I hope so, for predictability and efficiency)</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Jan 25 2023 12:00:31 GMT-0800 (Pacific Standard Time)">20:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">(of course if you want mutability you can store an object of your own design in the <code>AsyncContext</code> and provide an API around that)</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Jan 25 2023 12:01:16 GMT-0800 (Pacific Standard Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I like that it's gone, because it prevents a memory leak</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Jan 25 2023 12:01:36 GMT-0800 (Pacific Standard Time)">20:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The Node folks mentioned that it's helpful for APM usage, though, so you don't need to redo the app</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Jan 25 2023 12:02:04 GMT-0800 (Pacific Standard Time)">20:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Even my company makes use of it, but I know how to update it once we get a real API</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Jan 25 2023 12:03:01 GMT-0800 (Pacific Standard Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">with no <code>set</code> method, I believe you're guaranteed the result of calling <code>ctx.get()</code> will always return the same value anywhere you call it in a given function body, which is a very useful invariant</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Jan 25 2023 12:03:44 GMT-0800 (Pacific Standard Time)">20:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">so you don't have to guess arbitrarily about how often you should poll the context for a new value within a given function</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Jan 25 2023 12:09:55 GMT-0800 (Pacific Standard Time)">20:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">there's some work ongoing to eliminate the need for <code>set</code> in the APM cases</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Wed Jan 25 2023 12:12:21 GMT-0800 (Pacific Standard Time)">20:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I vaguely remember there used to be a <code>set</code> method along with <code>get</code>, but that's been removed… is <code>set</code> gone for good? (My bias: I hope so, for predictability and efficiency)</blockquote></mx-reply>I prefer omitting <code>set</code>, but <span class="nick-15">rbuckton</span> has argued in favor of including it</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Wed Jan 25 2023 12:13:29 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><code>set</code> usages can sometimes be replaced by using a single mutable object in the AsyncContext variable, and setting a property in that. Other times, that doesn't work, though.</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Wed Jan 25 2023 12:13:52 GMT-0800 (Pacific Standard Time)">20:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">It'd be great to do a deeper analysis of use cases of <code>set</code></td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Wed Jan 25 2023 12:16:32 GMT-0800 (Pacific Standard Time)">20:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">we <em>could</em> implement <code>set</code>, I'd prefer not to in general. just really dislike that model</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Wed Jan 25 2023 12:17:16 GMT-0800 (Pacific Standard Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">agreed</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Wed Jan 25 2023 12:17:30 GMT-0800 (Pacific Standard Time)">20:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I'd at least like to be able to disable <code>set</code>, so <code><a href="http://AsyncContext.prototype.set.call">AsyncContext.prototype.set.call</a>(&lt;arbitrary context obj&gt;, &lt;new value&gt;)</code> does not work</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Wed Jan 25 2023 12:20:23 GMT-0800 (Pacific Standard Time)">20:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the thing I don't understand about set is how far it applies. Ron seemed to expect it to only take affect in the current function and "inwards", whereas another, simpler model would be for it to take effect across the whole innermost <code>run</code> where that particular variable was set. The latter can be implemented in terms of AsyncContext; the former requires some fancier core behavior</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Wed Jan 25 2023 12:21:45 GMT-0800 (Pacific Standard Time)">20:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">since Ron is also working on the resource management proposal, I wonder if he's interested in the region of time from when the resource is created to when it goes out of scope</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Wed Jan 25 2023 12:22:24 GMT-0800 (Pacific Standard Time)">20:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">well, yes, Ron has talked about how it's unfortunate that <code>run</code> forces you to put everything in a callback (which <code>using</code> avoids)</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Wed Jan 25 2023 12:23:17 GMT-0800 (Pacific Standard Time)">20:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but... I'm not personally convinced that this is so bad. I think people shouldn't be using <code>run</code> anywhere near the same order of magnitude of frequency as <code>using</code>.</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Wed Jan 25 2023 12:24:00 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">if we had <code>set</code>, it'd be (potentially) a solution to this problem of forcing everything to be inside the callback (especially if it had the behavior Ron is arguing for, that it shouldn't leak out of the current function)</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Wed Jan 25 2023 12:24:36 GMT-0800 (Pacific Standard Time)">20:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(it may be that I misunderstood/misrepresented this suggestion; corrections welcome <span class="nick-15">rbuckton</span> )</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Wed Jan 25 2023 12:25:29 GMT-0800 (Pacific Standard Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think of <code>run</code> as something you call "once per thread" (conceptually)</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Wed Jan 25 2023 12:25:40 GMT-0800 (Pacific Standard Time)">20:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(if you conceptualize async/await being a weird kind of threading with tons of forks)</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Wed Jan 25 2023 12:27:34 GMT-0800 (Pacific Standard Time)">20:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">if the only way to change the value of the <code>AsyncContext</code> is to run new code, then there's an especially convenient representation for the underlying collection of all contexts</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Wed Jan 25 2023 12:29:10 GMT-0800 (Pacific Standard Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">roughly: an immutable map, where you can "add" elements in constant time by creating a new map in terms of old ones, and lookups are amortized O(1)</td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Wed Jan 25 2023 12:29:47 GMT-0800 (Pacific Standard Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I know <span class="nick-1">Justin Ridgewell</span> was working on a similar/better(?) optimization in <a href="https://github.com/legendecas/proposal-async-context/pull/15">https://github.com/legendecas/proposal-async-context/pull/15</a></td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Wed Jan 25 2023 12:29:56 GMT-0800 (Pacific Standard Time)">20:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yup</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Wed Jan 25 2023 12:30:14 GMT-0800 (Pacific Standard Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">We can optimize it further if we know whether the current map was "frozen" by a <code>wrap</code></td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Wed Jan 25 2023 12:30:30 GMT-0800 (Pacific Standard Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If it is, we need to reallocate to modify. If not, we can directly mutate</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Wed Jan 25 2023 12:31:38 GMT-0800 (Pacific Standard Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I believe there's even a way to use <code>WeakMap</code> here, so all values for a given <code>AsyncContext</code> go away if you discard that object</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Wed Jan 25 2023 12:32:17 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I know this may sound like premature optimization, but it's going to be hot code (in terms of CPU and memory) if we're not careful</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Wed Jan 25 2023 12:32:31 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">From the JS side, unfortunately not, but as an actual implementation, the values should be weakly held by the keys</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Wed Jan 25 2023 12:32:51 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">keys being <code>AsyncContext</code> instances?</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Wed Jan 25 2023 12:32:55 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yah</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Wed Jan 25 2023 12:33:34 GMT-0800 (Pacific Standard Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">In pure spec terms, there's no reason we can clone a <code>WeakMap</code></td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Wed Jan 25 2023 12:33:43 GMT-0800 (Pacific Standard Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It's just not an API currently offered</td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Wed Jan 25 2023 12:37:37 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">true! funny how useless the data structure <code>ImmutableWeakMap</code> sounds, but something like that would be useful for this</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Wed Jan 25 2023 12:38:11 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">it really doesn't need to be weak</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Wed Jan 25 2023 12:38:20 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but yes an immutable map structure would be useful here</td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Wed Jan 25 2023 12:38:30 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">private would be good enough, yes</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Wed Jan 25 2023 12:38:40 GMT-0800 (Pacific Standard Time)">20:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yes, this is definitely private</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Wed Jan 25 2023 12:39:29 GMT-0800 (Pacific Standard Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but WeakMap doesn't make sense because there's no practical way that the AsyncContext variable can be garbage-collected while in the middle of a <code>run</code> with it.</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Wed Jan 25 2023 12:39:39 GMT-0800 (Pacific Standard Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Map is the better one</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Wed Jan 25 2023 12:39:56 GMT-0800 (Pacific Standard Time)">20:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">ImmutableMap could avoid the linear cloning cost, while preserving the fast lookup, but ultimately this is an optimization available to implementations</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Wed Jan 25 2023 12:40:10 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">nothing visible in the API about whether it's implemented with Map or WeakMap or ImmutableMap</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Wed Jan 25 2023 12:40:21 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">right</td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Wed Jan 25 2023 12:40:46 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">my point is, it's one of those optimizations that works best (for the implementations that choose to take advantage) if there are some restrictions in the API</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Wed Jan 25 2023 12:41:15 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Yeah I think we should just avoid using terms like "dynamic scoping" or "fluid variable" in the presentations and docs, since they just get us into debates about wording, and lose most of the audience</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Wed Jan 25 2023 12:41:40 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (it may be that I misunderstood/misrepresented this suggestion; corrections welcome <span class="nick-15">rbuckton</span> )</blockquote></mx-reply>I think that is a valid summary. It would be unfortunate to not have it, but not a deal breaker.</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Wed Jan 25 2023 12:41:53 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> my point is, it's one of those optimizations that works best (for the implementations that choose to take advantage) if there are some restrictions in the API</blockquote></mx-reply>yes, <code>set</code> would definitely add complexity to the potential use of ImmutableMap (but not invalidate it I think)</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Wed Jan 25 2023 12:42:27 GMT-0800 (Pacific Standard Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">it would definitely be something to think through before concluding that we should have <code>set</code></td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Wed Jan 25 2023 12:43:11 GMT-0800 (Pacific Standard Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell"><span class="nick-15">rbuckton</span>: can you speak to what <code>set</code> can provide that mutable top-level context values (as an implementation detail) are not adequate for?</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Wed Jan 25 2023 12:43:20 GMT-0800 (Pacific Standard Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Is <code>AsyncContext</code> threaded through generators as well, or just async operations? If it isn't threaded through generators, then you could potentially write a generator function that <code>yield</code>s execution and upon returning control to the generator, evaluates <em>inside</em> of that context.</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Wed Jan 25 2023 12:44:14 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Can you clarify what you mean by "mutable top-level context values"? I haven't caught up on the conversation </td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Wed Jan 25 2023 12:45:00 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It’s not captured by gens, but it’d be easy to implement in userland</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Wed Jan 25 2023 12:45:57 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">(edited my text above a bit) if you <code><a href="http://ctx.run">ctx.run</a>([/*mutable array*/], () =&gt; { ... })</code> and code within that block has access to <code>ctx</code>, then they can do <code>ctx.get().push(...)</code> as if the context value was mutable</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Wed Jan 25 2023 12:45:59 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Once the <a href="http://gen.next">gen.next</a> call starts, inner code would not effect the outer context</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Wed Jan 25 2023 12:46:34 GMT-0800 (Pacific Standard Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell"><code>AsyncContext</code> is decidedly not just async operations (I sort of think the name undersells the sync side of the coin, where it also helps greatly)</td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Wed Jan 25 2023 12:46:58 GMT-0800 (Pacific Standard Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Should it be captured by generators? It would be coherent to do so</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Wed Jan 25 2023 12:47:20 GMT-0800 (Pacific Standard Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">there are two possible flows: the creation of the generator, when the whole thing could be bound to the current context, or each .next() call</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Wed Jan 25 2023 12:48:08 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">oh, yeah, I guess I was imagining that, when the generator is created, it'd capture the current async context, and on each .next() call, it would restore that</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Wed Jan 25 2023 12:48:15 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">I think it's important to decide what happens in generators, because async generators are also a thing</td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Wed Jan 25 2023 12:48:28 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So <code><a href="http://ctx.run">ctx.run</a>(foo, () =&gt; <a href="http://gen.next">gen.next</a>())</code> wouldn't resume the generator inside of the context?</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Wed Jan 25 2023 12:48:56 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The case I’m thinking of is koa, where an APM would be a middleware with a yield</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Wed Jan 25 2023 12:49:00 GMT-0800 (Pacific Standard Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">right, since basically the thing that next() calls out to would be "wrapped" internally</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Wed Jan 25 2023 12:50:01 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">We should move this into a GH issue, though</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Wed Jan 25 2023 12:52:38 GMT-0800 (Pacific Standard Time)">20:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (edited my text above a bit) if you <code><a href="http://ctx.run">ctx.run</a>([/*mutable array*/], () =&gt; { ... })</code> and code within that block has access to <code>ctx</code>, then they can do <code>ctx.get().push(...)</code> as if the context value was mutable</blockquote></mx-reply>so I'm wondering if that kind of object mutability is adequate for your use cases, or you really need the top-level context value to be changeable within the scope of a single function body</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Wed Jan 25 2023 12:55:03 GMT-0800 (Pacific Standard Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">no rush to answer btw; I'm just trying to get my thoughts sorted out before the meeting next week</td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Wed Jan 25 2023 13:03:43 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think of <code>run</code> as something you call "once per thread" (conceptually)</blockquote></mx-reply>one use case I like to imagine is an async task runner system, where <code>run</code> gets called behind the scenes once per subtask, setting the current subtask object for that execution subtree, say</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Wed Jan 25 2023 13:05:35 GMT-0800 (Pacific Standard Time)">21:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">(which is mostly to say <code>run</code> could happen fairly often in normal code)</td></tr>
  <tr class="msg" id="L153"><td class="ts-cell"><a class="ts" href="#L153" alt="Wed Jan 25 2023 13:07:43 GMT-0800 (Pacific Standard Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">would <code>wrap</code> affect V8's async stack tracing?</td></tr>
  <tr class="msg" id="L154"><td class="ts-cell"><a class="ts" href="#L154" alt="Wed Jan 25 2023 13:07:49 GMT-0800 (Pacific Standard Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Subtask is a better word than thread, yes</td></tr>
  <tr class="msg" id="L155"><td class="ts-cell"><a class="ts" href="#L155" alt="Wed Jan 25 2023 13:08:29 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Do you mean the one that exists if you check the box in devtools?</td></tr>
  <tr class="msg" id="L156"><td class="ts-cell"><a class="ts" href="#L156" alt="Wed Jan 25 2023 13:09:11 GMT-0800 (Pacific Standard Time)">21:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think not too often that, for example, it's a problem that <code>run</code> requires some allocation, and using a mutable object would mean even more allocation</td></tr>
  <tr class="msg" id="L157"><td class="ts-cell"><a class="ts" href="#L157" alt="Wed Jan 25 2023 13:12:37 GMT-0800 (Pacific Standard Time)">21:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">right now I guess you'll see the immediately calling callstack when the wrapped function runs, not the one from wherever it was first wrapped (which could also be useful)</td></tr>
  <tr class="msg" id="L158"><td class="ts-cell"><a class="ts" href="#L158" alt="Wed Jan 25 2023 13:13:45 GMT-0800 (Pacific Standard Time)">21:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">if the immediate caller is the event loop, maybe there's room to restore the previous async stack instead of showing nothing there</td></tr>
  <tr class="msg" id="L159"><td class="ts-cell"><a class="ts" href="#L159" alt="Wed Jan 25 2023 13:14:03 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@benjamn:matrix.org">Ben Newman (Apollo, @benjamn on GH)</span>&gt;</div></td><td class="msg-cell">(not sure if this even remotely answers the question)</td></tr>
  <tr class="msg" id="L160"><td class="ts-cell"><a class="ts" href="#L160" alt="Wed Jan 25 2023 13:14:23 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Do you mean the one that exists if you check the box in devtools?</blockquote></mx-reply>If you mean this one--that's a good point, probably it should be based on AsyncContext, if that can be done efficiently enough.</td></tr>
  <tr class="msg" id="L161"><td class="ts-cell"><a class="ts" href="#L161" alt="Wed Jan 25 2023 13:14:38 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I had to check whether there was a checkbox</td></tr>
  <tr class="msg" id="L162"><td class="ts-cell"><a class="ts" href="#L162" alt="Wed Jan 25 2023 13:14:46 GMT-0800 (Pacific Standard Time)">21:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the problem is that it'd be a lot of implied <code>run</code> calls</td></tr>
  <tr class="msg" id="L163"><td class="ts-cell"><a class="ts" href="#L163" alt="Wed Jan 25 2023 13:15:00 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">it's enabled by default, at least in M111</td></tr>
  <tr class="msg" id="L164"><td class="ts-cell"><a class="ts" href="#L164" alt="Wed Jan 25 2023 13:15:11 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">or rather, the checkbox says "disable"</td></tr>
  <tr class="msg" id="L165"><td class="ts-cell"><a class="ts" href="#L165" alt="Wed Jan 25 2023 13:15:21 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">huh, really?</td></tr>
  <tr class="msg" id="L166"><td class="ts-cell"><a class="ts" href="#L166" alt="Wed Jan 25 2023 13:15:50 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">well, it may be default-on when you open up the devtools panel, for example</td></tr>
  <tr class="msg" id="L167"><td class="ts-cell"><a class="ts" href="#L167" alt="Wed Jan 25 2023 13:15:58 GMT-0800 (Pacific Standard Time)">21:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">it's also been shipping in Deno and Node for a while</td></tr>
  <tr class="msg" id="L168"><td class="ts-cell"><a class="ts" href="#L168" alt="Wed Jan 25 2023 13:16:17 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">always-on async stack traces have been a long-time feature request; I hadn't heard that that was granted, but if so, great</td></tr>
  <tr class="msg" id="L169"><td class="ts-cell"><a class="ts" href="#L169" alt="Wed Jan 25 2023 13:16:42 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">they ultimately run into the sort of buffer overrun issue that was raised in response to Yoav's talk at BlinkOn</td></tr>
  <tr class="msg" id="L170"><td class="ts-cell"><a class="ts" href="#L170" alt="Wed Jan 25 2023 13:16:55 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but also, before then, there's a whole lot of bookkeeping</td></tr>
  <tr class="msg" id="L171"><td class="ts-cell"><a class="ts" href="#L171" alt="Wed Jan 25 2023 13:16:59 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">that's why, originally, it wasn't default-on</td></tr>
  <tr class="msg" id="L172"><td class="ts-cell"><a class="ts" href="#L172" alt="Wed Jan 25 2023 13:17:13 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">anyway if they made this cheaper: that's great!</td></tr>
  <tr class="msg" id="L173"><td class="ts-cell"><a class="ts" href="#L173" alt="Wed Jan 25 2023 13:17:52 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><a href="https://docs.google.com/document/d/13Sy_kBIJGP0XT34V1CV3nkWya4TwYx9L3Yv45LdGB6Q/edit">https://docs.google.com/document/d/13Sy_kBIJGP0XT34V1CV3nkWya4TwYx9L3Yv45LdGB6Q/edit</a></td></tr>
  <tr class="msg" id="L174"><td class="ts-cell"><a class="ts" href="#L174" alt="Wed Jan 25 2023 13:18:25 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Ah yes that's a different thing</td></tr>
  <tr class="msg" id="L175"><td class="ts-cell"><a class="ts" href="#L175" alt="Wed Jan 25 2023 13:18:30 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">that's why I started by asking "which one"</td></tr>
  <tr class="msg" id="L176"><td class="ts-cell"><a class="ts" href="#L176" alt="Wed Jan 25 2023 13:18:40 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I didn't realize there were more than one</td></tr>
  <tr class="msg" id="L177"><td class="ts-cell"><a class="ts" href="#L177" alt="Wed Jan 25 2023 13:18:42 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">that is more limited to just async/await and sometimes doesn't work</td></tr>
  <tr class="msg" id="L178"><td class="ts-cell"><a class="ts" href="#L178" alt="Wed Jan 25 2023 13:19:30 GMT-0800 (Pacific Standard Time)">21:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think that always-on mechanism will not interact with <code>wrap</code> or anything like that</td></tr>
  <tr class="msg" id="L179"><td class="ts-cell"><a class="ts" href="#L179" alt="Wed Jan 25 2023 13:23:37 GMT-0800 (Pacific Standard Time)">21:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Oh, I guess they got rid of the previous version and there has only been one for a while</td></tr>
  <tr class="msg" id="L180"><td class="ts-cell"><a class="ts" href="#L180" alt="Wed Jan 25 2023 13:24:58 GMT-0800 (Pacific Standard Time)">21:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the previous mechanism also worked for, e.g., setTimeout</td></tr>
  <tr class="msg" id="L181"><td class="ts-cell"><a class="ts" href="#L181" alt="Wed Jan 25 2023 13:27:36 GMT-0800 (Pacific Standard Time)">21:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Here's a description of the old version, clearly working without promises: <a href="https://developer.chrome.com/blog/async-call-stack/">https://developer.chrome.com/blog/async-call-stack/</a></td></tr>
  <tr class="msg" id="L182"><td class="ts-cell"><a class="ts" href="#L182" alt="Wed Jan 25 2023 13:28:04 GMT-0800 (Pacific Standard Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">and here's the release notes for the change: <a href="https://developer.chrome.com/blog/new-in-devtools-60/#async-stacks">https://developer.chrome.com/blog/new-in-devtools-60/#async-stacks</a></td></tr>
  <tr class="msg" id="L183"><td class="ts-cell"><a class="ts" href="#L183" alt="Wed Jan 25 2023 13:28:27 GMT-0800 (Pacific Standard Time)">21:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I think, with the previous version, you'd expect <code>wrap</code> to continue the async stack trace. With the new version, you would not--it is specific to Promises.</td></tr>
  <tr class="msg" id="L184"><td class="ts-cell"><a class="ts" href="#L184" alt="Wed Jan 25 2023 14:39:34 GMT-0800 (Pacific Standard Time)">22:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think they want you to manually tag your stacks now: <a href="https://developer.chrome.com/blog/devtools-modern-web-debugging/#:~:text=The%20Async%20Stack%20Tagging%20API%20introduces%20a%20new%20console%20method%20named%20console.createTask().%20The%20API%20signature%20is%20as%20follows%3A">https://developer.chrome.com/blog/devtools-modern-web-debugging/#:~:text=The%20Async%20Stack%20Tagging%20API%20introduces%20a%20new%20console%20method%20named%20console.createTask().%20The%20API%20signature%20is%20as%20follows%3A</a></td></tr>

</tbody></table></div></div></div>
</body></html>