<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2023-03-17</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2023-03-17<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-03-16" class="nav-link"><span>prev</span></a>
<a href="2023-03-22" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Mar 16 2023 19:46:06 GMT-0700 (Pacific Daylight Time)">02:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> How did the WebPerf WG meeting to, <span class="nick-7">Chengzhong Wu</span> ?</blockquote></mx-reply>as far as I can tell, the initial feedback is positive (slides of the talk: <a href="https://docs.google.com/presentation/d/1cmAUbNUsqkuO6gMjhPaEcVGHuCJFYluntw7AIPETGaI/edit?usp=sharing">https://docs.google.com/presentation/d/1cmAUbNUsqkuO6gMjhPaEcVGHuCJFYluntw7AIPETGaI/edit?usp=sharing</a>)</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Thu Mar 16 2023 20:08:12 GMT-0700 (Pacific Daylight Time)">03:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Are there notes?</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Thu Mar 16 2023 20:09:34 GMT-0700 (Pacific Daylight Time)">03:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">It should be published shortly at <a href="https://w3c.github.io/web-performance/meetings/">https://w3c.github.io/web-performance/meetings/</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Thu Mar 16 2023 20:10:47 GMT-0700 (Pacific Daylight Time)">03:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Not published yet.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Thu Mar 16 2023 20:12:04 GMT-0700 (Pacific Daylight Time)">03:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">The use cases there are very interesting. Maybe it would be useful to link that deck from the readme</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Thu Mar 16 2023 20:12:32 GMT-0700 (Pacific Daylight Time)">03:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">And possibly go into it at TC39 as well if there is skepticism raised</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Thu Mar 16 2023 20:13:21 GMT-0700 (Pacific Daylight Time)">03:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(Could be pasted on as bonus slides?)</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Thu Mar 16 2023 20:24:35 GMT-0700 (Pacific Daylight Time)">03:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">yeah, we can bring the use case slides up when needed.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Thu Mar 16 2023 20:25:42 GMT-0700 (Pacific Daylight Time)">03:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So I'd suggest saying, "asynchronous flow of control", or especially better if we say something more concrete, e.g., "Annotating logs with information related to a particular logically related series of operations, even with callbacks and promises" (or, maybe there's a better way to put that, idk)</blockquote></mx-reply>Agreed. "async stack" sounds like we are preserving the exact call stacks but this is not accurate.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Mar 17 2023 01:26:05 GMT-0700 (Pacific Daylight Time)">08:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">Rough minutes are at <a href="https://docs.google.com/document/d/1wO7mbGr6f3tDnEWAaMSVI0bMeEHIdcLbAKeOQe-Zh4U/edit#heading=h.1sx1vjpi65co">https://docs.google.com/document/d/1wO7mbGr6f3tDnEWAaMSVI0bMeEHIdcLbAKeOQe-Zh4U/edit#heading=h.1sx1vjpi65co</a></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Mar 17 2023 01:28:08 GMT-0700 (Pacific Daylight Time)">08:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">The document is not public -- access requested</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Mar 17 2023 01:28:38 GMT-0700 (Pacific Daylight Time)">08:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">apologies! should be now</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Mar 17 2023 01:34:52 GMT-0700 (Pacific Daylight Time)">08:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">If I can try to summarize the feedback: RUM providers would be very interested in being able to keep track of operations that are a result of a certain AsyncContext</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Mar 17 2023 01:35:33 GMT-0700 (Pacific Daylight Time)">08:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">e.g. "This element timing entry is a result of a user click on element X" is something they'd love to be able to surface to their customers</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Mar 17 2023 01:36:12 GMT-0700 (Pacific Daylight Time)">08:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">It was unclear from the conversation if the current API enables them to achieve that without over-instrumentation of their customers' code (which they prefer not to do)</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Mar 17 2023 01:38:26 GMT-0700 (Pacific Daylight Time)">08:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">But maybe magicaly surfacing the AsyncContext data in PerfObserver entries can help them do that if they wrap addEventListener callbacks</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Mar 17 2023 01:50:17 GMT-0700 (Pacific Daylight Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Yeah, this can be another interesting topic that we can discuss about. Node.js provides <a href="https://nodejs.org/api/diagnostics_channel.html#diagnostics-channel"><code>diagnostics_channel</code></a> for library providers to expose certain events, for example: <a href="https://github.com/nodejs/undici/blob/main/docs/api/DiagnosticsChannel.md">https://github.com/nodejs/undici/blob/main/docs/api/DiagnosticsChannel.md</a>.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Mar 17 2023 01:54:19 GMT-0700 (Pacific Daylight Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">I don't think async context is the exact only tool helping in this problem.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Mar 17 2023 02:00:55 GMT-0700 (Pacific Daylight Time)">09:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell"><a href="https://docs.google.com/document/d/16HstQ6yHWMhFHflrpnKTeH0FDGxpQ8fKWqbA1mos3Ag/edit#heading=h.9g3dvhcn9qro">https://docs.google.com/document/d/16HstQ6yHWMhFHflrpnKTeH0FDGxpQ8fKWqbA1mos3Ag/edit#heading=h.9g3dvhcn9qro</a> as I jotted down what I think a JS side impl may look like from my perspective </td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Mar 17 2023 02:01:09 GMT-0700 (Pacific Daylight Time)">09:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-6" title="@yoavweiss:matrix.org">Yoav Weiss</span>&gt;</div></td><td class="msg-cell">(dunno much about the implementation complexity of actually doing that in V8)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Mar 17 2023 04:43:21 GMT-0700 (Pacific Daylight Time)">11:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">Is <code>AsyncContext.wrap</code> only needed in userland JS with things like non-builtin promise libraries?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Mar 17 2023 04:44:14 GMT-0700 (Pacific Daylight Time)">11:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I was mostly thinking of it from an implementation perspective where you have to wrap when enqueuing promise jobs and other tasks, so I hadn't really thought about how it'd be used in userland</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Mar 17 2023 04:45:11 GMT-0700 (Pacific Daylight Time)">11:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">but I guess it's only really useful at that same level of abstraction</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Mar 17 2023 04:54:40 GMT-0700 (Pacific Daylight Time)">11:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Yoav Weiss</span>: I think what you describe there matches what we're doing in workers. We do have cases where we gave to grab a strong reference the current frame (taskscope in your proposal) and enter it manually (for instance, when queuing unhandled rejection events, or setTimer/setInterval... We also use it for tracing internally). If we had to implement task attribution apis in the runtime I don't think that's too much of a problem tho I would need to see more of what's involved. </td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Mar 17 2023 06:01:38 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> and no matter how that gets implemented in V8, V8-based WinterCG runtimes could handle it the same way as Chromium</blockquote></mx-reply>I don't think this is the case, because Node.js at least needs to be able to host Chrome at the same time. So there's value in the "multiplexing" of different variables being at the V8 level, rather than the blink level. Is that right, <span class="nick-3">James M Snell</span> ?</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Mar 17 2023 06:01:59 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">oh, that's right, Electron</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Mar 17 2023 06:06:48 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yep that's exactly it. As long as embedders can capture a reference to the entire frame at a point in time when necessary. </td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Mar 17 2023 06:07:14 GMT-0700 (Pacific Daylight Time)">13:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Having v8 manage it for us is best</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Mar 17 2023 10:26:12 GMT-0700 (Pacific Daylight Time)">17:26</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> It was unclear from the conversation if the current API enables them to achieve that without over-instrumentation of their customers' code (which they prefer not to do)</blockquote></mx-reply>I'm also not certain how they collect their data. If it's anything like OTEL, then we should be pretty good.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Mar 17 2023 10:28:06 GMT-0700 (Pacific Daylight Time)">17:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Is <code>AsyncContext.wrap</code> only needed in userland JS with things like non-builtin promise libraries?</blockquote></mx-reply>It's also useful when firing batches of handlers with a framework level event listener. Eg, I don't want to install a click listener on every element, I just want one at the root and it'll fire the handlers for the specific element that was clicked.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Mar 17 2023 10:29:10 GMT-0700 (Pacific Daylight Time)">17:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">right, any time you have an API which takes a callback and the API logically "schedules" that callback, it might be a good idea to use .wrap()</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Mar 17 2023 10:34:09 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So I'd suggest saying, "asynchronous flow of control", or especially better if we say something more concrete, e.g., "Annotating logs with information related to a particular logically related series of operations, even with callbacks and promises" (or, maybe there's a better way to put that, idk)</blockquote></mx-reply>I disagree with this. I think explaining this in terms of the async callstack is the perfect way, because people already have a understanding of how that propagates</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Mar 17 2023 10:34:59 GMT-0700 (Pacific Daylight Time)">17:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I don't think the we imply that we're capturing the actual function calls anywhere</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Mar 17 2023 10:44:08 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Particularly for cases like <code>await promiseFromAnotherContext</code>, is the context after that await the one from the promise? That would follow control flow, but describing it as the the callstack clears up that confusion</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Mar 17 2023 10:44:31 GMT-0700 (Pacific Daylight Time)">17:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">And, it's easy to explain why the context contains a certain value, just poke up the callstack in the dev tools</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Mar 17 2023 11:13:19 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don't think the we imply that we're capturing the actual function calls anywhere</blockquote></mx-reply>Huh, what does the term callstack mean to you?</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Mar 17 2023 11:14:10 GMT-0700 (Pacific Daylight Time)">18:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Anyway I am just trying to help you make things are clear, itâ€™s your call how to present it</td></tr>

</tbody></table></div></div></div>
</body></html>