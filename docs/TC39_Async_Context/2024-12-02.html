<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-12-02</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-12-02<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-11-18" class="nav-link"><span>prev</span></a>
<a href="2024-12-03" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun Dec 01 2024 18:21:22 GMT-0800 (Pacific Standard Time)">02:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">I see references to <code>enterWith</code> but basically nothing in github about it?</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sun Dec 01 2024 18:22:12 GMT-0800 (Pacific Standard Time)">02:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I see references to <code>enterWith</code> but basically nothing in github about it?</blockquote></mx-reply>Hi. This refers to the <code>enterWith</code> method in Node.js's <code>AsyncLocalStorage</code></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sun Dec 01 2024 18:22:24 GMT-0800 (Pacific Standard Time)">02:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">Ahh</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sun Dec 01 2024 18:22:27 GMT-0800 (Pacific Standard Time)">02:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><a href="https://nodejs.org/docs/latest/api/async_context.html#asynclocalstorageenterwithstore">https://nodejs.org/docs/latest/api/async_context.html#asynclocalstorageenterwithstore</a></td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sun Dec 01 2024 18:23:09 GMT-0800 (Pacific Standard Time)">02:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">Yeah, that's weird. It's basically like putting <code><a href="http://var.run">var.run</a></code> around the <em>entire continuation</em>.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Sun Dec 01 2024 18:28:34 GMT-0800 (Pacific Standard Time)">02:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">So "AsyncContext v2" is also a Node reference?</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Sun Dec 01 2024 18:29:53 GMT-0800 (Pacific Standard Time)">02:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So "AsyncContext v2" is also a Node reference?</blockquote></mx-reply>I don't know what it's a reference to, where did you see that?</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Sun Dec 01 2024 18:33:30 GMT-0800 (Pacific Standard Time)">02:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I prototyped a quick proof-of-concept that it's possible to leverage most of an existing implementation and add a disposable <code>enterWith</code> by just replacing <code>AsyncContext.Variable</code> with a new implementation that indirects through a single "real" variable: <a href="https://gist.github.com/shicks/0cd7e9b06535793c137934cc52ed12ce">https://gist.github.com/shicks/0cd7e9b06535793c137934cc52ed12ce</a></blockquote></mx-reply>This gist references v2.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Sun Dec 01 2024 18:34:29 GMT-0800 (Pacific Standard Time)">02:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">oh, right, this refers to <a href="https://github.com/tc39/proposal-async-context/pull/101">https://github.com/tc39/proposal-async-context/pull/101</a>, which are ideas for an extension to AsyncContext</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Sun Dec 01 2024 18:34:29 GMT-0800 (Pacific Standard Time)">02:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell"> * ~~Maybe I imagined it? Not finding it any more.~~</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Sun Dec 01 2024 18:34:55 GMT-0800 (Pacific Standard Time)">02:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">ah thx</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Sun Dec 01 2024 18:35:41 GMT-0800 (Pacific Standard Time)">02:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">Starts to look a bit like Jetpack Compose's snapshots.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Sun Dec 01 2024 18:36:48 GMT-0800 (Pacific Standard Time)">02:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I'm not familiar with those</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Sun Dec 01 2024 18:41:07 GMT-0800 (Pacific Standard Time)">02:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">(completely disconnected topic:) I'm wondering if we should also have a <code>resetFallbackContext</code> API, to isolate inner scopes</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Sun Dec 01 2024 18:41:15 GMT-0800 (Pacific Standard Time)">02:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">the SES folks would probably appreciate that</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Sun Dec 01 2024 18:41:55 GMT-0800 (Pacific Standard Time)">02:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell"><a href="https://blog.zachklipp.com/introduction-to-the-compose-snapshot-system/">https://blog.zachklipp.com/introduction-to-the-compose-snapshot-system/</a> is probably the best explanation</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Sun Dec 01 2024 18:43:25 GMT-0800 (Pacific Standard Time)">02:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">It's kind of built on Kotlin's <code>CoroutineContext</code>, which is basically the same as <code>AsyncContext</code>.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Sun Dec 01 2024 18:44:14 GMT-0800 (Pacific Standard Time)">02:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@taral:matrix.org">Taral</span>&gt;</div></td><td class="msg-cell">(albeit with a somewhat different interface)</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Dec 02 2024 09:20:35 GMT-0800 (Pacific Standard Time)">17:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jkrems:matrix.org">Jan Olaf Martin</span>&gt;</div></td><td class="msg-cell">After a chat about async context with <span class="nick-2">Steve Hicks</span>, I was wondering if other (non-fetch/non-xhr) async network operations should also preserve context? E.g. image and/or script loading triggers and their <code>onload</code> handlers.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Dec 02 2024 10:22:49 GMT-0800 (Pacific Standard Time)">18:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> (completely disconnected topic:) I'm wondering if we should also have a <code>resetFallbackContext</code> API, to isolate inner scopes</blockquote></mx-reply>What would <code>resetFallbackContext</code> do?  Would it escape out of whatever fallback context it was previously in?  That seems problematic, if fallback contexts were supposed to be able to isolate entire (transitive) chunks of code?  Though, I'm very skeptical of the security implications of AsyncContext at all - specifically, I don't think we can confidently guarantee that isolated inner code can never access outer/root/empty contexts - it seems too easy to smuggle a foreign context.  (For instance, we've talked about how <code>addEventListener</code> interacts with <code>runWithFallbackContext</code>, but would <code>onclick</code> setters also respect the same fallback?  If they're not <em>all</em> currently implemented as setter properties, then this might be extremely infeasible to change)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Dec 02 2024 10:23:33 GMT-0800 (Pacific Standard Time)">18:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I was thinking that it would reset to the empty context</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Dec 02 2024 10:24:33 GMT-0800 (Pacific Standard Time)">18:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Yeah, that's weird. It's basically like putting <code><a href="http://var.run">var.run</a></code> around the <em>entire continuation</em>.</blockquote></mx-reply>As we talk about more and more callback-accepting APIs (<code>runWithFallbackContext</code>, <code>resetFallbackContext</code>, etc, on top of <code>Variable#run</code> and <code>Snapshot#run</code>), will all of these be rendered obsolete if we end up exposing a <code>set</code>/<code>enterWith</code> API?</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Dec 02 2024 10:25:29 GMT-0800 (Pacific Standard Time)">18:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I was thinking that it would reset to the empty context</blockquote></mx-reply>This maybe suggests it's worth making it explicit that empty context should never be considered privileged?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Dec 02 2024 10:28:33 GMT-0800 (Pacific Standard Time)">18:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> As we talk about more and more callback-accepting APIs (<code>runWithFallbackContext</code>, <code>resetFallbackContext</code>, etc, on top of <code>Variable#run</code> and <code>Snapshot#run</code>), will all of these be rendered obsolete if we end up exposing a <code>set</code>/<code>enterWith</code> API?</blockquote></mx-reply>In Node.js I still see significant usage of <code>.run</code>, even if there is <code>.enterWith</code> (!!! this is not backed up by data, just by me looking at <code>.enterWith</code> usage patterns a month ago)</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Dec 02 2024 10:29:26 GMT-0800 (Pacific Standard Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><p>If you have access to the empty context, you could write (in userland)</p>
<pre><code>function resetFallbackContext(fn) {
  const snapshot = new AsyncContext.Snapshot();
  return EMPTY_SNAPSHOT.run(() =&gt; runWithFallbackContext(() =&gt; snapshot.run(fn)));
}
</code></pre>
</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Dec 02 2024 10:29:54 GMT-0800 (Pacific Standard Time)">18:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">(though the 3-8 extra frames on the stack are unfortunate)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Dec 02 2024 10:30:47 GMT-0800 (Pacific Standard Time)">18:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">I'm not sure I understand the use case for <code>resetFallbackContext</code></td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Dec 02 2024 10:31:54 GMT-0800 (Pacific Standard Time)">18:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">the use case I see is establishing a security boundary</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Dec 02 2024 10:35:38 GMT-0800 (Pacific Standard Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">But it does the opposite: it lets you <em>escape</em> the boundary that your caller set up for you</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Dec 02 2024 10:35:57 GMT-0800 (Pacific Standard Time)">18:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@nicolo-ribaudo:matrix.org">nicolo-ribaudo</span>&gt;</div></td><td class="msg-cell">(note: this is not about security, since there are many ways to get to the root context)</td></tr>

</tbody></table></div></div></div>
</body></html>