<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-05-31</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-05-31<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-05-30" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri May 31 2024 09:20:03 GMT-0700 (Pacific Daylight Time)">16:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <pre><code class="language-js">// Measure request time
app.use(async function (ctx, next) {
  const start = Date.now()
  await next()

  // While this happens _after_ the following middleware runs,
  // the store value will not be set.
  const id = store.get()
  console.log(`Request #${id} took ${Date.now() - start}ms`)
})

// Store a request id value
let id = 0
app.use(async function (ctx, next) {
  await store.run(++id, next)
})
</code></pre>
</blockquote></mx-reply><p>This took me a while to understand your logic as to why this <em>benefits</em> from flowing through, rather than the other way around. It seems strange to me that you would expect to be able to use the id produced later - if you just rearrange them, then it works with flow-around, and that's the order I'd expect them to be in.</p>
<p>But it seems like flow-through allows making it order-independent with a bit more care, at the cost of risking a catastrophic failure if somebody trashes your state, while flow-around insulates you from the risk (it's defensive programming by default, essentially), but then adds risk from structuring your middlewares incorrectly.</p></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri May 31 2024 10:11:22 GMT-0700 (Pacific Daylight Time)">17:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell"><p>That particular case is an <em>obvious</em> ordering problem, but when different systems are owned by different teams it's common to encounter scenarios like that where a team doesn't realize the specific implementation details of something means the data is not available where they expect it to be. With flow-through, anything that is logically <em>after</em> should reasonably expect to receive the context from something which came before it, whereas with around flow you have to deeply understand the full structure of the application to know exactly <em>where</em> context will reach, and refactors become problematic because if things get raised to different levels suddenly they have different contexts.</p>
<p>As for risk of state being trashed, I don't see how that's possible unless you go around sharing stores with untrusted users, in which case it's kind of your own fault if it gets trashed. Generally a store should be owned and managed by the same code so you always fully <em>know</em> what's in the store. Even with around flow you can still get trashed stores if you give others access to the store as they can just <code><a href="http://store.run">store.run</a>(...)</code> <em>anywhere</em>.</p>
</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri May 31 2024 10:13:56 GMT-0700 (Pacific Daylight Time)">17:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">To me, there's not really <em>any</em> "risk" of store state being corrupted in the through flow, and on the contrary there is <em>lots</em> of risk of it being corrupted by <em>around</em> flow as it cuts off branches all over the place, often in places not desired by the consuming code.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri May 31 2024 10:17:28 GMT-0700 (Pacific Daylight Time)">17:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Even for the <em>intended</em> case of only flowing inward, it's <em>still</em> possible to mess up the state by wrapping nested calls in additional unexpected <code><a href="http://store.run">store.run</a>(...)</code> calls, if you've passed around the store, and the global snapshot concept gives <em>anyone</em> a bunch of power to completely destroy the state of <em>all</em> stores by binding in strange places. I've always advocated for per-store binding with global/snapshot bind only used for <em>very exceptional</em> cases, generally managed by the runtime or some very specific userland module cases which should be <em>very clearly</em> communicated what the risks are to modifying the global flow graph.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri May 31 2024 11:07:20 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> To me, there's not really <em>any</em> "risk" of store state being corrupted in the through flow, and on the contrary there is <em>lots</em> of risk of it being corrupted by <em>around</em> flow as it cuts off branches all over the place, often in places not desired by the consuming code.</blockquote></mx-reply><p>The existence of global snapshotting means that (with flow-through) a subtask you call can trash your continuation context.  Flow-around insulates you from this because it guarantees that no subtask can affect your state, but at the cost of making it more expensive to extract state you actually <em>want</em> to get out of a subtask.  Again, it's a question of intention, assumptions, and defaults.</p>
<p>If we get the defaults right, then it may be perfectly reasonable to say "just don't use global snapshot" because the defaults will make it so that nobody ever really needs to.  If we get it even slightly wrong, we risk a cargo cult developing where less-informed developers think they need to use it <em>everywhere</em> and now you're stuck being ridiculously defensive about protecting your own context.</p>
</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri May 31 2024 11:08:42 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">It can't trash your state within local scope, but it definitely <em>can</em> trash your state in descending contexts.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri May 31 2024 11:09:47 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">As I expressed previously, around flow is actually just through flow with some extra snapshot binds layered on top. You can interfere with it in <em>exactly the same ways</em> when messing with global snapshots.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri May 31 2024 11:11:10 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">All the issues you are pointing out are issues with around flow too.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri May 31 2024 11:11:13 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I see descending contexts as their own responsibility.  I think this is reflecting our different perspectives.  I'm inclined to trust functions that call me (insofar as I'll assume that whatever state they give me is what they intended to, at least) more than I am to trust functions that I call.  It sounds like you're more inclined to trust the functions that you call, and less inclined to trust the functions that call you.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri May 31 2024 11:12:52 GMT-0700 (Pacific Daylight Time)">18:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">What I'm getting at is that we seem to be looking at something from two different directions - there's a lot of analogue/duality between them, and I think if we understand the bigger picture it might lead to a unified solution that makes sense from all angles.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri May 31 2024 11:13:00 GMT-0700 (Pacific Daylight Time)">18:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">It's not about <em>trust</em>, it's about <em>expectation</em>. With through flow it is <em>expected</em> that intermediate things can mutate the context if you give them access to do so. Whereas with <em>around</em> context it's <em>not</em> generally expected, but still possible.</td></tr>

</tbody></table></div></div></div>
</body></html>