<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-04-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-04-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-04-11" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Thu Apr 11 2024 20:36:40 GMT-0700 (Pacific Daylight Time)">03:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> we have to have this conversation with Steven and Signals people about Computed's context -- there's a concern that call-time context there would constitute "Zalgo": a computed signal could be forced in many different ways, and it should be giving the same answer regardless of context (of course we need some debugging/perf analysis tools to be possible)</blockquote></mx-reply><p>I agree that there's definite problems with computed signals - it's possible that two setters feed into the same computed signal and could have been set in different contexts, plus the fact that they're computed lazily might point to the reader's context as the correct call-time context (i.e. coming from the other direction). So there's potentially three or more different options and not necessarily a good way to disambiguate all of them.</p>
<p>That said, if there's no way to access the context(s) that set the signal(s) that caused the recompute, then tracing in many UI frameworks is essentially sunk. In my experience, it's a <em>very</em> common pattern to have an event handler do nothing but update a signal. If the tracing framework initiates a trace in the event handler then the trace would simply die then and there, whereas we'd like to be able to link that trace to any downstream reactions/effects, all the way to the re-render.</p></td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Apr 12 2024 06:18:50 GMT-0700 (Pacific Daylight Time)">13:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I see... so in this case, it's like application state should be registration-based, but tracing state should be call-based... :(</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Apr 12 2024 07:07:22 GMT-0700 (Pacific Daylight Time)">14:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">What's an example of application state that you'd want to be registration-based? My general (but somewhat uninformed) rule-of-thumb is that if a callback is intended to be called multiple times, it's more likely to want call-time context.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Apr 12 2024 07:11:25 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">an example is if we wanted to use AsyncContext for tracking the owner in tree-based rendering, or generally, React Context-style information</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Apr 12 2024 07:11:47 GMT-0700 (Pacific Daylight Time)">14:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">we could use AsyncContext.Snapshot.wrap for these cases but then it'd defeat tracing, sounds like...</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Apr 12 2024 07:12:30 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">also for the style of React Hooks using global variables under the hood</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Apr 12 2024 07:13:17 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">restoring the context after await is an example of registration-time behavior I think</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Apr 12 2024 07:13:34 GMT-0700 (Pacific Daylight Time)">14:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(especially obvious if you consider what explicit calls of .then() should do)</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Apr 12 2024 10:21:50 GMT-0700 (Pacific Daylight Time)">17:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">That's a good point about <code>await</code>.  I brought it up in the context of async generators in <a href="https://github.com/tc39/proposal-async-context/pull/77#issuecomment-2048897179">https://github.com/tc39/proposal-async-context/pull/77#issuecomment-2048897179</a> - I think my general expectation is that context needs to be <em>preserved</em> across an <code>await</code>, rather than <em>restored</em> to some particular snapshot on reentry</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Apr 12 2024 10:50:55 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Justin keeps talking about "restoring to the initial snapshot" but I've always been thinking about the semantics as "preserving the one that was right before the await or yield" (that's my mental model for AsyncContext in general). In the end, there isn't an observable difference between them, though.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Apr 12 2024 10:51:30 GMT-0700 (Pacific Daylight Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">well, with a disposable there would be a difference</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Apr 12 2024 10:52:22 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">right, if we had some flat way of doing <code>run</code> within a function, I'd <em>definitely</em> want the semantics to be, preserve what was before the await/yield; I don't see any argument for "restore the one at function entry"</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Apr 12 2024 10:52:58 GMT-0700 (Pacific Daylight Time)">17:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I think await and yield are <em>maybe</em> separate questions, but otherwise I agree.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Apr 12 2024 10:53:29 GMT-0700 (Pacific Daylight Time)">17:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">is there any post which captures your thoughts on yield? it's been a little hard for me to follow the threads given their length</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Apr 12 2024 10:55:33 GMT-0700 (Pacific Daylight Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I don't really use generators, so I don't have particularly strong feelings on yield, beyond recognizing that that's at least a small handful of people who seem to want to be able to observe the calling context somehow or other.  My bigger concern is repeated callbacks, which I think are a little easier to reason about.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Apr 12 2024 10:56:11 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">on yield, it seems like the biggest users in frameworks would actually <em>benefit</em> from these semantics because they end up using yield as a replacement for await</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Apr 12 2024 10:56:45 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but I like focusing on the concrete and want to understand more about your thoughts on callbacks</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Apr 12 2024 10:56:49 GMT-0700 (Pacific Daylight Time)">17:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I <em>think</em> yield-as-await already gets the right behavior automatically based on how promises work.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Apr 12 2024 10:57:15 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I <em>think</em> yield-as-await already gets the right behavior automatically based on how promises work.</blockquote></mx-reply>there's a tiny leak when it comes to thenables... but I think if you want the other behavior you're doing it wrong</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Apr 12 2024 10:57:15 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">(but I haven't thought through the details)</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Apr 12 2024 10:57:54 GMT-0700 (Pacific Daylight Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">What I've heard is, Koa doesn't force a Promise.resolve the way native await does, and that's where the difference comes from</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Apr 12 2024 10:59:21 GMT-0700 (Pacific Daylight Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">For repeated callbacks, it's common to register handlers or data pipelines at application start time.  These callbacks run every time a particular interaction or data flow happens.  There's no meaningful context when they're registered, so it's much more relevant to propagate the call-time context for <em>each</em> iniating circumstance, rather than the (empty) app-init context.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Apr 12 2024 11:00:37 GMT-0700 (Pacific Daylight Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> For repeated callbacks, it's common to register handlers or data pipelines at application start time.  These callbacks run every time a particular interaction or data flow happens.  There's no meaningful context when they're registered, so it's much more relevant to propagate the call-time context for <em>each</em> iniating circumstance, rather than the (empty) app-init context.</blockquote></mx-reply>do you think that events should have registration-time semantics for things that are expected to be one-use, i.e. <code>loadend</code> on XHR?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Apr 12 2024 11:01:16 GMT-0700 (Pacific Daylight Time)">18:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">you can use a single <code>XMLHttpRequest</code> object for multiple fetches, but I don't think most uses do that</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Apr 12 2024 11:09:17 GMT-0700 (Pacific Daylight Time)">18:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><p>More concretely, we have an internal framework that writes code (very roughly) like this:</p>
<pre><code>class UpvoteButtonComponent {
  constructor(private readonly rpcService: RpcService, private readonly id: string) {}
  render(item: ItemDetail) {
    return &lt;button on:click={this.onClick}&gt;{item.getVotes()}&lt;/button&gt;;
  }
  onClick() {
    this.rpcService.sendUpvote(new UpvoteRequest().setId(this.id));
  }
}
// in a totally different file:
RpcService.registerMiddleware(UpvoteResponse.typeId, ItemDetail.typeId,
    (response: UpvoteResponse) =&gt; response.getId(),
    (item: ItemDetail) =&gt; item.getId(),
    (response: UpvoteResponse, item: ItemDetail) =&gt; {
      item.setVotes(response.getNewVoteCount());
    });
</code></pre>
<p>In this example, there's a lot of loose coupling: the click handler just fires-and-forgets an RPC.  The RPC service has some middleware registered that gets a response of a certain type and then indexes all the cached ItemDetail models by their ID, retrieves the matching detail, and updates its votes.  The UI data binding then picks up this change and rerenders the component.  What I need to be able to do is thread a trace through that sequence of loosely coupled triggers.  The callbacks are all registered once, when the module is loaded, but they need to carry along the call-time context in order to preserve the trace.</p>
</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Apr 12 2024 11:10:04 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(is this the same internal framework that Jatin works on?)</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Apr 12 2024 11:10:26 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">My understanding is that this sort of loosely-coupled data binding is common in external frameworks as well.  Yes, it's the same.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Apr 12 2024 11:10:58 GMT-0700 (Pacific Daylight Time)">18:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">hey how do people feel about getting a logo for AsyncContext like we have for Signals? <a href="https://github.com/tc39/proposal-signals/blob/main/signals-logo.png">https://github.com/tc39/proposal-signals/blob/main/signals-logo.png</a></td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Apr 12 2024 11:11:16 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I can ask my friend who did the other one if he could do this too</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Apr 12 2024 11:11:39 GMT-0700 (Pacific Daylight Time)">18:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">somehow logos make it easier to talk about things, sometimes</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Apr 12 2024 11:41:53 GMT-0700 (Pacific Daylight Time)">18:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I need to better understand the concern about <code>using</code> and an async context scope. As I understand it, even with <code>[Symbol.enter]</code> you're concerned it's possible exit the function without exiting the scope?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Apr 12 2024 11:46:32 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I need to better understand the concern about <code>using</code> and an async context scope. As I understand it, even with <code>[Symbol.enter]</code> you're concerned it's possible exit the function without exiting the scope?</blockquote></mx-reply>the concern is that buggy (or malicious) code that calls <code>[Symbol.enter]</code> but not <code>[Symbol.dispose]</code> would change the context available when the function returns</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Apr 12 2024 11:46:53 GMT-0700 (Pacific Daylight Time)">18:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">currently in the AsyncContext proposal there's no way to change the context in the middle of a function execution</td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Fri Apr 12 2024 11:47:22 GMT-0700 (Pacific Daylight Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">and I think this was a design goal, which is why we didn't adopt <code>AsyncLocalStorage</code>'s <code>enterWith</code></td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Fri Apr 12 2024 11:47:58 GMT-0700 (Pacific Daylight Time)">18:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>How does this:</p>
<pre><code class="language-js">function f() {
  const scopeEnterable = new AsyncContext.Scope();
  scopeEnterable[Symbol.enter]();
  // do work
  // forget to exit scope
}
</code></pre>
<p>differ from this:</p>
<pre><code class="language-js">function f() {
  function* g() {
    using scope = new AsyncContext.Scope();
    // do work
    yield;
  }
  g().next();
}
</code></pre>
</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Fri Apr 12 2024 11:48:52 GMT-0700 (Pacific Daylight Time)">18:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That would also result in a dangling scope, even with some kind of more comprehensive enforcement of <code>using</code></td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Fri Apr 12 2024 11:50:26 GMT-0700 (Pacific Daylight Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">the current scope text switches the context when generators are paused and restored – there's still discussion about whether this is the right behavior, but that would take care of that</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Fri Apr 12 2024 11:50:31 GMT-0700 (Pacific Daylight Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah, neither of those is acceptable, that's the thing</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Fri Apr 12 2024 11:50:42 GMT-0700 (Pacific Daylight Time)">18:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the current API is based on <code>.run(cb)</code> instead</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Fri Apr 12 2024 11:51:23 GMT-0700 (Pacific Daylight Time)">18:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If failing to exit the scope is unacceptable, then there's no way to achieve that kind of enforcement with <code>using</code></td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Fri Apr 12 2024 11:52:18 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I guess the fact that AsyncContext <em>can</em> switch the scope for generators is a thing that no userland use cases could do, so maybe that doesn't apply more generally</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Fri Apr 12 2024 11:52:53 GMT-0700 (Pacific Daylight Time)">18:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Async functions would also result in a dangling scope</p>
<pre><code class="language-js">async function f(p) {
  using scope = new AsyncContext.Scope();
  // do work
  await p;
}

const { promise, resolve } = Promise.withResolves();
f(p);
// never call resolve()
</code></pre>
</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Fri Apr 12 2024 11:54:52 GMT-0700 (Pacific Daylight Time)">18:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This leads me to believe that <code>AsyncContext.Scope</code> isn't viable.</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Fri Apr 12 2024 11:55:21 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">a different thing in the space of <code>using</code> could hypothetically solve this problem--maybe more along the lines of what you described Python can do in <code>with</code>.</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Fri Apr 12 2024 11:55:45 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">not that we need that, but the name of the proposal kinda feels like a tease, <em>almost</em> getting us there</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Fri Apr 12 2024 11:55:55 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Python's <code>with</code> would have the exact same issues.</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Fri Apr 12 2024 11:55:58 GMT-0700 (Pacific Daylight Time)">18:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> This leads me to believe that <code>AsyncContext.Scope</code> isn't viable.</blockquote></mx-reply>I think it would be viable, because AsyncContext needs to integrate with generator resuming and promise continuations. But maybe similar use cases implemented in userland could not.</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Fri Apr 12 2024 11:56:38 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">And I'm not willing to ask for the strict <code>using</code> enforcement proposal to change to fit use cases which are limited to spec proposals</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Fri Apr 12 2024 11:56:43 GMT-0700 (Pacific Daylight Time)">18:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">in the extreme case: if <code>using</code> was passed the delimited continuation as an argument...</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Fri Apr 12 2024 11:58:17 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I think you're missing something here.  The issue is only in any shared contexts.  The context outside the async function isn't affected by the Scope.  I assume the point of Scope is that it effectively makes a child context "in place" - so it wouldn't impact any other function bodies that were sharing the same context as <em>before</em> the Scope is entered.  Specifically, it would <em>not</em> mutate the current context.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Fri Apr 12 2024 11:58:20 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> in the extreme case: if <code>using</code> was passed the delimited continuation as an argument...</blockquote></mx-reply>I don't see how this wouldn't be significantly worse.</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Fri Apr 12 2024 11:58:49 GMT-0700 (Pacific Daylight Time)">18:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don't see how this wouldn't be significantly worse.</blockquote></mx-reply>it would solve the problem that Andreu is talking about, while also, yes, being a crazy thing that we definitely shouldn't do</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Fri Apr 12 2024 11:59:08 GMT-0700 (Pacific Daylight Time)">18:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the design of <code>.run(cb)</code> forces you to extract the delimited continuation manually</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Fri Apr 12 2024 12:01:19 GMT-0700 (Pacific Daylight Time)">19:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><p>Where I see a problem is</p>
<pre><code>{
  using scope = new AsyncContext.Scope();
  // ...
  const innerScope =  new AsyncContext.Scope();
  innerScope[Symbol.enter]();
  // ...
}
// what happens to vars set on innerScope?
innerScope[Symbol.dispose]();
// what happens now?
</code></pre>
</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Fri Apr 12 2024 12:02:50 GMT-0700 (Pacific Daylight Time)">19:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">if you were to treat this like a stack, as <code>run(cb)</code> would do, I would expect <code>innerScope</code> to be on top of the stack, and when <code>scope</code> is disposed it should throw if it's not on the top of the stack.</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Fri Apr 12 2024 12:03:08 GMT-0700 (Pacific Daylight Time)">19:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Where I see a problem is</p>
<pre><code>{
  using scope = new AsyncContext.Scope();
  // ...
  const innerScope =  new AsyncContext.Scope();
  innerScope[Symbol.enter]();
  // ...
}
// what happens to vars set on innerScope?
innerScope[Symbol.dispose]();
// what happens now?
</code></pre>
</blockquote></mx-reply>I think this could be worked around by keeping the scope depth and invalidating <code>innerScope</code> if <code>scope</code> has been disposed. But I'm not sure at this point if this would work for async functions and generators</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Fri Apr 12 2024 12:04:23 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Do you have to keep track of when you enter or exit a function with <code>run()</code>?</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Fri Apr 12 2024 12:04:52 GMT-0700 (Pacific Daylight Time)">19:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">No</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Fri Apr 12 2024 12:05:23 GMT-0700 (Pacific Daylight Time)">19:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Run enters, invokes the cb, then exits. It can’t leave a dirty stack.</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Fri Apr 12 2024 12:11:50 GMT-0700 (Pacific Daylight Time)">19:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>One way I could envision this behavior would be something like this very naive implementation:</p>
<pre><code class="language-js">AsyncContext.run = function (ctx, cb) {
  using scope = new AsyncContext.Scope(ctx);
  return cb();
}
AsyncContext.Scope = class Scope {
  static #top;
  #prev;
  #ctx;
  constructor(ctx) {
    this.#ctx = ctx;
    this.#prev = Scope.#top;
    Scope.#top = this;
    // other scope setup work
  }
  [Symbol.dispose]() {
    if (this !== Scope.#top) throw new Error();
    Scope.#top = this.#prev;
    // other scope teardown work
  }
}
</code></pre>
<p>Each time you create a new <code>Scope</code>, you're pushing it into a stack. When you fail to pop a scope, you get an error.</p>
</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Fri Apr 12 2024 12:12:08 GMT-0700 (Pacific Daylight Time)">19:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">(I'll also point out that this is effectively impossible to polyfill, for whatever it's worth - you'd need to instrument every function with a local variable to store the current context in, rather than relying on a global.)</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Fri Apr 12 2024 12:16:14 GMT-0700 (Pacific Daylight Time)">19:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This doesn't require strict enforcement and it throws when used incorrectly. Theoretically, before you throw you could also walk the stack from <code>#top</code> to <code>this</code> and exit those contexts as well, but it's still better to error than to exit silently.</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Fri Apr 12 2024 12:18:21 GMT-0700 (Pacific Daylight Time)">19:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think that still leaves a dirty stack, just with an error telling you that something went wrong. It doesn’t prevent the misuse from happening.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Fri Apr 12 2024 12:19:10 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote>(I'll also point out that this is effectively impossible to polyfill, for whatever it's worth - you'd need to instrument every function with a local variable to store the current context in, rather than relying on a global.)</blockquote></mx-reply>Is this in reply to Ron, or the scoped feature in general? I think it’s easily polyfillable.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Fri Apr 12 2024 12:19:15 GMT-0700 (Pacific Daylight Time)">19:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think that still leaves a dirty stack, just with an error telling you that something went wrong. It doesn’t prevent the misuse from happening.</blockquote></mx-reply><code>using</code> doesn't prevent a dirty stack, as I illustrated with the generator and async function example. And as I mentioned, you can clean up the stack before you error.</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Fri Apr 12 2024 12:20:02 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I disagree, it defintely does</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Fri Apr 12 2024 12:20:17 GMT-0700 (Pacific Daylight Time)">19:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">~~not within the context of <code>run</code>.~~ sorry, misread the comment</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Fri Apr 12 2024 12:21:13 GMT-0700 (Pacific Daylight Time)">19:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">How does <code>using</code> prevent a dirty stack, given the examples I just posted?</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Fri Apr 12 2024 12:24:00 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I assume a generator has a magic behavior that does context capturing when started and resumed? Is there any reason you wouldn't do the same for normal function execution? Or is that just too expensive?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Fri Apr 12 2024 12:24:30 GMT-0700 (Pacific Daylight Time)">19:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It requires a modification in the internal pausing behavior for <code data-md="`">await</code> and <code data-md="`">yield</code></td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Fri Apr 12 2024 12:25:19 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I assume a generator has a magic behavior that does context capturing when started and resumed? Is there any reason you wouldn't do the same for normal function execution? Or is that just too expensive?</blockquote></mx-reply>I guess we could do that, but I expect that would break a lot of optimizations in engines</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Fri Apr 12 2024 12:25:56 GMT-0700 (Pacific Daylight Time)">19:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I expect that's true.</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Fri Apr 12 2024 12:29:10 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Assuming some magical enforcement of syntactic <code>using</code> does support your case, how would you expect it to work? Any alternative I've considered so far breaks some other important feature of resource management.</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Fri Apr 12 2024 12:29:45 GMT-0700 (Pacific Daylight Time)">19:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Is this in reply to Ron, or the scoped feature in general? I think it’s easily polyfillable.</blockquote></mx-reply>I was referring to <code>Scope</code> in general - I may just not be seeing it, but short of instrumenting <em>every</em> function to have its own separate mutable context, I don't see how two function bodies sharing the same <code>run</code> context could have <code>Scope</code> mutations from one be isolated from being observed in the other.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Fri Apr 12 2024 12:30:56 GMT-0700 (Pacific Daylight Time)">19:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">For example, lets say you could check a <code>function.using</code> meta property from inside the constructor that is only set when you write <code>using x = new Scope(ctx)</code>. That breaks composability, which is another core capability of resource management.</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Fri Apr 12 2024 12:31:42 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">That’s fine, <code data-md="`">Scope</code> is not composable</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Fri Apr 12 2024 12:31:48 GMT-0700 (Pacific Daylight Time)">19:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It prevents a user from wrapping <code>Scope</code> in another function to make decisions. It prevents a user from entering a <code>Scope</code> conditionally. It prevents instrumentation.</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Fri Apr 12 2024 12:32:33 GMT-0700 (Pacific Daylight Time)">19:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">That would be a huge footgun. </td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Fri Apr 12 2024 12:33:46 GMT-0700 (Pacific Daylight Time)">19:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">How? We’re jsut trying to allow unnested use of <code data-md="`">Variable</code>. We don’t need to do anything else.</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Fri Apr 12 2024 12:35:35 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote>I was referring to <code>Scope</code> in general - I may just not be seeing it, but short of instrumenting <em>every</em> function to have its own separate mutable context, I don't see how two function bodies sharing the same <code>run</code> context could have <code>Scope</code> mutations from one be isolated from being observed in the other.</blockquote></mx-reply>Wouldn’t the <code data-md="`">dispose</code> take care of that? And for the dangling async/generator’s mentioned above, it requires a small modification to the pausing behavior.</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Fri Apr 12 2024 12:35:49 GMT-0700 (Pacific Daylight Time)">19:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It's a footgun because it's confusing to users. If I had <code>using x = new Scope(ctx)</code>, and wanted to refactor to <code>const createScope = ctx =&gt; new Scope(ctx); using x = createScope(ctx);</code>, it suddenly breaks. Nothing else does that in the language, as far as I'm aware.</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Fri Apr 12 2024 12:36:50 GMT-0700 (Pacific Daylight Time)">19:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">It's a TCP violation, made worse because that specific change did not involve new syntax. the "new syntax" part didn't move.</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Fri Apr 12 2024 12:37:18 GMT-0700 (Pacific Daylight Time)">19:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Perfect, The normal case now is <code data-md="`"><a href="http://v.run">v.run</a>(1, () =&gt; …)</code>, which also wouldn’t work that way.</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Fri Apr 12 2024 12:38:27 GMT-0700 (Pacific Daylight Time)">19:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">take any valid expression in <code><a href="http://v.run">v.run</a>(...)</code> and turn it into an arrow and it would still work.</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Fri Apr 12 2024 12:39:29 GMT-0700 (Pacific Daylight Time)">19:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">with perhaps the only distinction being <code>this</code> receiver handling, which is a known quantity.</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Fri Apr 12 2024 12:40:45 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><pre data-md="```"><code>// Doesn't keep 1 on the context stack
const createScope = ctx =&gt; new Scope(ctx, 1);
using x = createScope(ctx);
doStuff();

// Doesn't keep 1 on the context stack
const run = () =&gt; v.run(1, () =&gt; {})
run();
doStuff();
</code></pre></td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Fri Apr 12 2024 12:40:50 GMT-0700 (Pacific Daylight Time)">19:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">These are the same programs</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Fri Apr 12 2024 12:41:03 GMT-0700 (Pacific Daylight Time)">19:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So, I stand corrected. <em>One</em> thing in the language has that oddity, and that's how <code>this</code> receivers work. The complexity of <code>this</code> receivers is not something I want to repeat.</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Fri Apr 12 2024 12:42:10 GMT-0700 (Pacific Daylight Time)">19:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>Where was <code>doStuff</code> before? If your original code was</p>
<pre><code class="language-js">v.run(1, () =&gt; {})
doStuff();
</code></pre>
<p>then it has the same behavior.</p>
</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Fri Apr 12 2024 12:43:17 GMT-0700 (Pacific Daylight Time)">19:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If your code was <code><a href="http://v.run">v.run</a>(1, () =&gt; { doStuff(); });</code>, then you didn't refactor it you changed it to a different behavior.</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Fri Apr 12 2024 12:44:17 GMT-0700 (Pacific Daylight Time)">19:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><p>I'm talking about changing this</p>
<pre><code class="language-js">v.run(1, () =&gt; doStuff());
</code></pre>
<p>into this</p>
<pre><code class="language-js">const f = () =&gt; doStuff();
v.run(1, () =&gt; f());
</code></pre>
<p>or this</p>
<pre><code class="language-js">const f = () =&gt; 1;
v.run(f(), () =&gt; doStuff());
</code></pre>
</td></tr>

</tbody></table></div></div></div>
</body></html>