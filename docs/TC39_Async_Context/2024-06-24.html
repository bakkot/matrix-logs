<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-06-24</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-06-24<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-06-23" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Jun 24 2024 06:35:10 GMT-0700 (Pacific Daylight Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">while checking out <a href="https://github.com/tc39/proposal-async-context/pull/94">https://github.com/tc39/proposal-async-context/pull/94</a>, I noticed that the (current) <code>AsyncContext.Variable</code> semantics <em>also</em> has merge points</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Jun 24 2024 06:35:29 GMT-0700 (Pacific Daylight Time)">13:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">except you can only observe them from the <code>unhandledrejection</code> event</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Jun 24 2024 06:44:19 GMT-0700 (Pacific Daylight Time)">13:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Would you mind elaborating on it? Can a property on <code>PromiseRejectionEvent</code> liked mentioned at <a href="https://matrixlogs.bakkot.com/TC39_General/2024-06-21#L2-L5">https://matrixlogs.bakkot.com/TC39_General/2024-06-21#L2-L5</a> address that?</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Jun 24 2024 06:48:47 GMT-0700 (Pacific Daylight Time)">13:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I think the background for <span class="nick-10">littledan</span>'s comment there was that, when discussing events with Anne and other web platform folks in the Web Engines Hackfest, we agreed that the originating context should be exposed as a (maybe null) property on all events</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Jun 24 2024 06:49:56 GMT-0700 (Pacific Daylight Time)">13:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">and for <code>ErrorEvent</code>, that would just be the regular property, but it would need special tracking across the abrupt completions to be able to get the context in which the exception was thrown</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jun 24 2024 06:50:18 GMT-0700 (Pacific Daylight Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">but I guess for <code>PromiseRejectionEvent</code>, that property could be an array instead</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jun 24 2024 06:50:57 GMT-0700 (Pacific Daylight Time)">13:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">function createRejectionInContext(value) {
    ctx.run(value, () =&gt; Promise.reject());
}

ctx.run("main", () =&gt; {
    // don't await or do anything with the result
    Promise.all([
        createRejectionInContext("task-0"),
        createRejectionInContext("task-1"),
        createRejectionInContext("task-2"),
        createRejectionInContext("task-3"),
    ]);
});

window.onunhandledrejection = (evt) =&gt; {
    evt.originatingContext.run(() =&gt; {
        // Could be task-[0123]. Can't be main.
        console.log(ctx.get());
    })
}
</code></pre>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jun 24 2024 06:52:59 GMT-0700 (Pacific Daylight Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">well, I guess in that example, with the current spec, it would always be <code>task-0</code></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jun 24 2024 06:54:05 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">but for <code>allSettled</code> you would definitely have a merge</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jun 24 2024 06:54:07 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">There should be only one rejection event for the promise of <code>Promise.all</code>, and the <code>evt.promise</code> is the promise of <code>Promise.all</code></td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jun 24 2024 06:54:56 GMT-0700 (Pacific Daylight Time)">13:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">yeah, you're right</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jun 24 2024 06:55:10 GMT-0700 (Pacific Daylight Time)">13:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">but for <code>Promise.allSettled</code> and <code>Promise.any</code> you would have a merge</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jun 24 2024 06:58:38 GMT-0700 (Pacific Daylight Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">if you implemented the current spec as is, you'd get the context of the last promise to resolve</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jun 24 2024 06:58:54 GMT-0700 (Pacific Daylight Time)">13:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">even if that last promise is fulfilled</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jun 24 2024 07:02:16 GMT-0700 (Pacific Daylight Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">that's for <code>Promise.any</code></td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jun 24 2024 07:02:25 GMT-0700 (Pacific Daylight Time)">14:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I didn't realize <code>Promise.allSettled</code> never rejected</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jun 24 2024 07:03:08 GMT-0700 (Pacific Daylight Time)">14:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Yeah, <code>Promise.allSettled</code> never rejects</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jun 24 2024 07:05:59 GMT-0700 (Pacific Daylight Time)">14:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> if you implemented the current spec as is, you'd get the context of the last promise to resolve</blockquote></mx-reply><a href="https://tc39.es/ecma262/#sec-performpromiseany">https://tc39.es/ecma262/#sec-performpromiseany</a> 27.2.4.3.1 step 4.n performs <code>then</code> on the iterated promises, how would it be different from a <code>Promise.prototype.then</code> in this case?</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jun 24 2024 07:08:26 GMT-0700 (Pacific Daylight Time)">14:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">...I might need to trace through the algorithm steps after all</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jun 24 2024 07:09:10 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">yeah, maybe there's no way to observe that after all, since you'd end up with the context in which <code>Promise.any</code> was called in any case</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jun 24 2024 07:09:52 GMT-0700 (Pacific Daylight Time)">14:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Yeah, if I understand it correctly, this is what the document described</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jun 24 2024 07:12:23 GMT-0700 (Pacific Daylight Time)">14:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">...is it? Sorry, I haven't been doing any work on this proposal for the past few weeks (because of other obligations and a break I took), and enough things changed shortly before that that I'm not so sure where things stand right now</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jun 24 2024 07:14:12 GMT-0700 (Pacific Daylight Time)">14:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">We didn't make any normative changes yet. It just wraps up the comparison of semantics.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jun 24 2024 07:42:18 GMT-0700 (Pacific Daylight Time)">14:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I think the background for <span class="nick-10">littledan</span>'s comment there was that, when discussing events with Anne and other web platform folks in the Web Engines Hackfest, we agreed that the originating context should be exposed as a (maybe null) property on all events</blockquote></mx-reply>Once nice property of this solution, as opposed to AsyncContext.currentComputed(), is that it gives us a clear way to add more originating contexts over time without risk of breaking anyone. OTOH with currentComputed, if it would sloppily leave the previous originating context in place until the next time that there's a relevant originating context, then it would change the behavior of existing programs to add more information later. I do see the downside that it's more difficult to use, though.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jun 24 2024 09:37:43 GMT-0700 (Pacific Daylight Time)">16:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@devsnek:matrix.org">snek</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don’t understand a principled way that we should decide which calling contexts to preserve. And the SES folks have made it clear that they see some cases of implicitly propagating the calling contexts to be an unacceptable information leak. But I don’t think losing the calling context in cases like this is a bad enough result to abandon the proposal entirely.</blockquote></mx-reply>i saw a suggestion on the repo to have multiple kinds of variables, which seems like it could be reasonable? in theory each variable kind represents a separate list that an agent has to track so not horrifying to implement at least. i will need to learn more about these specific SES concerns though.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jun 24 2024 10:50:19 GMT-0700 (Pacific Daylight Time)">17:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">Ultimately as far as DOM APIs go, I think not having access to causal context is not a dealbreaker.  I'm a little uneasy about  not being able to access the resolution context for promises, but I don't have a concrete use case where we would need it.  Most of the places we need access to causal context are userland scheduling APIs, and we can just implement them to preserve causal context as needed.  Where this falls down is that (1) it makes it a lot harder to reason about when most builtin schedulers automatically snapshot the registration context, but many userland schedulers (seemingly arbitrarily) depart from that convention, and (2) it will be an adoption blocker for builtin signals if we implement causal context for our own signals' computeds/effects, but the eventual builtin goes along with the pattern of only exposing the registration context.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jun 24 2024 11:05:57 GMT-0700 (Pacific Daylight Time)">18:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">We've discussed the <code>unhandledrejection</code> event a lot, but I don't think we've ever looked at <code>rejectionhandled</code> in much detail</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jun 24 2024 11:06:33 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">since that event is always queued from <code>PerformPromiseThen</code>, it'd have the context that's active when <code>.then</code> is called, right?</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Mon Jun 24 2024 11:06:48 GMT-0700 (Pacific Daylight Time)">18:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">or would it make sense to do something else?</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Mon Jun 24 2024 11:07:28 GMT-0700 (Pacific Daylight Time)">18:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">I didn't even realize such an event even existed... though I'd also like to see resolution context for fulfilled promises</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Mon Jun 24 2024 11:08:25 GMT-0700 (Pacific Daylight Time)">18:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell">(I've been gradually reading the spec but haven't gotten to Promise yet... so I can't say anything intelligent about the details unfortunately)</td></tr>

</tbody></table></div></div></div>
</body></html>