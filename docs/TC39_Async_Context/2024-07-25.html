<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2024-07-25</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2024-07-25<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-24" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Wed Jul 24 2024 19:11:30 GMT-0700 (Pacific Daylight Time)">02:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">I think React is actually kind of a <em>bad</em> basis in a way, because I feel it‚Äôs pointing us down a road that is only useful for functional code and not so much for procedural code.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Wed Jul 24 2024 19:44:56 GMT-0700 (Pacific Daylight Time)">02:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I don‚Äôt understand why running it in the top level snapshot wouldn‚Äôt also amount to Zalgo to the same extent as falling back to the registration context is</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Wed Jul 24 2024 19:51:00 GMT-0700 (Pacific Daylight Time)">02:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">‚ÄúConsistently do nothing‚Äù just isn‚Äôt an option for certain APIs which people have been bringing up here</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Wed Jul 24 2024 19:54:36 GMT-0700 (Pacific Daylight Time)">02:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don‚Äôt understand why running it in the top level snapshot wouldn‚Äôt also amount to Zalgo to the same extent as falling back to the registration context is</blockquote></mx-reply>There‚Äôs not really a way to bind <em>out</em> of registration-time. The other option being ‚Äúhave no context at all‚Äù is maybe not super helpful or intuitive, but you can at least fix that. Whereas if there is an <em>expectation</em> of not having a context then that seems like a reasonable solution to me.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Wed Jul 24 2024 19:54:45 GMT-0700 (Pacific Daylight Time)">02:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">But yes, an imperfect solution.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Wed Jul 24 2024 20:01:21 GMT-0700 (Pacific Daylight Time)">03:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I‚Äôve been polling framework authors. Everyone is excited about AsyncContext, they all think it will work well for them for one or two variables like Justin said, and no one thinks it would be especially important to build stuff like React Context on top of</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Wed Jul 24 2024 20:01:57 GMT-0700 (Pacific Daylight Time)">03:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">So I think we can forget about my point about needing saving and restoring contexts from JS to avoid an allocation</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Wed Jul 24 2024 20:10:02 GMT-0700 (Pacific Daylight Time)">03:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">We literally just landed that exact capability for CPED in V8 because AsyncLocalStorage in Node.js, Deno, and Cloudflare all <em>need</em> it. üòÖ</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Wed Jul 24 2024 20:48:51 GMT-0700 (Pacific Daylight Time)">03:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We literally just landed that exact capability for CPED in V8 because AsyncLocalStorage in Node.js, Deno, and Cloudflare all <em>need</em> it. üòÖ</blockquote></mx-reply>Which capability?</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Wed Jul 24 2024 20:49:26 GMT-0700 (Pacific Daylight Time)">03:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Saving and restoring context from JS.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Wed Jul 24 2024 20:50:49 GMT-0700 (Pacific Daylight Time)">03:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">We just landed some code to generate turbofan code for setting and getting the context slot from pure generated code so we don‚Äôt have to go to native/builtins.</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Wed Jul 24 2024 21:07:50 GMT-0700 (Pacific Daylight Time)">04:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">So how are you setting the cped?</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Wed Jul 24 2024 21:14:21 GMT-0700 (Pacific Daylight Time)">04:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">See: <a href="https://github.com/v8/v8/commit/7857eb34db42f339b337c6bdfb0d10deb14862f3">https://github.com/v8/v8/commit/7857eb34db42f339b337c6bdfb0d10deb14862f3</a></td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Wed Jul 24 2024 21:17:57 GMT-0700 (Pacific Daylight Time)">04:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Basically we‚Äôre generating code to be able to interact with the context slot on the isolate from optimizable JS code.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Wed Jul 24 2024 21:21:17 GMT-0700 (Pacific Daylight Time)">04:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Node.js very frequently needs to set and get the stored value from both native and JS side. We have lots of native handles for async code that needs to capture when they are constructed and restore when their callback runs. We also have lots of JS-side things like the timer queue which needs to be able to do the same captures and restores from JS efficiently.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Wed Jul 24 2024 21:46:03 GMT-0700 (Pacific Daylight Time)">04:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-2" title="@stephenhicks:matrix.org">Steve Hicks</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I don‚Äôt understand why running it in the top level snapshot wouldn‚Äôt also amount to Zalgo to the same extent as falling back to the registration context is</blockquote></mx-reply>It's not zalgo because it's statically determinable from the registration site. If you register a lifecycle hook in a particular context you know for certain that it will <em>not</em> hold onto a reference of that context - that's valuable. The alternative is that it holds onto a reference in case the lifecycle event is caused externally - that's the unpredictability/inconsistency I'm worried about.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Wed Jul 24 2024 22:02:50 GMT-0700 (Pacific Daylight Time)">05:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Node.js very frequently needs to set and get the stored value from both native and JS side. We have lots of native handles for async code that needs to capture when they are constructed and restore when their callback runs. We also have lots of JS-side things like the timer queue which needs to be able to do the same captures and restores from JS efficiently.</blockquote></mx-reply>I think this is separate? This reads to me as optimizing the JS &lt;-&gt; C++ interface. If you were to have this optimized interface and then wrap the return value in a pure JS object, would that cause a large performance regression? That‚Äôs essentially what Dan suggested.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Wed Jul 24 2024 22:05:27 GMT-0700 (Pacific Daylight Time)">05:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">In the last meeting Dan suggested changing the <code>new Snapshot()</code> API (that returns a new object wrapping the internal context mapping) with a <code>getSnapshot()</code> immutable API that always returns the same object.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jul 24 2024 22:05:51 GMT-0700 (Pacific Daylight Time)">05:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Purely as a performance optimization for frameworks that need to take lots of snapshots.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jul 24 2024 22:21:29 GMT-0700 (Pacific Daylight Time)">05:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">For workers, like node.js we have lots of things that are implemented entirely in c++ that need to be able to grab and preserve and manually propagate the current context across non-javascript async boundaries. For instance, any time we perform native I/o we have to grab a reference to the current snapshot and manually restore that when we are entering back into JS to continue. We build on v8's cped API for this. It's not an optimization as there are some things we use this for that only exist at the c++ layer... That is, we effectively have a c++ API equivalent to AsyncLocalStorage for things like metrics, etc</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jul 24 2024 22:33:03 GMT-0700 (Pacific Daylight Time)">05:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Yes, the C++ side is certainly a requirement. I was more referring to the JS equivalent interfaces though which don‚Äôt call into native code and so don‚Äôt incur the native barrier cost. We <em>can</em> just expose the C++ API to JS, but it‚Äôs <em>much</em> slower.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jul 24 2024 22:34:12 GMT-0700 (Pacific Daylight Time)">05:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Thus the effort to expose generated code versions of setting and getting the context slot. My benchmarks show it being up to 120x faster than the native interface.</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jul 24 2024 22:34:26 GMT-0700 (Pacific Daylight Time)">05:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yep, we absolutely need both with as little cost as possible.</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jul 24 2024 22:34:38 GMT-0700 (Pacific Daylight Time)">05:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Which makes the difference between ALS being viable and <em>not</em> viable in many companies.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jul 24 2024 22:36:48 GMT-0700 (Pacific Daylight Time)">05:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">The new API absolutely won't be viable for us in workers unless we have both. There's no doubt about it </td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jul 24 2024 22:39:36 GMT-0700 (Pacific Daylight Time)">05:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Yep, same for many of our Node.js customers. The overhead of ALS is way too expensive, and the <em>majority</em> of the cost is just in how frequently that set and get are called‚Äîespecially the get. That‚Äôs just about the hottest code in all of Node.js. üòÖ</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jul 24 2024 22:40:59 GMT-0700 (Pacific Daylight Time)">05:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">My rewrite should make it more viable for a lot of customers, but even still, it‚Äôs hard to convince some customers when they see single digit overhead numbers in other languages and then like 30%+ sometimes in Node.js. üòê</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jul 24 2024 22:44:36 GMT-0700 (Pacific Daylight Time)">05:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@stephenbelanger:matrix.org">Stephen Belanger</span>&gt;</div></td><td class="msg-cell">Anyway, point is: it needs to be <em>fast</em> or it doesn‚Äôt help us. Server JS environments are doing <em>way</em> more frequent async activity than any browser environment ever would, so performance will impact us significantly.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Thu Jul 25 2024 02:17:24 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-7" title="@legendecas:matrix.org">Chengzhong Wu</span>&gt;</div></td><td class="msg-cell">Host APIs on manipulating the snapshot can definitely be optimized without strict 1:1 map to the public JS APIs. CPED extras binding is this kind of optimization that is not restricted by the ecma262</td></tr>

</tbody></table></div></div></div>
</body></html>