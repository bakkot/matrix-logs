<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2022-11-19</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2022-11-19<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-11-18" class="nav-link"><span>prev</span></a>
<a href="2022-11-20" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Nov 18 2022 16:00:49 GMT-0800 (Pacific Standard Time)">00:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Sensitive or not. I may just want the code I'm executing to start fresh, such as ignoring a memoization cache stored in an async context to produce a fresh result.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Nov 18 2022 16:01:19 GMT-0800 (Pacific Standard Time)">00:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">You may not even have access to the async context you need to reset, because its defined in code you don't control. </td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Nov 18 2022 16:02:52 GMT-0800 (Pacific Standard Time)">00:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">And you don't want to give users the ability to enumerate all async contexts, or change them to arbitrary values. However, most of that code will already have to defensively check whether the context value is <code>undefined</code>, so resetting to a base state isn't a terrible inconvenience.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Nov 18 2022 16:03:03 GMT-0800 (Pacific Standard Time)">00:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">So we're talking about the scenario where, if you're in the middle you might not have the asynccontext, but the inner code can access the asynccontext of the outer code, right?</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Nov 18 2022 16:03:15 GMT-0800 (Pacific Standard Time)">00:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> And you don't want to give users the ability to enumerate all async contexts, or change them to arbitrary values. However, most of that code will already have to defensively check whether the context value is <code>undefined</code>, so resetting to a base state isn't a terrible inconvenience.</blockquote></mx-reply>Yes, I think we all agree that we don't want to expose that capability</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Nov 18 2022 16:03:16 GMT-0800 (Pacific Standard Time)">00:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Yes, exactly.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Nov 18 2022 16:05:43 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> So we're talking about the scenario where, if you're in the middle you might not have the asynccontext, but the inner code can access the asynccontext of the outer code, right?</blockquote></mx-reply>This was the same concern I had about Yehuda's request for some kind of implicit propagation of cancellation tokens several years back.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Nov 18 2022 16:05:48 GMT-0800 (Pacific Standard Time)">00:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">OK, so you provided an API above with <code>ExecutionContext</code> to achieve this, but if we were to not care about TCP and such, I take it that this could be something like a static method <code>AsyncContext.fresh(cb)</code></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Nov 18 2022 16:06:15 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> This was the same concern I had about Yehuda's request for some kind of implicit propagation of cancellation tokens several years back.</blockquote></mx-reply>I have definitely been thinking about how this would apply to cancel tokens and finally fulfill the prophesy!</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Nov 18 2022 16:06:23 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Essentially, yes. I think the TCP issues are still worth discussing in terms of ergonomics for refactoring.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Nov 18 2022 16:06:39 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah I'm not dismissing them just checking my understanding</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Nov 18 2022 16:06:56 GMT-0800 (Pacific Standard Time)">00:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I have definitely been thinking about how this would apply to cancel tokens and finally fulfill the prophesy!</blockquote></mx-reply>I hope not. This is the opposite of what cancellation tokens should be. Implicit propagation is bad, explicit handoff is good.</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Nov 18 2022 16:07:59 GMT-0800 (Pacific Standard Time)">00:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">what is the concern you had in this context?</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Nov 18 2022 16:08:19 GMT-0800 (Pacific Standard Time)">00:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">Or at least, if you want implicit propagation you have to roll it yourself with your own `AsyncContext.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Nov 18 2022 16:10:53 GMT-0800 (Pacific Standard Time)">00:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">The "I'm in the middle" concern. Lets say the <code>fetch</code> API had some kind of implicit cancellation. You are a library author whose library has an async function that <em>must</em> execute a <code>fetch</code> to completion (barring network I/O or power interruption issues). If your function is called by an application that just so happens to set this implicit cancellation token for <code>fetch</code>, you have no way to preserve your <em>must execute</em> requirement.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Nov 18 2022 16:11:26 GMT-0800 (Pacific Standard Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">This is why cancellation tokens are passed as an argument. If you are sitting in the middle, you can chose whether to forward that argument on to an API based on your function's needs.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Fri Nov 18 2022 16:11:59 GMT-0800 (Pacific Standard Time)">00:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If that token is in an <code>AsyncContext</code> you don't control, you have no way to preserve your invariant.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Fri Nov 18 2022 16:12:35 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">right, makes sense</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Fri Nov 18 2022 16:12:53 GMT-0800 (Pacific Standard Time)">00:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">If you're only recourse is a blunt object (i.e., <code>AsyncContext.fresh</code>), you might lose other important context information that the things <em>you</em> are calling still need.</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Fri Nov 18 2022 16:14:58 GMT-0800 (Pacific Standard Time)">00:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">So its better just to advise against it. A developer can still do it if they want to, but don't make it any easier than it has to be.</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Fri Nov 18 2022 16:20:27 GMT-0800 (Pacific Standard Time)">00:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Are we sure we want to allow resetting all contexts, even the ones you don’t have direct access to?</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Fri Nov 18 2022 16:23:04 GMT-0800 (Pacific Standard Time)">00:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I guess I'm convinced that people should be cautious about when/how to use AsyncContext, but this broader question is unclear to me</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Fri Nov 18 2022 16:42:13 GMT-0800 (Pacific Standard Time)">00:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">for both the vscode and server case, I kinda feel like those systems won't really run into the "in the middle" case, and like they should probably use 1-2 AsyncContexts in the first place</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Fri Nov 18 2022 16:43:55 GMT-0800 (Pacific Standard Time)">00:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Within a single piece of code, you should only really use multiple AsyncContexts if they are going to differ in extent/nesting from other things, right? You would use a compound data structure within that. (It looks like this is how HTTPContext works, right?) So when you have any kind of restricted-privilege plugin system, you only have a certain set of things to censor</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Fri Nov 18 2022 16:44:24 GMT-0800 (Pacific Standard Time)">00:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the "in the middle" concern seems like a good reason to not do implicit propagation of cancel tokens, but I don't see how it relates to this case of clearing all contexts</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Fri Nov 18 2022 16:46:55 GMT-0800 (Pacific Standard Time)">00:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> If your only recourse is a blunt object (i.e., <code>AsyncContext.fresh</code>), you might lose other important context information that the things <em>you</em> are calling still need.</blockquote></mx-reply>Sorry where you suggesting a more subtle instrument? I guess I missed that, though I guess the ExecutionContext API put the way to create and set a fresh one less "in your face", which could reduce the risk of accidental usage.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Fri Nov 18 2022 16:50:49 GMT-0800 (Pacific Standard Time)">00:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">anyway thanks so much for explaining all of this, <span class="nick-15">rbuckton</span> . We don't need to come to a conclusion today, and I'm just happy that I can understand your points on this now.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Fri Nov 18 2022 16:51:54 GMT-0800 (Pacific Standard Time)">00:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Overall I'd categorize these things as, even post-Stage 2 things, to resolve before Stage 3. There aren't really any fundamental disagreements about the core semantics of this API, I think.</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Fri Nov 18 2022 17:17:39 GMT-0800 (Pacific Standard Time)">01:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> for both the vscode and server case, I kinda feel like those systems won't really run into the "in the middle" case, and like they should probably use 1-2 AsyncContexts in the first place</blockquote></mx-reply>In one of my own projects I have at least 3 AsyncLocalStorage instances, and its a small app. Because <code>AsyncContext</code> represents a single value, as opposed to a larger mutable store like .NET's <code>ExecutionContext</code>, I would expect you will see far more of them than 1-2 in many applications.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Fri Nov 18 2022 17:18:21 GMT-0800 (Pacific Standard Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Are we sure we want to allow resetting all contexts, even the ones you don’t have direct access to?</blockquote></mx-reply>That's already feasible in the proposed design, just not convenient.</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Fri Nov 18 2022 17:19:02 GMT-0800 (Pacific Standard Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Sorry where you suggesting a more subtle instrument? I guess I missed that, though I guess the ExecutionContext API put the way to create and set a fresh one less "in your face", which could reduce the risk of accidental usage.</blockquote></mx-reply>I'm speaking specifically as to why transparent propagation of cancellation tokens are bad, not the async context API in general.</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Fri Nov 18 2022 17:20:31 GMT-0800 (Pacific Standard Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@kriskowal:matrix.org">Kris Kowal</span>&gt;</div></td><td class="msg-cell">That’s funny because propagating cancellation tokens is almost certainly the first and most obvious thing this will be used for.</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Fri Nov 18 2022 17:29:55 GMT-0800 (Pacific Standard Time)">01:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@rbuckton:matrix.org">rbuckton</span>&gt;</div></td><td class="msg-cell">I expect the most obvious thing it will be used for is passing along request state in a server. That's what I'm using <code>AsyncLocalStorage</code> for (though in that case, its a Discord bot).</td></tr>

</tbody></table></div></div></div>
</body></html>