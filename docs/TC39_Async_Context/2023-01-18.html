<!DOCTYPE html><html><head>
  <title>TC39 Async Context on 2023-01-18</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "TC39 Async Context";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">TC39 Async Context<br>2023-01-18<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2023-01-17" class="nav-link"><span>prev</span></a>
<a href="2023-01-19" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search TC39 Async Context">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Jan 17 2023 17:05:29 GMT-0800 (Pacific Standard Time)">01:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I'm surprised you need to do so much work to integrate it</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Jan 17 2023 17:06:06 GMT-0800 (Pacific Standard Time)">01:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The spec has a hook designed for this usecase, and it seems to exist in V8: <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4</a></td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Jan 17 2023 17:07:27 GMT-0800 (Pacific Standard Time)">01:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I spotted that previously but couldn't find any detail whatsoever on what/how it's used</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Jan 17 2023 17:09:13 GMT-0800 (Pacific Standard Time)">01:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">specifically, on the promise hook callback, for the init event, we create an opaque JS object that wraps the reference to the current async context frame. We then set that as a private field on the Promise object. What's not clear in any way (I couldn't find any documentation or examples) if Set/GetContinuationPreservedEmbedderData could be used for that</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Jan 17 2023 17:10:08 GMT-0800 (Pacific Standard Time)">01:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">specifically, it's not clear <em>when</em> we would call <code>SetContinuationPreservedEmbedderData</code> and what effect that would have</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Jan 17 2023 17:14:47 GMT-0800 (Pacific Standard Time)">01:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If I'm reading this right, I would call it in <code>Set…</code> inside <code><a href="http://AsyncContext.run">AsyncContext.run</a>()</code>, and call <code>Get…</code> inside <code>AsyncContext.get()</code></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Jan 17 2023 17:15:19 GMT-0800 (Pacific Standard Time)">01:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><ul>
<li><a href="https://source.chromium.org/search?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc">https://source.chromium.org/search?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc</a></li>
<li>Preserved on jobs: <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=75-90;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=75-90;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552</a></li>
<li>Restored on run: <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-245?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-245?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Jan 17 2023 17:16:14 GMT-0800 (Pacific Standard Time)">01:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Looks like Yoav might be using it in the new Chrome TaskAttribution work: <a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/task_attribution_tracker_impl.cc;l=233-289;drc=71630a0e336a703e21de9ebeb98a5abf84e8c96c">https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/task_attribution_tracker_impl.cc;l=233-289;drc=71630a0e336a703e21de9ebeb98a5abf84e8c96c</a></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Jan 17 2023 17:18:24 GMT-0800 (Pacific Standard Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Still not super clear but it's worth exploring to see if it does make it easier</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Jan 17 2023 17:19:06 GMT-0800 (Pacific Standard Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">one key issue is that we need the context tracking to also work with things like timers</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Jan 17 2023 17:19:46 GMT-0800 (Pacific Standard Time)">01:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">What other times do you provide?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Jan 17 2023 17:20:03 GMT-0800 (Pacific Standard Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">so long as we can preserve the context with non-v8 things and it all just works, then hopefully this could make things easier. I'll play with it</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Jan 17 2023 17:20:40 GMT-0800 (Pacific Standard Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Just setTimeout and setInterval but v8's only involvement there is that we call the function when the timer expires</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Jan 17 2023 17:20:49 GMT-0800 (Pacific Standard Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think if you port <a href="https://docs.google.com/presentation/d/1yw4d0ca6v2Z2Vmrnac9E9XJFlC872LDQ4GFR17QdRzk/edit#slide=id.g18e6eaa50e1_0_192">https://docs.google.com/presentation/d/1yw4d0ca6v2Z2Vmrnac9E9XJFlC872LDQ4GFR17QdRzk/edit#slide=id.g18e6eaa50e1_0_192</a> into C++, and everywhere you access <code>__storage__</code> you call <code>Get…</code>, and everywhere you set you call <code>Set…</code>, then it'd work correctly</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Jan 17 2023 17:20:59 GMT-0800 (Pacific Standard Time)">01:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">we capture a reference to the current frame and enter it when we invoke the callback</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Jan 17 2023 17:22:23 GMT-0800 (Pacific Standard Time)">01:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">ok, I'll play with this a bit. If we can eliminate the promise hook I'll be really quite happy</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Jan 17 2023 17:25:32 GMT-0800 (Pacific Standard Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It doesn't look like anything else uses the embedder continuation data, so I'm not sure if <code>setTimeout</code> would propagate correctly.</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Jan 17 2023 17:25:42 GMT-0800 (Pacific Standard Time)">01:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">It might be easy to do manually, though</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Wed Jan 18 2023 05:52:39 GMT-0800 (Pacific Standard Time)">13:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> The spec has a hook designed for this usecase, and it seems to exist in V8: <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4</a></blockquote></mx-reply>Oh wow I didn’t know about this API</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Wed Jan 18 2023 05:57:20 GMT-0800 (Pacific Standard Time)">13:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Would be cool to see if someone can build AsyncContext as a Node native module just based on that, or if there are limitations</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Wed Jan 18 2023 12:30:54 GMT-0800 (Pacific Standard Time)">20:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><code><a href="http://SCOPING.md">SCOPING.md</a></code> has the following:</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Wed Jan 18 2023 12:31:02 GMT-0800 (Pacific Standard Time)">20:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>Only code with direct access to <code>AsyncContext</code> instances can modify the value, and only for code execution nested inside a new <code><a href="http://context.run">context.run</a>()</code>.</p>
</blockquote>
</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Wed Jan 18 2023 12:32:46 GMT-0800 (Pacific Standard Time)">20:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">Doesn't <code>AsyncContext.wrap</code> allow any code to modify the value of all <code>AsyncContext</code> instances in the callback's context?</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Wed Jan 18 2023 12:33:41 GMT-0800 (Pacific Standard Time)">20:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yes and no</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Wed Jan 18 2023 12:34:15 GMT-0800 (Pacific Standard Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The <code>AsyncContext</code> instance can't contain a value unless that value is placed there by someone with access to the instance</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Wed Jan 18 2023 12:34:47 GMT-0800 (Pacific Standard Time)">20:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><code>undefined</code> (the default state of an <code>AsyncContext</code>) is just a "value placed there by someone with access"</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Wed Jan 18 2023 12:35:24 GMT-0800 (Pacific Standard Time)">20:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">So restoring the state to a prior one just places a value into the <code>AsyncContext</code> that was already placed there by someone with access</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Wed Jan 18 2023 12:36:04 GMT-0800 (Pacific Standard Time)">20:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Mark Miller's equates this more to a closed over variable</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Wed Jan 18 2023 12:37:14 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If I have a opaque <code>Map</code> (that I can't directly acccess, but which can be access by <code>AsyncContext</code> instances) which holds the data, then all I've done is propagate my closed-over map for you to read from.</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Wed Jan 18 2023 12:37:59 GMT-0800 (Pacific Standard Time)">20:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><ul>
<li><a href="https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style-transform.md">https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style-transform.md</a></li>
<li><a href="https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style.js">https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style.js</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Wed Jan 18 2023 12:40:36 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I guess to connect these things, the modification is well-behaved</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Wed Jan 18 2023 12:40:49 GMT-0800 (Pacific Standard Time)">20:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yes, you definitely can restore things via <code>wrap</code>, that's the whole point, that is a well-behaved modification</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Wed Jan 18 2023 12:41:03 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">so maybe this could be clarified in the wording of <a href="http://SCOPING.md">SCOPING.md</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Wed Jan 18 2023 12:41:50 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">yeah, in that sense <code>wrap</code> doesn't introduce any dynamic scoping, so it's just a matter of wording that</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Wed Jan 18 2023 12:41:56 GMT-0800 (Pacific Standard Time)">20:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Just a quick update here. I've implemented use of this api to store context for workers (<a href="https://github.com/cloudflare/workerd/pull/282">https://github.com/cloudflare/workerd/pull/282</a>).... it works well for promises in general but does have a limitation.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Wed Jan 18 2023 12:42:25 GMT-0800 (Pacific Standard Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Wed Jan 18 2023 12:42:50 GMT-0800 (Pacific Standard Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">I'm not familiar with programming language theory, and there's a lot of stuff I'm missing here</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Wed Jan 18 2023 12:42:57 GMT-0800 (Pacific Standard Time)">20:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I end up having to still associate the current context frame with the promise in the promise hook and entering the frame manually when emitting those events</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Wed Jan 18 2023 12:43:32 GMT-0800 (Pacific Standard Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers</blockquote></mx-reply>yep, that doesn't surprise me... this is what you need the init hook for, right?</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Wed Jan 18 2023 12:43:51 GMT-0800 (Pacific Standard Time)">20:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but it's great to hear if everything but the init hook works!!!</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Wed Jan 18 2023 12:44:09 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Second, I am capturing the async context when <code>queueMicrotask()</code> is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Wed Jan 18 2023 12:44:36 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I'm not familiar with programming language theory, and there's a lot of stuff I'm missing here</blockquote></mx-reply>Andreu, I recommend you make PRs to <a href="http://SCOPING.md">SCOPING.md</a> to make things clearer for you, and we can iterate on it in code review. You shouldn't have to be an expert in PL theory to read our docs.</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Wed Jan 18 2023 12:44:39 GMT-0800 (Pacific Standard Time)">20:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">but otherwise, the v8 api is quite helpful. Thank you for pointing it out <span class="nick-1">Justin Ridgewell</span></td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Wed Jan 18 2023 12:45:03 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Second, I am capturing the async context when <code>queueMicrotask()</code> is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks</blockquote></mx-reply>Sorry, could you explain this a little more?</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Wed Jan 18 2023 12:45:09 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">well, that was a bit more about <span class="nick-1">Justin Ridgewell</span>'s response</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Wed Jan 18 2023 12:45:46 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><pre><code>als.run(123, () =&gt; queueMicrotask(() =&gt; console.log(als.getStore())));
</code></pre>
</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Wed Jan 18 2023 12:45:53 GMT-0800 (Pacific Standard Time)">20:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the thing is, Mark Miller's school of PL theory is really not widely understood... it is just his small community</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Wed Jan 18 2023 12:46:26 GMT-0800 (Pacific Standard Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I've implemented it such that when the scheduled microtask is run, <code>als.getStore()</code> returns the appropriate value</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Wed Jan 18 2023 12:46:32 GMT-0800 (Pacific Standard Time)">20:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <pre><code>als.run(123, () =&gt; queueMicrotask(() =&gt; console.log(als.getStore())));
</code></pre>
</blockquote></mx-reply>huh, I thought that would be the whole point of V8's API, to propagate over exactly that pattern... if it doesn't handle this, what does it do?</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Wed Jan 18 2023 12:47:32 GMT-0800 (Pacific Standard Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I don't know. I could be doing something wrong here but in local testing it wasn't picking up the value</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Wed Jan 18 2023 12:47:41 GMT-0800 (Pacific Standard Time)">20:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I can play with it more</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Wed Jan 18 2023 12:48:40 GMT-0800 (Pacific Standard Time)">20:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">did you get it to work at all, in any case? for example, maybe it works for promises but not calls to queueMicrotask?</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Wed Jan 18 2023 12:49:26 GMT-0800 (Pacific Standard Time)">20:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> the thing is, Mark Miller's school of PL theory is really not widely understood... it is just his small community</blockquote></mx-reply>Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Wed Jan 18 2023 12:50:08 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬</blockquote></mx-reply>reference like link to, or put everything in his terms?</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Wed Jan 18 2023 12:50:24 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">They may not be integrating with the job queue correctly</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Wed Jan 18 2023 12:50:45 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The intention of the hooks is for that to work without modifications, but they're only calling it for promises currently</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Wed Jan 18 2023 12:50:59 GMT-0800 (Pacific Standard Time)">20:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I'm not sure how Web APIs implement their calls</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Wed Jan 18 2023 12:51:11 GMT-0800 (Pacific Standard Time)">20:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Redo the explanation in his terms</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Wed Jan 18 2023 12:53:30 GMT-0800 (Pacific Standard Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">yeah, definitely doesn't appear to be working</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Wed Jan 18 2023 12:53:38 GMT-0800 (Pacific Standard Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Redo the explanation in his terms</blockquote></mx-reply>Ah, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Wed Jan 18 2023 12:53:49 GMT-0800 (Pacific Standard Time)">20:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers</blockquote></mx-reply><p>Looks like that's actually possible with <code>SetPromiseRejectCallback</code>:</p>
<ul>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678</a></li>
<li>called by <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc</a></li>
</ul>
</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Wed Jan 18 2023 12:54:27 GMT-0800 (Pacific Standard Time)">20:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>Looks like that's actually possible with <code>SetPromiseRejectCallback</code>:</p>
<ul>
<li><a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678</a></li>
<li>called by <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc">https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc</a></li>
</ul>
</blockquote></mx-reply>Justin, that's one side (where you read the relevant asynccontext) but there's the other side separately (in the promise init hook, when you have to stash exactly that information)</td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Wed Jan 18 2023 12:55:35 GMT-0800 (Pacific Standard Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> yeah, definitely doesn't appear to be working</blockquote></mx-reply>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Wed Jan 18 2023 12:55:57 GMT-0800 (Pacific Standard Time)">20:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">so this is why I'm wondering if, in your testing, the save and restore at least happened for promises (it'd be really surprisng to me if it didn't work)</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Wed Jan 18 2023 12:56:48 GMT-0800 (Pacific Standard Time)">20:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Will the promise reject callback be invoked while the appropriate stored continuation value is current?</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Wed Jan 18 2023 12:57:06 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">if so, I can absolutely capture it then</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Wed Jan 18 2023 12:57:40 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">littledan</span>: You're sometimes replying to a thread on the main channel. Are you using an outdated Matrix client?</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Wed Jan 18 2023 12:57:54 GMT-0800 (Pacific Standard Time)">20:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I'm using <a href="http://app.element.io">app.element.io</a>... I don't see threads</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Wed Jan 18 2023 12:58:13 GMT-0800 (Pacific Standard Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">how do I enable them?</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Wed Jan 18 2023 12:58:50 GMT-0800 (Pacific Standard Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">oh, they're not actually enabled by default in recent Element versions, I just had manually enabled them</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Wed Jan 18 2023 12:58:58 GMT-0800 (Pacific Standard Time)">20:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-4" title="@abotella:igalia.com">Andreu Botella</span>&gt;</div></td><td class="msg-cell">All Settings / Labs</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Wed Jan 18 2023 12:59:23 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Yes, it should be</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Wed Jan 18 2023 12:59:28 GMT-0800 (Pacific Standard Time)">20:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">oh! yes, quick test appears that it does work! woo!</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Wed Jan 18 2023 13:00:20 GMT-0800 (Pacific Standard Time)">21:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Ah, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms</blockquote></mx-reply>That's exactly what I said. Lol.</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Wed Jan 18 2023 13:01:13 GMT-0800 (Pacific Standard Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Oh hi now I can see the thread</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Wed Jan 18 2023 13:01:33 GMT-0800 (Pacific Standard Time)">21:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks</p>
</blockquote>
<p><span class="nick-1">Justin Ridgewell</span> in v8 or somewhere else?</p>
</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Wed Jan 18 2023 13:02:01 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">if in v8, it might be in a newer version than we're using maybe?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Wed Jan 18 2023 13:02:17 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Hm?</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Wed Jan 18 2023 13:02:22 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <blockquote>
<p>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks</p>
</blockquote>
<p><span class="nick-1">Justin Ridgewell</span> in v8 or somewhere else?</p>
</blockquote></mx-reply>This is in Chrome, not V8</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Wed Jan 18 2023 13:02:32 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">so you won't just pick it up</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Wed Jan 18 2023 13:02:37 GMT-0800 (Pacific Standard Time)">21:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">ok yeah</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Wed Jan 18 2023 13:03:09 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Will the promise reject callback be invoked while the appropriate stored continuation value is current?</blockquote></mx-reply>I don't expect this to work at all... I think we'd have to add something specifically to promises code to store exactly this thing</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Wed Jan 18 2023 13:03:33 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Well, it does appear to be working in local testing</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Wed Jan 18 2023 13:03:35 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">this is why it's important that we document that unhandled rejection asynccontext is important!</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Wed Jan 18 2023 13:03:40 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">huh really? how so?</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Wed Jan 18 2023 13:03:47 GMT-0800 (Pacific Standard Time)">21:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Could you share your tests?</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Wed Jan 18 2023 13:04:38 GMT-0800 (Pacific Standard Time)">21:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><pre><code>          jsg::AsyncContextFrame::Scope scope(js, jsg::AsyncContextFrame::current(js));
          auto ev = jsg::alloc&lt;PromiseRejectionEvent&gt;(event, kj::mv(promise), kj::mv(value));
          dispatchEventImpl(js, kj::mv(ev));
</code></pre>
<p>It's a bit obscure here but...</p>
<p><code>jsg::AsyncContextFrame::current()</code> is a wrapper around code that grabs the current stored continuation data from v8::Context</p>
</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Wed Jan 18 2023 13:06:14 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>In JavaScript...</p>
<pre><code>const { AsyncLocalStorage } = async_hooks;

const als = new AsyncLocalStorage();

addEventListener('unhandledrejection', (event) =&gt; {
  // Here we are making sure that the async context properly travels along with
  // unhandled rejections.
  if (event.reason === 'boom' &amp;&amp; als.getStore() !== 123) {
    throw new Error("Incorrect async store value");
  }
  if (event.reason === 'boom2' &amp;&amp; als.getStore() !== 'ABC') {
    throw new Error("Incorrect async store value");
  }
});

addEventListener('rejectionhandled', (event) =&gt; {
  if (als.getStore() !== 'ABC') {
    throw new Error("Incorrect async store value");
  }
});

export default {
  async fetch(request) {
    // The async context is captured when on(...) is called to register
    // handlers.
    als.run(123, () =&gt; {
      Promise.reject("boom");
    });

    const p = als.run('ABC', () =&gt; {
      return Promise.reject("boom2");
    });

    await scheduler.wait(1);

    p.catch(() =&gt; {});

    return new Response("ok");
  }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Wed Jan 18 2023 13:06:50 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Try one that adopts the state of a rejected promise</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Wed Jan 18 2023 13:06:56 GMT-0800 (Pacific Standard Time)">21:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">That'll be the tricky case</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Wed Jan 18 2023 13:07:20 GMT-0800 (Pacific Standard Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><code>Promise.reject</code> is a sync rejection signal, so it's very easy to capture the current run state</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Wed Jan 18 2023 13:07:21 GMT-0800 (Pacific Standard Time)">21:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">oh.. no, yeah, shoot</td></tr>
  <tr class="msg" id="L92"><td class="ts-cell"><a class="ts" href="#L92" alt="Wed Jan 18 2023 13:08:04 GMT-0800 (Pacific Standard Time)">21:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">spoke too soon. That case was failing</td></tr>
  <tr class="msg" id="L93"><td class="ts-cell"><a class="ts" href="#L93" alt="Wed Jan 18 2023 13:10:07 GMT-0800 (Pacific Standard Time)">21:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">boo ok</td></tr>
  <tr class="msg" id="L94"><td class="ts-cell"><a class="ts" href="#L94" alt="Wed Jan 18 2023 13:16:50 GMT-0800 (Pacific Standard Time)">21:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Curious of your test case</td></tr>
  <tr class="msg" id="L95"><td class="ts-cell"><a class="ts" href="#L95" alt="Wed Jan 18 2023 13:17:00 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The spec flows work, maybe it's just a V8 impl bug</td></tr>
  <tr class="msg" id="L96"><td class="ts-cell"><a class="ts" href="#L96" alt="Wed Jan 18 2023 13:17:38 GMT-0800 (Pacific Standard Time)">21:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">The reject is either called sync (in which case, the context is still there), or it's queued in a job callback, in which case it would have been restored before calling reject</td></tr>
  <tr class="msg" id="L97"><td class="ts-cell"><a class="ts" href="#L97" alt="Wed Jan 18 2023 13:18:07 GMT-0800 (Pacific Standard Time)">21:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I'll see if I can dig in a bit deeper soon</td></tr>
  <tr class="msg" id="L98"><td class="ts-cell"><a class="ts" href="#L98" alt="Wed Jan 18 2023 13:20:19 GMT-0800 (Pacific Standard Time)">21:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><pre><code class="language-js">new Promise((_, rej) =&gt; rej(1));
new Promise(res =&gt; res(Promise.reject(1)));
// technically equivalent to the previous one
Promise.resolve().then(() =&gt; Promise.reject(1));
</code></pre>
</td></tr>
  <tr class="msg" id="L99"><td class="ts-cell"><a class="ts" href="#L99" alt="Wed Jan 18 2023 14:20:19 GMT-0800 (Pacific Standard Time)">22:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">FYI I asked about this API in the #jsc room of WebKit Slack, and Jared Sumner responded explaining that he's implementing AsyncLocalStorage in Bun. Hopefully he takes my offer to come and hang out over here :)</td></tr>
  <tr class="msg" id="L100"><td class="ts-cell"><a class="ts" href="#L100" alt="Wed Jan 18 2023 14:23:21 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">fun fact: Promise.reject is in fact the hard case, since you actually want to wait for the microtask queue to be exhausted before considering it truly an unhandled rejection</td></tr>
  <tr class="msg" id="L101"><td class="ts-cell"><a class="ts" href="#L101" alt="Wed Jan 18 2023 14:23:38 GMT-0800 (Pacific Standard Time)">22:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">the async case where the rejection happens after the responses have already been chained on--that's the easy case</td></tr>
  <tr class="msg" id="L102"><td class="ts-cell"><a class="ts" href="#L102" alt="Wed Jan 18 2023 14:24:16 GMT-0800 (Pacific Standard Time)">22:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(this was quite tricky for people inside of Bloomberg to rediscover, at least)</td></tr>
  <tr class="msg" id="L103"><td class="ts-cell"><a class="ts" href="#L103" alt="Wed Jan 18 2023 14:29:00 GMT-0800 (Pacific Standard Time)">22:29</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>For the following case, what would you expect the <code>als.getStore()</code> value to be printed..</p>
<pre><code>addEventListener('unhandledrejection', () =&gt;{
  console.log(als.getStore());
})

let reject;
const p2 = als.run(123, () =&gt; new Promise((a,b) =&gt; reject = b));
als.run(321, () =&gt; reject());
</code></pre>
</td></tr>
  <tr class="msg" id="L104"><td class="ts-cell"><a class="ts" href="#L104" alt="Wed Jan 18 2023 14:30:29 GMT-0800 (Pacific Standard Time)">22:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">Ahh, I hadn't considered that <code>reject()</code> would be called in a different context</td></tr>
  <tr class="msg" id="L105"><td class="ts-cell"><a class="ts" href="#L105" alt="Wed Jan 18 2023 14:32:46 GMT-0800 (Pacific Standard Time)">22:32</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I don't have an answer for this, it's not a usecase that we expose</td></tr>
  <tr class="msg" id="L106"><td class="ts-cell"><a class="ts" href="#L106" alt="Wed Jan 18 2023 14:33:06 GMT-0800 (Pacific Standard Time)">22:33</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">All user code is guaranteed to run inside the only context we care about</td></tr>
  <tr class="msg" id="L107"><td class="ts-cell"><a class="ts" href="#L107" alt="Wed Jan 18 2023 14:34:37 GMT-0800 (Pacific Standard Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">not sure I grok that... in Node.js, <code>als.getStore()</code> in the unhandledrejection handler prints <code>123</code></td></tr>
  <tr class="msg" id="L108"><td class="ts-cell"><a class="ts" href="#L108" alt="Wed Jan 18 2023 14:34:56 GMT-0800 (Pacific Standard Time)">22:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">because it grabs the async context reference on promise init and not promise reject</td></tr>
  <tr class="msg" id="L109"><td class="ts-cell"><a class="ts" href="#L109" alt="Wed Jan 18 2023 14:36:00 GMT-0800 (Pacific Standard Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think that's reasonable, but the other way actually allows more expressiveness</td></tr>
  <tr class="msg" id="L110"><td class="ts-cell"><a class="ts" href="#L110" alt="Wed Jan 18 2023 14:36:31 GMT-0800 (Pacific Standard Time)">22:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">If you wanted to preserve the context for the <code>reject()</code>, you would export <code>return wrap(reject)</code></td></tr>
  <tr class="msg" id="L111"><td class="ts-cell"><a class="ts" href="#L111" alt="Wed Jan 18 2023 14:37:05 GMT-0800 (Pacific Standard Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">yeah, I'm a bit torn because honestly I do think it should return <code>321</code> in this case</td></tr>
  <tr class="msg" id="L112"><td class="ts-cell"><a class="ts" href="#L112" alt="Wed Jan 18 2023 14:37:12 GMT-0800 (Pacific Standard Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I wonder if node had a use case to choose init-time</td></tr>
  <tr class="msg" id="L113"><td class="ts-cell"><a class="ts" href="#L113" alt="Wed Jan 18 2023 14:37:40 GMT-0800 (Pacific Standard Time)">22:37</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I'm not entirely convinced this case was considered</td></tr>
  <tr class="msg" id="L114"><td class="ts-cell"><a class="ts" href="#L114" alt="Wed Jan 18 2023 14:38:10 GMT-0800 (Pacific Standard Time)">22:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">I'm going to open an issue in Node.js to discuss</td></tr>
  <tr class="msg" id="L115"><td class="ts-cell"><a class="ts" href="#L115" alt="Wed Jan 18 2023 14:38:21 GMT-0800 (Pacific Standard Time)">22:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">👍️, please link</td></tr>
  <tr class="msg" id="L116"><td class="ts-cell"><a class="ts" href="#L116" alt="Wed Jan 18 2023 14:42:04 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>For the following case, what would you expect the <code>als.getStore()</code> value to be printed..</p>
<pre><code>addEventListener('unhandledrejection', () =&gt;{
  console.log(als.getStore());
})

let reject;
const p2 = als.run(123, () =&gt; new Promise((a,b) =&gt; reject = b));
als.run(321, () =&gt; reject());
</code></pre>
</blockquote></mx-reply>I would say, 123. I guess I'd predict that the V8 API that Justin linked to would log undefined.</td></tr>
  <tr class="msg" id="L117"><td class="ts-cell"><a class="ts" href="#L117" alt="Wed Jan 18 2023 14:42:24 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">This is actually important for Bloomberg's (admittedly weird) use case</td></tr>
  <tr class="msg" id="L118"><td class="ts-cell"><a class="ts" href="#L118" alt="Wed Jan 18 2023 14:42:38 GMT-0800 (Pacific Standard Time)">22:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/nodejs/node/issues/46262">https://github.com/nodejs/node/issues/46262</a></td></tr>
  <tr class="msg" id="L119"><td class="ts-cell"><a class="ts" href="#L119" alt="Wed Jan 18 2023 14:43:28 GMT-0800 (Pacific Standard Time)">22:43</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think it'd log <code>321</code>, no?</td></tr>
  <tr class="msg" id="L120"><td class="ts-cell"><a class="ts" href="#L120" alt="Wed Jan 18 2023 14:44:36 GMT-0800 (Pacific Standard Time)">22:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><code>reject</code> there is <a href="https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-reject-functions">https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-reject-functions</a>, which immediately invokes <a href="https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-rejectpromise">https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-rejectpromise</a>, which triggers the hook API</td></tr>
  <tr class="msg" id="L121"><td class="ts-cell"><a class="ts" href="#L121" alt="Wed Jan 18 2023 14:45:09 GMT-0800 (Pacific Standard Time)">22:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Yeah, it logs <code>321</code></td></tr>
  <tr class="msg" id="L122"><td class="ts-cell"><a class="ts" href="#L122" alt="Wed Jan 18 2023 14:46:34 GMT-0800 (Pacific Standard Time)">22:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">You would need to store the current context until the actual <code>unhandledrejection</code> event is fired, but you can do that as part of the hook</td></tr>
  <tr class="msg" id="L123"><td class="ts-cell"><a class="ts" href="#L123" alt="Wed Jan 18 2023 14:47:17 GMT-0800 (Pacific Standard Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><blockquote>
<p><a href="https://github.com/nodejs/node/issues/46262">https://github.com/nodejs/node/issues/46262</a></p>
</blockquote>
<p>Nit: "promise is resolved" should say "promise is settled"</p>
</td></tr>
  <tr class="msg" id="L124"><td class="ts-cell"><a class="ts" href="#L124" alt="Wed Jan 18 2023 14:47:58 GMT-0800 (Pacific Standard Time)">22:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">yeah, this is exactly the thing that I raised a week or two ago; I'm glad we're coming back to it since apparently we were talking past each other then</td></tr>
  <tr class="msg" id="L125"><td class="ts-cell"><a class="ts" href="#L125" alt="Wed Jan 18 2023 14:48:45 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I was arguing, we should include something about the kInit storage in the spec (even though it's not visible without the unhandled rejection tracking)</td></tr>
  <tr class="msg" id="L126"><td class="ts-cell"><a class="ts" href="#L126" alt="Wed Jan 18 2023 14:48:46 GMT-0800 (Pacific Standard Time)">22:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">My intuition is that what you really want is the context at the point either <code>resolve()</code> or <code>reject()</code> is called</td></tr>
  <tr class="msg" id="L127"><td class="ts-cell"><a class="ts" href="#L127" alt="Wed Jan 18 2023 14:49:02 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I remember. I think we should specify this as part of the proposal, I'm just interested in how we can implement this for workerd given what we already have</td></tr>
  <tr class="msg" id="L128"><td class="ts-cell"><a class="ts" href="#L128" alt="Wed Jan 18 2023 14:49:26 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">it's trivial for me to make it work either way now. </td></tr>
  <tr class="msg" id="L129"><td class="ts-cell"><a class="ts" href="#L129" alt="Wed Jan 18 2023 14:49:41 GMT-0800 (Pacific Standard Time)">22:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">currently I have the Promise hook in place to set the context on kInit</td></tr>
  <tr class="msg" id="L130"><td class="ts-cell"><a class="ts" href="#L130" alt="Wed Jan 18 2023 14:50:00 GMT-0800 (Pacific Standard Time)">22:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">but I have a pending set of changes that eliminates the promise hook and captures it on the rejection handler, which is working great</td></tr>
  <tr class="msg" id="L131"><td class="ts-cell"><a class="ts" href="#L131" alt="Wed Jan 18 2023 14:52:39 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I remember. I think we should specify this as part of the proposal, I'm just interested in how we can implement this for workerd given what we already have</blockquote></mx-reply>what do the spec sections that you cited have to do with workerd?</td></tr>
  <tr class="msg" id="L132"><td class="ts-cell"><a class="ts" href="#L132" alt="Wed Jan 18 2023 14:52:52 GMT-0800 (Pacific Standard Time)">22:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> but I have a pending set of changes that eliminates the promise hook and captures it on the rejection handler, which is working great</blockquote></mx-reply>wait, does this work to implement either set of semantics, or just the 321 one?</td></tr>
  <tr class="msg" id="L133"><td class="ts-cell"><a class="ts" href="#L133" alt="Wed Jan 18 2023 14:53:47 GMT-0800 (Pacific Standard Time)">22:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">it's either or, not both</td></tr>
  <tr class="msg" id="L134"><td class="ts-cell"><a class="ts" href="#L134" alt="Wed Jan 18 2023 14:54:02 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">my pending changes removes the promise hook</td></tr>
  <tr class="msg" id="L135"><td class="ts-cell"><a class="ts" href="#L135" alt="Wed Jan 18 2023 14:54:25 GMT-0800 (Pacific Standard Time)">22:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">workerd uses v8, and v8 exposes these hooks for implementers.</td></tr>
  <tr class="msg" id="L136"><td class="ts-cell"><a class="ts" href="#L136" alt="Wed Jan 18 2023 14:55:01 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">I think we should specify a behavior instead of allowing implementers to implement on their own</td></tr>
  <tr class="msg" id="L137"><td class="ts-cell"><a class="ts" href="#L137" alt="Wed Jan 18 2023 14:55:16 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">For this case, I think we have to</td></tr>
  <tr class="msg" id="L138"><td class="ts-cell"><a class="ts" href="#L138" alt="Wed Jan 18 2023 14:55:38 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">will this be a publicly visible PR?</td></tr>
  <tr class="msg" id="L139"><td class="ts-cell"><a class="ts" href="#L139" alt="Wed Jan 18 2023 14:55:45 GMT-0800 (Pacific Standard Time)">22:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">yes</td></tr>
  <tr class="msg" id="L140"><td class="ts-cell"><a class="ts" href="#L140" alt="Wed Jan 18 2023 14:56:14 GMT-0800 (Pacific Standard Time)">22:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/cloudflare/workerd/pull/282">https://github.com/cloudflare/workerd/pull/282</a></td></tr>
  <tr class="msg" id="L141"><td class="ts-cell"><a class="ts" href="#L141" alt="Wed Jan 18 2023 14:58:16 GMT-0800 (Pacific Standard Time)">22:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell"><p>Specifically, I think by default, we should capture the context on settle not kInit. So the answer by default should be <code>321</code>. If you want <code>123</code>, then use <code>wrap</code> around <code>reject</code> as suggested by Justin. Or, if we are using a mechanism like Node.js' <code>AsyncResource</code>, we can do something like:</p>
<pre><code>class Foo extends AsyncResource {
  constructor() {
    this.deferredPromise = createDeferredPromise();
  }

  resolve() { this.runInAsyncScope(() =&gt; this.deferredPromise.resolve()) }
  reject() { this.runInAsyncScope(() =&gt; this.deferredPromise.reject()) }
}
</code></pre>
</td></tr>
  <tr class="msg" id="L142"><td class="ts-cell"><a class="ts" href="#L142" alt="Wed Jan 18 2023 14:59:04 GMT-0800 (Pacific Standard Time)">22:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">This gives us the most flexibility because it allows us either option</td></tr>
  <tr class="msg" id="L143"><td class="ts-cell"><a class="ts" href="#L143" alt="Wed Jan 18 2023 15:00:45 GMT-0800 (Pacific Standard Time)">23:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">Can we have a parallel thread about the same question in legendecas's repo? I'd feel more comfortable sharing my thoughts there (since they're more related to Bloomberg's use case than Node stuff)</td></tr>
  <tr class="msg" id="L144"><td class="ts-cell"><a class="ts" href="#L144" alt="Wed Jan 18 2023 15:09:34 GMT-0800 (Pacific Standard Time)">23:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell"><a href="https://github.com/legendecas/proposal-async-context/issues/16">https://github.com/legendecas/proposal-async-context/issues/16</a></td></tr>
  <tr class="msg" id="L145"><td class="ts-cell"><a class="ts" href="#L145" alt="Wed Jan 18 2023 15:42:57 GMT-0800 (Pacific Standard Time)">23:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@jridgewell:matrix.org">Justin Ridgewell</span>&gt;</div></td><td class="msg-cell">This is also an interesting case because <code>unhandledrejection</code> will be the only event API that does not preserve the context at the time of registration...</td></tr>
  <tr class="msg" id="L146"><td class="ts-cell"><a class="ts" href="#L146" alt="Wed Jan 18 2023 15:44:20 GMT-0800 (Pacific Standard Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">It would indeed be special, but Yoav found that, in DOM, some events naturally wanted to restore the context when they were registered, whereas others should <em>not</em> do so and leave in place the context that triggered them</td></tr>
  <tr class="msg" id="L147"><td class="ts-cell"><a class="ts" href="#L147" alt="Wed Jan 18 2023 15:44:34 GMT-0800 (Pacific Standard Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">(I don't know details, but when we get back in touch with him, I'm really excited to hear his thoughts.)</td></tr>
  <tr class="msg" id="L148"><td class="ts-cell"><a class="ts" href="#L148" alt="Wed Jan 18 2023 15:44:49 GMT-0800 (Pacific Standard Time)">23:44</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">this is sort of a third case, to be sure</td></tr>
  <tr class="msg" id="L149"><td class="ts-cell"><a class="ts" href="#L149" alt="Wed Jan 18 2023 15:45:15 GMT-0800 (Pacific Standard Time)">23:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">but I think we agree it's disagreeing somehow, whether we go with 321 or 123</td></tr>
  <tr class="msg" id="L150"><td class="ts-cell"><a class="ts" href="#L150" alt="Wed Jan 18 2023 15:47:40 GMT-0800 (Pacific Standard Time)">23:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">Going through this, I'm more and more convinced the answer should be <code>321</code></td></tr>
  <tr class="msg" id="L151"><td class="ts-cell"><a class="ts" href="#L151" alt="Wed Jan 18 2023 15:48:35 GMT-0800 (Pacific Standard Time)">23:48</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@jasnell:matrix.org">James M Snell</span>&gt;</div></td><td class="msg-cell">if we're saying that the context is rightfully captured when the <code>then()</code> is called, or when <code>await</code> is called.. invoking an unhandledrejection handler falls into the equivalent category of "continuation handler"... it's just a different kind of continuation</td></tr>
  <tr class="msg" id="L152"><td class="ts-cell"><a class="ts" href="#L152" alt="Wed Jan 18 2023 15:53:14 GMT-0800 (Pacific Standard Time)">23:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-10" title="@littledan:matrix.org">littledan</span>&gt;</div></td><td class="msg-cell">I need to pull in an expert in how Bloomberg's system currently works before we make a call for the proposal in general; this whole thing might be unusable to us if the answer is 321</td></tr>

</tbody></table></div></div></div>
</body></html>