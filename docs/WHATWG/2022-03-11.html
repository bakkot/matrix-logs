<!DOCTYPE html><html><head>
  <title>WHATWG on 2022-03-11</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "WHATWG";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">WHATWG<br>2022-03-11<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2022-03-10" class="nav-link"><span>prev</span></a>
<a href="2022-03-12" class="nav-link"><span style="float:right">next</span></a>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search WHATWG">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Fri Mar 11 2022 03:15:19 GMT-0800 (Pacific Standard Time)">11:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Sigh, GitHub moderation is the worst. When you get spam on a PR you cannot delete the comment. If you block the person before editing the comment to remove the spam, you cannot edit the comment until you first unblock the person. And reporting the comment still takes you through a needlessly long software wizard I'm no longer interested in using.</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Fri Mar 11 2022 03:21:13 GMT-0800 (Pacific Standard Time)">11:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-3" title="@lucacasonato:matrix.org">Luca Casonato</span>&gt;</div></td><td class="msg-cell">I wish there was a feature like in Discord, where when you block someone it asks you if the all comments that person posted in the last 1hr/24hrs/7d should be deleted/hidden. That'd be really useful</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Fri Mar 11 2022 03:40:20 GMT-0800 (Pacific Standard Time)">11:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Matrix/Element does that too</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Fri Mar 11 2022 06:19:30 GMT-0800 (Pacific Standard Time)">14:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@timotijhof:matrix.org">Timo Tijhof</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> We are reasonably confident in the "reference implementation" in jsdom/whatwg-url, which says that such URLs are parsed like browsers do. <a href="https://jsdom.github.io/whatwg-url/#url=aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3BlY2lhbDpCbGFua3BhZ2U/ZnJvbT1lbiZ0bz1lcyZjYW1wYWlnbj1hcnRpY2xlLXJlY29tbWVuZGF0aW9uJnBhZ2U9QXBvbGxvJTk2U295dXpfVGVzdF9Qcm9qZWN0&amp;base=YWJvdXQ6Ymxhbms=">https://jsdom.github.io/whatwg-url/#url=aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3BlY2lhbDpCbGFua3BhZ2U/ZnJvbT1lbiZ0bz1lcyZjYW1wYWlnbj1hcnRpY2xlLXJlY29tbWVuZGF0aW9uJnBhZ2U9QXBvbGxvJTk2U295dXpfVGVzdF9Qcm9qZWN0&amp;base=YWJvdXQ6Ymxhbms=</a></blockquote></mx-reply><p>Thanks, that helps. With this, I traced it down to <a href="https://github.com/jsdom/whatwg-url/blob/a4cb13309246ca9ecf03404fdbf0d23ecaf114dd/lib/urlencoded.js#L10-L33">https://github.com/jsdom/whatwg-url/blob/a4cb13309246ca9ecf03404fdbf0d23ecaf114dd/lib/urlencoded.js#L10-L33</a> and <a href="https://github.com/jsdom/whatwg-url/blob/a4cb13309246ca9ecf03404fdbf0d23ecaf114dd/lib/percent-encoding.js#L20">https://github.com/jsdom/whatwg-url/blob/a4cb13309246ca9ecf03404fdbf0d23ecaf114dd/lib/percent-encoding.js#L20</a> which indeed is doing the critically important thing of ignoring things outside the known valid range and leaving them in-tact, whereas EcmaScript's decodeURIComponent throws an error for anything unexpected after a % sign.</p>
<p>I did actually (briefly) consider using jsdom originaly, but found that it (understandably) kind of makes maximum use of other internals. It seems it goes down to the level of code points and then brings all of TextEncoder into it all as well, and UintArray, etc. I struggled to find a minimal way to port that over.</p>
<p>I managed to make currently-failing test cases pass by replacing the blanket decodeURIComponent call with a loop over the string and then if the two chars after % are in-range, call decodeURIComponent on just But then found that this doesn't work for multi-byte characters, e.g. decoding <code>%7F%C3%BF</code> is only accepted when done at once, not when done chunk by chunk. The URL spec doesn't say that, but then again, the URL spec doesnt say to use decodeURI of course anyway, it says to work on bytes and code points and not return to UTF-8 strings until all the way done, which I can't do within ES5 I think, or at least not without a ton of other emulation code.</p>
<p>I did try forcing it by using String.fromCharCode(parseInt(chunk.slice(1), 16));`, but that just produced garbage.</p>
<p>I hate myself for this, but I managed to get all tests passing both old and new cases, by using a regex. That seemed simpler than trying to eagerly buffer up multiple %- chunks or re-implemenitng lower level code point mapping for multi-bytes.</p>
<p>The regex looks only for valid in-range percent encoded chunks and eagerly repeats this so that we always pass decodeURI as many at once as possible.</p>
<pre><code>	function percent_decode(bytes) {
			return bytes.replace(/((%[0-9A-Fa-f]{2})*)/g, function(m, p1) {
				return decodeURIComponent(p1);
			});
	
	}
</code></pre>
<p>I feel dirty now, but it seems to hold up in my testing so far. Curious if anyone here knows of a better minimal way to get the multi-byte code points to work in ES5 without "a lot of code" and/or can poke holes in the above, preferably holes that didn't already exist in the previous version of the FT polyfill (which simply calls decodeURIComponent on the whole thing).</p>
</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Fri Mar 11 2022 08:57:31 GMT-0800 (Pacific Standard Time)">16:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Ms2ger 游눌游눌</span>: why is it synthetic settings objects/realms and not shadow settings objects/realms?</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Fri Mar 11 2022 09:01:28 GMT-0800 (Pacific Standard Time)">17:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-6">Ms2ger 游눌游눌</span>: I'd also still like some kind of answer to the question I raised in my overall review comment</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Fri Mar 11 2022 09:03:16 GMT-0800 (Pacific Standard Time)">17:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">I'll leave these questions on the PR.</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Fri Mar 11 2022 09:30:58 GMT-0800 (Pacific Standard Time)">17:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Timo Tijhof</span>: that was a fun read. I'm bad at reading regexp, maybe add a comment, but that looks reasonable. It does look like it will fall over if folks are not using UTF-8 bytes, which is allowed. But perhaps that's acceptable in your case. Might also want to denote that.</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Fri Mar 11 2022 09:51:45 GMT-0800 (Pacific Standard Time)">17:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@timotijhof:matrix.org">Timo Tijhof</span>&gt;</div></td><td class="msg-cell"><p>Thanks, that gives me a bit more confidence. The use case that led me to discover this bug in the FT polyfill is actually very much related to bytes that are not UTF-8 bytes.</p>
<p>Wikipedia uses UTF-8 for canonical URLs everywhere now and has for almost two decades now. But some of the earliest language editions (Specifically en.wikipedia, pl.wikipedia, and zh.wikipedia) used to use a different encoding, which our backend web server (MediaWiki PHP) continues to support to ensure URLs don't break. If the decoded string isn't valid UTF-8, it will on those wikis fallback to a legacy encoding. For en.wikipedia that is windows-1252, for pl.wikipedia iso-8859-2 and for zh.wikipeida/zh-hans windows-936 and zh/zh-hant windows-950.  As per <a href="https://codesearch.wmcloud.org/core/?q=fallback8bitEncoding%20%3D">https://codesearch.wmcloud.org/core/?q=fallback8bitEncoding%20%3D</a></p>
<p>For example, this URL is still supported: <a href="https://en.wikipedia.org/w/index.php?title=Apollo%96Soyuz_Test_Project">https://en.wikipedia.org/w/index.php?title=Apollo%96Soyuz_Test_Project</a></p>
<p>While we don't have any need to read the "correct" value of the title parameter in JavaScript, we do have many other query params we sometimes read client-side, and so having <code>new mw.Uri</code> (our in-house library) or <code>new URL</code> (polyfiled) throw unconditionally on those pages is a problem. It's fine if we can't read <code>searchParams.get('title')</code> correctly, so long as we can still do other things with it.</p>
<p>Our downstream task (which was meant to be closed by using the URL API) - <a href="https://phabricator.wikimedia.org/T106244">https://phabricator.wikimedia.org/T106244</a></p>
<p>My PR (with docs now): <a href="https://github.com/Financial-Times/polyfill-library/pull/1173">https://github.com/Financial-Times/polyfill-library/pull/1173</a>.</p>
<p>I'm still looking into improving the handling of incomplete multi-byte. We are unlikely to encounter those for any "valid" URLs, not even legacy ones, but it still seems better not to crash on those but do a replacement indeed like the standard does.</p>
</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Fri Mar 11 2022 09:54:05 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Timo Tijhof</span>: so shouldn't you handle failure in that case and just return the input?</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Fri Mar 11 2022 09:54:37 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Timo Tijhof</span>: and maybe rename to utf8_percent_decode</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Fri Mar 11 2022 09:54:59 GMT-0800 (Pacific Standard Time)">17:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@timotijhof:matrix.org">Timo Tijhof</span>&gt;</div></td><td class="msg-cell">Ack, yeah, I'm aware calling these bytes is wrong (though pre-existing name in the code).</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Fri Mar 11 2022 09:55:05 GMT-0800 (Pacific Standard Time)">17:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Timo Tijhof</span>: e.g., consider %FF which can never decode as UTF-8</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Fri Mar 11 2022 09:57:16 GMT-0800 (Pacific Standard Time)">17:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@timotijhof:matrix.org">Timo Tijhof</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-16">Timo Tijhof</span>: and maybe rename to utf8_percent_decode</blockquote></mx-reply>Hm.. so the issue there is that if you have %FF%20, my eager regex will feed them all (as it should for multibyte) and then fail in its entirely still. Returning that as literal or as replacement character would both be different from the spec. But I don't mind a bit of difference with the spec. This is meant to be a relatively loose polyfill I think, and not a full virtual machine :)</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Fri Mar 11 2022 09:59:39 GMT-0800 (Pacific Standard Time)">17:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Yeah I mainly meant that you don't seem to handle failure at all at the moment. Other than rethrowing. You're right that sequences such as that make it trickier.</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Fri Mar 11 2022 10:00:00 GMT-0800 (Pacific Standard Time)">18:00</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@timotijhof:matrix.org">Timo Tijhof</span>&gt;</div></td><td class="msg-cell">Ack yeah, I'll add a localised try-catch if nothing else. Good point. </td></tr>

</tbody></table></div></div></div>
</body></html>