<!DOCTYPE html><html><head>
  <title>WHATWG on 2024-07-15</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "WHATWG";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">WHATWG<br>2024-07-15<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-07-13" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search WHATWG">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Sun Jul 14 2024 17:30:39 GMT-0700 (Pacific Daylight Time)">00:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@akaster:serenityos.org">akaster</span>&gt;</div></td><td class="msg-cell">Is there any appetite to revisit what origins are supposed to be exposed via <code>document.ancestorOrigins</code> ? We've got an open PR to implement it in Ladybird, but I'm not sure whether there was any consensus as to what it should be doing from <a href="https://github.com/whatwg/html/issues/1918">https://github.com/whatwg/html/issues/1918</a>. Chrome and Safar seem to implement it, while Firefox does not</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Sun Jul 14 2024 17:31:19 GMT-0700 (Pacific Daylight Time)">00:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@akaster:serenityos.org">akaster</span>&gt;</div></td><td class="msg-cell">er.. location.ancestorOrigins</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Sun Jul 14 2024 17:36:21 GMT-0700 (Pacific Daylight Time)">00:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@sideshowbarker:matrix.org">sideshowbarker</span>&gt;</div></td><td class="msg-cell"><p><span class="nick-8">akaster</span>: One thing to consider is: Somebody from the Ladybird project whoâ€™s familiar with that Ladybird PR could get it on the agenda for the next WHATNOT meeting/call by adding a comment to <a href="https://github.com/whatwg/html/issues/10471">https://github.com/whatwg/html/issues/10471</a>.</p>
<p>That next call is on July 18th at 9am US/West.</p>
<p>But if nobody else from Ladybird can be on the call, I can read up on the PR and could be on myself to talk about it.</p>
</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Sun Jul 14 2024 17:41:07 GMT-0700 (Pacific Daylight Time)">00:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@akaster:serenityos.org">akaster</span>&gt;</div></td><td class="msg-cell">Hmm. Sure. I've been meaning to figure out how to get us more involved in the standards processes anyway. I think we have quite a few open WhatWG-related issues laying around that might be worth aggregating into a list in our own issue tracker as well.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Sun Jul 14 2024 18:35:00 GMT-0700 (Pacific Daylight Time)">01:35</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@sideshowbarker:matrix.org">sideshowbarker</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">akaster</span>: If you want, I can make time to help with either or both of those (figuring out how to get more involved in standards processes, and aggregating the relevant issues). And Iâ€™d be happy to do it. Iâ€™m anyway looking for more ways I could contribute to the project â€”&nbsp;and itâ€™d be a good fit for me, since Iâ€™m already pretty involved in the WHATWG. (And would also give me another reason to procrastinate on debugging <a href="https://github.com/LadybirdBrowser/ladybird/issues/75">https://github.com/LadybirdBrowser/ladybird/issues/75</a> ðŸ˜†)</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Jul 15 2024 00:10:29 GMT-0700 (Pacific Daylight Time)">07:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">akaster</span>: I don't think there's an update on <code>ancestorOrigins</code>, but I think bz's concern around it exposing too much information still holds. There's talk about a header-based version of that feature that does a lot better in terms of information exposure: <a href="https://github.com/w3c/webappsec-fetch-metadata/issues/56">https://github.com/w3c/webappsec-fetch-metadata/issues/56</a></td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Jul 15 2024 01:10:50 GMT-0700 (Pacific Daylight Time)">08:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell">Hi, I was contemplating HTML entities and I realized that there are two entities, &amp;nLt; and &amp;nGt;, whose UTF-8 expansions are longer than their ASCII representations (six bytes versus five bytes). Only these entities have this property.

I realized this while writing an HTML parser in C, using constant string views to parse a document with no allocations and no copies. It seems to me that, in UTF-8, these entities and the mandate to replace U+0000 with U+FFFD are the only things preventing me from decoding inline HTML text in-place by mutating the buffer. I punt the replacement of nul bytes to the user, but because of &amp;nLt; and &amp;nGt;, inline text is 20% longer in the worst case after expansion.

Am I crazy, or is this a serious limitation? HTML is so close to being parseable in-place. I don't want to jump to the conclusion that these entities should be deprecated, but there would be a benefit.

I'm tempted to ignore &amp;nLt; and &amp;nGt; just for this reason!</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Jul 15 2024 01:34:03 GMT-0700 (Pacific Daylight Time)">08:34</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">Domenic</span>: if you have a couple minutes could you look at <a href="https://github.com/whatwg/mimesniff/pull/192">https://github.com/whatwg/mimesniff/pull/192</a>? I'd like to land it</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Jul 15 2024 01:36:06 GMT-0700 (Pacific Daylight Time)">08:36</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">lynko</span>: don't you have the same problem with decoding bytes to text? E.g., 0xFF has to become U+FFFD too.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Mon Jul 15 2024 01:39:36 GMT-0700 (Pacific Daylight Time)">08:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-9">lynko</span>: don't you have the same problem with decoding bytes to text? E.g., 0xFF has to become U+FFFD too.</blockquote></mx-reply>Sure, but that's malformed input, and I pass it on just like a nul byte (it's up to the user to decide if conversion is necessary). â‰ªâƒ’ and â‰«âƒ’ make it a problem for correct input too.</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Mon Jul 15 2024 01:42:22 GMT-0700 (Pacific Daylight Time)">08:42</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell">How do you avoid allocations for creating nodes and such?</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Mon Jul 15 2024 01:45:01 GMT-0700 (Pacific Daylight Time)">08:45</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell">There's one flat inout array for nodes, if the parser runs out of room it stops writing but still returns the number of nodes that were parsed. If your buffer was already big enough then it happens in one pass and doesn't trigger a reallocation, and even if it does, you know exactly how much room you need. The parser also always produces a valid hierarchy even if it gets cut off partway through</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Mon Jul 15 2024 01:49:45 GMT-0700 (Pacific Daylight Time)">08:49</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell">I see, but that also means you have to keep the entire input file in memory as well, right? For a markup-heavy document I wonder if that's still going to be beneficial. But it's interesting for sure.</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Mon Jul 15 2024 01:50:49 GMT-0700 (Pacific Daylight Time)">08:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell">If anyone <span class="nick-15">hsivonen</span> might have some thoughts about this, but not sure if he's around.</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Mon Jul 15 2024 01:52:11 GMT-0700 (Pacific Daylight Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell">It's kind of a specific use case, but I personally don't anticipate the need to parse files larger than I can store in memory. I do have some ideas about extending the API for streaming purposes with similar in-place properties... but it's beside the point</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Mon Jul 15 2024 01:52:36 GMT-0700 (Pacific Daylight Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">I haven't previously noticed this property of the entity names, but I have noticed that replacing U+0000 with U+FFFD is rather unfortunate from the UTF-8 perspective.</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Mon Jul 15 2024 01:52:58 GMT-0700 (Pacific Daylight Time)">08:52</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell">The answer is wilful violation :)</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Mon Jul 15 2024 01:54:37 GMT-0700 (Pacific Daylight Time)">08:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">lynko</span>: Does modifying the buffer in place really help? That is, don't you need an API that can report the content of a text nodes as multiple API chunks anyway? Once you have that, referring to static memory that contains the entity expansion is workable.</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Mon Jul 15 2024 01:55:47 GMT-0700 (Pacific Daylight Time)">08:55</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">lynko</span>: Can your tree builder side usefully hold onto text nodes that point to source data? Won't that mean retaining the buffer space for all the tags at presumably high cost?</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Mon Jul 15 2024 01:57:35 GMT-0700 (Pacific Daylight Time)">08:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell"><span class="nick-9">lynko</span>: also, when entities resolve to shorter output, won't you have quadratic memmoves that defeat the benefit of avoiding copies?</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Mon Jul 15 2024 01:59:01 GMT-0700 (Pacific Daylight Time)">08:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-9">lynko</span>: Does modifying the buffer in place really help? That is, don't you need an API that can report the content of a text nodes as multiple API chunks anyway? Once you have that, referring to static memory that contains the entity expansion is workable.</blockquote></mx-reply>If all I really want is decoded inline text, then I just want to compute that text. It's always a bonus not to have to find a new place to put it.</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Mon Jul 15 2024 02:02:08 GMT-0700 (Pacific Daylight Time)">09:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-9">lynko</span>: Can your tree builder side usefully hold onto text nodes that point to source data? Won't that mean retaining the buffer space for all the tags at presumably high cost?</blockquote></mx-reply>Tags are 75% of a document in the worst case. I'll always have to store a tag's type (and attributes) somehow, so I just use a single string view and don't decode attributes, except for parsing validation. I'm not sure exactly how the tradeoff works out, but tag content is usually a much smaller portion... I'm guessing 10%. Another benefit besides memory locality is that this approach preserves tags' case, although I don't store views of the closing tag</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Mon Jul 15 2024 02:03:41 GMT-0700 (Pacific Daylight Time)">09:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-9">lynko</span>: also, when entities resolve to shorter output, won't you have quadratic memmoves that defeat the benefit of avoiding copies?</blockquote></mx-reply>This can be done in O(n) where n is the length of the text, and it was already O(n). Also it only matters for documents with extreme amounts of entity references</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Mon Jul 15 2024 02:05:13 GMT-0700 (Pacific Daylight Time)">09:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-15" title="@hsivonen:mozilla.org">hsivonen</span>&gt;</div></td><td class="msg-cell">I see. I'm looking forward to seeing the results with the willful violation. I don't expect us to un-spec the two entities that have been there for a long time, despite them being niche, though. At least not without a use counter.</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Mon Jul 15 2024 02:07:43 GMT-0700 (Pacific Daylight Time)">09:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> I see. I'm looking forward to seeing the results with the willful violation. I don't expect us to un-spec the two entities that have been there for a long time, despite them being niche, though. At least not without a use counter.</blockquote></mx-reply>No no, I'm not suggesting U+FFFD should be changed. Too much momentum. And I wouldn't transmit HTML with nul bytes in it. This is for internal use, where I can optimize for correct input and retain control codes.</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Mon Jul 15 2024 02:08:09 GMT-0700 (Pacific Daylight Time)">09:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell">Also note that parsers in browser engines store local names (of most elements and attributes) as atomized strings. It'd be interesting to see the memory and performance differences though.</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Mon Jul 15 2024 02:14:07 GMT-0700 (Pacific Daylight Time)">09:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-9" title="@lynko:matrix.org">lynko</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> Also note that parsers in browser engines store local names (of most elements and attributes) as atomized strings. It'd be interesting to see the memory and performance differences though.</blockquote></mx-reply>I doubt I could make a fair comparison. Browser engines have a lot more concerns than me, so they must have to make compromises of some sort. But you've given me a lot to think about. Short-string optimization and generating a new text storage buffer alongside the node array seems worth exploring.</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Mon Jul 15 2024 02:15:57 GMT-0700 (Pacific Daylight Time)">09:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">Domenic</span>: thanks, follow-up request: <a href="https://github.com/web-platform-tests/wpt/pull/47002">https://github.com/web-platform-tests/wpt/pull/47002</a></td></tr>

</tbody></table></div></div></div>
</body></html>