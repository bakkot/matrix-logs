<!DOCTYPE html><html><head>
  <title>WHATWG on 2021-10-12</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "WHATWG";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">WHATWG<br>2021-10-12<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2021-10-10" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>
<input type="text" id="query" size="25" placeholder="Search WHATWG">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Mon Oct 11 2021 18:40:40 GMT-0700 (Pacific Daylight Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@msmith12:matrix.org">msmith12</span>&gt;</div></td><td class="msg-cell">Hi all</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Mon Oct 11 2021 18:40:57 GMT-0700 (Pacific Daylight Time)">01:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-13" title="@msmith12:matrix.org">msmith12</span>&gt;</div></td><td class="msg-cell">Just sumbitted patch, hopefully its the start of something great</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Mon Oct 11 2021 23:02:13 GMT-0700 (Pacific Daylight Time)">06:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">Good morning <span class="nick-12">annevk</span>, some longish morning thought. I was thinking a lot about the fetch/timing integration. Maybe it was not right to associate the timing info with a response? A response is something that can be shared between fetches (service workers, cache), and would have different timing in each fetch context as some of the timing is measured before the response is created. Perhaps reporting the timing should be a method of the fetch instance rather than the response, and all the "attaching" is not necessary? Contemplating <a href="https://github.com/whatwg/fetch/issues/1208">https://github.com/whatwg/fetch/issues/1208</a> and <a href="https://github.com/whatwg/fetch/issues/1215">https://github.com/whatwg/fetch/issues/1215</a></td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Mon Oct 11 2021 23:03:56 GMT-0700 (Pacific Daylight Time)">06:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@sideshowbarker:mozilla.org">sideshowbarker</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: by the way, thanks much for doing that PR for proper Fetch integration into CSS</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Mon Oct 11 2021 23:11:36 GMT-0700 (Pacific Daylight Time)">06:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-8">Noam Rosenthal</span>: by the way, thanks much for doing that PR for proper Fetch integration into CSS</blockquote></mx-reply>Pleasure, it felt necessary</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Mon Oct 11 2021 23:12:13 GMT-0700 (Pacific Daylight Time)">06:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@sideshowbarker:mozilla.org">sideshowbarker</span>&gt;</div></td><td class="msg-cell">yeah it was kind of long overdue</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Mon Oct 11 2021 23:13:14 GMT-0700 (Pacific Daylight Time)">06:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@sideshowbarker:mozilla.org">sideshowbarker</span>&gt;</div></td><td class="msg-cell">and for any given spec, itâ€™s not trivial to figure how to call into the Fetch algorithms in the right way</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Mon Oct 11 2021 23:14:41 GMT-0700 (Pacific Daylight Time)">06:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@sideshowbarker:mozilla.org">sideshowbarker</span>&gt;</div></td><td class="msg-cell">*for any given request scenario</td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Mon Oct 11 2021 23:47:35 GMT-0700 (Pacific Daylight Time)">06:47</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">trying to figure it out for multiple specs... For the CSS one it's a bit of a one-size-fits all because there are no load/error events, but still there are issues with referrers and CORS etc.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Oct 12 2021 00:09:15 GMT-0700 (Pacific Daylight Time)">07:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: I guess conceptually you'd want fetch to return a response and timing info, but since the handshake is fetch(request) -&gt; response it's hard to change that</td></tr>
  <tr class="msg" id="L10"><td class="ts-cell"><a class="ts" href="#L10" alt="Tue Oct 12 2021 00:09:29 GMT-0700 (Pacific Daylight Time)">07:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: though maybe it's changeable more easily now that we have callbacks</td></tr>
  <tr class="msg" id="L11"><td class="ts-cell"><a class="ts" href="#L11" alt="Tue Oct 12 2021 00:10:17 GMT-0700 (Pacific Daylight Time)">07:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: the other thing we probably still want to do at some point is FetchObserver (there's an issue if you search for this), which would also be a somewhat natural point to expose this on</td></tr>
  <tr class="msg" id="L12"><td class="ts-cell"><a class="ts" href="#L12" alt="Tue Oct 12 2021 00:12:57 GMT-0700 (Pacific Daylight Time)">07:12</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: Fetch doesn't really return anything, but rather takes in callbacks that accept responses. I think that it could return some controller object that represents the fetch instance, which could have things like "report resource timing"</td></tr>
  <tr class="msg" id="L13"><td class="ts-cell"><a class="ts" href="#L13" alt="Tue Oct 12 2021 00:13:46 GMT-0700 (Pacific Daylight Time)">07:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: sure, I meant at a high-level, but yeah, at a concrete level I suspect we'd want to return the controller directly</td></tr>
  <tr class="msg" id="L14"><td class="ts-cell"><a class="ts" href="#L14" alt="Tue Oct 12 2021 00:14:02 GMT-0700 (Pacific Daylight Time)">07:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: that would also give us a way to do abort more cleanly</td></tr>
  <tr class="msg" id="L15"><td class="ts-cell"><a class="ts" href="#L15" alt="Tue Oct 12 2021 00:14:11 GMT-0700 (Pacific Daylight Time)">07:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: that's probably what I'd want to start with</td></tr>
  <tr class="msg" id="L16"><td class="ts-cell"><a class="ts" href="#L16" alt="Tue Oct 12 2021 00:14:26 GMT-0700 (Pacific Daylight Time)">07:14</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">it would be easy to hook that return value into the fetch caller for the purposes of resource timing</td></tr>
  <tr class="msg" id="L17"><td class="ts-cell"><a class="ts" href="#L17" alt="Tue Oct 12 2021 00:15:15 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">We'd still want to use the timings of the callbacks to expose the information, though</td></tr>
  <tr class="msg" id="L18"><td class="ts-cell"><a class="ts" href="#L18" alt="Tue Oct 12 2021 00:15:18 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">I guess the idea of FetchObserver is conceptually that? I'll check the issue</td></tr>
  <tr class="msg" id="L19"><td class="ts-cell"><a class="ts" href="#L19" alt="Tue Oct 12 2021 00:15:58 GMT-0700 (Pacific Daylight Time)">07:15</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">yes, the callbacks will be there in the same way, but there will be no "attaching timing info to a response"</td></tr>
  <tr class="msg" id="L20"><td class="ts-cell"><a class="ts" href="#L20" alt="Tue Oct 12 2021 00:16:00 GMT-0700 (Pacific Daylight Time)">07:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: yeah, FetchObserver is/was for progress events and HTTP/2 push, but the latter died and there was never enough interest in the former (and it can be polyfilled using streams)</td></tr>
  <tr class="msg" id="L21"><td class="ts-cell"><a class="ts" href="#L21" alt="Tue Oct 12 2021 00:16:22 GMT-0700 (Pacific Daylight Time)">07:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Yeah, we'd attach it to the controller</td></tr>
  <tr class="msg" id="L22"><td class="ts-cell"><a class="ts" href="#L22" alt="Tue Oct 12 2021 00:16:45 GMT-0700 (Pacific Daylight Time)">07:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">I think the controller will have access to the fetch params</td></tr>
  <tr class="msg" id="L23"><td class="ts-cell"><a class="ts" href="#L23" alt="Tue Oct 12 2021 00:17:18 GMT-0700 (Pacific Daylight Time)">07:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">like a public facade for stuff you can do with things from the fetch params</td></tr>
  <tr class="msg" id="L24"><td class="ts-cell"><a class="ts" href="#L24" alt="Tue Oct 12 2021 00:17:45 GMT-0700 (Pacific Daylight Time)">07:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Yeah, I think we'd want a facade of sorts (or asserts) to ensure specs don't do weird things</td></tr>
  <tr class="msg" id="L25"><td class="ts-cell"><a class="ts" href="#L25" alt="Tue Oct 12 2021 00:18:04 GMT-0700 (Pacific Daylight Time)">07:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">Great, let me jot down something</td></tr>
  <tr class="msg" id="L26"><td class="ts-cell"><a class="ts" href="#L26" alt="Tue Oct 12 2021 00:51:41 GMT-0700 (Pacific Daylight Time)">07:51</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">this would also make it possible to update resource timing entries after they're created, e.g. if in the future we would want to spec that a <code>video</code> resource timing entry is created when the response is ready but updated with its <code>responseEnd</code> when it's done</td></tr>
  <tr class="msg" id="L27"><td class="ts-cell"><a class="ts" href="#L27" alt="Tue Oct 12 2021 01:19:18 GMT-0700 (Pacific Daylight Time)">08:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: I think in principle that should be possible either way, but this might make it easier</td></tr>
  <tr class="msg" id="L28"><td class="ts-cell"><a class="ts" href="#L28" alt="Tue Oct 12 2021 01:19:41 GMT-0700 (Pacific Daylight Time)">08:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">yea exactly</td></tr>
  <tr class="msg" id="L29"><td class="ts-cell"><a class="ts" href="#L29" alt="Tue Oct 12 2021 01:20:10 GMT-0700 (Pacific Daylight Time)">08:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: now that you mention it though, how do we account for media elements currently? They always make range requests so they get responses quite quickly. The spec for them doesn't quite reflect this (or at least not in sufficient detail)</td></tr>
  <tr class="msg" id="L30"><td class="ts-cell"><a class="ts" href="#L30" alt="Tue Oct 12 2021 01:20:40 GMT-0700 (Pacific Daylight Time)">08:20</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">I guess the current setup might end up with an entry per range request potentially?</td></tr>
  <tr class="msg" id="L31"><td class="ts-cell"><a class="ts" href="#L31" alt="Tue Oct 12 2021 01:22:46 GMT-0700 (Pacific Daylight Time)">08:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: currently in the spec, that integration is not done yet. I need to research how it's done in implementations. I wanted to have a good infrastructure with the simpler requests first</td></tr>
  <tr class="msg" id="L32"><td class="ts-cell"><a class="ts" href="#L32" alt="Tue Oct 12 2021 01:40:10 GMT-0700 (Pacific Daylight Time)">08:40</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: <a href="https://github.com/whatwg/fetch/pull/1329">https://github.com/whatwg/fetch/pull/1329</a></td></tr>
  <tr class="msg" id="L33"><td class="ts-cell"><a class="ts" href="#L33" alt="Tue Oct 12 2021 01:56:14 GMT-0700 (Pacific Daylight Time)">08:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: btw, I think also <code>cacheState</code> and <code>timing allow passed flag</code> should be associated with a fetch and not with a response, for the same reasons. It's not clear how they're forwarded from service workers or restored from cache</td></tr>
  <tr class="msg" id="L34"><td class="ts-cell"><a class="ts" href="#L34" alt="Tue Oct 12 2021 01:58:37 GMT-0700 (Pacific Daylight Time)">08:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">By restored from cache you mean restored from the Cache API? That might make sense. There's a general issue with that API not getting as much attention as it deserves.</td></tr>
  <tr class="msg" id="L35"><td class="ts-cell"><a class="ts" href="#L35" alt="Tue Oct 12 2021 02:13:21 GMT-0700 (Pacific Daylight Time)">09:13</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: I meant also from HTTP cache. It's not spec`ed how those responses are stored, and as far as the spec is concerned the response stored in the cache is a reference to the same one that's restored.</td></tr>
  <tr class="msg" id="L36"><td class="ts-cell"><a class="ts" href="#L36" alt="Tue Oct 12 2021 02:16:19 GMT-0700 (Pacific Daylight Time)">09:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: well, but we always set this field when we pull something from the cache</td></tr>
  <tr class="msg" id="L37"><td class="ts-cell"><a class="ts" href="#L37" alt="Tue Oct 12 2021 02:17:03 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: right, but we set it <em>on the response</em>, which could mean setting it on the original response also. I think there is a related Chrome bug about exactly this</td></tr>
  <tr class="msg" id="L38"><td class="ts-cell"><a class="ts" href="#L38" alt="Tue Oct 12 2021 02:17:49 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">e.g. if you store a response to cache and retrieve it before it's done, both responses would get the same cacheState</td></tr>
  <tr class="msg" id="L39"><td class="ts-cell"><a class="ts" href="#L39" alt="Tue Oct 12 2021 02:17:50 GMT-0700 (Pacific Daylight Time)">09:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">I think I'm missing how it's observable</td></tr>
  <tr class="msg" id="L40"><td class="ts-cell"><a class="ts" href="#L40" alt="Tue Oct 12 2021 02:18:05 GMT-0700 (Pacific Daylight Time)">09:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Aah</td></tr>
  <tr class="msg" id="L41"><td class="ts-cell"><a class="ts" href="#L41" alt="Tue Oct 12 2021 02:19:21 GMT-0700 (Pacific Daylight Time)">09:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Presumably we should take a copy when storing it in the cache (or take a copy when forwarding).</td></tr>
  <tr class="msg" id="L42"><td class="ts-cell"><a class="ts" href="#L42" alt="Tue Oct 12 2021 02:19:43 GMT-0700 (Pacific Daylight Time)">09:19</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">In theory that also seems problematic for reading the body for instance (which can only happen once).</td></tr>
  <tr class="msg" id="L43"><td class="ts-cell"><a class="ts" href="#L43" alt="Tue Oct 12 2021 02:21:20 GMT-0700 (Pacific Daylight Time)">09:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">yes, and I added a non-normative note as such</td></tr>
  <tr class="msg" id="L44"><td class="ts-cell"><a class="ts" href="#L44" alt="Tue Oct 12 2021 02:21:52 GMT-0700 (Pacific Daylight Time)">09:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">Ah actually it was something else, got mixed up</td></tr>
  <tr class="msg" id="L45"><td class="ts-cell"><a class="ts" href="#L45" alt="Tue Oct 12 2021 02:22:28 GMT-0700 (Pacific Daylight Time)">09:22</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">It's presumably a copy, but it's not formally a copy, and there is no definition of what a "response copy" is</td></tr>
  <tr class="msg" id="L46"><td class="ts-cell"><a class="ts" href="#L46" alt="Tue Oct 12 2021 02:24:51 GMT-0700 (Pacific Daylight Time)">09:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">which, I believe, fudges some things in existing implementations when response objects are shared between fetches</td></tr>
  <tr class="msg" id="L47"><td class="ts-cell"><a class="ts" href="#L47" alt="Tue Oct 12 2021 02:28:49 GMT-0700 (Pacific Daylight Time)">09:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Hmm, how did <a href="https://twitter.com/htmlstandard/status/1447820555760005122">https://twitter.com/htmlstandard/status/1447820555760005122</a> get tweeted?</td></tr>
  <tr class="msg" id="L48"><td class="ts-cell"><a class="ts" href="#L48" alt="Tue Oct 12 2021 02:31:33 GMT-0700 (Pacific Daylight Time)">09:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Ah, I forgot to remove a leading space when squashing. Good times.</td></tr>
  <tr class="msg" id="L49"><td class="ts-cell"><a class="ts" href="#L49" alt="Tue Oct 12 2021 02:54:44 GMT-0700 (Pacific Daylight Time)">09:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: updated the PR, now timing/TAO/cacheState are all part of fetch params and accessible through a controller. Regarding <code>body</code> I'll open a separate issue, I'm less familiar with it.</td></tr>
  <tr class="msg" id="L50"><td class="ts-cell"><a class="ts" href="#L50" alt="Tue Oct 12 2021 03:10:48 GMT-0700 (Pacific Daylight Time)">10:10</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: note that if you're moving cacheState we'll need to update SW too</td></tr>
  <tr class="msg" id="L51"><td class="ts-cell"><a class="ts" href="#L51" alt="Tue Oct 12 2021 03:11:34 GMT-0700 (Pacific Daylight Time)">10:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: doing this in smaller steps would make it a little easier to ensure nothing is missed</td></tr>
  <tr class="msg" id="L52"><td class="ts-cell"><a class="ts" href="#L52" alt="Tue Oct 12 2021 03:24:15 GMT-0700 (Pacific Daylight Time)">10:24</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <span class="nick-8">Noam Rosenthal</span>: doing this in smaller steps would make it a little easier to ensure nothing is missed</blockquote></mx-reply>Ok, I can start with a version that still assigns cacheState to a response</td></tr>
  <tr class="msg" id="L53"><td class="ts-cell"><a class="ts" href="#L53" alt="Tue Oct 12 2021 04:56:35 GMT-0700 (Pacific Daylight Time)">11:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">Actually, this might be more complex... not sure if on some cases RT users rely on  resource-timing being per response rather than per-fetch, need to clarify with the working group</td></tr>
  <tr class="msg" id="L54"><td class="ts-cell"><a class="ts" href="#L54" alt="Tue Oct 12 2021 05:05:37 GMT-0700 (Pacific Daylight Time)">12:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: you mean when requests are coalesced? There's also a question to what extent we want to expose that</td></tr>
  <tr class="msg" id="L55"><td class="ts-cell"><a class="ts" href="#L55" alt="Tue Oct 12 2021 05:07:08 GMT-0700 (Pacific Daylight Time)">12:07</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-10">TabAtkins</span>: have you considered linting / auto formatting for Bikeshed at some point? That would help a lot with spec PRs potentially.</td></tr>
  <tr class="msg" id="L56"><td class="ts-cell"><a class="ts" href="#L56" alt="Tue Oct 12 2021 05:08:21 GMT-0700 (Pacific Daylight Time)">12:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: : I mean, for example, when a service worker forwards a network response. Should the connection info be available only inside the context of the service worker, or should it be part of the resource entry of the document? Same for resources that were fetched early in the document and then accessed from cache.</td></tr>
  <tr class="msg" id="L57"><td class="ts-cell"><a class="ts" href="#L57" alt="Tue Oct 12 2021 05:09:26 GMT-0700 (Pacific Daylight Time)">12:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">I personally believe the cleanest solution that doesn't lose any info would be that a Resource Timing Entry is mapped 1:1 to a fetch, but I have to see with the WG whether there are other expectations or existing implementations that counter this</td></tr>
  <tr class="msg" id="L58"><td class="ts-cell"><a class="ts" href="#L58" alt="Tue Oct 12 2021 05:09:33 GMT-0700 (Pacific Daylight Time)">12:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: I thought we had some forwarding of service worker data already?</td></tr>
  <tr class="msg" id="L59"><td class="ts-cell"><a class="ts" href="#L59" alt="Tue Oct 12 2021 05:11:08 GMT-0700 (Pacific Daylight Time)">12:11</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: the service worker timing info itself is extra information available to navigations. What we forward from the service worker for non-navigation resources is a response. Since that forwarding happens before fetch-finale, that response's timing info gets overwritten by the document's fetch</td></tr>
  <tr class="msg" id="L60"><td class="ts-cell"><a class="ts" href="#L60" alt="Tue Oct 12 2021 05:16:30 GMT-0700 (Pacific Daylight Time)">12:16</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">I see, there is some complexity there as some service worker responses might not yet carry timing info, so any change would have to be considered carefully</td></tr>
  <tr class="msg" id="L61"><td class="ts-cell"><a class="ts" href="#L61" alt="Tue Oct 12 2021 05:38:22 GMT-0700 (Pacific Daylight Time)">12:38</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: are "flags" in the fetch spec considered atomic? I didn't see information about this in <code>infra</code></td></tr>
  <tr class="msg" id="L62"><td class="ts-cell"><a class="ts" href="#L62" alt="Tue Oct 12 2021 05:46:05 GMT-0700 (Pacific Daylight Time)">12:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: no, <span class="nick-1">jyasskin</span> has brought this up here and there and <span class="nick-6">Jake Archibald</span> too. Saying it's atomic when using it is probably sufficient for now.</td></tr>
  <tr class="msg" id="L63"><td class="ts-cell"><a class="ts" href="#L63" alt="Tue Oct 12 2021 05:46:59 GMT-0700 (Pacific Daylight Time)">12:46</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">Ok, so something like "atomically test and set" this or that.</td></tr>
  <tr class="msg" id="L64"><td class="ts-cell"><a class="ts" href="#L64" alt="Tue Oct 12 2021 05:53:57 GMT-0700 (Pacific Daylight Time)">12:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: the integrity case, btw, does not present a race condition. Fetch finale is only called after the integrity is verified</td></tr>
  <tr class="msg" id="L65"><td class="ts-cell"><a class="ts" href="#L65" alt="Tue Oct 12 2021 05:54:49 GMT-0700 (Pacific Daylight Time)">12:54</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">I believe there is actually no race condition. The "process response" steps are only called from within fetch finale. The flag setting doesn't need to be atomic</td></tr>
  <tr class="msg" id="L66"><td class="ts-cell"><a class="ts" href="#L66" alt="Tue Oct 12 2021 05:57:16 GMT-0700 (Pacific Daylight Time)">12:57</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: what ends up calling finalize in the integrity case?</td></tr>
  <tr class="msg" id="L67"><td class="ts-cell"><a class="ts" href="#L67" alt="Tue Oct 12 2021 05:58:08 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: the integrity algorithm itself once its done</td></tr>
  <tr class="msg" id="L68"><td class="ts-cell"><a class="ts" href="#L68" alt="Tue Oct 12 2021 05:58:21 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">you mean fetch finale</td></tr>
  <tr class="msg" id="L69"><td class="ts-cell"><a class="ts" href="#L69" alt="Tue Oct 12 2021 05:58:57 GMT-0700 (Pacific Daylight Time)">12:58</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">No, I meant finalize</td></tr>
  <tr class="msg" id="L70"><td class="ts-cell"><a class="ts" href="#L70" alt="Tue Oct 12 2021 05:59:56 GMT-0700 (Pacific Daylight Time)">12:59</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: right now, processing the body for the sake of integrity will call <code>finalize response</code> when it's done. but that would happen before the fetch finale, not in a race</td></tr>
  <tr class="msg" id="L71"><td class="ts-cell"><a class="ts" href="#L71" alt="Tue Oct 12 2021 06:01:19 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">the whole integrity sequence is done before fetch finale, so if the callback is attached in fetch finale, there is no race</td></tr>
  <tr class="msg" id="L72"><td class="ts-cell"><a class="ts" href="#L72" alt="Tue Oct 12 2021 06:01:42 GMT-0700 (Pacific Daylight Time)">13:01</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: if the callback is attached in fetch finale, how could it be invoked before?</td></tr>
  <tr class="msg" id="L73"><td class="ts-cell"><a class="ts" href="#L73" alt="Tue Oct 12 2021 06:02:10 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: it should not be invoked before. The callback is only valid for the actual response handling, not for verifying integrity</td></tr>
  <tr class="msg" id="L74"><td class="ts-cell"><a class="ts" href="#L74" alt="Tue Oct 12 2021 06:02:41 GMT-0700 (Pacific Daylight Time)">13:02</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: agreed, but finalize does need to run</td></tr>
  <tr class="msg" id="L75"><td class="ts-cell"><a class="ts" href="#L75" alt="Tue Oct 12 2021 06:03:04 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: it would run as the response body is read again inside <code>process response</code> or one of those</td></tr>
  <tr class="msg" id="L76"><td class="ts-cell"><a class="ts" href="#L76" alt="Tue Oct 12 2021 06:03:32 GMT-0700 (Pacific Daylight Time)">13:03</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: I don't think so, why?</td></tr>
  <tr class="msg" id="L77"><td class="ts-cell"><a class="ts" href="#L77" alt="Tue Oct 12 2021 06:04:16 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">ah I see what I've missed. the body is set by integrity and not read again</td></tr>
  <tr class="msg" id="L78"><td class="ts-cell"><a class="ts" href="#L78" alt="Tue Oct 12 2021 06:04:58 GMT-0700 (Pacific Daylight Time)">13:04</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">it's still not a race, fetch finale should finalize if body has already been read</td></tr>
  <tr class="msg" id="L79"><td class="ts-cell"><a class="ts" href="#L79" alt="Tue Oct 12 2021 06:05:10 GMT-0700 (Pacific Daylight Time)">13:05</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">That body read wouldn't trigger finalize either though, because finalize is only called by fetch finale and the network stack</td></tr>
  <tr class="msg" id="L80"><td class="ts-cell"><a class="ts" href="#L80" alt="Tue Oct 12 2021 06:06:16 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">And process response done only cares about the network stack being done, so finalize can be invoked by fetch finale if the network stack is already done. (Which I think is what I wrote down in my rather lengthy comment.)</td></tr>
  <tr class="msg" id="L81"><td class="ts-cell"><a class="ts" href="#L81" alt="Tue Oct 12 2021 06:06:49 GMT-0700 (Pacific Daylight Time)">13:06</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">ok, took me a while to process. got it now hopefully</td></tr>
  <tr class="msg" id="L82"><td class="ts-cell"><a class="ts" href="#L82" alt="Tue Oct 12 2021 06:08:38 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">process response done is something like "the latter between <code>fetch finale</code> and <code>network stack is done</code>, which are racy"</td></tr>
  <tr class="msg" id="L83"><td class="ts-cell"><a class="ts" href="#L83" alt="Tue Oct 12 2021 06:08:39 GMT-0700 (Pacific Daylight Time)">13:08</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell">Yeah, I want additional review for it as well as I noted. This stuff is not fun ðŸ™‚</td></tr>
  <tr class="msg" id="L84"><td class="ts-cell"><a class="ts" href="#L84" alt="Tue Oct 12 2021 06:09:10 GMT-0700 (Pacific Daylight Time)">13:09</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">I'm actually having fun</td></tr>
  <tr class="msg" id="L85"><td class="ts-cell"><a class="ts" href="#L85" alt="Tue Oct 12 2021 06:39:21 GMT-0700 (Pacific Daylight Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: ok my new version maybe handles it better. I have two flags, "network read complete" and "ready for clients", and only when both are set we dispatch "process response done"</td></tr>
  <tr class="msg" id="L86"><td class="ts-cell"><a class="ts" href="#L86" alt="Tue Oct 12 2021 06:39:59 GMT-0700 (Pacific Daylight Time)">13:39</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">they're not atomic as it's not really a thread issue. Body is read either before fetch finale (in integrity checking) or after (as a result of process response)</td></tr>
  <tr class="msg" id="L87"><td class="ts-cell"><a class="ts" href="#L87" alt="Tue Oct 12 2021 07:41:37 GMT-0700 (Pacific Daylight Time)">14:41</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: well, there are two "threads"</td></tr>
  <tr class="msg" id="L88"><td class="ts-cell"><a class="ts" href="#L88" alt="Tue Oct 12 2021 07:53:29 GMT-0700 (Pacific Daylight Time)">14:53</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: but the second "thread" only starts after we set the "ready for clients" flag, so it's not in a race</td></tr>
  <tr class="msg" id="L89"><td class="ts-cell"><a class="ts" href="#L89" alt="Tue Oct 12 2021 07:56:21 GMT-0700 (Pacific Daylight Time)">14:56</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:mozilla.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-8">Noam Rosenthal</span>: there's the fetch thread and there's the "receiving body bytes from the network" thread (and there's the main thread, which would be a third); I'm pretty sure the first two can race</td></tr>
  <tr class="msg" id="L90"><td class="ts-cell"><a class="ts" href="#L90" alt="Tue Oct 12 2021 08:17:21 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell"><span class="nick-12">annevk</span>: Ah I see, the network bytes keep running even if there is no "process response done". ok</td></tr>
  <tr class="msg" id="L91"><td class="ts-cell"><a class="ts" href="#L91" alt="Tue Oct 12 2021 08:17:31 GMT-0700 (Pacific Daylight Time)">15:17</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-8" title="@noamr:matrix.org">Noam Rosenthal</span>&gt;</div></td><td class="msg-cell">more fun</td></tr>

</tbody></table></div></div></div>
</body></html>