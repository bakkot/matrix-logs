<!DOCTYPE html><html><head>
  <title>WHATWG on 2024-04-03</title>
  <link rel="stylesheet" href="../style.css">
  <script>window.room = "WHATWG";</script><script src="../render-roomlist.js"></script>
  <script src="../logs.js"></script>
</head>
<body><div class="wrapper">
<div class="sidebar">
<div class="title">WHATWG<br>2024-04-03<br><a href="plaintext/">plaintext logs</a></div>
<div class="nav">
<a href="2024-04-02" class="nav-link"><span>prev</span></a>
<span style="float:right">next</span>
</div>
    <div class="all-rooms"><noscript>JavaScript is required to load the channel index, but you can go to <a href="../..">the static index</a> directly.</noscript></div>
<div class="footer"><a href="https://github.com/bakkot/matrix-archive-bot">source on github</a></div>
</div>
<div class="rhs">
<div class="rhs-header">
<span id="error" style="color: red; display:none">error</span>

<input type="text" id="query" size="25" placeholder="Search WHATWG">
<a id="search-submit" class="button icon-link" title="Search">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg>
</a>
</div>

<div class="log"><table id="log-table"><tbody id="log-tbody">

  <tr class="msg" id="L0"><td class="ts-cell"><a class="ts" href="#L0" alt="Tue Apr 02 2024 18:18:06 GMT-0700 (Pacific Daylight Time)">01:18</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-16" title="@timotijhof:matrix.org">Timo Tijhof</span>&gt;</div></td><td class="msg-cell"><mx-reply><blockquote> <p>I'm trying to preload requests for <code>&lt;script type=module src=â€¦&gt;</code> via the HTTP Link header.</p>
<p>I'm aware of, and have read, the past discussions around why <code>rel=modulepreload</code> was introduced separately instead of within rel=preload. As I understand it, module requests are made with a different CORS setting, plus by signalling the module type this way, browsers can do additional optimizations (e.g. look for indirect imports and preload those as well, and honouring import maps).</p>
<p>I'm also aware that at this time, there is no way to apply an import map to preloaded resources, which is fine, since the server-side in my case knows the flat and full list of "real" requests that will be made.</p>
<p>All that having been said, I can't seem to find in the spec what rel=preload incantation will result in the preloaded result being used by <code>&lt;script type=module&gt;</code>.</p>
<p>In Chrome, if I use <code>Link: &lt;/static/foo.js&gt;;rel=preload;as=script;crossorigin</code> it will correctly satisfy the later demand for <code>&lt;script type=module src=foo.js&gt;</code> by re-using the preload response (I can tell by the timing, the initiator, the order, and there not being a duplicat req).</p>
<p>In Firefox, it doesn't and there's instead a duplicate request made later on.</p>
</blockquote></mx-reply>I've comment at <a href="https://github.com/whatwg/html/issues/7854#issuecomment-2033368873">https://github.com/whatwg/html/issues/7854#issuecomment-2033368873</a> instead. Hoping I've missed something and that there is at least a way to do these "manually".</td></tr>
  <tr class="msg" id="L1"><td class="ts-cell"><a class="ts" href="#L1" alt="Tue Apr 02 2024 22:21:02 GMT-0700 (Pacific Daylight Time)">05:21</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-16">Timo Tijhof</span>: we were just discussing this case earlier in this channel; however, with the <code>crossorigin</code> attribute set it should in theory match up. Thinking about it again there's another thing however that set module scripts apart and maybe that's why Gecko doesn't reuse the cache. And that would make sense. Module scripts parse differently and so if you eagerly parse and don't store the original text you couldn't reuse the script as both classic and module script.</td></tr>
  <tr class="msg" id="L2"><td class="ts-cell"><a class="ts" href="#L2" alt="Tue Apr 02 2024 22:23:14 GMT-0700 (Pacific Daylight Time)">05:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">It felt like that thread had several good implementation bugs that should be filed. Although I can understand that discriminating between impl bugs vs impls following the spec could take some work.</td></tr>
  <tr class="msg" id="L3"><td class="ts-cell"><a class="ts" href="#L3" alt="Tue Apr 02 2024 22:23:18 GMT-0700 (Pacific Daylight Time)">05:23</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell">I guess that makes me lean towards only endorsing <code>modulepreload</code> for this, but I see you also need import maps at that level for that to be an okay solution. It's a bit unclear whether that should be prioritized or we should try to make <code>rel=preload type=module</code> be a thing as some kind of inbetweeny solution as well.</td></tr>
  <tr class="msg" id="L4"><td class="ts-cell"><a class="ts" href="#L4" alt="Tue Apr 02 2024 22:25:24 GMT-0700 (Pacific Daylight Time)">05:25</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell"><span class="nick-1">Domenic</span>: I only saw this Chrome/Firefox mismatch and if anything that's probably a specification bug for suggesting <code>rel=preload as=script</code> works for <code>type=module</code>. At least I'm quite convinced now that shouldn't work as it would rule out pre-parsing.</td></tr>
  <tr class="msg" id="L5"><td class="ts-cell"><a class="ts" href="#L5" alt="Tue Apr 02 2024 22:27:27 GMT-0700 (Pacific Daylight Time)">05:27</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">Firefox downloading bare imports seems bad. Safari not using module map to dedupe requests seems bad. Chrome downloading bare imports seems bad.</td></tr>
  <tr class="msg" id="L6"><td class="ts-cell"><a class="ts" href="#L6" alt="Tue Apr 02 2024 22:28:58 GMT-0700 (Pacific Daylight Time)">05:28</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">rel=preload as=script crossorigin seems like it should not work, although it might populate the HTTP cache. Maybe Chrome has some general request deduping happening; I suspect that's not a module specific problem. "Memory cache"??</td></tr>
  <tr class="msg" id="L7"><td class="ts-cell"><a class="ts" href="#L7" alt="Tue Apr 02 2024 22:30:23 GMT-0700 (Pacific Daylight Time)">05:30</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">That said I'm not sure the description is accurate since it includes the <code>&lt;script&gt;</code>. Some of the things &lt;a href="<span class="nick-12">https://matrix.to/#/@timotijhof:matrix.org"&gt;Timo</span> Tijhof&lt;/a&gt; ascribes to preload/modulepreload are almost certainly due to the <code>&lt;script&gt;</code></td></tr>
  <tr class="msg" id="L8"><td class="ts-cell"><a class="ts" href="#L8" alt="Tue Apr 02 2024 22:31:30 GMT-0700 (Pacific Daylight Time)">05:31</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-1" title="@domenicdenicola:matrix.org">Domenic</span>&gt;</div></td><td class="msg-cell">Safari behavior also looks so strange that I wonder if it's a DevTools issue.</td></tr>
  <tr class="msg" id="L9"><td class="ts-cell"><a class="ts" href="#L9" alt="Tue Apr 02 2024 23:50:58 GMT-0700 (Pacific Daylight Time)">06:50</a></td><td class="nick-cell"><div class="m-ov">&lt;<span class="nick nick-12" title="@annevk:matrix.org">annevk</span>&gt;</div></td><td class="msg-cell">Oh, I guess I should have read the Observations section more carefully.</td></tr>

</tbody></table></div></div></div>
</body></html>