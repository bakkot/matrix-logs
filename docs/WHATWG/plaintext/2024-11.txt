2024-11-01
[07:52:48.0378] <smaug>
Anyone understands what "If these attributes are omitted from an element, then the language of this element is the same as the language of its parent element, if any (except for slot elements in a shadow tree)." in the spec means? slot elements are somehow special cased, but it doesn't explain how?


2024-11-03
[23:57:48.0609] <annevk>
That language is not for implementers. Maybe it got out of sync with the implementer requirements?

[23:58:10.0042] <annevk>
As for `moveBefore()` and focus, I thought we decided not to do that? Did something change?

[02:21:13.0457] <Noam Rosenthal>
> <@annevk:matrix.org> As for `moveBefore()` and focus, I thought we decided not to do that? Did something change?

Ryosuke brought this up originally and it was left open, I suggested an additional alternative here that I think satisfies all the cases.


2024-11-04
[00:42:24.0190] <annevk>
Domenic: FYI: https://github.com/whatwg/dom/issues/1321

[00:43:46.0096] <annevk>
Noam Rosenthal: I don't get the impression he feels strongly about it. One point that was raised is that `moveBefore()` won't be state-preserving for accessibility as layout will be impacted.

[00:48:02.0681] <Noam Rosenthal>
> <@annevk:matrix.org> Noam Rosenthal: I don't get the impression he feels strongly about it. One point that was raised is that `moveBefore()` won't be state-preserving for accessibility as layout will be impacted.

I don‚Äôt exactly understand the a11y thing. Changing style can affect layout regardless of DOM structure changes

[00:48:53.0136] <Noam Rosenthal>
Re firing the events - sounds good, let‚Äôs start without like we said at WHATNOT and we can revise based on community feedback.

[04:40:15.0563] <Andreas Kling>
Anyone with HTML parsing know-how able to tell me if I'm missing something here or if this template/foreignObject interaction indeed leads to bugs? :) https://github.com/whatwg/html/issues/10739

[04:51:39.0438] <freddy>
Question about fetch metadata. It appears that all of the cases where page1.example is a) redirecting to page2.example, b) opening page2.example in a popup, c) navigating to page2.example - They are all done with Fetch Metadata of {sec-fetch-dest: document, sec-fetch-mode: navigate, sec-fetch-site: cross-site}. I wonder if it would be useful to have different or additional metadata for popups as they will include an opener reference (which the other cases don't). -- I am already fully aware that COOP exists which can control the popup case (but not make the browser tell beforehand)

[04:58:58.0011] <annevk>
Noam Rosenthal: well, in that we preserve state in the DOM tree, but for the a11y tree it'll be the same as remove/insert.

[05:00:39.0169] <annevk>
freddy: there's a popup proposal in the Fetch Metadata repo, been there since forever

[05:00:54.0139] <annevk>
Andreas Kling: I'll have a look, but your best bet would be hsivonen or zcorpan I suspect

[05:01:57.0471] <freddy>
annevk: great minds think alike, huh

[05:04:55.0086] <hsivonen>
Andreas Kling: Likely a spec bug

[05:05:26.0991] <Noam Rosenthal>
> <@annevk:matrix.org> Noam Rosenthal: well, in that we preserve state in the DOM tree, but for the a11y tree it'll be the same as remove/insert.

Right. 

[05:09:15.0841] <annevk>
Andreas Kling: given that it checks for a template element on the stack of open elements, I'm inclined to think that's inclusive of a namespace and therefore it wouldn't find any element

[05:09:52.0982] <annevk>
Andreas Kling: as whenever the HTML specification talks about elements that's about a particular identity derived from local name and namespace

[05:10:13.0476] <annevk>
hsivonen: ^^

[05:11:16.0882] <hsivonen>
annevk: I recall there having been a bug on this theme previously. (Part of how the combination of the introduction of SVG on one hand and template on the other resulted in a bunch of bugs.)

[05:11:46.0413] <hsivonen>
annevk: But it's indeed possible that the spec language is defined in a way that implies the HTML namespace on the stack.

[05:34:18.0630] <Andreas Kling>
Ohhh, interesting! We've indeed implemented stack checks as "is this tag name present on the stack", but we're ignoring the namespace

[05:56:52.0356] <annevk>
I wonder if one could put something on the stack with a namespace prefix. I suspect not as the stack is controlled by the HTML parser.

[05:58:49.0446] <zcorpan>
> <@annevk:matrix.org> I wonder if one could put something on the stack with a namespace prefix. I suspect not as the stack is controlled by the HTML parser.

No. Though some attributes can have a namespace prefix

[06:02:05.0989] <zcorpan>
Hmm, the inconsistency in the spec with when namespaces are explicit isn't ideal. See https://html.spec.whatwg.org/#has-an-element-in-scope (and the next few "in foo scope" definitions)

[06:03:47.0804] <zcorpan>
Andreas Kling: https://html.spec.whatwg.org/#xml
> Except where otherwise stated, all elements defined or mentioned in this specification are in the HTML namespace ("http://www.w3.org/1999/xhtml"), and all attributes defined or mentioned in this specification have no namespace.


2024-11-05
[23:16:25.0790] <Sam Sneddon [:gsnedders]>
what in the HTML spec defines that `setTimeout(function(x){ alert(1) }, 10000); window.location = "about:blank"` won't actually create that alert after 10s? is this just step 1 of the in parallel section of https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#run-steps-after-a-timeout?

[23:17:24.0403] <annevk>
Sam Sneddon [:gsnedders]: I think the task will be associated with a document that's not fully active and thus will be skipped in the event loop processing model

[23:19:00.0712] <annevk>
Perhaps "cannot show simple dialogs" should also have a fully active check though. Not sure what happens if you run `alert()` on a window of a removed nested document.

[23:20:33.0149] <annevk>
https://software.hixie.ch/utilities/js/live-dom-viewer/saved/13247 suggests we should probably add that check.

[23:24:32.0219] <annevk>
Filed https://github.com/whatwg/html/issues/10742

[23:24:48.0775] <Sam Sneddon [:gsnedders]>
My actual context here, FWIW, is figuring out what should happen if you do WebDriver's `session.execute_async_script("setTimeout(arguments[0], 10000); window.location = 'about:blank'")`, and whether that is actually well-defined.

[23:25:23.0302] <Sam Sneddon [:gsnedders]>
Where most of my question is about whether it's well-defined whether setTimeout actually calls its handler.

[23:25:39.0722] <Sam Sneddon [:gsnedders]>
 * Thus my question here is mostly where it's defined where the handler is called.

[23:28:00.0215] <annevk>
Which handler?

[23:37:24.0770] <Sam Sneddon [:gsnedders]>
the TimerHandler (the first argument to `setTimeout`)

[23:39:05.0924] <annevk>
I think that's well-defined along the lines I said above, yes.

[01:20:40.0251] <zcorpan>
annevk: is the iteration order of the inclusive ancestors undefined in https://dom.spec.whatwg.org/#ref-for-concept-tree-inclusive-ancestor%E2%91%A1 ?

[08:48:04.0577] <TabAtkins>
Correct, there's no predefined order for inclusive ancestors, the spec needs to specify whether it's top-down or bottom-up

[10:02:21.0293] <annevk>
Yeah, that should say something about order.


2024-11-06
[04:56:12.0477] <zcorpan>
I filed an issue

[06:05:13.0949] <annevk>
Nice, anyone want to fix it? Good exercise if you're new to standards.


2024-11-07
[00:50:20.0343] <annevk>
Anyone here signed up for bsky.app? I'm @annevk.nl.

[01:29:48.0990] <zcorpan>
:target and text fragments only work for the first page load if the element or text is available before onload. If the content is created from a `fetch()` + script, that can happen after onload. Should we have an explicit API to delay the load event, or to go "try again now to hash-navigate" ?

[01:46:53.0758] <annevk>
Hmm, `fetch()` normally delays the `load` event as well I think, but of course not if you use it after it. Perhaps what you suggest is okay within some timeout, but it doesn't seem generally okay.

[02:19:00.0155] <sideshowbarker>
zcorpan: Given the following WPT test case:

```html
<img title="title" data-expectedlabel="title" alt="" data-testname="img with tooltip label with empty alt" class="ex" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
```
‚Ä¶and given the spec requirements at https://w3c.github.io/html-aam/#img-element-accessible-name-computation ‚Äî specifically this requirement:
> *Otherwise use `alt` attribute, even if its value is the empty string.*
‚Ä¶then it seems that the expectation for that test should be the empty string.
But as you case, instead the expectation is `title` (from the `title` attribute value).
And https://wpt.fyi/results/accname/name/comp_tooltip.html shows that all engines pass that test.
So it seems like they‚Äôre all violating that _‚Äúuse `alt` attribute, even if its value is the empty string‚Äù_ spec requirement.

[02:19:22.0610] <sideshowbarker>
 * zcorpan: Given the following WPT test case:

```html
<img title="title" data-expectedlabel="title" alt="" data-testname="img with tooltip label with empty alt" class="ex" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
```

‚Ä¶and given the spec requirements at https://w3c.github.io/html-aam/#img-element-accessible-name-computation ‚Äî specifically this requirement:

> _Otherwise use `alt` attribute, even if its value is the empty string._

 ‚Ä¶then it seems that the expectation for that test should be the empty string.
But as you case, instead the expectation is `title` (from the `title` attribute value).
And https://wpt.fyi/results/accname/name/comp\_tooltip.html shows that all engines pass that test.
So it seems like they‚Äôre all violating that _‚Äúuse `alt` attribute, even if its value is the empty string‚Äù_ spec requirement.

[02:19:56.0103] <sideshowbarker>
Or else, is there something I‚Äôm misunderstanding?

[02:20:31.0924] <sideshowbarker>
 * zcorpan: Given the following WPT test case:

```html
<img title="title" data-expectedlabel="title" alt="" data-testname="img with tooltip label with empty alt" class="ex" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
```

‚Ä¶and given the spec requirements at https://w3c.github.io/html-aam/#img-element-accessible-name-computation ‚Äî specifically this requirement:

> _Otherwise use `alt` attribute, even if its value is the empty string._

‚Ä¶then it seems that the expectation for that test should be the empty string.
But as you can ses, instead the expectation is `title` (from the `title` attribute value).
And https://wpt.fyi/results/accname/name/comp\_tooltip.html shows that all engines pass that test.
So it seems like they‚Äôre all violating that _‚Äúuse `alt` attribute, even if its value is the empty string‚Äù_ spec requirement.

[02:20:39.0946] <sideshowbarker>
 * zcorpan: Given the following WPT test case:

```html
<img title="title" data-expectedlabel="title" alt="" data-testname="img with tooltip label with empty alt" class="ex" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
```

‚Ä¶and given the spec requirements at https://w3c.github.io/html-aam/#img-element-accessible-name-computation ‚Äî specifically this requirement:

> _Otherwise use `alt` attribute, even if its value is the empty string._

‚Ä¶then it seems that the expectation for that test should be the empty string.
But as you can see, instead the expectation is `title` (from the `title` attribute value).
And https://wpt.fyi/results/accname/name/comp\_tooltip.html shows that all engines pass that test.
So it seems like they‚Äôre all violating that _‚Äúuse `alt` attribute, even if its value is the empty string‚Äù_ spec requirement.

[02:31:04.0588] <Noam Rosenthal>
> <@zcorpan:mozilla.org> :target and text fragments only work for the first page load if the element or text is available before onload. If the content is created from a `fetch()` + script, that can happen after onload. Should we have an explicit API to delay the load event, or to go "try again now to hash-navigate" ?

Wouldn't this allow delaying the load event indefinitely and various similar footguns?

[02:57:51.0179] <annevk>
I think that's possible in theory already as the specification doesn't have network timeouts. But yeah, I'm not entirely convinced the load event is the correct primitive to build more upon.

[03:03:20.0892] <zcorpan>
Noam Rosenthal: yes

[03:03:37.0051] <zcorpan>
though the "try now" API doesn't

[03:04:07.0844] <zcorpan>
annevk: await res.json() doesn't delay

[03:05:10.0938] <sideshowbarker>
zcorpan: Ah wait I see: https://w3c.github.io/accname/#step2E says:
> E. Host Language Label: Otherwise, if the current node's native markup provides an attribute (e.g. alt) or element (e.g. HTML label or SVG title) that defines a text alternative, return that alternative in the form of a flat string as defined by the host language, **unless the element is marked as presentational (role="presentation" or role="none").**

‚Ä¶`<img alt="">` is `role="presentation"`

[03:08:02.0323] <zcorpan>
sideshowbarker: somewhat action at a distance

[03:09:17.0679] <zcorpan>
annevk: actually where does the spec say to delay the load event for `fetch()`?

[04:54:46.0592] <annevk>
zcorpan: it's prolly an open issue? At least I was under the impression that most fetches initiated before `load` fires end up delaying the `load` event, but maybe `fetch()` is somehow exempted?

[05:31:52.0110] <zcorpan>
annevk: I think https://searchfox.org/mozilla-central/search?q=symbol:_ZN7mozilla3dom8Document13UnblockOnloadEb&redirect=false is relevant for gecko. Includes e.g. fonts but not `fetch()` afaict

[05:49:49.0799] <Noam Rosenthal>
> <@annevk:matrix.org> zcorpan: it's prolly an open issue? At least I was under the impression that most fetches initiated before `load` fires end up delaying the `load` event, but maybe `fetch()` is somehow exempted?

In HTML this is explicitly specified for each operation that delays the load event, there's nothing general for fetches

[05:59:09.0736] <annevk>
Noam Rosenthal: I know, but I'm pretty sure we discovered holes in that model

[05:59:51.0900] <Noam Rosenthal>
> <@annevk:matrix.org> Noam Rosenthal: I know, but I'm pretty sure we discovered holes in that model

OK gotcha

[12:19:10.0246] <smaug>
jarhar: just looking at the patches... which one defines what select::picker(select) maps to?  

[13:13:46.0804] <jarhar>
are you talking about the chromium implementation? if so, this is it: https://chromium-review.googlesource.com/c/chromium/src/+/5817433

[13:26:26.0795] <Dominic Farolino>
annevk smaug: We didn't get to it on the WHATNOT agenda today, but we were hoping to discuss graduating `moveBefore()` to stage 3 ‚Äî what do you think? I've marked the DOM PR as ready to review.

[13:27:28.0286] <smaug>
spec prs

[13:28:05.0990] <smaug>
Well, I look at the diff views, and the many prs are split to quite a few diffs 

[13:28:37.0002] <smaug>
From implementation point of view I need to still check session history handling, that is the most worrisome to me

[13:31:22.0920] <smaug>
Like if you have iframes, and you navigate all them multiple times. Now you reorder the iframe elements and load some more pages to them. Then load a new top level page in a way which doesn't put the first top level page to bfcache. Then go back to the first top level page. What gets loaded to which iframe?

[13:45:08.0757] <smaug>
Somewhat related to my ancient testcase http://mozilla.pettay.fi/moztests/history2/Start.html Chrome's behavior there is quite surprising, but at least it doesn't load the url to a wrong iframe anymore

[14:31:35.0807] <smaug>
Dominic Farolino: hmm, I thought removing mutation events would still block moveBefore. Though that shouldn't block moving to stage 3, only shipping.

[14:58:16.0771] <jarhar>
here is the css part https://github.com/w3c/csswg-drafts/pull/10865

[14:58:28.0515] <jarhar>
and here is the html part https://github.com/whatwg/html/pull/10629


2024-11-08
[16:26:40.0372] <Dominic Farolino>
smaug: I think mutation events were already removed: https://github.com/whatwg/html/pull/10573. But yes I agree, shouldn't block stage 3.

[16:27:34.0109] <smaug>
(Implementations haven't removed mutation events)

[16:28:49.0168] <smaug>
 * (Implementations haven't removed mutation events, https://github.com/whatwg/dom/issues/305#issuecomment-2306411923)

[18:58:57.0817] <sideshowbarker>
(for those who care about the document-conformance/authoring parts of the requirements in the spec) https://github.com/whatwg/html/pull/10752

[23:15:46.0286] <annevk>
push-api apparently allows (and enforces in certain cases) wrapping after an equals sign of an attribute. That's a new one.

[00:07:19.0684] <Sacha Greif>
hi all! I'm the main guy who runs the State of JS/CSS/etc. surveys. Always happy to get feedback to help make them more helpful for the community :)

[00:36:54.0430] <annevk>
keithamus: heya, I could make time today for https://github.com/whatwg/html/pull/9841, but I was wondering if you could squash all the commits and rebase on top of main as there are conflicts at the moment

[00:38:07.0035] <annevk>
keithamus: I also see some minor issues such as wrapping before a closing tag (`</code></dfn>`) and indentation beyond the start tag on the preceding line that you might want to tackle while doing that?

[00:40:38.0508] <annevk>
WPT PR is also out-of-date it seems

[00:40:51.0683] <keithamus>
annevk: sure, I‚Äôm just about to get on the road but in about an hour I‚Äôll update both spec and wpt pr 

[03:04:25.0020] <annevk>
keithamus: oh I see that in August 27 I also expressed confusion as to how this event could work. That comment was never addressed.

[03:05:39.0168] <annevk>
I'm also once again confused at the compatibility story we ended up with around potentially changing the default of button type. Trying to find the relevant minutes...

[03:12:46.0535] <annevk>
Found it: https://github.com/whatwg/html/issues/10441

[03:13:41.0337] <annevk>
keithamus: so what I think I'm missing is changes to the `button` element `type` attribute reflection that take that into account

[03:14:24.0571] <annevk>
keithamus: in that we want the `type` getter to return `button` when the `button` element has `command` and `commandfor` attributes

[03:18:28.0443] <annevk>
It's a bit subtle as the `type` getter can mismatch with the actual state, but that seems okay-ish.

[03:23:23.0909] <keithamus>
Okay, apologies I thought we resolved the other way around. So we want the button to _not_ be a submit button if it has `command` or `commandfor`? It should be in the `button` state.

[03:25:20.0653] <annevk>
keithamus: I suspect the easiest way to do this is to introduce a Maybe Button state. The type getter would return "button" in that state. When associated with a form the button wouldn't work and when outside a form it would act like a button.

[03:25:46.0940] <annevk>
So I think behavior-wise it's pretty much what you have, except that it doesn't account for the `type` getter.

[03:26:55.0806] <ljharb>
so i could have a type submit that isn't a submit button? O.o that seems bad

[03:27:05.0427] <ljharb>
 * so i could have an explicit type submit that isn't a submit button? O.o that seems bad

[03:27:06.0777] <annevk>
And then I think there's the separate question of what should happen when type is set to submit or reset and you have these command/commandfor attributes. Perhaps in that case the command/commandfor attributes are to be ignored? Luke Warlow was looking at this for popover at some point.

[03:27:33.0567] <ljharb>
 * so i could have an explicit type submit that isn't a submit button? O.o that seems bad (when no `type` is provided, anything that lets it default to `button` is an improvement, defaulting to `submit` is painful)

[03:27:53.0302] <annevk>
ljharb: the problem is that `<button>` defaults to being a submit button, which is not necessarily great for new use cases.

[03:28:15.0935] <ljharb>
right - it's a very bad default, and when `type` is omitted, i think it's totally fine to quietly make it `button` when it has a new attribute

[03:28:34.0169] <ljharb>
but if i explicitly put `type="submit"` then violating that seems bad to me

[03:28:44.0003] <annevk>
Yeah agreed.

[03:29:40.0661] <ljharb>
(i just learned about command/commandFor recently, btw, and it seems very cool - is there a polyfill anywhere for its behavior?)

[03:30:23.0123] <annevk>
(The main reason why we're not defaulting to button inside a form immediately is because of backwards compatibility with browsers where it would submit the form. But five years from now or so we can change that as well.)

[03:30:49.0762] <keithamus>
> <@ljharb:matrix.org> (i just learned about command/commandFor recently, btw, and it seems very cool - is there a polyfill anywhere for its behavior?)

https://github.com/keithamus/invokers-polyfill is what I have so far

[03:34:47.0750] <keithamus>
> <@annevk:matrix.org> And then I think there's the separate question of what should happen when type is set to submit or reset and you have these command/commandfor attributes. Perhaps in that case the command/commandfor attributes are to be ignored? Luke Warlow was looking at this for popover at some point.

So I think if the button is explicit submit and has commandfor/command we should make it submit, ignore the command stuff, and browsers can log a warning to the console telling the user they've made a mistake

[03:35:02.0176] <keithamus>
The other choice is to not do either behaviour (submit nor command/commandfor)

[03:37:40.0600] <annevk>
Agreed, I just wrote that down in https://github.com/whatwg/html/issues/9625#issuecomment-2464496320

[03:45:17.0549] <keithamus>
annevk: how would I type the command attribute state? (Trying to address https://github.com/whatwg/html/pull/9841/files#r1834138912). It's not a string, I presume (it's an enum in the impls).

[03:46:34.0524] <annevk>
keithamus: in HTML it's a string, unless you introduced a concept that only contains the relevant string values, in which case you could use that concept, but I don't think that exists

[03:46:54.0038] <keithamus>
okay great I'll use a string

[03:47:02.0880] <annevk>
Oh wait, the state hmm

[03:47:15.0343] <annevk>
I was thinking the actual value

[03:48:17.0227] <annevk>
keithamus: hmm maybe it's easier to just pass in the element that has the attribute or some such

[03:48:39.0652] <keithamus>
oh yeah okay

[03:49:22.0673] <keithamus>
hmm... but an event is dispatched before the steps are called so referencing the element might be bad, it could change during the event phase...

[03:52:29.0108] <annevk>
keithamus: maybe just do state _state_ for now then. And don't talk about it being in a state, but being a state. "If command is the Close or Show Modal state, then return true."

[05:48:48.0202] <Noam Rosenthal>
Why would reordering them change anything spec-wise?

[05:49:34.0640] <Noam Rosenthal>
This seems like an implementation concern. I couldn't find anything in the spec that would be problematic because of this, and we've added pretty good test coverage for this type of scenario (though there could always be more)

[05:49:47.0863] <Noam Rosenthal>
Dominic Farolino did the iframe work though so perhaps I'm missing something.

[07:28:36.0749] <annevk>
Ms2ger: one thing that needs to be done for https://github.com/whatwg/html/pull/9893 is filling out OP. Having a clear proposed commit message there, ideally outlining some of the design, test strategy, impl bugs, MDN coverage, etc. goes a long way to making reviewing easier.

[07:29:01.0136] <Ms2ger>
Will do, thanks for the reminder

[07:34:17.0436] <annevk>
That also makes it scary, but I'll have another look anyway as it's been a long time.

[07:36:40.0052] <annevk>
Hmm, I remember we had a discussion before about renaming all the "concepts" to "principal concepts" not being great.

[07:52:50.0985] <annevk>
Ms2ger: hopefully I gave you a few things to look into. Overall this still looks good and I guess impl/TC39-wise it's more accepted now so maybe this can be done soonish modulo the massive number of needed PRs that it appears you all have signed up for...

[07:59:06.0334] <Noam Rosenthal>
> <@smaug:mozilla.org> (Implementations haven't removed mutation events)

It should be trivial to not fire them during moveBefore though, and they‚Äôre not in the spec  

[08:09:44.0292] <annevk>
(Oh and it seems that Shannon Booth from Ladybird also has some good ShadowRealm feedback.)

[08:14:15.0050] <Ms2ger>
Thanks again, I think :)

[11:30:03.0150] <Dominic Farolino>
There's nothing in the spec that's problematic regarding to this simply because the spec doesn't handle (at all) what we've referred to colloquially as the session history re-parenting issue ‚Äî i.e., the case where upon going back to a non-bfcached page, the browser tries to reconcile the structure of the DOM with the structure of the nested session history, and load the latest nested session history items into the corresponding iframes.

[11:34:19.0773] <Dominic Farolino>
So first, that's bad in general. But I don't think it intersects too much with moveBefore(). moveBefore() doesn't change the order of the iframes from the perspective of the browser process, session history, or other iframes that can reach these iframes via proxies. That is, it doesn't re-order window.frames: https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/web_tests/external/wpt/dom/nodes/moveBefore/tentative/iframe-document-preserve.window.js;l=110-116;drc=0ba2bf02d3c2d6bf52c53012cdb5993b50ba82ed

[11:35:35.0564] <Dominic Farolino>
 * So first, that's bad in general. But I don't think it intersects too much with moveBefore(). moveBefore() doesn't change the order of the iframes from the perspective of the browser process, session history, or other iframes that can reach the moved iframes via proxies. That is, it doesn't re-order window.frames: https://source.chromium.org/chromium/chromium/src/+/main:third\_party/blink/web\_tests/external/wpt/dom/nodes/moveBefore/tentative/iframe-document-preserve.window.js;l=110-116;drc=0ba2bf02d3c2d6bf52c53012cdb5993b50ba82ed

[11:36:45.0251] <Dominic Farolino>
So I think navigating backwards to the non-bfcached top-level page should behave the same as it would be if said page did not use moveBefore() before it was navigated away.

[11:38:28.0042] <Dominic Farolino>
> <@smaug:mozilla.org> (Implementations haven't removed mutation events, https://github.com/whatwg/dom/issues/305#issuecomment-2306411923)

smaug: Implementations must disable mutation events when this API runs: https://github.com/web-platform-tests/wpt/blob/master/dom/nodes/moveBefore/tentative/mutation-events.html. We can't spec it because mutation events don't exist in DOM, but we've tested it. either way, yeah I don't think this blocks stage 3 or shipping.

[11:45:34.0781] <Dominic Farolino>
Domenic: I've looked but I can't find a bug tracking the iframe session history reparent/restoration problem. Do you know if one exists? This is the case where you navigate backwards to a top-level non-bfcached page with iframes, and try and reconcile the page's iframe structure with the nested iframe history structure, to load the latest iframe history entries in the page's iframes..

[11:45:36.0261] <smaug>
have you tested session history?

[11:46:02.0664] <smaug>
(you have üôÇ )

[11:46:33.0103] <smaug>
 * (you have üôÇ ,  or at least have thought about it)

[12:49:00.0463] <Noam Rosenthal>
smaug: both session history reparenting and mutation events are important/interesting things to consider for implementation but they're both also not in the HTML standard... given that I'm a bit confused about the level of expectations here in terms of spec/interop, apart from each implementation having internal tests to make sure things stay sane

[12:50:59.0977] <smaug>
session history is in HTML spec, and seems like moveBefore may change its behavior 

[12:52:18.0452] <Noam Rosenthal>
> <@smaug:mozilla.org> session history is in HTML spec, and seems like moveBefore may change its behavior

It doesn't though. As I said earlier, there are no places in the HTML spec that `moveBefore` changes. We have looked at it in pretty deeply... if you find a place where it does please be specific

[12:52:37.0192] <Noam Rosenthal>
> <@smaug:mozilla.org> session history is in HTML spec, and seems like moveBefore may change its behavior

 * It doesn't though. As I said earlier, there are no places in the HTML spec around session history that `moveBefore` changes. We have looked at it in pretty deeply... if you find a place where it does please be specific

[12:52:53.0848] <smaug>
Well, it may break the behavior, let's say so.

[12:54:19.0711] <Noam Rosenthal>
> <@smaug:mozilla.org> Well, it may break the behavior, let's say so.

Again, please be specific. The behavior that it might break that you've mentioned before around session history reparenting is not a standardized part of session history traversal AFAIK

[12:55:11.0964] <smaug>
Well, there hasn't been any need for "reparenting" before

[12:55:18.0375] <Noam Rosenthal>
We've tested that `moveBefore` doesn't reorder `window.frames`, and some of the places in the spec collect `navigables` in tree order

[12:55:20.0033] <smaug>
This is a new thing caused by moveBefore

[12:56:20.0930] <smaug>
Ok, and if you go back to a page which had iframes reordered, what gets restored to iframes?

[12:57:04.0494] <Noam Rosenthal>
No change from before I guess?

[12:58:28.0994] <Noam Rosenthal>
For this kind of bug to occur you need to save the tree order of navigables somehow separate from the tree order of frames and have them out of sync due to `moveBefore`. I can see how a bug like that might occur in implementation but not in the spec

[12:59:50.0599] <Noam Rosenthal>
(Again, this goes back to auto iframe-restore, which is a non-standard part of session history)

[13:01:49.0194] <Noam Rosenthal>
> <@smaug:mozilla.org> Ok, and if you go back to a page which had iframes reordered, what gets restored to iframes?

Basically what Dominic Farolino said here: https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$rHZhhjwPPuncfjugC0qAqEA-krbyzprbnNf6LF7Vk9E?via=matrix.org&via=mozilla.org&via=igalia.com

[13:01:49.0666] <smaug>
ok, I guess if window.frames doesn't change, this might not be as big issue

[13:02:30.0967] <smaug>
oh, Element had hidden those messages well from me

[13:36:58.0332] <Dominic Farolino>
haha no worries. Yeah I understand the concern here, but I think from the perspective of things outside of the local DOM inside of the Document that experienced the moveBefore, nothing changes regarding child frame order, including in session history.

[15:02:11.0660] <sideshowbarker>
PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script and the build fails with an *‚Äúld: library 'System' not found‚Äù* error (in the Rust part of the build), the run the build script like this:
```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib \
./build.sh
```
‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or wherever).

[15:02:50.0649] <sideshowbarker>
 * PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script and the build fails with an _‚Äúld: library 'System' not found‚Äù_ error (in the Rust part of the build), the run the build script like this:

```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib" \
./build.sh
```

‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or wherever).


2024-11-09
[19:03:53.0945] <sideshowbarker>
PSA: PR to change all current `data-x="syntax-attributes"` usage (that is, the syntax for attribute declarations in markup) from *‚Äúattribute‚Äù* to *‚Äúattribute declaration‚Äù*. 

[19:04:00.0244] <sideshowbarker>
 * PSA: PR to change all current `data-x="syntax-attributes"` usage (that is, the syntax for attribute declarations in markup) from _‚Äúattribute‚Äù_ to _‚Äúattribute declaration‚Äù_. https://github.com/whatwg/html/pull/10756

[19:05:07.0911] <sideshowbarker>
 * PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script and the build fails with an _‚Äúld: library 'System' not found‚Äù_ error (in the Rust part of the build), then (re)run the build script like this:

```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib" \
./build.sh
```

‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or wherever).

[19:05:20.0538] <sideshowbarker>
 * PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script and the build fails with an _‚Äúld: library 'System' not found‚Äù_ error (in the Rust part of the build), then (re)run the build script like this:

```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib" \
./build.sh
```

‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or such).

[19:05:47.0432] <sideshowbarker>
 * PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script and the build fails with an _‚Äúld: library 'System' not found‚Äù_ error (in the Rust part of the build), then to fix that problem, (re)run the build script like this:

```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib" \
./build.sh
```

‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or such).

[19:06:03.0187] <sideshowbarker>
 * PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script, the build fails with an _‚Äúld: library 'System' not found‚Äù_ error (in the Rust part of the build), then to fix that problem, (re)run the build script like this:

```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib" \
./build.sh
```

‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or such).

[19:06:14.0256] <sideshowbarker>
 * PSA: If your environment is macOS and you‚Äôre working on an HTML spec PR and when you try to run the `./build.sh` script, the build fails with an _‚Äúld: library 'System' not found‚Äù_ error (in the Rust part of the build)¬†‚Äî then to fix that problem, (re)run the build script like this:

```
PATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib:$PATH \
LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib" \
./build.sh
```

‚Ä¶or else just export those `PATH` and `LIBRARY_PATH` settings to your environment (e.g., in your `~/.bashrc` or such).


2024-11-11
[01:25:43.0879] <She ‚ÄúNadya‚Äù Nah>
@sideshowbarker:matrix.org¬†


2024-11-12
[09:06:10.0938] <Dominic Farolino>
Dumb question but `no-cors` requests never trigger preflights, right?

[09:12:34.0418] <Noam Rosenthal>
Right


2024-11-13
[22:36:08.0951] <annevk>
Possibly Private/Local Network Access changes this? Been a while since I looked.

[02:37:45.0891] <Noam Rosenthal>
Yes, there are special preflights for PNA: https://developer.chrome.com/blog/private-network-access-preflight#preflight_requests

[02:59:28.0706] <Jake Archibald>
annevk: Safari blocks http localhost iframes inside https pages. Chrome and Firefox don't. Given that localhost should be treated as secure, this seems like a bug. Am I missing something?

[03:00:58.0730] <Jake Archibald>
https://bumpy-repeated-cover.glitch.me/ - quick test page, but you'll need to run a local server on 8080 that contains `index2.html`

[03:09:33.0702] <annevk>
Jake Archibald: we currently don't enforce that localhost is localhost, that's something we need to fix still

[03:10:36.0598] <Jake Archibald>
annevk: Oh, so is `127.0.0.1` likely to work?

[03:12:30.0797] <Jake Archibald>
ah, no, that doesn't work either

[03:34:04.0527] <annevk>
Hmm, that does seem like something that might be easier to fix. Are you willing to file a bug for just that? (There already are some for localhost.)

[03:52:16.0412] <Jake Archibald>
From https://bugs.webkit.org/show_bug.cgi?id=171934#c96, it seems like it's a difference of opinion with webappsec. I added a couple of comments about our use-case

[05:31:12.0756] <annevk>
Oh right. I had forgotten about P/LNA. Makes sense. Although I wonder if P/LNA still contains localhost protection.

[06:38:03.0514] <Dominic Farolino>
So smaug annevk what do you we think about stage 3 for atomic move? I'm sure there are small things that will fall out during review, but I think generally we agree on the shape of the processing model?

[06:45:59.0143] <smaug>
I think it needs another round of reviews, given that there were some rather obvious issues still couple of days ago.

[06:46:50.0003] <Dominic Farolino>
smaug: One of the comments is waiting on your feedback I believe

[06:46:58.0315] <Dominic Farolino>
(range updates)

[06:48:00.0264] <smaug>
sure, the range/selection part. But things like not handling Shadowroot or having wrong assumptions how ranges work were a bit surprising

[06:48:16.0896] <Dominic Farolino>
How do you feel about https://github.com/whatwg/dom/pull/1307#discussion_r1838738862

[06:48:26.0125] <Dominic Farolino>
Right, I don't think stage 3 is "all bugs are fixed" heh

[06:48:26.0257] <smaug>
...which is why I'd prefer another round of reviews

[06:49:01.0084] <Dominic Farolino>
OK, I'd appreciate your thoughts on https://github.com/whatwg/dom/pull/1307#discussion_r1838738862: keeping the container preservation approach except for when we cross the shadow boundary

[06:49:38.0663] <Dominic Farolino>
Or do you feel pretty set on not doing nothing special for Ranges during moveBefore() (treating them like remove + insert instead)

[06:49:56.0757] <Dominic Farolino>
The downside of that is that we never preserve selection if the selection range's endpoints move around

[06:50:15.0989] <Dominic Farolino>
Not the end of the world, but "better" selection preservation feels nice

[06:51:12.0848] <smaug>
That is a bit tricky one. In case of implementation supporting multiple ranges in selection, or using live ranges for highlights, some ranges might survive the move, and some wouldn't

[06:51:19.0814] <smaug>
it might lead to a it surprising results

[06:53:10.0740] <smaug>
 * it might lead to a bit surprising results

[06:53:47.0094] <Dominic Farolino>
Do any implementations support multiple ranges that contribute to a selection? I don't think that's allowed: https://w3c.github.io/selection-api/#responding-to-dom-mutations:~:text=Each%20selection%20can%20be%20associated%20with%20a%20single%20range

[06:53:59.0058] <smaug>
Gecko supports multiple ranges

[06:54:29.0192] <smaug>
(and other implementers have every now and then said it would be nice to support)

[06:55:45.0154] <Dominic Farolino>
Hmm, that feels like something we could deal with it if were to become standardized. Until then, I guess it's an implementation-specific thing to work around. I'd hate to make a decision about moveBefore() because of non-standardized impl quirks that we can't think through because we don't have a spec.

[06:55:48.0317] <smaug>
But hightlight anyhow supports multiple ranges

[06:56:16.0414] <smaug>
So, whether or not selection supports multiple ranges isn't too relevant here.

[06:59:37.0717] <Dominic Farolino>
OK so your concern is that if we only preserved selection when it is entirely inside a moved container node, then some ranges in a highlight will get reset, and others will survive, right?

[07:00:14.0448] <Dominic Farolino>
 * OK so your concern is that if we only preserved selection when it is entirely inside a moved container node, then some ranges in a highlight will get reset (in the same way they do during `remove()`), and others will completely survive, right?

[07:00:17.0939] <smaug>
Right. And that would be quite surprising, I think.

[07:00:22.0103] <Dominic Farolino>
I.e., that would be surprising

[07:01:13.0139] <Dominic Farolino>
How about the more aggressive preservation tactic where we *always* try and preserve the range (by allowing its start/end containers to move via moveBefore) ‚Äî unless the start/end get inverted, in which case we collapse the range

[07:01:40.0519] <Dominic Farolino>
I think that could still lead to some cases where some ranges survive and others get collapsed, but it feels a little more predictable since you know your start and end containers, maybe?

[07:02:01.0019] <Dominic Farolino>
(and start/end being inverted -> resulting in collapse feels pretty expected)

[07:02:04.0513] <smaug>
or if we move something across light/shadow trees...

[07:02:32.0373] <Dominic Farolino>
yeah... it does get complicated

[07:03:25.0540] <Dominic Farolino>
We could punt on this (don't handle Ranges specially during moveBefore()) until maybe users decide they care enough...

[07:05:50.0902] <smaug>
That might be easier for now. And if needed, add later some options to moveBefore. 

[07:07:34.0591] <Dominic Farolino>
I'd like to (& framework authors agree) avoid a bag of options for the API in the future if possible. So if we decide to change this in the future, I'd really try and shoot for just changing the behavior inside this API straight-up

[07:17:56.0917] <smaug>
That might be doable. One might be able to also provide some helper APIs for Range to move it around from one subtree to another (or in moveBefore case, re-initialize the old state after move).

[07:28:01.0222] <Noam Rosenthal>
We generally preserve element-specific state (frame window, focus, animation, dialog/fullscreen/popover), I think it makes sense to not automatically preserve state that depends on multiple elements, such as ranges, and design something separate for that, not necessarily as a node-specific API

[07:28:16.0443] <Noam Rosenthal>
 * We generally preserve element-specific state (frame window, focus, animation, dialog/fullscreen/popover), I think it makes sense to not automatically preserve state that depends on multiple elements, such as ranges, and design something separate for that later on if the need arises, not necessarily as a node-specific API

[07:28:45.0721] <annevk>
FWIW, I'm out this week (see Bluesky). I also have the feeling we're still not quite on the same wavelength with regards to when something is eligible for Stage 3. I think that warrants some further meta discussion as it would be good if we were all on the same page.

[07:29:53.0605] <Noam Rosenthal>
> <@noamr:matrix.org> We generally preserve element-specific state (frame window, focus, animation, dialog/fullscreen/popover), I think it makes sense to not automatically preserve state that depends on multiple elements, such as ranges, and design something separate for that later on if the need arises, not necessarily as a node-specific API

... though there is user experience value in doing our best to preserve selection, so I support revisiting this in the future 

