[
{"content":{"body":"devsnek: i now think my analysis of #1685 was incorrect and we need to revert it","msgtype":"m.text"},"ts":1571352650000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"namely, the analogy with AsyncGeneratorStart and GeneratorStart doesn't work","msgtype":"m.text"},"ts":1571352671000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"the change would be correct with that line removed","msgtype":"m.text"},"ts":1571352713000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"engine262 is running fine","msgtype":"m.text"},"ts":1571352727000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: well, there's the added weirdness of what it means to push a non-copied execution context onto the stack twice","msgtype":"m.text"},"ts":1571352839000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"ü§∑üèª","msgtype":"m.text"},"ts":1571352885000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"that part is definitely weird","msgtype":"m.text"},"ts":1571352895000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: i originally thought the change would be correct because you don't need to duplicate the asyncContext","msgtype":"m.text"},"ts":1571352922000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i think ideally we would just rework the [[Call]] for ecmascript functions","msgtype":"m.text"},"ts":1571352954000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"so that the actual dispatch is the one doing the pushing and popping","msgtype":"m.text"},"ts":1571352962000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: but you still do, because right now we're pushing a reference to the running (even after removing the erroneous 2nd push) context","msgtype":"m.text"},"ts":1571352965000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"devsnek: no, that wouldn't fix the issue, let me try to explain the issue to see if it makes sense","msgtype":"m.text"},"ts":1571352975000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"you have an `async function f()` and call `f()`, which is synchronous up until the first `await`, if any","msgtype":"m.text"},"ts":1571352998000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"right","msgtype":"m.text"},"ts":1571353003000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"in the case there is an `await`, the execution context of `f` needs to manually remove its execution context from the stack after resuming from the `await`","msgtype":"m.text"},"ts":1571353035000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"err, after running to completion after resuming from all awaits","msgtype":"m.text"},"ts":1571353046000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"right","msgtype":"m.text"},"ts":1571353074000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"in the case there is no `await`, it shouldn't manually remove its own execution context, because the [[Call]] itself pops it","msgtype":"m.text"},"ts":1571353085000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"that's why it's copied and re-pushed","msgtype":"m.text"},"ts":1571353090000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"it's annoying to deal with \"was there an await or not\" case otherwise","msgtype":"m.text"},"ts":1571353104000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"with a single execution context","msgtype":"m.text"},"ts":1571353109000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"the generator contexts don't need to duplicate and repush because they start suspended","msgtype":"m.text"},"ts":1571353120000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"so there is always at least one suspension point","msgtype":"m.text"},"ts":1571353129000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"the current state, with your change merged, is that we re-push something that doesn't have its own \"code evaluation state\", which is incorrect","msgtype":"m.text"},"ts":1571353198000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i'm still not following where the incorrect behaviour is","msgtype":"m.text"},"ts":1571353215000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"like i get the current logic is odd","msgtype":"m.text"},"ts":1571353224000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"okay, let's walk through an `async function f() { }`","msgtype":"m.text"},"ts":1571353286000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"PrepareForOrdinaryCall allocates a new execution context, let's call that `asyncContext`","msgtype":"m.text"},"ts":1571353331000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah","msgtype":"m.text"},"ts":1571353342000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"right before we call `f();`, the execution stack is `[originalContext]`","msgtype":"m.text"},"ts":1571353362000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yep","msgtype":"m.text"},"ts":1571353394000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"in [[Call]], PrepareForOrdinaryCall pushes `asyncContext` onto the stack, so now the stack is `[originalContext, asyncContext]`","msgtype":"m.text"},"ts":1571353429000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"eventually, via OrdinaryCallEvaluateBody, we get to `AsyncFunctionStart`","msgtype":"m.text"},"ts":1571353449000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"(assuming the second push in `AsyncFunctionStart` is removed)","msgtype":"m.text"},"ts":1571353472000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah","msgtype":"m.text"},"ts":1571353497000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"`AsyncFunctionStart` pushes `asyncContext` onto the stack again and resumes it, so now the stack is `[originalContext, asyncContext, asyncContext]`","msgtype":"m.text"},"ts":1571353499000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"since there's no awaits, the resumed `asyncContext` tries to remove itself from the context stack","msgtype":"m.text"},"ts":1571353521000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"wait are you talking about with clones or not","msgtype":"m.text"},"ts":1571353524000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i'm talking about the current version that is merged","msgtype":"m.text"},"ts":1571353532000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"so no language around \"copy an execution context\"","msgtype":"m.text"},"ts":1571353539000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"ok yeah, with the duplicate push","msgtype":"m.text"},"ts":1571353542000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"there are two asyncContexts on the stack","msgtype":"m.text"},"ts":1571353549000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"well, the bug in the current version is that there would actually be 3 asyncContexts","msgtype":"m.text"},"ts":1571353563000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"but assume we removed the obviously buggy 2nd push, there are 2 asyncContexts","msgtype":"m.text"},"ts":1571353571000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"there should only be one push","msgtype":"m.text"},"ts":1571353579000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"step 6","msgtype":"m.text"},"ts":1571353587000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"right, in AsyncFunctionStart","msgtype":"m.text"},"ts":1571353595000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"step 3 shouldn't exist","msgtype":"m.text"},"ts":1571353601000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"so you'd have `[originalContext, asyncContext]`","msgtype":"m.text"},"ts":1571353609000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"then evaluation is resumed","msgtype":"m.text"},"ts":1571353614000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"ah but no, but `asyncContext` is already pushed via `PrepareForOrdinaryCall`","msgtype":"m.text"},"ts":1571353618000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah","msgtype":"m.text"},"ts":1571353625000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"that's how asyncContext got there","msgtype":"m.text"},"ts":1571353634000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"so there are now 2 asyncContexts at the top of the stack","msgtype":"m.text"},"ts":1571353634000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i'm not seeing the thing you're talking about","msgtype":"m.text"},"ts":1571353644000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"where is the third push","msgtype":"m.text"},"ts":1571353654000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"the extra buggy push is making this hard to talk about","msgtype":"m.text"},"ts":1571353670000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"pretend step 3 doesn't exist","msgtype":"m.text"},"ts":1571353681000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"let's pretend step 3 of AsyncFunctionStart doesn't exist, yes","msgtype":"m.text"},"ts":1571353683000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"do you agree that before we even get to AsyncFunctionStart, asyncContext is already on the stack","msgtype":"m.text"},"ts":1571353699000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yes","msgtype":"m.text"},"ts":1571353703000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"okay, then we get to step 6","msgtype":"m.text"},"ts":1571353713000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"now the stack is [originalContext, asyncContext, asyncContext]","msgtype":"m.text"},"ts":1571353722000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"nope","msgtype":"m.text"},"ts":1571353725000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"why not?","msgtype":"m.text"},"ts":1571353735000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"no matter what, after a resumed evaluation, it removes itself from the stack","msgtype":"m.text"},"ts":1571353751000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"in this case its 2.b","msgtype":"m.text"},"ts":1571353756000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"what resumed evaluation?","msgtype":"m.text"},"ts":1571353767000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"asyncContext is never suspended","msgtype":"m.text"},"ts":1571353770000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"step 4 resumes evaluation","msgtype":"m.text"},"ts":1571353773000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"and what step suspends it?","msgtype":"m.text"},"ts":1571353779000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"Await() or the steps in 2","msgtype":"m.text"},"ts":1571353808000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"the example has no awaits","msgtype":"m.text"},"ts":1571353817000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"ok so the steps in step 2","msgtype":"m.text"},"ts":1571353822000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"what steps in 2?","msgtype":"m.text"},"ts":1571353827000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"code evaluation state steps","msgtype":"m.text"},"ts":1571353841000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"step 2 is what happens upon resumption","msgtype":"m.text"},"ts":1571353845000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah","msgtype":"m.text"},"ts":1571353849000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"it doesn't suspend the running execution context","msgtype":"m.text"},"ts":1571353850000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"return and throw automatically suspend evaluation","msgtype":"m.text"},"ts":1571353892000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"in this case","msgtype":"m.text"},"ts":1571353896000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i didn't add step 5","msgtype":"m.text"},"ts":1571353914000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i think you're confused, let's start at step 1","msgtype":"m.text"},"ts":1571353938000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"the stack at Step 1 is `[originalContext, asyncContext]`, yes?","msgtype":"m.text"},"ts":1571353960000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah","msgtype":"m.text"},"ts":1571353964000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"Step 2 says, *when asyncContext is resumed*, do all these substeps, but doesn't do anything with asyncFunctionBody or touch the stack, so the stack is still `[originalContext, asyncCOntext]`, yes?","msgtype":"m.text"},"ts":1571354006000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yep","msgtype":"m.text"},"ts":1571354019000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"step 3 doesn't exist, so we skip","msgtype":"m.text"},"ts":1571354029000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yep","msgtype":"m.text"},"ts":1571354035000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"Step 4 now tries to resume something that isn't suspended to begin with","msgtype":"m.text"},"ts":1571354048000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"what does that even do","msgtype":"m.text"},"ts":1571354053000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i didn't change that","msgtype":"m.text"},"ts":1571354062000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i just removed a clone","msgtype":"m.text"},"ts":1571354073000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"right","msgtype":"m.text"},"ts":1571354097000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i take step 4 to mean \"run the code evaluation state\"","msgtype":"m.text"},"ts":1571354127000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"which either gets to 2.b or Await step 10","msgtype":"m.text"},"ts":1571354160000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"er 2.c","msgtype":"m.text"},"ts":1571354176000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"ah okay, i see, it's very different if line 3 doesn't exist or line 6 doesn't exist","msgtype":"m.text"},"ts":1571354261000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"this is still very strange","msgtype":"m.text"},"ts":1571354274000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i think it also depends on how you see the evaluation of abstract ops","msgtype":"m.text"},"ts":1571354282000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i don't think that's up to interpretation?","msgtype":"m.text"},"ts":1571354290000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"they certainly don't operate on the stack","msgtype":"m.text"},"ts":1571354306000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"since they define the stack","msgtype":"m.text"},"ts":1571354309000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"as it stands now, there are two fixes: either revert, or remove 2.c, 3, and 6","msgtype":"m.text"},"ts":1571354325000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i don't think 2.c and 6 should be removed","msgtype":"m.text"},"ts":1571354355000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"if you're super against this, i guess reverting isn't terrible","msgtype":"m.text"},"ts":1571354373000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"you have some mental model of this that i do not around resuming non-suspended contexts","msgtype":"m.text"},"ts":1571354514000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i think the whole \"suspended\" terminology is a bit odd to begin with","msgtype":"m.text"},"ts":1571354539000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i think there might've even been some idea to rework how that is specified a while ago","msgtype":"m.text"},"ts":1571354576000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"anyway, please ping me if you end up reverting it so i can update engine262 appropriately","msgtype":"m.text"},"ts":1571354636000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"sure","msgtype":"m.text"},"ts":1571354698000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i think it comes down to i don't know how step 4 can mean the \"run the code evaluation state\"","msgtype":"m.text"},"ts":1571354707000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"when you're already running the code evaluation state of the current context","msgtype":"m.text"},"ts":1571354721000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"hmm","msgtype":"m.text"},"ts":1571354738000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"generators don't have this problem because they start suspended, so there's no inline resumption like this","msgtype":"m.text"},"ts":1571354773000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"and this is what copying handles","msgtype":"m.text"},"ts":1571354791000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"what if we just moved the initial evaluation out of the code evaluation state","msgtype":"m.text"},"ts":1571354796000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"there is probably a way to do this without copying","msgtype":"m.text"},"ts":1571354796000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"let's see...","msgtype":"m.text"},"ts":1571354805000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"moving step 2.a i mean","msgtype":"m.text"},"ts":1571354811000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"just 2.a, or all substeps?","msgtype":"m.text"},"ts":1571354843000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"hmm","msgtype":"m.text"},"ts":1571354861000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i guess we'd have to duplicate the substeps","msgtype":"m.text"},"ts":1571354866000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"actually i don't hate that idea","msgtype":"m.text"},"ts":1571354880000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"you can't even duplicate the substeps, how would Await know where to resume in the duplicated substeps?","msgtype":"m.text"},"ts":1571354890000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah i guess that would break the references elsewhere","msgtype":"m.text"},"ts":1571354958000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"oh well","msgtype":"m.text"},"ts":1571354959000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i think your interpretation of step 4 requires the step 2 substeps be a thunk-like thing that can run without affecting the currently running AsyncFunctionStart","msgtype":"m.text"},"ts":1571355207000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"and the closest thing we have to that abstraction *is* an execution context, thus the duplication","msgtype":"m.text"},"ts":1571355234000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"i'd imagine that's what anba was thinking","msgtype":"m.text"},"ts":1571355485000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: if you are happy with that reasoning, it does certainly seem to warrant a NOTE in that step","msgtype":"m.text"},"ts":1571355787000,"senderName":"shu","senderId":"shu@irc"},
{"content":{"body":"yeah that's fine","msgtype":"m.text"},"ts":1571355805000,"senderName":"devsnek","senderId":"devsnek@irc"}
]