[
{"content":{"body":"devsnek, Bakkot: what's the Chrome DevTools bug? please file it if you haven't already, thanks","msgtype":"m.text"},"ts":1575872445000,"senderName":"mathiasbynens","senderId":"mathiasbynens@irc"},
{"content":{"body":"mathiasbynens: reported already https://bugs.chromium.org/p/chromium/issues/detail?id=1031243","msgtype":"m.text"},"ts":1575879712000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"mathiasbynens: devtools seems to be doing a local parse of the input and using that to decide if it has side effects","msgtype":"m.text"},"ts":1575879880000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"which seems counter intuitive to the existence of v8's side effect detection","msgtype":"m.text"},"ts":1575879914000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: agreed... we should just rely on V8 here instead of trying to \"guess\" with broken heuristics","msgtype":"m.text"},"ts":1575884085000,"senderName":"mathiasbynens","senderId":"mathiasbynens@irc"},
{"content":{"body":"we're fixing it! thanks for pointing that out","msgtype":"m.text"},"ts":1575884134000,"senderName":"mathiasbynens","senderId":"mathiasbynens@irc"},
{"content":{"body":"Can someone explain https://www.ecma-international.org/ecma-262/10.0/#sec-block-level-function-declarations-web-legacy-compatibility-semantics to me, please? In particular, I've got the following code: https://pastebin.com/Zx0VNUaj and I want to know where its behavior is specified","msgtype":"m.text"},"ts":1575920260000,"senderName":"avp","senderId":"avp@irc"},
{"content":{"body":"it seems like it'd have to do with (3.) in that list, but it does say that \"No other declaration of f that is not a var declaration occurs within the function code of g\" - there is a `let bar = 3` which fails that condition","msgtype":"m.text"},"ts":1575920330000,"senderName":"avp","senderId":"avp@irc"},
{"content":{"body":"avp the notes at the beginning of the section are just of historical interest - they're documenting cases where browsers agreed before this was specified in ES2015","msgtype":"m.text"},"ts":1575920402000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"the actual changes are in B.3.3.1","msgtype":"m.text"},"ts":1575920408000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"sidebar: you should use the living spec at https://tc39.es/ecma262/#sec-block-level-function-declarations-web-legacy-compatibility-semantics","msgtype":"m.text"},"ts":1575920421000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"Bakkot: thanks, i'll try and use that section to reconcile my mental model","msgtype":"m.text"},"ts":1575920466000,"senderName":"avp","senderId":"avp@irc"},
{"content":{"body":"B.3.3 is notoriously the most cursed section of the spec though","msgtype":"m.text"},"ts":1575920530000,"senderName":"rkirsling","senderId":"rkirsling@irc"},
{"content":{"body":"so don't feel bad for being confused :p","msgtype":"m.text"},"ts":1575920540000,"senderName":"rkirsling","senderId":"rkirsling@irc"},
{"content":{"body":"the basic semantics are: when you have `function f(){ x() }` within a block, and you could replace that with a `var f` without getting a syntax error, then the semantics of the function are 1) you add a `var f;` to the top of the _containing_ function, 2) you add a `let f = function(){ x() }` at the top of the containing _block_ and 2) when control reaches the actual function declaration within the block, you read from the `let f` and","msgtype":"m.text"},"ts":1575920614000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":" write to the `var f`","msgtype":"m.text"},"ts":1575920615000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"ugh, that second 2) should be a 3) obviously","msgtype":"m.text"},"ts":1575920623000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"Bakkot: that helps a lot - deciphering the intent of B.3.3.1 was daunting","msgtype":"m.text"},"ts":1575920686000,"senderName":"avp","senderId":"avp@irc"},
{"content":{"body":"avp also you should use strict mode so this doesn't happen :P","msgtype":"m.text"},"ts":1575921440000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"JSC has bugs for B.3.3 early errors that I've been too scared to fix","msgtype":"m.text"},"ts":1575921715000,"senderName":"rkirsling","senderId":"rkirsling@irc"},
{"content":{"body":"everyone does","msgtype":"m.text"},"ts":1575921842000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"the spec does","msgtype":"m.text"},"ts":1575921844000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"https://github.com/tc39/ecma262/issues/913 etc","msgtype":"m.text"},"ts":1575921865000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"it's functions all the way down","msgtype":"m.text"},"ts":1575922752000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"> dysfunction all the way down","msgtype":"m.text"},"ts":1575926026000,"senderName":"rkirsling","senderId":"rkirsling@irc"},
{"content":{"body":"FTFY","msgtype":"m.text"},"ts":1575926026000,"senderName":"rkirsling","senderId":"rkirsling@irc"},
{"content":{"body":"Object.assign(Object.prototype,{get:()=>{}, set:(v)=>{}, value:undefined}); wrecks so much","msgtype":"m.text"},"ts":1575927539000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"it kinda seems like you have to use null prototypes to guard against it","msgtype":"m.text"},"ts":1575927562000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"bradleymeck: ? what key are you trying to defineProperty there?","msgtype":"m.text"},"ts":1575927947000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"none, just if Object.prototype has all 3 of those keys Object.defineProperty stops working unless you use null prototypes like Object.defineProperty(obj, 'propname', {__proto__:null, value: 'value'})","msgtype":"m.text"},"ts":1575928141000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"since it sees stuff up the proto chain and says it can't be both an accessor and data prop","msgtype":"m.text"},"ts":1575928160000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"was staring at my node pr and noticed we don't guard this currently","msgtype":"m.text"},"ts":1575928180000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"ohhhhh wow i just realized what you mean","msgtype":"m.text"},"ts":1575928183000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"i wonder if it'd be web compatible to change that somehow","msgtype":"m.text"},"ts":1575928202000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"well idk but running that little script on all my open tabs killed all of them except some static sites","msgtype":"m.text"},"ts":1575928229000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"likely we can't change it though","msgtype":"m.text"},"ts":1575928251000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"we can't make it be own properties i'm sure, but i wonder if we could effectively make it be \"Get\" but stop before Object.prototype","msgtype":"m.text"},"ts":1575928319000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"that seems pretty weird too","msgtype":"m.text"},"ts":1575928336000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"better question","msgtype":"m.text"},"ts":1575928338000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"who is doing Object.assign(Object.prototype,{get:()=>{}, set:(v)=>{}, value:undefined})","msgtype":"m.text"},"ts":1575928344000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"me, checking to see if we survive it in node (we don't)","msgtype":"m.text"},"ts":1575928372000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"once you get implicit set hooks things look pretty dicey about data exfiltration across modules","msgtype":"m.text"},"ts":1575928395000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"but ü§∑ this is more just locking down stuff to survive craziness","msgtype":"m.text"},"ts":1575928412000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"we had a couple of people snooping internals and doing bad things in the long past and we started to move to primordials in part because of that","msgtype":"m.text"},"ts":1575928437000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"i remember symbol polyfills were able to patch node","msgtype":"m.text"},"ts":1575928496000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"so that util.inspect and stuff worked with them","msgtype":"m.text"},"ts":1575928508000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"causing it to always error by filling out both get/set always or value is probably good enough honestly","msgtype":"m.text"},"ts":1575928552000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"ideally we would use some null proto shenanigans but slowdown on benchmarks is pretty bad","msgtype":"m.text"},"ts":1575928599000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"i just don't see why its worth guarding against","msgtype":"m.text"},"ts":1575928667000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"bradleymeck: another alternative is that the error for \"no get/set + value\" could be made to only throw when get/set is not undefined, instead of just present","msgtype":"m.text"},"ts":1575928673000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"bradleymeck: that way you'd always be able to locally override the shenanigans with `get: undefined, set: undefined` for data properties","msgtype":"m.text"},"ts":1575928693000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"altho i guess that wouldn't protect you for accessors","msgtype":"m.text"},"ts":1575928705000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"devsnek: same thing as why any other part of the runtime is worth being robust","msgtype":"m.text"},"ts":1575928726000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"i don't really get the overall goal tbh","msgtype":"m.text"},"ts":1575928752000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"user code shouldn't be able to break the platform?","msgtype":"m.text"},"ts":1575928818000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"mostly its to get reliable behavior when things go wrong, node has access to things like shell execution and often people send authorization strings to node in various ways, you don't want people snooping on strings and you don't want shell execution to happen. it gets hard to understand what a user can accidently load (see all those malicious packages people install) and have it undermine the default platform APIs","msgtype":"m.text"},"ts":1575928857000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"malicious code can just `require('inspector')` and read every value of every variable in the entire codebase","msgtype":"m.text"},"ts":1575928900000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"so, make it just ignore anything strange and/or make it survive anything strange to avoid leaking data or allow accidental execution. accidental execution is hard to avoid in JS","msgtype":"m.text"},"ts":1575928909000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"devsnek: not if you use a policy that doesn't allow it","msgtype":"m.text"},"ts":1575928927000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"which is why we have started making efforts to use em","msgtype":"m.text"},"ts":1575928937000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"assuming the code you've explicitly pulled in is malicious is like","msgtype":"m.text"},"ts":1575928971000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"you've already lost","msgtype":"m.text"},"ts":1575928991000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"you either need full isolation","msgtype":"m.text"},"ts":1575929001000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: we work with developers who install 3rd party code all the time. you build up layers of defenses like anything else","msgtype":"m.text"},"ts":1575929005000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"or you need to trust the code somehow","msgtype":"m.text"},"ts":1575929005000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"even with full isolation you can get confusion problems that make the isolated payload malicious","msgtype":"m.text"},"ts":1575929023000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"seems like an inherently losing battle tbh","msgtype":"m.text"},"ts":1575929048000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: the entire concept of SES is winning that battle, isn't it?","msgtype":"m.text"},"ts":1575929082000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"or attempting to","msgtype":"m.text"},"ts":1575929086000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"ü§∑üèª","msgtype":"m.text"},"ts":1575929100000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"i think security always will be a race of sorts yea. though i don't think we are really trying to prevent everything, but instead make auditing feasible","msgtype":"m.text"},"ts":1575929108000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"i think SES solves a symptom of the problem","msgtype":"m.text"},"ts":1575929120000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"not the problem","msgtype":"m.text"},"ts":1575929122000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"even reading code line by line myself i'm not fully confident in it not having some odd effect (i had one with a sticky regexp today!)","msgtype":"m.text"},"ts":1575929148000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"bradleymeck: wait you had a real use case for the sticky flag??","msgtype":"m.text"},"ts":1575929169000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"ljharb: i saw it being used and i removed it","msgtype":"m.text"},"ts":1575929182000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"cause lastIndex was being weird with .search","msgtype":"m.text"},"ts":1575929190000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"anyways, i do want to use shell commands so it isn't like i can ever really trust anything","msgtype":"m.text"},"ts":1575929215000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"aha","msgtype":"m.text"},"ts":1575929299000,"senderName":"ljharb","senderId":"ljharb@irc"},
{"content":{"body":"ljharb: the idea was to match the last \" in a quoted string but it wasn't working right","msgtype":"m.text"},"ts":1575929335000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"misplaced sticky flags won't exfiltrate your tokens","msgtype":"m.text"},"ts":1575929363000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: no, but it did change a parser and we got bad data that bypassed some checks!","msgtype":"m.text"},"ts":1575929416000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"you can always keep structured data structured... bugs exist of course but these systems aren't inherently fallible","msgtype":"m.text"},"ts":1575929730000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"devsnek: not all data is provided to you in a structured format; you can't get away from parsing untrusted input sometimes","msgtype":"m.text"},"ts":1575930001000,"senderName":"Bakkot","senderId":"Bakkot@irc"},
{"content":{"body":"even if it is structured it can be bad to intake naively (\"__proto__\" from json payloads)","msgtype":"m.text"},"ts":1575930036000,"senderName":"bradleymeck","senderId":"bradleymeck@irc"},
{"content":{"body":"I mean the output of the parser","msgtype":"m.text"},"ts":1575930054000,"senderName":"devsnek","senderId":"devsnek@irc"},
{"content":{"body":"it's still the output of the parser, and you can know it may be unsafe","msgtype":"m.text"},"ts":1575930075000,"senderName":"devsnek","senderId":"devsnek@irc"}
]