[
{"content":{"body":"littledan: let me know at what point https://github.com/whatwg/html/pull/4372 is ready for nits","msgtype":"m.text"},"ts":1550394292000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"littledan: and thanks for writing it up!","msgtype":"m.text"},"ts":1550394309000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"TimothyGu: I'll leave https://github.com/whatwg/html/pull/4368 open until you can verify my analysis, but I think it's good still","msgtype":"m.text"},"ts":1550394853000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Annevk, never too early for a review, but it will be some months or maybe a year. I will note in the PR thread when ready.","msgtype":"m.text"},"ts":1550394965000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"How would folks feel if I proposed some of the HTML job queue to be part of JS semantics? No normative changes, but maybe this could clear up the willful violation in this area.","msgtype":"m.text"},"ts":1550395023000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"Domenic: ^","msgtype":"m.text"},"ts":1550395032000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"This willful violation is causing extra complexity for several JS specs","msgtype":"m.text"},"ts":1550395068000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"littledan: so the last time we looked into this the simplest setup would be for JS to queue (perhaps annotated) things and let the host take care of organizing where to put those","msgtype":"m.text"},"ts":1550395143000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"littledan: I suppose we could move more of HTML into ES, but that seems really tricky to get right","msgtype":"m.text"},"ts":1550395172000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"I see. Where does the complexity come in?","msgtype":"m.text"},"ts":1550395190000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"(oh sorry rereading your above question, the PR is already ready for nits)","msgtype":"m.text"},"ts":1550395209000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"littledan: I mean, HTML's event loop algorithm is not simple","msgtype":"m.text"},"ts":1550395261000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"In particular, there was interest in TC39 in standardizing microtask queue semantics across JS environments to make things more predictable, which seems like a nice goal to me","msgtype":"m.text"},"ts":1550395265000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"The event loop would be in HTML still... OK, sounds like I should read more details and I will probably see where it doesn't work for myself","msgtype":"m.text"},"ts":1550395304000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"littledan: and afaik ES only queues what HTML calls microtasks and those only happen in special places and even those also have their own HTML-specific logic surrounding them","msgtype":"m.text"},"ts":1550395307000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"What's HTML -specific about that logic?","msgtype":"m.text"},"ts":1550395351000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"littledan: https://html.spec.whatwg.org/#perform-a-microtask-checkpoint","msgtype":"m.text"},"ts":1550395370000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Oh, that's the thing, I think we will need to perform microtask checkpoints from the JS spec","msgtype":"m.text"},"ts":1550395429000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"littledan: promise rejection notification, database cleanup, the manipulation of the event loop (I'm not sure what that does)","msgtype":"m.text"},"ts":1550395434000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Well, at least Step 2","msgtype":"m.text"},"ts":1550395446000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"Of that algorithm","msgtype":"m.text"},"ts":1550395451000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"littledan: interesting","msgtype":"m.text"},"ts":1550395475000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Maybe we should just make a host hook for microtask checkpoints","msgtype":"m.text"},"ts":1550395497000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"\"just\" ðŸ˜ƒ","msgtype":"m.text"},"ts":1550395574000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"But, I think we might need to at least run through the microtask queue between sibling modules as part of the top-level await proposal","msgtype":"m.text"},"ts":1550395574000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"I will have to think more about whether the other parts are required","msgtype":"m.text"},"ts":1550395588000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"I think it would help a lot to look at existing software architectures here and base the standard on those","msgtype":"m.text"},"ts":1550395654000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"What's an example?","msgtype":"m.text"},"ts":1550395673000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"E.g., SpiderMonkey <> Gecko","msgtype":"m.text"},"ts":1550395682000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Or V8 <> Chromium","msgtype":"m.text"},"ts":1550395691000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Or V8 <> Node","msgtype":"m.text"},"ts":1550395698000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Oh, for the layering?","msgtype":"m.text"},"ts":1550395699000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"Yeah","msgtype":"m.text"},"ts":1550395703000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"We are already well past that! JS engines include lots of things from HTML and WebIDL","msgtype":"m.text"},"ts":1550395724000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"ES could still impose restrictions on hosts to make them consistent somehow","msgtype":"m.text"},"ts":1550395731000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Well, lots is an exaggeration","msgtype":"m.text"},"ts":1550395762000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"And for some of those things it would indeed make sense to define them in ES, as we previously discussed ðŸ˜ƒ","msgtype":"m.text"},"ts":1550395788000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"I'm pretty sure the event loop is not in V8 or SpiderMonkey though","msgtype":"m.text"},"ts":1550395797000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"But, at the same time, V8 includes (or at one point included) step 2 of the perform a microtask checkpoint algorithm (which is what I think I need)","msgtype":"m.text"},"ts":1550395815000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"V8 definitely doesn't include the broader event loop","msgtype":"m.text"},"ts":1550395833000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"So step 2 is basically an agent having a microtask queue and some abstract operation iterating over it and draining it?","msgtype":"m.text"},"ts":1550395881000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Well, except for \"Set the event loop's currently running task to oldestMicrotask.\"","msgtype":"m.text"},"ts":1550395909000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Right... I will have to look into how the currently running task is maintained","msgtype":"m.text"},"ts":1550395910000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"Seems to be mostly for compound microtasks, i.e., mutation observers, but Domenic investigated all this last","msgtype":"m.text"},"ts":1550396122000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Thanks for the pointer; that is an area I don't understand as well","msgtype":"m.text"},"ts":1550396579000,"senderName":"littledan","senderId":"littledan@irc"},
{"content":{"body":"Looking at https://dom.spec.whatwg.org/#notify-mutation-observers I guess there's a bug there in that the slotchange event also needs to be dispatched from a compound microtask subtask...","msgtype":"m.text"},"ts":1550396857000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Hmm, how does that work at all, since an event can result in multiple callbacks...","msgtype":"m.text"},"ts":1550396974000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"Time to file an issue I guess","msgtype":"m.text"},"ts":1550396985000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"https://github.com/whatwg/dom/issues/734 for those curious","msgtype":"m.text"},"ts":1550397181000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"annevk: about https://github.com/whatwg/fetch/issues/871 it seems somebody should have thought to take time to confirm with you first","msgtype":"m.text"},"ts":1550397899000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"I mean about https://bugzilla.mozilla.org/show_bug.cgi?id=1508661","msgtype":"m.text"},"ts":1550397910000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"at least Cc you","msgtype":"m.text"},"ts":1550397921000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"MikeSmith: I dunno, given that Chrome and Safari were already passing those tests there was really no indication (other than misreading of the spec text) that suggested that needed to be done","msgtype":"m.text"},"ts":1550397981000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"MikeSmith: I suspect I made a mistake by assuming fetch()'s default was \"no-cors\" or some such","msgtype":"m.text"},"ts":1550398031000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"MikeSmith: I'm somewhat surprised it took until Firefox changed for this to be found out however, that makes little sense","msgtype":"m.text"},"ts":1550398060000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"yeah","msgtype":"m.text"},"ts":1550398069000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"I also donâ€™t understand how, given the browsers passing those tests, server systems could work as expected if they rely on taking the value of the Origin header and using it to set the value of the Access-Control-Allow-Origin header","msgtype":"m.text"},"ts":1550398323000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"there must be a lot of servers and server CORS libraries which do that","msgtype":"m.text"},"ts":1550398356000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"MikeSmith: yeah that doesn't make any sense, maybe nobody is using fetch()","msgtype":"m.text"},"ts":1550398358000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"I think Adam Rice said at the TAG f2f that Chrome use counters show usage of fetch() is around 9% of pages","msgtype":"m.text"},"ts":1550398438000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"MikeSmith: maybe it's only same-origin","msgtype":"m.text"},"ts":1550398545000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"ah yeah maybe so","msgtype":"m.text"},"ts":1550398566000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"annevk: yeah another data point is that Iâ€™ve never seen and question posted to Stack Overflow from somebody indicating that their browser wasnâ€™t sending the Origin header for GET requests","msgtype":"m.text"},"ts":1550398682000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"(and I pretty much read every single CORS-tagged question posted to SO, for the last 2 years or so)","msgtype":"m.text"},"ts":1550398715000,"senderName":"MikeSmith","senderId":"MikeSmith@irc"},
{"content":{"body":"MikeSmith: so also, if it's just same-origin the specification wasn't misread, because the CORS flag is only set once cross-origin","msgtype":"m.text"},"ts":1550398774000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"MikeSmith: so maybe the spec has a bug here after all","msgtype":"m.text"},"ts":1550398788000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"MikeSmith: I guess I need to do some more digging","msgtype":"m.text"},"ts":1550398799000,"senderName":"annevk","senderId":"annevk@irc"},
{"content":{"body":"but maybe not today","msgtype":"m.text"},"ts":1550398813000,"senderName":"annevk","senderId":"annevk@irc"}
]