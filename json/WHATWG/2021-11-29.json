[
{"content":{"body":"Jake Archibald: good morning! I have a couple of SW patches waiting for review when you get a chance... https://github.com/w3c/ServiceWorker/pull/1620 and https://github.com/w3c/ServiceWorker/pull/1621","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@jakea:matrix.org\">Jake Archibald</a>: good morning! I have a couple of SW patches waiting for review when you get a chance... https://github.com/w3c/ServiceWorker/pull/1620 and https://github.com/w3c/ServiceWorker/pull/1621","msgtype":"m.text"},"ts":1638175286556,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$6tBAf5rk_MqrIZ-5mYxUU-3FjpM2cuHC-CNWGY9GZSY"},
{"content":{"body":"Hi annevk: We found some existing issue with `process response donein this comment: https://github.com/whatwg/fetch/pull/1311/files#r737407947","format":"org.matrix.custom.html","formatted_body":"Hi <a href=\"https://matrix.to/#/@annevk:mozilla.org\">annevk</a>: We found some existing issue with `process response donein this comment: https://github.com/whatwg/fetch/pull/1311/files#r737407947","msgtype":"m.text"},"ts":1638176971618,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$henIC43Hicq-I1Ath0ST8I6AopzxqwHWLL3bi3knYEk"},
{"content":{"body":"basically we call \"done\" when the network is done, but we never call it for http-cache/SW. For http-cache it's simple, but not sure yet how to integrate it with SW","msgtype":"m.text"},"ts":1638177012608,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$UNvWeBhwmLHQ0RAWvjwQIh-QGYMluhVLkS41qmi1b18"},
{"content":{"body":"annevk:  Maybe `network read complete` flag should be on a response instead of on the fetch, I think that would solve it","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:mozilla.org\">annevk</a>:  Maybe <code>network read complete</code> flag should be on a response instead of on the fetch, I think that would solve it","msgtype":"m.text"},"ts":1638177308105,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$00wpxiGYa_jsKSeAYFXNyHFr17XKWqmHbBrw22Fc6oc"},
{"content":{"body":"How would it get set is the problem, no? It's interesting how the lack of progress events for streams is making a lot of this hard","msgtype":"m.text"},"ts":1638177385385,"senderName":"annevk","senderId":"@annevk:mozilla.org","id":"$uq0AqcSetNlXt7EF2-g7L0IeYDcYcHZsV0qnNIJuubk"},
{"content":{"body":"yea","msgtype":"m.text"},"ts":1638177396996,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$-RmWaaoD1AJ6yDMO83cV1w37qvE9JCXNPXDRtOgacB4"},
{"content":{"body":"ideally this should all be related to the streams","msgtype":"m.text"},"ts":1638177408990,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$5LaBSPdpNvrFqgHwNHOqvJajOqxRJ77NZ0UC1BtKDlw"},
{"content":{"body":"Perhaps the solution would be to have some kind of transform stream that reports when EOF is pushed and otherwise forwards","msgtype":"m.text"},"ts":1638177413049,"senderName":"annevk","senderId":"@annevk:mozilla.org","id":"$cLNW5t-MJ5ru2sQC7nRXhcp3geqPNYhB5BhnLO1qGcY"},
{"content":{"body":"isn't that equivalent to \"teeing\" the stream and fully reading one side of the tee?","msgtype":"m.text"},"ts":1638177442794,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$cJqE2tCUVhfaJfoMNUu-1ZHYQ-4EK9xCuQG7yIJaHkY"},
{"content":{"body":"I thought reading had side effects, such as possibly influencing the speed of transfer","msgtype":"m.text"},"ts":1638177495652,"senderName":"annevk","senderId":"@annevk:mozilla.org","id":"$1cRj_vAqlvwIJwxD9DxrVOdj0ezAWskjMT11Gxqrr2A"},
{"content":{"body":"yea but not observable side effects","msgtype":"m.text"},"ts":1638177521755,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$fc_vY6iRMTlvoaPnt2X1owZpS5-u85e4BBBqD_6lhCU"},
{"content":{"body":"as far as observable behavior is concerned it should be equivalent, of course implementations can do something \"faster\"","msgtype":"m.text"},"ts":1638177547449,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$yMyocf3-sBn3WxhNqG_VPfn8sbXDknwzzIbneLBbCIc"},
{"content":{"body":"Maybe, I'm not too well-versed in this. It seems rather wasteful, but perhaps with an explanation of what it is doing it could work","msgtype":"m.text"},"ts":1638177628582,"senderName":"annevk","senderId":"@annevk:mozilla.org","id":"$j9blFw_EWUG1Gp0nu1Jsaj2NFbl6XuR2tJBA4GDZ4D0"},
{"content":{"body":"but maybe a cleaner solution would be to add some \"control-flow\" reader to a stream like you suggested","msgtype":"m.text"},"ts":1638177629054,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$TNAUJmhlvHcB1cOAww3VK4jyGxA644qGdFw4Xl495eI"},
{"content":{"body":"Mattias Buelens do you have thoughts on any of this?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@mattiasbuelens:matrix.org\">Mattias Buelens</a> do you have thoughts on any of this?","msgtype":"m.text"},"ts":1638177677276,"senderName":"annevk","senderId":"@annevk:mozilla.org","id":"$5UZ-JJhoExsKIjNNBr1Un-rSLbjLvrf7dpkjJoKzNE0"},
{"content":{"body":"Seems like maybe the cleanest thing would be that FETCH adds a transform stream that implements flush (https://streams.spec.whatwg.org/#dom-transformer-flush) but that is otherwise an identity transform stream","msgtype":"m.text"},"ts":1638178132827,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$MkqIGttWoyyjKsvyy1nRwrmaNKPPoaGOIJpeb3i4rs4"},
{"content":{"body":"annevk: doing ^^^ for only the SW case would solve the problem I think (for HTTP cache we can check cache-state on fetch finale). I'll jot down a revision and see what it looks like","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:mozilla.org\">annevk</a>: doing ^^^ for only the SW case would solve the problem I think (for HTTP cache we can check cache-state on fetch finale). I'll jot down a revision and see what it looks like","msgtype":"m.text"},"ts":1638179756951,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$9_YJP-IFfcfPruKJc9aCdunHS8F2DLhrDGPsxSn1XyE"},
{"content":{"body":"Teeing and then fully reading one side is not correct, since it doesn't respect backpressure. Piping through an identity transform stream that implements `flush()` would work.","format":"org.matrix.custom.html","formatted_body":"Teeing and then fully reading one side is not correct, since it doesn't respect backpressure. Piping through an identity transform stream that implements <code>flush()</code> would work.","msgtype":"m.text"},"ts":1638179879510,"senderName":"Mattias Buelens","senderId":"@mattiasbuelens:matrix.org","id":"$gxPa7T_ygfewPQdrJq8C4Duwer3KmprSHgKHQeVZrUo"},
{"content":{"body":"You could also use the promise returned by `pipeTo()` to know when the pipe has completed, and thus when the readable has reached EOF. But a transform stream with `flush()` is probably easier to reason about.","format":"org.matrix.custom.html","formatted_body":"You could also use the promise returned by <code>pipeTo()</code> to know when the pipe has completed, and thus when the readable has reached EOF. But a transform stream with <code>flush()</code> is probably easier to reason about.","msgtype":"m.text"},"ts":1638180041774,"senderName":"Mattias Buelens","senderId":"@mattiasbuelens:matrix.org","id":"$cy_iSNvvyulsKWh5KP6ajvZbutYM8teqVy30b5pgiDQ"},
{"content":{"body":"great, thanks Mattias Buelens. Getting to it!","format":"org.matrix.custom.html","formatted_body":"great, thanks <a href=\"https://matrix.to/#/@mattiasbuelens:matrix.org\">Mattias Buelens</a>. Getting to it!","msgtype":"m.text"},"ts":1638180124221,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$U0qtjMo4QealNt7-LwRL1EFoDyfCfpH28ZuTVWcKuQg"},
{"content":{"body":"Mattias Buelens: how do I define a `[=transform stream=]` with a custom flush, spec-wise? Seems like `{{Transformer}}` is a web-exposed class, while I want to stay in the \"internal\" realm","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@mattiasbuelens:matrix.org\">Mattias Buelens</a>: how do I define a <code>[=transform stream=]</code> with a custom flush, spec-wise? Seems like <code>{{Transformer}}</code> is a web-exposed class, while I want to stay in the &quot;internal&quot; realm","msgtype":"m.text"},"ts":1638181611980,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$GOB3ngELNapVgGY9TJka5Ic-FQnUzFghYwnKA0gGRmo"},
{"content":{"body":"See https://streams.spec.whatwg.org/#other-specs-ts","msgtype":"m.text"},"ts":1638181644096,"senderName":"Mattias Buelens","senderId":"@mattiasbuelens:matrix.org","id":"$Y5QNrtuu6kScJlPjS9DWU_WFqB9VPVzTP-ux5T6G0Vs"},
{"content":{"body":"For an example, see step 5.2 of https://fetch.spec.whatwg.org/#http-fetch","msgtype":"m.text"},"ts":1638181693788,"senderName":"Mattias Buelens","senderId":"@mattiasbuelens:matrix.org","id":"$jKJT9nKOucgk1X3ttJIRh00Rl0GxPf3w7H_frN0w8vQ"},
{"content":{"body":"perfect, thanks!","msgtype":"m.text"},"ts":1638181702403,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$YZNiivowgeT6CxEDFd14esI62063yLDrtptz2Qvt0yY"},
{"content":{"body":"> <@mattiasbuelens:matrix.org> See https://streams.spec.whatwg.org/#other-specs-ts\n\nSeems like `transformAlgorithm` is required though, is there something like an `identityTransformAlgorithm` I can use here or needs to be exposed?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$Y5QNrtuu6kScJlPjS9DWU_WFqB9VPVzTP-ux5T6G0Vs?via=mozilla.org&via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@mattiasbuelens:matrix.org\">@mattiasbuelens:matrix.org</a><br>See https://streams.spec.whatwg.org/#other-specs-ts</blockquote></mx-reply>Seems like <code>transformAlgorithm</code> is required though, is there something like an <code>identityTransformAlgorithm</code> I can use here or needs to be exposed?","m.relates_to":{"m.in_reply_to":{"event_id":"$Y5QNrtuu6kScJlPjS9DWU_WFqB9VPVzTP-ux5T6G0Vs"}},"msgtype":"m.text"},"ts":1638181843358,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$YbiwNyHQqXZw6xb198b4KXUhIOd8lN0fJkSShK6darM"},
{"content":{"body":"(I only want to customize flush)","msgtype":"m.text"},"ts":1638181855001,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$WXH7m155TYEPahUauwEvCEj2xG0a4LKhiMA5Ldw64D0"},
{"content":{"body":"Hmm, doesn't seem like it. It's probably easiest to define your own `transformAlgorithm` that simply enqueues the given chunk (using https://streams.spec.whatwg.org/#transformstream-enqueue).","format":"org.matrix.custom.html","formatted_body":"Hmm, doesn't seem like it. It's probably easiest to define your own <code>transformAlgorithm</code> that simply enqueues the given chunk (using https://streams.spec.whatwg.org/#transformstream-enqueue).","msgtype":"m.text"},"ts":1638182044748,"senderName":"Mattias Buelens","senderId":"@mattiasbuelens:matrix.org","id":"$hcAXS0mW32hkkQz9mCxdM4VJFXMuTeY5Ep-mVE8sLkU"},
{"content":{"body":"You can copy the phrasing from https://streams.spec.whatwg.org/#create-an-identity-transformstream","msgtype":"m.text"},"ts":1638182082634,"senderName":"Mattias Buelens","senderId":"@mattiasbuelens:matrix.org","id":"$mHiXiY-qlhs5_EOu2vtelKGR9GGYjyBUdfdHAS7cQow"}
]