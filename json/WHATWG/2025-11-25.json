[
{"content":{"body":"There's still some discussion over how it should behave with script & preloading https://github.com/whatwg/html/issues/11669#issuecomment-3550088089. Do you think this blocks moving to stage 2? If not I'm fine with it and we can continue to discuss. zcorpan does this make sense with the stages model?","format":"org.matrix.custom.html","formatted_body":"There's still some discussion over how it should behave with script &amp; preloading https://github.com/whatwg/html/issues/11669#issuecomment-3550088089. Do you think this blocks moving to stage 2? If not I'm fine with it and we can continue to discuss. <a href=\"https://matrix.to/#/@zcorpan:mozilla.org\">zcorpan</a> does this make sense with the stages model?","m.mentions":{"user_ids":["@foolip:matrix.org","@zcorpan:mozilla.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$UN8rnetasxjyEQrAPQUTiYNT9ZMh5t5ODXnWgBXdmhE"}},"msgtype":"m.text"},"ts":1764067465171,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$3UcdATD9fexcW8EEjdG3ohQk-CXv0EdPHfDKob51Bf0"},
{"content":{"body":"foolip: why doesn't it add runScripts to setHTMLUnsafe?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: why doesn't it add runScripts to setHTMLUnsafe?","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"ts":1764069032439,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$CPEeritcMVhxL7x-Fu3aclH-Jb2eW0ta6_5jBg2QxQU"},
{"content":{"body":"annevk: That's just an oversight. Do you think we should add `runScripts` to setHTMLUnsafe() independently (before) streamHTMLUnsafe(), or do it all in one PR?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:matrix.org\">annevk</a>: That's just an oversight. Do you think we should add <code>runScripts</code> to setHTMLUnsafe() independently (before) streamHTMLUnsafe(), or do it all in one PR?","m.mentions":{"user_ids":["@annevk:matrix.org"]},"msgtype":"m.text"},"ts":1764069215879,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$iL7uPGC9VandCIo4mNgmSUj8cC53_yKNf7dlkgcPnTo"},
{"content":{"body":"I don't have a preference, except that `setHTMLUnsafe()` getting it later doesn't seem good.","format":"org.matrix.custom.html","formatted_body":"I don't have a preference, except that <code>setHTMLUnsafe()</code> getting it later doesn't seem good.","m.mentions":{},"msgtype":"m.text"},"ts":1764069279844,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$4knmir387NU50NZkzLLmj9fPgppUryoG3uLFe3ujdyg"},
{"content":{"body":"Yeah, that wouldn't make sense","m.mentions":{},"msgtype":"m.text"},"ts":1764069694687,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$ZIVjllIe5za3SQp3zSyc0BRiI7lSkzBGSYCmPP5Lslg"},
{"content":{"body":"I left some other comments on the PR. Forgot to comment on `runScripts`. ðŸ˜…","format":"org.matrix.custom.html","formatted_body":"I left some other comments on the PR. Forgot to comment on <code>runScripts</code>. ðŸ˜…","m.mentions":{},"msgtype":"m.text"},"ts":1764069704905,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$pyLzSiLVGpGWLHcx8HCMFabnIkroSs1OgfBdmhwXyxs"},
{"content":{"body":"I'll add it to the PR so that it's somewhere for now.","m.mentions":{},"msgtype":"m.text"},"ts":1764069705742,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$ZVcNfZgFe8FxHt6CDEuRbFKVW8ThgxhzzQ2umBx_fzo"},
{"content":{"body":"I'm not sure there is actually much of an issue there; we can tee those streams to use the speculative parser the same way it's done in the main parser. The mechanism of that is kind of loosely spec'ed to begin with though","m.mentions":{"user_ids":["@jakea:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$3UcdATD9fexcW8EEjdG3ohQk-CXv0EdPHfDKob51Bf0"}},"msgtype":"m.text"},"ts":1764070024871,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$OLGdWRrE8AdeqoHUpL0b1CXBJIxkiHkJBJ0peGDaSKc"},
{"content":{"body":"Noam Rosenthal: ohh, I didn't realise that the buffering to allow scripts to run before adding the next element stuff had made it into the spec","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@noamr:matrix.org\">Noam Rosenthal</a>: ohh, I didn't realise that the buffering to allow scripts to run before adding the next element stuff had made it into the spec","m.mentions":{"user_ids":["@noamr:matrix.org"]},"msgtype":"m.text"},"ts":1764070138680,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$LGaPSPBqFQopfo7EUckckRN8BiyMZEzAbswi_rgqfS4"},
{"content":{"body":"It *sort of* did. The stream that goes into the parser is teed to the main parser and speculative parser, but a lot of details there are left to implementations. In either case, I checked it in the spec and streaming to an element doesn't have an effective change on this (though of course this needs to be properly tested).","format":"org.matrix.custom.html","formatted_body":"It <em>sort of</em> did. The stream that goes into the parser is teed to the main parser and speculative parser, but a lot of details there are left to implementations. In either case, I checked it in the spec and streaming to an element doesn't have an effective change on this (though of course this needs to be properly tested).","m.mentions":{"user_ids":["@jakea:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$LGaPSPBqFQopfo7EUckckRN8BiyMZEzAbswi_rgqfS4"}},"msgtype":"m.text"},"ts":1764070227187,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$dzY0vKnEq_S84QkKqVTVC6ePbU5y5cXKSRcAzbQF4OU"},
{"content":{"body":"> but a lot of details there are left to implementations\nThat soundsâ€¦ bad :D","format":"org.matrix.custom.html","formatted_body":"<blockquote>\n<p>but a lot of details there are left to implementations<br>That soundsâ€¦ bad :D</p>\n</blockquote>\n","m.mentions":{},"msgtype":"m.text"},"ts":1764070897705,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$VfmIpiQ-9-DRS7_IdEap71nE-hQ8UTuuHF1QoMM4mCw"},
{"content":{"body":"* > but a lot of details there are left to implementations\n\nThat soundsâ€¦ bad :D","format":"org.matrix.custom.html","formatted_body":"* <blockquote>\n<p>but a lot of details there are left to implementations</p>\n</blockquote>\n<p>That soundsâ€¦ bad :D</p>\n","m.mentions":{},"m.new_content":{"body":"> but a lot of details there are left to implementations\n\nThat soundsâ€¦ bad :D","format":"org.matrix.custom.html","formatted_body":"<blockquote>\n<p>but a lot of details there are left to implementations</p>\n</blockquote>\n<p>That soundsâ€¦ bad :D</p>\n","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$VfmIpiQ-9-DRS7_IdEap71nE-hQ8UTuuHF1QoMM4mCw","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1764070903764,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$mSgONEZiP-Lu_ufZKbkBL9HIZ8YoNTMhJe3_yPzF8uk"},
{"content":{"body":"Noam Rosenthal: I really think the stuff in https://github.com/whatwg/html/issues/11669#issuecomment-3537477657 should be interoperable","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@noamr:matrix.org\">Noam Rosenthal</a>: I really think the stuff in https://github.com/whatwg/html/issues/11669#issuecomment-3537477657 should be interoperable","m.mentions":{"user_ids":["@noamr:matrix.org"]},"msgtype":"m.text"},"ts":1764070956836,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$sZMeZXTtH33QE8eW6lLlkBn-D5vxUo-wHHQz9P61_Co"},
{"content":{"body":"*That* stuff is interoperable. I meant that the speculative parsing behaviour might not be entirely interoperable.","format":"org.matrix.custom.html","formatted_body":"<em>That</em> stuff is interoperable. I meant that the speculative parsing behaviour might not be entirely interoperable.","m.mentions":{"user_ids":["@jakea:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$sZMeZXTtH33QE8eW6lLlkBn-D5vxUo-wHHQz9P61_Co"}},"msgtype":"m.text"},"ts":1764071235656,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$1bMCTxEB-aib0440Y1uHHAWD_br5bKe02CYhN0795W0"},
{"content":{"body":"oh yeah that's fine","m.mentions":{},"msgtype":"m.text"},"ts":1764071713724,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$TBT7g8_ZVEcDAL6BWk6hk4sIRP6UgsjfQzh3xtRTQok"},
{"content":{"body":"Noam Rosenthal: someone's asking \"why contentname and not id\", and I couldn't find the relevant discussion","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@noamr:matrix.org\">Noam Rosenthal</a>: someone's asking \"why contentname and not id\", and I couldn't find the relevant discussion","m.mentions":{"user_ids":["@noamr:matrix.org"]},"msgtype":"m.text"},"ts":1764072226857,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$ed4_fHFaaZMzkb3CRJ0L55ZQDvWcCBar-7teAvCMOwo"},
{"content":{"body":"https://x.com/royalicing/status/1991714869012582584","m.mentions":{},"msgtype":"m.text"},"ts":1764072232674,"senderName":"Jake Archibald","senderId":"@jakea:matrix.org","id":"$1i1VCDQVeptoI5KfQCd7RIAv5DXjF0Hb5pMNtIRkRDA"},
{"content":{"body":"Thanks for the feedback! I've addressed the simple stuff now. For the HTML fragment parsing algorithm refactor I'm concerned that the diff will be unreadable if I just do it. In the end there should be one algorithm, so maybe as a middle ground I could add \"(streaming case)\" markers to some steps to show exactly where the changes are instead of waving at them from the outside?","m.mentions":{"user_ids":["@annevk:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$pyLzSiLVGpGWLHcx8HCMFabnIkroSs1OgfBdmhwXyxs"}},"msgtype":"m.text"},"ts":1764072390423,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$lhxXpow7cgLDzGU_6rSrOkMRcjJQGyWenI91ghrHQOk"},
{"content":{"body":"I think you need to modify the core HTML parser as well, at least for some of the things we discussed. And ideally some of that is tidied up as it's all rather hand-wavy currently and adding this on top will make it even more fragile. So yeah, maybe do some refactoring first.","m.mentions":{},"msgtype":"m.text"},"ts":1764072487505,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$tjX4ShoVFDVeBGkUI5B3Kd_TIytT-r2aDq3tutKxLWk"},
{"content":{"body":"It's an XSS mitigation, to avoid new streaming modifying markup that doesn't expect it. It was raised in the first WHATNOT about this and also by our security folks.\nIt was discussed here https://docs.google.com/document/d/1iaarr4Ho715CUULrvi_LD3TwshAcN2odDLBBEK0FjH0/edit?tab=t.0#heading=h.oh1h778cnny but the minutes are lacking/missing\n","m.mentions":{"user_ids":["@jakea:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$1i1VCDQVeptoI5KfQCd7RIAv5DXjF0Hb5pMNtIRkRDA"}},"msgtype":"m.text"},"ts":1764072631617,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$yuTxrO_s4VmHTJNCFPhwEL8SaASboYqxgF2qfhkNZzw"},
{"content":{"body":"... also, contentname is not meant to be document-unique like ID. it is resolved from the template's parent downwards (or for the whole document if the template is a direct child of the body)","m.mentions":{},"m.relates_to":{"m.in_reply_to":{"event_id":"$yuTxrO_s4VmHTJNCFPhwEL8SaASboYqxgF2qfhkNZzw"}},"msgtype":"m.text"},"ts":1764072725451,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$2jBUsPRDJRhGEJaW32UNRs6oIv0x-omVzCGGGDhLY3I"},
{"content":{"body":"bkardell: Do you have any insight?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@bkardell:igalia.com\">bkardell</a>: Do you have any insight?","m.mentions":{"user_ids":["@bkardell:igalia.com"]},"m.relates_to":{"event_id":"$a44HXf6A4cIz_GZPFKdxyEnNSf9-3Je82yysXGBXLCk","is_falling_back":true,"m.in_reply_to":{"event_id":"$a44HXf6A4cIz_GZPFKdxyEnNSf9-3Je82yysXGBXLCk"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1764078795478,"senderName":"sb3nder","senderId":"@sb3nder:matrix.org","id":"$Ppy-TfdlYTkT1cy-6HlLQXCoquoISSaI_8bEgFLAbnY"},
{"content":{"body":"For Sanitizer definitely, although I think that has to be a different PR. But also for `runScripts`, at least https://html.spec.whatwg.org/#parsing-main-inhead:already-started should be modified.","format":"org.matrix.custom.html","formatted_body":"For Sanitizer definitely, although I think that has to be a different PR. But also for <code>runScripts</code>, at least https://html.spec.whatwg.org/#parsing-main-inhead:already-started should be modified.","m.mentions":{"user_ids":["@annevk:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$tjX4ShoVFDVeBGkUI5B3Kd_TIytT-r2aDq3tutKxLWk"}},"msgtype":"m.text"},"ts":1764081954649,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$cr7aMPxIGNUOZt44T2ki9hO4PJ4FzRUV-M0PP8dGDnk"},
{"content":{"body":"annevk: but this really seems more like stage 3 (\"Complete specification text\") than stage 2 (\"draft specification\") to me, don't you think so?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:matrix.org\">annevk</a>: but this really seems more like stage 3 (\"Complete specification text\") than stage 2 (\"draft specification\") to me, don't you think so?","m.mentions":{"user_ids":["@annevk:matrix.org"]},"msgtype":"m.text"},"ts":1764082036702,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$4-a1gHCML5zlvilE4U4N4pKe4rw0c6fhJ66hyDa-Rfg"},
{"content":{"body":"foolip: are you sure that's only for sanitizer? For instance, the way it is currently specified declarative shadow trees would not work, because there's no separate parser document and thus you would get the settings from the main document parser. I don't think that's what we want.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: are you sure that's only for sanitizer? For instance, the way it is currently specified declarative shadow trees would not work, because there's no separate parser document and thus you would get the settings from the main document parser. I don't think that's what we want.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"ts":1764083957040,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$56M-67QoPuiNipEw7oWWA0R8AV8INAw0BDVYa6ei6rk"},
{"content":{"body":"foolip: anyway, API-shape-wise this is all seems fairly settled and it does seem somewhat unlikely we'll have to deviate very far from this as we define things better. But it's a big gap and I really hope this will come with some improvements to how we define the HTML parser in general, because I don't know if you've noticed, but people keep reporting new issues with it.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: anyway, API-shape-wise this is all seems fairly settled and it does seem somewhat unlikely we'll have to deviate very far from this as we define things better. But it's a big gap and I really hope this will come with some improvements to how we define the HTML parser in general, because I don't know if you've noticed, but people keep reporting new issues with it.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"ts":1764084216366,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$Vun3cIFypj04y-igFGgc5dM5iUJacfmfAIvedOWz3Vw"},
{"content":{"body":"annevk: My current thinking is to define an algorithm that works for streamHTMLUnsafe() and then wrap that in a synchronous form for setHTUnsafe() and other existing APIs. I'm not sure how exactly though because streams primitives aren't synchronous so it will have to be something else. Maybe just a parser object that can be fed chunks.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:matrix.org\">@annevk:matrix.org</a>: My current thinking is to define an algorithm that works for streamHTMLUnsafe() and then wrap that in a synchronous form for setHTUnsafe() and other existing APIs. I'm not sure how exactly though because streams primitives aren't synchronous so it will have to be something else. Maybe just a parser object that can be fed chunks.","msgtype":"m.text"},"ts":1764084574097,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$kDB-gwvmgnHWBrFydUhxcDoGOKgBl1mb_2M-Z3I6olA"},
{"content":{"body":"That isn't the most interesting stuff however. What makes scripts and DSD work differently in different parser modes is much more interesting. For scripts I'm pretty sure of how to do it, for DSD I'll need to look at where we get the setting from in the absence of a separate parser document.","msgtype":"m.text"},"ts":1764084700208,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$wMEf0_rQS7EirIg0rJTb5R-nyhCRrLwWehrLmsIyyXQ"},
{"content":{"body":"I'm not sure it's just scripts and declarative shadow trees. I can imagine there might also be differences between node creation and insertion that would show up. Because as currently proposed the node would not be created in an \"inert\" document. I suspect that needs to change so it's the same as `setHTMLUnsafe()` and friends.","format":"org.matrix.custom.html","formatted_body":"I'm not sure it's just scripts and declarative shadow trees. I can imagine there might also be differences between node creation and insertion that would show up. Because as currently proposed the node would not be created in an \"inert\" document. I suspect that needs to change so it's the same as <code>setHTMLUnsafe()</code> and friends.","m.mentions":{},"msgtype":"m.text"},"ts":1764084994315,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$rVU7xe5T151omcisBKN-_iUQGvWawxi2_ob9yiKNywo"},
{"content":{"body":"This aspect would be more like the main parser where nodes are created in and inserted into the main document. There might definitely be surprises hiding here since it's not quite like the main parser and not quite the fragment parser, but I'm not sure that bouncing nodes off an inert document is really better. Noam Rosenthal can you think of any observable differences between those two models?","format":"org.matrix.custom.html","formatted_body":"This aspect would be more like the main parser where nodes are created in and inserted into the main document. There might definitely be surprises hiding here since it's not quite like the main parser and not quite the fragment parser, but I'm not sure that bouncing nodes off an inert document is really better. <a href=\"https://matrix.to/#/@noamr:matrix.org\">Noam Rosenthal</a> can you think of any observable differences between those two models?","m.mentions":{"user_ids":["@annevk:matrix.org","@noamr:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$rVU7xe5T151omcisBKN-_iUQGvWawxi2_ob9yiKNywo"}},"msgtype":"m.text"},"ts":1764090651532,"senderName":"foolip","senderId":"@foolip:matrix.org","id":"$3LxxQzDohR_-V7o9w68jxKtVaZ0XJvwOYvvyx_jSL-4"},
{"content":{"body":"foolip: well something like that is clearly needed for the Sanitizer and we don't want the design for setHTMLUnsafe to be fundamentally different from setHTML.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: well something like that is clearly needed for the Sanitizer and we don't want the design for setHTMLUnsafe to be fundamentally different from setHTML.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"ts":1764091142028,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$qKl4sPybkrWDN00u4Lh5yjIbRw-y3aFGgtGOF7PKk7s"},
{"content":{"body":"foolip: so solving for the Sanitizer is definitely going to be needed to some extent for v1. Much more so than with setHTMLUnsafe() as there it was very clear what needed to be done.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: so solving for the Sanitizer is definitely going to be needed to some extent for v1. Much more so than with setHTMLUnsafe() as there it was very clear what needed to be done.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"ts":1764091195158,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$SExvkaH4hXydg5GxTlwQWDzzkSV_wsfI9nlwCoNtSdI"},
{"content":{"body":"* foolip: well something like that is clearly needed for the Sanitizer and we don't want the design for streamHTMLUnsafe to be fundamentally different from streamHTML.","format":"org.matrix.custom.html","formatted_body":"* <a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: well something like that is clearly needed for the Sanitizer and we don't want the design for streamHTMLUnsafe to be fundamentally different from streamHTML.","m.mentions":{},"m.new_content":{"body":"foolip: well something like that is clearly needed for the Sanitizer and we don't want the design for streamHTMLUnsafe to be fundamentally different from streamHTML.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: well something like that is clearly needed for the Sanitizer and we don't want the design for streamHTMLUnsafe to be fundamentally different from streamHTML.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"m.relates_to":{"event_id":"$qKl4sPybkrWDN00u4Lh5yjIbRw-y3aFGgtGOF7PKk7s","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1764091230921,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$JOwvF-CQqFc9NfntwBaAZNDC1kOjf0SGiQhK7QHh73E"},
{"content":{"body":"* foolip: well something like that is clearly needed for the Sanitizer and we don't want the design for `streamHTMLUnsafe()` to be fundamentally different from `streamHTML()`.","format":"org.matrix.custom.html","formatted_body":"* <a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: well something like that is clearly needed for the Sanitizer and we don't want the design for <code>streamHTMLUnsafe()</code> to be fundamentally different from <code>streamHTML()</code>.","m.mentions":{},"m.new_content":{"body":"foolip: well something like that is clearly needed for the Sanitizer and we don't want the design for `streamHTMLUnsafe()` to be fundamentally different from `streamHTML()`.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: well something like that is clearly needed for the Sanitizer and we don't want the design for <code>streamHTMLUnsafe()</code> to be fundamentally different from <code>streamHTML()</code>.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"m.relates_to":{"event_id":"$qKl4sPybkrWDN00u4Lh5yjIbRw-y3aFGgtGOF7PKk7s","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1764091263207,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$D8Ehs1NcXQaeUFqkYrzmXmcwjRwVjr0eME_Kom-GiNQ"},
{"content":{"body":"* foolip: so solving for the Sanitizer is definitely going to be needed to some extent for v1. Much more so than with `setHTMLUnsafe()` as there it was very clear what needed to be done.","format":"org.matrix.custom.html","formatted_body":"* <a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: so solving for the Sanitizer is definitely going to be needed to some extent for v1. Much more so than with <code>setHTMLUnsafe()</code> as there it was very clear what needed to be done.","m.mentions":{},"m.new_content":{"body":"foolip: so solving for the Sanitizer is definitely going to be needed to some extent for v1. Much more so than with `setHTMLUnsafe()` as there it was very clear what needed to be done.","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@foolip:matrix.org\">foolip</a>: so solving for the Sanitizer is definitely going to be needed to some extent for v1. Much more so than with <code>setHTMLUnsafe()</code> as there it was very clear what needed to be done.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"msgtype":"m.text"},"m.relates_to":{"event_id":"$SExvkaH4hXydg5GxTlwQWDzzkSV_wsfI9nlwCoNtSdI","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1764091271851,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$VXa777C7J208vyiXP_X2U7DEO20WqxuC5jNus_srKsE"},
{"content":{"body":"In blink it's basically the fragment parser, but when it's time to insert to the the `root` created in step 7, we insert directly to the context node.\nThere is no inert document in the blink implementation in the first place -  the existing `setHTMLUnsafe` and friends it's basically a `DocumentFragment` and those elements are inserted to that fragment directly.","format":"org.matrix.custom.html","formatted_body":"In blink it's basically the fragment parser, but when it's time to insert to the the <code>root</code> created in step 7, we insert directly to the context node.<br>There is no inert document in the blink implementation in the first place -  the existing <code>setHTMLUnsafe</code> and friends it's basically a <code>DocumentFragment</code> and those elements are inserted to that fragment directly.","m.mentions":{"user_ids":["@foolip:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$3LxxQzDohR_-V7o9w68jxKtVaZ0XJvwOYvvyx_jSL-4"}},"msgtype":"m.text"},"ts":1764091328001,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$10ny5V5hy5-9UolHvkperbKaHfElAEt98QOjH0z-zMM"},
{"content":{"body":"Sure, I suspect all implementations optimize that away, but the observables are the same if you go through a `DocumentFragment`. Not so much if you skip that.","format":"org.matrix.custom.html","formatted_body":"Sure, I suspect all implementations optimize that away, but the observables are the same if you go through a <code>DocumentFragment</code>. Not so much if you skip that.","m.mentions":{},"msgtype":"m.text"},"ts":1764091939029,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$euKMr7sAe93_0cgsLbf6h6RXGS2u3kIinKlUSGWI2Vo"},
{"content":{"body":"... but if the difference was between node creation and insertion times, the DocumentFragment in the middle is not what would matter...\ne.g. if custom elements were created at some point and then asynchronously inserted much later it would be observable with the custom element constructor or some such.\nThe differences we've found so far are the ones you'd expect due to streaming (e.g. classic scripts run immediately)","m.mentions":{},"msgtype":"m.text"},"ts":1764092742970,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$CElMg2vWpPu9q5Ktc4ZhPVJbDFdZ6GoH4PTeH7It8D8"},
{"content":{"body":"* ... but if the difference was between node creation and insertion times, the DocumentFragment in the middle is not what would matter, but rather the inert document...\ne.g. if custom elements were created at some point and then asynchronously inserted much later it would be observable with the custom element constructor or some such.\nThe differences we've found so far are the ones you'd expect due to streaming (e.g. classic scripts run immediately)","m.mentions":{},"m.new_content":{"body":"... but if the difference was between node creation and insertion times, the DocumentFragment in the middle is not what would matter, but rather the inert document...\ne.g. if custom elements were created at some point and then asynchronously inserted much later it would be observable with the custom element constructor or some such.\nThe differences we've found so far are the ones you'd expect due to streaming (e.g. classic scripts run immediately)","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$CElMg2vWpPu9q5Ktc4ZhPVJbDFdZ6GoH4PTeH7It8D8","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1764092756246,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$A8FwmM72FIWcsSEeURTl93T1FxXCvHq82pZXgfBmoO0"},
{"content":{"body":"... at least nothing obvious came up from using the fragment parser in this way and just adjusting the insertion point when inserting into the `root`. It doesn't mean that there aren't surprises somewhere, the parser is pretty big.","format":"org.matrix.custom.html","formatted_body":"... at least nothing obvious came up from using the fragment parser in this way and just adjusting the insertion point when inserting into the <code>root</code>. It doesn't mean that there aren't surprises somewhere, the parser is pretty big.","m.mentions":{},"msgtype":"m.text"},"ts":1764092877779,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$qki5SzIzy1vNb0z6hetC9S3trVhYe87Z8IkAfKNcoF8"},
{"content":{"body":"That's a fair point. I wonder how that works for `img` for instance. That would mean it starts loading before the Sanitizer API gets to it.","format":"org.matrix.custom.html","formatted_body":"That's a fair point. I wonder how that works for <code>img</code> for instance. That would mean it starts loading before the Sanitizer API gets to it.","m.mentions":{},"msgtype":"m.text"},"ts":1764093058446,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$b3dl2WEXxk-gXEq3Xo1q5gQ4Q28G61ZzHe1pHE3DDFE"},
{"content":{"body":"I don't think there's an observable time difference between creating an <img> and inserting it though","m.mentions":{},"msgtype":"m.text"},"ts":1764093257683,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$OHrMROMrfRpweklWgX51dmNpMOe_0-2fTvcVjOWdbac"}
]