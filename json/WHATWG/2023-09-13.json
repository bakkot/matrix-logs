[
{"content":{"body":"I'm looking into StructuredSerializeInternal for Ladybird, and steps 22 and 23 are tripping me up. From looking into blink, it seems like they defer to v8 for the serialization steps, in v8::ValueSerializer. And v8 seems to encode all the data about whether an object (a \"receiver\") is a well known ES object or ES prototype in a tag field. But LibJS doesn't do that, we just have a bunch of classical c++ inheritance. Like there's no \"IsExotic()\" function I can call. \n\nDo all the other engines do this type of tagging of JS objects so that those two catch-all steps are trivial and/or fall out of handling the known object types?","msgtype":"m.text"},"ts":1694630627968,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$fQgmLf_JjgUrPwNAAng7bsbBvWIKg3ecahA7bytE2gA"},
{"content":{"body":"There's certainly no ECMAScript abstract operation I can call to say \"is this a plain old object\" (I think?)","msgtype":"m.text"},"ts":1694630742432,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$0VUZyehYYlKsLQJHuJfUML1SoSfsu4LA7QIHdS4giIQ"},
{"content":{"body":"the prose \"is an ordinary object\" is how 262 does it.","msgtype":"m.text"},"ts":1694631939319,"senderName":"ljharb","senderId":"@ljharb:matrix.org","id":"$Y0cgDslGyzbpNtcHDatWiZM7tOGJ_u2a5-FFtgkDSlA"},
{"content":{"body":" * the prose \"is an ordinary object\" is how 262 does it (in a condition, or assertion, or parameter/return type)","m.new_content":{"body":"the prose \"is an ordinary object\" is how 262 does it (in a condition, or assertion, or parameter/return type)","msgtype":"m.text"},"m.relates_to":{"event_id":"$Y0cgDslGyzbpNtcHDatWiZM7tOGJ_u2a5-FFtgkDSlA","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1694631974792,"senderName":"ljharb","senderId":"@ljharb:matrix.org","id":"$EToVXKy2I1YRNdPrPXFuBWXX4yfUilKMgjzP_dDbdeQ"},
{"content":{"body":"Aha, there's like 40 or so objects in the spec that say \"such and such object: - is an ordinary object\"","msgtype":"m.text"},"ts":1694632240901,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$45DqfVepssQDPrHsDuEkbX0vYTfOaVoaZaQYq91HEyM"},
{"content":{"body":"But I can't clone all of those. Like, no promise, no weakmap, no Finalization registry, no Arguments, ...","msgtype":"m.text"},"ts":1694632426857,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$_0MosOeZbTIl3RmFQAZVGxOkOgudWz_7mB4CSCzLBJw"},
{"content":{"body":"Oh lovely. If I create a new RegExp(\".\", \"\") and try to structuredClone its __proto__ property, Firefox says \"can't clone RegExp.prototype\", and Chromium says \"here's your object\"","msgtype":"m.text"},"ts":1694632893418,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$9d3X7CpxVXYQwA475fHj9NpvPeoZ2Nunol-LVC06Ivw"},
{"content":{"body":"Safari refuses to clone it too ","msgtype":"m.text"},"ts":1694633051578,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$gk98_fFDgl6i1i4lMTQyYrovTU5rkWprrWjKSgRN8Rs"},
{"content":{"body":"Step 22 excludes the ones you're worried about","msgtype":"m.text"},"ts":1694633664984,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$i9JyGgeUbT26JPcBKS-LwoP2XdhVOBr_hcvXWPGUkP4"},
{"content":{"body":"Right.. the best idea I've got for that step at the moment is checking whether my JS::Value is an object and it's class name is \"Object\" ðŸ˜…","msgtype":"m.text"},"ts":1694633729891,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$Z_TxJuAxkK-rBMhdno08K2t7wMCfkm0sGDYljgNZ-jU"},
{"content":{"body":"I do suspect the other two engines also do object type tagging, as it seems helpful for various optimizations","msgtype":"m.text"},"ts":1694633732042,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$GGokZNwa0AAwZ_dFR_XSAZYmpv8OQW_3guFEiD6oVio"},
{"content":{"body":"Yeah, Andreas was brainstorming a radical idea where we create custom vtables to check whether properties/methods are overridden and optimize based on that. But it seems overkill if I just want to get message serialization up and running to implement Workers properly","msgtype":"m.text"},"ts":1694633812696,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$3PJ6iaugNxwwUO9sML3UN7nqnJilkYaaoIsLE5Qe_aU"},
{"content":{"body":"Eh. I'm sure some WPT tests for this and I can clean it up later ","msgtype":"m.text"},"ts":1694633895453,"senderName":"akaster","senderId":"@akaster:serenityos.org","id":"$OzlWPDKKvX3SkROYhS9EYaoMKriKRD_IQBgwyiiusN4"}
]