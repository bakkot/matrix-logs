[
{"content":{"body":"Anyone know the details about the `unload` event fire in Gecko? Per https://software.hixie.ch/utilities/js/live-dom-viewer/saved/14453 it looks like it fires after removal somehow?","format":"org.matrix.custom.html","formatted_body":"Anyone know the details about the <code>unload</code> event fire in Gecko? Per https://software.hixie.ch/utilities/js/live-dom-viewer/saved/14453 it looks like it fires after removal somehow?","m.mentions":{},"msgtype":"m.text"},"ts":1768976450427,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$XtVqzJ_0iD2ihn_x8weMd9D_j9yTo34uruORdB086Sg"},
{"content":{"body":"ended up answering my unicode question and finished my Zig IDNA implementation https://github.com/nektro/zig-unicode-idna :)","m.mentions":{},"msgtype":"m.text"},"ts":1768981984150,"senderName":"nektro","senderId":"@nektro:matrix.org","id":"$43ttKAdevcEBocK4OXmD9KCA9h434pT4IYksyxsKfwI"},
{"content":{"body":"now to get back to url hehe","m.mentions":{},"msgtype":"m.text"},"ts":1768982012277,"senderName":"nektro","senderId":"@nektro:matrix.org","id":"$BGBCPbPdF3opJGvpCKogTu0iFaexT4wcqGP_0UdFueM"},
{"content":{"body":"So everybody else fires it after?","m.mentions":{"user_ids":["@annevk:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$XtVqzJ_0iD2ihn_x8weMd9D_j9yTo34uruORdB086Sg"}},"msgtype":"m.text"},"ts":1768983753079,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$gSI6VHfaA45qDc2O2xS0orT3y4NP0SLtL-pmtSypMq0"},
{"content":{"body":"per spec, is the removal sync? And is the firing of the event async?","m.mentions":{},"msgtype":"m.text"},"ts":1768983810115,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$s1wXVk8E7VqcJ2nY9IxQfThA-p-jBL2FOMRTmxP7rN8"},
{"content":{"body":"I‚Äôm trying to do some code inspection, looking at the code locally ‚Äî but‚Ä¶¬†it‚Äôs pretty hairy","m.mentions":{},"msgtype":"m.text"},"ts":1768983852216,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$7FhT1d7EH7pWYJ_Nak2oUudaacWJCXljYnwB55nBPgg"},
{"content":{"body":"I kind of feel like nobody might know what the code is doing ‚Äî except whoever wrote it or last had to touch it","m.mentions":{},"msgtype":"m.text"},"ts":1768983894844,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$glDMNDqJaddaD-pDQQn2YoUmOf9_XH5kr65ykVdNRrU"},
{"content":{"body":"and probably they don‚Äôt even remember by now","m.mentions":{},"msgtype":"m.text"},"ts":1768983904731,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$iGomj8C_XwlSyG4_kA461HeC9sjRz1mOqfwk8btj4dE"},
{"content":{"body":"but then I guess there‚Äôs a high change ‚Äúthey‚Äù = smaug anyway","m.mentions":{},"msgtype":"m.text"},"ts":1768983930910,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$l4bXfDXlr9NwfkcRNr1mjVhFrHDOs7Dl4recEEQ9H4o"},
{"content":{"body":"anyway, in other news, since I‚Äôm going to be the W3C staff contact for the Web Extensions WG, I figured I should actually try to write a cross-browser extension ‚Äî in order to fully participate in the pain of trying to do that ‚Äî¬†and I managed to come up with an actually-pretty-useful extension:","m.mentions":{},"msgtype":"m.text"},"ts":1768984145680,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$4hSVkGzh_nMf0U8vvi56mZoznINgBFdyu6KrN0nosOM"},
{"content":{"body":"https://github.com/sideshowbarker/social-media-cleanser","m.mentions":{},"msgtype":"m.text"},"ts":1768984152915,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$ki7FFfNEIPtU0kuipixr-R3iR4D6lKI0jmaEnt7HbQ4"},
{"content":{"body":"* ‚Ä¶\nanyway, in other news, since I‚Äôm going to be the W3C staff contact for the Web Extensions WG, I figured I should actually try to write a cross-browser extension ‚Äî in order to fully participate in the pain of trying to do that ‚Äî¬†and I managed to come up with an actually-pretty-useful extension:","m.mentions":{},"m.new_content":{"body":"‚Ä¶\nanyway, in other news, since I‚Äôm going to be the W3C staff contact for the Web Extensions WG, I figured I should actually try to write a cross-browser extension ‚Äî in order to fully participate in the pain of trying to do that ‚Äî¬†and I managed to come up with an actually-pretty-useful extension:","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$4hSVkGzh_nMf0U8vvi56mZoznINgBFdyu6KrN0nosOM","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1768984164917,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$nSOwO80UPj_mfR3ee4xuVw_m-MjMYb7aO9zlMvJnmXA"},
{"content":{"body":"I encourage any and all try to it, and specifically lemme know if you run into any install problems. And otherwise of course, does it actually work for you.","m.mentions":{},"msgtype":"m.text"},"ts":1768984221090,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$HdJaDHwSEuOsJ-6UwaaVZaJ1RWgy-0xJGBPh2kYGkXY"},
{"content":{"body":"In https://github.com/whatwg/html/issues/4611#issuecomment-1960779830 Dominic Farolino claimed all browsers are aligned, but my trivial example from above shows that's not the case.","format":"org.matrix.custom.html","formatted_body":"In https://github.com/whatwg/html/issues/4611#issuecomment-1960779830 <a href=\"https://matrix.to/#/@domfarolino:matrix.org\">Dominic Farolino</a> claimed all browsers are aligned, but my trivial example from above shows that's not the case.","m.mentions":{"user_ids":["@domfarolino:matrix.org"]},"msgtype":"m.text"},"ts":1768984718659,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$H32sFxmXZK0lr_BgsFKcOaQIGFVx6SuHPgqdplQmeDM"},
{"content":{"body":"seems like it‚Äôs async in gecko at least","m.mentions":{},"msgtype":"m.text"},"ts":1768984948704,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$_Z-TaP30MLDNMzDxt5kOnMvpNkZGZIsdJKA2ZeabHmU"},
{"content":{"body":"* seems like it‚Äôs actually async in gecko at least","m.mentions":{},"m.new_content":{"body":"seems like it‚Äôs actually async in gecko at least","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$_Z-TaP30MLDNMzDxt5kOnMvpNkZGZIsdJKA2ZeabHmU","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1768984972724,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$yrtzYK7yJPNzZhZ5OBazdTqvw36oyQG2yED7Whq1tk0"},
{"content":{"body":"I don't think so. At least per https://software.hixie.ch/utilities/js/live-dom-viewer/saved/14454 it seems like they might just clear `frameElement` earlier, but if you cache it in some other way you still get to make changes around the same time. But perhaps maybe it's slightly delayed?","format":"org.matrix.custom.html","formatted_body":"I don't think so. At least per https://software.hixie.ch/utilities/js/live-dom-viewer/saved/14454 it seems like they might just clear <code>frameElement</code> earlier, but if you cache it in some other way you still get to make changes around the same time. But perhaps maybe it's slightly delayed?","m.mentions":{},"msgtype":"m.text"},"ts":1768985443623,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$E_-sH3Wxjrug7pUVd9ohVfLOYoPoOax29IhqfeKTGL0"},
{"content":{"body":"I'm looking at this since rniwa is saying `selectedcontent` is unsafe as specified because of the `unload` event. I'm curious how jarhar dealt with this as I don't really see anything obvious in the Chromium code. I did notice Chromium doesn't appear to clear all non-primary `selectedcontent` elements when testing.","format":"org.matrix.custom.html","formatted_body":"I'm looking at this since rniwa is saying <code>selectedcontent</code> is unsafe as specified because of the <code>unload</code> event. I'm curious how <a href=\"https://matrix.to/#/@jarhar:matrix.org\">jarhar</a> dealt with this as I don't really see anything obvious in the Chromium code. I did notice Chromium doesn't appear to clear all non-primary <code>selectedcontent</code> elements when testing.","m.mentions":{"user_ids":["@jarhar:matrix.org"]},"msgtype":"m.text"},"ts":1768986697482,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$n6k_-tplBx9oTjCq4Tn9l1KJCJFPKzL42yNU6sz8t7s"},
{"content":{"body":"We were looking into something similar very recently on Gecko side and selectedcontent. I thought it was safe after all, but just possibly a bit weird","m.mentions":{},"msgtype":"m.text"},"ts":1768993798822,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$1DMz1H6NsUcBWtFWo9G8c6ko3zT4h0FS3MUtwRP9ILc"},
{"content":{"body":"jjaschke might recall","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@jjaschke:mozilla.org\">jjaschke</a> might recall","m.mentions":{"user_ids":["@jjaschke:mozilla.org"]},"msgtype":"m.text"},"ts":1768993802919,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$vlb5F3YdaaD2StCFMQAOtApu2md7-vXiMq4JWo7VGjI"},
{"content":{"body":"Something about remove all the child nodes","m.mentions":{},"msgtype":"m.text"},"ts":1768993823587,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$OVXIF6U7a3NGIYpgp_lf8D3AEVr2v-NGCwl_Jud-wG4"},
{"content":{"body":"And yes, I couldn't immediately find the code in Chromium doing what the spec says, but didn't spend much time on that","m.mentions":{},"msgtype":"m.text"},"ts":1768993988574,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$heImV1TDZGJoifD6Rln1VvkIAJsVCljQ34LGgdffT5k"},
{"content":{"body":"Selectedcontent calls [replace all with](https://dom.spec.whatwg.org/#concept-node-replace-all) when cloning stuff into it or removing its contents","format":"org.matrix.custom.html","formatted_body":"Selectedcontent calls <a href=\"https://dom.spec.whatwg.org/#concept-node-replace-all\">replace all with</a> when cloning stuff into it or removing its contents","m.mentions":{},"msgtype":"m.text"},"ts":1768994051060,"senderName":"jjaschke","senderId":"@jjaschke:mozilla.org","id":"$YSiXrG-tryKYCY9Qv8Hrqfp9ogTDAH2O0s_4GyvoITo"},
{"content":{"body":"(and similar-ish weirdness may happen for example when using range.deleteContents())","m.mentions":{},"msgtype":"m.text"},"ts":1768995073578,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$we8qlj8gNhgT1ODcmz5TVolSNRyjgA2IgjhNNVVWEvA"},
{"content":{"body":"* (and similar-ish weirdness may happen for example when using range.deleteContents(), so nothing new there)","m.mentions":{},"m.new_content":{"body":"(and similar-ish weirdness may happen for example when using range.deleteContents(), so nothing new there)","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$we8qlj8gNhgT1ODcmz5TVolSNRyjgA2IgjhNNVVWEvA","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1768995116507,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$g7n0cD3sqX_DoagBqXSBMRjt7mUxkDOMfexyA_V9zps"},
{"content":{"body":"so the unsafe thing here is that an <iframe> inside a <selectedcontent> can trigger a `pagehide` that would observe some mid-algorithm state, or some such?","format":"org.matrix.custom.html","formatted_body":"so the unsafe thing here is that an &lt;iframe&gt; inside a &lt;selectedcontent&gt; can trigger a <code>pagehide</code> that would observe some mid-algorithm state, or some such?","m.mentions":{},"msgtype":"m.text"},"ts":1768995214160,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$3oJ8dMlFfM4hab4SbYCzBcfHHDcsV9XXpnpyZFFlhY8"},
{"content":{"body":"yeah, pagehide or unload. That was the worry I had. Not sure if annevk is talking about something else","format":"org.matrix.custom.html","formatted_body":"yeah, pagehide or unload. That was the worry I had. Not sure if <a href=\"https://matrix.to/#/@annevk:matrix.org\">annevk</a> is talking about something else","m.mentions":{"user_ids":["@annevk:matrix.org"]},"msgtype":"m.text"},"ts":1768995262496,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$f9jq24Dnm5TLvuX8dRBSp0TZ_YjfOaMbRH1CmQt7fJA"},
{"content":{"body":"(note that while `unload` is deprecated and has weird cross-browser issues, `pagehide` is relatively interoperable I think and potentially has the same issue so it's easier to reason about)","format":"org.matrix.custom.html","formatted_body":"(note that while <code>unload</code> is deprecated and has weird cross-browser issues, <code>pagehide</code> is relatively interoperable I think and potentially has the same issue so it's easier to reason about)","m.mentions":{},"msgtype":"m.text"},"ts":1768995292213,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$lNifi5R1YQ7SWLV7wcMaNyx8HuZemV-RqziI-xni3ks"},
{"content":{"body":"sure","m.mentions":{},"msgtype":"m.text"},"ts":1768995316273,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$d3DAtaydkzM0f9vuMCDvi8QJeMNSVRLA2W5xRHtfw4M"},
{"content":{"body":"Noam Rosenthal: is `pagehide` synchronous as well? If so, yes. I think we need post-removing steps, maybe?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@noamr:matrix.org\">Noam Rosenthal</a>: is <code>pagehide</code> synchronous as well? If so, yes. I think we need post-removing steps, maybe?","m.mentions":{"user_ids":["@noamr:matrix.org"]},"msgtype":"m.text"},"ts":1769001633426,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$QrffGHT2H5lSskFDsGQwcG9RguasvVr-6aWG-AsXGGM"},
{"content":{"body":"> <@annevk:matrix.org> Noam Rosenthal: is `pagehide` synchronous as well? If so, yes. I think we need post-removing steps, maybe?\n\nIt is. It is the only synchronous removal step that can run scripts (though blink still has blur events)","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$QrffGHT2H5lSskFDsGQwcG9RguasvVr-6aWG-AsXGGM?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@annevk:matrix.org\">@annevk:matrix.org</a><br /><a href=\"https://matrix.to/#/@noamr:matrix.org\">Noam Rosenthal</a>: is <code>pagehide</code> synchronous as well? If so, yes. I think we need post-removing steps, maybe?</blockquote></mx-reply>It is. It is the only synchronous removal step that can run scripts (though blink still has blur events)","m.relates_to":{"m.in_reply_to":{"event_id":"$QrffGHT2H5lSskFDsGQwcG9RguasvVr-6aWG-AsXGGM"}},"msgtype":"m.text"},"ts":1769001693457,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$G0xyB-g5RexXvikk-kGjPcCLoeqKxccq0DohJEq_VGo"},
{"content":{"body":"I'll just make the issue about pagehide then.","m.mentions":{},"msgtype":"m.text"},"ts":1769001792104,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$3Gtz1G54Vp0gFz2CdMwmEAC1S5dQeP18iDyBbI8lqWQ"},
{"content":{"body":"https://github.com/whatwg/html/issues/12096","m.mentions":{},"msgtype":"m.text"},"ts":1769001921867,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$4mrNRnDEwBAgnH6xrZEfVT2ZEvDG4MttJ3wLMw8qz7k"},
{"content":{"body":"smaug: yeah rniwa was a bit stricter than you I suppose and just said no. üòä","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@smaug:mozilla.org\">smaug</a>: yeah rniwa was a bit stricter than you I suppose and just said no. üòä","m.mentions":{"user_ids":["@smaug:mozilla.org"]},"msgtype":"m.text"},"ts":1769002221543,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$-mxh0iQVit8ujHnGv-gUVrgFBo-5842NbqQDurC_Gdc"},
{"content":{"body":"annevk: not sure if post removal steps would help. It's a really tricky one. We explored it when dealing with moveBefore though it ended up not being an issue there because moveBefore surpresses iframe removal. Will comment on the issue ","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:matrix.org\">@annevk:matrix.org</a>: not sure if post removal steps would help. It's a really tricky one. We explored it when dealing with moveBefore though it ended up not being an issue there because moveBefore surpresses iframe removal. Will comment on the issue ","msgtype":"m.text"},"ts":1769002258684,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$8r3FK_mblchoUotqxN6soiorjPFrJKIn3QXscU98fC4"},
{"content":{"body":"The safest thing would be to disallow subframes in selectedcontent but I don't know if it breaks use cases or not ","msgtype":"m.text"},"ts":1769002289732,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$m-Inue6Ol1mlJUlvZq2JoXUUJHD43VkHvWsTzxI_gS8"},
{"content":{"body":"If we remove the nesting by postponing the removal I'm not sure what issue would remain? It does seem possible someone can think of use cases for selecting between nested documents, even if a bit absurd.","m.mentions":{},"msgtype":"m.text"},"ts":1769002416710,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$vuVhiHLQ4TbL6LSaNbeT7E5HWBrKDdG0aY4CbUVyZuw"},
{"content":{"body":"Oh postponing the removal specifically in selectedcontent? That would also work.","msgtype":"m.text"},"ts":1769002463438,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$q4y3gWujAHeANy3771FpbBuD5LUB_eBjRTxLnQn72Z0"},
{"content":{"body":"Right, specifically in the case where removal would otherwise end up nesting.","m.mentions":{},"msgtype":"m.text"},"ts":1769002487476,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$lkf9HJBgeQy-iBPEwc5Veb66gYhC7k5W6KxKBukI3po"},
{"content":{"body":"annevk: I'm not sure what \"remove the nesting by postponing the removal\" means? Do you mean run the pagehide first, and postpone the actual DOM removal until after that event has fired?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@annevk:matrix.org\">annevk</a>: I'm not sure what \"remove the nesting by postponing the removal\" means? Do you mean run the pagehide first, and postpone the actual DOM removal until after that event has fired?","m.mentions":{"user_ids":["@annevk:matrix.org"]},"msgtype":"m.text"},"ts":1769008406921,"senderName":"Dominic Farolino","senderId":"@domfarolino:matrix.org","id":"$rtOFXK6B8z5DUIH2dFGg7qd1XmlEDaOBf8DZ5fyGl_Y"}
]