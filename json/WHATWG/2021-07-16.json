[
{"content":{"body":"https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/parser/html_meta_charset_parser.h;l=58 indeed looks a lot like Chromium is using the real HTML tokenizer. But not the real tree builder: https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/parser/html_meta_charset_parser.h;l=58","msgtype":"m.text"},"ts":1626420890209,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$b0Erdy3ZaRRjxhmP9efbLHKKT8yKMH1crR1g6hFyl_Y"},
{"content":{"body":"Can anyone think of bad Web compat consequences from using the real tree builder algorithm for figuring out where `body` starts?","format":"org.matrix.custom.html","formatted_body":"Can anyone think of bad Web compat consequences from using the real tree builder algorithm for figuring out where <code>body</code> starts?","msgtype":"m.text"},"ts":1626420946795,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$EyeyZ70x3sJg1zHGqx6vnIbH6MGAlqYKcIVZ9XXsQVw"},
{"content":{"body":"That is, running the tree builder in the scripting enabled mode without actually executing scripts during the `meta` prescan?","format":"org.matrix.custom.html","formatted_body":"That is, running the tree builder in the scripting enabled mode without actually executing scripts during the <code>meta</code> prescan?","msgtype":"m.text"},"ts":1626420988469,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$XUcDuYZ3nVZEbc0uuLrjjqN6AskLY-RN9roKrj7xd30"},
{"content":{"body":"Oops. The second link was supposed to be https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/parser/html_meta_charset_parser.h;l=58","msgtype":"m.text"},"ts":1626421063654,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$7_Uf1XfAX1qI5wwkBdAl5PTrbudiZ0ksPkWzRy8nOM8"},
{"content":{"body":"What","msgtype":"m.text"},"ts":1626421071420,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$y1HRSuKn0N7EUEIGeUJs1G8gDRzklL8G2Gp2-vdc1M0"},
{"content":{"body":"https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/parser/html_meta_charset_parser.cc;l=88","msgtype":"m.text"},"ts":1626421094568,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$8Bd8ws6BphMSJZtAoGzpVcdGlaiFfIU69EQzuL0qzyU"},
{"content":{"body":"Something weird going on with how the copypasteable URL updates.","msgtype":"m.text"},"ts":1626421107803,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$OLBZvh8zs7UrNZEH4WvPyrg5op7vxK_ZB5WtrG5_WXg"},
{"content":{"body":"AFAICT, the biggest risk is probably `meta` inside `script` in a manner that should be honored for compat. Need to write tests...","format":"org.matrix.custom.html","formatted_body":"AFAICT, the biggest risk is probably <code>meta</code> inside <code>script</code> in a manner that should be honored for compat. Need to write tests...","msgtype":"m.text"},"ts":1626421291580,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$YZBVMWNwdk7bQSQ6YGjvrT6dTZjAV4gfMefj5o4U2gc"},
{"content":{"body":"> <@hsivonen:mozilla.org> AFAICT, the biggest risk is probably `meta` inside `script` in a manner that should be honored for compat. Need to write tests...\n\nFWIW, I would be strongly in favour of not allowing this (or `meta` inside `noscript`), if we could get away this from a compat POV","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$YZBVMWNwdk7bQSQ6YGjvrT6dTZjAV4gfMefj5o4U2gc?via=mozilla.org&via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@hsivonen:mozilla.org\">@hsivonen:mozilla.org</a><br>AFAICT, the biggest risk is probably <code>meta</code> inside <code>script</code> in a manner that should be honored for compat. Need to write tests...</blockquote></mx-reply>FWIW, I would be strongly in favour of not allowing this (or <code>meta</code> inside <code>noscript</code>), if we could get away this from a compat POV","m.relates_to":{"m.in_reply_to":{"event_id":"$YZBVMWNwdk7bQSQ6YGjvrT6dTZjAV4gfMefj5o4U2gc"}},"msgtype":"m.text"},"ts":1626426312030,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$JySB5g0TtjDS9NzKXtLTzGhnLOB59V9lTW9zklNh-ic"},
{"content":{"body":"I don't know the origins of why Hixie spec'd it as allowing it, though…","msgtype":"m.text"},"ts":1626426447244,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$LJAq0-4uhJI4M9sHwlNJQe5o5MpBgr8aPa_jLpYrd94"},
{"content":{"body":"Compat is nice and all, but sometimes I understand why people wanted to burn it all to the ground","msgtype":"m.text"},"ts":1626426455486,"senderName":"Ms2ger","senderId":"@ms2ger:igalia.com","id":"$Er7hRnJnqCpE41RF_aPw8aBjV3Ih3KZ5t3eQh07j2jA"},
{"content":{"body":"I guess it's somewhat difficult to avoid the actual parser changing encoding from `document.write`, and probably practically unacceptable :(","format":"org.matrix.custom.html","formatted_body":"I guess it's somewhat difficult to avoid the actual parser changing encoding from <code>document.write</code>, and probably practically unacceptable :(","msgtype":"m.text"},"ts":1626426781823,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$Eonw5SbRYV-tOwHyo9Rya3LyPtclfaD38Ep0JqbIjTQ"},
{"content":{"body":"Compat is nice / but compat can stop you / from doing all the things in life you'd like to.","msgtype":"m.text"},"ts":1626426864008,"senderName":"jgraham","senderId":"@jgraham_:matrix.org","id":"$6WpkAaqLOqS55Ax5vvPxAhOvi-_mlb6ThToWzCgf0zA"},
{"content":{"body":"(also I think to quote The Smiths these days, one need to pretend that Morrissey doesn't exist and it's all Johnny Marr)","msgtype":"m.text"},"ts":1626426961608,"senderName":"jgraham","senderId":"@jgraham_:matrix.org","id":"$Rv_e2jt4wbkhvjZZlnIDHMxEZAUdBofNgrKHOI5AIw4"},
{"content":{"body":"Who are The Smiths?","msgtype":"m.text"},"ts":1626426976450,"senderName":"Ms2ger","senderId":"@ms2ger:igalia.com","id":"$eph_ZDdLhoX64f77RBCYsOA_uo293dlXK4WD5w_LSwo"},
{"content":{"body":"gets inspired to put on a far more acceptable band, The Jesus and the Mary Chain","msgtype":"m.emote"},"ts":1626427095628,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$4MabETP_ZN2e9LmzXhFw-AiRLc6OTd464L3u6DjCX74"},
{"content":{"body":"> <@gsnedders:mozilla.org> I don't know the origins of why Hixie spec'd it as allowing it, though…\n\nI thought Hixie specced it the way it's specced in order to imitate IE6. However, I could be wrong and maybe the spec is creative in ways it shouldn't have been.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$LJAq0-4uhJI4M9sHwlNJQe5o5MpBgr8aPa_jLpYrd94?via=mozilla.org&via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@gsnedders:mozilla.org\">@gsnedders:mozilla.org</a><br>I don&#39;t know the origins of why Hixie spec&#39;d it as allowing it, though…</blockquote></mx-reply>I thought Hixie specced it the way it's specced in order to imitate IE6. However, I could be wrong and maybe the spec is creative in ways it shouldn't have been.","m.relates_to":{"m.in_reply_to":{"event_id":"$LJAq0-4uhJI4M9sHwlNJQe5o5MpBgr8aPa_jLpYrd94"}},"msgtype":"m.text"},"ts":1626427410114,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$NumHoWL7TKCOy6naVHzHGnTHJFvFK4TO11syyQ4ljgc"},
{"content":{"body":"> <@hsivonen:mozilla.org> I thought Hixie specced it the way it's specced in order to imitate IE6. However, I could be wrong and maybe the spec is creative in ways it shouldn't have been.\n\nI have a suspicion that it didn't handle `<script>` for the sake of keeping the prescan as simple as possible?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$NumHoWL7TKCOy6naVHzHGnTHJFvFK4TO11syyQ4ljgc?via=mozilla.org&via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@hsivonen:mozilla.org\">@hsivonen:mozilla.org</a><br>I thought Hixie specced it the way it's specced in order to imitate IE6. However, I could be wrong and maybe the spec is creative in ways it shouldn't have been.</blockquote></mx-reply>I have a suspicion that it didn't handle <code>&lt;script&gt;</code> for the sake of keeping the prescan as simple as possible?","m.relates_to":{"m.in_reply_to":{"event_id":"$NumHoWL7TKCOy6naVHzHGnTHJFvFK4TO11syyQ4ljgc"}},"msgtype":"m.text"},"ts":1626427467804,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$hFGTZTnmtmszg0iWqGFxRN7aG6taz1dkI6Sm-cYObmc"},
{"content":{"body":"Also possible.","msgtype":"m.text"},"ts":1626427479807,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$sPPjbYS61YSr5WMtSnuzDL41NPtHbm8rb05JZZf12_o"},
{"content":{"body":"If I'm reading the Chromium code correctly, it's running the tokeniser with scripting disabled, which means the prescan would pick up `<noscript><meta charset=…>`","format":"org.matrix.custom.html","formatted_body":"If I'm reading the Chromium code correctly, it's running the tokeniser with scripting disabled, which means the prescan would pick up <code>&lt;noscript&gt;&lt;meta charset=…&gt;</code>","msgtype":"m.text"},"ts":1626427936402,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$4IH0N3Iwtq4RDH8z8h0MmeB38ptTtXQpv0jci5Ign0o"},
{"content":{"body":"Fun","msgtype":"m.text"},"ts":1626427947500,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$tKad9cMzgik6RYDX3eRJltwnbnZ30sETnZBGIuJBk0Q"},
{"content":{"body":"What would be a simple way for the page to self-diagnose whether there was a charset reload?","msgtype":"m.text"},"ts":1626427986493,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$FRHu5VImVQVB-fWNjfgUhOSvISG98ZL99GA9j5Sy33o"},
{"content":{"body":"write in localStorage? though I guess that depends on how it deals with committing things there","msgtype":"m.text"},"ts":1626428011313,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$EUxPvabszeMvrZrtdnAlliXEUC08l-mnv_xucrzjmhU"},
{"content":{"body":"I guess local-storage would involve having to edit a test-specific key into each test.","msgtype":"m.text"},"ts":1626428051856,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$SB53NTINIyuqT7XZsoQHUeiRB5r5i9y7GlMbtK9598w"},
{"content":{"body":"> <@gsnedders:mozilla.org> I guess it's somewhat difficult to avoid the actual parser changing encoding from `document.write`, and probably practically unacceptable :(\n\na more radical suggestion to deal with `document.write` for the parser would be to change the confidence to `certain` before executing any script; I wonder how often that would change things…","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$Eonw5SbRYV-tOwHyo9Rya3LyPtclfaD38Ep0JqbIjTQ?via=mozilla.org&via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@gsnedders:mozilla.org\">@gsnedders:mozilla.org</a><br>I guess it's somewhat difficult to avoid the actual parser changing encoding from <code>document.write</code>, and probably practically unacceptable :(</blockquote></mx-reply>a more radical suggestion to deal with <code>document.write</code> for the parser would be to change the confidence to <code>certain</code> before executing any script; I wonder how often that would change things…","m.relates_to":{"m.in_reply_to":{"event_id":"$Eonw5SbRYV-tOwHyo9Rya3LyPtclfaD38Ep0JqbIjTQ"}},"msgtype":"m.text"},"ts":1626428088921,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$NcNMo0_JJ_ng463l2hL0u4pQJtpONsitahfTkaUm_JI"},
{"content":{"body":"Pretty sure that would break the Web.","msgtype":"m.text"},"ts":1626428110563,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$75XSqoGpLdrKYUeKej7-1YBRygZFr1rY_JH8JfUnw34"},
{"content":{"body":"I can find very little evidence for sites using `document.write(\"<meta charset=…>\")` at least, but yeah, I suspect it would break the web due to sites having the meta after a first script","format":"org.matrix.custom.html","formatted_body":"I can find very little evidence for sites using <code>document.write(&quot;&lt;meta charset=…&gt;&quot;)</code> at least, but yeah, I suspect it would break the web due to sites having the meta after a first script","msgtype":"m.text"},"ts":1626428147654,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$TU0IPRBw7I0NweKg3oBWuxRYOHr3nKcOGSOFnKl3UG4"},
{"content":{"body":"even just changing changing it to certain on a `document.write` call would I expect break things :(","format":"org.matrix.custom.html","formatted_body":"even just changing changing it to certain on a <code>document.write</code> call would I expect break things :(","msgtype":"m.text"},"ts":1626428195515,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$qp52rVSm_LsXAiduQENnhHg4m1fv9fahxxfgfx1kd4k"},
{"content":{"body":"Wouldn't that have to be `document.write(\"<meta ch\" + \"arset=...\")`?","format":"org.matrix.custom.html","formatted_body":"Wouldn't that have to be <code>document.write(&quot;&lt;meta ch&quot; + &quot;arset=...&quot;)</code>?","msgtype":"m.text"},"ts":1626428204316,"senderName":"Andreu Botella (he/they)","senderId":"@andreubotella:mozilla.org","id":"$y2AI3ha0awRURIS5K6g3bfPPpK-k1qXDr8KhI5RLX2U"},
{"content":{"body":"to avoid the prescan? yes","msgtype":"m.text"},"ts":1626428218705,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$fJ05QM7OIy7g3ciCJL-dPuhvuBDhskcTW3TmpC29yYI"},
{"content":{"body":"my hypothesis is few sites are deliberately trying to avoid the prescanner 🙃","msgtype":"m.text"},"ts":1626428262465,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$42JGJ9EwBQO6Z2hmw38r2Hr_o6jf-YmETwmmNR5s6xc"},
{"content":{"body":"That WebKit/Blink got away with https://hsivonen.com/test/moz/meta/after-head-after-1kb.htm goes against my intuition of the Web.","msgtype":"m.text"},"ts":1626428561200,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$yNjWJRgUbgFL4OzyZ6BD1BCCnE0zQhc8qfn8DtEiGCI"},
{"content":{"body":"Too bad that for TLS reasons, it's very annoying to test IE6 these days.","msgtype":"m.text"},"ts":1626428610090,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$71TkUO7EEnHunUxUt2xWLyl1YS-DPmnILBopij_fh7M"},
{"content":{"body":"Please leave your intuition at the door as well?","msgtype":"m.text"},"ts":1626428616167,"senderName":"Ms2ger","senderId":"@ms2ger:igalia.com","id":"$0D4YjEqYbq9AM8d33FFf17yeVAZH8bFqTbVd8FMciYM"},
{"content":{"body":"is that another difference with the prescanner? (after `</head>`)","format":"org.matrix.custom.html","formatted_body":"is that another difference with the prescanner? (after <code>&lt;/head&gt;</code>)","msgtype":"m.text"},"ts":1626428642655,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$r_IO9c73KyhTy9T09KjhWzaWnwnhvGJaYmqQvFoqNtQ"},
{"content":{"body":"Looking for the end of `head` is a WebKit/Blink difference from the spec. The one that I'm trying to resolve in Gecko.","format":"org.matrix.custom.html","formatted_body":"Looking for the end of <code>head</code> is a WebKit/Blink difference from the spec. The one that I'm trying to resolve in Gecko.","msgtype":"m.text"},"ts":1626428690590,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$fIaDcMwDu2I2E3bGHeB3ohh7veKY6BLTjrwGRlDNEv4"},
{"content":{"body":"Specifically, I'm trying to make Gecko load https://hsivonen.com/test/moz/meta/after-1kb.htm like WebKit/Blink without reloading. (With this test the reload is so fast that you don't notice.)","msgtype":"m.text"},"ts":1626428823431,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$2wh-kwvNKZWp_UNZasUJp2hwp1pn03h5QSDMW3r5qDM"},
{"content":{"body":"(As for why not just go ahead and do exactly what Chrome does: That would involve introducing the capability of the tokenizer to have different kinds of token sinks in Gecko. Also, if using the tree builder works, the prescan process could yield speculative loads.)","msgtype":"m.text"},"ts":1626428957305,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$joRhoQyRRbHhKQdrUQE538yL9VEGQ_2AxA0M3VlhzRQ"},
{"content":{"body":"the only difference then would be the prescan running without scripting?","msgtype":"m.text"},"ts":1626429252486,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$PPlKuVUkMmR-NKqCkJ5eoDK8ve3-YumdOui34Yy78mE"},
{"content":{"body":"(v. the \"real\" parser)","msgtype":"m.text"},"ts":1626429284778,"senderName":"Sam Sneddon [:gsnedders]","senderId":"@gsnedders:mozilla.org","id":"$lTgDEwikoe7X1HofpPLVk7Z-Bts7COZaMoJfvwsAtlk"},
{"content":{"body":"> <@gsnedders:mozilla.org> the only difference then would be the prescan running without scripting?\n\nYes. In particular, the prescan could be the real parse if UTF-8 is declared and none of the scripts `document.write`. That is, it could be a speculative real parse.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$PPlKuVUkMmR-NKqCkJ5eoDK8ve3-YumdOui34Yy78mE?via=mozilla.org&via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@gsnedders:mozilla.org\">@gsnedders:mozilla.org</a><br>the only difference then would be the prescan running without scripting?</blockquote></mx-reply>Yes. In particular, the prescan could be the real parse if UTF-8 is declared and none of the scripts <code>document.write</code>. That is, it could be a speculative real parse.","m.relates_to":{"m.in_reply_to":{"event_id":"$PPlKuVUkMmR-NKqCkJ5eoDK8ve3-YumdOui34Yy78mE"}},"msgtype":"m.text"},"ts":1626438021917,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$vkkR7qdBJCMACaG-SRqcYGmz1KtdnQ5S9Idnsl8ZjSw"},
{"content":{"body":"So far, `noscript` is the only case where using the real tree builder would differ from Chrome: https://hsivonen.com/test/moz/meta/","format":"org.matrix.custom.html","formatted_body":"So far, <code>noscript</code> is the only case where using the real tree builder would differ from Chrome: https://hsivonen.com/test/moz/meta/","msgtype":"m.text"},"ts":1626438613461,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$AGTkxY_g5WQvxjBTxzNExEK7J5_l-Wb8pBdpEnMFJAU"},
{"content":{"body":"Another difference between Chrome and the real tree builder: https://hsivonen.com/test/moz/meta/in-template-after-1kb.htm","msgtype":"m.text"},"ts":1626439538426,"senderName":"hsivonen","senderId":"@hsivonen:mozilla.org","id":"$yl_vi-q21ED2Ak1fNfX_NzXlPAWHGptOoDLgvYScc1o"},
{"content":{"body":"I noticed that on the introduction page ( html.spec.whatwg.org/multipage/introduction.html ) the section :\"Design Notes\"  includes a paragraph stating:  Authors can create plugins and invoke them using the embed element. This is how Flash works.\n\nSince the announcement of Adobe ending support of Flash Player on December 31, 2020,\nshould this be revised to provide a different example?","msgtype":"m.text"},"ts":1626466174922,"senderName":"dg12","senderId":"@dg12:matrix.org","id":"$cFs0GYez4bsb28JTcCnii-PuSTX51IHESHNBccyYxpw"}
]