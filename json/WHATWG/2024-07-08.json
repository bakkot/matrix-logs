[
{"content":{"body":"krosylight: how are push subscriptions scoped currently? An origin can in theory create infinite service workers. Would each of them be able to get a push subscription? Or is there some implementation-defined limit?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@krosylight:mozilla.org\">krosylight</a>: how are push subscriptions scoped currently? An origin can in theory create infinite service workers. Would each of them be able to get a push subscription? Or is there some implementation-defined limit?","m.mentions":{"user_ids":["@krosylight:mozilla.org"]},"msgtype":"m.text"},"ts":1720437824768,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc"},
{"content":{"body":"> <@annevk:matrix.org> krosylight: how are push subscriptions scoped currently? An origin can in theory create infinite service workers. Would each of them be able to get a push subscription? Or is there some implementation-defined limit?\n\nI don't have an answer right now, I'll ask our push backend engineer. (I don't immediately see anything from the gecko side)","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@annevk:matrix.org\">@annevk:matrix.org</a><br><a href=\"https://matrix.to/#/@krosylight:mozilla.org\">krosylight</a>: how are push subscriptions scoped currently? An origin can in theory create infinite service workers. Would each of them be able to get a push subscription? Or is there some implementation-defined limit?</blockquote></mx-reply>I don't have an answer right now, I'll ask our push backend engineer. (I don't immediately see anything from the gecko side)","m.mentions":{"user_ids":["@annevk:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc"}},"msgtype":"m.text"},"ts":1720442033216,"senderName":"krosylight","senderId":"@krosylight:mozilla.org","id":"$mbSvgQZl_ONHejWG5djWodo7A56sK_QsfHeZ_BXeGGY"},
{"content":{"body":"krosylight: ta, will do the same","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@krosylight:mozilla.org\">krosylight</a>: ta, will do the same","m.mentions":{"user_ids":["@krosylight:mozilla.org"]},"msgtype":"m.text"},"ts":1720442239219,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$SwvF6aZYSVFXuMnIqe8D9ycagIkf_QRrhmDr1LDp4rw"},
{"content":{"body":"krosylight: I plan on working on declarative web push again, so there will be some more activity until my vacation starts anyway","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@krosylight:mozilla.org\">krosylight</a>: I plan on working on declarative web push again, so there will be some more activity until my vacation starts anyway","m.mentions":{"user_ids":["@krosylight:mozilla.org"]},"msgtype":"m.text"},"ts":1720442277731,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$A2W9Ow3HnCPM73Zb_8gFSlb_x6rrG9_ybgzuuugbQsk"},
{"content":{"body":"Speaking of which, anyone here familiar with whether there's anything remotely like file signatures for JSON? Using a rather unique key is the best I've come up with thus far.","m.mentions":{},"msgtype":"m.text"},"ts":1720448585937,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$r64FR0h2dqxpTdGFVLj86HJOcktnZqe85lfT1rVMQ40"},
{"content":{"body":"for people using json-schema, they use `$schema` key to point to a URL of the accepted json-schema format","format":"org.matrix.custom.html","formatted_body":"for people using json-schema, they use <code>$schema</code> key to point to a URL of the accepted json-schema format","m.mentions":{},"msgtype":"m.text"},"ts":1720448928474,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$avc8PCXGyp39EPYneddIan4nCNRrqrqCJRPow4VZ5fY"},
{"content":{"body":"maybe that's what you mean with a \"rather unique key\"? Even if a file has that special key, you'd still have to check that all keys and values are: present, not duplicate, of the right type etc.","m.mentions":{},"msgtype":"m.text"},"ts":1720448974135,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$uhOpYRRsqTZPCF9fmjE9mx0V8C99ToU_tcP8Zpqk4wU"},
{"content":{"body":"Hi, Push Engineer here.\nSo, technically, a UserAgent could have as many subscriptions as there is numberspace in a UUID4. (Subscriptions are identified as \"Channel IDs\" or CHIDs). Push subscriptions are fairly cheap on the server side since at most they require adding a mostly empty row to a Bigtable database. The server then encrypts the UAID and CHID into the subscription URL and that's what you're getting back. Of course, having that many subscription updates will do frankly horrible things to the UA, which has to manage, decrypt, and process those subscriptions, so there's the very high likelihood that even if only a percentage of those subscriptions were active, you'd swamp the network and CPU for the UA. ","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449126303,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$xOY9MbDJ-QOd67cFhMPv9jf5mLn_pF1rjWdY8py1VK4"},
{"content":{"body":"If you're interested, the code we use is [here](https://github.com/mozilla-services/autopush-rs/). It's in rust, with Python integration tests.","format":"org.matrix.custom.html","formatted_body":"If you're interested, the code we use is <a href=\"https://github.com/mozilla-services/autopush-rs/\">here</a>. It's in rust, with Python integration tests.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$xOY9MbDJ-QOd67cFhMPv9jf5mLn_pF1rjWdY8py1VK4"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449185856,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$KWJLI9kZAPp70JyrkzqM6WUIu-EIqRDWOJAldL2X9jA"},
{"content":{"body":"It seems that only self-identifies schemas, but yeah, I guess something like that is what I mean. And yeah, it's clear all the validation still has to happen.","m.mentions":{},"msgtype":"m.text"},"ts":1720449199384,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$HgtZ9tXZDoaahsbm_E8WrlZ_hoa3vK8CeLy3PCptVJE"},
{"content":{"body":"But what about a website? A website can have many service workers (infinite, in fact) which means it could single-handedly DOS? That'd be bad, no?","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$KWJLI9kZAPp70JyrkzqM6WUIu-EIqRDWOJAldL2X9jA"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449280752,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$QzpI6F9VTqlf52_f_1LvuL80CKeelt9EN179BXocudM"},
{"content":{"body":"By DOS, what are you intending to DOS? Our push server? The UA? ","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$QzpI6F9VTqlf52_f_1LvuL80CKeelt9EN179BXocudM"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449413018,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$YL4LzFRlsaEvMatd5Uejg1fElbw18SUIyf2n9AR32wY"},
{"content":{"body":"Not sure, maybe it doesn't really matter as it's all behind a permission anyway. But might be tricky for the end user to clean up if it goes bad and it's not anticipated.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$YL4LzFRlsaEvMatd5Uejg1fElbw18SUIyf2n9AR32wY"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449535909,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$ZsOl2N-B6tQy-dKalIw05chUk6WaUNm0HmLXPs9YJto"},
{"content":{"body":"Push currently handles a ludicrous number of messages a minute. We are very free with 503 messages if we see a source generating a lot of messages, and even more generous with the backoff messages if we see some service ignoring the 503s.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$ZsOl2N-B6tQy-dKalIw05chUk6WaUNm0HmLXPs9YJto"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449564564,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$NBqU8aunCg-mDZpTrXOVzIl_On1mKvFoc0HWT06T8cE"},
{"content":{"body":"Ah, so you're thinking more on the UA side. ","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$NBqU8aunCg-mDZpTrXOVzIl_On1mKvFoc0HWT06T8cE"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449581204,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$_RXKvW9rB8kyv8BD8fjCV0mzoWI142efWvY1XDLF_vg"},
{"content":{"body":"Yeah, I guess so. Services already have to scale and deal with abuse so the additional angle of many registrations for a single origin prolly doesn't hurt them much.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$_RXKvW9rB8kyv8BD8fjCV0mzoWI142efWvY1XDLF_vg"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720449670618,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$X-yJiWpMzOeDPylLsyP5d-xImytT4iC7uxgtxkO-by8"},
{"content":{"body":"Ok, so here are a few odd scenarios that could happen:\n1) Rogue site generates stupid number of ChannelIDs (push subscription endpoints). \nEach UA has to record the subscription info locally, so at some point there may be resource restrictions that it hits. Added bonus, if they're a mobile device, there's also a \"daily check-in\" that can occur which would make their device potentially useless while that happens. Eventually, they'd just reinstall the browser, I guess? \n2) Rogue site generates small number of subscriptions that it then barrages the UA with (ala https://mozilla-services.github.io/WebPushDataTestPage/ ) Mind you, the user has to agree to at least setting things up, and each push message popup identifies the source. User then has to disable the notification permission using native controls. ","format":"org.matrix.custom.html","formatted_body":"<p>Ok, so here are a few odd scenarios that could happen:</p>\n<ol>\n<li>Rogue site generates stupid number of ChannelIDs (push subscription endpoints).<br>Each UA has to record the subscription info locally, so at some point there may be resource restrictions that it hits. Added bonus, if they're a mobile device, there's also a \"daily check-in\" that can occur which would make their device potentially useless while that happens. Eventually, they'd just reinstall the browser, I guess?</li>\n<li>Rogue site generates small number of subscriptions that it then barrages the UA with (ala https://mozilla-services.github.io/WebPushDataTestPage/ ) Mind you, the user has to agree to at least setting things up, and each push message popup identifies the source. User then has to disable the notification permission using native controls.</li>\n</ol>\n","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$X-yJiWpMzOeDPylLsyP5d-xImytT4iC7uxgtxkO-by8"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720450050560,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$ajIt_dwtoYs_7GwSNih6_cK73RN8Mnt_Wt19-rLgbWw"},
{"content":{"body":"I mean, in a perfectly frictionless network filled with spherical cows, then I can see this as being a problem, but in reality, I think there will be a number of other factors at play. At most, the user uninstalls or resets their browser. Subscriptions are generally not synced by any of the browser publishers for A LOT of reasons, so the recovery will not cause the problem to happen, unless they do the same thing again.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$ajIt_dwtoYs_7GwSNih6_cK73RN8Mnt_Wt19-rLgbWw"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720450186906,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$_8ksFKZ94deLBOVAG2J7mFky55TcBPguFilO44oyhMg"},
{"content":{"body":"Yeah makes sense. I'm gonna ask around if we do anything, but I agree that things are prolly ok for the majority of cases.\n\nThanks for the help!","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$_8ksFKZ94deLBOVAG2J7mFky55TcBPguFilO44oyhMg"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720450238771,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$ive_djifPgo5oaXGW6W_8uVmB92bqmLGggAFGZWcUKs"},
{"content":{"body":"I also don't mean to dismiss your concern. It's very valid. FWIW, there are a few things I've seen in my monitoring that are sketchy as hell and I'd love to know more of what the heck those connections are doing.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$ive_djifPgo5oaXGW6W_8uVmB92bqmLGggAFGZWcUKs"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720450254057,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$64Ac5hZP_YrtQ16i-hFX9lHRjp61R_NLDWszp4zZpDY"},
{"content":{"body":"That said, PLEASE ask more questions like this. Poking at the protocol is really, really important and I absolutely welcome folk doing that.","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$64Ac5hZP_YrtQ16i-hFX9lHRjp61R_NLDWszp4zZpDY"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720450303810,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$yWDC0-XriLfGCMz_4biMo2anMuc3C-QSME1ydKWjH-Y"},
{"content":{"body":"(Honestly? I'd be fine if the UA were to limit the number of push subscriptions to something, even if it were some arbitrary number like 256.) Like I said, the bulk of the work is more on the UA than the backend server. ","m.mentions":{},"m.relates_to":{"event_id":"$qz6NzCPvRmfWVtOwTDmMKFm1M0xc1fKl0DB4Z4sdUVc","is_falling_back":true,"m.in_reply_to":{"event_id":"$yWDC0-XriLfGCMz_4biMo2anMuc3C-QSME1ydKWjH-Y"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1720450395890,"senderName":"jrconlin","senderId":"@jrconlin:mozilla.org","id":"$jJsF2H54Cj3uW0oBC_pzwgkhqV2onPBPpuVGIGZuPJ8"}
]