[
{"content":{"body":"cries a little bit. Yet [another](https://html.spec.whatwg.org/#:~:text=Prepare%20to%20run%20script%20given%20document%27s%20relevant%20settings%20object%2E) \"let's break how microtasks work\" special case.","format":"org.matrix.custom.html","formatted_body":"cries a little bit. Yet <a href=\"https://html.spec.whatwg.org/#:~:text=Prepare%20to%20run%20script%20given%20document%27s%20relevant%20settings%20object%2E\">another</a> \"let's break how microtasks work\" special case.","m.mentions":{},"msgtype":"m.emote"},"ts":1768220780232,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$0EEuF0d1u8LxXTeC668iT_WwGTDL_gU4UaWqY0NNQq4"},
{"content":{"body":"* cries a little bit. Yet [another](https://html.spec.whatwg.org/#:~:text=Prepare%20to%20run%20script%20given%20document%27s%20relevant%20settings%20object%2E) \"let's break how microtasks work\" special case. (but maybe he did review that change? Hard to get back to the spec issue from the commit message)","format":"org.matrix.custom.html","formatted_body":"* cries a little bit. Yet <a href=\"https://html.spec.whatwg.org/#:~:text=Prepare%20to%20run%20script%20given%20document%27s%20relevant%20settings%20object%2E\">another</a> \"let's break how microtasks work\" special case. (but maybe he did review that change? Hard to get back to the spec issue from the commit message)","m.mentions":{},"m.new_content":{"body":"cries a little bit. Yet [another](https://html.spec.whatwg.org/#:~:text=Prepare%20to%20run%20script%20given%20document%27s%20relevant%20settings%20object%2E) \"let's break how microtasks work\" special case. (but maybe he did review that change? Hard to get back to the spec issue from the commit message)","format":"org.matrix.custom.html","formatted_body":"cries a little bit. Yet <a href=\"https://html.spec.whatwg.org/#:~:text=Prepare%20to%20run%20script%20given%20document%27s%20relevant%20settings%20object%2E\">another</a> \"let's break how microtasks work\" special case. (but maybe he did review that change? Hard to get back to the spec issue from the commit message)","m.mentions":{},"msgtype":"m.emote"},"m.relates_to":{"event_id":"$0EEuF0d1u8LxXTeC668iT_WwGTDL_gU4UaWqY0NNQq4","rel_type":"m.replace"},"msgtype":"m.emote"},"ts":1768220815106,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$BeMuNU8qJgm7kmYgIxgmvezaApPIgMsABRaFRL5Opxs"},
{"content":{"body":"This was me and it was thoroughly reviewed.","m.mentions":{"user_ids":["@smaug:mozilla.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$0EEuF0d1u8LxXTeC668iT_WwGTDL_gU4UaWqY0NNQq4"}},"msgtype":"m.text"},"ts":1768221008989,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$GtMtx6B3YBIdbYZm1Fi9_eK30AfG0gJ6MV7Cyet8HyI"},
{"content":{"body":"https://github.com/whatwg/html/pull/10284","m.mentions":{},"msgtype":"m.text"},"ts":1768221062908,"senderName":"Ms2ger","senderId":"@ms2ger:igalia.com","id":"$mXJ3JI0zo8Mt3ClJmuJInGkeeE3xECjxI2bUsSxYvNs"},
{"content":{"body":"Yea I think we had the discussion about this with Domenic elsewhere... ","m.mentions":{},"msgtype":"m.text"},"ts":1768221160271,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$hnKkt8IewVc6N-5671m85Ux5c963jg-bgSs93-0ck04"},
{"content":{"body":"Looks like google only patch and review","m.mentions":{},"msgtype":"m.text"},"ts":1768221193781,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$N1sWFi_vnvwoAW0XklDmcfoQRkrpBH5Pddka0xzAGqE"},
{"content":{"body":"the problem with microtasks in the rendering loop is that they might be postponed until the end of the rendering task and that's a no-man's land","m.mentions":{},"msgtype":"m.text"},"ts":1768221201567,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$zKmrgAoUIaAHoZfgl8My3Qd0NpDf_WwQugBSA604WQA"},
{"content":{"body":"Oh, I do understand how microtasks work and what their limitations are ðŸ˜› ","m.mentions":{},"msgtype":"m.text"},"ts":1768221234786,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$mhUwqCEmCBCt_mESaiaJfvbirKLZ7TgDzNCmOm1vFqs"},
{"content":{"body":"but it is getting really hard to explain how microtasks work given the special cases. Navigation API has similar weird special case","m.mentions":{},"msgtype":"m.text"},"ts":1768221278442,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$YJR2uxAzkH_aiJ8aDDJHw6fRqLdJC5wKxWTgw0bOOcI"},
{"content":{"body":"yea agreed, there are a few of those","m.mentions":{},"msgtype":"m.text"},"ts":1768221294270,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$vOLncPPS7qVzJk4kc9eN_V8LivAnQgL-rXGYUWbiuzQ"},
{"content":{"body":"but really I think those special cases can be counted on one hand","m.mentions":{},"msgtype":"m.text"},"ts":1768221303730,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$SCrV1pwNnMEXTi0IJaiUJEV_BcWgnwkJysMNU6G12hY"},
{"content":{"body":"so we have enough to start a Quirks spec for microtasks","m.mentions":{"user_ids":["@noamr:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$SCrV1pwNnMEXTi0IJaiUJEV_BcWgnwkJysMNU6G12hY"}},"msgtype":"m.text"},"ts":1768221386901,"senderName":"sideshowbarker","senderId":"@sideshowbarker:matrix.org","id":"$OKDi_xZSXCwmqKM6vKOOxytd4Qi8NexNxGGPlV0TxAk"},
{"content":{"body":"I suggested before to have something like an isolated promise resolver algorithm that does this... it's probably easier to explain then wrapping each of these separately","m.mentions":{},"msgtype":"m.text"},"ts":1768221389678,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$N3ESMZ9Swzdzt7i2D5Y_TFA4lTAKUiMC79_NSFdgRPo"},
{"content":{"body":"Does it need to be an AI-generated hand? ðŸ˜‡","m.mentions":{},"msgtype":"m.text"},"ts":1768221397408,"senderName":"Ms2ger","senderId":"@ms2ger:igalia.com","id":"$Pu4A_SfJXG05IhsgU_WSZXB75tB0vra4Xv4hyeyaBwA"},
{"content":{"body":"The quirky things about microtasks is when they need to fire before of other things in the same task... then you need to wrap them with this prepare/cleanup thingy. I think the right way to explain it is to have some sort of isolated wrapper for this but it wouldn't look much different from those prepare/cleanup pairs\n\nThe latter one is really confusing \n","m.mentions":{},"msgtype":"m.text"},"ts":1768221610273,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$BsUIVDNipOAHu3CduLOn1sJ-_fAprTf2kY9x4AtFrgE"},
{"content":{"body":"* The quirky things about microtasks is when they need to fire before of other things in the same task... then you need to wrap them with this prepare/cleanup thingy. I think the right way to explain it is to have some sort of isolated wrapper for this but it wouldn't look much different from those prepare/cleanup pairs\n","m.mentions":{},"m.new_content":{"body":"The quirky things about microtasks is when they need to fire before of other things in the same task... then you need to wrap them with this prepare/cleanup thingy. I think the right way to explain it is to have some sort of isolated wrapper for this but it wouldn't look much different from those prepare/cleanup pairs\n","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$BsUIVDNipOAHu3CduLOn1sJ-_fAprTf2kY9x4AtFrgE","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1768221617104,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$CBMEtLsdj6MTVAx0VKR1xW_v33y8SAmBXuEbCN93CDQ"},
{"content":{"body":"* The quirky things about microtasks is when they need to fire before other things in the same task... then you need to wrap them with this prepare/cleanup thingy. I think the right way to explain it is to have some sort of isolated wrapper for this but it wouldn't look much different from those prepare/cleanup pairs\n","m.mentions":{},"m.new_content":{"body":"The quirky things about microtasks is when they need to fire before other things in the same task... then you need to wrap them with this prepare/cleanup thingy. I think the right way to explain it is to have some sort of isolated wrapper for this but it wouldn't look much different from those prepare/cleanup pairs\n","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$BsUIVDNipOAHu3CduLOn1sJ-_fAprTf2kY9x4AtFrgE","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1768221655264,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$MPfOXR0LnmZ61YZ8SilnjGLJR8caGUklWWFrsQeFXSA"},
{"content":{"body":"(though so far this sounds like more like a group rant than an attempt to fix things, so perhaps I'd leave it to that)","m.mentions":{},"msgtype":"m.text"},"ts":1768221709181,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$gXTLyoxVX5J3dpNvmGzGV9xXFd8To4dIpr-c13BZmZ8"},
{"content":{"body":"I guess we'd need conceptual MilliTasks, and Microtasks would run then at  the end of outermost script execution or end of millitask or task.","m.mentions":{},"msgtype":"m.text"},"ts":1768221963525,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$5cylKPYIswEPLTEuLusTiDGu_nEqFtqCWljmQl0JGDY"},
{"content":{"body":"we kind of have that. you can call script execution blocks millitasks","m.mentions":{},"msgtype":"m.text"},"ts":1768222006742,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$k4y_3x696vkRrQ3CL-Q4hcnS4gby0a9l-HBHIR78iQ0"},
{"content":{"body":"(I wouldn't use the term, but the concept exist)","m.mentions":{},"msgtype":"m.text"},"ts":1768222019825,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$34C2ILMVVbJQEc6EVli79eqxZSyl79yPyY5UbU8a1X0"},
{"content":{"body":"but really what I found myself looking for a few times is more like \"when you resolve this promise, if there is no active script, also perform a microtask checkpoint and flush the world\". the default behavior of delaying that to the end of the task is what's quirky","m.mentions":{},"msgtype":"m.text"},"ts":1768222149410,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$0oMwQOxMzJWYaQdlQuzOr9RlHAt866_NHNiiF-Z5vQQ"},
{"content":{"body":"yeah, that largely comes from the fact that microtasks weren't designed for promises","m.mentions":{},"msgtype":"m.text"},"ts":1768222219207,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$4A4BK6b7vG9Sw5HaQnelhh8vf6UFcRva6S4TcnqjR9k"},
{"content":{"body":"(end of the task or an event handler or callback that might happen to run)","m.mentions":{},"msgtype":"m.text"},"ts":1768222254309,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$vP8wQGGkSeYxAqEdl7mqINmCXU-y09B1h-6Qyomvaqs"},
{"content":{"body":"sure, but that's why a wrapper to \"resolve a promise\" or to wrap a prepare/cleanup pair for promise resolution and expose that in an algo is not a bad solution","m.mentions":{},"msgtype":"m.text"},"ts":1768222302998,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$rogfpWayigsHX9ShYpxEn1IcdOqUBugbPuSXW4_Kfo8"},
{"content":{"body":"it makes explaining microtasks hard. \"usually microtasks run at this time, but then we have these special cases\"","m.mentions":{},"msgtype":"m.text"},"ts":1768222387411,"senderName":"smaug","senderId":"@smaug:mozilla.org","id":"$Pm0l4xWBOjrg2JYrK4WeaD0jFWyY5S-KlD3Jk_ke4Ek"},
{"content":{"body":"they run when the JS stack is emptied from running scripts or at the end of the task. We can say that these promise-based entry points create a JS Stack","m.mentions":{},"msgtype":"m.text"},"ts":1768222439229,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$OMxfb0uMQHFUMnQTbk7QZRgkpHzGNN9Uo0dan-qcPKc"},
{"content":{"body":"it's not a \"special case\" per se, it creates JS stacks/scopes whatever when there is a promise-based API callback","m.mentions":{},"msgtype":"m.text"},"ts":1768222502094,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$pIsY9pFoVQtgmJjr4TxF6S1qyeElN3NwDeC2nxedpQk"},
{"content":{"body":"The alternative way to explain this is by having these sub-tasks be tasks and manage the order via task queues... I'm pretty sure that would be more cumbersome and won't solve anything.","m.mentions":{},"msgtype":"m.text"},"ts":1768223944310,"senderName":"Noam Rosenthal","senderId":"@noamr:matrix.org","id":"$wL_pSOCsYxxVmzv589j61E5vUn8Xk8QyubYl4PgOu4c"}
]