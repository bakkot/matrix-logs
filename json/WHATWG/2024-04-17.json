[
{"content":{"body":"Do we need a getHTML function on the document interface? We can parse to a document but can't currently serialise from one (not preserving shadow Dom anyway). You can call getHTML on the documentElement but that loses the html element in the output (because that's effectively innerHTML and we'd need outerHTML)","msgtype":"m.text"},"ts":1713312908746,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$TII0sG924dIa1N89uUb9J6toDQs5kLNxP8sY0-UO6PY"},
{"content":{"body":" * Do we need a getHTML function on the document interface? We can parse to a document but can't currently serialise from one (not preserving shadow Dom anyway). You can call getHTML on the documentElement but that loses the html element in the output (because that's effectively innerHTML and we'd need outerHTML). A getHTML on the document object itself could also serialise the compat mode back to the doctype? Which feels like it could be useful if you're trying to ensure lossless round tripping of parsing and serialisation?","m.mentions":{},"m.new_content":{"body":"Do we need a getHTML function on the document interface? We can parse to a document but can't currently serialise from one (not preserving shadow Dom anyway). You can call getHTML on the documentElement but that loses the html element in the output (because that's effectively innerHTML and we'd need outerHTML). A getHTML on the document object itself could also serialise the compat mode back to the doctype? Which feels like it could be useful if you're trying to ensure lossless round tripping of parsing and serialisation?","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$TII0sG924dIa1N89uUb9J6toDQs5kLNxP8sY0-UO6PY","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1713313072210,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$DUADsYjOlA_GfBd21rrdwY3jEOQ7LXKWgmp8COss6I0"},
{"content":{"body":"That issue just feels like an area where the community needs to go off and get a widely-used custom element (or React component, I'm not picky) before spending all this time in standards space...","m.mentions":{},"msgtype":"m.text"},"ts":1713317512178,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$rjv_H9U85a6OEZrFOC9_6vT6aH_-tCn9mnyRvl6WTcQ"},
{"content":{"body":"> <@lwarlow:igalia.com> Do we need a getHTML function on the document interface? We can parse to a document but can't currently serialise from one (not preserving shadow Dom anyway). You can call getHTML on the documentElement but that loses the html element in the output (because that's effectively innerHTML and we'd need outerHTML). A getHTML on the document object itself could also serialise the compat mode back to the doctype? Which feels like it could be useful if you're trying to ensure lossless round tripping of parsing and serialisation?\n\nI would like that. Serializing the DOCTYPE in particular is nice. jsdom has its own serialization function just for that, because documentElement.outerHTML misses it.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$TII0sG924dIa1N89uUb9J6toDQs5kLNxP8sY0-UO6PY?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@lwarlow:igalia.com\">@lwarlow:igalia.com</a><br>Do we need a getHTML function on the document interface? We can parse to a document but can&#39;t currently serialise from one (not preserving shadow Dom anyway). You can call getHTML on the documentElement but that loses the html element in the output (because that&#39;s effectively innerHTML and we&#39;d need outerHTML). A getHTML on the document object itself could also serialise the compat mode back to the doctype? Which feels like it could be useful if you&#39;re trying to ensure lossless round tripping of parsing and serialisation?</blockquote></mx-reply>I would like that. Serializing the DOCTYPE in particular is nice. jsdom has its own serialization function just for that, because documentElement.outerHTML misses it.","m.mentions":{"user_ids":["@lwarlow:igalia.com"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$TII0sG924dIa1N89uUb9J6toDQs5kLNxP8sY0-UO6PY"}},"msgtype":"m.text"},"ts":1713317561234,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$j90oV9apWzkXVokHkjPrSRgt6buB1FVaKLBMqRszJK0"},
{"content":{"body":"It might be a little weird that `parseHTMLUnsafe()` is a static method then and not just `document.setHTMLUnsafe()`.","format":"org.matrix.custom.html","formatted_body":"It might be a little weird that <code>parseHTMLUnsafe()</code> is a static method then and not just <code>document.setHTMLUnsafe()</code>.","m.mentions":{},"msgtype":"m.text"},"ts":1713337726198,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$0a5sef4IIeCcjP2MN8Gw2URETezRPX1sfFcKz-bnh5k"},
{"content":{"body":"But I guess it's fine. Serializing the doctype seems good, but we should be opinionated about it and not support all inputs as-is.","m.mentions":{},"msgtype":"m.text"},"ts":1713337806342,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$OgEtnY4w3pQd6beU1JlH5-RDlQBRIIbvrALZkt-bUV4"},
{"content":{"body":"> <@annevk:matrix.org> But I guess it's fine. Serializing the doctype seems good, but we should be opinionated about it and not support all inputs as-is.\n\nYeah okay maybe lossless was the wrong choice of word. I think the compatMode should serialise to the presence or lack of a standard Doctype","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$OgEtnY4w3pQd6beU1JlH5-RDlQBRIIbvrALZkt-bUV4?via=igalia.com&via=matrix.org&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@annevk:matrix.org\">@annevk:matrix.org</a><br />But I guess it's fine. Serializing the doctype seems good, but we should be opinionated about it and not support all inputs as-is.</blockquote></mx-reply>Yeah okay maybe lossless was the wrong choice of word. I think the compatMode should serialise to the presence or lack of a standard Doctype","m.relates_to":{"m.in_reply_to":{"event_id":"$OgEtnY4w3pQd6beU1JlH5-RDlQBRIIbvrALZkt-bUV4"}},"msgtype":"m.text"},"ts":1713338575916,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$5482orQhJfUX23rIwO6F0EyW1-4sKc1e5rG3bAMJU6A"},
{"content":{"body":"> <@annevk:matrix.org> It might be a little weird that `parseHTMLUnsafe()` is a static method then and not just `document.setHTMLUnsafe()`.\n\nI guess that's fine though because it ensures the state of the document object is consistent when parsing?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$0a5sef4IIeCcjP2MN8Gw2URETezRPX1sfFcKz-bnh5k?via=igalia.com&via=matrix.org&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@annevk:matrix.org\">@annevk:matrix.org</a><br />It might be a little weird that <code>parseHTMLUnsafe()</code> is a static method then and not just <code>document.setHTMLUnsafe()</code>.</blockquote></mx-reply>I guess that's fine though because it ensures the state of the document object is consistent when parsing?","m.relates_to":{"m.in_reply_to":{"event_id":"$0a5sef4IIeCcjP2MN8Gw2URETezRPX1sfFcKz-bnh5k"}},"msgtype":"m.text"},"ts":1713338687425,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$4ArfsUIaVOoLHqXHuYRpHLxVHzT5-li3s0xQqNuTINY"},
{"content":{"body":"Hmm, the state for non-document nodes is not. But in theory we could also add `setHTMLUnsafe()` to document if we ever wanted to parse without allocation. Prolly not worth it for the foreseeable future though.","format":"org.matrix.custom.html","formatted_body":"Hmm, the state for non-document nodes is not. But in theory we could also add <code>setHTMLUnsafe()</code> to document if we ever wanted to parse without allocation. Prolly not worth it for the foreseeable future though.","m.mentions":{},"msgtype":"m.text"},"ts":1713338993781,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$eO6FqESGZONpbzJFBSzBeaE52xfwR9ToocEWPOtAYPY"},
{"content":{"body":"I got thinking on this because if we had document getHTML, you could use trusted types and the sanitizer APIs to always safely set the srcdoc attribute on an iframe without needing any dependencies (unless there's some missing issues I've not thought of).","msgtype":"m.text"},"ts":1713339224794,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$wCZ81qyMhfs_WrLKpWVSOFaJ8JgbMTWSXIzAiMcd6S0"},
{"content":{"body":"* I got thinking on this because if we had document getHTML, you could use trusted types and the sanitizer APIs to always safely set the srcdoc attribute on an iframe without needing any dependencies (unless there's some missing issues I've not thought of).\n\nAnd also just because it does feel like a missing piece to the serialization puzzle.","m.new_content":{"body":"I got thinking on this because if we had document getHTML, you could use trusted types and the sanitizer APIs to always safely set the srcdoc attribute on an iframe without needing any dependencies (unless there's some missing issues I've not thought of).\n\nAnd also just because it does feel like a missing piece to the serialization puzzle.","msgtype":"m.text"},"m.relates_to":{"event_id":"$wCZ81qyMhfs_WrLKpWVSOFaJ8JgbMTWSXIzAiMcd6S0","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1713339300762,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$g3oHRPHXeT2aknZnnQu14ycGtMZzr6gd2uoYXtNycGY"},
{"content":{"body":"> <@lwarlow:igalia.com> Yeah okay maybe lossless was the wrong choice of word. I think the compatMode should serialise to the presence or lack of a standard Doctype\n\nI don't think compatmode should impact it. It should be whether the Document has a DocumentType node. And then it should serialize according to https://html.spec.whatwg.org/#html-fragment-serialisation-algorithm .","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$5482orQhJfUX23rIwO6F0EyW1-4sKc1e5rG3bAMJU6A?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@lwarlow:igalia.com\">@lwarlow:igalia.com</a><br>Yeah okay maybe lossless was the wrong choice of word. I think the compatMode should serialise to the presence or lack of a standard Doctype</blockquote></mx-reply>I don't think compatmode should impact it. It should be whether the Document has a DocumentType node. And then it should serialize according to https://html.spec.whatwg.org/#html-fragment-serialisation-algorithm .","m.mentions":{"user_ids":["@lwarlow:igalia.com"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$5482orQhJfUX23rIwO6F0EyW1-4sKc1e5rG3bAMJU6A"}},"msgtype":"m.text"},"ts":1713339710874,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$wYn9idIiPMfQc95ePOQvCFoRTvOZtlfVAptaebY33iQ"},
{"content":{"body":"> <@domenicdenicola:matrix.org> I don't think compatmode should impact it. It should be whether the Document has a DocumentType node. And then it should serialize according to https://html.spec.whatwg.org/#html-fragment-serialisation-algorithm .\n\nI was thinking back to how we used to do it where I worked before but maybe we were doing it badly 😅","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$wYn9idIiPMfQc95ePOQvCFoRTvOZtlfVAptaebY33iQ?via=igalia.com&via=matrix.org&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@domenicdenicola:matrix.org\">@domenicdenicola:matrix.org</a><br />I don't think compatmode should impact it. It should be whether the Document has a DocumentType node. And then it should serialize according to https://html.spec.whatwg.org/#html-fragment-serialisation-algorithm .</blockquote></mx-reply>I was thinking back to how we used to do it where I worked before but maybe we were doing it badly 😅","m.relates_to":{"m.in_reply_to":{"event_id":"$wYn9idIiPMfQc95ePOQvCFoRTvOZtlfVAptaebY33iQ"}},"msgtype":"m.text"},"ts":1713339809441,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$raRea9R0p9ppOSFXb9n4nQNC5br4UVcsncHcyxbXFRQ"},
{"content":{"body":"Interesting that the parser preserves name, system ID, and public ID, but the serializer only keeps the name.","m.mentions":{},"msgtype":"m.text"},"ts":1713339855211,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$-yujMfwLjA7uMyHHb-qx4k5WmCQbRa75ffBzCoddgSE"},
{"content":{"body":"I'll open an issue on the html spec proposing this idea and we can discuss further the details there. Just wanted to guage if we thought it was any good or not.","msgtype":"m.text"},"ts":1713339928483,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$I5Eh27Zy4BKkL5GSPd6Vt1qemSsGtzYEpAQSECRcrSY"},
{"content":{"body":"I can't find any way to trigger the HTML fragment serializing algorithm with a doctype, sad.","m.mentions":{},"msgtype":"m.text"},"ts":1713340320092,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$v3M7ndVtbms_uQTb1DRWU7peAqjPBEeosmOw6FOdwo8"},
{"content":{"body":"I also either found a bug or am blind https://github.com/whatwg/dom/issues/1278","m.mentions":{},"msgtype":"m.text"},"ts":1713340409534,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$2K-oVZiyfYe955L5sDv4hae93T7FvD4KHWasCENB1uE"},
{"content":{"body":"Huh, I learned there is `document.doctype` but it doesn't serialize to a doctype string?","format":"org.matrix.custom.html","formatted_body":"Huh, I learned there is <code>document.doctype</code> but it doesn't serialize to a doctype string?","m.mentions":{},"msgtype":"m.text"},"ts":1713340458305,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$rSq6GVumXN2YuFyou9mzOZyZzXZt7dQ_ARmSjDT0ksc"},
{"content":{"body":"(testing in Firefox)","m.mentions":{},"msgtype":"m.text"},"ts":1713340463671,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$mI6AqRIzGKek42cMzH_isMsjhq8g7LVwf5_GlUH_40I"},
{"content":{"body":"I've used `document.body.parentElement.outerHTML` in the past, but you'd have to guess and attach the right doctype. Either way. I think there's value in a getter for the document.","format":"org.matrix.custom.html","formatted_body":"I've used <code>document.body.parentElement.outerHTML</code> in the past, but you'd have to guess and attach the right doctype. Either way. I think there's value in a getter for the document.","m.mentions":{},"msgtype":"m.text"},"ts":1713340502548,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$wwjk3Pl7cBz5n7HCqml49OCDoH7-Lu8A6PwO7X5P_Y8"},
{"content":{"body":"It doesn't have any serializing methods or properties","m.mentions":{},"msgtype":"m.text"},"ts":1713340504289,"senderName":"Domenic","senderId":"@domenicdenicola:matrix.org","id":"$tIKu7ko1WaOxrzNLVf7A1XFObcne_90stQ8awMQgwQg"},
{"content":{"body":"Did we manage to remove the getters on doctype?","m.mentions":{},"msgtype":"m.text"},"ts":1713343153791,"senderName":"Ms2ger","senderId":"@ms2ger:igalia.com","id":"$5xN-GdgWEeicAxnfucJxLNiSCYc886ZxCSaqHDO9hjQ"},
{"content":{"body":"There were some? Well, then apparently...yes? :)","m.mentions":{},"msgtype":"m.text"},"ts":1713344253597,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$8WpYFBK7_QI06ODJj4m4C-m62YrOrmV6_QS-u-AVLTE"},
{"content":{"body":"I guess I disagree with Domenic. I like the idea of serializing based on quirks mode a lot better. That way we either have no doctype, an almost doctype, or the doctype in the output.","format":"org.matrix.custom.html","formatted_body":"I guess I disagree with <a href=\"https://matrix.to/#/@domenicdenicola:matrix.org\">Domenic</a>. I like the idea of serializing based on quirks mode a lot better. That way we either have no doctype, an almost doctype, or the doctype in the output.","m.mentions":{"user_ids":["@domenicdenicola:matrix.org"]},"msgtype":"m.text"},"ts":1713345382995,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$Ds-9HsZvta1Smy8e6vgQyIi7QddofAD4ttNh0-kNCjE"},
{"content":{"body":"I raised https://github.com/whatwg/html/issues/10280 ","m.mentions":{},"msgtype":"m.text"},"ts":1713345902544,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$OnH3DQ17yJICQOXoLr7ty6H-PtZEpEjn5-XkOmSywTo"},
{"content":{"body":"We also discussed this in our Sanitizer issue triage and thought that a `document.setHTML` might be neat, such that one could do `iframe.contentDocument.setHTML()` and without doing a parsing/serialization roundtrip between for that specific use case. https://github.com/WICG/sanitizer-api/issues/117#issuecomment-2060735167 has more.","format":"org.matrix.custom.html","formatted_body":"We also discussed this in our Sanitizer issue triage and thought that a <code>document.setHTML</code> might be neat, such that one could do <code>iframe.contentDocument.setHTML()</code> and without doing a parsing/serialization roundtrip between for that specific use case. https://github.com/WICG/sanitizer-api/issues/117#issuecomment-2060735167 has more.","m.mentions":{},"msgtype":"m.text"},"ts":1713345991092,"senderName":"freddy","senderId":"@fbraun:mozilla.org","id":"$9aH_lHj6OXdPQLElSWjgB6TsWzzgeytENarPFRxLOg0"},
{"content":{"body":"freddy: note that it would require quite a number of downstream changes (none too hard I suspect) as we currently only consider possible element children","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@fbraun:mozilla.org\">freddy</a>: note that it would require quite a number of downstream changes (none too hard I suspect) as we currently only consider possible element children","m.mentions":{"user_ids":["@fbraun:mozilla.org"]},"msgtype":"m.text"},"ts":1713354942106,"senderName":"annevk","senderId":"@annevk:matrix.org","id":"$ymNUD6ofZ3OxZNg53M2OzpRSSCeYNEVH7KncD6OUxoc"},
{"content":{"body":"> <@domenicdenicola:matrix.org> It doesn't have any serializing methods or properties\n\n`new XMLSerializer().serializeToString(document.doctype)` this will give you a string representation back","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$tIKu7ko1WaOxrzNLVf7A1XFObcne_90stQ8awMQgwQg?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@domenicdenicola:matrix.org\">@domenicdenicola:matrix.org</a><br>It doesn&#39;t have any serializing methods or properties</blockquote></mx-reply><code>new XMLSerializer().serializeToString(document.doctype)</code> this will give you a string representation back","m.mentions":{"user_ids":["@domenicdenicola:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$tIKu7ko1WaOxrzNLVf7A1XFObcne_90stQ8awMQgwQg"}},"msgtype":"m.text"},"ts":1713364972505,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$q6EJU8GmX5zi9VkppPlCrb-NbQyNn0N98R3lyQ5_1Oo"},
{"content":{"body":" * I got thinking on this because if we had document getHTML, you could use trusted types and the sanitizer APIs to always safely set the srcdoc attribute on an iframe without needing any dependencies (unless there's some missing issues I've not thought of).\n\nmXSS is what I was missing.\n\nAnd also just because it does feel like a missing piece to the serialization puzzle.","m.mentions":{},"m.new_content":{"body":"I got thinking on this because if we had document getHTML, you could use trusted types and the sanitizer APIs to always safely set the srcdoc attribute on an iframe without needing any dependencies (unless there's some missing issues I've not thought of).\n\nmXSS is what I was missing.\n\nAnd also just because it does feel like a missing piece to the serialization puzzle.","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$wCZ81qyMhfs_WrLKpWVSOFaJ8JgbMTWSXIzAiMcd6S0","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1713365363384,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$hnhcySjkex79W8D7h_YBZzS2UvN14xf4Kf6pXkpsWqA"},
{"content":{"body":"> <@domenicdenicola:matrix.org> It doesn't have any serializing methods or properties\n\n * `new XMLSerializer().serializeToString(document.doctype)` this will give you a string representation back. But to your point this obviously goes via XML serialisation rather than HTML.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!AGetWbsMpFPdSgUrbs:matrix.org/$tIKu7ko1WaOxrzNLVf7A1XFObcne_90stQ8awMQgwQg?via=matrix.org&amp;via=mozilla.org&amp;via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@domenicdenicola:matrix.org\">@domenicdenicola:matrix.org</a><br>It doesn't have any serializing methods or properties</blockquote></mx-reply> * <code>new XMLSerializer().serializeToString(document.doctype)</code> this will give you a string representation back. But to your point this obviously goes via XML serialisation rather than HTML.","m.mentions":{},"m.new_content":{"body":"`new XMLSerializer().serializeToString(document.doctype)` this will give you a string representation back. But to your point this obviously goes via XML serialisation rather than HTML.","format":"org.matrix.custom.html","formatted_body":"<code>new XMLSerializer().serializeToString(document.doctype)</code> this will give you a string representation back. But to your point this obviously goes via XML serialisation rather than HTML.","m.mentions":{"user_ids":["@domenicdenicola:matrix.org"]},"msgtype":"m.text"},"m.relates_to":{"event_id":"$q6EJU8GmX5zi9VkppPlCrb-NbQyNn0N98R3lyQ5_1Oo","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1713365704271,"senderName":"Luke Warlow","senderId":"@lwarlow:igalia.com","id":"$aiqsjo3tmGyiwHArhNcFsV7A0Uk2XzOezAb4Qh0ZIbk"},
{"content":{"body":"Why did we use labels and not milestones for Stages?","m.mentions":{},"msgtype":"m.text"},"ts":1713396227596,"senderName":"zcorpan","senderId":"@zcorpan:mozilla.org","id":"$f3c6WNULSGogDQBTZ7ycfbQetplfsp753qfAjw-zi2s"}
]