[
{"content":{"body":"shu: i have a package that sets Symbol.isConcatSpreadable on a few objects, for the purpose of ensuring that array concat still works as expected even if someone does `Array.prototype[Symbol.isConcatSpreadable] = true`, or has an array with an own property set on it.\n\na user is reporting that v8 becomes permanently slow if Symbol.isConcatSpreadable is ever set, even once, on any object - and deleting it later doesn't fix it. is there anything that could be done here to make it less pathological to set it on an arbitrary object?","format":"org.matrix.custom.html","formatted_body":"<p><a href=\"https://matrix.to/#/@shuyuguo:matrix.org\">shu</a>: i have a package that sets Symbol.isConcatSpreadable on a few objects, for the purpose of ensuring that array concat still works as expected even if someone does <code>Array.prototype[Symbol.isConcatSpreadable] = true</code>, or has an array with an own property set on it.</p>\n<p>a user is reporting that v8 becomes permanently slow if Symbol.isConcatSpreadable is ever set, even once, on any object - and deleting it later doesn't fix it. is there anything that could be done here to make it less pathological to set it on an arbitrary object?</p>\n","msgtype":"m.text"},"ts":1693950675223,"senderName":"ljharb","senderId":"@ljharb:matrix.org","id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI"},
{"content":{"body":"https://github.com/ljharb/safe-array-concat/pull/3#issuecomment-1707355732 for context","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693950814064,"senderName":"ljharb","senderId":"@ljharb:matrix.org","id":"$crRA5WRTIv7pTLz0VgnDh0tpwfWVw-msSmQHbwu2S-A"},
{"content":{"body":"this i can easily confirm: assigning a property on _any_ object with a name of `Symbol.isConcatSpreadable` triggers the protector","format":"org.matrix.custom.html","formatted_body":"this i can easily confirm: assigning a property on <em>any</em> object with a name of <code>Symbol.isConcatSpreadable</code> triggers the protector","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$crRA5WRTIv7pTLz0VgnDh0tpwfWVw-msSmQHbwu2S-A"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693951846912,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$0yzVR21WwDYb9piO6lr5zCgf5aAF7v35QK0w3wOuElo"},
{"content":{"body":"protectors are 1-way, there's no way to un-trigger them","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$0yzVR21WwDYb9piO6lr5zCgf5aAF7v35QK0w3wOuElo"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693951853874,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$gTOxZS-WMRwYJT4vjhVh4I2fQEQw11Ypy2jkb7-hOlw"},
{"content":{"body":"the short answer is i don't know to make it less pathological, because the concat spreadable behavior is that we need to check it on arbitrary objects","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$gTOxZS-WMRwYJT4vjhVh4I2fQEQw11Ypy2jkb7-hOlw"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952017799,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$dw5-HKB06-9imAz2gYSiu5nHdlah82MhM94YCvdEKR0"},
{"content":{"body":"https://chromium.googlesource.com/v8/v8.git/+/HEAD/src/builtins/builtins-array.cc#1276","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$dw5-HKB06-9imAz2gYSiu5nHdlah82MhM94YCvdEKR0"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952022715,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$Fh8Vsvy9zizmZLKk0PvXk9KBD2VP4SsPURRXQBYK1S0"},
{"content":{"body":"there might be something possible here to carve out more fast paths","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$Fh8Vsvy9zizmZLKk0PvXk9KBD2VP4SsPURRXQBYK1S0"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952028178,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$46vCXAlzbTAGEpIK-Hd4m_khp9I2g9y88XkxdwqZavA"},
{"content":{"body":"\"Slow path if @@isConcatSpreadable has been used\"","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$Fh8Vsvy9zizmZLKk0PvXk9KBD2VP4SsPURRXQBYK1S0"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952029034,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$h5Apop959zMdf7J12RU2zUDSPW0QE_UwiKUARZyJOJE"},
{"content":{"body":"the current tradeoff is that Symbol.isConcatSpreadable is rare enough to just have a blanket slow path","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$h5Apop959zMdf7J12RU2zUDSPW0QE_UwiKUARZyJOJE"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952100920,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$Kv54OdYtR0FwnAe7JNde9ItZZWklYVm9f_IaCrohmmw"},
{"content":{"body":"here's the data: https://chromestatus.com/metrics/feature/timeline/popularity/3261","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$Kv54OdYtR0FwnAe7JNde9ItZZWklYVm9f_IaCrohmmw"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952904209,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$hZjrhJkbf7BturwVn9ECYPZXADlQ3MQrnDXgWPmvOuQ"},
{"content":{"body":"it's more than i thought actually","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$hZjrhJkbf7BturwVn9ECYPZXADlQ3MQrnDXgWPmvOuQ"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952909504,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$TqhGIKxPzZDTOe1qELdn9ecif_XpZLaGSqZ83KKPIC8"},
{"content":{"body":"but still not *that* much","format":"org.matrix.custom.html","formatted_body":"but still not <em>that</em> much","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$TqhGIKxPzZDTOe1qELdn9ecif_XpZLaGSqZ83KKPIC8"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952914885,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$xru0HmnHaUZe5JfM_BQF_e6gdkHeDHljwrSsdqg37sw"},
{"content":{"body":"the main problem i see is that the slow path for Array.concat is *really* slow, like, it uses a hash table for the numbers for the resulting array","format":"org.matrix.custom.html","formatted_body":"the main problem i see is that the slow path for Array.concat is <em>really</em> slow, like, it uses a hash table for the numbers for the resulting array","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$xru0HmnHaUZe5JfM_BQF_e6gdkHeDHljwrSsdqg37sw"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693952988211,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$5tpMxCS2Fq5sl16RgMNkZoa84Mi01ckphAykB4Orzss"},
{"content":{"body":"there's probably something to do there for concat spreadable so the cliff isn't quite so big","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$5tpMxCS2Fq5sl16RgMNkZoa84Mi01ckphAykB4Orzss"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693953009272,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$Ozg8WCfAA78tLgPWhCek5OWOcsFC8ixB0MEK79uHdwo"},
{"content":{"body":"you could also, like, directly implement concat though?","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$Ozg8WCfAA78tLgPWhCek5OWOcsFC8ixB0MEK79uHdwo"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693953036721,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$LIpXAQ4X68UUdNrTDBUFpHVDIDOmUltqCo6zEfC5yLc"},
{"content":{"body":"instead of setting @@isConcatSpreadable","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$LIpXAQ4X68UUdNrTDBUFpHVDIDOmUltqCo6zEfC5yLc"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693953050835,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$xDMBDziL8vmqzkBnTmlokmQFUKt7PPNdyYaRAY58Ktc"},
{"content":{"body":"just for interest: JSC doesn't have a fast path at all, and Firefox has a per-object \"can't have interesting symbol\" fast path\n\n- https://github.com/WebKit/WebKit/blob/94ce519cd2eaba3a1f2f4cb9753f40c98e9d9472/Source/JavaScriptCore/builtins/ArrayPrototype.js#L555\n- https://searchfox.org/mozilla-central/source/js/src/builtin/Array.cpp#4553","format":"org.matrix.custom.html","formatted_body":"<p>just for interest: JSC doesn't have a fast path at all, and Firefox has a per-object &quot;can't have interesting symbol&quot; fast path</p>\n<ul>\n<li>https://github.com/WebKit/WebKit/blob/94ce519cd2eaba3a1f2f4cb9753f40c98e9d9472/Source/JavaScriptCore/builtins/ArrayPrototype.js#L555</li>\n<li>https://searchfox.org/mozilla-central/source/js/src/builtin/Array.cpp#4553</li>\n</ul>\n","m.relates_to":{"event_id":"$AvNmlvqs_FzgNaNVUg2hCsf9C0c4azm-0z0o56n5cZI","is_falling_back":true,"m.in_reply_to":{"event_id":"$xDMBDziL8vmqzkBnTmlokmQFUKt7PPNdyYaRAY58Ktc"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1693953426759,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$B_tUpMIzxitcVmA26XWlgBjb3ogRKyodJNUtQEHB638"}
]