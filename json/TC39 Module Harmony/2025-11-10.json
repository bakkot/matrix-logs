[
{"content":{"body":"Further to the discussion last meeting about source phase architecture in v8 being tough to integrate","m.mentions":{},"msgtype":"m.text"},"ts":1762800087121,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$ACTJ-HR1F0YPpSCQAu_Ip6f5vJ1er6DcJ1lU-JNByNs"},
{"content":{"body":"both Deno and Cloudflare now resolve dependencies of source phase moudles, effectively in violation of the spec, just because that's the natural implementation path .... :(","m.mentions":{},"msgtype":"m.text"},"ts":1762800111687,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$RvEkL35U6ADes25RgpUe3p2DyhMfYYj0TcsGpppFOFY"},
{"content":{"body":"https://github.com/denoland/deno/issues/31240","m.mentions":{},"msgtype":"m.text"},"ts":1762800113041,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$-YnWRPaek2ahifqg6hvkqDw7RLO1I5P0TEMxs216Nlo"},
{"content":{"body":"Deno didn't implement V8's source phase callbacks. Would you mind elaborating why this is a V8 issue?","m.mentions":{},"msgtype":"m.text"},"ts":1762802620608,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$g2pYp3snhZr8G_OLnLYiRPm3P0lpFEZH6Ne3i18_o9Y"},
{"content":{"body":"In other words, Deno didn't implement V8's source phase support at all.","m.mentions":{},"msgtype":"m.text"},"ts":1762802671264,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$6pRomUvWDwj9IfKproyEI_spX93jubHy4T9yb-2deko"},
{"content":{"body":"Yeah I see that's the root cause here. Would be nice if implementers didn't have to do anything to get source phase though...","m.mentions":{},"msgtype":"m.text"},"ts":1762802918139,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$6P7b7niloWymkoC-rQmxIj4l29KNqs84ZvvmtEBktP0"},
{"content":{"body":"I'm not sure it will help in Deno's case","m.mentions":{},"msgtype":"m.text"},"ts":1762802944579,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$TxgYb7gASlgGVuDcejqn7aEYTMW2187HxkTqPoL953I"},
{"content":{"body":"Deno is literally resolving before even reaching to V8","m.mentions":{},"msgtype":"m.text"},"ts":1762802959149,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$3G7GLg-nXC4i04O8lgekQWDZEywF53jpdwmO87ZWnWw"},
{"content":{"body":"yeah, I see that, and that makes sense I suppose. Ideally implementations would _just_ need to opt-out of their prefetching for source phase, and then all phases and imports work out after that.","format":"org.matrix.custom.html","formatted_body":"yeah, I see that, and that makes sense I suppose. Ideally implementations would <em>just</em> need to opt-out of their prefetching for source phase, and then all phases and imports work out after that.","m.mentions":{},"msgtype":"m.text"},"ts":1762803093591,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$aV7_D90Jkpun2koXE6f9svbon8fgKbczHB79WdVRGtk"},
{"content":{"body":"If an embedder did not implement the source phase support, V8 does not enable the feature by default (at the moment, this is still hidden behind the flag `--js-source-phase-imports`)","format":"org.matrix.custom.html","formatted_body":"If an embedder did not implement the source phase support, V8 does not enable the feature by default (at the moment, this is still hidden behind the flag <code>--js-source-phase-imports</code>)","m.mentions":{},"msgtype":"m.text"},"ts":1762803175623,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$2F9U9L7xQOa0-lDJAAjgtjDSEzzGXuIceaMATfQN6pk"},
{"content":{"body":"I can see that this could be improved by asking V8 taking over the resolution step, so that V8 can stop resolving source import dependencies","m.mentions":{},"msgtype":"m.text"},"ts":1762803216403,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$p_yH1_dqr8n3cyW5ukOwhdqtbYJzkz_UcYK3VMhILo8"},
{"content":{"body":"* I can see that this could be potentially improved by asking V8 taking over the resolution step, so that V8 can stop resolving source import dependencies","m.mentions":{},"m.new_content":{"body":"I can see that this could be potentially improved by asking V8 taking over the resolution step, so that V8 can stop resolving source import dependencies","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$p_yH1_dqr8n3cyW5ukOwhdqtbYJzkz_UcYK3VMhILo8","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762803223990,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$FhhC3tcjB6J31WiTN34tAZIeti6ioyFrH3a3VZfgIWw"},
{"content":{"body":"However, I'd doubt the complexity of it because resolution can be either sync (node.js) or async (web).","m.mentions":{},"msgtype":"m.text"},"ts":1762803291955,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$-ZZj9xw8fMA2qrdzHF3MTUqnejJwJqiWgZHkjxrBL_I"},
{"content":{"body":"* However, I'd doubt the complexity of it because resolution can be either sync (node.js) or async (web & node.js).","m.mentions":{},"m.new_content":{"body":"However, I'd doubt the complexity of it because resolution can be either sync (node.js) or async (web & node.js).","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$-ZZj9xw8fMA2qrdzHF3MTUqnejJwJqiWgZHkjxrBL_I","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762803306850,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$3tm3sKbkRvsvQEPWJX6YNh0QLD_pTNx4LfkF9AiP394"},
{"content":{"body":"resolution is always now synchronous on both the web and node","m.mentions":{},"msgtype":"m.text"},"ts":1762803313126,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Caje7-vtc6UTm3C13AXuCFe2HcWLVd39_pHG73KtW4Q"},
{"content":{"body":"node still allows async resolution","m.mentions":{},"msgtype":"m.text"},"ts":1762803328293,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$CMalu64q591j6sIG4Z6cGGs8s6T-kYuO3RUxeoCFWsg"},
{"content":{"body":"is it not fully deprecated yet?","m.mentions":{},"msgtype":"m.text"},"ts":1762803363642,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$5hZi6fAzID6sdHUfR3FyYfSG0Hm5Cnmarp1ibWwnh6M"},
{"content":{"body":"it's.. not even under the discussion of deprecation","m.mentions":{},"msgtype":"m.text"},"ts":1762803379133,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$Ixz8qzDBkKaIGQgFccV0JAKFF0ou2HxddlFEjkfXIbs"},
{"content":{"body":"* it's.. not even under the discussion of deprecation AFAICT","m.mentions":{},"m.new_content":{"body":"it's.. not even under the discussion of deprecation AFAICT","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$Ixz8qzDBkKaIGQgFccV0JAKFF0ou2HxddlFEjkfXIbs","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762803400904,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$_2V1lugtWCLnEm1rWWrGTy93O8o0X6S00LGU6XfUBrs"},
{"content":{"body":"I guess there's two main architectures that might work for V8 - `HostResolveImportedModuleSource` as the new primitive that obtains sources first as a separate object (that can have compile cache etc)","format":"org.matrix.custom.html","formatted_body":"I guess there's two main architectures that might work for V8 - <code>HostResolveImportedModuleSource</code> as the new primitive that obtains sources first as a separate object (that can have compile cache etc)","m.mentions":{},"msgtype":"m.text"},"ts":1762803489048,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$lQi3ZdVvBKT3OmiuqIGQ4u7vjK8rUSgAaspnfI08fv0"},
{"content":{"body":"or we stick with `HostResolveImportedModuleV2` or `HostResolveImportedModuleWithPhase` that takes a phase argument as a hint, then returns a module without resolving dependencies","format":"org.matrix.custom.html","formatted_body":"or we stick with <code>HostResolveImportedModuleV2</code> or <code>HostResolveImportedModuleWithPhase</code> that takes a phase argument as a hint, then returns a module without resolving dependencies","m.mentions":{},"msgtype":"m.text"},"ts":1762803517394,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$TXGVqKsl61NBe65Rd5d7xJ3gockGX0GEydCVkf0U8HA"},
{"content":{"body":"Yeah, so a new v2 / or we extend it to apply to all modules","m.mentions":{},"msgtype":"m.text"},"ts":1762803566755,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$TFm6a9ylk7whVH2mojMd_kNcP06fhNJnQ38O5FDloR0"},
{"content":{"body":"not sure if we are referring to the same thing. Are you referring to `HostImportModuleWithPhaseDynamicallyCallback`?","format":"org.matrix.custom.html","formatted_body":"not sure if we are referring to the same thing. Are you referring to <code>HostImportModuleWithPhaseDynamicallyCallback</code>?","m.mentions":{},"msgtype":"m.text"},"ts":1762803605382,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$nuhpNa9EfiGeFXMP-L6-6QEoSnp_Fx3C7ougWjaEG_Y"},
{"content":{"body":"yes, as either being replaced or extended","m.mentions":{},"msgtype":"m.text"},"ts":1762803620500,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$bcp7mVaRlDOERgU2FRTtujy-fKEFGleGlcEvSVN0it4"},
{"content":{"body":"`HostImportModuleWithPhaseDynamicallyCallback` is only invoked for `import.source()` calls, it already takes an argument of `ModuleImportPhase`","format":"org.matrix.custom.html","formatted_body":"<code>HostImportModuleWithPhaseDynamicallyCallback</code> is only invoked for <code>import.source()</code> calls, it already takes an argument of <code>ModuleImportPhase</code>","m.mentions":{},"msgtype":"m.text"},"ts":1762803690110,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$SwrTpZO6XP_wxA1lrA4TY1c1vtnra2S9YmoqZXFoB3M"},
{"content":{"body":"I understand that and I've implemented that in both Node.js and Cloudflare","m.mentions":{},"msgtype":"m.text"},"ts":1762803707055,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$ypK4oJa7jJ_feMml1qCqulCcKWfKAI4QhwhQif7XfH8"},
{"content":{"body":"what I'm talking about is how we extend this to work for JS modules and sources more generally, while avoiding implementer complexity, as implementer feedback","m.mentions":{},"msgtype":"m.text"},"ts":1762803740930,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$hawzrz-8wwkLnwDSuXNxZ3LYP3fF9tW79dztRzqvf18"},
{"content":{"body":"It no longer does at least on the main thread (only allows it on the async loader hook thread when async loader hooks are registered)","m.mentions":{"user_ids":["@legendecas:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$CMalu64q591j6sIG4Z6cGGs8s6T-kYuO3RUxeoCFWsg"}},"msgtype":"m.text"},"ts":1762803843141,"senderName":"joyee","senderId":"@qzhang:igalia.com","id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE"},
{"content":{"body":"Putting Deno's issue aside, it's not easy for me to understand what's the exact issue you are trying to improve. I assume you are trying to push V8 taking over the implementation of resolution steps, and ask host to resolve for each `referrer, specifier, attributes` pairs?","format":"org.matrix.custom.html","formatted_body":"Putting Deno's issue aside, it's not easy for me to understand what's the exact issue you are trying to improve. I assume you are trying to push V8 taking over the implementation of resolution steps, and ask host to resolve for each <code>referrer, specifier, attributes</code> pairs?","m.mentions":{},"msgtype":"m.text"},"ts":1762803855413,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$fSjfMELhNSvC5UZC05ZC2aerKwVOaSkAxe0ZHtNP6WE"},
{"content":{"body":"no, just to separate source phase from instance phase in the V8 pipeline","m.mentions":{},"msgtype":"m.text"},"ts":1762803873812,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$hLGEWJb6XFKu3YtvUc3jWqPbrn1ADDtChxTDMvvOfTI"},
{"content":{"body":"but... it is still allowed, right?","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762803881715,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$Yul2wVqgjnmeJwHYlqET_FHgoN_3dd76yGKXZZVRLEM"},
{"content":{"body":"sources as first-class representations in v8","m.mentions":{},"msgtype":"m.text"},"ts":1762803884893,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$XGZn6Ek-iO0EsuS803ORGNfW-zXZuGTQtOjPoOfHV4g"},
{"content":{"body":"i.e. both for WebAssembly Module Record, and for Source Text Module Record","m.mentions":{},"msgtype":"m.text"},"ts":1762803913598,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$141JEvHFBJIjjKnSCtwkBt9Zx_-681IehVdB15HkvuA"},
{"content":{"body":"i.e. we still need to support async resolution, not being able to remove the support entirely","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$Yul2wVqgjnmeJwHYlqET_FHgoN_3dd76yGKXZZVRLEM"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762803924608,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$aof7PV_YWVhkxQwolUEK7GGx2DcEsW07CHfDOdeFLmE"},
{"content":{"body":"We technically could, it's just going to be a breaking change for a fairly niche use case in an experimental feature (when you expect an async loader to affect the resolution of subsequent loader on the loader thread - say you register a typescript loader, and you want to load a zip loader written in typescript, that sort of thing)","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$aof7PV_YWVhkxQwolUEK7GGx2DcEsW07CHfDOdeFLmE"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762804055070,"senderName":"joyee","senderId":"@qzhang:igalia.com","id":"$9Kal7jNnIrUH8Qcr3mdkfrRLLpFMXNMuYXt567Hw4jA"},
{"content":{"body":"I think the current `v8::Module` maps to the Module Record in the spec text. Both are essentially representation of module instance record","format":"org.matrix.custom.html","formatted_body":"I think the current <code>v8::Module</code> maps to the Module Record in the spec text. Both are essentially representation of module instance record","m.mentions":{},"msgtype":"m.text"},"ts":1762804073726,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$3AvzRWzejtzF0GPUfZphuMUeQmRKdKwuZZUq3s_IyZI"},
{"content":{"body":"https://github.com/tc39/proposal-esm-phase-imports/issues/53","m.mentions":{},"msgtype":"m.text"},"ts":1762804074702,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$zypEqih496NzXshpU8mv1vjfslEooXjSopGjrUgEEjg"},
{"content":{"body":"right, but in the spec `[[ModuleSource]]` is a field on the module record","format":"org.matrix.custom.html","formatted_body":"right, but in the spec <code>[[ModuleSource]]</code> is a field on the module record","m.mentions":{},"msgtype":"m.text"},"ts":1762804099083,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$f-w7WY6JeUgkjoXpSEjDZlhK8Vc2ndFLNDtwSoinCnY"},
{"content":{"body":"so we need to use the module as the handle for the module source, or separate the module source wrapper into its own thing","m.mentions":{},"msgtype":"m.text"},"ts":1762804122322,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$ojBS1krxyqAkkRLYVnLjnJB1n6TDTp4CNJC_ZHjjYyo"},
{"content":{"body":"as I say two main paths","m.mentions":{},"msgtype":"m.text"},"ts":1762804128703,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$QJncWli8MLNlRqB3KVGyNTBZ3W39tTnJ5ifT0TV3n3s"},
{"content":{"body":"V8 did not expose internal AbstractModuleSource to the API. It could be exposed as a first class representation. But it'd still be great to distinguish it in the spec as a first step","m.mentions":{},"msgtype":"m.text"},"ts":1762804170270,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$WUALouF3uGi1fIZx1Q4_R7blXu_lFnWmB_UECTYlLRQ"},
{"content":{"body":"* V8 did not expose internal AbstractModuleSource to the API. It could be potentially exposed as a first class representation. But it'd still be great to distinguish it in the spec as a first step","m.mentions":{},"m.new_content":{"body":"V8 did not expose internal AbstractModuleSource to the API. It could be potentially exposed as a first class representation. But it'd still be great to distinguish it in the spec as a first step","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$WUALouF3uGi1fIZx1Q4_R7blXu_lFnWmB_UECTYlLRQ","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804181013,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$OwEj0Z8A62xKJWOi8ieDHWkxDhEls56YiUUUbNiUoLE"},
{"content":{"body":"having `v8::WasmModule` will help I think too","format":"org.matrix.custom.html","formatted_body":"having <code>v8::WasmModule</code> will help I think too","m.mentions":{},"msgtype":"m.text"},"ts":1762804190545,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Lu_n_Vkf1Pmm4gtGrmA_gKjHva1PWnVz47axD5WaV9Q"},
{"content":{"body":"Not speaking on behalf of V8. `v8::WasmModuleObject` is already exposed as a public API. V8 could expose `v8::ModuleSource` and make `v8::WasmModuleObject` a subclass of it","format":"org.matrix.custom.html","formatted_body":"Not speaking on behalf of V8. <code>v8::WasmModuleObject</code> is already exposed as a public API. V8 could expose <code>v8::ModuleSource</code> and make <code>v8::WasmModuleObject</code> a subclass of it","m.mentions":{},"msgtype":"m.text"},"ts":1762804358756,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$mq8uEWqQvOPYVt5oqNZeYIYQZ4l2bez2m8c4w8t8saw"},
{"content":{"body":"* Not speaking on behalf of V8 team. `v8::WasmModuleObject` is already exposed as a public API. V8 could expose `v8::ModuleSource` and make `v8::WasmModuleObject` a subclass of it","format":"org.matrix.custom.html","formatted_body":"* Not speaking on behalf of V8 team. <code>v8::WasmModuleObject</code> is already exposed as a public API. V8 could expose <code>v8::ModuleSource</code> and make <code>v8::WasmModuleObject</code> a subclass of it","m.mentions":{},"m.new_content":{"body":"Not speaking on behalf of V8 team. `v8::WasmModuleObject` is already exposed as a public API. V8 could expose `v8::ModuleSource` and make `v8::WasmModuleObject` a subclass of it","format":"org.matrix.custom.html","formatted_body":"Not speaking on behalf of V8 team. <code>v8::WasmModuleObject</code> is already exposed as a public API. V8 could expose <code>v8::ModuleSource</code> and make <code>v8::WasmModuleObject</code> a subclass of it","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$mq8uEWqQvOPYVt5oqNZeYIYQZ4l2bez2m8c4w8t8saw","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804364032,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$pvCezjbof6_jhqUySVXoRp1ZJOZY2-nCC0QC_LAh1Fs"},
{"content":{"body":"The source phase as fully compiled can work for that, would require the JS representation to also have a fully compiled analog then","m.mentions":{},"msgtype":"m.text"},"ts":1762804481651,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Lw0QG7aXb29Jcp9cnCPu-TZJL3GIp1WvAfx7L8PKkvw"},
{"content":{"body":"would be nice if it can be associated with arbitrary cache data though","m.mentions":{},"msgtype":"m.text"},"ts":1762804506455,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$wEudQq6XprEJWVRhKbUn1t6iqen4PN8GuQxAvpSkgcU"},
{"content":{"body":"The public API is not essentially 1:1 mapping with JS representation actually. When `--js-source-phase-imports` is set, JS `WebAssembly.Module` is a subclass of AbstractModuleSource, regardless of the `v8::WasmModuleObject` C++ hierarchy.","format":"org.matrix.custom.html","formatted_body":"The public API is not essentially 1:1 mapping with JS representation actually. When <code>--js-source-phase-imports</code> is set, JS <code>WebAssembly.Module</code> is a subclass of AbstractModuleSource, regardless of the <code>v8::WasmModuleObject</code> C++ hierarchy.","m.mentions":{},"msgtype":"m.text"},"ts":1762804581907,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$wDVFRL_4b3XxrXBhM4nsgUhG_KkzwnXbWOQEp2b0vy4"},
{"content":{"body":"* The C++ public API is not essentially 1:1 mapping with JS representation actually. When `--js-source-phase-imports` is set, JS `WebAssembly.Module` is a subclass of AbstractModuleSource, regardless of the `v8::WasmModuleObject` C++ hierarchy.","format":"org.matrix.custom.html","formatted_body":"* The C++ public API is not essentially 1:1 mapping with JS representation actually. When <code>--js-source-phase-imports</code> is set, JS <code>WebAssembly.Module</code> is a subclass of AbstractModuleSource, regardless of the <code>v8::WasmModuleObject</code> C++ hierarchy.","m.mentions":{},"m.new_content":{"body":"The C++ public API is not essentially 1:1 mapping with JS representation actually. When `--js-source-phase-imports` is set, JS `WebAssembly.Module` is a subclass of AbstractModuleSource, regardless of the `v8::WasmModuleObject` C++ hierarchy.","format":"org.matrix.custom.html","formatted_body":"The C++ public API is not essentially 1:1 mapping with JS representation actually. When <code>--js-source-phase-imports</code> is set, JS <code>WebAssembly.Module</code> is a subclass of AbstractModuleSource, regardless of the <code>v8::WasmModuleObject</code> C++ hierarchy.","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$wDVFRL_4b3XxrXBhM4nsgUhG_KkzwnXbWOQEp2b0vy4","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804587301,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$kUTJtelKHzMRoAemyEwSGu3ev3-VhmmtV7hLnOAbxxU"},
{"content":{"body":"That pattern of using loader might already be somewhat problematic, regardless of the async requirement - typescript/zip don't even need to be async anyway (suppose loader A requires B to be loaded before A, and loader C requires itself to be loaded after A but before B, or you have multiple versions of one of these loaders...things easily get out of hand)","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$9Kal7jNnIrUH8Qcr3mdkfrRLLpFMXNMuYXt567Hw4jA"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762804599878,"senderName":"joyee","senderId":"@qzhang:igalia.com","id":"$wBmE11NoAXikRlvWtdmTBtrBiXkNgF-3TjGk8mCptYA"},
{"content":{"body":"this is separate from `WebAssembly Module Record` though","format":"org.matrix.custom.html","formatted_body":"this is separate from <code>WebAssembly Module Record</code> though","m.mentions":{},"msgtype":"m.text"},"ts":1762804613400,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$NSCCpdqWByvzVrN5FyXmVS1xWZZZpP2HX_b16VXyKcw"},
{"content":{"body":"Addressing https://github.com/tc39/proposal-esm-phase-imports/issues/53 could help engines like V8 to define what state should come with a source record, and what state should come with an instance record, being spec-complaint","m.mentions":{},"msgtype":"m.text"},"ts":1762804713187,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$yEusbk23hmkrqNuV9kGWkYwG9YdZjfVf_KfFjE7efWg"},
{"content":{"body":"How would it help to see that addressed? A more detailed explainer document around semantics?","m.mentions":{},"msgtype":"m.text"},"ts":1762804804652,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$gPh8u-7z54sI8scsV2ki41eQci-lBwKSqVH7ibO1QMc"},
{"content":{"body":"* How would it help to see that addressed? A more detailed explainer document around semantics and state that is carried?","m.mentions":{},"m.new_content":{"body":"How would it help to see that addressed? A more detailed explainer document around semantics and state that is carried?","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$gPh8u-7z54sI8scsV2ki41eQci-lBwKSqVH7ibO1QMc","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804818446,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$KjSmyv5PCdNpE4nS2ebR7C9s4JJDZnCLXY9vU7iQM4s"},
{"content":{"body":"Like, as you mentioned, making Module Source Record a first class record in ecma262 could be a first step","m.mentions":{},"msgtype":"m.text"},"ts":1762804903246,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$UxxORRvpuMSLC8iNZJgP3kTsTgCNRFdV-HFSuC3eEYU"},
{"content":{"body":"right now, the spec says \"ModuleSource instances have a [[SourceTextModuleRecord]] internal slot.\" which is totally confusing","m.mentions":{},"msgtype":"m.text"},"ts":1762804918479,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$gcaV02DuevDsVynBq-w-Uh5bmAe31EKFiKNazaGCav0"},
{"content":{"body":"* right now, the spec says \"ModuleSource instances have a \\[\\[SourceTextModuleRecord\\]\\] internal slot.\" which could be confusing","format":"org.matrix.custom.html","formatted_body":"* right now, the spec says &quot;ModuleSource instances have a [[SourceTextModuleRecord]] internal slot.&quot; which could be confusing","m.mentions":{},"m.new_content":{"body":"right now, the spec says \"ModuleSource instances have a \\[\\[SourceTextModuleRecord\\]\\] internal slot.\" which could be confusing","format":"org.matrix.custom.html","formatted_body":"right now, the spec says &quot;ModuleSource instances have a [[SourceTextModuleRecord]] internal slot.&quot; which could be confusing","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$gcaV02DuevDsVynBq-w-Uh5bmAe31EKFiKNazaGCav0","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804938968,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$T4fLpO_sKHEjb7WBfXOHAtLeVzgtiy2GHTa-lTPr7Ak"},
{"content":{"body":"here's the diagram","m.mentions":{},"msgtype":"m.text"},"ts":1762805001186,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$j_IuGgD3nfKm5RmKF9BBIcJfK9vqr_z_dcWqugBjHBs"},
{"content":{"body":"yes we need to decide if we want to split out module source, but from a spec perpsective we already discussed and determined this isn't necessary and because it affects three separate specifications that is a huge refactoring","m.mentions":{},"msgtype":"m.text"},"ts":1762805078090,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Xqlbirh7mqejln3QZwd1cJF4Jy3wcUFPUpqnZQB9p1o"},
{"content":{"body":"so I think addressing the question separately for the spec and v8 makes sense","m.mentions":{},"msgtype":"m.text"},"ts":1762805088870,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$bXZ09HMEIg2UN238XhVqW2qaqOFAW7FKKTYy4hUHzcY"},
{"content":{"body":"we're talking about v8 here - and need to answer that question now","m.mentions":{},"msgtype":"m.text"},"ts":1762805098115,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$tlVAyKhM4Pd8mxl-KzBLoYxXQwoNCwM8_vP3pQnvC4A"},
{"content":{"body":"I was saying that making this clearer in spec could help engines implement it correctly","m.mentions":{},"msgtype":"m.text"},"ts":1762805125446,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$FenZGaLGd50qHfT5aofXkoq3FUl1qgxtnANbFG3-D4Q"},
{"content":{"body":"and engines could expose 1:1 API mapping to the spec","m.mentions":{},"msgtype":"m.text"},"ts":1762805150670,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$KGw1Q9towdRcHYMEVEMBGSqjZZQgH-orCQ-kM2DrQ2g"},
{"content":{"body":"i appreciate that, but this might be one of those scenarios where spec complexity and implementation complexity require separate modularity approaches","m.mentions":{},"msgtype":"m.text"},"ts":1762805153684,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$lWeFZZhGqp4OiTtS7Q8I-9egSXB57vZk8ZjYmTvqc50"},
{"content":{"body":"Allen always said that standards are not implementation algorithms but instead formal definitions that full cover the semantics","m.mentions":{},"msgtype":"m.text"},"ts":1762805247148,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$e3erLKvh3pXPPzNp2MlUiBccCp28F-YrLGnhfng8x2c"},
{"content":{"body":"without a source of truth for the source / instance record hierarchy, i think defining the hierarchy in an engine by engine basis does not help in the long term. There are already name ambiguity in both spec and implementation that sometime \"module\" refers to a module instance, and sometime \"module\" refers to a source representation","m.mentions":{},"msgtype":"m.text"},"ts":1762805315722,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$9LWooc3OFhDEGg52WFDjz_P5xfLSi9OaZsWxeB-vSFo"},
{"content":{"body":"I think we iron this out with good tests and that is my focus here","m.mentions":{},"msgtype":"m.text"},"ts":1762805366339,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$P84AGTwvWpg68TZfydqZBD6Ja_GwVUyzwN-J9ExHRak"},
{"content":{"body":"covering the cases of module serialization and importability across contexts","m.mentions":{},"msgtype":"m.text"},"ts":1762805380943,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$JbScmdfRW8FX6U-JVnKHg2DJHBsTQbJwrZslMhpY8bU"},
{"content":{"body":"if not refactoring ecma262, an (official) explainer as a source of truth could also help","m.mentions":{},"msgtype":"m.text"},"ts":1762805405479,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$d7nwg4LJ0NzgCw8snR8k5DViH3VHkppgfCG0g577sNc"},
{"content":{"body":"Sure, that's good feedback, I'll put some thought to along with the test262 work. Appreciated spec on its own is not enough to clearly explain the model.","m.mentions":{},"msgtype":"m.text"},"ts":1762805604530,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$6EKmROU5_TGmFHizq7fNRLO5VNaLbst09FvObUGeUCA"},
{"content":{"body":"(and especially if we have determined spec structure is not necessarily implementation structure)","m.mentions":{},"msgtype":"m.text"},"ts":1762805646117,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$BNPkGBPCKzvmhTVOurBnHspNfTaRBQkbHMbIS5ucJAI"},
{"content":{"body":"* (and especially if we have determined spec structure is not necessarily implementation structure, although tbd as well!)","m.mentions":{},"m.new_content":{"body":"(and especially if we have determined spec structure is not necessarily implementation structure, although tbd as well!)","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$BNPkGBPCKzvmhTVOurBnHspNfTaRBQkbHMbIS5ucJAI","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762805659898,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$7wcRJnd0_zkEK3by9_tvBn3KyIyt6Fdr2CSXABIkZqs"}
]