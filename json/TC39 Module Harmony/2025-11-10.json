[
{"content":{"body":"Further to the discussion last meeting about source phase architecture in v8 being tough to integrate","m.mentions":{},"msgtype":"m.text"},"ts":1762800087121,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$ACTJ-HR1F0YPpSCQAu_Ip6f5vJ1er6DcJ1lU-JNByNs"},
{"content":{"body":"both Deno and Cloudflare now resolve dependencies of source phase moudles, effectively in violation of the spec, just because that's the natural implementation path .... :(","m.mentions":{},"msgtype":"m.text"},"ts":1762800111687,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$RvEkL35U6ADes25RgpUe3p2DyhMfYYj0TcsGpppFOFY"},
{"content":{"body":"https://github.com/denoland/deno/issues/31240","m.mentions":{},"msgtype":"m.text"},"ts":1762800113041,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$-YnWRPaek2ahifqg6hvkqDw7RLO1I5P0TEMxs216Nlo"},
{"content":{"body":"Deno didn't implement V8's source phase callbacks. Would you mind elaborating why this is a V8 issue?","m.mentions":{},"msgtype":"m.text"},"ts":1762802620608,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$g2pYp3snhZr8G_OLnLYiRPm3P0lpFEZH6Ne3i18_o9Y"},
{"content":{"body":"In other words, Deno didn't implement V8's source phase support at all.","m.mentions":{},"msgtype":"m.text"},"ts":1762802671264,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$6pRomUvWDwj9IfKproyEI_spX93jubHy4T9yb-2deko"},
{"content":{"body":"Yeah I see that's the root cause here. Would be nice if implementers didn't have to do anything to get source phase though...","m.mentions":{},"msgtype":"m.text"},"ts":1762802918139,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$6P7b7niloWymkoC-rQmxIj4l29KNqs84ZvvmtEBktP0"},
{"content":{"body":"I'm not sure it will help in Deno's case","m.mentions":{},"msgtype":"m.text"},"ts":1762802944579,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$TxgYb7gASlgGVuDcejqn7aEYTMW2187HxkTqPoL953I"},
{"content":{"body":"Deno is literally resolving before even reaching to V8","m.mentions":{},"msgtype":"m.text"},"ts":1762802959149,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$3G7GLg-nXC4i04O8lgekQWDZEywF53jpdwmO87ZWnWw"},
{"content":{"body":"yeah, I see that, and that makes sense I suppose. Ideally implementations would _just_ need to opt-out of their prefetching for source phase, and then all phases and imports work out after that.","format":"org.matrix.custom.html","formatted_body":"yeah, I see that, and that makes sense I suppose. Ideally implementations would <em>just</em> need to opt-out of their prefetching for source phase, and then all phases and imports work out after that.","m.mentions":{},"msgtype":"m.text"},"ts":1762803093591,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$aV7_D90Jkpun2koXE6f9svbon8fgKbczHB79WdVRGtk"},
{"content":{"body":"If an embedder did not implement the source phase support, V8 does not enable the feature by default (at the moment, this is still hidden behind the flag `--js-source-phase-imports`)","format":"org.matrix.custom.html","formatted_body":"If an embedder did not implement the source phase support, V8 does not enable the feature by default (at the moment, this is still hidden behind the flag <code>--js-source-phase-imports</code>)","m.mentions":{},"msgtype":"m.text"},"ts":1762803175623,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$2F9U9L7xQOa0-lDJAAjgtjDSEzzGXuIceaMATfQN6pk"},
{"content":{"body":"I can see that this could be improved by asking V8 taking over the resolution step, so that V8 can stop resolving source import dependencies","m.mentions":{},"msgtype":"m.text"},"ts":1762803216403,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$p_yH1_dqr8n3cyW5ukOwhdqtbYJzkz_UcYK3VMhILo8"},
{"content":{"body":"* I can see that this could be potentially improved by asking V8 taking over the resolution step, so that V8 can stop resolving source import dependencies","m.mentions":{},"m.new_content":{"body":"I can see that this could be potentially improved by asking V8 taking over the resolution step, so that V8 can stop resolving source import dependencies","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$p_yH1_dqr8n3cyW5ukOwhdqtbYJzkz_UcYK3VMhILo8","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762803223990,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$FhhC3tcjB6J31WiTN34tAZIeti6ioyFrH3a3VZfgIWw"},
{"content":{"body":"However, I'd doubt the complexity of it because resolution can be either sync (node.js) or async (web).","m.mentions":{},"msgtype":"m.text"},"ts":1762803291955,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$-ZZj9xw8fMA2qrdzHF3MTUqnejJwJqiWgZHkjxrBL_I"},
{"content":{"body":"* However, I'd doubt the complexity of it because resolution can be either sync (node.js) or async (web & node.js).","m.mentions":{},"m.new_content":{"body":"However, I'd doubt the complexity of it because resolution can be either sync (node.js) or async (web & node.js).","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$-ZZj9xw8fMA2qrdzHF3MTUqnejJwJqiWgZHkjxrBL_I","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762803306850,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$3tm3sKbkRvsvQEPWJX6YNh0QLD_pTNx4LfkF9AiP394"},
{"content":{"body":"resolution is always now synchronous on both the web and node","m.mentions":{},"msgtype":"m.text"},"ts":1762803313126,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Caje7-vtc6UTm3C13AXuCFe2HcWLVd39_pHG73KtW4Q"},
{"content":{"body":"node still allows async resolution","m.mentions":{},"msgtype":"m.text"},"ts":1762803328293,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$CMalu64q591j6sIG4Z6cGGs8s6T-kYuO3RUxeoCFWsg"},
{"content":{"body":"is it not fully deprecated yet?","m.mentions":{},"msgtype":"m.text"},"ts":1762803363642,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$5hZi6fAzID6sdHUfR3FyYfSG0Hm5Cnmarp1ibWwnh6M"},
{"content":{"body":"it's.. not even under the discussion of deprecation","m.mentions":{},"msgtype":"m.text"},"ts":1762803379133,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$Ixz8qzDBkKaIGQgFccV0JAKFF0ou2HxddlFEjkfXIbs"},
{"content":{"body":"* it's.. not even under the discussion of deprecation AFAICT","m.mentions":{},"m.new_content":{"body":"it's.. not even under the discussion of deprecation AFAICT","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$Ixz8qzDBkKaIGQgFccV0JAKFF0ou2HxddlFEjkfXIbs","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762803400904,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$_2V1lugtWCLnEm1rWWrGTy93O8o0X6S00LGU6XfUBrs"},
{"content":{"body":"I guess there's two main architectures that might work for V8 - `HostResolveImportedModuleSource` as the new primitive that obtains sources first as a separate object (that can have compile cache etc)","format":"org.matrix.custom.html","formatted_body":"I guess there's two main architectures that might work for V8 - <code>HostResolveImportedModuleSource</code> as the new primitive that obtains sources first as a separate object (that can have compile cache etc)","m.mentions":{},"msgtype":"m.text"},"ts":1762803489048,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$lQi3ZdVvBKT3OmiuqIGQ4u7vjK8rUSgAaspnfI08fv0"},
{"content":{"body":"or we stick with `HostResolveImportedModuleV2` or `HostResolveImportedModuleWithPhase` that takes a phase argument as a hint, then returns a module without resolving dependencies","format":"org.matrix.custom.html","formatted_body":"or we stick with <code>HostResolveImportedModuleV2</code> or <code>HostResolveImportedModuleWithPhase</code> that takes a phase argument as a hint, then returns a module without resolving dependencies","m.mentions":{},"msgtype":"m.text"},"ts":1762803517394,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$TXGVqKsl61NBe65Rd5d7xJ3gockGX0GEydCVkf0U8HA"},
{"content":{"body":"Yeah, so a new v2 / or we extend it to apply to all modules","m.mentions":{},"msgtype":"m.text"},"ts":1762803566755,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$TFm6a9ylk7whVH2mojMd_kNcP06fhNJnQ38O5FDloR0"},
{"content":{"body":"not sure if we are referring to the same thing. Are you referring to `HostImportModuleWithPhaseDynamicallyCallback`?","format":"org.matrix.custom.html","formatted_body":"not sure if we are referring to the same thing. Are you referring to <code>HostImportModuleWithPhaseDynamicallyCallback</code>?","m.mentions":{},"msgtype":"m.text"},"ts":1762803605382,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$nuhpNa9EfiGeFXMP-L6-6QEoSnp_Fx3C7ougWjaEG_Y"},
{"content":{"body":"yes, as either being replaced or extended","m.mentions":{},"msgtype":"m.text"},"ts":1762803620500,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$bcp7mVaRlDOERgU2FRTtujy-fKEFGleGlcEvSVN0it4"},
{"content":{"body":"`HostImportModuleWithPhaseDynamicallyCallback` is only invoked for `import.source()` calls, it already takes an argument of `ModuleImportPhase`","format":"org.matrix.custom.html","formatted_body":"<code>HostImportModuleWithPhaseDynamicallyCallback</code> is only invoked for <code>import.source()</code> calls, it already takes an argument of <code>ModuleImportPhase</code>","m.mentions":{},"msgtype":"m.text"},"ts":1762803690110,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$SwrTpZO6XP_wxA1lrA4TY1c1vtnra2S9YmoqZXFoB3M"},
{"content":{"body":"I understand that and I've implemented that in both Node.js and Cloudflare","m.mentions":{},"msgtype":"m.text"},"ts":1762803707055,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$ypK4oJa7jJ_feMml1qCqulCcKWfKAI4QhwhQif7XfH8"},
{"content":{"body":"what I'm talking about is how we extend this to work for JS modules and sources more generally, while avoiding implementer complexity, as implementer feedback","m.mentions":{},"msgtype":"m.text"},"ts":1762803740930,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$hawzrz-8wwkLnwDSuXNxZ3LYP3fF9tW79dztRzqvf18"},
{"content":{"body":"It no longer does at least on the main thread (only allows it on the async loader hook thread when async loader hooks are registered)","m.mentions":{"user_ids":["@legendecas:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$CMalu64q591j6sIG4Z6cGGs8s6T-kYuO3RUxeoCFWsg"}},"msgtype":"m.text"},"ts":1762803843141,"senderName":"joyee","senderId":"@qzhang:igalia.com","id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE"},
{"content":{"body":"Putting Deno's issue aside, it's not easy for me to understand what's the exact issue you are trying to improve. I assume you are trying to push V8 taking over the implementation of resolution steps, and ask host to resolve for each `referrer, specifier, attributes` pairs?","format":"org.matrix.custom.html","formatted_body":"Putting Deno's issue aside, it's not easy for me to understand what's the exact issue you are trying to improve. I assume you are trying to push V8 taking over the implementation of resolution steps, and ask host to resolve for each <code>referrer, specifier, attributes</code> pairs?","m.mentions":{},"msgtype":"m.text"},"ts":1762803855413,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$fSjfMELhNSvC5UZC05ZC2aerKwVOaSkAxe0ZHtNP6WE"},
{"content":{"body":"no, just to separate source phase from instance phase in the V8 pipeline","m.mentions":{},"msgtype":"m.text"},"ts":1762803873812,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$hLGEWJb6XFKu3YtvUc3jWqPbrn1ADDtChxTDMvvOfTI"},
{"content":{"body":"but... it is still allowed, right?","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762803881715,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$Yul2wVqgjnmeJwHYlqET_FHgoN_3dd76yGKXZZVRLEM"},
{"content":{"body":"sources as first-class representations in v8","m.mentions":{},"msgtype":"m.text"},"ts":1762803884893,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$XGZn6Ek-iO0EsuS803ORGNfW-zXZuGTQtOjPoOfHV4g"},
{"content":{"body":"i.e. both for WebAssembly Module Record, and for Source Text Module Record","m.mentions":{},"msgtype":"m.text"},"ts":1762803913598,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$141JEvHFBJIjjKnSCtwkBt9Zx_-681IehVdB15HkvuA"},
{"content":{"body":"i.e. we still need to support async resolution, not being able to remove the support entirely","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$Yul2wVqgjnmeJwHYlqET_FHgoN_3dd76yGKXZZVRLEM"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762803924608,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$aof7PV_YWVhkxQwolUEK7GGx2DcEsW07CHfDOdeFLmE"},
{"content":{"body":"We technically could, it's just going to be a breaking change for a fairly niche use case in an experimental feature (when you expect an async loader to affect the resolution of subsequent loader on the loader thread - say you register a typescript loader, and you want to load a zip loader written in typescript, that sort of thing)","m.mentions":{},"m.relates_to":{"event_id":"$IBeGhPAX6MuqImZlTYOpNhOprcj5qTWKa3W-4dbfxZE","is_falling_back":true,"m.in_reply_to":{"event_id":"$aof7PV_YWVhkxQwolUEK7GGx2DcEsW07CHfDOdeFLmE"},"rel_type":"m.thread"},"msgtype":"m.text"},"ts":1762804055070,"senderName":"joyee","senderId":"@qzhang:igalia.com","id":"$9Kal7jNnIrUH8Qcr3mdkfrRLLpFMXNMuYXt567Hw4jA"},
{"content":{"body":"I think the current `v8::Module` maps to the Module Record in the spec text. Both are essentially representation of module instance record","format":"org.matrix.custom.html","formatted_body":"I think the current <code>v8::Module</code> maps to the Module Record in the spec text. Both are essentially representation of module instance record","m.mentions":{},"msgtype":"m.text"},"ts":1762804073726,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$3AvzRWzejtzF0GPUfZphuMUeQmRKdKwuZZUq3s_IyZI"},
{"content":{"body":"https://github.com/tc39/proposal-esm-phase-imports/issues/53","m.mentions":{},"msgtype":"m.text"},"ts":1762804074702,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$zypEqih496NzXshpU8mv1vjfslEooXjSopGjrUgEEjg"},
{"content":{"body":"right, but in the spec `[[ModuleSource]]` is a field on the module record","format":"org.matrix.custom.html","formatted_body":"right, but in the spec <code>[[ModuleSource]]</code> is a field on the module record","m.mentions":{},"msgtype":"m.text"},"ts":1762804099083,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$f-w7WY6JeUgkjoXpSEjDZlhK8Vc2ndFLNDtwSoinCnY"},
{"content":{"body":"so we need to use the module as the handle for the module source, or separate the module source wrapper into its own thing","m.mentions":{},"msgtype":"m.text"},"ts":1762804122322,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$ojBS1krxyqAkkRLYVnLjnJB1n6TDTp4CNJC_ZHjjYyo"},
{"content":{"body":"as I say two main paths","m.mentions":{},"msgtype":"m.text"},"ts":1762804128703,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$QJncWli8MLNlRqB3KVGyNTBZ3W39tTnJ5ifT0TV3n3s"},
{"content":{"body":"V8 did not expose internal AbstractModuleSource to the API. It could be exposed as a first class representation. But it'd still be great to distinguish it in the spec as a first step","m.mentions":{},"msgtype":"m.text"},"ts":1762804170270,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$WUALouF3uGi1fIZx1Q4_R7blXu_lFnWmB_UECTYlLRQ"},
{"content":{"body":"* V8 did not expose internal AbstractModuleSource to the API. It could be potentially exposed as a first class representation. But it'd still be great to distinguish it in the spec as a first step","m.mentions":{},"m.new_content":{"body":"V8 did not expose internal AbstractModuleSource to the API. It could be potentially exposed as a first class representation. But it'd still be great to distinguish it in the spec as a first step","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$WUALouF3uGi1fIZx1Q4_R7blXu_lFnWmB_UECTYlLRQ","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804181013,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$OwEj0Z8A62xKJWOi8ieDHWkxDhEls56YiUUUbNiUoLE"},
{"content":{"body":"having `v8::WasmModule` will help I think too","format":"org.matrix.custom.html","formatted_body":"having <code>v8::WasmModule</code> will help I think too","m.mentions":{},"msgtype":"m.text"},"ts":1762804190545,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Lu_n_Vkf1Pmm4gtGrmA_gKjHva1PWnVz47axD5WaV9Q"},
{"content":{"body":"Not speaking on behalf of V8. `v8::WasmModuleObject` is already exposed as a public API. V8 could expose `v8::ModuleSource` and make `v8::WasmModuleObject` a subclass of it","format":"org.matrix.custom.html","formatted_body":"Not speaking on behalf of V8. <code>v8::WasmModuleObject</code> is already exposed as a public API. V8 could expose <code>v8::ModuleSource</code> and make <code>v8::WasmModuleObject</code> a subclass of it","m.mentions":{},"msgtype":"m.text"},"ts":1762804358756,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$mq8uEWqQvOPYVt5oqNZeYIYQZ4l2bez2m8c4w8t8saw"},
{"content":{"body":"* Not speaking on behalf of V8 team. `v8::WasmModuleObject` is already exposed as a public API. V8 could expose `v8::ModuleSource` and make `v8::WasmModuleObject` a subclass of it","format":"org.matrix.custom.html","formatted_body":"* Not speaking on behalf of V8 team. <code>v8::WasmModuleObject</code> is already exposed as a public API. V8 could expose <code>v8::ModuleSource</code> and make <code>v8::WasmModuleObject</code> a subclass of it","m.mentions":{},"m.new_content":{"body":"Not speaking on behalf of V8 team. `v8::WasmModuleObject` is already exposed as a public API. V8 could expose `v8::ModuleSource` and make `v8::WasmModuleObject` a subclass of it","format":"org.matrix.custom.html","formatted_body":"Not speaking on behalf of V8 team. <code>v8::WasmModuleObject</code> is already exposed as a public API. V8 could expose <code>v8::ModuleSource</code> and make <code>v8::WasmModuleObject</code> a subclass of it","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$mq8uEWqQvOPYVt5oqNZeYIYQZ4l2bez2m8c4w8t8saw","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1762804364032,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$pvCezjbof6_jhqUySVXoRp1ZJOZY2-nCC0QC_LAh1Fs"},
{"content":{"body":"The source phase as fully compiled can work for that, would require the JS representation to also have a fully compiled analog then","m.mentions":{},"msgtype":"m.text"},"ts":1762804481651,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$Lw0QG7aXb29Jcp9cnCPu-TZJL3GIp1WvAfx7L8PKkvw"},
{"content":{"body":"would be nice if it can be associated with arbitrary cache data though","m.mentions":{},"msgtype":"m.text"},"ts":1762804506455,"senderName":"guybedford","senderId":"@guybedford:matrix.org","id":"$wEudQq6XprEJWVRhKbUn1t6iqen4PN8GuQxAvpSkgcU"}
]