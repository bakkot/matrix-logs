[
{"content":{"body":"Hi everyone. My team recently discovered an interesting technique used by React Server components.\n\nThe React Server components machinery (in particular [react-client](https://github.com/facebook/react/tree/main/packages/react-client)) creates fake scripts with the same source map as a real user code to preserve source mapped traces in the browser. It allows recreating the top stack frame of the server code on the client preserving mapping to the original source code.\n\nConsider an example ([github repo](https://github.com/Soarex16/next-15-server-components-reproduction-app)):\n\n```js\nexport default function Home() {\n  console.log('Home');\n  return <div>\n    <main>\n      <h1>Header</h1>\n      Some text\n    </main>\n    <footer>Footer</footer>\n  </div>;\n}\n```\n\nIf you open this example in a browser, it will print to console the following message (first picture)\nAnd clicking to “page.tsx:3” points to the original source (second picture).\n\nFrom the user perspective, it’s a really neat feature, but unfortunately, this technique confuses js debuggers ([issue on GH](https://github.com/vercel/next.js/issues/77733)). This happens because debuggers think that this piece of code was bundled in different places multiple times.\n\nSo when the user put a breakpoint, the debugger put breakpoints in all these fake scripts causing redundant breaks.\n\nHere is an example of one of the scripts:\n\n```js\n/* This module was rendered by a Server Component. Turn on Source Maps to see the server source. */\n\n({\"Home\":_=>\n\n        _()})\n\n//# sourceURL=rsc://React/Server/webpack-internal:///(rsc)/./app/page.tsx?0\n\n//# sourceMappingURL=http://localhost:3000/__nextjs_source-map?filename=webpack-internal%3A%2F%2F%2F%28rsc%29%2F.%2Fapp%2Fpage.tsx\n```\n\nWe have several options for solving this problem, and all of them require coordination between debuggers and frameworks. Since it affects all major debuggers – Chrome DevTools, WebStorm, VS Code, I’m asking for your feedback as a starting point for discussion with the community.  \nHere they are:\n\n* Use some heuristics (like matching file structure, comments, etc.) to detect fake scripts that don't need breakpoints. This approach is unreliable and can easily break if React changes scripts structure in the future.  \n* Use some comment similar to \\# sourceMappingURL to indicate that this file should be skipped by the debugger  \n* For fake scripts generate source maps with some extra field (like ignoreList but for generated code):\n\n```json\n{\n  \"version\" : 3,\n  \"file\": \"out.js\",\n  \"ignored\": true,\n  rest of the source map ...\n}\n```","format":"org.matrix.custom.html","formatted_body":"<p>Hi everyone. My team recently discovered an interesting technique used by React Server components.</p>\n<p>The React Server components machinery (in particular <a href=\"https://github.com/facebook/react/tree/main/packages/react-client\">react-client</a>) creates fake scripts with the same source map as a real user code to preserve source mapped traces in the browser. It allows recreating the top stack frame of the server code on the client preserving mapping to the original source code.</p>\n<p>Consider an example (<a href=\"https://github.com/Soarex16/next-15-server-components-reproduction-app\">github repo</a>):</p>\n<pre><code class=\"language-js\">export default function Home() {\n  console.log('Home');\n  return &lt;div&gt;\n    &lt;main&gt;\n      &lt;h1&gt;Header&lt;/h1&gt;\n      Some text\n    &lt;/main&gt;\n    &lt;footer&gt;Footer&lt;/footer&gt;\n  &lt;/div&gt;;\n}\n</code></pre>\n<p>If you open this example in a browser, it will print to console the following message (first picture)<br>And clicking to “page.tsx:3” points to the original source (second picture).</p>\n<p>From the user perspective, it’s a really neat feature, but unfortunately, this technique confuses js debuggers (<a href=\"https://github.com/vercel/next.js/issues/77733\">issue on GH</a>). This happens because debuggers think that this piece of code was bundled in different places multiple times.</p>\n<p>So when the user put a breakpoint, the debugger put breakpoints in all these fake scripts causing redundant breaks.</p>\n<p>Here is an example of one of the scripts:</p>\n<pre><code class=\"language-js\">/* This module was rendered by a Server Component. Turn on Source Maps to see the server source. */\n\n({\"Home\":_=&gt;\n\n        _()})\n\n//# sourceURL=rsc://React/Server/webpack-internal:///(rsc)/./app/page.tsx?0\n\n//# sourceMappingURL=http://localhost:3000/__nextjs_source-map?filename=webpack-internal%3A%2F%2F%2F%28rsc%29%2F.%2Fapp%2Fpage.tsx\n</code></pre>\n<p>We have several options for solving this problem, and all of them require coordination between debuggers and frameworks. Since it affects all major debuggers – Chrome DevTools, WebStorm, VS Code, I’m asking for your feedback as a starting point for discussion with the community.<br>\nHere they are:</p>\n<ul>\n<li>Use some heuristics (like matching file structure, comments, etc.) to detect fake scripts that don't need breakpoints. This approach is unreliable and can easily break if React changes scripts structure in the future.</li>\n<li>Use some comment similar to # sourceMappingURL to indicate that this file should be skipped by the debugger</li>\n<li>For fake scripts generate source maps with some extra field (like ignoreList but for generated code):</li>\n</ul>\n<pre><code class=\"language-json\">{\n  \"version\" : 3,\n  \"file\": \"out.js\",\n  \"ignored\": true,\n  rest of the source map ...\n}\n</code></pre>\n","m.mentions":{},"msgtype":"m.text"},"ts":1749630656677,"senderName":"Shumaf Lovpache","senderId":"@sshumaf:matrix.org","id":"$FteuluBdSuhtJ2jn5ZX3kegXwwIxndXozUIOCrNS5m4"},
{"content":{"body":"Not sure I fully follow, why are the fake scripts needed? Is it because due to the server rendering no JS would actually run on the browser-side?","m.mentions":{},"msgtype":"m.text"},"ts":1749631776490,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$tyms2QOtqxUMwMt4WhgoB6JiQPmi23Vld3jrD1QU0to"},
{"content":{"body":"If I understand correctly, these fake scripts are indeed for the code that runs on the server and it creates problems because the same code can run on both the server (when the component is first rendered) and the client (when the component is rendered after an update), in that case you have a real and a fake script, both pointing to the same original code.","m.mentions":{},"msgtype":"m.text"},"ts":1749632180304,"senderName":"Holger Benl","senderId":"@holger_benl:matrix.org","id":"$R-NuApJSOdTZIQOoVFRlSuBmT-X3kqKPvqpGuZjDReU"},
{"content":{"body":"I don't even understand how the server console.log is injected into the client (from the screenshot)","m.mentions":{},"msgtype":"m.text"},"ts":1749632268622,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$SaQUwx-4Mb39-Sn9bsITtnfK9wrdETG-EkadVumiPFs"},
{"content":{"body":"Yes, thats because some `console.log` was actually executed on the server and in the browser we don't have the same code that rendered the page, so we need to construct a fake script with matching lines","format":"org.matrix.custom.html","formatted_body":"Yes, thats because some <code>console.log</code> was actually executed on the server and in the browser we don't have the same code that rendered the page, so we need to construct a fake script with matching lines","m.mentions":{"user_ids":["@szuend:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$tyms2QOtqxUMwMt4WhgoB6JiQPmi23Vld3jrD1QU0to"}},"msgtype":"m.text"},"ts":1749632682799,"senderName":"Shumaf Lovpache","senderId":"@sshumaf:matrix.org","id":"$LcRWNL3xkMtqSIzjE4NdyS1n8JfvIhwQ0BVXpkT5Sck"},
{"content":{"body":"Yeah, with `console.error` and source maps disabled i can kinda understand whats happening","format":"org.matrix.custom.html","formatted_body":"Yeah, with <code>console.error</code> and source maps disabled i can kinda understand whats happening","m.mentions":{},"msgtype":"m.text"},"ts":1749632902496,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$I6L2YB1PmHsnaSD8-BY6n3VtDd2hfv4Tt9Kxyzpv_rU"},
{"content":{"body":"The answer is [ReactFlightClient](https://github.com/facebook/react/blob/ef4bc8b4f91023afac437be9179beef350b32db3/packages/react-client/src/ReactFlightClient.js#L2565). As I understood, ReactFlightClient [reads events from response stream](https://github.com/facebook/react/blob/main/packages/react-client/src/ReactFlightClient.js#L3121C10-L3121C30) and replays them on the client","format":"org.matrix.custom.html","formatted_body":"The answer is <a href=\"https://github.com/facebook/react/blob/ef4bc8b4f91023afac437be9179beef350b32db3/packages/react-client/src/ReactFlightClient.js#L2565\">ReactFlightClient</a>. As I understood, ReactFlightClient <a href=\"https://github.com/facebook/react/blob/main/packages/react-client/src/ReactFlightClient.js#L3121C10-L3121C30\">reads events from response stream</a> and replays them on the client","m.mentions":{"user_ids":["@szuend:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$SaQUwx-4Mb39-Sn9bsITtnfK9wrdETG-EkadVumiPFs"}},"msgtype":"m.text"},"ts":1749632959499,"senderName":"Shumaf Lovpache","senderId":"@sshumaf:matrix.org","id":"$QYSyWe_hgN064asrLzhVUlyXqax1aHUZgNmmqLmTOGE"},
{"content":{"body":"So it receives an event that `console.log` happened on the server. It creates a  fake temporary script with that console.log and slaps a source map onto that that looks like the original `page.tsx`","format":"org.matrix.custom.html","formatted_body":"So it receives an event that <code>console.log</code> happened on the server. It creates a  fake temporary script with that console.log and slaps a source map onto that that looks like the original <code>page.tsx</code>","m.mentions":{},"msgtype":"m.text"},"ts":1749633133496,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$mcyFdVmTFzfk2Uvkd-EjK6alrTmU4oZJi9Ah2pUey0E"},
{"content":{"body":"is that a somewhat accurate summary?","m.mentions":{},"msgtype":"m.text"},"ts":1749633142224,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$yIMOO4YWJbs6-I6eO7RaMbb4nhxg5o2dI55oT6L1uWA"},
{"content":{"body":"Yes, precisely :)","m.mentions":{},"msgtype":"m.text"},"ts":1749633164458,"senderName":"Shumaf Lovpache","senderId":"@sshumaf:matrix.org","id":"$RPRqOODd3UF7mzHVlsVXTjG1O4_RJM9C_huqhRcZSVc"},
{"content":{"body":"The only thing i can think of (in Chrome DevTools), is to explicitly ignore-list the temporary scripts if they follow some naming pattern.","m.mentions":{},"msgtype":"m.text"},"ts":1749633314741,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$HMvgWHfksFOJoYSpQfr0K6J8OW72KIMSvOY5a1PVQ6U"},
{"content":{"body":"Yeah, the breakpoint behavior on Chroem DevTools for this is atrocious","m.mentions":{},"msgtype":"m.text"},"ts":1749633412586,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$sFb09hpEqxgOlgzhSwJZ17QaSVA4jAAzvKqcm1Uk-Ho"},
{"content":{"body":"Nice point, it's much easier to agree on some naming convention and use debugger capabilities","m.mentions":{"user_ids":["@szuend:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$HMvgWHfksFOJoYSpQfr0K6J8OW72KIMSvOY5a1PVQ6U"}},"msgtype":"m.text"},"ts":1749633445650,"senderName":"Shumaf Lovpache","senderId":"@sshumaf:matrix.org","id":"$lWtpvQI7182isa8uVK5vgrFzuGHbn2QE1Aediq6YmI0"},
{"content":{"body":"if you put one on the `console.log`, the \"breakpoint moving\" logic kicks in and will insert new breakpoints. So even though you \"continue\", it ends up as a stepping","format":"org.matrix.custom.html","formatted_body":"if you put one on the <code>console.log</code>, the \"breakpoint moving\" logic kicks in and will insert new breakpoints. So even though you \"continue\", it ends up as a stepping","m.mentions":{},"msgtype":"m.text"},"ts":1749633450697,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$IbUu4pBxK5Dp2Ths-f2GN9y969ofgj-0XSISN6H6xcY"},
{"content":{"body":"Whats the reason for the odd temporary script formatting? Is it to preserve line numbers in `Error.stack` which doesn't go through source maps?","format":"org.matrix.custom.html","formatted_body":"Whats the reason for the odd temporary script formatting? Is it to preserve line numbers in <code>Error.stack</code> which doesn't go through source maps?","m.mentions":{},"msgtype":"m.text"},"ts":1749633919415,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$LckOtKOZOvY9arbYPoQKasgcZV_SMtnlnkYBjA92mIs"},
{"content":{"body":"What do you mean by 'odd temporary script formatting'?","m.mentions":{},"msgtype":"m.text"},"ts":1749636618810,"senderName":"Shumaf Lovpache","senderId":"@sshumaf:matrix.org","id":"$izkaNZmgNfWhJ-_MOTQ7L3HrQaa2-Gz8aQ5nYSxoDmg"},
{"content":{"body":"The temporary script has different numbers of newlines and the `_()` call is usually indented a lot","format":"org.matrix.custom.html","formatted_body":"The temporary script has different numbers of newlines and the <code>_()</code> call is usually indented a lot","m.mentions":{},"msgtype":"m.text"},"ts":1749638267794,"senderName":"Simon Zünd","senderId":"@szuend:matrix.org","id":"$eBPpMfE8bDmB7Cuyf-1jPXOjGp9LW0DqZJ91P2iZIPQ"}
]