[
{"content":{"body":"> <@shuyuguo:matrix.org> i guarantee you adding a check to Array.prototype object lookups will regress speedometer\n\nIs this done by analyzing the creation of, or transition to, a new map that has an JS_ARRAY_TYPE type, or are you talking about patching actual assignments (i.e., to catch code that may not have moved to the optimizing compiler)?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!WgJwmjBNZEXhJnXHXw:matrix.org/$RmdoURPrz0GlnmwaETsc49Ko29zKy5zAhQ1YwXCAhaY?via=matrix.org&via=igalia.com&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@shuyuguo:matrix.org\">@shuyuguo:matrix.org</a><br>i guarantee you adding a check to Array.prototype object lookups will regress speedometer</blockquote></mx-reply>Is this done by analyzing the creation of, or transition to, a new map that has an JS_ARRAY_TYPE type, or are you talking about patching actual assignments (i.e., to catch code that may not have moved to the optimizing compiler)?","m.relates_to":{"m.in_reply_to":{"event_id":"$RmdoURPrz0GlnmwaETsc49Ko29zKy5zAhQ1YwXCAhaY"}},"msgtype":"m.text"},"ts":1683670706636,"senderName":"rbuckton","senderId":"@rbuckton:matrix.org","id":"$pIv9jyOsx2jl6iUCbOsNY1wsBhaC10aC3Vi95GWbz3k"},
{"content":{"body":"well, i elided a few thoughts","msgtype":"m.text"},"ts":1683670964497,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$LsMXSGKZR5d2mR2r-MF1VWG5oUq27jExoksZ22W_62M"},
{"content":{"body":"i don't think it's sufficient to just check if e.g. someone added a new property named `group` to `Array.prototype`, because we know unconditional assignment is unproblematic","format":"org.matrix.custom.html","formatted_body":"i don't think it's sufficient to just check if e.g. someone added a new property named <code>group</code> to <code>Array.prototype</code>, because we know unconditional assignment is unproblematic","msgtype":"m.text"},"ts":1683671009218,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$rKsKSZk0HTUkrMyzBfbq8WZro7UuTuuJEe5_znqJCbY"},
{"content":{"body":"so to add a more nuanced check that's a better measure of whether there's a problematic assignment to a particular `Array.prototype` name:\n\n1. i don't know how to write that use counter\n2. it's probably spread through enough parts of the code that adding that many branches is slow?","format":"org.matrix.custom.html","formatted_body":"<p>so to add a more nuanced check that's a better measure of whether there's a problematic assignment to a particular <code>Array.prototype</code> name:</p>\n<ol>\n<li>i don't know how to write that use counter</li>\n<li>it's probably spread through enough parts of the code that adding that many branches is slow?</li>\n</ol>\n","msgtype":"m.text"},"ts":1683671055807,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$tWTPyE0Ok2Q7CnXl0UNUiRTLr5S-P6N2xtc1TyAULAk"},
{"content":{"body":"we _could_ probably add a check just to see if someone added a new property named `group` to Array.prototype but i'd need to audit for all the places where we do that","format":"org.matrix.custom.html","formatted_body":"we <em>could</em> probably add a check just to see if someone added a new property named <code>group</code> to Array.prototype but i'd need to audit for all the places where we do that","msgtype":"m.text"},"ts":1683671125388,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$MheHfkgsKLDs8ql2nb0DoOM_kMj7b9v6HRqys8GZWGQ"},
{"content":{"body":"the actual problem with `group` was triggered by someone relying on the _absence_ of a property named `group` on array objects, IIRC","format":"org.matrix.custom.html","formatted_body":"the actual problem with <code>group</code> was triggered by someone relying on the <em>absence</em> of a property named <code>group</code> on array objects, IIRC","msgtype":"m.text"},"ts":1683671530529,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$c3kCAVSxwHGPOSFTwtXEBk2LzehQZf7qsEAOQYbDDOE"},
{"content":{"body":"so you'd need a use counter for lookup, not just assignment","msgtype":"m.text"},"ts":1683671546040,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$TN27Gn8Yu6et7pPabAGXthZSzAiX9XPMABobkR2B3e0"},
{"content":{"body":"right, that's what i obliquely referred to as \"lookup\"","msgtype":"m.text"},"ts":1683671550766,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$Qc8U95tDxUYgFaoaI6092xgzEEzqgChHKp0twSvSshg"},
{"content":{"body":"i can imagine a use counter \"through time\" like, if i looked up 'group' then assigned to 'group', then maybe we bump the counter","msgtype":"m.text"},"ts":1683671578189,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$Nny3ykq-xCyqK5GHSq8psXGjvSo0mefc85R9H20VTAU"},
{"content":{"body":"but there is just no way i can add a branch to every lookup","msgtype":"m.text"},"ts":1683671585959,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$XlcL9E0doZsrBS7k0aIQR3MaMl4BNa00GMHLzlhQZQ8"},
{"content":{"body":"> <@bakkot:matrix.org> the actual problem with `group` was triggered by someone relying on the _absence_ of a property named `group` on array objects, IIRC\n\nBut did they then still assign to it, or just test for its presence and that's it?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!WgJwmjBNZEXhJnXHXw:matrix.org/$c3kCAVSxwHGPOSFTwtXEBk2LzehQZf7qsEAOQYbDDOE?via=matrix.org&via=igalia.com&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@bakkot:matrix.org\">@bakkot:matrix.org</a><br>the actual problem with <code>group</code> was triggered by someone relying on the <em>absence</em> of a property named <code>group</code> on array objects, IIRC</blockquote></mx-reply>But did they then still assign to it, or just test for its presence and that's it?","m.relates_to":{"m.in_reply_to":{"event_id":"$c3kCAVSxwHGPOSFTwtXEBk2LzehQZf7qsEAOQYbDDOE"}},"msgtype":"m.text"},"ts":1683671644412,"senderName":"rbuckton","senderId":"@rbuckton:matrix.org","id":"$bHlydovyTX2OnqUiTP7odiOfFabF1gAvMIlqUNdhT_c"},
{"content":{"body":"just test for presence","msgtype":"m.text"},"ts":1683671651032,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$X-FHHAM7qBgaowtVVGoUSWhUOW0THeIz_W9L7f0jclo"},
{"content":{"body":"oh they didn't even assign to it?","msgtype":"m.text"},"ts":1683671662102,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$s8PK47v4YvzQWO5fl0ImH8ioPXH-a6lzfPozM9rIVi8"},
{"content":{"body":"they were using it as a type discriminant","msgtype":"m.text"},"ts":1683671662758,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$aSpu-Rn27ueVYlx22JhvoumUnlRNVp_ysFBFYpqCCPQ"},
{"content":{"body":"word","msgtype":"m.text"},"ts":1683671677739,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$UAvCFJseiSzI0bEBa9kjoK5qnh6y7uhOZDhXczCg4qA"},
{"content":{"body":"ain't nothing i can do ","msgtype":"m.text"},"ts":1683671679824,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$bW3bvg_VIDvMDp9fge5qumm1d1hA9D67Cn9kv-FS3nk"},
{"content":{"body":"https://github.com/webcompat/web-bugs/issues/112552#issuecomment-1291374679","msgtype":"m.text"},"ts":1683671768178,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$Yl2irBuzF4orPR_V_OdOFMHhfChCTtnl_Rg-W-VCS1A"},
{"content":{"body":"specifically that case ^","msgtype":"m.text"},"ts":1683671772372,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$_86Ch7zhcQquWhXVzu-UAVOy0buuUCHthqwHzq98YxY"},
{"content":{"body":"there were others","msgtype":"m.text"},"ts":1683671773742,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$XbRYpTjbB5c1LgUW-AmWZ2Tpi92bh28daAi1Ud09G6Q"},
{"content":{"body":"that is, there were other cases which were doing other more normal things, which a use counter might have been able to detect","msgtype":"m.text"},"ts":1683671798198,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$zZlnYCq1Y01XpjJhPdyrpIlmT3cm6lH0V-K1F9N3DlU"},
{"content":{"body":"but this specific one was doing the type discriminant thing","msgtype":"m.text"},"ts":1683671810081,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$2RhDc2zMitMzxDZW1w9bURCohp8ZrkSzlvKWdhNzDf0"},
{"content":{"body":"do you wonder what life would be like if you worked on a language that had just a little bit less baggage","msgtype":"m.text"},"ts":1683671917805,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$gYDOMuah-4oMUA91fV29IujTeX-ilM6qZj-xfQb4psg"},
{"content":{"body":"not a lot, maybe just like 10% less","msgtype":"m.text"},"ts":1683671922086,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$7kplvZ8Ggi5ZphCJ8b_B-_bFqt7wTcgrA63WE77Tl8I"},
{"content":{"body":"> <@shuyuguo:matrix.org> do you wonder what life would be like if you worked on a language that had just a little bit less baggage\n\nLike, one where the version can change but it doesn't break your code because your code is compiled and linked to a version-specific standard library?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!WgJwmjBNZEXhJnXHXw:matrix.org/$gYDOMuah-4oMUA91fV29IujTeX-ilM6qZj-xfQb4psg?via=matrix.org&via=igalia.com&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@shuyuguo:matrix.org\">@shuyuguo:matrix.org</a><br>do you wonder what life would be like if you worked on a language that had just a little bit less baggage</blockquote></mx-reply>Like, one where the version can change but it doesn't break your code because your code is compiled and linked to a version-specific standard library?","m.relates_to":{"m.in_reply_to":{"event_id":"$gYDOMuah-4oMUA91fV29IujTeX-ilM6qZj-xfQb4psg"}},"msgtype":"m.text"},"ts":1683671978227,"senderName":"rbuckton","senderId":"@rbuckton:matrix.org","id":"$Gw_Peu8vo1_TV7Ukg7j8dIta7bFMimYS5D9Mcd3il2k"},
{"content":{"body":"like chris lattner has it figured out man","msgtype":"m.text"},"ts":1683672158491,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$FHZNxnwyfmk74b9tJhC0CqwkMEHDS7JxdOb0OBaocD4"},
{"content":{"body":"occasionally I stare forlornly across the bay in the direction of rust","msgtype":"m.text"},"ts":1683672163341,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$_QZ2zCw6rsi5IpEvAFrxFYwyq7OC-Uu6CVE2T1GFZ_E"},
{"content":{"body":"make a language, go somewhere else, make another language","msgtype":"m.text"},"ts":1683672165474,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$548fkSalzDtdXpJNQKyLwidQnqdGcg-DiZWsN0QqEOo"},
{"content":{"body":"> <@bakkot:matrix.org> https://github.com/webcompat/web-bugs/issues/112552#issuecomment-1291374679\n\nWait, so the issue is the method must exist, but old code is relying on it being falsy. This kinda rings a bell. Haven't we solved this problem once before...?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!WgJwmjBNZEXhJnXHXw:matrix.org/$Yl2irBuzF4orPR_V_OdOFMHhfChCTtnl_Rg-W-VCS1A?via=matrix.org&via=igalia.com&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@bakkot:matrix.org\">@bakkot:matrix.org</a><br>https://github.com/webcompat/web-bugs/issues/112552#issuecomment-1291374679</blockquote></mx-reply>Wait, so the issue is the method must exist, but old code is relying on it being falsy. This kinda rings a bell. Haven't we solved this problem once before...?","m.relates_to":{"m.in_reply_to":{"event_id":"$Yl2irBuzF4orPR_V_OdOFMHhfChCTtnl_Rg-W-VCS1A"}},"msgtype":"m.text"},"ts":1683672295628,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$0p69_mYXINJzXYRep6uxBE05RL5C1ymxt12NxBA8u_Y"},
{"content":{"body":"whenever I suggest `document.all` as the solution to all our problems people start screaming in horror and also ominous chanting starts up and blood starts leaking from the walls","format":"org.matrix.custom.html","formatted_body":"whenever I suggest <code>document.all</code> as the solution to all our problems people start screaming in horror and also ominous chanting starts up and blood starts leaking from the walls","msgtype":"m.text"},"ts":1683672366326,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$gVqpeGbQ74tmi2LBX9WWQGbMl7xh6glb6xRzhAEtNCU"},
{"content":{"body":"so I've stopped suggesting it","msgtype":"m.text"},"ts":1683672370244,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$SrIm8Bmj45ocN--D2AflA5CFdcrks1ezuTBQ0i7lw70"},
{"content":{"body":"The chanting and blood leaks are a bug in our piping infrastructure, there's an issue open years ago","msgtype":"m.text"},"ts":1683672408519,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$VGQ4k_hQ2299vImyH_msfepFqfCPXM1F7R-majlmzgI"},
{"content":{"body":"we can simply extend the MOP to include `emulates: val`","format":"org.matrix.custom.html","formatted_body":"we can simply extend the MOP to include <code>emulates: val</code>","msgtype":"m.text"},"ts":1683672423545,"senderName":"shu","senderId":"@shuyuguo:matrix.org","id":"$9_FEk2lKfgNIxB-VVv4nKg-hj1jmJ9ntZq9jza88F78"}
]