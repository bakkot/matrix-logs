[
{"content":{"body":"in implementations that model weakmaps as hidden fields on the keys, how do they in practice clean those up when the weakmap is no longer reachable?","m.mentions":{},"msgtype":"m.text"},"ts":1725045024046,"senderName":"snek","senderId":"@devsnek:matrix.org","id":"$TVXrsS15cSGJ2STJS98ssa7vLeQOvzlXM1Gwb_W93Xw"},
{"content":{"body":"> <@devsnek:matrix.org> in implementations that model weakmaps as hidden fields on the keys, how do they in practice clean those up when the weakmap is no longer reachable?\n\nI believe chakra works or worked that way; you could check","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!wbACpffbfxANskIFZq:matrix.org/$TVXrsS15cSGJ2STJS98ssa7vLeQOvzlXM1Gwb_W93Xw?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@devsnek:matrix.org\">@devsnek:matrix.org</a><br>in implementations that model weakmaps as hidden fields on the keys, how do they in practice clean those up when the weakmap is no longer reachable?</blockquote></mx-reply>I believe chakra works or worked that way; you could check","m.mentions":{"user_ids":["@devsnek:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$TVXrsS15cSGJ2STJS98ssa7vLeQOvzlXM1Gwb_W93Xw"}},"msgtype":"m.text"},"ts":1725047305632,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$WFhpdq6_RtbeaX9H1SiOsWklq6jDuKSjhw235RmlCrc"},
{"content":{"body":"> <@devsnek:matrix.org> in implementations that model weakmaps as hidden fields on the keys, how do they in practice clean those up when the weakmap is no longer reachable?\n\nFrom what I can tell, XS has a pointer from the key field back to the weak collection, and from the weak collection entry back to the key field, so that removal of either can remove the other. More specifically when doing the mark and sweep, the first pass mark the field on the key, then it checks the weak collection content, and if it's no longer reachable, it removes all the keys fields corresponding to the collection's entries: https://github.com/Moddable-OpenSource/moddable/blob/24e3e54fd3b66379c1f91ad92969c99f941ff4cf/xs/sources/xsMemory.c#L1595-L1609","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!wbACpffbfxANskIFZq:matrix.org/$TVXrsS15cSGJ2STJS98ssa7vLeQOvzlXM1Gwb_W93Xw?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@devsnek:matrix.org\">@devsnek:matrix.org</a><br>in implementations that model weakmaps as hidden fields on the keys, how do they in practice clean those up when the weakmap is no longer reachable?</blockquote></mx-reply>From what I can tell, XS has a pointer from the key field back to the weak collection, and from the weak collection entry back to the key field, so that removal of either can remove the other. More specifically when doing the mark and sweep, the first pass mark the field on the key, then it checks the weak collection content, and if it's no longer reachable, it removes all the keys fields corresponding to the collection's entries: https://github.com/Moddable-OpenSource/moddable/blob/24e3e54fd3b66379c1f91ad92969c99f941ff4cf/xs/sources/xsMemory.c#L1595-L1609","m.mentions":{"user_ids":["@devsnek:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$TVXrsS15cSGJ2STJS98ssa7vLeQOvzlXM1Gwb_W93Xw"}},"msgtype":"m.text"},"ts":1725049386122,"senderName":"Mathieu Hofman","senderId":"@mhofman:matrix.org","id":"$L7VR1MfKre2A2ErgFgElv6ijPPPhBxErEDzlDrBobfk"}
]