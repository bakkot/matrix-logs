[
{"content":{"body":"I'm translating the Map/Set prototype methods over to WebIDL-ese (so we can define maplikes and setlikes in terms of Infra maps and sets, rather than doing weird and fraught indirections to actual ES Maps and Sets), and I noticed that while the @@iterator for them records the initial length and only iterates to that length at max (can stop earlier if things are deleted so it hits the end before that point), the `forEach` methods just visit every entry \"live\" and can potentially run forever if the callback keeps adding entries.","format":"org.matrix.custom.html","formatted_body":"I'm translating the Map/Set prototype methods over to WebIDL-ese (so we can define maplikes and setlikes in terms of Infra maps and sets, rather than doing weird and fraught indirections to actual ES Maps and Sets), and I noticed that while the @@iterator for them records the initial length and only iterates to that length at max (can stop earlier if things are deleted so it hits the end before that point), the <code>forEach</code> methods just visit every entry &quot;live&quot; and can potentially run forever if the callback keeps adding entries.","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"I'm translating the Map/Set prototype methods over to WebIDL-ese (so we can define maplikes and setlikes in terms of Infra maps and sets, rather than doing weird and fraught indirections to actual ES Maps and Sets), and I noticed that while the @@iterator for them records the initial length and only iterates to that length at max (can stop earlier if things are deleted so it hits the end before that point), the `forEach` methods just visit every entry \"live\" and can potentially run forever if the callback keeps adding entries.","mimetype":"text/plain"},{"body":"I'm translating the Map/Set prototype methods over to WebIDL-ese (so we can define maplikes and setlikes in terms of Infra maps and sets, rather than doing weird and fraught indirections to actual ES Maps and Sets), and I noticed that while the @@iterator for them records the initial length and only iterates to that length at max (can stop earlier if things are deleted so it hits the end before that point), the <code>forEach</code> methods just visit every entry &quot;live&quot; and can potentially run forever if the callback keeps adding entries.","mimetype":"text/html"}]},"ts":1651520233040,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$tFw2qeWPGFopflMQEVfdD4nK44p-_U3N544B3cjJG6Q"},
{"content":{"body":"Is this behavior difference intentional?","msgtype":"m.text","org.matrix.msc1767.text":"Is this behavior difference intentional?"},"ts":1651520241583,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$9w24S8gPvuUaySPii-TNQ8Nyosdp75rwJYrdTYi021M"},
{"content":{"body":"uh","msgtype":"m.text","org.matrix.msc1767.text":"uh"},"ts":1651520610619,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$jd4eMw2uxn5KdhpD7zjC7mc6DSYpUBzG1iiwK-2D71c"},
{"content":{"body":"that's probably a bug from when we refactored those","msgtype":"m.text","org.matrix.msc1767.text":"that's probably a bug from when we refactored those"},"ts":1651520615503,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$3yNFE1m-MBBQJR4_LD0cDvXGvNSTcCzFS4w2ZXoBi8U"},
{"content":{"body":" * that's probably a bug from when we refactored those","m.new_content":{"body":"that's probably a bug from when we refactored those","msgtype":"m.text","org.matrix.msc1767.text":"that's probably a bug from when we refactored those"},"m.relates_to":{"event_id":"$3yNFE1m-MBBQJR4_LD0cDvXGvNSTcCzFS4w2ZXoBi8U","rel_type":"m.replace"},"msgtype":"m.text","org.matrix.msc1767.text":" * that's probably a bug from when we refactored those"},"ts":1651520624682,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$miq7_gc2xjZwBGiAYgBoLFv7f121nvo4dLOpej3l5Tk"},
{"content":{"body":"oh, wait, no it's not","msgtype":"m.text","org.matrix.msc1767.text":"oh, wait, no it's not"},"ts":1651520641233,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$WcXkvpkeX2XtdJpaU32Lx52NuoyI1rktH_6JJdxXC24"},
{"content":{"body":"you missed a step:","msgtype":"m.text","org.matrix.msc1767.text":"you missed a step:"},"ts":1651520644055,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$6vR_BX2rTHawoQbkhlGAwa_qnHKUQ3k1NiZeuxIp9ho"},
{"content":{"body":"CreateMapIterator step 2.d.iii.6: Set numEntries to the number of elements of entries.","msgtype":"m.text","org.matrix.msc1767.text":"CreateMapIterator step 2.d.iii.6: Set numEntries to the number of elements of entries."},"ts":1651520661127,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$wcyldLBLeIH-hlq3EC5L8DJP3_jnA-ewZDgv-Q8CQ3w"},
{"content":{"body":"Right, I mentioned that.","msgtype":"m.text","org.matrix.msc1767.text":"Right, I mentioned that."},"ts":1651520676312,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$g75ZIghoYveioSHJK77AhAE7gosbfVgcOOEMyP6jncg"},
{"content":{"body":"no, that's in the loop","msgtype":"m.text","org.matrix.msc1767.text":"no, that's in the loop"},"ts":1651520690553,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$t8Hqo-IRmebNWr-NU4sOoi3grK70aojwQDlC1Hytm_g"},
{"content":{"body":"it updates numEntries within the loop","msgtype":"m.text","org.matrix.msc1767.text":"it updates numEntries within the loop"},"ts":1651520703292,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$CJDGxVtIS-ZkdWYPrrGCdCtTHjtP7uoYyAHme0eSWyA"},
{"content":{"body":"or I am not understanding your question","msgtype":"m.text","org.matrix.msc1767.text":"or I am not understanding your question"},"ts":1651520712743,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$NNYM0cADThPAq4hAhnU4IgqcJJ6wqINjbU53Qtfq51I"},
{"content":{"body":"Oh dang you're right, I *did* miss/misunderstand that.","format":"org.matrix.custom.html","formatted_body":"Oh dang you're right, I <em>did</em> miss/misunderstand that.","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"Oh dang you're right, I *did* miss/misunderstand that.","mimetype":"text/plain"},{"body":"Oh dang you're right, I <em>did</em> miss/misunderstand that.","mimetype":"text/html"}]},"ts":1651520753217,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$iN3bZswWDx7KnBdeDl6TembIgJA6nIzhNFUfXwy-xkg"},
{"content":{"body":"Hm then, the two methods can both run infinitely, ok. Is there a particular reason why the two have their iteration written significantly differently, or is that intended to just be an editorial detail? (Iterator goes over the entries by index and makes no mention of \"empty\" values; forEach iterates the entries list directly and explicitly jumps over \"empty\" values. (I note that \"empty\" is supposed to be a spec convenience for deleted entries and not an actual author-exposed thing.))","msgtype":"m.text","org.matrix.msc1767.text":"Hm then, the two methods can both run infinitely, ok. Is there a particular reason why the two have their iteration written significantly differently, or is that intended to just be an editorial detail? (Iterator goes over the entries by index and makes no mention of \"empty\" values; forEach iterates the entries list directly and explicitly jumps over \"empty\" values. (I note that \"empty\" is supposed to be a spec convenience for deleted entries and not an actual author-exposed thing.))"},"ts":1651520881968,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$ac5i9t2ueLFs1HHVkMf5m_z4kCMdmhvJR8d6TTGhFHc"},
{"content":{"body":"Iterator does handle empty values, it seems to me?\n> iii. If e.[[Key]] is not empty, then","format":"org.matrix.custom.html","formatted_body":"<p>Iterator does handle empty values, it seems to me?</p>\n<blockquote>\n<p>iii. If e.[[Key]] is not empty, then</p>\n</blockquote>\n","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"Iterator does handle empty values, it seems to me?\n> iii. If e.[[Key]] is not empty, then","mimetype":"text/plain"},{"body":"<p>Iterator does handle empty values, it seems to me?</p>\n<blockquote>\n<p>iii. If e.[[Key]] is not empty, then</p>\n</blockquote>\n","mimetype":"text/html"}]},"ts":1651521051374,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$USAftGn22ZhX4Bplmg1Op1Rt00MUo4Z4-nkYsP-tCNE"},
{"content":{"body":"They actually look pretty similar to me, all told","msgtype":"m.text","org.matrix.msc1767.text":"They actually look pretty similar to me, all told"},"ts":1651521062926,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$IPYjrOVYUs6k6WS5FpE-OavN5VtaQHDtKnsQQO4VhTA"},
{"content":{"body":"Sigh, I'm blind.","msgtype":"m.text","org.matrix.msc1767.text":"Sigh, I'm blind."},"ts":1651521085009,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$7NZ21id027-sozXRp282qskT9XA4W0oosp0Kpf_EGAQ"},
{"content":{"body":"Yeah, so it's just the explicit index-based vs just looping over the List directly, I guess","msgtype":"m.text","org.matrix.msc1767.text":"Yeah, so it's just the explicit index-based vs just looping over the List directly, I guess"},"ts":1651521110207,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$mCu5mEbaP8SRDabvp3whVOL_gXLAwxajF-RnGFCjdsA"},
{"content":{"body":"yeah, and that one... I think it's a path-dependence thing","msgtype":"m.text","org.matrix.msc1767.text":"yeah, and that one... I think it's a path-dependence thing"},"ts":1651521130389,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$xVv98vJp85vRDq18U9BETMM_eEg1lk-qsoE82LnKTq4"},
{"content":{"body":"in earlier editions iterators were specified in terms of explicitly keeping all of the state on internal slots, but in https://github.com/tc39/ecma262/pull/2045 we made it possible to specify a \"spec generator\" which is more similar to how you'd write it in JS","msgtype":"m.text","org.matrix.msc1767.text":"in earlier editions iterators were specified in terms of explicitly keeping all of the state on internal slots, but in https://github.com/tc39/ecma262/pull/2045 we made it possible to specify a \"spec generator\" which is more similar to how you'd write it in JS"},"ts":1651521202659,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$HiSq55LqUWuX4leVXP_G2mTwXLTIWPSVaNNfsuutdpk"},
{"content":{"body":"prior to that, the iterator _needed_ to be specified in terms of an index so it could store the index on an internal slot, as in https://tc39.es/ecma262/2016/#sec-%mapiteratorprototype%.next","format":"org.matrix.custom.html","formatted_body":"prior to that, the iterator <em>needed</em> to be specified in terms of an index so it could store the index on an internal slot, as in https://tc39.es/ecma262/2016/#sec-%mapiteratorprototype%.next","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"prior to that, the iterator _needed_ to be specified in terms of an index so it could store the index on an internal slot, as in https://tc39.es/ecma262/2016/#sec-%mapiteratorprototype%.next","mimetype":"text/plain"},{"body":"prior to that, the iterator <em>needed</em> to be specified in terms of an index so it could store the index on an internal slot, as in https://tc39.es/ecma262/2016/#sec-%mapiteratorprototype%.next","mimetype":"text/html"}]},"ts":1651521234921,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$yesY8hCXJLSQ2BZ-9_i6-WG8pXYYOHol3e3re7bN9rc"},
{"content":{"body":"with the refactoring that's no longer strictly necessary but the refactoring was written as a delta from what was originally there","msgtype":"m.text","org.matrix.msc1767.text":"with the refactoring that's no longer strictly necessary but the refactoring was written as a delta from what was originally there"},"ts":1651521249318,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$S77EAFOMgQaHEfKoVeyO6RMwY8OHD6orIBppn14OBng"},
{"content":{"body":"Ahhhhh, ok, thanks for the history, that makes sense.","msgtype":"m.text","org.matrix.msc1767.text":"Ahhhhh, ok, thanks for the history, that makes sense."},"ts":1651521275519,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$okA5hyUoz7EVKL7JfZ8gAZaiUgFv9efCf0EOgo0GXEM"},
{"content":{"body":"Okay, more questions in this regard: `Array`'s `forEach`_does_ compute the length once at the beginning and then doesn't go past it <https://tc39.es/ecma262/#sec-array.prototype.foreach>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","format":"org.matrix.custom.html","formatted_body":"Okay, more questions in this regard: <code>Array</code>'s <code>forEach</code><em>does</em> compute the length once at the beginning and then doesn't go past it <a href=\"https://tc39.es/ecma262/#sec-array.prototype.foreach\">https://tc39.es/ecma262/#sec-array.prototype.foreach</a>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"Okay, more questions in this regard: `Array`'s `forEach`_does_ compute the length once at the beginning and then doesn't go past it <https://tc39.es/ecma262/#sec-array.prototype.foreach>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","mimetype":"text/plain"},{"body":"Okay, more questions in this regard: <code>Array</code>'s <code>forEach</code><em>does</em> compute the length once at the beginning and then doesn't go past it <a href=\"https://tc39.es/ecma262/#sec-array.prototype.foreach\">https://tc39.es/ecma262/#sec-array.prototype.foreach</a>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","mimetype":"text/html"}]},"ts":1651522594426,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$Br0YQEfIykir832kV4J5XS7a5BYxlscBl7L0qnbpLYg"},
{"content":{"body":" * Okay, more questions in this regard: `Array`'s `forEach`_does_ compute the length once at the beginning and then doesn't go past it <https://tc39.es/ecma262/#sec-array.prototype.foreach>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","format":"org.matrix.custom.html","formatted_body":" * Okay, more questions in this regard: <code>Array</code>'s <code>forEach</code><em>does</em> compute the length once at the beginning and then doesn't go past it <a href=\"https://tc39.es/ecma262/#sec-array.prototype.foreach\">https://tc39.es/ecma262/#sec-array.prototype.foreach</a>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","m.new_content":{"body":"Okay, more questions in this regard: `Array`'s `forEach`_does_ compute the length once at the beginning and then doesn't go past it <https://tc39.es/ecma262/#sec-array.prototype.foreach>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","format":"org.matrix.custom.html","formatted_body":"Okay, more questions in this regard: <code>Array</code>'s <code>forEach</code><em>does</em> compute the length once at the beginning and then doesn't go past it <a href=\"https://tc39.es/ecma262/#sec-array.prototype.foreach\">https://tc39.es/ecma262/#sec-array.prototype.foreach</a>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"Okay, more questions in this regard: `Array`'s `forEach`_does_ compute the length once at the beginning and then doesn't go past it <https://tc39.es/ecma262/#sec-array.prototype.foreach>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","mimetype":"text/plain"},{"body":"Okay, more questions in this regard: <code>Array</code>'s <code>forEach</code><em>does</em> compute the length once at the beginning and then doesn't go past it <a href=\"https://tc39.es/ecma262/#sec-array.prototype.foreach\">https://tc39.es/ecma262/#sec-array.prototype.foreach</a>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","mimetype":"text/html"}]},"m.relates_to":{"event_id":"$Br0YQEfIykir832kV4J5XS7a5BYxlscBl7L0qnbpLYg","rel_type":"m.replace"},"msgtype":"m.text","org.matrix.msc1767.message":[{"body":" * Okay, more questions in this regard: `Array`'s `forEach`_does_ compute the length once at the beginning and then doesn't go past it <https://tc39.es/ecma262/#sec-array.prototype.foreach>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","mimetype":"text/plain"},{"body":" * Okay, more questions in this regard: <code>Array</code>'s <code>forEach</code><em>does</em> compute the length once at the beginning and then doesn't go past it <a href=\"https://tc39.es/ecma262/#sec-array.prototype.foreach\">https://tc39.es/ecma262/#sec-array.prototype.foreach</a>, so you can't infinite-loop yourself by pushing to the array in the callback. Is the behavior difference between arr.forEach and map.forEach intentional or accidental? (And which should we copy for general web-platform purposes when we define iteration better for Infra types in https://github.com/whatwg/infra/issues/396?)","mimetype":"text/html"}]},"ts":1651522616093,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$mwtKcpgFxokkvDoR670HTU59qB3zK8pP9odU77ZI160"},
{"content":{"body":"That one is before my time, so someone else will have to give the actual answer","msgtype":"m.text","org.matrix.msc1767.text":"That one is before my time, so someone else will have to give the actual answer"},"ts":1651522687875,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$a8u46a291gMihLYK8wJtXFVtBWh2HBKQYJYDUCAChh8"},
{"content":{"body":"but I do note that looking up the length of an array is observable, whereas looking up the length of a Map's internal list is not, so it's possible that's the reason for the difference?","msgtype":"m.text","org.matrix.msc1767.text":"but I do note that looking up the length of an array is observable, whereas looking up the length of a Map's internal list is not, so it's possible that's the reason for the difference?"},"ts":1651522716181,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$IsiB5ajulmPTeuFHv8Lr1TftJz6-E_hCDVmAFYkgJ_w"},
{"content":{"body":"Hm, but Array's @@iterator *does* allow infinite-loops, so I guess that might just be a legacy detail we got stuck with","format":"org.matrix.custom.html","formatted_body":"Hm, but Array's @@iterator <em>does</em> allow infinite-loops, so I guess that might just be a legacy detail we got stuck with","msgtype":"m.text","org.matrix.msc1767.message":[{"body":"Hm, but Array's @@iterator *does* allow infinite-loops, so I guess that might just be a legacy detail we got stuck with","mimetype":"text/plain"},{"body":"Hm, but Array's @@iterator <em>does</em> allow infinite-loops, so I guess that might just be a legacy detail we got stuck with","mimetype":"text/html"}]},"ts":1651522728985,"senderName":"TabAtkins","senderId":"@tabatkins:matrix.org","id":"$YHiiMiyEG9vkwjttH9qTVhVJceonugRV3J9BfiejGwI"},
{"content":{"body":"ah, yeah, in that case probably","msgtype":"m.text","org.matrix.msc1767.text":"ah, yeah, in that case probably"},"ts":1651522736869,"senderName":"bakkot","senderId":"@bakkot:matrix.org","id":"$-SdwzsJTprFctuHSjCpK05ZqtfyVRkKUJeFdLLUm0PM"}
]