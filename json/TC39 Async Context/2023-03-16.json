[
{"content":{"body":"Don't know about you, but I thought the idea was to implement task attribution *on top of* AsyncContext, rather than the other way around","format":"org.matrix.custom.html","formatted_body":"Don't know about you, but I thought the idea was to implement task attribution <em>on top of</em> AsyncContext, rather than the other way around","msgtype":"m.text"},"ts":1678962190825,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$RcJft9cwxtAnEFU_ZkZPrGXQYUT-PunhEVddH6pJDdo"},
{"content":{"body":"but implementing it on top of task attribution seems to be what Yoav is proposing","msgtype":"m.text"},"ts":1678962204752,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$l3DratKfYodw2my6zEbyY6vFra8eWzrdcsT2UPOvH5g"},
{"content":{"body":" * but implementing AsyncContext on top of task attribution seems to be what Yoav is proposing","m.new_content":{"body":"but implementing AsyncContext on top of task attribution seems to be what Yoav is proposing","msgtype":"m.text"},"m.relates_to":{"event_id":"$l3DratKfYodw2my6zEbyY6vFra8eWzrdcsT2UPOvH5g","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1678962218144,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$PUD2Viq07Vp-MKY3HpffyAYIAvgP-YftoHwZCRjC32s"},
{"content":{"body":"I wonder what the folks from server-side V8-based runtimes think about that","msgtype":"m.text"},"ts":1678962562276,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$w4tvyv107V5l7eUNdOjjpFZmAF1ya4C6Xzf4IAsuXJU"},
{"content":{"body":"so the way we handle things in workers... What we actually store using the v8 API is an embedder object wrapped in a js object. We call this embedder object an \"Async Context Frame\" (or frame for short). That frame maintains a mapping of `StorageKey` to JS Value. Every `AsyncLocalStorage` instance (equivalent to `AsyncContext`) represents one `StorageKey`. Whenever `als.run(...)` is called, we create a new frame as a clone of the current and set the new value associated with that key. \"Capturing\" the current context just means holding a reference to whatever frame is current ","format":"org.matrix.custom.html","formatted_body":"so the way we handle things in workers... What we actually store using the v8 API is an embedder object wrapped in a js object. We call this embedder object an &quot;Async Context Frame&quot; (or frame for short). That frame maintains a mapping of <code>StorageKey</code> to JS Value. Every <code>AsyncLocalStorage</code> instance (equivalent to <code>AsyncContext</code>) represents one <code>StorageKey</code>. Whenever <code>als.run(...)</code> is called, we create a new frame as a clone of the current and set the new value associated with that key. &quot;Capturing&quot; the current context just means holding a reference to whatever frame is current","msgtype":"m.text"},"ts":1678975697882,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$sK1XZqRwmL1HadXUOqw9CicQlLslNbjjhui7A1pGOzw"},
{"content":{"body":"What's nice about this design is that we can (and do) have `StorageKey` instances that are not associated with a specific `AsyncLocalStorage` instance","format":"org.matrix.custom.html","formatted_body":"What's nice about this design is that we can (and do) have <code>StorageKey</code> instances that are not associated with a specific <code>AsyncLocalStorage</code> instance","msgtype":"m.text"},"ts":1678975755060,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$oM338PBkErx3iAt89Tj10OtARpjTARB4XnPmNupsuqI"},
{"content":{"body":"the values actually stored are also ECMAScript language values","msgtype":"m.text"},"ts":1678975873516,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$spZIXLhj4DXN1Ftet0xlRXbRxuEddzFlWmaG_30AmLc"},
{"content":{"body":"but those could be externals (js objects wrapping embedder objects) ","msgtype":"m.text"},"ts":1678975896784,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$gRGD1E6T8J9jP--zLE7SDJTlbfv8_9U_gHQEZX0PfVo"},
{"content":{"body":"Hm, I guess if task attribution gets spec'd in the web platform, and it is used for the scheduler API, that would fall under WinterCG","msgtype":"m.text"},"ts":1678977594995,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$Mqnay5RzxWvFAbF4d8rtgfbDSBVs_CHS-nVmR68MelA"},
{"content":{"body":"and no matter how that gets implemented in V8, V8-based WinterCG runtimes could handle it the same way as Chromium","msgtype":"m.text"},"ts":1678977626752,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$qpNwmCHxeT6sZlngvUaDR4VX2bkm4-uZjUqh2YSYifc"},
{"content":{"body":"so it might not matter that the current async context snapshot is not managed by V8 itself","msgtype":"m.text"},"ts":1678977754686,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$_7CNxlVg92oE921k7kFVdq4bvw57EM_VnyxLOUXIVwg"},
{"content":{"body":"Andreu Botella: What is the difference? Is there some conversation happening somewhere that I'm missing?","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@abotella:igalia.com\">Andreu Botella</a>: What is the difference? Is there some conversation happening somewhere that I'm missing?","msgtype":"m.text"},"ts":1678977791286,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$BthoFV4mSTcDaTs7JqX4cdKnFNSxPL-TnW2SwMsoudE"},
{"content":{"body":"> <@littledan:matrix.org> Andreu Botella: What is the difference? Is there some conversation happening somewhere that I'm missing?\n\nhttps://docs.google.com/document/d/16HstQ6yHWMhFHflrpnKTeH0FDGxpQ8fKWqbA1mos3Ag/edit","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$BthoFV4mSTcDaTs7JqX4cdKnFNSxPL-TnW2SwMsoudE?via=matrix.org&via=igalia.com&via=mozilla.org\">In reply to</a> <a href=\"https://matrix.to/#/@littledan:matrix.org\">@littledan:matrix.org</a><br><a href=\"https://matrix.to/#/@abotella:igalia.com\">Andreu Botella</a>: What is the difference? Is there some conversation happening somewhere that I'm missing?</blockquote></mx-reply>https://docs.google.com/document/d/16HstQ6yHWMhFHflrpnKTeH0FDGxpQ8fKWqbA1mos3Ag/edit","m.relates_to":{"m.in_reply_to":{"event_id":"$BthoFV4mSTcDaTs7JqX4cdKnFNSxPL-TnW2SwMsoudE"}},"msgtype":"m.text"},"ts":1678977817295,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$cjLbefgOC-rERcC0OWYPt7XdWmmyUGhqrsEdw3kwPVc"},
{"content":{"body":"was this linked from somewhere?","msgtype":"m.text"},"ts":1678977858455,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$xo-FXEdUFfHKH-NQU91XOc20wmZoKDmH3DQKT4gwTvo"}
]