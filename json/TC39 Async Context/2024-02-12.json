[
{"content":{"body":"I've been thinking about this, and there's a lot of caveats to doing flattening on-demand.","m.mentions":{},"msgtype":"m.text"},"ts":1707712610218,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$U2kT6nFoFQkdIO4kjzARQ0LBikPjFBXp_mp8nimIZpg"},
{"content":{"body":"You can't really do it during `.get()` or `.run()`, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.","format":"org.matrix.custom.html","formatted_body":"You can't really do it during <code>.get()</code> or <code>.run()</code>, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.","m.mentions":{},"msgtype":"m.text"},"ts":1707712655781,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$LotRLkKC9eyGnXHeGXPQrpEOn2KSoj-8cDqaxPeHrgU"},
{"content":{"body":"And, worse, there's a **future** snapshot after the current `.get()` or `.run()` which could observe it.","format":"org.matrix.custom.html","formatted_body":"And, worse, there's a <strong>future</strong> snapshot after the current <code>.get()</code> or <code>.run()</code> which could observe it.","m.mentions":{},"msgtype":"m.text"},"ts":1707712700643,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$amvCwmZv3SQEd2RWlKKYwhY0fpt2OEch-2lMAlDn88E"},
{"content":{"body":"The only time you can flatten is when there is no active context","m.mentions":{},"msgtype":"m.text"},"ts":1707712724214,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$BPtLPHXU2dxztORnZeLPFD4-fR-LCWh6FTBpNwenv2Q"},
{"content":{"body":" * The only time you can flatten is when there is no active context, eg, as part of GC passes","m.mentions":{},"m.new_content":{"body":"The only time you can flatten is when there is no active context, eg, as part of GC passes","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$BPtLPHXU2dxztORnZeLPFD4-fR-LCWh6FTBpNwenv2Q","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1707712737502,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$BgMS-FZYcE-euutG4Y1e3u7olB2VtxGkxTFYLKmlpcM"},
{"content":{"body":"It shouldn't be too much to implement: https://gist.github.com/jridgewell/ef8a674291f8f7419a2bea0448c3b0eb","m.mentions":{},"msgtype":"m.text"},"ts":1707714896431,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$4ExgKeR-KyDk_Fp2Vw1xg6v-1iAAk_5qfxvXhjqZrms"},
{"content":{"body":"> <@jridgewell:matrix.org> You can't really do it during `.get()` or `.run()`, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.\n\nI think that's only the case on your implementation that mutates in-place. Purely persistent implementations don't have that issue","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$LotRLkKC9eyGnXHeGXPQrpEOn2KSoj-8cDqaxPeHrgU?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>You can't really do it during <code>.get()</code> or <code>.run()</code>, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.</blockquote></mx-reply>I think that's only the case on your implementation that mutates in-place. Purely persistent implementations don't have that issue","m.mentions":{"user_ids":["@jridgewell:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$LotRLkKC9eyGnXHeGXPQrpEOn2KSoj-8cDqaxPeHrgU"}},"msgtype":"m.text"},"ts":1707719013928,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$BChsq_lpPMKfdxwxbX8iO-1Qv5FnWs1fNB0yu1EcJiI"},
{"content":{"body":"That would only solve already existing chains, it wouldnâ€™t solve future snapshots of the current chain","msgtype":"m.text"},"ts":1707719247759,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$L2kxZDger9vjr1mF9tfAU5VRBV80YFTijwQ3vgtcH7g"},
{"content":{"body":"At least during an active run, you could (but why) do it during get inside an empty chain","msgtype":"m.text"},"ts":1707719306888,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$vRWevWxpAjaeH_KY2-GFT5xuuPomgjjlqrlx1ICGaak"},
{"content":{"body":"Or you push it into snapshot restore, which it the most performance critical","msgtype":"m.text"},"ts":1707719341673,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$Tjoaanwbw7Xjcnel8nLpll6KoybNOb5DtA2Gdrs7X-I"}
]