[
{"content":{"body":"I've been thinking about this, and there's a lot of caveats to doing flattening on-demand.","m.mentions":{},"msgtype":"m.text"},"ts":1707712610218,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$U2kT6nFoFQkdIO4kjzARQ0LBikPjFBXp_mp8nimIZpg"},
{"content":{"body":"You can't really do it during `.get()` or `.run()`, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.","format":"org.matrix.custom.html","formatted_body":"You can't really do it during <code>.get()</code> or <code>.run()</code>, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.","m.mentions":{},"msgtype":"m.text"},"ts":1707712655781,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$LotRLkKC9eyGnXHeGXPQrpEOn2KSoj-8cDqaxPeHrgU"},
{"content":{"body":"And, worse, there's a **future** snapshot after the current `.get()` or `.run()` which could observe it.","format":"org.matrix.custom.html","formatted_body":"And, worse, there's a <strong>future</strong> snapshot after the current <code>.get()</code> or <code>.run()</code> which could observe it.","m.mentions":{},"msgtype":"m.text"},"ts":1707712700643,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$amvCwmZv3SQEd2RWlKKYwhY0fpt2OEch-2lMAlDn88E"},
{"content":{"body":"The only time you can flatten is when there is no active context","m.mentions":{},"msgtype":"m.text"},"ts":1707712724214,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$BPtLPHXU2dxztORnZeLPFD4-fR-LCWh6FTBpNwenv2Q"},
{"content":{"body":" * The only time you can flatten is when there is no active context, eg, as part of GC passes","m.mentions":{},"m.new_content":{"body":"The only time you can flatten is when there is no active context, eg, as part of GC passes","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$BPtLPHXU2dxztORnZeLPFD4-fR-LCWh6FTBpNwenv2Q","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1707712737502,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$BgMS-FZYcE-euutG4Y1e3u7olB2VtxGkxTFYLKmlpcM"},
{"content":{"body":"It shouldn't be too much to implement: https://gist.github.com/jridgewell/ef8a674291f8f7419a2bea0448c3b0eb","m.mentions":{},"msgtype":"m.text"},"ts":1707714896431,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$4ExgKeR-KyDk_Fp2Vw1xg6v-1iAAk_5qfxvXhjqZrms"},
{"content":{"body":"> <@jridgewell:matrix.org> You can't really do it during `.get()` or `.run()`, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.\n\nI think that's only the case on your implementation that mutates in-place. Purely persistent implementations don't have that issue","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$LotRLkKC9eyGnXHeGXPQrpEOn2KSoj-8cDqaxPeHrgU?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>You can't really do it during <code>.get()</code> or <code>.run()</code>, because there's a possibility that a snapshot has already been taken of the context that can still observe the shadowed Var value.</blockquote></mx-reply>I think that's only the case on your implementation that mutates in-place. Purely persistent implementations don't have that issue","m.mentions":{"user_ids":["@jridgewell:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$LotRLkKC9eyGnXHeGXPQrpEOn2KSoj-8cDqaxPeHrgU"}},"msgtype":"m.text"},"ts":1707719013928,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$BChsq_lpPMKfdxwxbX8iO-1Qv5FnWs1fNB0yu1EcJiI"},
{"content":{"body":"That would only solve already existing chains, it wouldn’t solve future snapshots of the current chain","msgtype":"m.text"},"ts":1707719247759,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$L2kxZDger9vjr1mF9tfAU5VRBV80YFTijwQ3vgtcH7g"},
{"content":{"body":"At least during an active run, you could (but why) do it during get inside an empty chain","msgtype":"m.text"},"ts":1707719306888,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$vRWevWxpAjaeH_KY2-GFT5xuuPomgjjlqrlx1ICGaak"},
{"content":{"body":"Or you push it into snapshot restore, which it the most performance critical","msgtype":"m.text"},"ts":1707719341673,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$Tjoaanwbw7Xjcnel8nLpll6KoybNOb5DtA2Gdrs7X-I"},
{"content":{"body":"I'm having trouble conceptualizing this, but I haven't had my coffee yet","m.mentions":{},"msgtype":"m.text"},"ts":1707720124780,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$g8l2fjn37K0prVLhzZU5mh4Q4GoFwQmOsLy7cyNjxcY"},
{"content":{"body":"the way I was thinking of it was that, you could just replace the current snapshot from a linked list to a map, without mutating anything else","m.mentions":{},"msgtype":"m.text"},"ts":1707720192008,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$XwwkDmCeHDeLwDpBB_0epkhTxKTHU8t61wirKiDSIkQ"},
{"content":{"body":"you could even mutate the current entry in the linked list by making it store a map and make its `next` pointer be null","format":"org.matrix.custom.html","formatted_body":"you could even mutate the current entry in the linked list by making it store a map and make its <code>next</code> pointer be null","m.mentions":{},"msgtype":"m.text"},"ts":1707720235956,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$AXoxzVea02dv7-2h2KlxkrOhF105Ntiejuwl84iPjic"},
{"content":{"body":"if you imagine a linked list representation of a map, where each entry in the list is an update on the map represented by the rest of the linked list, flattening an entry into a map would not change the semantics, for that entry as the snapshot, or for anything that has that entry as part of the list","m.mentions":{},"msgtype":"m.text"},"ts":1707720369202,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$_7i4zWZRU9GK2Fch_QgGY02zw-iiFlAkqzeHuzzJIG4"},
{"content":{"body":"now, flattening on get is probably not a good idea because of the performance considerations – even amortized, there is an implementation of flattening on run that has the same asymptotic runtime on get","m.mentions":{},"msgtype":"m.text"},"ts":1707720466064,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$FP7rm7278dc-yXdaiXthRkLl7aBveY437k_0ZW8xoDE"},
{"content":{"body":" * now, flattening on get is probably not a good idea because of the performance considerations – even amortized, there is an implementation of flattening on run that has the same asymptotic runtime on get, if not better","m.mentions":{},"m.new_content":{"body":"now, flattening on get is probably not a good idea because of the performance considerations – even amortized, there is an implementation of flattening on run that has the same asymptotic runtime on get, if not better","m.mentions":{},"msgtype":"m.text"},"m.relates_to":{"event_id":"$FP7rm7278dc-yXdaiXthRkLl7aBveY437k_0ZW8xoDE","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1707720515731,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$Aq_kDZtC9tlEZTk1EMGH-aNTLMVIxF6fXVX47KsTurY"},
{"content":{"body":"I'm working on a doc comparing various possible implementations","m.mentions":{},"msgtype":"m.text"},"ts":1707720565346,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$gLSttyigJ6sE56N_RoRBcm-lFwV4taPL9jp-PG3eo0g"},
{"content":{"body":"My concern is with:\n```\na.run(1, () => {\n  b.run('b', () => {\n    a.run(2, () => {\n      // flatten here\n      a.get();\n    })\n\n    // Still observe 1 here\n    a.get();\n  })\n});\n```","format":"org.matrix.custom.html","formatted_body":"<p>My concern is with:</p>\n<pre><code>a.run(1, () =&gt; {\n  b.run('b', () =&gt; {\n    a.run(2, () =&gt; {\n      // flatten here\n      a.get();\n    })\n\n    // Still observe 1 here\n    a.get();\n  })\n});\n</code></pre>\n","m.mentions":{},"msgtype":"m.text"},"ts":1707721096425,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$aa4lMdP6-jxBuPDV09qiLfwUfghP5dzfyn1P95p8H4E"},
{"content":{"body":"If we flatten inside the `a.run(2, …)`, we can still observe the `1` value afterwards","format":"org.matrix.custom.html","formatted_body":"If we flatten inside the <code>a.run(2, …)</code>, we can still observe the <code>1</code> value afterwards","m.mentions":{},"msgtype":"m.text"},"ts":1707721137292,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$fPN6SEzt1HIK6MFK8y6WwT-pO05PC43o0lNMgLGFMZI"}
]