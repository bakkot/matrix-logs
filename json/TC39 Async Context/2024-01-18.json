[
{"content":{"body":"I wonder if it makes sense to add a method to the C++ embedder API for `AsyncContext.Snapshot` to tell whether two objects represent the same underlying map","format":"org.matrix.custom.html","formatted_body":"I wonder if it makes sense to add a method to the C++ embedder API for <code>AsyncContext.Snapshot</code> to tell whether two objects represent the same underlying map","msgtype":"m.text"},"ts":1705581215036,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$yMOCo6vM1seUfkhj0f5xsW2JA0WKWLAtTpXMb-6S3-Q"},
{"content":{"body":"also to create an `AsyncContext.Snapshot` with an empty map (well, with the map being `undefined` in my V8 implementation)","format":"org.matrix.custom.html","formatted_body":"also to create an <code>AsyncContext.Snapshot</code> with an empty map (well, with the map being <code>undefined</code> in my V8 implementation)","msgtype":"m.text"},"ts":1705581644155,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$07EHLhcRsOku4MxlCLEbDzuQQHCqAU_2krXw-QhbJt0"},
{"content":{"body":"Do you have use cases for those in mind?","msgtype":"m.text"},"ts":1705583155485,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$F6MNmovER6jeFWJjsjhF8ZRt5N0zhJXaOXFTeBJg3xg"},
{"content":{"body":"For the latter, I really don’t want to expose that to JS, and I wonder why it would ever be valid to do ","format":"org.matrix.custom.html","formatted_body":"For the latter, I really don’t want to expose that to JS, and I wonder why it would ever be valid to do","msgtype":"m.text"},"ts":1705583181053,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$LQPRkLIU2V3eiGY34dv986JnqmCc5We6JMruQ-ekfCE"},
{"content":{"body":"not to JS, to embedders","msgtype":"m.text"},"ts":1705583848973,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$WqxnnFi0lmXDfSZVb1tTb2xg_OiPo7bKou3bXrdiGwc"},
{"content":{"body":"because of reasons involving the architecture of Blink, task attribution is using a `std::unique_ptr<Scope>` as an RAII scope for the equivalent of `snapshot.run()`","format":"org.matrix.custom.html","formatted_body":"because of reasons involving the architecture of Blink, task attribution is using a <code>std::unique_ptr&lt;Scope&gt;</code> as an RAII scope for the equivalent of <code>snapshot.run()</code>","msgtype":"m.text"},"ts":1705584687120,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$ac4MNgq9QUlGB6YV3fhl_XOAs2qPsvfbwutsQI0MAJ0"},
{"content":{"body":"it has to be an allocation because users of this scope can't depend on the actual C++ files calling into V8, so `Scope` there has to be an abstract class that is implemented elsewhere","format":"org.matrix.custom.html","formatted_body":"it has to be an allocation because users of this scope can't depend on the actual C++ files calling into V8, so <code>Scope</code> there has to be an abstract class that is implemented elsewhere","msgtype":"m.text"},"ts":1705584787221,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$wJY2Nmgy_JUnnjHEPL8yhmd84-Srw4DqvbdiLVcd-xc"},
{"content":{"body":"you can save the allocation if you can be sure that the snapshot you'd be running is the same as the current one, and if there's nothing new to set task allocation-wise that wasn't there before","msgtype":"m.text"},"ts":1705584827715,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$IAQKAvTeSlCf-m9-JUQDbu5RO1EAyxt_ROt8wnNM3V8"},
{"content":{"body":"by returning a null `unique_ptr`","format":"org.matrix.custom.html","formatted_body":"by returning a null <code>unique_ptr</code>","msgtype":"m.text"},"ts":1705584861423,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$QWT-x7kuLr0FkAUER-n1ess3BHthB3ihI46I-QtVnTo"},
{"content":{"body":"the snapshot with an empty map, I just realized I don't actually need it for Blink","msgtype":"m.text"},"ts":1705584990963,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$d77W5clQ7qu6VtmZmD1sdrGSUwUmRTRr-cq8AtS8u-w"},
{"content":{"body":" * the snapshot with an empty map, I just realized I don't actually need it in Blink","m.new_content":{"body":"the snapshot with an empty map, I just realized I don't actually need it in Blink","msgtype":"m.text"},"m.relates_to":{"event_id":"$d77W5clQ7qu6VtmZmD1sdrGSUwUmRTRr-cq8AtS8u-w","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1705584998500,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$jo67d-i7wvOPY8Cia7JDr1l5-cDuJPg9Hp26EDhiCDY"},
{"content":{"body":"> <@abotella:igalia.com> the snapshot with an empty map, I just realized I don't actually need it in Blink\n\nRight, I was thinking, I couldn't think of any reason why a web spec or other embedder would ever validly want to get an empty snapshot. Anyway if we don't have a use case in mind yet, then that problem can be stashed for later.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$d77W5clQ7qu6VtmZmD1sdrGSUwUmRTRr-cq8AtS8u-w?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@abotella:igalia.com\">@abotella:igalia.com</a><br>the snapshot with an empty map, I just realized I don&#39;t actually need it in Blink</blockquote></mx-reply>Right, I was thinking, I couldn't think of any reason why a web spec or other embedder would ever validly want to get an empty snapshot. Anyway if we don't have a use case in mind yet, then that problem can be stashed for later.","m.mentions":{"user_ids":["@abotella:igalia.com"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$d77W5clQ7qu6VtmZmD1sdrGSUwUmRTRr-cq8AtS8u-w"}},"msgtype":"m.text"},"ts":1705611691604,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$tSHxVgQYcSlJNWDS2LBIMrqHjWCGSfSC9GaqYqvTPRI"},
{"content":{"body":"> <@abotella:igalia.com> because of reasons involving the architecture of Blink, task attribution is using a `std::unique_ptr<Scope>` as an RAII scope for the equivalent of `snapshot.run()`\n\nYeah, we were going to make the API look like that too, weren't we?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$ac4MNgq9QUlGB6YV3fhl_XOAs2qPsvfbwutsQI0MAJ0?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@abotella:igalia.com\">@abotella:igalia.com</a><br>because of reasons involving the architecture of Blink, task attribution is using a <code>std::unique_ptr&lt;Scope&gt;</code> as an RAII scope for the equivalent of <code>snapshot.run()</code></blockquote></mx-reply>Yeah, we were going to make the API look like that too, weren't we?","m.mentions":{"user_ids":["@abotella:igalia.com"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$ac4MNgq9QUlGB6YV3fhl_XOAs2qPsvfbwutsQI0MAJ0"}},"msgtype":"m.text"},"ts":1705611785606,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$O1f5jKFWZHiaIw4meZ4ugypnlYzQNG__nA3v0yQAYQA"},
{"content":{"body":"> <@abotella:igalia.com> you can save the allocation if you can be sure that the snapshot you'd be running is the same as the current one, and if there's nothing new to set task allocation-wise that wasn't there before\n\nHow could we do this RAII pattern only conditionally? Anyway couldn't this optimization be contained within the implementation of .run/the RAII equivalent?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$IAQKAvTeSlCf-m9-JUQDbu5RO1EAyxt_ROt8wnNM3V8?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@abotella:igalia.com\">@abotella:igalia.com</a><br>you can save the allocation if you can be sure that the snapshot you&#39;d be running is the same as the current one, and if there&#39;s nothing new to set task allocation-wise that wasn&#39;t there before</blockquote></mx-reply>How could we do this RAII pattern only conditionally? Anyway couldn't this optimization be contained within the implementation of .run/the RAII equivalent?","m.mentions":{"user_ids":["@abotella:igalia.com"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$IAQKAvTeSlCf-m9-JUQDbu5RO1EAyxt_ROt8wnNM3V8"}},"msgtype":"m.text"},"ts":1705611834970,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$vBoHLVhcYpab45oICOxVpYKHIr8wQc0ppx5bolVWjGM"},
{"content":{"body":"I take it you're not talking about an RAII pattern in JS, correct? I saw RAII and immediately thought of `using` declarations. If that's unrelated, feel free to disregard this.","format":"org.matrix.custom.html","formatted_body":"I take it you're not talking about an RAII pattern in JS, correct? I saw RAII and immediately thought of <code>using</code> declarations. If that's unrelated, feel free to disregard this.","m.mentions":{},"msgtype":"m.text"},"ts":1705612473232,"senderName":"rbuckton","senderId":"@rbuckton:matrix.org","id":"$PvD3NGhrXm7xIjcIPm7pLDj3Lah7P4VHI4_pkyeHNt4"},
{"content":{"body":"> <@littledan:matrix.org> Yeah, we were going to make the API look like that too, weren't we?\n\nNot with a `std::unique_ptr`. You could do the same with the embedder APIs we have by wrapping them in `std::optional`, but you're still using that memory. With `unique_ptr` you can save the allocation if not needed.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$O1f5jKFWZHiaIw4meZ4ugypnlYzQNG__nA3v0yQAYQA?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@littledan:matrix.org\">@littledan:matrix.org</a><br>Yeah, we were going to make the API look like that too, weren't we?</blockquote></mx-reply>Not with a <code>std::unique_ptr</code>. You could do the same with the embedder APIs we have by wrapping them in <code>std::optional</code>, but you're still using that memory. With <code>unique_ptr</code> you can save the allocation if not needed.","m.relates_to":{"m.in_reply_to":{"event_id":"$O1f5jKFWZHiaIw4meZ4ugypnlYzQNG__nA3v0yQAYQA"}},"msgtype":"m.text"},"ts":1705613286841,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$48yD0AfB-lMj0ogced_zR2-n4lP7sCFG_lpsyuebAUI"},
{"content":{"body":"> <@littledan:matrix.org> How could we do this RAII pattern only conditionally? Anyway couldn't this optimization be contained within the implementation of .run/the RAII equivalent?\n\nTask attribution uses a combined snapshot and variable `run`, and it would only save on the allocation if both are unnecessary. The embedder API could also do that, if it has a combined RAII scope for snapshot and variable `run`. Not otherwise.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$vBoHLVhcYpab45oICOxVpYKHIr8wQc0ppx5bolVWjGM?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@littledan:matrix.org\">@littledan:matrix.org</a><br>How could we do this RAII pattern only conditionally? Anyway couldn't this optimization be contained within the implementation of .run/the RAII equivalent?</blockquote></mx-reply>Task attribution uses a combined snapshot and variable <code>run</code>, and it would only save on the allocation if both are unnecessary. The embedder API could also do that, if it has a combined RAII scope for snapshot and variable <code>run</code>. Not otherwise.","m.relates_to":{"m.in_reply_to":{"event_id":"$vBoHLVhcYpab45oICOxVpYKHIr8wQc0ppx5bolVWjGM"}},"msgtype":"m.text"},"ts":1705613366324,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$vvC9AjyzEuoNLG6rmqoEKAbO9IT2hIv6DUIRKLEjnOI"},
{"content":{"body":"> <@rbuckton:matrix.org> I take it you're not talking about an RAII pattern in JS, correct? I saw RAII and immediately thought of `using` declarations. If that's unrelated, feel free to disregard this.\n\nCorrect, just C++","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$PvD3NGhrXm7xIjcIPm7pLDj3Lah7P4VHI4_pkyeHNt4?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@rbuckton:matrix.org\">@rbuckton:matrix.org</a><br>I take it you're not talking about an RAII pattern in JS, correct? I saw RAII and immediately thought of <code>using</code> declarations. If that's unrelated, feel free to disregard this.</blockquote></mx-reply>Correct, just C++","m.mentions":{"user_ids":["@rbuckton:matrix.org"]},"m.relates_to":{"m.in_reply_to":{"event_id":"$PvD3NGhrXm7xIjcIPm7pLDj3Lah7P4VHI4_pkyeHNt4"}},"msgtype":"m.text"},"ts":1705613979509,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$gxq3gQl7W8qDxlC8TRQGYEIBdYTTE8nSeJC4XLSOaaA"},
{"content":{"body":"I'm really confused, why not just unconditionally stack-allocate this memory?","m.mentions":{},"msgtype":"m.text"},"ts":1705614062112,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$-9ORMdFOS2NNRUEEdk2Y-PjUlhNQqYo39JHJhOm5-x0"},
{"content":{"body":"it's not very much, is it?","m.mentions":{},"msgtype":"m.text"},"ts":1705614067199,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$eV-Q3l8zD1AQzpOYmSd9RmjHX5Kls3FS3VlknTEL-nE"},
{"content":{"body":"it's just to remember to restore to the previous snapshot (if there was a change)","m.mentions":{},"msgtype":"m.text"},"ts":1705614090611,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$N9MXp3BqsOSt6Wj_DeiBOkyGb6Fvv20Voe_uOrmELho"},
{"content":{"body":"I'm having to explain implementation decisions about task attribution that don't make sense outside of Blink (not even V8)","msgtype":"m.text"},"ts":1705615143832,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$XcPwEOizleaJ9WGRERaB-Z_GQL_I20Fy2KW8YUETBu0"},
{"content":{"body":"it's because of the way Blink prevents dependencies between different parts of the code, so the task attribution scope as exposed by the task attribution API must be an abstract class, with a subclass elsewhere in the code that can depend on the relevant things","msgtype":"m.text"},"ts":1705615250451,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$-M3ARsino7PWY_pz7DSfaV9LQOHHyxELBFQ00nSEThw"},
{"content":{"body":"I'm not sure it's even worth it though","msgtype":"m.text"},"ts":1705615396190,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$x3RkEKYs9uQ7-8iwVwcmkSccT90-MzM4lCpFaeTQiL8"},
{"content":{"body":" * I'm not sure it's even worth skipping that allocation though","m.new_content":{"body":"I'm not sure it's even worth skipping that allocation though","msgtype":"m.text"},"m.relates_to":{"event_id":"$x3RkEKYs9uQ7-8iwVwcmkSccT90-MzM4lCpFaeTQiL8","rel_type":"m.replace"},"msgtype":"m.text"},"ts":1705615408628,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$nVnYhtLBwNcAl71Z_x9W8eCNOlyYaLi5NlwygPIa3NQ"},
{"content":{"body":"oh, the linking structure prevents you from stack-allocating it? OK","m.mentions":{},"msgtype":"m.text"},"ts":1705615433935,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$AwhUumMPhc2sgEgNx6xlC9mBy5DDql8Bn6E9Ya9q2lI"}
]