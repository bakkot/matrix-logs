[
{"content":{"body":"> <@littledan:matrix.org> we have to have this conversation with Steven and Signals people about Computed's context -- there's a concern that call-time context there would constitute \"Zalgo\": a computed signal could be forced in many different ways, and it should be giving the same answer regardless of context (of course we need some debugging/perf analysis tools to be possible)\n\nI agree that there's definite problems with computed signals - it's possible that two setters feed into the same computed signal and could have been set in different contexts, plus the fact that they're computed lazily might point to the reader's context as the correct call-time context (i.e. coming from the other direction). So there's potentially three or more different options and not necessarily a good way to disambiguate all of them.\n\nThat said, if there's no way to access the context(s) that set the signal(s) that caused the recompute, then tracing in many UI frameworks is essentially sunk. In my experience, it's a _very_ common pattern to have an event handler do nothing but update a signal. If the tracing framework initiates a trace in the event handler then the trace would simply die then and there, whereas we'd like to be able to link that trace to any downstream reactions/effects, all the way to the re-render.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!eQuZUAhGqudVFPodUG:matrix.org/$rorB792EDNX34EdSfB9td7vBuxOAeqgNiPuJLANCVPg?via=matrix.org&via=mozilla.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@littledan:matrix.org\">@littledan:matrix.org</a><br />we have to have this conversation with Steven and Signals people about Computed's context -- there's a concern that call-time context there would constitute &quot;Zalgo&quot;: a computed signal could be forced in many different ways, and it should be giving the same answer regardless of context (of course we need some debugging/perf analysis tools to be possible)</blockquote></mx-reply><p>I agree that there's definite problems with computed signals - it's possible that two setters feed into the same computed signal and could have been set in different contexts, plus the fact that they're computed lazily might point to the reader's context as the correct call-time context (i.e. coming from the other direction). So there's potentially three or more different options and not necessarily a good way to disambiguate all of them.</p>\n<p>That said, if there's no way to access the context(s) that set the signal(s) that caused the recompute, then tracing in many UI frameworks is essentially sunk. In my experience, it's a <em>very</em> common pattern to have an event handler do nothing but update a signal. If the tracing framework initiates a trace in the event handler then the trace would simply die then and there, whereas we'd like to be able to link that trace to any downstream reactions/effects, all the way to the re-render.</p>","m.relates_to":{"m.in_reply_to":{"event_id":"$rorB792EDNX34EdSfB9td7vBuxOAeqgNiPuJLANCVPg"}},"msgtype":"m.text"},"ts":1712893000862,"senderName":"Steve Hicks","senderId":"@stephenhicks:matrix.org","id":"$23-3PdqSmo1N_BD8c1PZwPS1aES-blPqladV_bfziFQ"},
{"content":{"body":"I see... so in this case, it's like application state should be registration-based, but tracing state should be call-based... :(","m.mentions":{},"msgtype":"m.text"},"ts":1712927930479,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$kE5oQXK-3M9cbgsWqIfRihrtCU41AVsnyMoxLQd_9AY"},
{"content":{"body":"What's an example of application state that you'd want to be registration-based? My general (but somewhat uninformed) rule-of-thumb is that if a callback is intended to be called multiple times, it's more likely to want call-time context.","msgtype":"m.text"},"ts":1712930842429,"senderName":"Steve Hicks","senderId":"@stephenhicks:matrix.org","id":"$BgDZfxiY_v4YXlVU2UZYZpMNiUkSbJ8XI6PW-y_pmP0"},
{"content":{"body":"an example is if we wanted to use AsyncContext for tracking the owner in tree-based rendering, or generally, React Context-style information","m.mentions":{},"msgtype":"m.text"},"ts":1712931085433,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$cMdE81CQo6ATf2f1izMg747v2V26_ntTRuI3mWGPWi0"},
{"content":{"body":"we could use AsyncContext.Snapshot.wrap for these cases but then it'd defeat tracing, sounds like...","m.mentions":{},"msgtype":"m.text"},"ts":1712931107156,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$XiKT3nwRc12DJ1dFMQEbI4HJiuLe2YPdFg41pqTlJ1w"},
{"content":{"body":"also for the style of React Hooks using global variables under the hood","m.mentions":{},"msgtype":"m.text"},"ts":1712931150073,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$ioTpyO6FdM_-BDFy3BYIkG4_Vm9T4Tl7oIIz_3Z-n84"},
{"content":{"body":"restoring the context after await is an example of registration-time behavior I think","m.mentions":{},"msgtype":"m.text"},"ts":1712931197483,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$FzPcfpAMdePaRzt_lwn7CcpEcA028ecnhtFFEsFFCOs"},
{"content":{"body":"(especially obvious if you consider what explicit calls of .then() should do)","m.mentions":{},"msgtype":"m.text"},"ts":1712931214319,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$V6P2rvliLM9uOjCkcPt4C1MX1KuMYA1ltZ1wmYCj5HA"},
{"content":{"body":"That's a good point about `await`.  I brought it up in the context of async generators in https://github.com/tc39/proposal-async-context/pull/77#issuecomment-2048897179 - I think my general expectation is that context needs to be _preserved_ across an `await`, rather than _restored_ to some particular snapshot.","format":"org.matrix.custom.html","formatted_body":"That's a good point about <code>await</code>.  I brought it up in the context of async generators in https://github.com/tc39/proposal-async-context/pull/77#issuecomment-2048897179 - I think my general expectation is that context needs to be <em>preserved</em> across an <code>await</code>, rather than <em>restored</em> to some particular snapshot.","m.mentions":{},"msgtype":"m.text"},"ts":1712942510924,"senderName":"Steve Hicks","senderId":"@stephenhicks:matrix.org","id":"$WXAkAX7lHwvwUabF5ZBn_hfvQFI9enR1Qsb48N7BKaA"}
]