[
{"content":{"msgtype":"m.text","body":"Because it uses `EnqueueMicrotask`, which doesn't preserve the context: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-resolve.tq;l=189;drc=4c61bb3131b7951ed2ed896b4df6110b1e5c072f","format":"org.matrix.custom.html","formatted_body":"Because it uses <code>EnqueueMicrotask</code>, which doesn't preserve the context: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-resolve.tq;l=189;drc=4c61bb3131b7951ed2ed896b4df6110b1e5c072f","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$7L0IJLaPFLGe2WEF4s77a-DrS1GgJeuJX1KI6ynTexw"},"rel_type":"m.thread"}},"ts":1674172915865,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$mPYnwRF3lhkHQtFzClAbAd9hZIdUFYgoWR9fXQr28ds"},
{"content":{"msgtype":"m.text","body":"Let me know if I should write this; I am happy to do so but don’t have Edit access"},"ts":1674178599731,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$fHddxWj2NKyMHorYkMni4TnT_2gr5nQy_2o4pILc03Q"},
{"content":{"msgtype":"m.text","body":"Send me your email, and I’ll give you edit access"},"ts":1674180832209,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$J_NwzvOP_sXmxPZne5OisC_LiZJrNdFygYyf4Dvco48"},
{"content":{"msgtype":"m.text","body":"Or send me notes, and I’ll add them to the deck"},"ts":1674180883684,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$iJ_0ODYPahbEXdSZZgtZinHw7PKrQElBCOvv-hLWEaU"},
{"content":{"msgtype":"m.text","body":"I don’t really know anything about open telemetry"},"ts":1674180890144,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$wqowb-SWOS_2NYERBXToT5vCxHKiRMJzO7pb3lbGCHc"},
{"content":{"msgtype":"m.text","body":"Sorry I was out yesterday and now I'm back on work. Catching up with the long discussions."},"ts":1674181097877,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$jD2K5ijgREUG_pmoZc8iDmAQqePR1ZEVGCmWYjC_UyE"},
{"content":{"msgtype":"m.text","body":"My email for slides is littledan@chromium.org"},"ts":1674181796535,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$PuH57HTPqFKbu_LezYQt2UQpKz6QWCgmOiyGlIWhnyQ"},
{"content":{"msgtype":"m.text","body":"Will post outline of presentation edits here in the coming hours"},"ts":1674181809463,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$p935NUt0JFCijKqT6r2muCUnR973gZaVPsA_BiNPvII"},
{"content":{"msgtype":"m.text","body":"So the question then is, is this fixable with V8 changes?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$mPYnwRF3lhkHQtFzClAbAd9hZIdUFYgoWR9fXQr28ds"},"rel_type":"m.thread"}},"ts":1674181915589,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$L9WPj8SS1obn1r2TuTTVJoYLRWid48kuu4P4dIP4o1s"},
{"content":{"body":"My notes since legendecas was gone:\n- SES says we are all good!!!!! And the AsyncContext is per agent, not per Realm.\n- V8 has an API that does most of the work for us, and it is cheaper than PromiseHooks. It is called SetContinuationPreservedEmbedderData. However this only handles some things and not others, where we will need plumbing.\n- It actually turns out it makes sense to run the promise unhandled rejections callback in the AsyncContext where the promise was rejected, rather than created. This means we don’t need to instrument the init hook.","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"<p>My notes since legendecas was gone:</p>\n<ul>\n<li>SES says we are all good!!!!! And the AsyncContext is per agent, not per Realm.</li>\n<li>V8 has an API that does most of the work for us, and it is cheaper than PromiseHooks. It is called SetContinuationPreservedEmbedderData. However this only handles some things and not others, where we will need plumbing.</li>\n<li>It actually turns out it makes sense to run the promise unhandled rejections callback in the AsyncContext where the promise was rejected, rather than created. This means we don’t need to instrument the init hook.</li>\n</ul>"},"ts":1674182150365,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$uUdIwRdN0k7y7EOaj0kX0VrTA1r5PxZLN9DV2CJDXk8"},
{"content":{"body":"I'd add that v8's API will definitely need to be expanded to EnqueueMicrotask in order for thenables to be supported","msgtype":"m.text"},"ts":1674183330902,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$VYlRIl2jtr8UUmMEmkvLnBSrLhLs2xQS0g67ygltVdM"},
{"content":{"body":"(And for queueMicrotask)","msgtype":"m.text"},"ts":1674183343875,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$9aiKDZVdGWkw8Oyu0cf1uopI1qhudLaryce0w8jULGI"},
{"content":{"msgtype":"m.text","body":"Yes, this is due to V8 not fully implementing the host hooks","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$L9WPj8SS1obn1r2TuTTVJoYLRWid48kuu4P4dIP4o1s"},"rel_type":"m.thread"}},"ts":1674183723537,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$R-YqRATDyDgx518hfu-SO_3Xlv2096mEp0O3z0E9L4M"},
{"content":{"msgtype":"m.text","body":"All jobs should carry the `[[HostDefined]]` slot (what they're calling `continuation_preserved_embedder_data`), but currently only Promise jobs do it","format":"org.matrix.custom.html","formatted_body":"All jobs should carry the <code>[[HostDefined]]</code> slot (what they're calling <code>continuation_preserved_embedder_data</code>), but currently only Promise jobs do it","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$R-YqRATDyDgx518hfu-SO_3Xlv2096mEp0O3z0E9L4M"},"rel_type":"m.thread"}},"ts":1674183767255,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$UAWuBLVhSskG3HTZmQQFqiSbANmhNt4UV_WNqf_FTmg"},
{"content":{"msgtype":"m.text","body":"queueMicrotask is in the same logical bucket as setTimeout though, isn’t it? Like, everything needs plumbing"},"ts":1674186407018,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$CrjiXyeZxIj83YiiWij0TnZQC_YhmTw9O07qrtSwBu8"},
{"content":{"body":"But thenables would need built in support otoh ","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"But thenables would need built in support otoh"},"ts":1674186422936,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$GQkoDDkdGw3obZo-pq1d-hZ9M0BRIQofU0f5aFnl-A8"},
{"content":{"msgtype":"m.text","body":"Kinda, and no"},"ts":1674186481756,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$wKhM3KxyA-dYNuuSt0j3AwBWF0oWFad17fy9c6OvEVM"},
{"content":{"msgtype":"m.text","body":"Note that the job system in the JS spec has historically contained certain… standing disagreements between layers","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$UAWuBLVhSskG3HTZmQQFqiSbANmhNt4UV_WNqf_FTmg"},"rel_type":"m.thread"}},"ts":1674186504502,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$4luMlBT3kXTU2tLYcW1Fdcfxzi9BiE0nV21aO4mUNfI"},
{"content":{"msgtype":"m.text","body":"The V8 API can do whatever it wants; there is no obligation to match the JS spec","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$4luMlBT3kXTU2tLYcW1Fdcfxzi9BiE0nV21aO4mUNfI"},"rel_type":"m.thread"}},"ts":1674186522313,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$HA6YaRQVIQqJZEU8LL6VHjLAuXxbY8O26ww73ybW9UE"},
{"content":{"msgtype":"m.text","body":"Anyway this is to say that I don’t know what “all jobs” means","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$HA6YaRQVIQqJZEU8LL6VHjLAuXxbY8O26ww73ybW9UE"},"rel_type":"m.thread"}},"ts":1674186542629,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$92NNTLfuSnyXWO8eeFZfwVuTp35D5TSgx_7hgsFr1QM"},
{"content":{"msgtype":"m.text","body":"`queueMicrotask` seems to be the equivalent of a quick job, and they're not properly implementing the hooks for jobs","format":"org.matrix.custom.html","formatted_body":"<code>queueMicrotask</code> seems to be the equivalent of a quick job, and they're not properly implementing the hooks for jobs"},"ts":1674186551088,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$r5UjCZIA-jnXY0m_ClzhIs3VVDCS3pjtDbHHj5f5yo8"},
{"content":{"msgtype":"m.text","body":"`setTimeout` might be a job, but I have no idea how it's implemented","format":"org.matrix.custom.html","formatted_body":"<code>setTimeout</code> might be a job, but I have no idea how it's implemented"},"ts":1674186570021,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$3MCu3uIHiXOuWB_H4XfDIatDrwK9RUEXQAbwQdamL8c"},
{"content":{"msgtype":"m.text","body":"Do you mean literally the function queueMicrotask, or the V8 API used to implement it?"},"ts":1674186572008,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$0G92vNFpJeFth8U7vagVEdntrqvm2SHuzvkVOvN3d40"},
{"content":{"msgtype":"m.text","body":"Sorry, I meant `queueMicrotask`","format":"org.matrix.custom.html","formatted_body":"Sorry, I meant <code>queueMicrotask</code>"},"ts":1674186588529,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$qySGiek3emPs7bb5cO99QeKWGEMOtpEy9he1KLyDHvE"},
{"content":{"msgtype":"m.text","body":"No, `EnqueueMicrotask`","format":"org.matrix.custom.html","formatted_body":"No, <code>EnqueueMicrotask</code>"},"ts":1674186599378,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$cqGUheUss76sIY9MnsYxXZ2SMZM4B-UiGlXeXJVNgY8"},
{"content":{"msgtype":"m.text","body":"Ugh"},"ts":1674186600789,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$hYPTfiJj5qKbIaiORSExY3Md5hcT-fOUYhb0ylZ7O6s"},
{"content":{"body":"Oh! ok, the V8 API ","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"Oh! ok, the V8 API"},"ts":1674186610642,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$_1QyJXwcNH7zFONSDbO9YbY3Tb3bk8U3WJnp4d8X-_M"},
{"content":{"msgtype":"m.text","body":"Now I understand better"},"ts":1674186615200,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$RneS2MgRXuny3EpusuqMuj0eLUlKkK59V4v9TM4m0F8"},
{"content":{"msgtype":"m.text","body":"Yeah I can imagine that we need something there"},"ts":1674186626822,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$djN8UemkJYiHcsk0iT3h9d48emYue5JLpw1IkA6t51g"},
{"content":{"msgtype":"m.text","body":"Specifically, steps 13-15 of https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-resolve-functions are all jobs code, but they're implemented in V8 as a single `EnqueueMicrotask`","format":"org.matrix.custom.html","formatted_body":"Specifically, steps 13-15 of https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-resolve-functions are all jobs code, but they're implemented in V8 as a single <code>EnqueueMicrotask</code>"},"ts":1674186690848,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$uyW1PeKFjQ7A5swxP9F2rByGbgfCovJtFyelPY-EjQ4"},
{"content":{"msgtype":"m.text","body":"Node.js tracks `queueMicrotask` with the async resource API: https://github.com/nodejs/node/blob/main/lib/internal/process/task_queues.js#L152","format":"org.matrix.custom.html","formatted_body":"Node.js tracks <code>queueMicrotask</code> with the async resource API: https://github.com/nodejs/node/blob/main/lib/internal/process/task_queues.js#L152"},"ts":1674186727273,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$Jc2_WGVi9Llc1JF4hnuSae9SNu-GNUlZnt8snH5clJU"},
{"content":{"msgtype":"m.text","body":"similar to `setTimeout`","format":"org.matrix.custom.html","formatted_body":"similar to <code>setTimeout</code>"},"ts":1674186735461,"senderName":"Chengzhong Wu","senderId":"@legendecas:matrix.org","id":"$mdChkRHPioV-DL-eCxx1mQf9Sogh281nSwQIxH10m-E"},
{"content":{"msgtype":"m.text","body":"Thenables shouldn't need specific support, the spec for them would work if V8 had fully implemented the job hooks"},"ts":1674186741824,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$1FBw6uuWtt4vCgtk1UhvxqxHGAR9OEDIJ6-vV_XwapY"},
{"content":{"msgtype":"m.text","body":"Please, let’s make our arguments on the basis of what is useful, not on what someone is expected to do based on how the spec is written. The latter is a weaker argument and less relevant."},"ts":1674186872989,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$RMmfa9YGn3jV713TbmwzTxpb0RmuKkgnVQ45VGpIBys"},
{"content":{"body":"> <@legendecas:matrix.org> Node.js tracks `queueMicrotask` with the async resource API: https://github.com/nodejs/node/blob/main/lib/internal/process/task_queues.js#L152\n\nThis makes sense to me. Though if the V8 API did something fancier, it might be more efficient.","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy%3Amatrix.org/%24Jc2_WGVi9Llc1JF4hnuSae9SNu-GNUlZnt8snH5clJU\">In reply to</a> <a href=\"https://matrix.to/#/@legendecas:matrix.org\">@legendecas:matrix.org</a><br>Node.js tracks <code>queueMicrotask</code> with the async resource API: https://github.com/nodejs/node/blob/main/lib/internal/process/task_queues.js#L152</blockquote></mx-reply>This makes sense to me. Though if the V8 API did something fancier, it might be more efficient.","m.relates_to":{"m.in_reply_to":{"event_id":"$Jc2_WGVi9Llc1JF4hnuSae9SNu-GNUlZnt8snH5clJU"}}},"ts":1674186931156,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$xxMM-5OgnT6Vy8XKVO4__aD51tBtokpmnucJzLyekLw"},
{"content":{"body":"This is a place where we should learn from Yoav’s implementation experience ","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"This is a place where we should learn from Yoav’s implementation experience"},"ts":1674186980782,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$Dmh8MXk2uJgx6luazpJK7g1VDm2Om3aMiHI_xpPwi-U"},
{"content":{"msgtype":"m.text","body":"> Please, let’s make our arguments on the basis of what is useful, not on what someone is expected to do based on how the spec is written\n\nBecause it prevents an embedder from implementing a feature specifically designed in the spec, I do think it's a problem.","format":"org.matrix.custom.html","formatted_body":"<blockquote>\n<p>Please, let’s make our arguments on the basis of what is useful, not on what someone is expected to do based on how the spec is written</p>\n</blockquote>\n<p>Because it prevents an embedder from implementing a feature specifically designed in the spec, I do think it's a problem.</p>\n"},"ts":1674187069775,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$V2d5bVepETwEaECPS7qgY3KgIx0DmXBCV9BAWK6I_dU"},
{"content":{"msgtype":"m.text","body":"I think if you make an argument on this basis, you will get a flat no. It just isn’t the contract that engines sign up for."},"ts":1674187420343,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$P0SAoJMM6gGZY6PU6RJLo6QZhJDyU-wtrGEryVJ04S4"},
{"content":{"body":"If we make an argument based on case by case utility, it will be more effective ","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"If we make an argument based on case by case utility, it will be more effective"},"ts":1674187442673,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$nbOVVDSCbg0pBOK68I26sM2c4v6R176DkWwFAcSbjKI"},
{"content":{"msgtype":"m.text","body":"Part of this is, there are some things about the interface Ecma-262 provides which are very wacky and bad; engines don’t actually want to sign up for implementing all of that"},"ts":1674187509342,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$n8Z-vJ5UavLyDd766bK1L48p6mmhc3Pqr5j1Dr5Q0IM"},
{"content":{"body":"So you are asking for more than you need if you say that they should do everything corresponding to that interface ","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"So you are asking for more than you need if you say that they should do everything corresponding to that interface"},"ts":1674187561581,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$-yBE6Mglc2MijaJEhAXUrrkLJc1fpCwcbNIJ75zyJsE"},
{"content":{"msgtype":"m.text","body":"Eg it is fine that there is no actual imperative V8 API to get the time zone and that it does things via libc or ICU"},"ts":1674187667508,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$He1tJ5YpljwzYbyT143uFJJdWZioE0fMFY1gah7wVmM"},
{"content":{"msgtype":"m.text","body":"I think we're getting off on a tangent."},"ts":1674187730988,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$t0sAp_UIBDS9b7oYMMbNfsFAlj0y7VRpAnXb8lXZ6DA"},
{"content":{"msgtype":"m.text","body":"The spec will have explicit requirements for `AsyncContext`, and when that exists, the hooks won't really matter","format":"org.matrix.custom.html","formatted_body":"The spec will have explicit requirements for <code>AsyncContext</code>, and when that exists, the hooks won't really matter"},"ts":1674187747986,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$CaaTMl-fsru2gqrBRjQof5g_AfZOv-HlHfKcfxNiQCE"},
{"content":{"msgtype":"m.text","body":"They only matter now because we're trying to shoehorn in `AsyncContext`","format":"org.matrix.custom.html","formatted_body":"They only matter now because we're trying to shoehorn in <code>AsyncContext</code>"},"ts":1674187759674,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$E5EXxqH9rrVVDg5QIcu1ErOr84hFKhkKy_Ce9IueYo4"},
{"content":{"msgtype":"m.text","body":"It's unfortunate it doesn't work properly"},"ts":1674187767201,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$KQ64-9EeJTgehosYesxEUVy37IHRmTMH-NdAbYXi0Ag"},
{"content":{"msgtype":"m.text","body":"But that'll go away with the real impl"},"ts":1674187773091,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$AUa5zTF1SPHP93uY-EPSj-xoy5WeRzpTiShfO0tQaco"},
{"content":{"msgtype":"m.text","body":"Yes, the spec will have requirements, and we will also design a V8 API"},"ts":1674187781948,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$YiEpOargEfhwGjtmnBO05QIzknM11_DxOTuj_L_cSQI"}
]