[
{"content":{"org.matrix.msc1767.text":"I'm surprised you need to do so much work to integrate it","body":"I'm surprised you need to do so much work to integrate it","msgtype":"m.text"},"ts":1674003929529,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$dmM0fz7JcVSo0ZPRkos6Z4bugsKu7pp9HcN1vrySX9Y"},
{"content":{"org.matrix.msc1767.text":"The spec has a hook designed for this usecase, and it seems to exist in V8: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4","body":"The spec has a hook designed for this usecase, and it seems to exist in V8: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4","msgtype":"m.text"},"ts":1674003966522,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$ZFsJCEkKBR4eVm8NCYzc9DQNJnfXrB4biyTr1PCWWHw"},
{"content":{"org.matrix.msc1767.text":"I spotted that previously but couldn't find any detail whatsoever on what/how it's used","body":"I spotted that previously but couldn't find any detail whatsoever on what/how it's used","msgtype":"m.text"},"ts":1674004047216,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Tqdpogkhn87J-WzzMJtvd4eT0V9spj7v4wz9EnNisiM"},
{"content":{"org.matrix.msc1767.text":"specifically, on the promise hook callback, for the init event, we create an opaque JS object that wraps the reference to the current async context frame. We then set that as a private field on the Promise object. What's not clear in any way (I couldn't find any documentation or examples) if Set/GetContinuationPreservedEmbedderData could be used for that","body":"specifically, on the promise hook callback, for the init event, we create an opaque JS object that wraps the reference to the current async context frame. We then set that as a private field on the Promise object. What's not clear in any way (I couldn't find any documentation or examples) if Set/GetContinuationPreservedEmbedderData could be used for that","msgtype":"m.text"},"ts":1674004153400,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$UhUR5OeQ6XcwOB4H7Pjze1LatuyYt865xLO6egTF0zA"},
{"content":{"org.matrix.msc1767.message":[{"body":"specifically, it's not clear *when* we would call `SetContinuationPreservedEmbedderData` and what effect that would have","mimetype":"text/plain"},{"body":"specifically, it's not clear <em>when</em> we would call <code>SetContinuationPreservedEmbedderData</code> and what effect that would have","mimetype":"text/html"}],"body":"specifically, it's not clear *when* we would call `SetContinuationPreservedEmbedderData` and what effect that would have","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"specifically, it's not clear <em>when</em> we would call <code>SetContinuationPreservedEmbedderData</code> and what effect that would have"},"ts":1674004208459,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$87EVD_E8iIAbyEIp0kXHgarWrnXy4np5KZ1U8liHeTU"},
{"content":{"org.matrix.msc1767.message":[{"body":"If I'm reading this right, I would call it in `Set…` inside `AsyncContext.run()`, and call `Get…` inside `AsyncContext.get()`","mimetype":"text/plain"},{"body":"If I'm reading this right, I would call it in <code>Set…</code> inside <code>AsyncContext.run()</code>, and call <code>Get…</code> inside <code>AsyncContext.get()</code>","mimetype":"text/html"}],"body":"If I'm reading this right, I would call it in `Set…` inside `AsyncContext.run()`, and call `Get…` inside `AsyncContext.get()`","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"If I'm reading this right, I would call it in <code>Set…</code> inside <code>AsyncContext.run()</code>, and call <code>Get…</code> inside <code>AsyncContext.get()</code>"},"ts":1674004487001,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$7gWOOMSy3VxmJe2kE6Zj6M4IXBhu1zYBD_gQaLgJP9k"},
{"content":{"org.matrix.msc1767.message":[{"body":"- https://source.chromium.org/search?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&ss=chromium%2Fchromium%2Fsrc\n- Preserved on jobs: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=75-90;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552\n- Restored on run: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-245?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&ss=chromium%2Fchromium%2Fsrc","mimetype":"text/plain"},{"body":"<ul>\n<li>https://source.chromium.org/search?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc</li>\n<li>Preserved on jobs: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=75-90;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552</li>\n<li>Restored on run: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-245?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc</li>\n</ul>\n","mimetype":"text/html"}],"body":"- https://source.chromium.org/search?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&ss=chromium%2Fchromium%2Fsrc\n- Preserved on jobs: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=75-90;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552\n- Restored on run: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-245?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&ss=chromium%2Fchromium%2Fsrc","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<ul>\n<li>https://source.chromium.org/search?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc</li>\n<li>Preserved on jobs: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq;l=75-90;drc=39c3a97e848a7ecd1fa95e738771cc61d6d72552</li>\n<li>Restored on run: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc;l=238-245?q=continuation_preserved_embedder_data%20-filepath:%5Eout%2F&amp;ss=chromium%2Fchromium%2Fsrc</li>\n</ul>\n"},"ts":1674004519904,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$zAmKPCWZXNxPXZs29AvT2LctTrqNjZBU-Xr-E4AQ5qs"},
{"content":{"org.matrix.msc1767.text":"Looks like Yoav might be using it in the new Chrome TaskAttribution work: https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/task_attribution_tracker_impl.cc;l=233-289;drc=71630a0e336a703e21de9ebeb98a5abf84e8c96c","body":"Looks like Yoav might be using it in the new Chrome TaskAttribution work: https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/scheduler/task_attribution_tracker_impl.cc;l=233-289;drc=71630a0e336a703e21de9ebeb98a5abf84e8c96c","msgtype":"m.text"},"ts":1674004574535,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$kfGCHgkarAArK7izYKhXAiKoTjJ8MtnuOmqw9hoO5U8"},
{"content":{"org.matrix.msc1767.text":"Still not super clear but it's worth exploring to see if it does make it easier","body":"Still not super clear but it's worth exploring to see if it does make it easier","msgtype":"m.text"},"ts":1674004704463,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$bqGhKO9Gd4Ok3Zd-hD6DqFa2cX7VhpHqkRawMT5nWkU"},
{"content":{"org.matrix.msc1767.text":"one key issue is that we need the context tracking to also work with things like timers","body":"one key issue is that we need the context tracking to also work with things like timers","msgtype":"m.text"},"ts":1674004746578,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$wjhwtRqhJe0p2P4xgHsBamiVqDtY9fL1SQSCSCrwHFs"},
{"content":{"org.matrix.msc1767.text":"What other times do you provide?","body":"What other times do you provide?","msgtype":"m.text"},"ts":1674004786175,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$Y0ZGeCeKHAPasZ9BvMVe6ZhlJiyvuIgt7QuGK6vurIE"},
{"content":{"org.matrix.msc1767.text":"so long as we can preserve the context with non-v8 things and it all just works, then hopefully this could make things easier. I'll play with it","body":"so long as we can preserve the context with non-v8 things and it all just works, then hopefully this could make things easier. I'll play with it","msgtype":"m.text"},"ts":1674004803317,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$i-OHoTmY04c9au-bfnLhEYtpBRotzLpq0Z-v2q6t3hU"},
{"content":{"org.matrix.msc1767.text":"Just setTimeout and setInterval but v8's only involvement there is that we call the function when the timer expires","body":"Just setTimeout and setInterval but v8's only involvement there is that we call the function when the timer expires","msgtype":"m.text"},"ts":1674004840429,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$B7xiJQQilxQ6bvEV1ZiHwri16SWPH2SaKmTrHL-wfGQ"},
{"content":{"org.matrix.msc1767.message":[{"body":"I think if you port https://docs.google.com/presentation/d/1yw4d0ca6v2Z2Vmrnac9E9XJFlC872LDQ4GFR17QdRzk/edit#slide=id.g18e6eaa50e1_0_192 into C++, and everywhere you access `__storage__` you call `Get…`, and everywhere you set you call `Set…`, then it'd work correctly","mimetype":"text/plain"},{"body":"I think if you port https://docs.google.com/presentation/d/1yw4d0ca6v2Z2Vmrnac9E9XJFlC872LDQ4GFR17QdRzk/edit#slide=id.g18e6eaa50e1_0_192 into C++, and everywhere you access <code>__storage__</code> you call <code>Get…</code>, and everywhere you set you call <code>Set…</code>, then it'd work correctly","mimetype":"text/html"}],"body":"I think if you port https://docs.google.com/presentation/d/1yw4d0ca6v2Z2Vmrnac9E9XJFlC872LDQ4GFR17QdRzk/edit#slide=id.g18e6eaa50e1_0_192 into C++, and everywhere you access `__storage__` you call `Get…`, and everywhere you set you call `Set…`, then it'd work correctly","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"I think if you port https://docs.google.com/presentation/d/1yw4d0ca6v2Z2Vmrnac9E9XJFlC872LDQ4GFR17QdRzk/edit#slide=id.g18e6eaa50e1_0_192 into C++, and everywhere you access <code>__storage__</code> you call <code>Get…</code>, and everywhere you set you call <code>Set…</code>, then it'd work correctly"},"ts":1674004849237,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$u3m7hD12JaUyM0lxtwaDfdCGbPcnkSeMAKpeM_EMw_k"},
{"content":{"org.matrix.msc1767.text":"we capture a reference to the current frame and enter it when we invoke the callback","body":"we capture a reference to the current frame and enter it when we invoke the callback","msgtype":"m.text"},"ts":1674004859171,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$0fGOciMJUdQQiDcvc-PJREPvS-cNcYL9KyNTI_7DdlM"},
{"content":{"org.matrix.msc1767.text":"ok, I'll play with this a bit. If we can eliminate the promise hook I'll be really quite happy","body":"ok, I'll play with this a bit. If we can eliminate the promise hook I'll be really quite happy","msgtype":"m.text"},"ts":1674004943503,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$gIwB5C0hS1gAVSMZTauYECnnQXBQrL9P1zov6H0vCbM"},
{"content":{"org.matrix.msc1767.message":[{"body":"It doesn't look like anything else uses the embedder continuation data, so I'm not sure if `setTimeout` would propagate correctly.","mimetype":"text/plain"},{"body":"It doesn't look like anything else uses the embedder continuation data, so I'm not sure if <code>setTimeout</code> would propagate correctly.","mimetype":"text/html"}],"body":"It doesn't look like anything else uses the embedder continuation data, so I'm not sure if `setTimeout` would propagate correctly.","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"It doesn't look like anything else uses the embedder continuation data, so I'm not sure if <code>setTimeout</code> would propagate correctly."},"ts":1674005132952,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$WavQt1tm6E1ayph8NW6z4Glw2TAVB4dNhFZpim78KiU"},
{"content":{"org.matrix.msc1767.text":"It might be easy to do manually, though","body":"It might be easy to do manually, though","msgtype":"m.text"},"ts":1674005142536,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$3yTKXt2mJcdqWt_57WmUyIYPiIhk8tyZJybyu6o8Ku8"},
{"content":{"body":"> <@jridgewell:matrix.org> The spec has a hook designed for this usecase, and it seems to exist in V8: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4\n\nOh wow I didn’t know about this API","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy%3Amatrix.org/%24ZFsJCEkKBR4eVm8NCYzc9DQNJnfXrB4biyTr1PCWWHw\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>The spec has a hook designed for this usecase, and it seems to exist in V8: https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=6837-6853;drc=dd38db94df728f36d61d5d6c943156dbe37144a4</blockquote></mx-reply>Oh wow I didn’t know about this API","m.relates_to":{"m.in_reply_to":{"event_id":"$ZFsJCEkKBR4eVm8NCYzc9DQNJnfXrB4biyTr1PCWWHw"}}},"ts":1674049959030,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$BXuIO5Jh7LImGEle762VjolB6UgQaANT_dyq6suIqbs"},
{"content":{"body":"Would be cool to see if someone can build AsyncContext as a Node native module just based on that, or if there are limitations ","format":"org.matrix.custom.html","msgtype":"m.text","formatted_body":"Would be cool to see if someone can build AsyncContext as a Node native module just based on that, or if there are limitations"},"ts":1674050240170,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k"},
{"content":{"org.matrix.msc1767.message":[{"body":"`SCOPING.md` has the following:","mimetype":"text/plain"},{"body":"<code>SCOPING.md</code> has the following:","mimetype":"text/html"}],"body":"`SCOPING.md` has the following:","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<code>SCOPING.md</code> has the following:"},"ts":1674073854553,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$5DHhlU3Ly_QuN90w8H-sVbAsUlJ8SvkU5hnH9GAWGRE"},
{"content":{"org.matrix.msc1767.message":[{"body":"> Only code with direct access to `AsyncContext` instances can modify the value, and only for code execution nested inside a new `context.run()`.","mimetype":"text/plain"},{"body":"<blockquote>\n<p>Only code with direct access to <code>AsyncContext</code> instances can modify the value, and only for code execution nested inside a new <code>context.run()</code>.</p>\n</blockquote>\n","mimetype":"text/html"}],"body":"> Only code with direct access to `AsyncContext` instances can modify the value, and only for code execution nested inside a new `context.run()`.","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<blockquote>\n<p>Only code with direct access to <code>AsyncContext</code> instances can modify the value, and only for code execution nested inside a new <code>context.run()</code>.</p>\n</blockquote>\n"},"ts":1674073862246,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$sqWwno5uI4WPHow0H1NNWN2lS_9LanYKKm0Z6Ti1480"},
{"content":{"org.matrix.msc1767.message":[{"body":"Doesn't `AsyncContext.wrap` allow any code to modify the value of all `AsyncContext` instances in the callback's context?","mimetype":"text/plain"},{"body":"Doesn't <code>AsyncContext.wrap</code> allow any code to modify the value of all <code>AsyncContext</code> instances in the callback's context?","mimetype":"text/html"}],"body":"Doesn't `AsyncContext.wrap` allow any code to modify the value of all `AsyncContext` instances in the callback's context?","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"Doesn't <code>AsyncContext.wrap</code> allow any code to modify the value of all <code>AsyncContext</code> instances in the callback's context?"},"ts":1674073966777,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$7qcS0eWnq0iEYftLKSXYXDlKN6PyY3U3CJtLy5i6K_4"},
{"content":{"msgtype":"m.text","body":"Yes and no"},"ts":1674074021514,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$Cdw0CvOG6-l_lDmGCHjrhQa263R_q8STQYm1MPJFciA"},
{"content":{"msgtype":"m.text","body":"The `AsyncContext` instance can't contain a value unless that value is placed there by someone with access to the instance","format":"org.matrix.custom.html","formatted_body":"The <code>AsyncContext</code> instance can't contain a value unless that value is placed there by someone with access to the instance"},"ts":1674074055880,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$FJCYh6lZiuQtdU9dUtHPkMwWZr8_p5gMPhd4rm2WpBw"},
{"content":{"msgtype":"m.text","body":"`undefined` (the default state of an `AsyncContext`) is just a \"value placed there by someone with access\"","format":"org.matrix.custom.html","formatted_body":"<code>undefined</code> (the default state of an <code>AsyncContext</code>) is just a &quot;value placed there by someone with access&quot;"},"ts":1674074087672,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$hpmCkM9qXvm7wscvzDQ1T_0NXpC_jbPv6_sBE-RmzpE"},
{"content":{"msgtype":"m.text","body":"So restoring the state to a prior one just places a value into the `AsyncContext` that was already placed there by someone with access","format":"org.matrix.custom.html","formatted_body":"So restoring the state to a prior one just places a value into the <code>AsyncContext</code> that was already placed there by someone with access"},"ts":1674074124126,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$AJKOV38WIdDKnFh7hhtGLcxHLxHNi_y2HtxEZ6CoQLM"},
{"content":{"msgtype":"m.text","body":"Mark Miller's equates this more to a closed over variable"},"ts":1674074164664,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$ggOl87blUSB1JEmznPab6gY4BjhaCWnMQDFUPNNsX6Y"},
{"content":{"msgtype":"m.text","body":"If I have a opaque `Map` (that I can't directly acccess, but which can be access by `AsyncContext` instances) which holds the data, then all I've done is propagate my closed-over map for you to read from.","format":"org.matrix.custom.html","formatted_body":"If I have a opaque <code>Map</code> (that I can't directly acccess, but which can be access by <code>AsyncContext</code> instances) which holds the data, then all I've done is propagate my closed-over map for you to read from."},"ts":1674074234325,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$NrZRLx6oSAHgg6hxNzwuqDw5ojBsqk6OFZBWx0IsCnA"},
{"content":{"msgtype":"m.text","body":"- https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style-transform.md\n- https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style.js","format":"org.matrix.custom.html","formatted_body":"<ul>\n<li>https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style-transform.md</li>\n<li>https://github.com/endojs/endo/blob/markm-fluid-scopes/packages/eventual-send/src/async-contexts/7-fluid-passing-style.js</li>\n</ul>\n"},"ts":1674074279766,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$B13R4hHX9UyXVAcJqZt6-FvuGSSzUVNZOov3Gh_nGcQ"},
{"content":{"org.matrix.msc1767.text":"I guess to connect these things, the modification is well-behaved","body":"I guess to connect these things, the modification is well-behaved","msgtype":"m.text"},"ts":1674074436900,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$AQPbKAsZ4LCVNDCqawyc4gbARvLD7jqgGYHEtRtvSrc"},
{"content":{"org.matrix.msc1767.message":[{"body":"yes, you definitely can restore things via `wrap`, that's the whole point, that is a well-behaved modification","mimetype":"text/plain"},{"body":"yes, you definitely can restore things via <code>wrap</code>, that's the whole point, that is a well-behaved modification","mimetype":"text/html"}],"body":"yes, you definitely can restore things via `wrap`, that's the whole point, that is a well-behaved modification","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"yes, you definitely can restore things via <code>wrap</code>, that's the whole point, that is a well-behaved modification"},"ts":1674074449937,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$peXxJkrFS8Cc4CpUFyMvLO4A8QYa1JsOrnUFWdQwEEE"},
{"content":{"org.matrix.msc1767.text":"so maybe this could be clarified in the wording of SCOPING.md","body":"so maybe this could be clarified in the wording of SCOPING.md","msgtype":"m.text"},"ts":1674074463996,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$xh5GRa9bYYSTWe_VTxJCerfMipVddFtGjdAtuKot6QM"},
{"content":{"org.matrix.msc1767.message":[{"body":"yeah, in that sense `wrap` doesn't introduce any dynamic scoping, so it's just a matter of wording that","mimetype":"text/plain"},{"body":"yeah, in that sense <code>wrap</code> doesn't introduce any dynamic scoping, so it's just a matter of wording that","mimetype":"text/html"}],"body":"yeah, in that sense `wrap` doesn't introduce any dynamic scoping, so it's just a matter of wording that","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"yeah, in that sense <code>wrap</code> doesn't introduce any dynamic scoping, so it's just a matter of wording that"},"ts":1674074510736,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$9da-R-FXhT7ArKi97ilImWj0s-uE4M1_QjqEGAJ4ExI"},
{"content":{"msgtype":"m.text","body":"Just a quick update here. I've implemented use of this api to store context for workers (https://github.com/cloudflare/workerd/pull/282).... it works well for promises in general but does have a limitation.","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k"},"rel_type":"m.thread"}},"ts":1674074516033,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Y0XHwbj1bxOGdp018QGOx-6wv6i5n4U15jzOada3htI"},
{"content":{"msgtype":"m.text","body":"Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Y0XHwbj1bxOGdp018QGOx-6wv6i5n4U15jzOada3htI"},"rel_type":"m.thread"}},"ts":1674074545124,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA"},
{"content":{"org.matrix.msc1767.text":"I'm not familiar with programming language theory, and there's a lot of stuff I'm missing here","body":"I'm not familiar with programming language theory, and there's a lot of stuff I'm missing here","msgtype":"m.text"},"ts":1674074570948,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$Bv0976em9Lfe6_-P0lX-SlxiFtIVc3w8tB_hidkCeCo"},
{"content":{"msgtype":"m.text","body":"I end up having to still associate the current context frame with the promise in the promise hook and entering the frame manually when emitting those events","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA"},"rel_type":"m.thread"}},"ts":1674074577857,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$tb4MaxD3B5o5Bmcyj5jm8zB-fF72bxVRXUwWBBiUiV4"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jasnell:matrix.org> Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers\n\nyep, that doesn't surprise me... this is what you need the init hook for, right?","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>Specifically, I&#39;m currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers</blockquote></mx-reply>yep, that doesn't surprise me... this is what you need the init hook for, right?","mimetype":"text/html"}],"body":"> <@jasnell:matrix.org> Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers\n\nyep, that doesn't surprise me... this is what you need the init hook for, right?","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>Specifically, I&#39;m currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers</blockquote></mx-reply>yep, that doesn't surprise me... this is what you need the init hook for, right?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","m.in_reply_to":{"event_id":"$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA"},"rel_type":"m.thread"}},"ts":1674074612509,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$WHppKZL9id7M59wOf1v4lssdURiUh6_XBjDHe9PlIKs"},
{"content":{"org.matrix.msc1767.text":"but it's great to hear if everything but the init hook works!!!","body":"but it's great to hear if everything but the init hook works!!!","msgtype":"m.text"},"ts":1674074631517,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$EpbOK0yJlikCBQzoXiE2Em7mDCceCsX6-jd3Ny0jMYQ"},
{"content":{"msgtype":"m.text","body":"Second, I am capturing the async context when `queueMicrotask()` is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks","format":"org.matrix.custom.html","formatted_body":"Second, I am capturing the async context when <code>queueMicrotask()</code> is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$WHppKZL9id7M59wOf1v4lssdURiUh6_XBjDHe9PlIKs"},"rel_type":"m.thread"}},"ts":1674074649461,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$jDCHqXKWTvlRJPwmk9dDdiTk-P7Ps9qf1L7Frj2vYbw"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@abotella:igalia.com> I'm not familiar with programming language theory, and there's a lot of stuff I'm missing here\n\nAndreu, I recommend you make PRs to SCOPING.md to make things clearer for you, and we can iterate on it in code review. You shouldn't have to be an expert in PL theory to read our docs.","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$Bv0976em9Lfe6_-P0lX-SlxiFtIVc3w8tB_hidkCeCo?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@abotella:igalia.com\">@abotella:igalia.com</a><br>I&#39;m not familiar with programming language theory, and there&#39;s a lot of stuff I&#39;m missing here</blockquote></mx-reply>Andreu, I recommend you make PRs to SCOPING.md to make things clearer for you, and we can iterate on it in code review. You shouldn't have to be an expert in PL theory to read our docs.","mimetype":"text/html"}],"body":"> <@abotella:igalia.com> I'm not familiar with programming language theory, and there's a lot of stuff I'm missing here\n\nAndreu, I recommend you make PRs to SCOPING.md to make things clearer for you, and we can iterate on it in code review. You shouldn't have to be an expert in PL theory to read our docs.","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$Bv0976em9Lfe6_-P0lX-SlxiFtIVc3w8tB_hidkCeCo?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@abotella:igalia.com\">@abotella:igalia.com</a><br>I&#39;m not familiar with programming language theory, and there&#39;s a lot of stuff I&#39;m missing here</blockquote></mx-reply>Andreu, I recommend you make PRs to SCOPING.md to make things clearer for you, and we can iterate on it in code review. You shouldn't have to be an expert in PL theory to read our docs.","m.relates_to":{"m.in_reply_to":{"event_id":"$Bv0976em9Lfe6_-P0lX-SlxiFtIVc3w8tB_hidkCeCo"}}},"ts":1674074676365,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$wunqUNCJbLh0I_ZZGAaFjj8JPiUJG0AMvNruB0DhRTA"},
{"content":{"msgtype":"m.text","body":"but otherwise, the v8 api is quite helpful. Thank you for pointing it out Justin Ridgewell ","format":"org.matrix.custom.html","formatted_body":"but otherwise, the v8 api is quite helpful. Thank you for pointing it out <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">Justin Ridgewell</a>","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$jDCHqXKWTvlRJPwmk9dDdiTk-P7Ps9qf1L7Frj2vYbw"},"rel_type":"m.thread"}},"ts":1674074679206,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$97nVCQ3pWjdRw-lu2jbGM-0PA1-LymYu074zH-j2QEM"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jasnell:matrix.org> Second, I am capturing the async context when `queueMicrotask()` is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks\n\nSorry, could you explain this a little more?","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$jDCHqXKWTvlRJPwmk9dDdiTk-P7Ps9qf1L7Frj2vYbw?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>Second, I am capturing the async context when <code>queueMicrotask()</code> is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks</blockquote></mx-reply>Sorry, could you explain this a little more?","mimetype":"text/html"}],"body":"> <@jasnell:matrix.org> Second, I am capturing the async context when `queueMicrotask()` is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks\n\nSorry, could you explain this a little more?","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$jDCHqXKWTvlRJPwmk9dDdiTk-P7Ps9qf1L7Frj2vYbw?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>Second, I am capturing the async context when <code>queueMicrotask()</code> is called so that the context at the time queueMicrotask is called to schedule the callback is entered. v8 does not appear to propagate the stored context when invoking those scheduled tasks</blockquote></mx-reply>Sorry, could you explain this a little more?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","m.in_reply_to":{"event_id":"$jDCHqXKWTvlRJPwmk9dDdiTk-P7Ps9qf1L7Frj2vYbw"},"rel_type":"m.thread"}},"ts":1674074703366,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$CBLzKKuU-QsFHVyI_1drJfEIsk8e0lKYbXU7BVBMpQE"},
{"content":{"org.matrix.msc1767.message":[{"body":"well, that was a bit more about Justin Ridgewell's response","mimetype":"text/plain"},{"body":"well, that was a bit more about <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">Justin Ridgewell</a>'s response","mimetype":"text/html"}],"body":"well, that was a bit more about Justin Ridgewell's response","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"well, that was a bit more about <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">Justin Ridgewell</a>'s response"},"ts":1674074709394,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$hWGzsOyfu4BYQDuQgiYbzG3mKn9LuqE_gi5GBZadf38"},
{"content":{"msgtype":"m.text","body":"```\nals.run(123, () => queueMicrotask(() => console.log(als.getStore())));\n```","format":"org.matrix.custom.html","formatted_body":"<pre><code>als.run(123, () =&gt; queueMicrotask(() =&gt; console.log(als.getStore())));\n</code></pre>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$CBLzKKuU-QsFHVyI_1drJfEIsk8e0lKYbXU7BVBMpQE"},"rel_type":"m.thread"}},"ts":1674074746917,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$71KTPxYBiZisR-YXJvhE5o_krv69EM1iYWrRMfXlVb8"},
{"content":{"org.matrix.msc1767.text":"the thing is, Mark Miller's school of PL theory is really not widely understood... it is just his small community","body":"the thing is, Mark Miller's school of PL theory is really not widely understood... it is just his small community","msgtype":"m.text"},"ts":1674074753257,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$6DHC5aA08_SiwzmrQrgZU3t_Aq9WKFh0pC7XUGIZmgU"},
{"content":{"msgtype":"m.text","body":"I've implemented it such that when the scheduled microtask is run, `als.getStore()` returns the appropriate value","format":"org.matrix.custom.html","formatted_body":"I've implemented it such that when the scheduled microtask is run, <code>als.getStore()</code> returns the appropriate value","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$71KTPxYBiZisR-YXJvhE5o_krv69EM1iYWrRMfXlVb8"},"rel_type":"m.thread"}},"ts":1674074786922,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$fYJPWcgnZWC4QGCp3tuKCvKAizVFPme7MKXoAxO-2x0"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jasnell:matrix.org> ```\n> als.run(123, () => queueMicrotask(() => console.log(als.getStore())));\n> ```\n\nhuh, I thought that would be the whole point of V8's API, to propagate over exactly that pattern... if it doesn't handle this, what does it do?","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$71KTPxYBiZisR-YXJvhE5o_krv69EM1iYWrRMfXlVb8?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br><pre><code>als.run(123, () =&gt; queueMicrotask(() =&gt; console.log(als.getStore())));\n</code></pre>\n</blockquote></mx-reply>huh, I thought that would be the whole point of V8's API, to propagate over exactly that pattern... if it doesn't handle this, what does it do?","mimetype":"text/html"}],"body":"> <@jasnell:matrix.org> ```\n> als.run(123, () => queueMicrotask(() => console.log(als.getStore())));\n> ```\n\nhuh, I thought that would be the whole point of V8's API, to propagate over exactly that pattern... if it doesn't handle this, what does it do?","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$71KTPxYBiZisR-YXJvhE5o_krv69EM1iYWrRMfXlVb8?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br><pre><code>als.run(123, () =&gt; queueMicrotask(() =&gt; console.log(als.getStore())));\n</code></pre>\n</blockquote></mx-reply>huh, I thought that would be the whole point of V8's API, to propagate over exactly that pattern... if it doesn't handle this, what does it do?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","m.in_reply_to":{"event_id":"$71KTPxYBiZisR-YXJvhE5o_krv69EM1iYWrRMfXlVb8"},"rel_type":"m.thread"}},"ts":1674074792493,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$GHb_OE-3rh_Ro4sxJfRYtj4f_lg16QLh1Ifpb4T0mAk"},
{"content":{"msgtype":"m.text","body":"I don't know. I could be doing something wrong here but in local testing it wasn't picking up the value","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$GHb_OE-3rh_Ro4sxJfRYtj4f_lg16QLh1Ifpb4T0mAk"},"rel_type":"m.thread"}},"ts":1674074852579,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$SJzLNHg5N_0oJN_V6RF5tCzb7GZbgh3nSnvd9GJLl3I"},
{"content":{"msgtype":"m.text","body":"I can play with it more","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$SJzLNHg5N_0oJN_V6RF5tCzb7GZbgh3nSnvd9GJLl3I"},"rel_type":"m.thread"}},"ts":1674074861583,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$1nh7Igt3j580Jhwm0lj6sVbg4QsHBtx--rQqW_EKoNg"},
{"content":{"org.matrix.msc1767.text":"did you get it to work at all, in any case? for example, maybe it works for promises but not calls to queueMicrotask?","body":"did you get it to work at all, in any case? for example, maybe it works for promises but not calls to queueMicrotask?","msgtype":"m.text"},"ts":1674074920397,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$zj-IqE_RF8Tj1kzYCIkE3hUCaV6Ud86y9F_ZitcdoV0"},
{"content":{"msgtype":"m.text","body":"> <@littledan:matrix.org> the thing is, Mark Miller's school of PL theory is really not widely understood... it is just his small community\n\nMark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$6DHC5aA08_SiwzmrQrgZU3t_Aq9WKFh0pC7XUGIZmgU?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@littledan:matrix.org\">@littledan:matrix.org</a><br>the thing is, Mark Miller&#39;s school of PL theory is really not widely understood... it is just his small community</blockquote></mx-reply>Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬","m.relates_to":{"m.in_reply_to":{"event_id":"$6DHC5aA08_SiwzmrQrgZU3t_Aq9WKFh0pC7XUGIZmgU"}}},"ts":1674074966130,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$rdBcIePNn4B095lLJ2ttLegBF-IzrAkJOBplHjNfM04"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jridgewell:matrix.org> Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬\n\nreference like link to, or put everything in his terms?","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$rdBcIePNn4B095lLJ2ttLegBF-IzrAkJOBplHjNfM04?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬</blockquote></mx-reply>reference like link to, or put everything in his terms?","mimetype":"text/html"}],"body":"> <@jridgewell:matrix.org> Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬\n\nreference like link to, or put everything in his terms?","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$rdBcIePNn4B095lLJ2ttLegBF-IzrAkJOBplHjNfM04?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>Mark asked to update the proposal docs to reference his explanations, which I'm a little worried about. 😬</blockquote></mx-reply>reference like link to, or put everything in his terms?","m.relates_to":{"m.in_reply_to":{"event_id":"$rdBcIePNn4B095lLJ2ttLegBF-IzrAkJOBplHjNfM04"}}},"ts":1674075008816,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$wPN5Zbta9p11WdYIoHN8hxGTpWF5QCd9s_7EcTRAnNc"},
{"content":{"msgtype":"m.text","body":"They may not be integrating with the job queue correctly","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$1nh7Igt3j580Jhwm0lj6sVbg4QsHBtx--rQqW_EKoNg"},"rel_type":"m.thread"}},"ts":1674075024880,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$lJ5c0nhdD3q0bdmThu3M3viKKHXQkyL-Pt7akdq-feE"},
{"content":{"msgtype":"m.text","body":"The intention of the hooks is for that to work without modifications, but they're only calling it for promises currently","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$lJ5c0nhdD3q0bdmThu3M3viKKHXQkyL-Pt7akdq-feE"},"rel_type":"m.thread"}},"ts":1674075045000,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$-7VbXQAhCTPvV5W_v_7f19nC7ZtO0sorAS7_cC0PaHM"},
{"content":{"msgtype":"m.text","body":"I'm not sure how Web APIs implement their calls","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$-7VbXQAhCTPvV5W_v_7f19nC7ZtO0sorAS7_cC0PaHM"},"rel_type":"m.thread"}},"ts":1674075059641,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$nFXbGHwAm3hNwmgstwsy20owD1rsgnDRHDlPf5FIdkY"},
{"content":{"msgtype":"m.text","body":"Redo the explanation in his terms"},"ts":1674075071977,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$CBrC1agDoQotd_QX5uCZx65fOY5p_itPpdeOv4EMIdk"},
{"content":{"msgtype":"m.text","body":"yeah, definitely doesn't appear to be working","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$nFXbGHwAm3hNwmgstwsy20owD1rsgnDRHDlPf5FIdkY"},"rel_type":"m.thread"}},"ts":1674075210773,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$6xJenOsQUAgW23l7AFgUH0_-LKpVZcIY8yTyB28ezYc"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jridgewell:matrix.org> Redo the explanation in his terms\n\nAh, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$CBrC1agDoQotd_QX5uCZx65fOY5p_itPpdeOv4EMIdk?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>Redo the explanation in his terms</blockquote></mx-reply>Ah, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms","mimetype":"text/html"}],"body":"> <@jridgewell:matrix.org> Redo the explanation in his terms\n\nAh, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$CBrC1agDoQotd_QX5uCZx65fOY5p_itPpdeOv4EMIdk?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>Redo the explanation in his terms</blockquote></mx-reply>Ah, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms","m.relates_to":{"m.in_reply_to":{"event_id":"$CBrC1agDoQotd_QX5uCZx65fOY5p_itPpdeOv4EMIdk"}}},"ts":1674075218052,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$B-CTsyL8A0DhkR63uDaLlVbwr8SC4me3Agh2lBLGuQQ"},
{"content":{"msgtype":"m.text","body":"> <@jasnell:matrix.org> Specifically, I'm currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers\n\nLooks like that's actually possible with `SetPromiseRejectCallback`:\n- https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678\n- called by https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>Specifically, I&#39;m currently not able to completely eliminate the use of the promise hook because the v8 api does not make the context propagation available for the unhandledrejection event handlers</blockquote></mx-reply><p>Looks like that's actually possible with <code>SetPromiseRejectCallback</code>:</p>\n<ul>\n<li>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678</li>\n<li>called by https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc</li>\n</ul>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":false,"m.in_reply_to":{"event_id":"$Qy91K_EdByEJqiFii3wBIpeVhRBsB-3pBubXyHyCCQA"},"rel_type":"m.thread"}},"ts":1674075229671,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$nMX_drTSBGkvZsjRakXuVeUoB1RJUwRczLN1JjtYoZg"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jridgewell:matrix.org> Looks like that's actually possible with `SetPromiseRejectCallback`:\n> - https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678\n> - called by https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc\n\nJustin, that's one side (where you read the relevant asynccontext) but there's the other side separately (in the promise init hook, when you have to stash exactly that information)","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$nMX_drTSBGkvZsjRakXuVeUoB1RJUwRczLN1JjtYoZg?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br><p>Looks like that's actually possible with <code>SetPromiseRejectCallback</code>:</p>\n<ul>\n<li>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678</li>\n<li>called by https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc</li>\n</ul>\n</blockquote></mx-reply>Justin, that's one side (where you read the relevant asynccontext) but there's the other side separately (in the promise init hook, when you have to stash exactly that information)","mimetype":"text/html"}],"body":"> <@jridgewell:matrix.org> Looks like that's actually possible with `SetPromiseRejectCallback`:\n> - https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678\n> - called by https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc\n\nJustin, that's one side (where you read the relevant asynccontext) but there's the other side separately (in the promise init hook, when you have to stash exactly that information)","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$nMX_drTSBGkvZsjRakXuVeUoB1RJUwRczLN1JjtYoZg?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br><p>Looks like that's actually possible with <code>SetPromiseRejectCallback</code>:</p>\n<ul>\n<li>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/api/api.cc;l=9491-9495;drc=c53c026e6ee5083d71e1cd63607ecbae0c641678</li>\n<li>called by https://source.chromium.org/chromium/chromium/src/+/main:v8/src/runtime/runtime-promise.cc</li>\n</ul>\n</blockquote></mx-reply>Justin, that's one side (where you read the relevant asynccontext) but there's the other side separately (in the promise init hook, when you have to stash exactly that information)","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","m.in_reply_to":{"event_id":"$nMX_drTSBGkvZsjRakXuVeUoB1RJUwRczLN1JjtYoZg"},"rel_type":"m.thread"}},"ts":1674075267763,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$E9WBSfSqw4yQpy8E2Qlsgjt04PCsXk2dN1nTU5B3N6c"},
{"content":{"org.matrix.msc1767.message":[{"body":"> <@jasnell:matrix.org> yeah, definitely doesn't appear to be working\n\nYoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks","mimetype":"text/plain"},{"body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$6xJenOsQUAgW23l7AFgUH0_-LKpVZcIY8yTyB28ezYc?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>yeah, definitely doesn&#39;t appear to be working</blockquote></mx-reply>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks","mimetype":"text/html"}],"body":"> <@jasnell:matrix.org> yeah, definitely doesn't appear to be working\n\nYoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$6xJenOsQUAgW23l7AFgUH0_-LKpVZcIY8yTyB28ezYc?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>yeah, definitely doesn&#39;t appear to be working</blockquote></mx-reply>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","m.in_reply_to":{"event_id":"$6xJenOsQUAgW23l7AFgUH0_-LKpVZcIY8yTyB28ezYc"},"rel_type":"m.thread"}},"ts":1674075335099,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$8OlFbScI2GMM4M7Mwj_yRquLaUONkIQqSFeIGgUILyY"},
{"content":{"org.matrix.msc1767.text":"so this is why I'm wondering if, in your testing, the save and restore at least happened for promises (it'd be really surprisng to me if it didn't work)","body":"so this is why I'm wondering if, in your testing, the save and restore at least happened for promises (it'd be really surprisng to me if it didn't work)","msgtype":"m.text"},"ts":1674075357146,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$JgdzqsSxRRAia_qs4P0ooQ_OHACXuJU6nkCYwS31qxg"},
{"content":{"msgtype":"m.text","body":"Will the promise reject callback be invoked while the appropriate stored continuation value is current?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$8OlFbScI2GMM4M7Mwj_yRquLaUONkIQqSFeIGgUILyY"},"rel_type":"m.thread"}},"ts":1674075408576,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$rikzD0QEI9pukegjGbfWl4__LM5ZT2H_YAaqpomg8Eg"},
{"content":{"msgtype":"m.text","body":"if so, I can absolutely capture it then","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$rikzD0QEI9pukegjGbfWl4__LM5ZT2H_YAaqpomg8Eg"},"rel_type":"m.thread"}},"ts":1674075426481,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$FXlpnuE7peCx1kflXFPLLt6O_hULoW0s7w_ObHQYgTM"},
{"content":{"org.matrix.msc1767.message":[{"body":"littledan: You're sometimes replying to a thread on the main channel. Are you using an outdated Matrix client?","mimetype":"text/plain"},{"body":"<a href=\"https://matrix.to/#/@littledan:matrix.org\">littledan</a>: You're sometimes replying to a thread on the main channel. Are you using an outdated Matrix client?","mimetype":"text/html"}],"body":"littledan: You're sometimes replying to a thread on the main channel. Are you using an outdated Matrix client?","msgtype":"m.text","format":"org.matrix.custom.html","formatted_body":"<a href=\"https://matrix.to/#/@littledan:matrix.org\">littledan</a>: You're sometimes replying to a thread on the main channel. Are you using an outdated Matrix client?"},"ts":1674075460243,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$HZ3uYq_kv8uNMW80RJ3tX16c8nWArjj5XFsVk-5yue8"},
{"content":{"org.matrix.msc1767.text":"I'm using app.element.io... I don't see threads","body":"I'm using app.element.io... I don't see threads","msgtype":"m.text"},"ts":1674075474990,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$i8caxQCDkbMyh00b2snHfhyvRcN8efFgh4Fs4qcW59s"},
{"content":{"msgtype":"m.text","body":"how do I enable them?"},"ts":1674075493684,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$XvUAiL1AvjNVIAl_yBfVRgXXfpC583Yf6ZB6uJQKeKQ"},
{"content":{"org.matrix.msc1767.text":"oh, they're not actually enabled by default in recent Element versions, I just had manually enabled them","body":"oh, they're not actually enabled by default in recent Element versions, I just had manually enabled them","msgtype":"m.text"},"ts":1674075530901,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$JnxvF8N8jNcVpGWH1hoVMOezb7crDSjZ2weZffqp7Tk"},
{"content":{"org.matrix.msc1767.text":"All Settings / Labs","body":"All Settings / Labs","msgtype":"m.text"},"ts":1674075538271,"senderName":"Andreu Botella","senderId":"@abotella:igalia.com","id":"$u82sbLRvCkor12fc-xVCXyU9dJ7Gd_HYta09q7NuwDE"},
{"content":{"msgtype":"m.text","body":"Yes, it should be","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$FXlpnuE7peCx1kflXFPLLt6O_hULoW0s7w_ObHQYgTM"},"rel_type":"m.thread"}},"ts":1674075563383,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$78F3oa6u25sasX_MvzOmoqZ_jDTG53ba7ZEHFdiOiEc"},
{"content":{"msgtype":"m.text","body":"oh! yes, quick test appears that it does work! woo!","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$FXlpnuE7peCx1kflXFPLLt6O_hULoW0s7w_ObHQYgTM"},"rel_type":"m.thread"}},"ts":1674075568438,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$3SmvKQZJueFGzxKUGgbb5vKOg2yUhill_laHQ8ZGHDM"},
{"content":{"msgtype":"m.text","body":"> <@littledan:matrix.org> Ah, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms\n\nThat's exactly what I said. Lol.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$B-CTsyL8A0DhkR63uDaLlVbwr8SC4me3Agh2lBLGuQQ?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@littledan:matrix.org\">@littledan:matrix.org</a><br>Ah, yeah, I think we should decline this request. The main explanation should be intuitive; we could have a doc off to the side in their terms</blockquote></mx-reply>That's exactly what I said. Lol.","m.relates_to":{"m.in_reply_to":{"event_id":"$B-CTsyL8A0DhkR63uDaLlVbwr8SC4me3Agh2lBLGuQQ"}}},"ts":1674075620135,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$4Q2q_Up9wGPpRmvybHGWd3-qDxxvNBrRo-H68loTm-g"},
{"content":{"msgtype":"m.text","body":"Oh hi now I can see the thread","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$3SmvKQZJueFGzxKUGgbb5vKOg2yUhill_laHQ8ZGHDM"},"rel_type":"m.thread"}},"ts":1674075673363,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$LhsMvFE_gELokYgW13krMZz5fr_MMvZZ6Pvsh7B2ySs"},
{"content":{"msgtype":"m.text","body":"> Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks\n\nJustin Ridgewell in v8 or somewhere else?","format":"org.matrix.custom.html","formatted_body":"<blockquote>\n<p>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks</p>\n</blockquote>\n<p><a href=\"https://matrix.to/#/@jridgewell:matrix.org\">Justin Ridgewell</a> in v8 or somewhere else?</p>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$LhsMvFE_gELokYgW13krMZz5fr_MMvZZ6Pvsh7B2ySs"},"rel_type":"m.thread"}},"ts":1674075693272,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$6k1CEDwVgLH7NJOdG_a0CYU2k2eAQ9jOAxfCwTlau64"},
{"content":{"msgtype":"m.text","body":"if in v8, it might be in a newer version than we're using maybe?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$6k1CEDwVgLH7NJOdG_a0CYU2k2eAQ9jOAxfCwTlau64"},"rel_type":"m.thread"}},"ts":1674075721800,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$vT8OgaSNYy1wWSaOAOvuWzFPokVdAfJ9XuCWbGqVEIM"},
{"content":{"msgtype":"m.text","body":"Hm?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$vT8OgaSNYy1wWSaOAOvuWzFPokVdAfJ9XuCWbGqVEIM"},"rel_type":"m.thread"}},"ts":1674075737716,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$wWNAxThNRvJbOUM0jKR23R2D3mkV-ZiEmiFqU_wdBcM"},
{"content":{"msgtype":"m.text","body":"> <@jasnell:matrix.org> Justin Ridgewell in v8 or somewhere else?\n\nThis is in Chrome, not V8","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$6k1CEDwVgLH7NJOdG_a0CYU2k2eAQ9jOAxfCwTlau64?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br><blockquote>\n<p>Yoav told me that, for web APIs, he added extra logic to save and restore the right thing when queueing [macro]tasks</p>\n</blockquote>\n<p><a href=\"https://matrix.to/#/@jridgewell:matrix.org\">Justin Ridgewell</a> in v8 or somewhere else?</p>\n</blockquote></mx-reply>This is in Chrome, not V8","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":false,"m.in_reply_to":{"event_id":"$6k1CEDwVgLH7NJOdG_a0CYU2k2eAQ9jOAxfCwTlau64"},"rel_type":"m.thread"}},"ts":1674075742365,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$d9S2Z1rf3Dg-11ncw5_iwpMTC7m1SNqAEzXqel-3SQ4"},
{"content":{"msgtype":"m.text","body":"so you won't just pick it up","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$d9S2Z1rf3Dg-11ncw5_iwpMTC7m1SNqAEzXqel-3SQ4"},"rel_type":"m.thread"}},"ts":1674075752817,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$ae3No1ni5qeXOi565wVelXCJq7X4dKMvtJaiQCmQvBA"},
{"content":{"msgtype":"m.text","body":"ok yeah","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$ae3No1ni5qeXOi565wVelXCJq7X4dKMvtJaiQCmQvBA"},"rel_type":"m.thread"}},"ts":1674075757617,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$ZcMZR-RHJSDw8mpjQ5GjNn_I3487_XNUl6J3L9zdLb0"},
{"content":{"msgtype":"m.text","body":"> <@jasnell:matrix.org> Will the promise reject callback be invoked while the appropriate stored continuation value is current?\n\nI don't expect this to work at all... I think we'd have to add something specifically to promises code to store exactly this thing","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$rikzD0QEI9pukegjGbfWl4__LM5ZT2H_YAaqpomg8Eg?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>Will the promise reject callback be invoked while the appropriate stored continuation value is current?</blockquote></mx-reply>I don't expect this to work at all... I think we'd have to add something specifically to promises code to store exactly this thing","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":false,"m.in_reply_to":{"event_id":"$rikzD0QEI9pukegjGbfWl4__LM5ZT2H_YAaqpomg8Eg"},"rel_type":"m.thread"}},"ts":1674075789484,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$8QI1ctPySzIlc_NnjMOGDFuSdDlj-LnOyVDIHAjY9lU"},
{"content":{"msgtype":"m.text","body":"Well, it does appear to be working in local testing","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$8QI1ctPySzIlc_NnjMOGDFuSdDlj-LnOyVDIHAjY9lU"},"rel_type":"m.thread"}},"ts":1674075813996,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$FSAWLFFKtFHVcdgGyun8zYpcKE5mDSW26vq8glY2oxs"},
{"content":{"msgtype":"m.text","body":"this is why it's important that we document that unhandled rejection asynccontext is important!","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$FSAWLFFKtFHVcdgGyun8zYpcKE5mDSW26vq8glY2oxs"},"rel_type":"m.thread"}},"ts":1674075815979,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$rUuDGdrRGJmllNZ_MRtZbY2XxB2yz0oI0AEd3MWZN50"},
{"content":{"msgtype":"m.text","body":"huh really? how so?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$rUuDGdrRGJmllNZ_MRtZbY2XxB2yz0oI0AEd3MWZN50"},"rel_type":"m.thread"}},"ts":1674075820340,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$XGJCx9BZlSkrzkDrYflXYMXy_79E-ED7qGY4VTWWspI"},
{"content":{"msgtype":"m.text","body":"Could you share your tests?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$XGJCx9BZlSkrzkDrYflXYMXy_79E-ED7qGY4VTWWspI"},"rel_type":"m.thread"}},"ts":1674075827602,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$XRurJkRx8Y44FRn3XMaFpTHZr1FbnVc2klPjl-d6q10"},
{"content":{"msgtype":"m.text","body":"```\n          jsg::AsyncContextFrame::Scope scope(js, jsg::AsyncContextFrame::current(js));\n          auto ev = jsg::alloc<PromiseRejectionEvent>(event, kj::mv(promise), kj::mv(value));\n          dispatchEventImpl(js, kj::mv(ev));\n```\n\nIt's a bit obscure here but...\n\n`jsg::AsyncContextFrame::current()` is a wrapper around code that grabs the current stored continuation data from v8::Context","format":"org.matrix.custom.html","formatted_body":"<pre><code>          jsg::AsyncContextFrame::Scope scope(js, jsg::AsyncContextFrame::current(js));\n          auto ev = jsg::alloc&lt;PromiseRejectionEvent&gt;(event, kj::mv(promise), kj::mv(value));\n          dispatchEventImpl(js, kj::mv(ev));\n</code></pre>\n<p>It's a bit obscure here but...</p>\n<p><code>jsg::AsyncContextFrame::current()</code> is a wrapper around code that grabs the current stored continuation data from v8::Context</p>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$XRurJkRx8Y44FRn3XMaFpTHZr1FbnVc2klPjl-d6q10"},"rel_type":"m.thread"}},"ts":1674075878562,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$msvejGTM0MNyw5Tb6LGkANMTuUuxUTUwCVohYRabOQg"},
{"content":{"msgtype":"m.text","body":"In JavaScript...\n\n```\nconst { AsyncLocalStorage } = async_hooks;\n\nconst als = new AsyncLocalStorage();\n\naddEventListener('unhandledrejection', (event) => {\n  // Here we are making sure that the async context properly travels along with\n  // unhandled rejections.\n  if (event.reason === 'boom' && als.getStore() !== 123) {\n    throw new Error(\"Incorrect async store value\");\n  }\n  if (event.reason === 'boom2' && als.getStore() !== 'ABC') {\n    throw new Error(\"Incorrect async store value\");\n  }\n});\n\naddEventListener('rejectionhandled', (event) => {\n  if (als.getStore() !== 'ABC') {\n    throw new Error(\"Incorrect async store value\");\n  }\n});\n\nexport default {\n  async fetch(request) {\n    // The async context is captured when on(...) is called to register\n    // handlers.\n    als.run(123, () => {\n      Promise.reject(\"boom\");\n    });\n\n    const p = als.run('ABC', () => {\n      return Promise.reject(\"boom2\");\n    });\n\n    await scheduler.wait(1);\n\n    p.catch(() => {});\n\n    return new Response(\"ok\");\n  }\n}\n```","format":"org.matrix.custom.html","formatted_body":"<p>In JavaScript...</p>\n<pre><code>const { AsyncLocalStorage } = async_hooks;\n\nconst als = new AsyncLocalStorage();\n\naddEventListener('unhandledrejection', (event) =&gt; {\n  // Here we are making sure that the async context properly travels along with\n  // unhandled rejections.\n  if (event.reason === 'boom' &amp;&amp; als.getStore() !== 123) {\n    throw new Error(&quot;Incorrect async store value&quot;);\n  }\n  if (event.reason === 'boom2' &amp;&amp; als.getStore() !== 'ABC') {\n    throw new Error(&quot;Incorrect async store value&quot;);\n  }\n});\n\naddEventListener('rejectionhandled', (event) =&gt; {\n  if (als.getStore() !== 'ABC') {\n    throw new Error(&quot;Incorrect async store value&quot;);\n  }\n});\n\nexport default {\n  async fetch(request) {\n    // The async context is captured when on(...) is called to register\n    // handlers.\n    als.run(123, () =&gt; {\n      Promise.reject(&quot;boom&quot;);\n    });\n\n    const p = als.run('ABC', () =&gt; {\n      return Promise.reject(&quot;boom2&quot;);\n    });\n\n    await scheduler.wait(1);\n\n    p.catch(() =&gt; {});\n\n    return new Response(&quot;ok&quot;);\n  }\n}\n</code></pre>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$msvejGTM0MNyw5Tb6LGkANMTuUuxUTUwCVohYRabOQg"},"rel_type":"m.thread"}},"ts":1674075974180,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$CYLCPaYLJl3NSJYh-7rSlBdzZfDvNhTcvJ_M6YKFuxg"},
{"content":{"msgtype":"m.text","body":"Try one that adopts the state of a rejected promise","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$CYLCPaYLJl3NSJYh-7rSlBdzZfDvNhTcvJ_M6YKFuxg"},"rel_type":"m.thread"}},"ts":1674076010856,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$3t6dZxf5mzd3dcL7uKb0RVueDqEuCWYpO3wnlZT47z4"},
{"content":{"msgtype":"m.text","body":"That'll be the tricky case","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$3t6dZxf5mzd3dcL7uKb0RVueDqEuCWYpO3wnlZT47z4"},"rel_type":"m.thread"}},"ts":1674076016442,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$OQZsDXbViA5VbBgZML8ZieH6WP9COtJzqzHgiG1PbGs"},
{"content":{"msgtype":"m.text","body":"`Promise.reject` is a sync rejection signal, so it's very easy to capture the current run state","format":"org.matrix.custom.html","formatted_body":"<code>Promise.reject</code> is a sync rejection signal, so it's very easy to capture the current run state","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$OQZsDXbViA5VbBgZML8ZieH6WP9COtJzqzHgiG1PbGs"},"rel_type":"m.thread"}},"ts":1674076040161,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$z8nkempSC9sREA1Im3-wyfz2PH78KThXldmK28V1hFU"},
{"content":{"msgtype":"m.text","body":"oh.. no, yeah, shoot","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$OQZsDXbViA5VbBgZML8ZieH6WP9COtJzqzHgiG1PbGs"},"rel_type":"m.thread"}},"ts":1674076041379,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$nioShEEagZTc1tneeZZp073GYS0Mj_W8-AipZ_A2zf0"},
{"content":{"msgtype":"m.text","body":"spoke too soon. That case was failing","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$nioShEEagZTc1tneeZZp073GYS0Mj_W8-AipZ_A2zf0"},"rel_type":"m.thread"}},"ts":1674076084550,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Mn9gw9iWSPpH7KdVGXEh4ZA4f37_hiwVxvCf4aJJTRo"},
{"content":{"msgtype":"m.text","body":"boo ok","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Mn9gw9iWSPpH7KdVGXEh4ZA4f37_hiwVxvCf4aJJTRo"},"rel_type":"m.thread"}},"ts":1674076207592,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Dsr-pwg4H22s_vB-e-1LHFFB1WIc8u6ZTwBVwg7_28I"},
{"content":{"msgtype":"m.text","body":"Curious of your test case","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Dsr-pwg4H22s_vB-e-1LHFFB1WIc8u6ZTwBVwg7_28I"},"rel_type":"m.thread"}},"ts":1674076610047,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$okv7JZTxOLDJBjNmq3tthZeWe184CRXDR-F1Wxb0H20"},
{"content":{"msgtype":"m.text","body":"The spec flows work, maybe it's just a V8 impl bug","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$okv7JZTxOLDJBjNmq3tthZeWe184CRXDR-F1Wxb0H20"},"rel_type":"m.thread"}},"ts":1674076620136,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$abxgRA_JgbXjVF7IHy9aVDm_x4n0tHuMgibMrhVT1EM"},
{"content":{"msgtype":"m.text","body":"The reject is either called sync (in which case, the context is still there), or it's queued in a job callback, in which case it would have been restored before calling reject","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$abxgRA_JgbXjVF7IHy9aVDm_x4n0tHuMgibMrhVT1EM"},"rel_type":"m.thread"}},"ts":1674076658598,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$wGEvP51Q5Nxt-pTP6pW7wf-0DDAlnNiAX-hs_bdVUDc"},
{"content":{"msgtype":"m.text","body":"I'll see if I can dig in a bit deeper soon","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$wGEvP51Q5Nxt-pTP6pW7wf-0DDAlnNiAX-hs_bdVUDc"},"rel_type":"m.thread"}},"ts":1674076687543,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$4f8v9YiXYoYyHiM5MKShTBYoyIgO2TixPznInfBWOcI"},
{"content":{"msgtype":"m.text","body":"```js\nnew Promise((_, rej) => rej(1));\nnew Promise(res => res(Promise.reject(1)));\n// technically equivalent to the previous one\nPromise.resolve().then(() => Promise.reject(1));\n```","format":"org.matrix.custom.html","formatted_body":"<pre><code class=\"language-js\">new Promise((_, rej) =&gt; rej(1));\nnew Promise(res =&gt; res(Promise.reject(1)));\n// technically equivalent to the previous one\nPromise.resolve().then(() =&gt; Promise.reject(1));\n</code></pre>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$4f8v9YiXYoYyHiM5MKShTBYoyIgO2TixPznInfBWOcI"},"rel_type":"m.thread"}},"ts":1674076819134,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$pNeEUNLYgwADHabfGRg3Uhu9RACaadAWUqqcIGeV3tM"},
{"content":{"msgtype":"m.text","body":"FYI I asked about this API in the #jsc room of WebKit Slack, and Jared Sumner responded explaining that he's implementing AsyncLocalStorage in Bun. Hopefully he takes my offer to come and hang out over here :)"},"ts":1674080419381,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$dkRLP20bQCVxYvTPWBZ9hag1L9cVMhW5Z7iiVsVCgI8"},
{"content":{"msgtype":"m.text","body":"fun fact: Promise.reject is in fact the hard case, since you actually want to wait for the microtask queue to be exhausted before considering it truly an unhandled rejection","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$pNeEUNLYgwADHabfGRg3Uhu9RACaadAWUqqcIGeV3tM"},"rel_type":"m.thread"}},"ts":1674080601356,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$JoPgueZjAEDt8pqyoLz_Z7bjac_eJMjx5XjQv3PeiiI"},
{"content":{"msgtype":"m.text","body":"the async case where the rejection happens after the responses have already been chained on--that's the easy case","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$JoPgueZjAEDt8pqyoLz_Z7bjac_eJMjx5XjQv3PeiiI"},"rel_type":"m.thread"}},"ts":1674080618257,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$7dZbbaUS7qwkcZDGqq_hP2qByFll_OQMNSzQ9tGJq0E"},
{"content":{"msgtype":"m.text","body":"(this was quite tricky for people inside of Bloomberg to rediscover, at least)","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$7dZbbaUS7qwkcZDGqq_hP2qByFll_OQMNSzQ9tGJq0E"},"rel_type":"m.thread"}},"ts":1674080656505,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$bLvD5C_-wFb_ulfvAZM258Md4D8r7s22Q5GDnoCE5OQ"},
{"content":{"msgtype":"m.text","body":"For the following case, what would you expect the `als.getStore()` value to be printed..\n\n```\naddEventListener('unhandledrejection', () =>{\n  console.log(als.getStore());\n})\n\nlet reject;\nconst p2 = als.run(123, () => new Promise((a,b) => reject = b));\nals.run(321, () => reject());\n```","format":"org.matrix.custom.html","formatted_body":"<p>For the following case, what would you expect the <code>als.getStore()</code> value to be printed..</p>\n<pre><code>addEventListener('unhandledrejection', () =&gt;{\n  console.log(als.getStore());\n})\n\nlet reject;\nconst p2 = als.run(123, () =&gt; new Promise((a,b) =&gt; reject = b));\nals.run(321, () =&gt; reject());\n</code></pre>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$bLvD5C_-wFb_ulfvAZM258Md4D8r7s22Q5GDnoCE5OQ"},"rel_type":"m.thread"}},"ts":1674080940441,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$zXnCZuRp1aseC6zkNbLU8oieI9SloPF9EiP6wUhfGCM"},
{"content":{"msgtype":"m.text","body":"Ahh, I hadn't considered that `reject()` would be called in a different context","format":"org.matrix.custom.html","formatted_body":"Ahh, I hadn't considered that <code>reject()</code> would be called in a different context","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$zXnCZuRp1aseC6zkNbLU8oieI9SloPF9EiP6wUhfGCM"},"rel_type":"m.thread"}},"ts":1674081029403,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$yPsCifLDJMX0wCWl0W-FRq0xwme3FFs6t_ZTTeJUIkw"},
{"content":{"msgtype":"m.text","body":"I don't have an answer for this, it's not a usecase that we expose","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$yPsCifLDJMX0wCWl0W-FRq0xwme3FFs6t_ZTTeJUIkw"},"rel_type":"m.thread"}},"ts":1674081166685,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$AsZNODOaGxRrhBq2oT8q4FO2WeCpEnp3BGPD1rFYZzs"},
{"content":{"msgtype":"m.text","body":"All user code is guaranteed to run inside the only context we care about","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$AsZNODOaGxRrhBq2oT8q4FO2WeCpEnp3BGPD1rFYZzs"},"rel_type":"m.thread"}},"ts":1674081186378,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$gG_Fu-gheYzqdcFuaRDopxIhD7VLbwYm8s2vIK49UnA"},
{"content":{"msgtype":"m.text","body":"not sure I grok that... in Node.js, `als.getStore()` in the unhandledrejection handler prints `123`","format":"org.matrix.custom.html","formatted_body":"not sure I grok that... in Node.js, <code>als.getStore()</code> in the unhandledrejection handler prints <code>123</code>","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$gG_Fu-gheYzqdcFuaRDopxIhD7VLbwYm8s2vIK49UnA"},"rel_type":"m.thread"}},"ts":1674081277627,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$FHPt4mS23m5TpbpiDjgqtI3C3V2QL49lbsYISbtdfRE"},
{"content":{"msgtype":"m.text","body":"because it grabs the async context reference on promise init and not promise reject","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$FHPt4mS23m5TpbpiDjgqtI3C3V2QL49lbsYISbtdfRE"},"rel_type":"m.thread"}},"ts":1674081296801,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$8kTkYWU-dfx4SRqqcVG82cniKhk-BZoFveoCxAsY0kk"},
{"content":{"msgtype":"m.text","body":"I think that's reasonable, but the other way actually allows more expressiveness","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$8kTkYWU-dfx4SRqqcVG82cniKhk-BZoFveoCxAsY0kk"},"rel_type":"m.thread"}},"ts":1674081360617,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$cucERhiQfFNhi8ES8vcTn0VTgRuLjbdD9me1sBqJwCE"},
{"content":{"msgtype":"m.text","body":"If you wanted to preserve the context for the `reject()`, you would export `return wrap(reject)`","format":"org.matrix.custom.html","formatted_body":"If you wanted to preserve the context for the <code>reject()</code>, you would export <code>return wrap(reject)</code>","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$cucERhiQfFNhi8ES8vcTn0VTgRuLjbdD9me1sBqJwCE"},"rel_type":"m.thread"}},"ts":1674081391363,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$f2Jv2B0QsPsWwO1K1-oG8Z2aYLp7v4ZxFJo2ZQte71o"},
{"content":{"msgtype":"m.text","body":"yeah, I'm a bit torn because honestly I do think it should return `321` in this case","format":"org.matrix.custom.html","formatted_body":"yeah, I'm a bit torn because honestly I do think it should return <code>321</code> in this case","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$f2Jv2B0QsPsWwO1K1-oG8Z2aYLp7v4ZxFJo2ZQte71o"},"rel_type":"m.thread"}},"ts":1674081425998,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$yb3AqM4lLj9HqN-mHS5eBdNVo7x0pYcYzEQCOnIHl5M"},
{"content":{"msgtype":"m.text","body":"I wonder if node had a use case to choose init-time","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$yb3AqM4lLj9HqN-mHS5eBdNVo7x0pYcYzEQCOnIHl5M"},"rel_type":"m.thread"}},"ts":1674081432043,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$IY7r5G234PktJDB3h2OVB6Z9bqBtuHqonKjQXy2An2I"},
{"content":{"msgtype":"m.text","body":"I'm not entirely convinced this case was considered","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$IY7r5G234PktJDB3h2OVB6Z9bqBtuHqonKjQXy2An2I"},"rel_type":"m.thread"}},"ts":1674081460985,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$TzkjQZ9y4HgPSdplHAQPRcWcN50GbUDnWwW9IYPeO_g"},
{"content":{"msgtype":"m.text","body":"I'm going to open an issue in Node.js to discuss","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$TzkjQZ9y4HgPSdplHAQPRcWcN50GbUDnWwW9IYPeO_g"},"rel_type":"m.thread"}},"ts":1674081490371,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$DN_oTaaxLfNwq62XwR4iqytU6oaHIVoSTPXTJSl6n2Q"},
{"content":{"msgtype":"m.text","body":"👍️, please link","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$DN_oTaaxLfNwq62XwR4iqytU6oaHIVoSTPXTJSl6n2Q"},"rel_type":"m.thread"}},"ts":1674081501252,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$dASeUQJ4F3JbWKMAKv2YmllO2b_38QvH_aMaWtPNPv8"},
{"content":{"msgtype":"m.text","body":"> <@jasnell:matrix.org> For the following case, what would you expect the `als.getStore()` value to be printed..\n> \n> ```\n> addEventListener('unhandledrejection', () =>{\n>   console.log(als.getStore());\n> })\n> \n> let reject;\n> const p2 = als.run(123, () => new Promise((a,b) => reject = b));\n> als.run(321, () => reject());\n> ```\n\nI would say, 123. I guess I'd predict that the V8 API that Justin linked to would log undefined.","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$zXnCZuRp1aseC6zkNbLU8oieI9SloPF9EiP6wUhfGCM?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br><p>For the following case, what would you expect the <code>als.getStore()</code> value to be printed..</p>\n<pre><code>addEventListener('unhandledrejection', () =&gt;{\n  console.log(als.getStore());\n})\n\nlet reject;\nconst p2 = als.run(123, () =&gt; new Promise((a,b) =&gt; reject = b));\nals.run(321, () =&gt; reject());\n</code></pre>\n</blockquote></mx-reply>I would say, 123. I guess I'd predict that the V8 API that Justin linked to would log undefined.","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":false,"m.in_reply_to":{"event_id":"$zXnCZuRp1aseC6zkNbLU8oieI9SloPF9EiP6wUhfGCM"},"rel_type":"m.thread"}},"ts":1674081724220,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$xjxUf2soczvtIX93-jZEzCQx6x8IlJydSsaFCXymGV4"},
{"content":{"msgtype":"m.text","body":"This is actually important for Bloomberg's (admittedly weird) use case","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$xjxUf2soczvtIX93-jZEzCQx6x8IlJydSsaFCXymGV4"},"rel_type":"m.thread"}},"ts":1674081744840,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$7fj-r6SUGXDTvKwFeQkIR8gOBJACcgRXW92d-kJEZSw"},
{"content":{"msgtype":"m.text","body":"https://github.com/nodejs/node/issues/46262","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$7fj-r6SUGXDTvKwFeQkIR8gOBJACcgRXW92d-kJEZSw"},"rel_type":"m.thread"}},"ts":1674081758744,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$kpFVL-zn925e7nW9abF65odpi5f93Ld7MbDIZs7mg4w"},
{"content":{"msgtype":"m.text","body":"I think it'd log `321`, no?","format":"org.matrix.custom.html","formatted_body":"I think it'd log <code>321</code>, no?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$kpFVL-zn925e7nW9abF65odpi5f93Ld7MbDIZs7mg4w"},"rel_type":"m.thread"}},"ts":1674081808628,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$1KcCvgXEZRfKUNtBxjcBJt_n1BQLp5EvvKY0gwxFnr4"},
{"content":{"msgtype":"m.text","body":"`reject` there is https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-reject-functions, which immediately invokes https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-rejectpromise, which triggers the hook API","format":"org.matrix.custom.html","formatted_body":"<code>reject</code> there is https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-reject-functions, which immediately invokes https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-rejectpromise, which triggers the hook API","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$1KcCvgXEZRfKUNtBxjcBJt_n1BQLp5EvvKY0gwxFnr4"},"rel_type":"m.thread"}},"ts":1674081876846,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$-3JL4RnwoLJlMXuFMmDTSM2cIm6m3lFdt727YI-e7DQ"},
{"content":{"msgtype":"m.text","body":"Yeah, it logs `321`","format":"org.matrix.custom.html","formatted_body":"Yeah, it logs <code>321</code>","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$-3JL4RnwoLJlMXuFMmDTSM2cIm6m3lFdt727YI-e7DQ"},"rel_type":"m.thread"}},"ts":1674081909471,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$4ucd7L5KU31Fx-ldiveYu9GqZ_f3dXCSU1P2_w8b280"},
{"content":{"msgtype":"m.text","body":"You would need to store the current context until the actual `unhandledrejection` event is fired, but you can do that as part of the hook","format":"org.matrix.custom.html","formatted_body":"You would need to store the current context until the actual <code>unhandledrejection</code> event is fired, but you can do that as part of the hook","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$4ucd7L5KU31Fx-ldiveYu9GqZ_f3dXCSU1P2_w8b280"},"rel_type":"m.thread"}},"ts":1674081994072,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$UQfz83vUbQXWCapZ3ko6IGKEJpD4YxKV61YW7YJ4b10"},
{"content":{"msgtype":"m.text","body":"> https://github.com/nodejs/node/issues/46262\n\nNit: \"promise is resolved\" should say \"promise is settled\"","format":"org.matrix.custom.html","formatted_body":"<blockquote>\n<p>https://github.com/nodejs/node/issues/46262</p>\n</blockquote>\n<p>Nit: &quot;promise is resolved&quot; should say &quot;promise is settled&quot;</p>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$UQfz83vUbQXWCapZ3ko6IGKEJpD4YxKV61YW7YJ4b10"},"rel_type":"m.thread"}},"ts":1674082037344,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$idFGB8uDxURzd2zaMU1ymb-qQAbav6Z7u2hTqAFeuIQ"},
{"content":{"msgtype":"m.text","body":"yeah, this is exactly the thing that I raised a week or two ago; I'm glad we're coming back to it since apparently we were talking past each other then","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$idFGB8uDxURzd2zaMU1ymb-qQAbav6Z7u2hTqAFeuIQ"},"rel_type":"m.thread"}},"ts":1674082078046,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$FnB550RmX7AOd8k_6E1ZaZv9_MXlxq6zAQgYB9VjO_g"},
{"content":{"msgtype":"m.text","body":"I was arguing, we should include something about the kInit storage in the spec (even though it's not visible without the unhandled rejection tracking)","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$FnB550RmX7AOd8k_6E1ZaZv9_MXlxq6zAQgYB9VjO_g"},"rel_type":"m.thread"}},"ts":1674082125205,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$xLw372AUr8ErURcGqU3YO66XLsT4Lb5MH0x1Ok8o5fI"},
{"content":{"msgtype":"m.text","body":"My intuition is that what you really want is the context at the point either `resolve()` or `reject()` is called","format":"org.matrix.custom.html","formatted_body":"My intuition is that what you really want is the context at the point either <code>resolve()</code> or <code>reject()</code> is called","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$FnB550RmX7AOd8k_6E1ZaZv9_MXlxq6zAQgYB9VjO_g"},"rel_type":"m.thread"}},"ts":1674082126175,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$NVv-xCqTX8yfMXVdpnWkjgTrHJfC8v3DYvBliJA3EFQ"},
{"content":{"msgtype":"m.text","body":"I remember. I think we should specify this as part of the proposal, I'm just interested in how we can implement this for workerd given what we already have","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$NVv-xCqTX8yfMXVdpnWkjgTrHJfC8v3DYvBliJA3EFQ"},"rel_type":"m.thread"}},"ts":1674082142804,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$Z5-jhNFYnVbCOoaAzN3T5Do4qABTlDfOHwtG-Fm9l8g"},
{"content":{"msgtype":"m.text","body":"it's trivial for me to make it work either way now. ","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Z5-jhNFYnVbCOoaAzN3T5Do4qABTlDfOHwtG-Fm9l8g"},"rel_type":"m.thread"}},"ts":1674082166449,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$DZShSlibzmEkJeZA6haNFgxnO0So9Pgk0K_zE4QI_XQ"},
{"content":{"msgtype":"m.text","body":"currently I have the Promise hook in place to set the context on kInit","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$DZShSlibzmEkJeZA6haNFgxnO0So9Pgk0K_zE4QI_XQ"},"rel_type":"m.thread"}},"ts":1674082181305,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$pBVhu8hheahfZg_qP0rpBSITswnpWjsnH6qDwRuwm-o"},
{"content":{"msgtype":"m.text","body":"but I have a pending set of changes that eliminates the promise hook and captures it on the rejection handler, which is working great","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$pBVhu8hheahfZg_qP0rpBSITswnpWjsnH6qDwRuwm-o"},"rel_type":"m.thread"}},"ts":1674082200325,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$2W65xt9mcYV3YRQ0TyBP9V-Y4ZMYl2M-IhwT0pP0o6Q"},
{"content":{"msgtype":"m.text","body":"> <@jridgewell:matrix.org> I remember. I think we should specify this as part of the proposal, I'm just interested in how we can implement this for workerd given what we already have\n\nwhat do the spec sections that you cited have to do with workerd?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$Z5-jhNFYnVbCOoaAzN3T5Do4qABTlDfOHwtG-Fm9l8g?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jridgewell:matrix.org\">@jridgewell:matrix.org</a><br>I remember. I think we should specify this as part of the proposal, I&#39;m just interested in how we can implement this for workerd given what we already have</blockquote></mx-reply>what do the spec sections that you cited have to do with workerd?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":false,"m.in_reply_to":{"event_id":"$Z5-jhNFYnVbCOoaAzN3T5Do4qABTlDfOHwtG-Fm9l8g"},"rel_type":"m.thread"}},"ts":1674082359912,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$c0wcX--gpPeEC0YMcw1uO7ITJopmJGWBfFUQfvq7UlU"},
{"content":{"msgtype":"m.text","body":"> <@jasnell:matrix.org> but I have a pending set of changes that eliminates the promise hook and captures it on the rejection handler, which is working great\n\nwait, does this work to implement either set of semantics, or just the 321 one?","format":"org.matrix.custom.html","formatted_body":"<mx-reply><blockquote><a href=\"https://matrix.to/#/!siOjSOrhCVYVzIoThy:matrix.org/$2W65xt9mcYV3YRQ0TyBP9V-Y4ZMYl2M-IhwT0pP0o6Q?via=matrix.org&via=igalia.com\">In reply to</a> <a href=\"https://matrix.to/#/@jasnell:matrix.org\">@jasnell:matrix.org</a><br>but I have a pending set of changes that eliminates the promise hook and captures it on the rejection handler, which is working great</blockquote></mx-reply>wait, does this work to implement either set of semantics, or just the 321 one?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":false,"m.in_reply_to":{"event_id":"$2W65xt9mcYV3YRQ0TyBP9V-Y4ZMYl2M-IhwT0pP0o6Q"},"rel_type":"m.thread"}},"ts":1674082372914,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$ciY_bcKrpSn-WLFGdFwxAo6_C0oiua0lGnZBvgmYyPY"},
{"content":{"msgtype":"m.text","body":"it's either or, not both","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$ciY_bcKrpSn-WLFGdFwxAo6_C0oiua0lGnZBvgmYyPY"},"rel_type":"m.thread"}},"ts":1674082427375,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$DAUvlfH4b8qAOU0xB20LetDbnhEdb8Vc09hBoxrmOpI"},
{"content":{"msgtype":"m.text","body":"my pending changes removes the promise hook","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$DAUvlfH4b8qAOU0xB20LetDbnhEdb8Vc09hBoxrmOpI"},"rel_type":"m.thread"}},"ts":1674082442754,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$goETeOkD5bt4f_7LodsPcOdhuWNHaE77RWi6KWOcrns"},
{"content":{"msgtype":"m.text","body":"workerd uses v8, and v8 exposes these hooks for implementers.","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$goETeOkD5bt4f_7LodsPcOdhuWNHaE77RWi6KWOcrns"},"rel_type":"m.thread"}},"ts":1674082465788,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$nUx4pkjhrsaAgX2edRJHd7-VfqD9N1jsjB0nP_l-HsA"},
{"content":{"msgtype":"m.text","body":"I think we should specify a behavior instead of allowing implementers to implement on their own","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$nUx4pkjhrsaAgX2edRJHd7-VfqD9N1jsjB0nP_l-HsA"},"rel_type":"m.thread"}},"ts":1674082501925,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$TVNecbNhKGBlbb0mfB4aVAsk3RBTg_BdsmQ7J2BQvcg"},
{"content":{"msgtype":"m.text","body":"For this case, I think we have to","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$TVNecbNhKGBlbb0mfB4aVAsk3RBTg_BdsmQ7J2BQvcg"},"rel_type":"m.thread"}},"ts":1674082516354,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Pn39o2cWXXf6k7EhCADKC3QrEKZRzyqyrhO9yZjrMIE"},
{"content":{"msgtype":"m.text","body":"will this be a publicly visible PR?","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Pn39o2cWXXf6k7EhCADKC3QrEKZRzyqyrhO9yZjrMIE"},"rel_type":"m.thread"}},"ts":1674082538249,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$CoiDXSyDAHaPb_rco1x1X8QGxJXoE6carMZO9amtpnY"},
{"content":{"msgtype":"m.text","body":"yes","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$CoiDXSyDAHaPb_rco1x1X8QGxJXoE6carMZO9amtpnY"},"rel_type":"m.thread"}},"ts":1674082545980,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$6A-VCsYa8tCYCFX91QyzIpVSozo1JB9IHkFglBmhWVY"},
{"content":{"msgtype":"m.text","body":"https://github.com/cloudflare/workerd/pull/282","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$6A-VCsYa8tCYCFX91QyzIpVSozo1JB9IHkFglBmhWVY"},"rel_type":"m.thread"}},"ts":1674082574272,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$ceWEUOLIEV7qugUVRUTXucQipS7TIOUf7LHL3kUT20M"},
{"content":{"msgtype":"m.text","body":"Specifically, I think by default, we should capture the context on settle not kInit. So the answer by default should be `321`. If you want `123`, then use `wrap` around `reject` as suggested by Justin. Or, if we are using a mechanism like Node.js' `AsyncResource`, we can do something like:\n\n```\nclass Foo extends AsyncResource {\n  constructor() {\n    this.deferredPromise = createDeferredPromise();\n  }\n\n  resolve() { this.runInAsyncScope(() => this.deferredPromise.resolve()) }\n  reject() { this.runInAsyncScope(() => this.deferredPromise.reject()) }\n}\n```","format":"org.matrix.custom.html","formatted_body":"<p>Specifically, I think by default, we should capture the context on settle not kInit. So the answer by default should be <code>321</code>. If you want <code>123</code>, then use <code>wrap</code> around <code>reject</code> as suggested by Justin. Or, if we are using a mechanism like Node.js' <code>AsyncResource</code>, we can do something like:</p>\n<pre><code>class Foo extends AsyncResource {\n  constructor() {\n    this.deferredPromise = createDeferredPromise();\n  }\n\n  resolve() { this.runInAsyncScope(() =&gt; this.deferredPromise.resolve()) }\n  reject() { this.runInAsyncScope(() =&gt; this.deferredPromise.reject()) }\n}\n</code></pre>\n","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$ceWEUOLIEV7qugUVRUTXucQipS7TIOUf7LHL3kUT20M"},"rel_type":"m.thread"}},"ts":1674082696430,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$k_u7C-kGiSHJ2Az0_tTDYHpxk92dpbWgntjTzRyJAnk"},
{"content":{"msgtype":"m.text","body":"This gives us the most flexibility because it allows us either option","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$k_u7C-kGiSHJ2Az0_tTDYHpxk92dpbWgntjTzRyJAnk"},"rel_type":"m.thread"}},"ts":1674082744192,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$Zq21hkTq2nwD5Ts32XW36LCiO-KnZrYpPnuh2SaXFdY"},
{"content":{"msgtype":"m.text","body":"Can we have a parallel thread about the same question in legendecas's repo? I'd feel more comfortable sharing my thoughts there (since they're more related to Bloomberg's use case than Node stuff)","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$Zq21hkTq2nwD5Ts32XW36LCiO-KnZrYpPnuh2SaXFdY"},"rel_type":"m.thread"}},"ts":1674082845119,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$gp1iw_YtfJ6X_k4MJyrXIkS_E2DryDp-Eouy8qYQFY4"},
{"content":{"msgtype":"m.text","body":"https://github.com/legendecas/proposal-async-context/issues/16","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$gp1iw_YtfJ6X_k4MJyrXIkS_E2DryDp-Eouy8qYQFY4"},"rel_type":"m.thread"}},"ts":1674083374078,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$L3MHc4aQQmloT41wvUcGJAIOrbYvFPR3yI3nFaG3D4Y"},
{"content":{"msgtype":"m.text","body":"This is also an interesting case because `unhandledrejection` will be the only event API that does not preserve the context at the time of registration...","format":"org.matrix.custom.html","formatted_body":"This is also an interesting case because <code>unhandledrejection</code> will be the only event API that does not preserve the context at the time of registration...","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$L3MHc4aQQmloT41wvUcGJAIOrbYvFPR3yI3nFaG3D4Y"},"rel_type":"m.thread"}},"ts":1674085377674,"senderName":"Justin Ridgewell","senderId":"@jridgewell:matrix.org","id":"$xMlVh36VQKDPlKJVoEI-iMZJzlKHM1Fq-JWs9Y1yyLA"},
{"content":{"msgtype":"m.text","body":"It would indeed be special, but Yoav found that, in DOM, some events naturally wanted to restore the context when they were registered, whereas others should *not* do so and leave in place the context that triggered them","format":"org.matrix.custom.html","formatted_body":"It would indeed be special, but Yoav found that, in DOM, some events naturally wanted to restore the context when they were registered, whereas others should <em>not</em> do so and leave in place the context that triggered them","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$xMlVh36VQKDPlKJVoEI-iMZJzlKHM1Fq-JWs9Y1yyLA"},"rel_type":"m.thread"}},"ts":1674085460474,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$f1IlGiAgZQcyKuInm9vV9brFU-nPWe2k41A2H5CSlBI"},
{"content":{"msgtype":"m.text","body":"(I don't know details, but when we get back in touch with him, I'm really excited to hear his thoughts.)","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$f1IlGiAgZQcyKuInm9vV9brFU-nPWe2k41A2H5CSlBI"},"rel_type":"m.thread"}},"ts":1674085474746,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$AKunLHZPpf4ny7QdaNAKejX-I3whhdBDHEANYLG0JoU"},
{"content":{"msgtype":"m.text","body":"this is sort of a third case, to be sure","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$AKunLHZPpf4ny7QdaNAKejX-I3whhdBDHEANYLG0JoU"},"rel_type":"m.thread"}},"ts":1674085489139,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$DJW9jCHasD4B_2kesHGm1Io7rmgwCXDTzR-_oyfIkj8"},
{"content":{"msgtype":"m.text","body":"but I think we agree it's disagreeing somehow, whether we go with 321 or 123","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$DJW9jCHasD4B_2kesHGm1Io7rmgwCXDTzR-_oyfIkj8"},"rel_type":"m.thread"}},"ts":1674085515840,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$D4IueJ0a1fUKRIxOkGODmBe2jJWngNaEI3CettCD_pw"},
{"content":{"msgtype":"m.text","body":"Going through this, I'm more and more convinced the answer should be `321`","format":"org.matrix.custom.html","formatted_body":"Going through this, I'm more and more convinced the answer should be <code>321</code>","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$D4IueJ0a1fUKRIxOkGODmBe2jJWngNaEI3CettCD_pw"},"rel_type":"m.thread"}},"ts":1674085660824,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$eT5_VNYNSseHNpJnKP0-ZSEPDMcQN3paSn64Prcm_A4"},
{"content":{"msgtype":"m.text","body":"if we're saying that the context is rightfully captured when the `then()` is called, or when `await` is called.. invoking an unhandledrejection handler falls into the equivalent category of \"continuation handler\"... it's just a different kind of continuation","format":"org.matrix.custom.html","formatted_body":"if we're saying that the context is rightfully captured when the <code>then()</code> is called, or when <code>await</code> is called.. invoking an unhandledrejection handler falls into the equivalent category of &quot;continuation handler&quot;... it's just a different kind of continuation","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$eT5_VNYNSseHNpJnKP0-ZSEPDMcQN3paSn64Prcm_A4"},"rel_type":"m.thread"}},"ts":1674085715236,"senderName":"James M Snell","senderId":"@jasnell:matrix.org","id":"$ngIBn8UTrW6y-yEu1nhBRaRHCDnA-DF-aFhj2ijmZIA"},
{"content":{"msgtype":"m.text","body":"I need to pull in an expert in how Bloomberg's system currently works before we make a call for the proposal in general; this whole thing might be unusable to us if the answer is 321","m.relates_to":{"event_id":"$fdLRPv7OFj3pBRtKTuS1cUoUPhgjT9S-9db_-vVtL3k","is_falling_back":true,"m.in_reply_to":{"event_id":"$ngIBn8UTrW6y-yEu1nhBRaRHCDnA-DF-aFhj2ijmZIA"},"rel_type":"m.thread"}},"ts":1674085994744,"senderName":"littledan","senderId":"@littledan:matrix.org","id":"$kekM-46BLDvhYn2ki58ggStMHsbNdwFzM5hHCk--Qok"}
]